<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/images/manifest.json">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-corner-indicator.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ikoct.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="省流: 被算法卡脖子了 学到虚脱">
<meta property="og:type" content="article">
<meta property="og:title" content="2025腾讯游戏安全 PC端决赛题解+复现">
<meta property="og:url" content="https://ikoct.com/2025/05/19/2025%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8-PC%E7%AB%AF%E5%86%B3%E8%B5%9B%E9%A2%98%E8%A7%A3-%E5%A4%8D%E7%8E%B0/">
<meta property="og:site_name" content="Ikoct的饮冰室">
<meta property="og:description" content="省流: 被算法卡脖子了 学到虚脱">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F11%2F20250411-134759.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F11%2F20250411-134741.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F11%2F20250411-145724.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-145242.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-145701.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-183659.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-184910.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-190459.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-201647.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-205209.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-212352.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-212558.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-212611.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-112913.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-113008.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-133331.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-133547.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-135654.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-140617.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-141000.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-144512.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-152400.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-153342.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-175052.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-180051.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-180445.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F16%2F20250416-204559.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-195014.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-195026.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F08%2F20250508-140135.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F08%2F20250508-134151.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F08%2F20250508-142205.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F12%2F20250512-105901.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F12%2F20250512-113324.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F12%2F20250512-132919.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F12%2F20250512-184738.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F12%2F20250512-192554.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F12%2F20250512-192707.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F15%2F20250515-214852.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F19%2F20250519-110654.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F19%2F20250519-114658.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F19%2F20250519-121154.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F19%2F20250519-122026.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F19%2F20250519-122210.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F19%2F20250519-133441.png">
<meta property="article:published_time" content="2025-05-19T08:30:48.000Z">
<meta property="article:modified_time" content="2025-05-19T08:30:48.388Z">
<meta property="article:author" content="1K0CT B14s">
<meta property="article:tag" content="Reverse">
<meta property="article:tag" content="Writeups">
<meta property="article:tag" content="Kernel">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F11%2F20250411-134759.png">

<link rel="canonical" href="https://ikoct.com/2025/05/19/2025%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8-PC%E7%AB%AF%E5%86%B3%E8%B5%9B%E9%A2%98%E8%A7%A3-%E5%A4%8D%E7%8E%B0/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>2025腾讯游戏安全 PC端决赛题解+复现 | Ikoct的饮冰室</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Ikoct的饮冰室</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">你愿意和我学一辈子二进制吗?</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ikoct.com/2025/05/19/2025%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8-PC%E7%AB%AF%E5%86%B3%E8%B5%9B%E9%A2%98%E8%A7%A3-%E5%A4%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.gif">
      <meta itemprop="name" content="1K0CT B14s">
      <meta itemprop="description" content="残りの人生、私にくれませんか？">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ikoct的饮冰室">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          2025腾讯游戏安全 PC端决赛题解+复现
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2025-05-19 16:30:48" itemprop="dateCreated datePublished" datetime="2025-05-19T16:30:48+08:00">2025-05-19</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index"><span itemprop="name">二进制</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/Reverse/" itemprop="url" rel="index"><span itemprop="name">Reverse</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Windows%E5%86%85%E6%A0%B8/" itemprop="url" rel="index"><span itemprop="name">Windows内核</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>28k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>25 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>省流: 被算法卡脖子了 学到虚脱</p>
<span id="more"></span>

<h2 id="2-能在双机环境运行驱动并调试-1分"><a href="#2-能在双机环境运行驱动并调试-1分" class="headerlink" title="(2)能在双机环境运行驱动并调试(1分)"></a>(2)能在双机环境运行驱动并调试(1分)</h2><p>直接加载驱动会报错:</p>
<p><code>DriverEntry failed 0xc0000001 for driver \REGISTRY\MACHINE\SYSTEM\ControlSet001\Services\ACE2025</code></p>
<p>代码高度混淆 静态也看不出东西 这里尝试patch驱动强制下断让windbg接管:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F11%2F20250411-134759.png" alt="QQ_1744350475400"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F11%2F20250411-134741.png" alt="QQ_1744350458831"></p>
<p>但是调着调着会进到<code>KeBugCheckEx()</code>然后蓝屏:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F11%2F20250411-145724.png" alt="QQ_1744354520570"></p>
<p>估计就是这里检测双机调试或程序完整性的 写个驱动hook这个函数 同时观察.text段中需要解密的字节是否在此时已经解密了:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntdef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntstatus.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_BACKTRACE_DEPTH 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYM <span class="string">L&quot;\\??\\Hook_API&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kprintf(format, ...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, format, __VA_ARGS__)</span></span><br><span class="line"><span class="keyword">typedef</span> UINT64 u64;</span><br><span class="line"><span class="keyword">typedef</span> UINT32 u32;</span><br><span class="line"><span class="keyword">typedef</span> UINT16 u16;</span><br><span class="line"><span class="keyword">typedef</span> UINT8  u8;</span><br><span class="line"></span><br><span class="line">u8 mov_jmp_rax1[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,	<span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>											<span class="comment">//jmp rax</span></span><br><span class="line">&#125;, mov_jmp_rax2[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,	<span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>											<span class="comment">//jmp rax</span></span><br><span class="line">&#125;, mov_jmp_rax3[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,	<span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>											<span class="comment">//jmp rax</span></span><br><span class="line">&#125;, mov_jmp_rax4[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,	<span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>											<span class="comment">//jmp rax</span></span><br><span class="line">&#125;, origin1[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;, origin2[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;, origin3[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;, origin4[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">u8* HookAddr1 = <span class="literal">NULL</span>, * HookAddr2 = <span class="literal">NULL</span>, * HookAddr3 = <span class="literal">NULL</span>, * HookAddr4 = <span class="literal">NULL</span>, Hooked1 = FALSE, Hooked2 = FALSE, Hooked3 = FALSE, Hooked4 = FALSE;</span><br><span class="line"></span><br><span class="line">KIRQL <span class="title function_">writeProtectOFFx64</span><span class="params">()</span> &#123;</span><br><span class="line">    KIRQL OldIrql;</span><br><span class="line">    OldIrql = KeRaiseIrqlToDpcLevel();</span><br><span class="line">    __writecr0(__readcr0() &amp; ~<span class="number">0x10000</span>);</span><br><span class="line">    _disable();</span><br><span class="line">    <span class="keyword">return</span> OldIrql;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeProtectONx64</span><span class="params">(KIRQL OldIrql)</span> &#123;</span><br><span class="line">    _enable();</span><br><span class="line">    __writecr0(__readcr0() | <span class="number">0x10000</span>);</span><br><span class="line">    KeLowerIrql(OldIrql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">dohook3</span><span class="params">(u8 HOOK)</span> &#123;</span><br><span class="line">    Hooked3 = HOOK;</span><br><span class="line">    KIRQL irql = writeProtectOFFx64();</span><br><span class="line">    <span class="keyword">if</span> (HookAddr3) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!HOOK) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr3, origin3, <span class="keyword">sizeof</span>(origin3));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr3, mov_jmp_rax3, <span class="keyword">sizeof</span>(mov_jmp_rax3));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    writeProtectONx64(irql);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">NTSTATUS</span><span class="params">(*kebugcheck_ptr)</span> <span class="params">(</span></span><br><span class="line"><span class="params">    _In_ ULONG BugCheckCode,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter1,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter2,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter3,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter4</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line">ULONG  <span class="title function_">myKeBugCheckEx</span><span class="params">(_In_ ULONG BugCheckCode,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter1,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter2,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter3,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter4</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    dohook3(FALSE);</span><br><span class="line">    kebugcheck_ptr func = (kebugcheck_ptr)HookAddr3;</span><br><span class="line"></span><br><span class="line">    PVOID backtrace[MAX_BACKTRACE_DEPTH];</span><br><span class="line">    USHORT capturedFrames = RtlCaptureStackBackTrace(<span class="number">0</span>, MAX_BACKTRACE_DEPTH, backtrace, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    kprintf((<span class="string">&quot;Line %d: calling KeBugCheckEx(%p,%p,%p,%p,%p)\n&quot;</span>), __LINE__, BugCheckCode, BugCheckParameter1, BugCheckParameter2, BugCheckParameter3, BugCheckParameter4);</span><br><span class="line">    <span class="keyword">if</span> (BugCheckCode == <span class="number">0x414345</span>) &#123;</span><br><span class="line">        dohook3(TRUE);</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    ULONG64 s = func(BugCheckCode, BugCheckParameter1, BugCheckParameter2, BugCheckParameter3, BugCheckParameter4);</span><br><span class="line">    dohook3(TRUE);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DeleteDevice</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Deleting Driver\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="keyword">if</span> (pDriver-&gt;DeviceObject) &#123;</span><br><span class="line">        UNICODE_STRING DeviceName;</span><br><span class="line">        RtlInitUnicodeString(&amp;DeviceName, SYM);</span><br><span class="line">        IoDeleteSymbolicLink(&amp;DeviceName);</span><br><span class="line">        IoDeleteDevice(pDriver-&gt;DeviceObject);</span><br><span class="line">    &#125;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Deleted\n&quot;</span>, __LINE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Unloading Driver\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="keyword">if</span> (Hooked3) &#123;</span><br><span class="line">        dohook3(FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">    DeleteDevice(pDriver);</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Unloaded\n&quot;</span>, __LINE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Loaded, RegistryPath : %S\n&quot;</span>, __LINE__, RegistryPath-&gt;Buffer);</span><br><span class="line">    HookAddr3 = (u64)KeBugCheckEx;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: HookAddr1 : %p, HookAddr3 : %p\n&quot;</span>, __LINE__, HookAddr1, HookAddr3);</span><br><span class="line">    <span class="built_in">memcpy</span>(origin3, HookAddr3, <span class="keyword">sizeof</span>(origin3));</span><br><span class="line">    *((u64*)(mov_jmp_rax3 + <span class="number">2</span>)) = (u64)myKeBugCheckEx;</span><br><span class="line">    dohook3(TRUE);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到加载驱动的入口时这段还是待解密的:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-145242.png" alt="QQ_1744440737644"></p>
<p>到达hook到的kebugcheck里之后已经解密过了:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-145701.png" alt="QQ_1744440985810"></p>
<p>现在dump出来方便静态分析 <code>.writemem &quot;D:\dump.bin&quot; ACEDriver L012CE000</code> 用CFF重建PE头:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-183659.png" alt="QQ_1744454198485"></p>
<p>在IDA数据库中rebase为0方便分析 找到了可能可以指示真正入口点的字符串 但是交叉引用没有结果 应该是隐藏了 用bn试试能不能找到在哪里引用了这个字符串:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-184910.png" alt="QQ_1744454895747"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-190459.png" alt="QQ_1744455889702"></p>
<p>找到<code>DEFB</code>处进行了引用 去除几处花指令就在IDA中发现了可能为程序入口点的位置 在此处下硬件断点(<code>ba e1 ACEDriver+0xde2c</code>)看看Windbg能不能断在此处:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-201647.png" alt="img"></p>
<p>成功断下:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-205209.png" alt="QQ_1744462321480"></p>
<p>调试到后面发现进入了这个函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_E304</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// edi</span></span><br><span class="line">  __int64 v4; <span class="comment">// rcx</span></span><br><span class="line"></span><br><span class="line">  qword_6B548 = a1;</span><br><span class="line">  <span class="keyword">if</span> ( !(<span class="type">unsigned</span> __int8)sub_E450() )</span><br><span class="line">    RtlFailFast(<span class="number">7u</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)sub_E408(&amp;unk_10218, &amp;unk_10220) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0xC0000365</span>LL;</span><br><span class="line">  sub_E3D0(&amp;unk_10208, &amp;unk_10210);</span><br><span class="line">  v3 = sub_808C(a1);</span><br><span class="line">  <span class="keyword">if</span> ( v3 &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    sub_E6A0();</span><br><span class="line">    LOBYTE(v4) = <span class="number">1</span>;</span><br><span class="line">    sub_E574(v4, <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( *(_QWORD *)(a1 + <span class="number">104</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    qword_6B550 = *(_QWORD *)(a1 + <span class="number">104</span>);</span><br><span class="line">    *(_QWORD *)(a1 + <span class="number">104</span>) = sub_E2D0;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> <span class="type">int</span>)v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中的<code>RtlFailFast()</code>启发了我主动造成蓝屏的原因 如果要造成蓝屏且错误代码是<code>0x414345</code>那么就一定会将这个参数计算或者直接传入寄存器作为参数 先尝试搜索:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-212352.png" alt="QQ_1744464225957"></p>
<p>直接搜到了两个结果 在这两个函数开头下断看看会不会到这里 结果直接断下来了 并且还可以发现是先清除了栈然后调用的是<code>KeBugCheckEx()</code>:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-212558.png" alt="QQ_1744464319344"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F12%2F20250412-212611.png" alt="QQ_1744464366243"></p>
<p>在IDA中向上交叉引用还能发现反调试使用的函数:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-112913.png" alt="QQ_1744514945922"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-113008.png" alt="QQ_1744514962483"></p>
<p>hook这个函数看看是否能正常进行双机调试了:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntdef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntstatus.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_BACKTRACE_DEPTH 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYM <span class="string">L&quot;\\??\\Hook_API&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kprintf(format, ...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, format, __VA_ARGS__)</span></span><br><span class="line"><span class="keyword">typedef</span> UINT64 u64;</span><br><span class="line"><span class="keyword">typedef</span> UINT32 u32;</span><br><span class="line"><span class="keyword">typedef</span> UINT16 u16;</span><br><span class="line"><span class="keyword">typedef</span> UINT8  u8;</span><br><span class="line"></span><br><span class="line">u8 mov_jmp_rax1[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,	<span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>											<span class="comment">//jmp rax</span></span><br><span class="line">&#125;, mov_jmp_rax2[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,	<span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>											<span class="comment">//jmp rax</span></span><br><span class="line">&#125;, mov_jmp_rax3[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,	<span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>											<span class="comment">//jmp rax</span></span><br><span class="line">&#125;, mov_jmp_rax4[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,	<span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>											<span class="comment">//jmp rax</span></span><br><span class="line">&#125;, origin1[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;, origin2[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;, origin3[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;, origin4[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">u8* HookAddr1 = <span class="literal">NULL</span>, * HookAddr2 = <span class="literal">NULL</span>, * HookAddr3 = <span class="literal">NULL</span>, * HookAddr4 = <span class="literal">NULL</span>, Hooked1 = FALSE, Hooked2 = FALSE, Hooked3 = FALSE, Hooked4 = FALSE;</span><br><span class="line"></span><br><span class="line">KIRQL <span class="title function_">writeProtectOFFx64</span><span class="params">()</span> &#123;</span><br><span class="line">    KIRQL OldIrql;</span><br><span class="line">    OldIrql = KeRaiseIrqlToDpcLevel();</span><br><span class="line">    __writecr0(__readcr0() &amp; ~<span class="number">0x10000</span>);</span><br><span class="line">    _disable();</span><br><span class="line">    <span class="keyword">return</span> OldIrql;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeProtectONx64</span><span class="params">(KIRQL OldIrql)</span> &#123;</span><br><span class="line">    _enable();</span><br><span class="line">    __writecr0(__readcr0() | <span class="number">0x10000</span>);</span><br><span class="line">    KeLowerIrql(OldIrql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">dohook1</span><span class="params">(u8 HOOK)</span> &#123;</span><br><span class="line">    Hooked1 = HOOK;</span><br><span class="line">    KIRQL irql = writeProtectOFFx64();</span><br><span class="line">    <span class="keyword">if</span> (HookAddr1) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!HOOK) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr1, origin1, <span class="keyword">sizeof</span>(origin1));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr1, mov_jmp_rax1, <span class="keyword">sizeof</span>(mov_jmp_rax1));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    writeProtectONx64(irql);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">dohook2</span><span class="params">(u8 HOOK)</span> &#123;</span><br><span class="line">    Hooked2 = HOOK;</span><br><span class="line">    KIRQL irql = writeProtectOFFx64();</span><br><span class="line">    <span class="keyword">if</span> (HookAddr2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!HOOK) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr2, origin2, <span class="keyword">sizeof</span>(origin2));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr2, mov_jmp_rax2, <span class="keyword">sizeof</span>(mov_jmp_rax2));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    writeProtectONx64(irql);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">dohook3</span><span class="params">(u8 HOOK)</span> &#123;</span><br><span class="line">    Hooked3 = HOOK;</span><br><span class="line">    KIRQL irql = writeProtectOFFx64();</span><br><span class="line">    <span class="keyword">if</span> (HookAddr3) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!HOOK) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr3, origin3, <span class="keyword">sizeof</span>(origin3));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr3, mov_jmp_rax3, <span class="keyword">sizeof</span>(mov_jmp_rax3));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    writeProtectONx64(irql);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">u8</span><span class="params">(*kdrefreshdebugnotpresent_ptr)</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">u8 <span class="title function_">myKdRefreshDebugNotPresent</span><span class="params">()</span> &#123;</span><br><span class="line">    kprintf((<span class="string">&quot;Line %d: calling KdRefreshDebuggerNotPresent()\n&quot;</span>), __LINE__);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">NTSTATUS</span><span class="params">(*queryinformation_ptr)</span> <span class="params">(</span></span><br><span class="line"><span class="params">    _In_ ULONG SystemInformationClass,</span></span><br><span class="line"><span class="params">    _Out_writes_bytes_opt_(SystemInformationLength) PVOID SystemInformation,</span></span><br><span class="line"><span class="params">    _In_ ULONG SystemInformationLength,</span></span><br><span class="line"><span class="params">    _Out_opt_ PULONG ReturnLength</span></span><br><span class="line"><span class="params">)</span>;</span><br><span class="line"></span><br><span class="line">NTSTATUS  <span class="title function_">myHalQuerySystemInformation</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ ULONG SystemInformationClass,</span></span><br><span class="line"><span class="params">    _Out_writes_bytes_opt_(SystemInformationLength) PVOID SystemInformation,</span></span><br><span class="line"><span class="params">    _In_ ULONG SystemInformationLength,</span></span><br><span class="line"><span class="params">    _Out_opt_ PULONG ReturnLength</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    dohook1(FALSE);</span><br><span class="line">    queryinformation_ptr func = (queryinformation_ptr)HookAddr1;</span><br><span class="line">    <span class="keyword">if</span> (SystemInformationClass == <span class="number">0x23</span> || SystemInformationClass == <span class="number">0x95</span> </span><br><span class="line">        || SystemInformationClass == <span class="number">0xA3</span> || SystemInformationClass == <span class="number">0xBA</span>) &#123;</span><br><span class="line">        kprintf((<span class="string">&quot;Line %d: calling HalQuerySystemInformation(%p,%p,%p,%p)\n&quot;</span>), __LINE__, SystemInformationClass, SystemInformation, SystemInformationLength, ReturnLength);</span><br><span class="line">        dohook1(TRUE);</span><br><span class="line">        <span class="keyword">return</span> STATUS_UNSUCCESSFUL;</span><br><span class="line">    &#125;</span><br><span class="line">    ULONG64 s = func(SystemInformationClass, SystemInformation, SystemInformationLength, ReturnLength);</span><br><span class="line">    dohook1(TRUE);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">NTSTATUS</span><span class="params">(*kebugcheck_ptr)</span> <span class="params">(</span></span><br><span class="line"><span class="params">    _In_ ULONG BugCheckCode,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter1,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter2,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter3,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter4</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line">ULONG  <span class="title function_">myKeBugCheckEx</span><span class="params">(_In_ ULONG BugCheckCode,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter1,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter2,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter3,</span></span><br><span class="line"><span class="params">    _In_ ULONG_PTR BugCheckParameter4</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    dohook3(FALSE);</span><br><span class="line">    kebugcheck_ptr func = (kebugcheck_ptr)HookAddr3;</span><br><span class="line"></span><br><span class="line">    PVOID backtrace[MAX_BACKTRACE_DEPTH];</span><br><span class="line">    USHORT capturedFrames = RtlCaptureStackBackTrace(<span class="number">0</span>, MAX_BACKTRACE_DEPTH, backtrace, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    kprintf((<span class="string">&quot;Line %d: calling KeBugCheckEx(%p,%p,%p,%p,%p)\n&quot;</span>), __LINE__, BugCheckCode, BugCheckParameter1, BugCheckParameter2, BugCheckParameter3, BugCheckParameter4);</span><br><span class="line">    <span class="keyword">if</span> (BugCheckCode == <span class="number">0x414345</span>) &#123;</span><br><span class="line">        dohook3(TRUE);</span><br><span class="line">        <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">    &#125;</span><br><span class="line">    ULONG64 s = func(BugCheckCode, BugCheckParameter1, BugCheckParameter2, BugCheckParameter3, BugCheckParameter4);</span><br><span class="line">    dohook3(TRUE);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DeleteDevice</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Deleting Driver\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="keyword">if</span> (pDriver-&gt;DeviceObject) &#123;</span><br><span class="line">        UNICODE_STRING DeviceName;</span><br><span class="line">        RtlInitUnicodeString(&amp;DeviceName, SYM);</span><br><span class="line">        IoDeleteSymbolicLink(&amp;DeviceName);</span><br><span class="line">        IoDeleteDevice(pDriver-&gt;DeviceObject);</span><br><span class="line">    &#125;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Deleted\n&quot;</span>, __LINE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Unloading Driver\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="keyword">if</span> (Hooked3) &#123;</span><br><span class="line">        dohook3(FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">    DeleteDevice(pDriver);</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Unloaded\n&quot;</span>, __LINE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Loaded, RegistryPath : %S\n&quot;</span>, __LINE__, RegistryPath-&gt;Buffer);</span><br><span class="line"></span><br><span class="line">    HookAddr1 = (u64)HalQuerySystemInformation;</span><br><span class="line">    HookAddr2 = (u64)KdRefreshDebuggerNotPresent;</span><br><span class="line">    HookAddr3 = (u64)KeBugCheckEx;</span><br><span class="line">    <span class="built_in">memcpy</span>(origin3, HookAddr3, <span class="keyword">sizeof</span>(origin3));</span><br><span class="line">    <span class="built_in">memcpy</span>(origin2, HookAddr2, <span class="keyword">sizeof</span>(origin2));</span><br><span class="line">    <span class="built_in">memcpy</span>(origin1, HookAddr1, <span class="keyword">sizeof</span>(origin1));</span><br><span class="line">    *((u64*)(mov_jmp_rax3 + <span class="number">2</span>)) = (u64)myKeBugCheckEx;</span><br><span class="line">    *((u64*)(mov_jmp_rax2 + <span class="number">2</span>)) = (u64)myKdRefreshDebugNotPresent;</span><br><span class="line">    *((u64*)(mov_jmp_rax1 + <span class="number">2</span>)) = (u64)myHalQuerySystemInformation;</span><br><span class="line">    dohook3(TRUE);</span><br><span class="line">    dohook2(TRUE);</span><br><span class="line">    dohook1(TRUE);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先运行hook驱动再运行题目驱动成功让调试器正常附加到内核上了:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-133331.png" alt="QQ_1744522409303"></p>
<h2 id="1-在intel-CPU-64位Windows10系统上运行sys-成功加载驱动-0-5分"><a href="#1-在intel-CPU-64位Windows10系统上运行sys-成功加载驱动-0-5分" class="headerlink" title="(1)在intel CPU&#x2F;64位Windows10系统上运行sys 成功加载驱动(0.5分)"></a>(1)<strong>在intel CPU&#x2F;64位Windows10系统</strong>上运行sys 成功加载驱动(0.5分)</h2><p>能够调试驱动过后找到导致驱动加载失败的位置 现在IDA中静态分析:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-133547.png" alt="QQ_1744522533947"></p>
<p><code>E3B8</code>的返回值应该就是驱动加载成功的关键 最终定位到这个函数:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-135654.png" alt="QQ_1744523799960"></p>
<p>如果要正确加载驱动这个函数应该返回0 也就是需要一直执行到<code>important()</code>中间没有跳转 调试到此处通过修改标志位来让它返回0 最后成功加载驱动:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-140617.png" alt="img"></p>
<h2 id="3-优化驱动中的耗时算法-并给出demo能快速计算得出正确的key-1分"><a href="#3-优化驱动中的耗时算法-并给出demo能快速计算得出正确的key-1分" class="headerlink" title="(3)优化驱动中的耗时算法 并给出demo能快速计算得出正确的key(1分)"></a>(3)优化驱动中的耗时算法 并给出demo能快速计算得出正确的key(1分)</h2><p>在上面的调试过程中发现<code>important()</code>调用了位于<code>0x9930</code>处的函数 而这个函数中间提示了它应该就是需要改进的耗时算法:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-141000.png" alt="QQ_1744524570828"></p>
<p>在进入耗时函数之前还执行了位于<code>0x670C</code>处的函数 开始就先解密了一个字符串:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-144512.png" alt="QQ_1744526708788"></p>
<p>dump出解密结果得到是<code>\Registry\Machine\System\CurrentControlSet\Services\ACEDriver\2025ACECTF</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="string">&quot;&quot;&quot;5C 00 52 00 65 00 67 00 69 00 73 00 74 00 72 00</span></span><br><span class="line"><span class="string">79 00 5C 00 4D 00 61 00 63 00 68 00 69 00 6E 00</span></span><br><span class="line"><span class="string">65 00 5C 00 53 00 79 00 73 00 74 00 65 00 6D 00</span></span><br><span class="line"><span class="string">5C 00 43 00 75 00 72 00 72 00 65 00 6E 00 74 00</span></span><br><span class="line"><span class="string">43 00 6F 00 6E 00 74 00 72 00 6F 00 6C 00 53 00</span></span><br><span class="line"><span class="string">65 00 74 00 5C 00 53 00 65 00 72 00 76 00 69 00</span></span><br><span class="line"><span class="string">63 00 65 00 73 00 5C 00 41 00 43 00 45 00 44 00</span></span><br><span class="line"><span class="string">72 00 69 00 76 00 65 00 72 00 5C 00 32 00 30 00</span></span><br><span class="line"><span class="string">32 00 35 00 41 00 43 00 45 00 43 00 54 00 46 00</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> line <span class="keyword">in</span> text.split(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>]:</span><br><span class="line">    line = line.replace(<span class="string">&#x27; 00&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">bytes</span>.fromhex(line).decode(), end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>那驱动大概率通过注册表来获取了一些值 在<code>ZwOpenKey</code>和<code>ZwQueryValueKey</code>下断点发现在进入程序时就读取了<code>\Registry\Machine\System\CurrentControlSet\Services\ACEDriver\2025ACECTF</code>的内容:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-152400.png" alt="QQ_1744529032944"></p>
<p>先随便创建一个对应的注册表键值对在下一次调试时看看具体读取的是哪个键:</p>
<p><code>reg add &quot;HKLM\System\CurrentControlSet\Services\ACEDriver\2025ACECTF&quot; /v &quot;Flag&quot; /t REG_SZ /d &quot;flag&#123;testflaggggggggggggg&#125;&quot; /f</code></p>
<p>在<code>ZwQueryValueKey</code>处的断点还得知了它要读取的键名为<code>Key</code> 并且第2次调用时可以得知大小至少为8字节 应该是一个QWORD:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-153342.png" alt="QQ_1744529599453"></p>
<p>那么先创建这个键看看下一次如果读取成功的话会对key进行什么操作:</p>
<p><code>reg add &quot;HKLM\System\CurrentControlSet\Services\ACEDriver\2025ACECTF&quot; /v &quot;Key&quot; /t REG_QWORD /d 0xACE6ACE6ACE6ACE6 /f</code></p>
<p>后续又读取了<code>Flag</code>:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-175052.png" alt="QQ_1744537836977"></p>
<p>在<code>0x6a61</code>处读取到了flag:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-180051.png" alt="QQ_1744538422996"></p>
<p>再执行时发现驱动就启动成功了 且不需要修改返回值:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-180445.png" alt="QQ_1744538684000"></p>
<p>也就是说驱动加载成功的关键是注册表中有Key和Flag两项</p>
<p>后续调试发现如果要让程序自己计算正确的Key就需要不传入Key 手动修改跳转条件使其进入待改进的算法 :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">to_promote</span><span class="params">(__int32 _0x2c, <span class="type">unsigned</span> <span class="type">int</span> _0x16)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD *v4; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdi</span></span><br><span class="line">  __int64 v6; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD *seq; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// r10d</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// ecx</span></span><br><span class="line">  __int64 v12; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v13; <span class="comment">// r8</span></span><br><span class="line">  __int64 v14; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v15; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v16; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v17; <span class="comment">// rax</span></span><br><span class="line">  __int64 v18; <span class="comment">// rcx</span></span><br><span class="line">  __int128 <span class="built_in">vector</span>; <span class="comment">// [rsp+20h] [rbp-50h] BYREF</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+30h] [rbp-40h]</span></span><br><span class="line">  __int64 v22; <span class="comment">// [rsp+38h] [rbp-38h]</span></span><br><span class="line">  __int64 v23; <span class="comment">// [rsp+40h] [rbp-30h]</span></span><br><span class="line">  __int32 now_1; <span class="comment">// [rsp+48h] [rbp-28h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> next; <span class="comment">// [rsp+4Ch] [rbp-24h]</span></span><br><span class="line">  __int64 v26; <span class="comment">// [rsp+50h] [rbp-20h]</span></span><br><span class="line">  __int64 v27; <span class="comment">// [rsp+58h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> v28; <span class="comment">// [rsp+60h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">vector</span> = <span class="number">0LL</span>;</span><br><span class="line">  v21 = <span class="number">0LL</span>;</span><br><span class="line">  v22 = <span class="number">0LL</span>;</span><br><span class="line">  v23 = <span class="number">0LL</span>;</span><br><span class="line">  v4 = (_QWORD *)sub_B0F4(<span class="number">16LL</span>);</span><br><span class="line">  v4[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  *(_QWORD *)&amp;<span class="built_in">vector</span> = v4;</span><br><span class="line">  *v4 = &amp;<span class="built_in">vector</span>;</span><br><span class="line">  v5 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( _0x2c )</span><br><span class="line">  &#123;</span><br><span class="line">    now_1 = _0x2c;</span><br><span class="line">    next = _0x16;</span><br><span class="line">LABEL_4:</span><br><span class="line">    v26 = <span class="number">0LL</span>;</span><br><span class="line">    v27 = <span class="number">0LL</span>;</span><br><span class="line">    v28 = <span class="number">0</span>;</span><br><span class="line">    append(&amp;<span class="built_in">vector</span>, &amp;now_1);</span><br><span class="line">    v6 = v23;</span><br><span class="line">    <span class="keyword">while</span> ( v6 )</span><br><span class="line">    &#123;</span><br><span class="line">      seq = *(_QWORD **)(*((_QWORD *)&amp;<span class="built_in">vector</span> + <span class="number">1</span>) + <span class="number">8</span> * ((v21 - <span class="number">1</span>) &amp; (v6 + v22 - <span class="number">1</span>)));<span class="comment">// start with 0x2c 0x16</span></span><br><span class="line">      v8 = *((_DWORD *)seq + <span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !v8 || (v9 = *(_DWORD *)seq, v8 == *(_DWORD *)seq) )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = <span class="number">1LL</span>;</span><br><span class="line">        v23 = --v6;</span><br><span class="line">        v22 &amp;= -(__int64)(v6 != <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v10 = *((_DWORD *)seq + <span class="number">6</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v10 )</span><br><span class="line">        &#123;</span><br><span class="line">          *((_DWORD *)seq + <span class="number">6</span>) = <span class="number">1</span>;</span><br><span class="line">          now_1 = v9 - <span class="number">1</span>;</span><br><span class="line">          next = v8;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">        &#125;</span><br><span class="line">        v11 = v10 - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( !v11 )</span><br><span class="line">        &#123;</span><br><span class="line">          seq[<span class="number">1</span>] = v5;</span><br><span class="line">          *((_DWORD *)seq + <span class="number">6</span>) = <span class="number">2</span>;</span><br><span class="line">          now_1 = v9 - <span class="number">1</span>;</span><br><span class="line">          next = v8 - <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_4;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v11 == <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          seq[<span class="number">2</span>] = v5;</span><br><span class="line">          v5 += seq[<span class="number">1</span>] + v9 % <span class="number">5</span>;</span><br><span class="line">          v6 = --v23;</span><br><span class="line">          <span class="keyword">if</span> ( !v23 )</span><br><span class="line">            v22 = <span class="number">0LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    sub_DDAD(<span class="string">&quot;This step will take a long time to run, maybe 12 hours (depending on your machine), maybe you have a better way?&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后面对最后返回的v5 即key没有影响 只用分析上面的 初步分析可以定义出下面几个结构体 不知道含义的先随便用xyz之类的顶着:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">00000000</span> <span class="class"><span class="keyword">struct</span> <span class="title">data</span> // <span class="title">sizeof</span>=</span><span class="number">0x20</span></span><br><span class="line"><span class="number">00000000</span> &#123;</span><br><span class="line"><span class="number">00000000</span>     _DWORD x;</span><br><span class="line"><span class="number">00000004</span>     _DWORD y;</span><br><span class="line"><span class="number">00000008</span>     _QWORD last;</span><br><span class="line"><span class="number">00000010</span>     _QWORD now;</span><br><span class="line"><span class="number">00000018</span>     _DWORD step;</span><br><span class="line"><span class="number">0000001</span>C     <span class="comment">// padding byte</span></span><br><span class="line"><span class="number">0000001</span>D     <span class="comment">// padding byte</span></span><br><span class="line"><span class="number">0000001</span>E     <span class="comment">// padding byte</span></span><br><span class="line"><span class="number">0000001F</span>     <span class="comment">// padding byte</span></span><br><span class="line"><span class="number">00000020</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> <span class="class"><span class="keyword">struct</span> <span class="title">Vector</span> // <span class="title">sizeof</span>=</span><span class="number">0x28</span></span><br><span class="line"><span class="number">00000000</span> &#123;                                       <span class="comment">// XREF: to_promote/r</span></span><br><span class="line"><span class="number">00000000</span>     _QWORD *self;                       <span class="comment">// XREF: to_promote+30/w</span></span><br><span class="line"><span class="number">00000000</span>                                         <span class="comment">// to_promote+51/w ...</span></span><br><span class="line"><span class="number">00000008</span>     data **data;                        <span class="comment">// XREF: to_promote+B0/r</span></span><br><span class="line"><span class="number">00000008</span>                                         <span class="comment">// to_promote+1AD/r ...</span></span><br><span class="line"><span class="number">00000010</span>     _QWORD align1;                      <span class="comment">// XREF: to_promote+38/w</span></span><br><span class="line"><span class="number">00000010</span>                                         <span class="comment">// to_promote+A6/r ...</span></span><br><span class="line"><span class="number">00000018</span>     _QWORD align2;                      <span class="comment">// XREF: to_promote+3C/w</span></span><br><span class="line"><span class="number">00000018</span>                                         <span class="comment">// to_promote:loc_99CC/r ...</span></span><br><span class="line"><span class="number">00000020</span>     _QWORD have;</span><br><span class="line"><span class="number">00000028</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="number">00000000</span> <span class="class"><span class="keyword">struct</span> <span class="title">KeyPair</span> // <span class="title">sizeof</span>=</span><span class="number">0x10</span></span><br><span class="line"><span class="number">00000000</span> &#123;                                       <span class="comment">// XREF: to_promote/r</span></span><br><span class="line"><span class="number">00000000</span>     _DWORD x;                           <span class="comment">// XREF: to_promote:loc_99A4/w</span></span><br><span class="line"><span class="number">00000000</span>                                         <span class="comment">// to_promote+130/w ...</span></span><br><span class="line"><span class="number">00000004</span>     _DWORD y;                           <span class="comment">// XREF: to_promote+77/w</span></span><br><span class="line"><span class="number">00000004</span>                                         <span class="comment">// to_promote+137/w ...</span></span><br><span class="line"><span class="number">00000008</span>     _QWORD z;                           <span class="comment">// XREF: to_promote:loc_99AA/w</span></span><br><span class="line"><span class="number">00000010</span> &#125;;</span><br></pre></td></tr></table></figure>

<p>逻辑清晰了一点:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F16%2F20250416-204559.png" alt="QQ_1744807550117"></p>
<p>接下来就用调试来分析了</p>
<blockquote>
<p>但是算法这块还是太史了 比赛的时候就做到这里 下面是根据网上的wp进行复现的</p>
</blockquote>
<p>重点应该是<code>now</code>的赋值(<code>99EF</code>)以及那个不是对<code>step</code>进行判断的特殊的分支(<code>9AA0</code>) 分别下断点观察一下 取出的<code>data</code>结构体放在<code>r8</code>中 经过几轮调试观察取出来的<code>data</code>的<code>x</code>和<code>y</code> 可以大致发现规律 下面是一个辅助理解的python程序:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> sleep</span><br><span class="line"></span><br><span class="line">colors = &#123;<span class="number">0</span>: <span class="string">&#x27;green&#x27;</span>, <span class="number">1</span>: <span class="string">&#x27;blue&#x27;</span>, <span class="number">2</span>: <span class="string">&#x27;red&#x27;</span>&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Point</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line">        self.weight = <span class="number">0</span></span><br><span class="line">        self.stage  = <span class="number">0</span>    </span><br><span class="line"></span><br><span class="line">points = [Point(<span class="number">44</span>, <span class="number">22</span>)]</span><br><span class="line"><span class="built_in">sum</span> = <span class="number">0</span></span><br><span class="line">plt.ion()</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="built_in">len</span>(points):</span><br><span class="line">    <span class="keyword">if</span> points[-<span class="number">1</span>].x == points[-<span class="number">1</span>].y <span class="keyword">or</span> points[-<span class="number">1</span>].y == <span class="number">0</span>:</span><br><span class="line">        <span class="built_in">sum</span> = <span class="number">1</span></span><br><span class="line">        points.pop()</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">match</span> points[-<span class="number">1</span>].stage:</span><br><span class="line">        <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">            points[-<span class="number">1</span>].stage = <span class="number">1</span></span><br><span class="line">            points += [Point(points[-<span class="number">1</span>].x - <span class="number">1</span>, points[-<span class="number">1</span>].y)]</span><br><span class="line">        <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">            points[-<span class="number">1</span>].weight = <span class="built_in">sum</span></span><br><span class="line">            points[-<span class="number">1</span>].stage = <span class="number">2</span></span><br><span class="line">            points += [Point(points[-<span class="number">1</span>].x - <span class="number">1</span>, points[-<span class="number">1</span>].y - <span class="number">1</span>)]</span><br><span class="line">        <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">            <span class="built_in">sum</span> += points[-<span class="number">1</span>].weight + (points[-<span class="number">1</span>].x % <span class="number">5</span>)</span><br><span class="line">            points.pop()</span><br><span class="line"></span><br><span class="line">    _<span class="built_in">max</span> = <span class="number">0</span></span><br><span class="line">    plt.clf()</span><br><span class="line">    <span class="keyword">for</span> p <span class="keyword">in</span> points:</span><br><span class="line">        plt.scatter(p.x, p.y, color=colors[p.stage])</span><br><span class="line">        <span class="keyword">if</span> p.weight != <span class="number">0</span>:</span><br><span class="line">            plt.text(p.x + <span class="number">0.1</span>, p.y + <span class="number">0.1</span>, <span class="string">f&#x27;<span class="subst">&#123;p.weight&#125;</span>&#x27;</span>, fontsize=<span class="number">8</span>, color=<span class="string">&#x27;blue&#x27;</span>)</span><br><span class="line">        _<span class="built_in">max</span> = <span class="built_in">max</span>(_<span class="built_in">max</span>, p.x, p.y)</span><br><span class="line">    x_line = np.arange(<span class="number">0</span>, _<span class="built_in">max</span> + <span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    y_line = x_line</span><br><span class="line">    plt.plot(x_line, y_line, label=<span class="string">&quot;x=y&quot;</span>, color=<span class="string">&#x27;red&#x27;</span>, linestyle=<span class="string">&#x27;-&#x27;</span>)</span><br><span class="line">    plt.xticks(np.arange(<span class="number">0</span>, _<span class="built_in">max</span> + <span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">    plt.yticks(np.arange(<span class="number">0</span>, _<span class="built_in">max</span> + <span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">    plt.axis([<span class="number">0</span>, _<span class="built_in">max</span> + <span class="number">1</span>, <span class="number">0</span>, _<span class="built_in">max</span> + <span class="number">1</span>])</span><br><span class="line">    plt.legend()</span><br><span class="line">    plt.title(<span class="string">f&#x27;Sum = <span class="subst">&#123;<span class="built_in">sum</span>&#125;</span>&#x27;</span>)</span><br><span class="line">    plt.grid(<span class="literal">True</span>)</span><br><span class="line">    plt.pause(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;Final sum = <span class="subst">&#123;<span class="built_in">hex</span>(<span class="built_in">sum</span>)&#125;</span>&#x27;</span>)</span><br><span class="line">plt.ioff()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>可以发现是一个求路径和的算法 计算从<code>(44, 22)</code> 到<code>(0, 0)</code>的一个特殊路径和 只能往左或者左下走走一格 用公式来表示大概是<code>W(x, y) = W(x - 1, y) + W(x - 1, y - 1) + (x % 5)</code> 往左走优先于往左下走 在<code>y = 0</code>和<code>y = x</code>两条曲线上的点权重为0</p>
<p>题目给的驱动里面用的是类似递归的算法 可以直接正向求解 时间复杂度可以降至<code>O(n)</code>:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">prev_row = [<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">45</span>):</span><br><span class="line">    y_max = <span class="built_in">min</span>(x, <span class="number">22</span>)</span><br><span class="line">    current_row = [<span class="number">0</span>] * (y_max + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> y <span class="keyword">in</span> <span class="built_in">range</span>(y_max + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> y == <span class="number">0</span> <span class="keyword">or</span> y == x:</span><br><span class="line">            current_row[y] = <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            term1 = prev_row[y] <span class="keyword">if</span> y &lt; <span class="built_in">len</span>(prev_row) <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            term2 = prev_row[y-<span class="number">1</span>] <span class="keyword">if</span> (y-<span class="number">1</span> &gt;= <span class="number">0</span> <span class="keyword">and</span> y-<span class="number">1</span> &lt; <span class="built_in">len</span>(prev_row)) <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">            current_row[y] = term1 + term2 + (x % <span class="number">5</span>)</span><br><span class="line">    prev_row = current_row</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(prev_row[<span class="number">22</span>]))</span><br><span class="line"><span class="comment"># 0x66711265fd2</span></span><br></pre></td></tr></table></figure>

<p>正确的Key为<code>0x66711265fd2</code></p>
<h2 id="4-分析并给出flag的计算执行流程-1-5分-能准确说明其串联逻辑-0-5分"><a href="#4-分析并给出flag的计算执行流程-1-5分-能准确说明其串联逻辑-0-5分" class="headerlink" title="(4)分析并给出flag的计算执行流程(1.5分) 能准确说明其串联逻辑(0.5分)"></a>(4)分析并给出flag的计算执行流程(1.5分) 能准确说明其串联逻辑(0.5分)</h2><p>在注册表中填充正确的key:<code>reg add &quot;HKLM\System\CurrentControlSet\Services\ACEDriver\2025ACECTF&quot; /v &quot;Key&quot; /t REG_QWORD /d 0x66711265fd2 /f</code></p>
<p>后续跟进Key的处理发现了第一步加密:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-195014.png" alt="QQ_1744544994801"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F13%2F20250413-195026.png" alt="QQ_1744545022126"></p>
<p>也就是将flag和上面得到的key(d2 5f 26 11 67 06)进行异或 但是从内存中(<code>[r15+RCX]</code>)取出flag时会发现和用WinDbg查到的不一样 第1位应该是<code>0x66</code> 但是经过<code>0x95df</code>的mov al后得到的却是0x95 合理怀疑特意为flag分配了一个page是为了进行EPThook 查找<code>vmresume(0F 01 C3)</code>指令看看能不能找到 VT对虚拟机退出进行异常处理的位置 然后查找到了<code>0x1220</code>处的ExitHandler 其中调用的<code>0x5150</code>应该是就分发器 其中<code>_RCX</code>应该就是从VMCS中取出的Exit Reason:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F08%2F20250508-140135.png" alt="QQ_1746684048947"></p>
<p>根据Intel手册(或者直接看linux的<a target="_blank" rel="noopener" href="https://github.com/torvalds/linux/blob/master/arch/x86/include/uapi/asm/vmx.h">vmx.h</a>) <code>EPT violation</code>对应数值0x30 进行运算后为<code>0x460d</code> 找对对应的handler<code>0x2B78</code> 下面大概是取出了Exit qualification看是不是mov al那条指令导致的 那么就可以确定其中的就是handler:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F08%2F20250508-134151.png" alt="QQ_1746682900777"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F08%2F20250508-142205.png" alt="QQ_1746685322531"></p>
<p>中间取的大概是Guest的寄存器 按照x86_64的寄存器顺序大概可以判断这几个变量的含义 接下来handler根据取出的当前flag位和其下标进行了一个校验值计算:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> __fastcall <span class="title function_">ept_violation_handler</span><span class="params">(<span class="type">char</span> now, <span class="type">char</span> idx)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> res; <span class="comment">// r10</span></span><br><span class="line">  <span class="type">bool</span> v3; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v4; <span class="comment">// r11</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v5; <span class="comment">// dl</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v6; <span class="comment">// cl</span></span><br><span class="line">  __int64 v7; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v8; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v9; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">char</span> v10; <span class="comment">// r9</span></span><br><span class="line">  __int64 v11; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// eax</span></span><br><span class="line">  _BYTE *v13; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">char</span> v14; <span class="comment">// dl</span></span><br><span class="line">  <span class="type">char</span> v15; <span class="comment">// dl</span></span><br><span class="line">  _BYTE v17[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-18h] BYREF</span></span><br><span class="line"></span><br><span class="line">  res = <span class="number">0</span>;</span><br><span class="line">  v4 = idx ^ now;</span><br><span class="line">  v3 = idx == now;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = v4;</span><br><span class="line">  <span class="keyword">if</span> ( !v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v5 += v6 &amp; <span class="number">1</span>;</span><br><span class="line">      v6 &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v6 );</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = <span class="number">7LL</span>;</span><br><span class="line">  v8 = v5;</span><br><span class="line">  *(_DWORD *)v17 = <span class="number">0x3020100</span>;</span><br><span class="line">  *(_DWORD *)&amp;v17[<span class="number">4</span>] = <span class="number">0x7060504</span>;</span><br><span class="line">  v9 = <span class="number">8</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v10 = v17[v7];</span><br><span class="line">    v8 = <span class="number">0x3F5713FCCC7C79AA</span>LL * v8 + <span class="number">0x3A7D9E5B36F498B2</span>LL;</span><br><span class="line">    v11 = HIDWORD(v8) % v9--;</span><br><span class="line">    v17[v7--] = v17[v11];</span><br><span class="line">    v17[v11] = v10;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v7 &gt; <span class="number">0</span> );</span><br><span class="line">  v12 = <span class="number">0</span>;</span><br><span class="line">  v13 = v17;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v14 = v4 &gt;&gt; *v13++;</span><br><span class="line">    v15 = (v14 &amp; <span class="number">1</span>) &lt;&lt; v12++;</span><br><span class="line">    res |= v15;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v12 &lt; <span class="number">8</span> );</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>大概是根据当前的字节和下标生成一个乱序的set(0~7)并根据这个序列调换当前字节的每个位 这个过程明显是不可逆的 但是可以打印出所有下标和值进行计算的结果最后取表</p>
<p>接下来就是经典TEA(0x93B8):</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F12%2F20250512-105901.png" alt="QQ_1747018663779"></p>
<p>但是连初赛都上了inline hook 决赛的TEA绝对不是看上去那么简单 果然调试的时候就能发现给delta赋值这一步执行的指令和读到的就已经不一样了:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F12%2F20250512-113324.png" alt="QQ_1747020775137"></p>
<p>这里肯定是上了ept hook 但是在处理<code>EPT violation</code>的handler中能明显看出来根据指令hook的只有上面用key和flag异或那一步根据是否是mov al进行操作 既然没有根据指令hook 那应该就是直接hook了一整个页 这里识别出VT框架就很重要了 看网上的wp说是<a target="_blank" rel="noopener" href="https://github.com/jonomango/hv">hv</a>框架的 该框架在处理<code>EPT violation</code>时会<a target="_blank" rel="noopener" href="https://github.com/jonomango/hv/blob/main/hv/exit-handlers.cpp#L547">将安装了ept hook的假页面返回</a> 交叉引用<code>install_ept_hook</code>可以发现该框架可以通过<a target="_blank" rel="noopener" href="https://github.com/jonomango/hv/blob/main/hv/exit-handlers.cpp#L204">guest执行vmcall主动向host发送安装ept hook的请求</a> </p>
<p>再看看<code>hc::install_ept_hook</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// install an EPT hook for the CURRENT logical processor ONLY</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">install_ept_hook</span><span class="params">(vcpu* <span class="type">const</span> cpu)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// arguments</span></span><br><span class="line">  <span class="keyword">auto</span> <span class="type">const</span> orig_page_pfn = cpu-&gt;ctx-&gt;rcx;</span><br><span class="line">  <span class="keyword">auto</span> <span class="type">const</span> exec_page_pfn = cpu-&gt;ctx-&gt;rdx;</span><br><span class="line"></span><br><span class="line">  cpu-&gt;ctx-&gt;rax = <span class="built_in">install_ept_hook</span>(cpu-&gt;ept, orig_page_pfn, exec_page_pfn);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">skip_instruction</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要hook的页面和实际执行的页面分别在执行vmcall时存放在RCX和RDX中 在驱动中唯一一个vmcall(0x1557)下断应该就能得到实际执行的函数了:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F12%2F20250512-132919.png" alt="QQ_1747027684894"></p>
<p>dump出这个页(4kb)后缝到之前dump出来的驱动上方便用IDA分析:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">origin = <span class="built_in">bytearray</span>(<span class="built_in">open</span>(<span class="string">&#x27;.\dumpsys.sys&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line">patch  = <span class="built_in">bytearray</span>(<span class="built_in">open</span>(<span class="string">&#x27;.\eptdump.bin&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line">origin[<span class="number">0x1000</span>:<span class="number">0x2000</span>] = patch</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;.\eptsys.sys&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(origin)</span><br></pre></td></tr></table></figure>

<p>得到实际执行的TEA:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">TEA</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> *flag, _DWORD *key)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+0h] [rbp-58h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v0; <span class="comment">// [rsp+4h] [rbp-54h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// [rsp+8h] [rbp-50h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// [rsp+Ch] [rbp-4Ch]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v0 = *flag;</span><br><span class="line">  v1 = flag[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v0 += (v3 + key[v3 &amp; <span class="number">3</span>]) ^ (v1 + ((v1 &gt;&gt; <span class="number">5</span>) ^ (<span class="number">16</span> * v1)));</span><br><span class="line">    v3 -= <span class="number">0x788EEF63</span>;</span><br><span class="line">    v1 = v1 + <span class="number">0x7C77AF7C</span> + ((v3 + v0) ^ v0 ^ (key[<span class="number">2</span>] + <span class="number">16</span> * v0) ^ (key[<span class="number">3</span>] + (v0 &gt;&gt; <span class="number">5</span>)) ^ <span class="number">0x4321</span>) - <span class="number">0x5901181B</span>;</span><br><span class="line">    ++v6;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v6 &lt; <span class="number">0x3C</span> );</span><br><span class="line">  result = v0;</span><br><span class="line">  *flag = v0;</span><br><span class="line">  flag[<span class="number">1</span>] = v1;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续调试可以发现执行完TEA后与密文进行比较前flag又发生了变动 <code>0x94A1</code>处的<code>rdmsr</code>指令执行完后flag就发生了变化 read msr导致的退出Exit Reason为0x1f 计算完后为0x690d 对应handler在0x2608 根据某个和0xE8对比的变量可以推测a1在0x2740B8偏移位置的应该就是guest的寄存器指针:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F12%2F20250512-184738.png" alt="img"></p>
<p>找到hv框架中对应的<a target="_blank" rel="noopener" href="https://github.com/jonomango/hv/blob/main/hv/guest-context.h">guset-context</a> 在IDA中定义寄存器结构体 方便后续逆向 后面可以发现就是拆成byte进行异或:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F12%2F20250512-192554.png" alt="QQ_1747049152013"></p>
<p>验证一下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="built_in">vector</span>&lt;<span class="type">uint8_t</span>&gt; test_enc = &#123;<span class="number">0x42</span>, <span class="number">0x7b</span>, <span class="number">0x50</span>, <span class="number">0xb1</span>, <span class="number">0x12</span>, <span class="number">0xf8</span>, <span class="number">0x3d</span>, <span class="number">0xdc</span>&#125;;</span><br><span class="line">    <span class="type">int</span> round = <span class="number">0</span>, count = <span class="number">0</span>;</span><br><span class="line">    <span class="type">uint8_t</span> key1[<span class="number">5</span>], key2[<span class="number">7</span>];</span><br><span class="line">    *(<span class="type">uint32_t</span> *)key1 = <span class="number">0x12CDAD89</span>;</span><br><span class="line">    key1[<span class="number">4</span>] = <span class="number">0x56</span>;</span><br><span class="line">    *(<span class="type">uint32_t</span> *)key2 = <span class="number">0xEF586958</span>;</span><br><span class="line">    *(<span class="type">uint16_t</span> *)&amp;key2[<span class="number">4</span>] = <span class="number">0x46B3</span>;</span><br><span class="line">    key2[<span class="number">6</span>] = <span class="number">0x23</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        <span class="type">uint32_t</span> xor_key = round++ + <span class="number">0x1A</span> + key1[count % <span class="number">5</span>] + key2[count % <span class="number">7</span>];</span><br><span class="line">        test_enc[count++] ^= xor_key;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( round &lt; <span class="number">8</span> );</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> byte : test_enc)&#123;</span><br><span class="line">        <span class="built_in">cout</span> &lt;&lt; hex &lt;&lt; (<span class="type">int</span>)byte &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// b9 4a 11 af 35 16 cd 9a</span></span><br></pre></td></tr></table></figure>

<p>成功验证:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F12%2F20250512-192707.png" alt="img"></p>
<p>到这里就能给出flag计算中的串联逻辑了 即:</p>
<ol>
<li>通过ept hook在读取flag内容时触发<code>EPT Violation</code>根据flag中每个字节和其下标交换字节中的位</li>
<li>与Key循环异或</li>
<li>变异TEA加密</li>
<li>通过读<code>MSR</code>触发<code>Read MSR</code>对flag进行异或</li>
</ol>
<p>EXP:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdint&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> std::vector;</span><br><span class="line"></span><br><span class="line"><span class="type">uint32_t</span> enc[] = &#123;<span class="number">0x199354C3</span>,<span class="number">0xB1FD7BE6</span>,<span class="number">0x73205B55</span>,<span class="number">0xDE5C4D43</span>,<span class="number">0xA4EF9954</span>,<span class="number">0xA97651D4</span>,<span class="number">0xEFBA6B6A</span>,<span class="number">0xC6E221DE</span>,<span class="number">0x8FA342FE</span>,<span class="number">0x4C1C63BE</span>,<span class="number">0xD0AEE4C6</span>,<span class="number">0xC6F63D4B</span>,<span class="number">0x3807EBDA</span>,<span class="number">0x2ADF5814</span>,<span class="number">0x7A83C42E</span>,<span class="number">0x9E348D33</span>,<span class="number">0x782779E4</span>,<span class="number">0xC4A55FC0</span>,<span class="number">0xDC0B64D0</span>,<span class="number">0x7EE36C5D</span>,<span class="number">0xE43BE42C</span>,<span class="number">0xD5E405CA</span>,<span class="number">0xB772C9A7</span>,<span class="number">0x30CDC7</span>,<span class="number">0x2F09B31C</span>,<span class="number">0xFA839DD7</span>,<span class="number">0x57547B88</span>,<span class="number">0xF754B5AE</span>,<span class="number">0x231F7B75</span>,<span class="number">0x13160770</span>,<span class="number">0x6EB71579</span>,<span class="number">0xFA28BBD</span>,<span class="number">0x6103E890</span>,<span class="number">0xEF604E1D</span>&#125;;</span><br><span class="line"><span class="type">uint8_t</span> *bpenc = (<span class="type">uint8_t</span> *)enc;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">/* XOR1 decrypt */</span></span><br><span class="line">    <span class="type">uint8_t</span> key1[<span class="number">5</span>], key2[<span class="number">7</span>];</span><br><span class="line">    *(<span class="type">uint32_t</span> *)key1 = <span class="number">0x12CDAD89</span>;</span><br><span class="line">    key1[<span class="number">4</span>] = <span class="number">0x56</span>;</span><br><span class="line">    *(<span class="type">uint32_t</span> *)key2 = <span class="number">0xEF586958</span>;</span><br><span class="line">    *(<span class="type">uint16_t</span> *)&amp;key2[<span class="number">4</span>] = <span class="number">0x46B3</span>;</span><br><span class="line">    key2[<span class="number">6</span>] = <span class="number">0x23</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> _ = <span class="number">0</span>; _ &lt; ((<span class="number">34</span> - <span class="number">1</span>) &gt;&gt; <span class="number">1</span>) + <span class="number">1</span>; _++)&#123;</span><br><span class="line">        <span class="type">int</span> round = <span class="number">0</span>, count = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            <span class="type">uint8_t</span> xor_key = round++ + <span class="number">34</span> + key1[count % <span class="number">5</span>] + key2[count % <span class="number">7</span>];</span><br><span class="line">            bpenc[count++] ^= xor_key;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( round &lt; <span class="number">8</span> );</span><br><span class="line">        bpenc += <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* TEA decrypt */</span></span><br><span class="line">    <span class="type">uint32_t</span> key[<span class="number">6</span>] = &#123;<span class="number">0x89</span>, <span class="number">0xfe</span>, <span class="number">0x76</span>, <span class="number">0xa0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> _ = <span class="number">0</span>; _ &lt; <span class="number">17</span>; _++)&#123;</span><br><span class="line">        <span class="type">uint32_t</span> v0 = enc[<span class="number">2</span> * _], v1 = enc[<span class="number">2</span> * _ + <span class="number">1</span>], delta = <span class="number">0x788EEF63</span>, sum = <span class="number">0x3c</span> * -delta, round = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">do</span>&#123;</span><br><span class="line">            round++;</span><br><span class="line">            v1 -= <span class="number">0x7C77AF7C</span> + ((sum + v0) ^ v0 ^ (key[<span class="number">2</span>] + <span class="number">16</span> * v0) ^ (key[<span class="number">3</span>] + (v0 &gt;&gt; <span class="number">5</span>)) ^ <span class="number">0x4321</span>) - <span class="number">0x5901181B</span>;</span><br><span class="line">            sum += delta;</span><br><span class="line">            v0 -= (sum + key[sum &amp; <span class="number">3</span>]) ^ (v1 + ((v1 &gt;&gt; <span class="number">5</span>) ^ (<span class="number">16</span> * v1)));</span><br><span class="line">        &#125;<span class="keyword">while</span>(round &lt; <span class="number">0x3c</span>);</span><br><span class="line">        enc[<span class="number">2</span> * _] = v0;</span><br><span class="line">        enc[<span class="number">2</span> * _ + <span class="number">1</span>] = v1;</span><br><span class="line">        cout &lt;&lt; hex &lt;&lt; v0 &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; hex &lt;&lt; v1 &lt;&lt; <span class="string">&quot; &quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* XOR2 decrypt */</span></span><br><span class="line">    <span class="type">uint8_t</span> xor_key[<span class="number">6</span>] = &#123;<span class="number">0xd2</span>, <span class="number">0x5f</span>, <span class="number">0x26</span>, <span class="number">0x11</span>, <span class="number">0x67</span>, <span class="number">0x6</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">34</span>; i++)&#123;</span><br><span class="line">        enc[i] ^= xor_key[i % <span class="number">6</span>];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Brute force */</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> idx = <span class="number">0</span>; idx &lt; <span class="number">34</span>; idx++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> byte = <span class="number">0</span>; byte &lt; <span class="number">0x100</span>; byte++)&#123;</span><br><span class="line">            <span class="type">uint64_t</span> seed = <span class="number">0</span>, r1 = <span class="number">7</span>, r2 = <span class="number">8</span>;</span><br><span class="line">            <span class="type">uint8_t</span> rand_key[<span class="number">8</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">            *(<span class="type">uint32_t</span> *)rand_key = <span class="number">0x3020100</span>;</span><br><span class="line">            *(<span class="type">uint32_t</span> *)&amp;rand_key[<span class="number">4</span>] = <span class="number">0x7060504</span>;</span><br><span class="line">            <span class="type">uint8_t</span> tmp = byte ^ idx, new_seed = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">do</span>&#123;</span><br><span class="line">                seed += tmp &amp; <span class="number">1</span>;</span><br><span class="line">                tmp &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">while</span>(tmp &gt; <span class="number">0</span>);</span><br><span class="line">            <span class="keyword">do</span>&#123;</span><br><span class="line">                <span class="type">uint8_t</span> tmp = rand_key[r1];</span><br><span class="line">                seed =  <span class="number">0x3F5713FCCC7C79AA</span>LL * seed + <span class="number">0x3A7D9E5B36F498B2</span>LL;</span><br><span class="line">                <span class="type">uint64_t</span> new_idx = (seed &gt;&gt; <span class="number">0x20</span>) % r2--;</span><br><span class="line">                rand_key[r1--] = rand_key[new_idx];</span><br><span class="line">                rand_key[new_idx] = tmp;</span><br><span class="line">            &#125;<span class="keyword">while</span>(r1 &gt; <span class="number">0</span>);</span><br><span class="line">            r1 = <span class="number">0</span>;</span><br><span class="line">            <span class="type">uint8_t</span> res = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">do</span>&#123;</span><br><span class="line">                <span class="type">uint8_t</span> tmp1 = (idx ^ byte) &gt;&gt; rand_key[r1], tmp2 = (tmp1 &amp; <span class="number">1</span>) &lt;&lt; (r1++);</span><br><span class="line">                res |= tmp2;</span><br><span class="line">            &#125;<span class="keyword">while</span>(r1 &lt; <span class="number">8</span>);</span><br><span class="line">            <span class="keyword">if</span>(res == enc[idx])&#123;</span><br><span class="line">                cout &lt;&lt; (<span class="type">char</span>)byte;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="6-该题目使用了一种外挂常用的隐藏手段-请给出多种检测方法-要求demo程序能在题目驱动运行的环境下进行精确检测-方法越多分数越高-3分"><a href="#6-该题目使用了一种外挂常用的隐藏手段-请给出多种检测方法-要求demo程序能在题目驱动运行的环境下进行精确检测-方法越多分数越高-3分" class="headerlink" title="(6)该题目使用了一种外挂常用的隐藏手段 请给出多种检测方法 要求demo程序能在题目驱动运行的环境下进行精确检测 方法越多分数越高(3分)"></a>(6)该题目使用了一种外挂常用的隐藏手段 请给出多种检测方法 要求demo程序能在题目驱动运行的环境下进行精确检测 方法越多分数越高(3分)</h2><p>从上面的分析能看出要检验的应该就是是否开启VT</p>
<h3 id="方法1-cpuid执行的cpu周期"><a href="#方法1-cpuid执行的cpu周期" class="headerlink" title="方法1: cpuid执行的cpu周期"></a>方法1: cpuid执行的cpu周期</h3><p><code>cpuid</code>作为一条特权指令 在VT环境下执行会触发VM-exit交由host处理 即使题目的VT框架没有特殊处理这条特权指令 但是下面这些代码都是会执行的:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F15%2F20250515-214852.png" alt="QQ_1747316790832"></p>
<p>这肯定比执行一条<code>cpuid</code>所需的时间长 所以可以通过执行和<code>cpuid</code>所需时间差不多长的指令来找到一个基准 如果执行<code>cpuid</code>的时间远超这个值基本上就可以确定当前处于VT环境下 先测一下非嵌套VT环境下执行cpuid所需的时间:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntdef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntstatus.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_BACKTRACE_DEPTH 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYM <span class="string">L&quot;\\??\\VTcheck1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kprintf(format, ...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, format, __VA_ARGS__)</span></span><br><span class="line"><span class="keyword">typedef</span> UINT64 u64;</span><br><span class="line"><span class="keyword">typedef</span> UINT32 u32;</span><br><span class="line"><span class="keyword">typedef</span> UINT16 u16;</span><br><span class="line"><span class="keyword">typedef</span> UINT8  u8;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">PerformTimingTest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">const</span> u32 iterations = <span class="number">1000000</span>;</span><br><span class="line">    u64 start = <span class="number">0</span>, end = <span class="number">0</span>, total = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> cpuinfo[<span class="number">4</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// Bind current thread to CPU 0  </span></span><br><span class="line">    KAFFINITY oldAffinity = KeSetSystemAffinityThreadEx((KAFFINITY)<span class="number">1</span>);</span><br><span class="line">    KIRQL oldIrql = KeRaiseIrqlToDpcLevel();</span><br><span class="line">    <span class="keyword">for</span> (u32 i = <span class="number">0</span>; i &lt; iterations; i++) &#123;</span><br><span class="line">        start = __rdtsc();</span><br><span class="line"></span><br><span class="line">        __cpuid(cpuinfo, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        end = __rdtsc();</span><br><span class="line">        total += (end - start);</span><br><span class="line">    &#125;</span><br><span class="line">    u64 avg = total / iterations;</span><br><span class="line">    KeLowerIrql(oldIrql);</span><br><span class="line">    KeRevertToUserAffinityThreadEx(oldAffinity);</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Average CPU cycles for __cpuid: %llu\n&quot;</span>, __LINE__, avg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DeleteDevice</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Deleting Driver\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="keyword">if</span> (pDriver-&gt;DeviceObject) &#123;</span><br><span class="line">        UNICODE_STRING DeviceName;</span><br><span class="line">        RtlInitUnicodeString(&amp;DeviceName, SYM);</span><br><span class="line">        IoDeleteSymbolicLink(&amp;DeviceName);</span><br><span class="line">        IoDeleteDevice(pDriver-&gt;DeviceObject);</span><br><span class="line">    &#125;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Deleted\n&quot;</span>, __LINE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Unloading Driver\n&quot;</span>, __LINE__);</span><br><span class="line">    DeleteDevice(pDriver);</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Unloaded\n&quot;</span>, __LINE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Loaded, RegistryPath : %S\n&quot;</span>, __LINE__, RegistryPath-&gt;Buffer);</span><br><span class="line"></span><br><span class="line">    PerformTimingTest();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到在非嵌套VT环境下cpuid执行的时间大致为800左右:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F19%2F20250519-110654.png" alt="QQ_1747624003674"></p>
<p>启动了题目驱动后执行时间翻了十倍有余:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F19%2F20250519-114658.png" alt="QQ_1747626371632"></p>
<p>接下来就是找到不被VT影响的指令来对比cpuid进行是否在VT环境的判断:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F19%2F20250519-121154.png" alt="QQ_1747627899501"></p>
<p>最后得到检测VT环境的函数:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">PerformTimingTest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">const</span> u32 iterations = <span class="number">10</span>;</span><br><span class="line">    u64 start = <span class="number">0</span>, end = <span class="number">0</span>, total = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> cpuinfo[<span class="number">4</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// Bind current thread to CPU 0  </span></span><br><span class="line">    KAFFINITY oldAffinity = KeSetSystemAffinityThreadEx((KAFFINITY)<span class="number">1</span>);</span><br><span class="line">    KIRQL oldIrql = KeRaiseIrqlToDpcLevel();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (u32 i = <span class="number">0</span>; i &lt; iterations; i++) &#123;</span><br><span class="line">        start = __rdtsc();</span><br><span class="line">        <span class="type">int</span> j = <span class="number">0x300</span>;</span><br><span class="line">        <span class="keyword">while</span> (TRUE) &#123;</span><br><span class="line">            <span class="keyword">if</span> (j &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            j -= <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        end = __rdtsc();</span><br><span class="line">        total += (end - start);</span><br><span class="line">    &#125;</span><br><span class="line">    u64 avg_before_VT = total / iterations;</span><br><span class="line">    total = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (u32 i = <span class="number">0</span>; i &lt; iterations; i++) &#123;</span><br><span class="line">        start = __rdtsc();</span><br><span class="line">        __cpuidex(cpuinfo, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        end = __rdtsc();</span><br><span class="line">        total += (end - start);</span><br><span class="line">    &#125;</span><br><span class="line">    u64 avg_cpuid = total / iterations;</span><br><span class="line"></span><br><span class="line">    KeLowerIrql(oldIrql);</span><br><span class="line">    KeRevertToUserAffinityThreadEx(oldAffinity);</span><br><span class="line">    <span class="keyword">if</span> (avg_cpuid / avg_before_VT &gt; <span class="number">10</span>) &#123;</span><br><span class="line">        kprintf(<span class="string">&quot;Line %d: VT is enabled\n&quot;</span>, __LINE__);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        kprintf(<span class="string">&quot;Line %d: VT is disabled\n&quot;</span>, __LINE__);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>未开启题目驱动时:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F19%2F20250519-122026.png" alt="QQ_1747628423947"></p>
<p>开启题目驱动后:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F19%2F20250519-122210.png" alt="QQ_1747628528091"></p>
<p>成功检测到VT环境</p>
<h3 id="方法2-检测IA32-APERF-MSR"><a href="#方法2-检测IA32-APERF-MSR" class="headerlink" title="方法2: 检测IA32_APERF_MSR"></a>方法2: 检测IA32_APERF_MSR</h3><p><code>IA32_APERF_MSR(MSR[0xE8])</code>用于记录cpu在运行期间的实际执行周期数 在两次读取之间如果cpu执行了一些任务那么理论上第二次读取到的数值会大于第一次读到的 但是上面解flag的时候已经知道了题目驱动hook了读取msr[0xE8]的指令 返回的永远都是0 可以利用这一点检测是否开启了题目驱动 但是因为我的VMware开了虚拟化CPU性能计数器就报错开不了机 所以这里只给出可能可行的代码:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F05%2F19%2F20250519-133441.png" alt="QQ_1747632879661"></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">PerformAPERFTest</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> cpuinfo[<span class="number">4</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="comment">// Bind current thread to CPU 0  </span></span><br><span class="line">    KAFFINITY oldAffinity = KeSetSystemAffinityThreadEx((KAFFINITY)<span class="number">1</span>);</span><br><span class="line">    KIRQL oldIrql = KeRaiseIrqlToDpcLevel();</span><br><span class="line"></span><br><span class="line">    u64 start = __readmsr(<span class="number">0xe8</span>);</span><br><span class="line">    __cpuid(cpuinfo, <span class="number">0</span>);</span><br><span class="line">    u64 end = __readmsr(<span class="number">0xe8</span>);</span><br><span class="line"></span><br><span class="line">    KeLowerIrql(oldIrql);</span><br><span class="line">    KeRevertToUserAffinityThreadEx(oldAffinity);</span><br><span class="line">    <span class="keyword">if</span> (end - start == <span class="number">0</span>) &#123;</span><br><span class="line">        kprintf(<span class="string">&quot;Line %d: VT enabled\n&quot;</span>, __LINE__);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        kprintf(<span class="string">&quot;Line %d: VT disabled\n&quot;</span>, __LINE__);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>参考</p>
<blockquote>
<p>腾讯2025游戏安全PC方向决赛题解 - moshuiD	<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-286462.htm">https://bbs.kanxue.com/thread-286462.htm</a></p>
<p>腾讯游戏安全竞赛2025决赛题解 - xia0ji233		<a target="_blank" rel="noopener" href="https://xia0ji233.pro/2025/04/14/tencent-race-2025-final/">https://xia0ji233.pro/2025/04/14/tencent-race-2025-final/</a></p>
<p>hv github项目	<a target="_blank" rel="noopener" href="https://github.com/jonomango/hv">https://github.com/jonomango/hv</a></p>
</blockquote>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>1K0CT B14s
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://ikoct.com/2025/05/19/2025%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8-PC%E7%AB%AF%E5%86%B3%E8%B5%9B%E9%A2%98%E8%A7%A3-%E5%A4%8D%E7%8E%B0/" title="2025腾讯游戏安全 PC端决赛题解+复现">https://ikoct.com/2025/05/19/2025腾讯游戏安全-PC端决赛题解-复现/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Reverse/" rel="tag"># Reverse</a>
              <a href="/tags/Writeups/" rel="tag"># Writeups</a>
              <a href="/tags/Kernel/" rel="tag"># Kernel</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2025/04/23/Unicorn%E5%BC%95%E6%93%8E%E5%AD%A6%E4%B9%A0/" rel="prev" title="Unicorn引擎学习">
      <i class="fa fa-chevron-left"></i> Unicorn引擎学习
    </a></div>
      <div class="post-nav-item">
    <a href="/2025/07/28/NepCTF2025%E9%80%86%E5%90%91%E6%96%B9%E5%90%91Writeups/" rel="next" title="NepCTF2025逆向方向Writeups">
      NepCTF2025逆向方向Writeups <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E8%83%BD%E5%9C%A8%E5%8F%8C%E6%9C%BA%E7%8E%AF%E5%A2%83%E8%BF%90%E8%A1%8C%E9%A9%B1%E5%8A%A8%E5%B9%B6%E8%B0%83%E8%AF%95-1%E5%88%86"><span class="nav-number">1.</span> <span class="nav-text">(2)能在双机环境运行驱动并调试(1分)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E5%9C%A8intel-CPU-64%E4%BD%8DWindows10%E7%B3%BB%E7%BB%9F%E4%B8%8A%E8%BF%90%E8%A1%8Csys-%E6%88%90%E5%8A%9F%E5%8A%A0%E8%BD%BD%E9%A9%B1%E5%8A%A8-0-5%E5%88%86"><span class="nav-number">2.</span> <span class="nav-text">(1)在intel CPU&#x2F;64位Windows10系统上运行sys 成功加载驱动(0.5分)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%BC%98%E5%8C%96%E9%A9%B1%E5%8A%A8%E4%B8%AD%E7%9A%84%E8%80%97%E6%97%B6%E7%AE%97%E6%B3%95-%E5%B9%B6%E7%BB%99%E5%87%BAdemo%E8%83%BD%E5%BF%AB%E9%80%9F%E8%AE%A1%E7%AE%97%E5%BE%97%E5%87%BA%E6%AD%A3%E7%A1%AE%E7%9A%84key-1%E5%88%86"><span class="nav-number">3.</span> <span class="nav-text">(3)优化驱动中的耗时算法 并给出demo能快速计算得出正确的key(1分)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E5%88%86%E6%9E%90%E5%B9%B6%E7%BB%99%E5%87%BAflag%E7%9A%84%E8%AE%A1%E7%AE%97%E6%89%A7%E8%A1%8C%E6%B5%81%E7%A8%8B-1-5%E5%88%86-%E8%83%BD%E5%87%86%E7%A1%AE%E8%AF%B4%E6%98%8E%E5%85%B6%E4%B8%B2%E8%81%94%E9%80%BB%E8%BE%91-0-5%E5%88%86"><span class="nav-number">4.</span> <span class="nav-text">(4)分析并给出flag的计算执行流程(1.5分) 能准确说明其串联逻辑(0.5分)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-%E8%AF%A5%E9%A2%98%E7%9B%AE%E4%BD%BF%E7%94%A8%E4%BA%86%E4%B8%80%E7%A7%8D%E5%A4%96%E6%8C%82%E5%B8%B8%E7%94%A8%E7%9A%84%E9%9A%90%E8%97%8F%E6%89%8B%E6%AE%B5-%E8%AF%B7%E7%BB%99%E5%87%BA%E5%A4%9A%E7%A7%8D%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95-%E8%A6%81%E6%B1%82demo%E7%A8%8B%E5%BA%8F%E8%83%BD%E5%9C%A8%E9%A2%98%E7%9B%AE%E9%A9%B1%E5%8A%A8%E8%BF%90%E8%A1%8C%E7%9A%84%E7%8E%AF%E5%A2%83%E4%B8%8B%E8%BF%9B%E8%A1%8C%E7%B2%BE%E7%A1%AE%E6%A3%80%E6%B5%8B-%E6%96%B9%E6%B3%95%E8%B6%8A%E5%A4%9A%E5%88%86%E6%95%B0%E8%B6%8A%E9%AB%98-3%E5%88%86"><span class="nav-number">5.</span> <span class="nav-text">(6)该题目使用了一种外挂常用的隐藏手段 请给出多种检测方法 要求demo程序能在题目驱动运行的环境下进行精确检测 方法越多分数越高(3分)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%951-cpuid%E6%89%A7%E8%A1%8C%E7%9A%84cpu%E5%91%A8%E6%9C%9F"><span class="nav-number">5.1.</span> <span class="nav-text">方法1: cpuid执行的cpu周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%B9%E6%B3%952-%E6%A3%80%E6%B5%8BIA32-APERF-MSR"><span class="nav-number">5.2.</span> <span class="nav-text">方法2: 检测IA32_APERF_MSR</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="1K0CT B14s"
      src="/images/myavatar.gif">
  <p class="site-author-name" itemprop="name">1K0CT B14s</p>
  <div class="site-description" itemprop="description">残りの人生、私にくれませんか？</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">34</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">19</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        <!--
-->

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">1K0CT B14s</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">634k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:37</span>
</div>

<!--
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>-->

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
